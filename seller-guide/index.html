<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì»¨í…ì¸  ê°€ì´ë“œ | ëª¨ì—¬ë¼ë”œ</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #fc9600;
      --primary-dark: #e08600;
      --primary-light: #fff8f0;
      --gray-900: #191F28;
      --gray-700: #4E5968;
      --gray-500: #8B95A1;
      --gray-300: #C9CDD2;
      --gray-200: #E5E8EB;
      --gray-100: #F2F4F6;
      --gray-50: #F9FAFB;
      --success: #22c55e;
      --info: #3b82f6;
      --warning: #f59e0b;
    }
    body {
      font-family: 'Pretendard', -apple-system, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 100px;
    }
    .header {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(145deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 16px;
      margin-bottom: 20px;
    }
    .header h1 { font-size: 22px; margin-bottom: 8px; }
    .header p { font-size: 14px; opacity: 0.9; }
    .section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .section-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-100);
      font-size: 14px;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--gray-500); }
    .info-value { font-weight: 600; color: var(--gray-900); }
    
    /* ìƒí’ˆ í…Œì´ë¸” */
    .product-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .product-table th {
      background: var(--gray-100);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--gray-700);
    }
    .product-table th:last-child { text-align: right; }
    .product-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-100);
    }
    .product-table td:last-child {
      text-align: right;
      color: var(--primary);
      font-weight: 700;
    }
    
    /* í˜œíƒ ë°•ìŠ¤ */
    .benefit-box {
      background: linear-gradient(145deg, #fffbeb, #fef3c7);
      border: 1px solid #fcd34d;
      border-radius: 12px;
      padding: 16px;
    }
    .benefit-box h4 {
      color: #d97706;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .benefit-text {
      font-size: 14px;
      color: #92400e;
      line-height: 1.8;
    }
    
    /* ìº¡ì…˜ ì„¹ì…˜ */
    .caption-box {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .caption-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 8px;
      font-weight: 600;
    }
    .caption-text {
      font-size: 14px;
      line-height: 1.8;
      white-space: pre-wrap;
      color: var(--gray-700);
    }
    .copy-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }
    .copy-btn:active { transform: scale(0.98); }
    
    /* ì…ë ¥ í•„ë“œ */
    .input-group {
      margin-bottom: 16px;
    }
    .input-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
      display: block;
    }
    .input-field {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(252, 150, 0, 0.1);
    }
    .input-hint {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 6px;
    }
    
    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      display: flex;
      background: var(--gray-100);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 16px;
    }
    .tab-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* ë¡œë”© */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ì—ëŸ¬ */
    .error-box {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 16px;
    }
    .error-icon { font-size: 48px; margin-bottom: 16px; }
    .error-text { color: var(--gray-500); }
    
    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-900);
      color: white;
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>ê°€ì´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyD4BoC8JLnhgCsEcbL6XNheMjm5QY8qodo",
      authDomain: "moyeora-392ce.firebaseapp.com",
      projectId: "moyeora-392ce",
      storageBucket: "moyeora-392ce.appspot.com",
      messagingSenderId: "305,739,605,032",
      appId: "1:305739605032:web:ab3b2bef051c41aa4c06cb"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // URLì—ì„œ ê³µêµ¬ ID ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const dealId = urlParams.get('id');
    
    // ì „ì—­ ìƒíƒœ
    let dealData = null;
    let supplierData = null;
    let productsData = [];
    
    // ì´ˆê¸°í™”
    async function init() {
      if (!dealId) {
        showError('ê³µêµ¬ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        // ê³µêµ¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const dealDoc = await db.collection('deals').doc(dealId).get();
        if (!dealDoc.exists) {
          showError('ê³µêµ¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        dealData = { id: dealDoc.id, ...dealDoc.data() };
        
        // ê³µê¸‰ì‚¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        if (dealData.supplierId) {
          const supplierDoc = await db.collection('suppliers').doc(dealData.supplierId).get();
          if (supplierDoc.exists) {
            supplierData = { id: supplierDoc.id, ...supplierDoc.data() };
          }
        }
        
        // ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const productsSnap = await db.collection('supplier_products').get();
        const allProducts = productsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // ì„ íƒëœ ìƒí’ˆë§Œ í•„í„°ë§
        if (dealData.selectedProducts && dealData.selectedProducts.length > 0) {
          productsData = dealData.selectedProducts.map(item => {
            const pid = typeof item === 'string' ? item : item.productId;
            const product = allProducts.find(p => p.id === pid);
            if (product) {
              return {
                ...product,
                marginRate: typeof item === 'object' ? item.marginRate : 0
              };
            }
            return null;
          }).filter(Boolean);
        }
        
        render();
      } catch (e) {
        console.error(e);
        showError('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ì—ëŸ¬ í‘œì‹œ
    function showError(msg) {
      document.getElementById('app').innerHTML = `
        <div class="error-box">
          <div class="error-icon">ğŸ˜¢</div>
          <p class="error-text">${msg}</p>
        </div>
      `;
    }
    
    // í† ìŠ¤íŠ¸
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
    
    // ë³µì‚¬
    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('ğŸ“‹ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }).catch(() => {
        // í´ë°±
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('ğŸ“‹ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      });
    }
    
    // ìº¡ì…˜ ìƒì„±
    function generateCaption() {
      const productLink = document.getElementById('product-link')?.value || '[ìƒí’ˆë§í¬]';
      const nego = dealData.negotiation || {};
      const benefits = [nego.eventSupplier, nego.eventMoyeora, nego.event].filter(Boolean).join(' / ');
      const productNames = productsData.map(p => p.productName).slice(0, 3).join(', ');
      
      const caption = `ğŸ‰ íŠ¹ë³„í•œ ê³µë™êµ¬ë§¤ ì†Œì‹!

${supplierData?.name || 'ë¸Œëœë“œ'}ì˜ ${productNames || 'ìƒí’ˆ'}ì„ íŠ¹ë³„ ê°€ê²©ì— ë§Œë‚˜ë³´ì„¸ìš” âœ¨

ğŸ“… ê¸°ê°„: ${dealData.startDate} ~ ${dealData.endDate}
${benefits ? `ğŸ í˜œíƒ: ${benefits}` : ''}

ğŸ‘‡ êµ¬ë§¤ë§í¬
${productLink}

#ê³µë™êµ¬ë§¤ #${supplierData?.name?.replace(/\s/g, '') || 'ë¸Œëœë“œ'} #ëª¨ì—¬ë¼ë”œ`;
      
      return caption;
    }
    
    // íƒ­ ì „í™˜
    function switchTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabId);
      });
      
      // ìº¡ì…˜ íƒ­ì´ë©´ ìº¡ì…˜ ì—…ë°ì´íŠ¸
      if (tabId === 'tab-caption') {
        updateCaptionPreview();
      }
    }
    
    // ìº¡ì…˜ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    function updateCaptionPreview() {
      const captionEl = document.getElementById('caption-preview');
      if (captionEl) {
        captionEl.textContent = generateCaption();
      }
    }
    
    // ë Œë”ë§
    function render() {
      const nego = dealData.negotiation || {};
      const benefits = [nego.eventSupplier, nego.eventMoyeora, nego.event].filter(Boolean).join(' / ');
      const productNames = productsData.map(p => p.productName).slice(0, 3);
      const productDisplay = productNames.join(', ') + (productsData.length > 3 ? ' ì™¸' : '');
      
      document.getElementById('app').innerHTML = `
        <!-- í—¤ë” -->
        <div class="header">
          <h1>${supplierData?.name || 'ë¸Œëœë“œ'}</h1>
          <p>${productDisplay || dealData.title}</p>
        </div>
        
        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-nav">
          <button class="tab-btn active" data-tab="tab-info" onclick="switchTab('tab-info')">ğŸ“‹ ìƒí’ˆì •ë³´</button>
          <button class="tab-btn" data-tab="tab-schedule" onclick="switchTab('tab-schedule')">ğŸ“… ì¼ì •</button>
          <button class="tab-btn" data-tab="tab-caption" onclick="switchTab('tab-caption')">âœï¸ ìº¡ì…˜</button>
        </div>
        
        <!-- ìƒí’ˆì •ë³´ íƒ­ -->
        <div class="tab-content active" id="tab-info">
          <!-- ìƒí’ˆë³„ ë§ˆì§„ìœ¨ -->
          <div class="section">
            <div class="section-title">ğŸ’° ìƒí’ˆë³„ ë§ˆì§„ìœ¨</div>
            ${productsData.length > 0 ? `
              <table class="product-table">
                <thead>
                  <tr>
                    <th>ìƒí’ˆëª…</th>
                    <th>ë§ˆì§„ìœ¨</th>
                  </tr>
                </thead>
                <tbody>
                  ${productsData.map(p => `
                    <tr>
                      <td>${p.productName}</td>
                      <td>${p.marginRate || 0}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            ` : '<p style="color: var(--gray-500); font-size: 14px;">ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
          </div>
          
          <!-- í˜œíƒ -->
          ${benefits ? `
            <div class="section">
              <div class="section-title">ğŸ ì´ë²ˆ ê³µêµ¬ í˜œíƒ</div>
              <div class="benefit-box">
                <div class="benefit-text">${benefits}</div>
              </div>
            </div>
          ` : ''}
        </div>
        
        <!-- ì¼ì • íƒ­ -->
        <div class="tab-content" id="tab-schedule">
          <div class="section">
            <div class="section-title">ğŸ“… ê³µêµ¬ ì¼ì •</div>
            <div class="info-row">
              <span class="info-label">ì‹œì‘ì¼</span>
              <span class="info-value">${dealData.startDate}</span>
            </div>
            <div class="info-row">
              <span class="info-label">ì¢…ë£Œì¼</span>
              <span class="info-value">${dealData.endDate}</span>
            </div>
            <div class="info-row">
              <span class="info-label">ê³µê¸‰ì‚¬</span>
              <span class="info-value" style="color: var(--primary);">${supplierData?.name || '-'}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">ğŸ“Œ ì£¼ìš” ì¼ì • ì²´í¬</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--gray-50); border-radius: 10px;">
                <span style="font-size: 20px;">ğŸ“¦</span>
                <div>
                  <div style="font-weight: 600; font-size: 14px;">ìƒ˜í”Œ ìˆ˜ë ¹</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ê³µêµ¬ ì‹œì‘ ì „ ìƒ˜í”Œ ì´¬ì˜</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--gray-50); border-radius: 10px;">
                <span style="font-size: 20px;">ğŸ“¸</span>
                <div>
                  <div style="font-weight: 600; font-size: 14px;">ì»¨í…ì¸  ì—…ë¡œë“œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">${dealData.startDate} ì˜¤ì „ ì¤‘ ê²Œì‹œ</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--gray-50); border-radius: 10px;">
                <span style="font-size: 20px;">ğŸ””</span>
                <div>
                  <div style="font-weight: 600; font-size: 14px;">ê³µêµ¬ ì¢…ë£Œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">${dealData.endDate} ìì •ê¹Œì§€</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ìº¡ì…˜ íƒ­ -->
        <div class="tab-content" id="tab-caption">
          <div class="section">
            <div class="section-title">ğŸ”— ìƒí’ˆ ë§í¬ ì…ë ¥</div>
            <div class="input-group">
              <label class="input-label">êµ¬ë§¤ ë§í¬</label>
              <input type="text" class="input-field" id="product-link" placeholder="https://smartstore.naver.com/..." oninput="updateCaptionPreview()">
              <p class="input-hint">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´, ì¹´í˜24 ë“± êµ¬ë§¤ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">âœï¸ ìº¡ì…˜ ë¯¸ë¦¬ë³´ê¸°</div>
            <div class="caption-box">
              <div class="caption-text" id="caption-preview">${generateCaption()}</div>
            </div>
            <button class="copy-btn" onclick="copyText(generateCaption())">
              ğŸ“‹ ìº¡ì…˜ ë³µì‚¬í•˜ê¸°
            </button>
          </div>
          
          <div class="section">
            <div class="section-title">ğŸ’¡ ìº¡ì…˜ ì‘ì„± íŒ</div>
            <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8;">
              <p>â€¢ ì²« ì¤„ì— í•µì‹¬ ë©”ì‹œì§€ë¥¼ ë‹´ì•„ì£¼ì„¸ìš”</p>
              <p>â€¢ í˜œíƒê³¼ ê¸°ê°„ì„ ëª…í™•í•˜ê²Œ í‘œì‹œí•´ì£¼ì„¸ìš”</p>
              <p>â€¢ êµ¬ë§¤ë§í¬ëŠ” í”„ë¡œí•„ ë§í¬ë¡œë„ ì•ˆë‚´ ê°€ëŠ¥í•´ìš”</p>
              <p>â€¢ í•´ì‹œíƒœê·¸ëŠ” 5~10ê°œ ì •ë„ê°€ ì ë‹¹í•´ìš”</p>
            </div>
          </div>
        </div>
      `;
    }
    
    // ì‹œì‘
    init();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì¡°íšŒ - ëª¨ì—¬ë¼ë”œ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f5f5f5; font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 16px 24px; color: #fff; }
        .header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 18px; font-weight: 700; text-decoration: none; color: #fff; display: flex; align-items: center; gap: 8px; }
        .logo img { height: 28px; }
        .nav-menu { display: flex; gap: 4px; }
        .nav-item { padding: 8px 16px; border-radius: 8px; text-decoration: none; color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.15); }
        .nav-item.active { background: rgba(255,255,255,0.25); color: #fff; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
        .user-name { font-weight: 600; background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 6px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

        /* Login Section */
        .login-section { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px); }
        .login-card { background: #fff; border-radius: 16px; padding: 48px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 400px; width: 100%; text-align: center; }
        .login-title { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 8px; }
        .login-desc { font-size: 14px; color: #888; margin-bottom: 32px; }
        .login-input { width: 100%; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px; margin-bottom: 16px; }
        .login-input:focus { outline: none; border-color: #f59e0b; }
        .login-btn { width: 100%; padding: 14px; background: #f59e0b; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .login-btn:hover { background: #d97706; }

        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }

        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: #fff; border-radius: 16px; padding: 24px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .stat-card.highlight { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; }
        .stat-label { font-size: 13px; color: #888; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 700; color: #333; }
        .stat-card.highlight .stat-value { color: #d97706; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 18px; font-weight: 600; color: #333; }
        .selected-info { font-size: 14px; color: #f59e0b; font-weight: 600; }
        .btn-group { display: flex; gap: 8px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-primary { background: #f59e0b; color: #fff; }
        .btn-primary:hover { background: #d97706; }

        .table-container { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f9fafb; padding: 12px 10px; text-align: center; font-weight: 600; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
        th.supplier-col { background: #fef3c7; color: #92400e; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; text-align: center; vertical-align: middle; }
        tr:hover { background: #fafafa; }
        .row-group { background: #fffbeb; }
        .row-group:hover { background: #fef3c7; }

        .seller-cell { font-weight: 600; color: #374151; }
        .period-cell { font-size: 12px; color: #6b7280; }
        .product-cell { text-align: left; font-size: 12px; line-height: 1.4; }
        .amount-cell { font-weight: 600; }
        .supply-cell { background: #fffbeb; font-weight: 600; color: #92400e; }
        .vat-cell { background: #fef3c7; }
        .total-cell { background: #fde68a; font-weight: 700; color: #92400e; }

        .checkbox-cell { width: 40px; }
        .checkbox-cell input { width: 18px; height: 18px; cursor: pointer; accent-color: #f59e0b; }

        .subtotal-row { background: #f3f4f6; font-weight: 600; }
        .subtotal-row td { border-top: 2px solid #e5e7eb; }
        .grand-total-row { background: #fef3c7; }
        .grand-total-row td { font-weight: 700; font-size: 14px; border-top: 3px solid #f59e0b; }

        .empty-state { text-align: center; padding: 60px 20px; color: #999; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-body { padding: 24px; }

        .statement-header { text-align: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 3px solid #f59e0b; }
        .statement-logo { font-size: 28px; font-weight: 700; color: #f59e0b; margin-bottom: 8px; }
        .statement-title { font-size: 24px; font-weight: 700; color: #374151; }

        .statement-info { margin-bottom: 24px; }
        .info-item { display: flex; gap: 8px; padding: 6px 0; font-size: 14px; }
        .info-label { color: #6b7280; min-width: 80px; }
        .info-value { font-weight: 500; color: #374151; }

        .statement-total { font-size: 24px; font-weight: 700; color: #f59e0b; margin: 20px 0; }

        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
        .statement-table th { background: #f9fafb; padding: 10px 8px; border: 1px solid #e5e7eb; }
        .statement-table th.supply-header { background: #fef3c7; }
        .statement-table td { padding: 10px 8px; border: 1px solid #e5e7eb; text-align: center; }
        .statement-table .product-name { text-align: left; }

        .download-btn { width: 100%; padding: 14px; background: #f59e0b; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 20px; }
        .download-btn:hover { background: #d97706; }

        .footer-note { text-align: center; margin-top: 24px; font-size: 12px; color: #9ca3af; }

        @media (max-width: 768px) {
            .header-inner { flex-direction: column; gap: 12px; }
            .stats-row { grid-template-columns: 1fr; }
            .table-container { overflow-x: auto; }
            table { min-width: 1100px; }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <a href="/" class="logo">
                <span>â˜€ï¸ëª¨ì—¬ë¼ë”œ</span>
            </a>
            <div class="nav-menu" id="navMenu" style="display: none;">
                <a href="portal.html" class="nav-item active">ì •ì‚°ì„œ</a>
                <a href="orders.html" class="nav-item">ì£¼ë¬¸í˜„í™©</a>
                <a href="proposal-manager.html" class="nav-item">ì œì•ˆì„œ ê´€ë¦¬</a>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span class="user-name" id="displayName"></span>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <!-- Login Section -->
    <div class="login-section" id="loginSection">
        <div class="login-card">
            <h1 class="login-title">ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì¡°íšŒ</h1>
            <p class="login-desc">ë“±ë¡ëœ ë¸Œëœë“œëª…(ê³µê¸‰ì‚¬ëª…)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            <input type="text" class="login-input" id="supplierNameInput" placeholder="ë¸Œëœë“œëª… (ì˜ˆ: ë¡œì§€ì˜¤ê°€ë‹‰)">
            <button class="login-btn" onclick="login()">ì •ì‚°ì„œ ì¡°íšŒ</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="container dashboard" id="dashboard">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">ì •ì‚° ê±´ìˆ˜</div>
                <div class="stat-value" id="totalCount">0ê±´</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì´ íŒë§¤ì•¡</div>
                <div class="stat-value" id="totalSales">0ì›</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">ì´ ì •ì‚°ê¸ˆì•¡(V+)</div>
                <div class="stat-value" id="totalAmount">0ì›</div>
            </div>
        </div>

        <div class="section-header">
            <h2 class="section-title">ì •ì‚° ë‚´ì—­</h2>
            <div style="display: flex; align-items: center; gap: 16px;">
                <span class="selected-info" id="selectedInfo"></span>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="exportExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="downloadSelectedPDF()">PDF ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>ì…€ëŸ¬</th>
                        <th>ê³µêµ¬ê¸°ê°„</th>
                        <th>íŒë§¤ìƒí’ˆ</th>
                        <th>íŒë§¤ë‹¨ê°€</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>íŒë§¤ê¸ˆì•¡</th>
                        <th class="supplier-col">ê³µê¸‰ë‹¨ê°€(V+)</th>
                        <th class="supplier-col">ê³µê¸‰ê°€ì•¡</th>
                        <th class="supplier-col">ë¶€ê°€ì„¸(10%)</th>
                        <th class="supplier-col">ì •ì‚°ê¸ˆì•¡(V+)</th>
                        <th>ì •ì‚°ì¼</th>
                    </tr>
                </thead>
                <tbody id="settlementList">
                </tbody>
            </table>
            <div class="empty-state" id="emptyState" style="display: none;">
                <p>ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </div>

        <p class="footer-note">ğŸŸ¡ ë…¸ë€ìƒ‰ ì˜ì—­: ê³µê¸‰ì‚¬ ì •ì‚° í•­ëª©</p>
    </div>

    <!-- Statement Modal -->
    <div class="modal" id="statementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ê³µê¸‰ì‚¬ ì •ì‚°ì„œ</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="statementDetail">
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
            authDomain: "moyeora-deal-manager.firebaseapp.com",
            projectId: "moyeora-deal-manager",
            storageBucket: "moyeora-deal-manager.firebasestorage.app",
            messagingSenderId: "527148187832",
            appId: "1:527148187832:web:dc35b0413a7157db34744d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let settlements = [];
        let products = [];
        let cafe24Orders = [];
        let currentSupplier = '';
        let selectedSettlements = new Set();

        window.onload = function() {
            const saved = sessionStorage.getItem('supplierName');
            if (saved) {
                currentSupplier = saved;
                showDashboard();
            }
        };

        function login() {
            const name = document.getElementById('supplierNameInput').value.trim();
            if (!name) {
                alert('ë¸Œëœë“œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            currentSupplier = name;
            sessionStorage.setItem('supplierName', name);
            showDashboard();
        }

        function logout() {
            sessionStorage.removeItem('supplierName');
            currentSupplier = '';
            settlements = [];
            cafe24Orders = [];
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('navMenu').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('navMenu').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('displayName').textContent = currentSupplier;
            loadData();
        }

        async function loadData() {
            try {
                // ìƒí’ˆ DB ë¡œë“œ (ê³µê¸‰ë‹¨ê°€ ì •ë³´)
                const productsSnapshot = await db.collection('products').get();
                products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // ğŸ”¥ cafe24_ordersì—ì„œ í•´ë‹¹ ê³µê¸‰ì‚¬(supplier_name) ì£¼ë¬¸ ë¡œë“œ
                const ordersSnapshot = await db.collection('cafe24_orders')
                    .orderBy('order_date', 'desc')
                    .limit(2000)
                    .get();

                const allOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // ë””ë²„ê¹…: DBì— ìˆëŠ” ëª¨ë“  ê³µê¸‰ì‚¬ëª… ëª©ë¡ í‘œì‹œ
                const uniqueSuppliers = [...new Set(allOrders.map(o => o.supplier_name || '(ì—†ìŒ)'))];
                console.log('ğŸ“¦ DB ì „ì²´ ì£¼ë¬¸ìˆ˜:', allOrders.length);
                console.log('ğŸ¢ DB ê³µê¸‰ì‚¬ëª… ëª©ë¡:', uniqueSuppliers);
                console.log('ğŸ” ê²€ìƒ‰ ê³µê¸‰ì‚¬ëª…:', currentSupplier);

                // supplier_name ë˜ëŠ” supplier í•„ë“œì—ì„œ ê³µê¸‰ì‚¬ëª… ë§¤ì¹­ (ë‹¤ì–‘í•œ í•„ë“œ ì§€ì›)
                cafe24Orders = allOrders.filter(o => {
                    const supplierName = (o.supplier_name || o.supplier || o.brand_name || '').toLowerCase().trim();
                    const currentName = currentSupplier.toLowerCase().trim();

                    // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, ì„œë¡œ í¬í•¨ ê´€ê³„ì´ë©´ ë§¤ì¹­
                    if (!supplierName) return false;
                    return supplierName === currentName ||
                           supplierName.includes(currentName) ||
                           currentName.includes(supplierName);
                });

                console.log(`âœ… ${currentSupplier} ì£¼ë¬¸ ${cafe24Orders.length}ê±´ ë¡œë“œë¨`);

                // ì£¼ë¬¸ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì •ì‚° ë°ì´í„° ìƒì„±
                settlements = processOrdersToSettlements(cafe24Orders);
                renderSettlements();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // cafe24_ordersë¥¼ ì…€ëŸ¬ë³„/ê¸°ê°„ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì •ì‚° ë°ì´í„° ìƒì„±
        function processOrdersToSettlements(orders) {
            const result = [];

            // ì…€ëŸ¬ë³„ë¡œ ê·¸ë£¹í™”
            const sellerGroups = {};
            orders.forEach(order => {
                const sellerName = order.seller_name || '(ë¯¸ì§€ì •)';
                const orderDate = order.order_date || '';
                const yearMonth = orderDate.substring(0, 7); // YYYY-MM

                const groupKey = `${sellerName}_${yearMonth}`;

                if (!sellerGroups[groupKey]) {
                    sellerGroups[groupKey] = {
                        sellerName: sellerName,
                        yearMonth: yearMonth,
                        orders: []
                    };
                }
                sellerGroups[groupKey].orders.push(order);
            });

            // ê° ê·¸ë£¹ì„ ì •ì‚° ë°ì´í„°ë¡œ ë³€í™˜
            Object.values(sellerGroups).forEach(group => {
                const items = [];

                // ìƒí’ˆë³„ë¡œ ì§‘ê³„
                const productMap = {};
                group.orders.forEach(order => {
                    const productName = order.product_name || order.product_option || 'ìƒí’ˆ';
                    const qty = Number(order.quantity) || 1;
                    const unitPrice = Number(order.unit_price) || 0;
                    const totalAmount = Number(order.total_amount) || (unitPrice * qty);

                    // ê³µê¸‰ë‹¨ê°€ ì°¾ê¸°: 1) ì£¼ë¬¸ì— ì €ì¥ëœ supply_price, 2) ìƒí’ˆDBì—ì„œ ë§¤ì¹­
                    let supplyUnitPrice = Number(order.supply_price) || 0;
                    if (!supplyUnitPrice) {
                        const matchedProduct = findMatchingProduct(productName);
                        if (matchedProduct) {
                            supplyUnitPrice = Number(matchedProduct.supplyPrice) || 0;
                        }
                    }

                    const productKey = `${productName}_${unitPrice}_${supplyUnitPrice}`;
                    if (!productMap[productKey]) {
                        productMap[productKey] = {
                            productName: productName,
                            unitPrice: unitPrice,
                            supplyUnitPrice: supplyUnitPrice,
                            quantity: 0,
                            salesAmount: 0
                        };
                    }
                    productMap[productKey].quantity += qty;
                    productMap[productKey].salesAmount += totalAmount;
                });

                // ìƒí’ˆë³„ ì •ì‚° ê³„ì‚°
                Object.values(productMap).forEach(item => {
                    // ê³µê¸‰ë‹¨ê°€(V+)ëŠ” ë¶€ê°€ì„¸ í¬í•¨ ê¸ˆì•¡
                    // ê³µê¸‰ê°€ì•¡ = ê³µê¸‰ë‹¨ê°€ / 1.1 (ë¶€ê°€ì„¸ ì œì™¸)
                    // ë¶€ê°€ì„¸ = ê³µê¸‰ê°€ì•¡ * 10%
                    // ì •ì‚°ê¸ˆì•¡(V+) = ê³µê¸‰ê°€ì•¡ + ë¶€ê°€ì„¸ = ê³µê¸‰ë‹¨ê°€

                    const supplyUnitPrice = item.supplyUnitPrice; // V+ í¬í•¨ ë‹¨ê°€
                    const totalSupplyPriceVat = supplyUnitPrice * item.quantity; // ì´ ê³µê¸‰ë‹¨ê°€(V+)

                    // ê³µê¸‰ê°€ì•¡ = ê³µê¸‰ë‹¨ê°€(V+) / 1.1
                    const supplyAmount = supplyUnitPrice > 0
                        ? Math.round(totalSupplyPriceVat / 1.1)
                        : Math.round(item.salesAmount * 0.7); // ê³µê¸‰ë‹¨ê°€ ì—†ìœ¼ë©´ íŒë§¤ê¸ˆì•¡ì˜ 70%ë¡œ ì¶”ì •

                    // ë¶€ê°€ì„¸ = ê³µê¸‰ê°€ì•¡ * 10%
                    const vatAmount = Math.round(supplyAmount * 0.1);

                    // ì •ì‚°ê¸ˆì•¡(V+) = ê³µê¸‰ê°€ì•¡ + ë¶€ê°€ì„¸
                    const totalPayment = supplyAmount + vatAmount;

                    items.push({
                        productName: item.productName,
                        quantity: item.quantity,
                        unitPrice: item.unitPrice,
                        salesAmount: item.salesAmount,
                        supplyUnitPrice: supplyUnitPrice,
                        supplyAmount: supplyAmount,
                        vatAmount: vatAmount,
                        totalPayment: totalPayment
                    });
                });

                // ê³µêµ¬ê¸°ê°„ ê³„ì‚° (í•´ë‹¹ ê·¸ë£¹ ì£¼ë¬¸ì˜ ìµœì´ˆ~ìµœì¢… ë‚ ì§œ)
                const dates = group.orders.map(o => o.order_date).filter(d => d).sort();
                const dealPeriod = dates.length > 0
                    ? `${dates[0].substring(0,10)} ~ ${dates[dates.length-1].substring(0,10)}`
                    : group.yearMonth;

                result.push({
                    id: `${group.sellerName}_${group.yearMonth}`,
                    sellerName: group.sellerName,
                    dealPeriod: dealPeriod,
                    settlementDate: '-', // ì •ì‚° ì™„ë£Œì¼ì€ ë³„ë„ ê´€ë¦¬
                    isCompleted: false,
                    items: items,
                    totalSalesAmount: items.reduce((sum, i) => sum + i.salesAmount, 0),
                    totalSupplyAmount: items.reduce((sum, i) => sum + i.supplyAmount, 0),
                    totalVatAmount: items.reduce((sum, i) => sum + i.vatAmount, 0),
                    totalPayment: items.reduce((sum, i) => sum + i.totalPayment, 0)
                });
            });

            return result.sort((a, b) => (b.dealPeriod || '').localeCompare(a.dealPeriod || ''));
        }

        // ìƒí’ˆ DBì—ì„œ ë§¤ì¹­ë˜ëŠ” ìƒí’ˆ ì°¾ê¸°
        function findMatchingProduct(productName) {
            if (!productName) return null;

            const normalizedName = productName.toLowerCase().replace(/\s+/g, '');

            return products.find(p => {
                if (!p.brandName || !p.productName) return false;

                // ê³µê¸‰ì‚¬ ë§¤ì¹­
                const supplierMatch = p.brandName.toLowerCase() === currentSupplier.toLowerCase();
                if (!supplierMatch) return false;

                // ìƒí’ˆëª… ë§¤ì¹­ (ë¶€ë¶„ ë§¤ì¹­)
                const dbProductName = p.productName.toLowerCase().replace(/\s+/g, '');
                return normalizedName.includes(dbProductName) ||
                       dbProductName.includes(normalizedName) ||
                       normalizedName.includes(dbProductName.split('(')[0]) ||
                       dbProductName.includes(normalizedName.split('(')[0]);
            });
        }

        function renderSettlements() {
            const tbody = document.getElementById('settlementList');
            const emptyState = document.getElementById('emptyState');

            // í†µê³„ ê³„ì‚°
            const totalCount = settlements.length;
            const totalSales = settlements.reduce((sum, s) => sum + s.totalSalesAmount, 0);
            const totalAmount = settlements.reduce((sum, s) => sum + s.totalPayment, 0);

            document.getElementById('totalCount').textContent = totalCount + 'ê±´';
            document.getElementById('totalSales').textContent = totalSales.toLocaleString() + 'ì›';
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + 'ì›';

            if (settlements.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            let html = '';
            let grandTotalSupply = 0;
            let grandTotalVat = 0;
            let grandTotalPayment = 0;

            settlements.forEach((s, idx) => {
                const rowspan = s.items.length;

                s.items.forEach((item, itemIdx) => {
                    const isFirst = itemIdx === 0;

                    html += `<tr class="${isFirst ? 'row-group' : ''}">`;

                    if (isFirst) {
                        html += `
                            <td class="checkbox-cell" rowspan="${rowspan}">
                                <input type="checkbox" data-idx="${idx}" onchange="toggleSelect(${idx})" ${selectedSettlements.has(idx) ? 'checked' : ''}>
                            </td>
                            <td class="seller-cell" rowspan="${rowspan}">${s.sellerName}</td>
                            <td class="period-cell" rowspan="${rowspan}">${s.dealPeriod}</td>
                        `;
                    }

                    html += `
                        <td class="product-cell">${item.productName}</td>
                        <td>${item.unitPrice.toLocaleString()}ì›</td>
                        <td>${item.quantity}</td>
                        <td class="amount-cell">${item.salesAmount.toLocaleString()}ì›</td>
                        <td class="supply-cell">${(item.supplyUnitPrice || 0).toLocaleString()}ì›</td>
                        <td class="supply-cell">${item.supplyAmount.toLocaleString()}ì›</td>
                        <td class="vat-cell">${item.vatAmount.toLocaleString()}ì›</td>
                    `;

                    if (isFirst) {
                        html += `
                            <td class="total-cell" rowspan="${rowspan}">${s.totalPayment.toLocaleString()}ì›</td>
                            <td rowspan="${rowspan}">${s.settlementDate}</td>
                        `;
                    }

                    html += '</tr>';
                });

                grandTotalSupply += s.totalSupplyAmount;
                grandTotalVat += s.totalVatAmount;
                grandTotalPayment += s.totalPayment;
            });

            // í•©ê³„ í–‰
            html += `
                <tr class="grand-total-row">
                    <td colspan="7" style="text-align: center;">í•©ê³„</td>
                    <td class="supply-cell">-</td>
                    <td class="supply-cell">${grandTotalSupply.toLocaleString()}ì›</td>
                    <td class="vat-cell">${grandTotalVat.toLocaleString()}ì›</td>
                    <td class="total-cell">${grandTotalPayment.toLocaleString()}ì›</td>
                    <td>-</td>
                </tr>
            `;

            tbody.innerHTML = html;
            updateSelectedInfo();
        }

        function toggleSelect(idx) {
            if (selectedSettlements.has(idx)) {
                selectedSettlements.delete(idx);
            } else {
                selectedSettlements.add(idx);
            }
            updateSelectedInfo();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            if (selectAll) {
                settlements.forEach((_, idx) => selectedSettlements.add(idx));
            } else {
                selectedSettlements.clear();
            }
            renderSettlements();
        }

        function updateSelectedInfo() {
            const count = selectedSettlements.size;
            const total = Array.from(selectedSettlements).reduce((sum, idx) => sum + settlements[idx].totalPayment, 0);
            document.getElementById('selectedInfo').textContent = count > 0 ? `${count}ê±´ ì„ íƒ Â· ${total.toLocaleString()}ì›` : '';
        }

        function downloadSelectedPDF() {
            if (selectedSettlements.size === 0) {
                alert('ì •ì‚°ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const selectedList = Array.from(selectedSettlements).map(idx => settlements[idx]);
            const totalPayment = selectedList.reduce((sum, s) => sum + s.totalPayment, 0);

            let itemsHtml = '';
            selectedList.forEach(s => {
                s.items.forEach((item, idx) => {
                    const isFirst = idx === 0;
                    itemsHtml += `
                        <tr>
                            ${isFirst ? `<td rowspan="${s.items.length}" style="vertical-align: middle;">${s.sellerName}</td>` : ''}
                            ${isFirst ? `<td rowspan="${s.items.length}" style="vertical-align: middle; font-size: 11px;">${s.dealPeriod}</td>` : ''}
                            <td style="text-align: left; font-size: 11px;">${item.productName}</td>
                            <td>${item.quantity}</td>
                            <td>${item.salesAmount.toLocaleString()}ì›</td>
                            <td style="background: #fef3c7;">${(item.supplyUnitPrice || 0).toLocaleString()}ì›</td>
                            <td style="background: #fef3c7;">${item.supplyAmount.toLocaleString()}ì›</td>
                            <td style="background: #fef3c7;">${item.vatAmount.toLocaleString()}ì›</td>
                            ${isFirst ? `<td rowspan="${s.items.length}" style="vertical-align: middle; background: #fde68a; font-weight: 700;">${s.totalPayment.toLocaleString()}ì›</td>` : ''}
                            ${isFirst ? `<td rowspan="${s.items.length}" style="vertical-align: middle;">${s.settlementDate}</td>` : ''}
                        </tr>
                    `;
                });
            });

            const content = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ê³µê¸‰ì‚¬ ì •ì‚°ì„œ - ${currentSupplier}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; padding: 40px; max-width: 1000px; margin: 0 auto; }
        .header { text-align: left; border-bottom: 3px solid #f59e0b; padding-bottom: 20px; margin-bottom: 24px; }
        .logo { font-size: 24px; font-weight: 700; color: #f59e0b; }
        .title { font-size: 28px; font-weight: 700; color: #374151; margin-top: 8px; }
        .info { margin-bottom: 16px; }
        .info p { margin: 4px 0; font-size: 14px; color: #6b7280; }
        .info strong { color: #374151; }
        .total-amount { font-size: 24px; font-weight: 700; color: #f59e0b; margin: 16px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px; }
        th { background: #f3f4f6; padding: 10px 6px; border: 1px solid #e5e7eb; font-weight: 600; }
        th.supply { background: #fef3c7; }
        td { padding: 8px 6px; border: 1px solid #e5e7eb; text-align: center; }
        .footer { text-align: center; color: #9ca3af; font-size: 11px; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">â˜€ï¸ ëª¨ì—¬ë¼ë”œ</div>
        <div class="title">ê³µê¸‰ì‚¬ ì •ì‚°ì„œ</div>
    </div>
    <div class="info">
        <p><strong>ê³µê¸‰ì‚¬:</strong> ${currentSupplier}</p>
        <p><strong>ë°œí–‰ì¼:</strong> ${new Date().toLocaleDateString('ko-KR')}</p>
        <p><strong>ì„ íƒ ê±´ìˆ˜:</strong> ${selectedList.length}ê±´</p>
    </div>
    <div class="total-amount">ì„ íƒ ì •ì‚°ê¸ˆì•¡ (V+): ${totalPayment.toLocaleString()}ì›</div>
    <table>
        <thead>
            <tr>
                <th>ì…€ëŸ¬</th>
                <th>ê³µêµ¬ê¸°ê°„</th>
                <th>íŒë§¤ìƒí’ˆ</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>íŒë§¤ê¸ˆì•¡</th>
                <th class="supply">ê³µê¸‰ë‹¨ê°€(V+)</th>
                <th class="supply">ê³µê¸‰ê°€ì•¡</th>
                <th class="supply">ë¶€ê°€ì„¸(10%)</th>
                <th class="supply">ì •ì‚°ê¸ˆì•¡(V+)</th>
                <th>ì •ì‚°ì¼</th>
            </tr>
        </thead>
        <tbody>
            ${itemsHtml}
        </tbody>
    </table>
    <div class="footer">
        <p>ëª¨ì—¬ë¼ë”œ íŒŒíŠ¸ë„ˆ í¬í„¸ì—ì„œ ë°œí–‰ëœ ì •ì‚°ì„œì…ë‹ˆë‹¤.</p>
    </div>
</body>
</html>`;

            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ê³µê¸‰ì‚¬ì •ì‚°ì„œ_${currentSupplier}_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportExcel() {
            if (settlements.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const data = [];
            data.push(['ì…€ëŸ¬', 'ê³µêµ¬ê¸°ê°„', 'íŒë§¤ìƒí’ˆ', 'íŒë§¤ë‹¨ê°€', 'ìˆ˜ëŸ‰', 'íŒë§¤ê¸ˆì•¡', 'ê³µê¸‰ë‹¨ê°€(V+)', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸(10%)', 'ì •ì‚°ê¸ˆì•¡(V+)', 'ì •ì‚°ì¼']);

            settlements.forEach(s => {
                s.items.forEach((item, idx) => {
                    data.push([
                        idx === 0 ? s.sellerName : '',
                        idx === 0 ? s.dealPeriod : '',
                        item.productName,
                        item.unitPrice,
                        item.quantity,
                        item.salesAmount,
                        item.supplyUnitPrice || 0,
                        item.supplyAmount,
                        item.vatAmount,
                        idx === 0 ? s.totalPayment : '',
                        idx === 0 ? s.settlementDate : ''
                    ]);
                });
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ê³µê¸‰ì‚¬ì •ì‚°');
            XLSX.writeFile(wb, `ê³µê¸‰ì‚¬ì •ì‚°_${currentSupplier}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function closeModal() {
            document.getElementById('statementModal').classList.remove('active');
        }

        document.getElementById('supplierNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…€ëŸ¬ ì£¼ë¬¸í˜„í™© - ëª¨ì—¬ë¼ë”œ</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f5f5f5; font-family: 'Pretendard', -apple-system, sans-serif; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 16px 24px; color: #fff; }
        .header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 18px; font-weight: 700; text-decoration: none; color: #fff; display: flex; align-items: center; gap: 8px; }
        .nav-menu { display: flex; gap: 4px; }
        .nav-item { padding: 8px 16px; border-radius: 8px; text-decoration: none; color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.15); }
        .nav-item.active { background: rgba(255,255,255,0.25); color: #fff; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
        .user-name { font-weight: 600; background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 6px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

        /* Login Section */
        .login-section { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px); }
        .login-card { background: #fff; border-radius: 16px; padding: 48px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 400px; width: 100%; text-align: center; }
        .login-title { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 8px; }
        .login-desc { font-size: 14px; color: #888; margin-bottom: 32px; }
        .login-input { width: 100%; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px; margin-bottom: 16px; }
        .login-input:focus { outline: none; border-color: #10b981; }
        .login-btn { width: 100%; padding: 14px; background: #10b981; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .login-btn:hover { background: #059669; }

        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }

        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 4px; }
        .page-desc { font-size: 14px; color: #888; }

        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .stat-card.primary { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }
        .stat-label { font-size: 13px; color: #888; margin-bottom: 6px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #333; }
        .stat-card.primary .stat-value { color: #059669; }

        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 16px; }

        .deal-group { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .deal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 2px solid #10b981; margin-bottom: 16px; }
        .deal-title { font-size: 16px; font-weight: 600; color: #10b981; }
        .deal-stats { display: flex; gap: 16px; font-size: 13px; color: #666; }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f9fafb; padding: 12px 10px; text-align: center; font-weight: 600; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; text-align: center; vertical-align: middle; }
        tr:hover { background: #fafafa; }

        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; color: white; }
        .badge-primary { background: #10b981; }
        .badge-success { background: #10b981; }
        .badge-info { background: #3b82f6; }
        .badge-warning { background: #eab308; }
        .badge-danger { background: #ef4444; }
        .badge-gray { background: #6b7280; }

        .empty-state { text-align: center; padding: 60px 20px; color: #999; }

        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(16,185,129,0.3); border-top-color: #10b981; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .deal-header { flex-direction: column; align-items: flex-start; gap: 8px; }
            table { min-width: 900px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <a href="/" class="logo">
                <span>â˜€ï¸ëª¨ì—¬ë¼ë”œ</span>
            </a>
            <div class="nav-menu" id="navMenu" style="display: none;">
                <a href="portal.html" class="nav-item">ì •ì‚°ì„œ</a>
                <a href="orders.html" class="nav-item active">ì£¼ë¬¸í˜„í™©</a>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span class="user-name" id="displayName"></span>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <!-- Login Section -->
    <div class="login-section" id="loginSection">
        <div class="login-card">
            <h1 class="login-title">ì…€ëŸ¬ ì£¼ë¬¸í˜„í™©</h1>
            <p class="login-desc">ë“±ë¡ëœ ì…€ëŸ¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            <input type="text" class="login-input" id="sellerNameInput" placeholder="ì…€ëŸ¬ëª… (ì˜ˆ: í˜„ë¸Œë¡œë§˜)">
            <button class="login-btn" onclick="login()">ì£¼ë¬¸í˜„í™© ì¡°íšŒ</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="container dashboard" id="dashboard">
        <div class="page-header">
            <h1 class="page-title">ğŸ“¦ ì£¼ë¬¸í˜„í™©</h1>
            <p class="page-desc">ì¹´í˜24 ì£¼ë¬¸ ë°ì´í„° ê¸°ì¤€ (10ë¶„ë§ˆë‹¤ ìë™ ìˆ˜ì§‘)</p>
        </div>

        <!-- ë‚ ì§œ í•„í„° -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <select id="dateFilter" onchange="loadOrders(this.value)" style="padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white; min-width: 140px;">
                <option value="">ì „ì²´ ê¸°ê°„</option>
                <option value="today">ì˜¤ëŠ˜</option>
                <option value="week">ì§€ë‚œ 7ì¼</option>
                <option value="month">ì§€ë‚œ 30ì¼</option>
                <option value="3months">ì§€ë‚œ 3ê°œì›”</option>
            </select>
            <span id="dateRangeDisplay" style="font-size: 13px; color: #666;"></span>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">ì´ ì£¼ë¬¸</div>
                <div class="stat-value" id="totalOrders">0ê±´</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ê²°ì œì™„ë£Œ</div>
                <div class="stat-value" id="paidOrders">0ê±´</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ë°°ì†¡ëŒ€ê¸°</div>
                <div class="stat-value" id="pendingOrders">0ê±´</div>
            </div>
            <div class="stat-card primary">
                <div class="stat-label">ì´ ì£¼ë¬¸ê¸ˆì•¡</div>
                <div class="stat-value" id="totalAmount">0ì›</div>
            </div>
        </div>

        <h2 class="section-title">ë”œë³„ ì£¼ë¬¸ ë‚´ì—­</h2>
        <div id="dealGroups"></div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <p>ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
            authDomain: "moyeora-deal-manager.firebaseapp.com",
            projectId: "moyeora-deal-manager",
            storageBucket: "moyeora-deal-manager.firebasestorage.app",
            messagingSenderId: "527148187832",
            appId: "1:527148187832:web:dc35b0413a7157db34744d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentSeller = null;
        let currentSellerId = null;

        async function login() {
            const sellerName = document.getElementById('sellerNameInput').value.trim();
            if (!sellerName) {
                alert('ì…€ëŸ¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                // ì…€ëŸ¬ ì°¾ê¸°
                const sellersSnapshot = await db.collection('sellers').get();
                const seller = sellersSnapshot.docs.find(doc => doc.data().name === sellerName);

                if (!seller) {
                    alert('ë“±ë¡ë˜ì§€ ì•Šì€ ì…€ëŸ¬ëª…ì…ë‹ˆë‹¤.\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    return;
                }

                currentSeller = { id: seller.id, ...seller.data() };
                currentSellerId = seller.id;

                // ë¡œê·¸ì¸ ì„±ê³µ
                sessionStorage.setItem('sellerPortalAuth', JSON.stringify(currentSeller));
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('navMenu').style.display = 'flex';
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('displayName').textContent = currentSeller.name;

                loadOrders();
            } catch (err) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', err);
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function logout() {
            sessionStorage.removeItem('sellerPortalAuth');
            location.reload();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            const auth = sessionStorage.getItem('sellerPortalAuth');
            if (auth) {
                currentSeller = JSON.parse(auth);
                currentSellerId = currentSeller.id;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('navMenu').style.display = 'flex';
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('displayName').textContent = currentSeller.name;
                loadOrders();
            }
        });

        async function loadOrders(filterType = '') {
            try {
                // ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
                const today = new Date();
                let startDate = null;
                let endDate = today.toISOString().split('T')[0];

                if (filterType === 'today') {
                    startDate = endDate;
                } else if (filterType === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    startDate = weekAgo.toISOString().split('T')[0];
                } else if (filterType === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    startDate = monthAgo.toISOString().split('T')[0];
                } else if (filterType === '3months') {
                    const threeMonthsAgo = new Date(today);
                    threeMonthsAgo.setMonth(today.getMonth() - 3);
                    startDate = threeMonthsAgo.toISOString().split('T')[0];
                }

                // ë‚ ì§œ ë²”ìœ„ í‘œì‹œ
                const dateRangeDisplay = document.getElementById('dateRangeDisplay');
                if (startDate) {
                    dateRangeDisplay.textContent = `${startDate} ~ ${endDate}`;
                } else {
                    dateRangeDisplay.textContent = '';
                }

                // ì¹´í˜24 ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (seller_nameìœ¼ë¡œ í•„í„°ë§)
                let query = db.collection('cafe24_orders')
                    .where('seller_name', '==', currentSeller.name);

                // ë‚ ì§œ í•„í„°ê°€ ìˆìœ¼ë©´ ì„œë²„ ì‚¬ì´ë“œì—ì„œ í•„í„°ë§ (ì„±ëŠ¥ ê°œì„ )
                if (startDate) {
                    query = query.where('order_date', '>=', startDate);
                }

                const ordersSnapshot = await query
                    .orderBy('order_date', 'desc')
                    .limit(2000)  // í•œë„ ì¦ê°€
                    .get();

                const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (orders.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // í†µê³„ ê³„ì‚°
                const totalOrders = orders.length;
                const paidOrders = orders.filter(o => o.payment_status === 'F' || o.payment_status === 'ê²°ì œì™„ë£Œ').length;
                const pendingOrders = orders.filter(o => o.order_status === 'N10' || o.order_status === 'N20').length;
                const totalAmount = orders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);

                document.getElementById('totalOrders').textContent = formatNumber(totalOrders) + 'ê±´';
                document.getElementById('paidOrders').textContent = formatNumber(paidOrders) + 'ê±´';
                document.getElementById('pendingOrders').textContent = formatNumber(pendingOrders) + 'ê±´';
                document.getElementById('totalAmount').textContent = formatNumber(totalAmount) + 'ì›';

                // ë”œë³„ë¡œ ê·¸ë£¹í™”
                const dealGroups = {};
                orders.forEach(order => {
                    const dealId = order.deal_id || 'unmatched';
                    if (!dealGroups[dealId]) {
                        dealGroups[dealId] = {
                            dealTitle: order.deal_title || 'ë”œ ë¯¸ë§¤ì¹­',
                            orders: []
                        };
                    }
                    dealGroups[dealId].orders.push(order);
                });

                // ë”œë³„ ë Œë”ë§
                const dealGroupsEl = document.getElementById('dealGroups');
                dealGroupsEl.innerHTML = '';

                Object.entries(dealGroups).forEach(([dealId, group]) => {
                    const orderCount = group.orders.length;
                    const totalAmt = group.orders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);

                    const dealHtml = `
                        <div class="deal-group">
                            <div class="deal-header">
                                <div class="deal-title">${group.dealTitle}</div>
                                <div class="deal-stats">
                                    <span>ì£¼ë¬¸ ${orderCount}ê±´</span>
                                    <span>ê¸ˆì•¡ ${formatNumber(totalAmt)}ì›</span>
                                </div>
                            </div>
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                                            <th>ì£¼ë¬¸ì¼ì‹œ</th>
                                            <th>ìƒí’ˆëª…</th>
                                            <th>ìˆ˜ëŸ‰</th>
                                            <th>ê¸ˆì•¡</th>
                                            <th>ì£¼ë¬¸ìƒíƒœ</th>
                                            <th>ê²°ì œìƒíƒœ</th>
                                            <th>ìˆ˜ë ¹ì¸</th>
                                            <th>ì—°ë½ì²˜</th>
                                            <th>ë°°ì†¡ì§€</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${group.orders.map(order => `
                                            <tr>
                                                <td style="font-weight: 600; color: #3b82f6;">${order.order_id || '-'}</td>
                                                <td>${formatDate(order.order_date)}</td>
                                                <td style="text-align: left; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${order.product_name || '-'}</td>
                                                <td>${order.quantity || 1}</td>
                                                <td style="font-weight: 600;">${formatNumber(order.total_amount)}ì›</td>
                                                <td>${getOrderStatusBadge(order.order_status)}</td>
                                                <td>${getPaymentStatusBadge(order.payment_status)}</td>
                                                <td>${order.buyer_name || '-'}</td>
                                                <td>${order.buyer_phone || '-'}</td>
                                                <td style="text-align: left; font-size: 12px;">${order.shipping_address || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    dealGroupsEl.insertAdjacentHTML('beforeend', dealHtml);
                });

            } catch (err) {
                console.error('ì£¼ë¬¸ ë¡œë”© ì˜¤ë¥˜:', err);
                alert('ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function formatNumber(num) {
            return (num || 0).toLocaleString();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return dateStr.replace('T', ' ').substring(0, 16);
        }

        function getOrderStatusBadge(status) {
            const statusMap = {
                'N00': { text: 'ì…ê¸ˆì „', color: 'gray' },
                'N10': { text: 'ê²°ì œì™„ë£Œ', color: 'info' },
                'N20': { text: 'ìƒí’ˆì¤€ë¹„ì¤‘', color: 'warning' },
                'N21': { text: 'ë°°ì†¡ëŒ€ê¸°', color: 'warning' },
                'N22': { text: 'ë°°ì†¡ì¤‘', color: 'success' },
                'N30': { text: 'ë°°ì†¡ì™„ë£Œ', color: 'success' },
                'C00': { text: 'ì·¨ì†Œì‹ ì²­', color: 'danger' },
                'C10': { text: 'ì·¨ì†Œì²˜ë¦¬ì¤‘', color: 'danger' },
                'C20': { text: 'ì·¨ì†Œì™„ë£Œ', color: 'gray' },
            };
            const info = statusMap[status] || { text: status || 'ì•Œ ìˆ˜ ì—†ìŒ', color: 'gray' };
            return `<span class="badge badge-${info.color}">${info.text}</span>`;
        }

        function getPaymentStatusBadge(status) {
            if (status === 'F' || status === 'ê²°ì œì™„ë£Œ') {
                return '<span class="badge badge-success">ê²°ì œì™„ë£Œ</span>';
            }
            return '<span class="badge badge-gray">ë¯¸ê²°ì œ</span>';
        }
    </script>
</body>
</html>

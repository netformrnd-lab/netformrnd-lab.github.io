<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…€ëŸ¬ ì •ì‚°ì„œ ì¡°íšŒ - ëª¨ì—¬ë¼ë”œ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f5f5f5; font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px 24px; color: #fff; }
        .header-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 20px; font-weight: 700; text-decoration: none; color: #fff; display: flex; align-items: center; gap: 8px; }
        .logo img { height: 32px; }
        .nav-menu { display: flex; gap: 4px; }
        .nav-item { padding: 8px 16px; border-radius: 8px; text-decoration: none; color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.15); }
        .nav-item.active { background: rgba(255,255,255,0.25); color: #fff; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
        .user-name { font-weight: 600; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

        /* Login Section */
        .login-section { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px); }
        .login-card { background: #fff; border-radius: 16px; padding: 48px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 400px; width: 100%; text-align: center; }
        .login-title { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 8px; }
        .login-desc { font-size: 14px; color: #888; margin-bottom: 32px; }
        .login-input { width: 100%; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px; margin-bottom: 16px; }
        .login-input:focus { outline: none; border-color: #fe9f29; }
        .login-btn { width: 100%; padding: 14px; background: #fe9f29; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .login-btn:hover { background: #ea8000; }
        .login-note { margin-top: 16px; font-size: 13px; color: #999; }

        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }

        .page-title { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 24px; }

        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .stat-label { font-size: 13px; color: #888; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #333; }
        .stat-value.highlight { color: #fe9f29; }

        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .badge { background: #fe9f29; color: #fff; font-size: 12px; padding: 2px 8px; border-radius: 10px; }

        .table-container { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9f9f9; padding: 14px 16px; text-align: left; font-size: 13px; font-weight: 600; color: #666; border-bottom: 1px solid #eee; }
        td { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; font-size: 14px; color: #333; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #fafafa; }

        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-completed { background: #e8f5e9; color: #2e7d32; }
        .status-pending { background: #fff3e0; color: #ef6c00; }

        .amount { font-weight: 600; }
        .amount.positive { color: #2e7d32; }

        .view-btn { background: #f5f5f5; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; color: #666; }
        .view-btn:hover { background: #eee; }

        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.3; }
        .empty-state p { font-size: 15px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-body { padding: 24px; }

        .statement-header { text-align: center; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 2px solid #fe9f29; }
        .statement-logo { font-size: 24px; font-weight: 700; color: #fe9f29; margin-bottom: 8px; }
        .statement-title { font-size: 20px; font-weight: 600; }

        .statement-info { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .info-label { color: #888; font-size: 14px; }
        .info-value { font-weight: 500; font-size: 14px; }

        .statement-summary { background: #f9f9f9; border-radius: 12px; padding: 20px; margin-top: 24px; }
        .summary-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .summary-row:last-child { border-bottom: none; }
        .summary-row.total { font-size: 18px; font-weight: 700; color: #fe9f29; }

        .download-btn { width: 100%; padding: 14px; background: #fe9f29; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 24px; }
        .download-btn:hover { background: #ea8000; }

        @media (max-width: 768px) {
            .header-inner { flex-direction: column; gap: 12px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .table-container { overflow-x: auto; }
            table { min-width: 600px; }
            .statement-info { grid-template-columns: 1fr; }
        }

        /* J.A.R.V.I.S. ì±—ë´‡ */
        #chatbot-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
            z-index: 999;
            transition: all 0.3s;
            font-size: 28px;
        }
        #chatbot-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.5);
        }
        #chatbot-window {
            position: fixed;
            bottom: 90px;
            right: 24px;
            width: 380px;
            max-width: calc(100vw - 48px);
            height: 520px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        #chatbot-window.active {
            display: flex;
        }
        .chatbot-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            padding: 16px 20px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chatbot-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chatbot-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }
        #chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f9fafb;
        }
        .chat-message {
            margin-bottom: 12px;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.bot {
            display: flex;
            gap: 8px;
        }
        .chat-message.user {
            display: flex;
            justify-content: flex-end;
        }
        .bot-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .message-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 75%;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 14px;
        }
        .message-bubble.bot {
            background: #fff;
            border: 1px solid #e5e7eb;
        }
        .message-bubble.user {
            background: #10b981;
            color: #fff;
        }
        .quick-questions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        .quick-question-btn {
            background: #fff;
            border: 1px solid #d1d5db;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: all 0.2s;
        }
        .quick-question-btn:hover {
            background: #f3f4f6;
            border-color: #10b981;
        }
        .chatbot-input-container {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            background: #fff;
            border-radius: 0 0 16px 16px;
        }
        #chatbot-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        #chatbot-input:focus {
            outline: none;
            border-color: #10b981;
        }
        @media (max-width: 768px) {
            #chatbot-window {
                bottom: 80px;
                right: 16px;
                width: calc(100vw - 32px);
                height: 480px;
            }
            #chatbot-fab {
                bottom: 16px;
                right: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <a href="/" class="logo">
                <span>â˜€ï¸ëª¨ì—¬ë¼ë”œ</span>
            </a>
            <div class="nav-menu" id="navMenu" style="display: none;">
                <a href="portal.html" class="nav-item active">ì •ì‚°ì„œ</a>
                <a href="orders.html" class="nav-item">ì£¼ë¬¸í˜„í™©</a>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span class="user-name" id="displayName"></span>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <!-- Login Section -->
    <div class="login-section" id="loginSection">
        <div class="login-card">
            <h1 class="login-title">ì…€ëŸ¬ ì •ì‚°ì„œ ì¡°íšŒ</h1>
            <p class="login-desc">ë“±ë¡ëœ ì…€ëŸ¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            <input type="text" class="login-input" id="sellerNameInput" placeholder="ì…€ëŸ¬ëª… (ì˜ˆ: í™ê¸¸ë™)">
            <button class="login-btn" onclick="login()">ì •ì‚°ì„œ ì¡°íšŒ</button>
            <p class="login-note">ë¬¸ì˜: ëª¨ì—¬ë¼ë”œ ê´€ë¦¬ì</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="container dashboard" id="dashboard">
        <h1 class="page-title">ì •ì‚° í˜„í™©</h1>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">ì´ ì •ì‚° ê±´ìˆ˜</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì´ ì •ì‚° ê¸ˆì•¡</div>
                <div class="stat-value highlight" id="totalAmount">0ì›</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì •ì‚° ì™„ë£Œ</div>
                <div class="stat-value" id="completedCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì •ì‚° ëŒ€ê¸°</div>
                <div class="stat-value" id="pendingCount">0</div>
            </div>
        </div>

        <!-- ë² ìŠ¤íŠ¸ ìƒí’ˆ & ì›”ë³„ ì¶”ì´ -->
        <div class="stats-row" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 24px;">
            <div style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                <div style="font-size: 14px; font-weight: 600; color: #dc2626; margin-bottom: 16px;">ğŸ”¥ ë² ìŠ¤íŠ¸ íŒë§¤ ìƒí’ˆ</div>
                <div id="bestProducts" style="font-size: 13px; color: #666;">ë¡œë”©ì¤‘...</div>
            </div>
            <div style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                <div style="font-size: 14px; font-weight: 600; color: #2563eb; margin-bottom: 16px;">ğŸ“Š ì›”ë³„ ì •ì‚° í˜„í™©</div>
                <div id="monthlyStats" style="font-size: 13px; color: #666;">ë¡œë”©ì¤‘...</div>
            </div>
        </div>

        <h2 class="section-title">ì •ì‚° ë‚´ì—­ <span class="badge" id="listCount">0</span></h2>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ì •ì‚°ì¼</th>
                        <th>ë¸Œëœë“œ</th>
                        <th>ê³µêµ¬ê¸°ê°„</th>
                        <th>íŒë§¤ê¸ˆì•¡</th>
                        <th>ë§ˆì§„ê¸ˆì•¡</th>
                        <th>ì‹¤ì§€ê¸‰ì•¡</th>
                        <th>ìƒíƒœ</th>
                        <th>ìƒì„¸</th>
                    </tr>
                </thead>
                <tbody id="settlementList">
                </tbody>
            </table>
            <div class="empty-state" id="emptyState" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 12H5c-.55 0-1-.45-1-1V9c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v8c0 .55-.45 1-1 1z"/></svg>
                <p>ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </div>
    </div>

    <!-- Statement Modal -->
    <div class="modal" id="statementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ì •ì‚°ì„œ ìƒì„¸</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="statementDetail">
            </div>
        </div>
    </div>

    <!-- J.A.R.V.I.S. ì±—ë´‡ -->
    <div id="chatbot-fab" onclick="toggleChatbot()">ğŸ¤–</div>
    <div id="chatbot-window">
        <div class="chatbot-header">
            <div class="chatbot-title">ğŸ¤– J.A.R.V.I.S.</div>
            <button class="chatbot-close" onclick="toggleChatbot()">Ã—</button>
        </div>
        <div id="chatbot-messages"></div>
        <div class="chatbot-input-container">
            <input type="text" id="chatbot-input" placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" />
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
            authDomain: "moyeora-deal-manager.firebaseapp.com",
            projectId: "moyeora-deal-manager",
            storageBucket: "moyeora-deal-manager.firebasestorage.app",
            messagingSenderId: "527148187832",
            appId: "1:527148187832:web:dc35b0413a7157db34744d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let settlements = [];
        let currentSeller = '';

        // Check session
        window.onload = function() {
            const saved = sessionStorage.getItem('sellerName');
            if (saved) {
                currentSeller = saved;
                showDashboard();
            }
        };

        function login() {
            const name = document.getElementById('sellerNameInput').value.trim();
            if (!name) {
                alert('ì…€ëŸ¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            currentSeller = name;
            sessionStorage.setItem('sellerName', name);
            showDashboard();
        }

        function logout() {
            sessionStorage.removeItem('sellerName');
            currentSeller = '';
            settlements = [];
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('navMenu').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('navMenu').style.display = 'flex';
            document.getElementById('displayName').textContent = currentSeller + ' ì…€ëŸ¬ë‹˜';
            loadSettlements();
        }

        async function loadSettlements() {
            try {
                const snapshot = await db.collection('sellerSettlements')
                    .where('sellerName', '==', currentSeller)
                    .orderBy('createdAt', 'desc')
                    .get();

                settlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSettlements();
            } catch (error) {
                console.error('Error loading settlements:', error);
                // Try without index
                try {
                    const snapshot = await db.collection('sellerSettlements').get();
                    settlements = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(s => s.sellerName === currentSeller)
                        .sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
                    renderSettlements();
                } catch (e) {
                    console.error('Fallback error:', e);
                }
            }
        }

        function renderSettlements() {
            const tbody = document.getElementById('settlementList');
            const emptyState = document.getElementById('emptyState');

            // Update stats
            const total = settlements.length;
            const completed = settlements.filter(s => s.isCompleted).length;
            const pending = total - completed;
            const totalAmount = settlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);

            document.getElementById('totalCount').textContent = total;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + 'ì›';
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('listCount').textContent = total;

            // ë² ìŠ¤íŠ¸ ìƒí’ˆ ê³„ì‚° (salesItems ë˜ëŠ” items í•„ë“œì—ì„œ)
            renderBestProducts();
            renderMonthlyStats();

            if (settlements.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = settlements.map((s, idx) => `
                <tr>
                    <td>${s.settlementDate || '-'}</td>
                    <td>${s.brandName || '-'}</td>
                    <td>${s.dealPeriod || '-'}</td>
                    <td>${Number(s.salesAmount || 0).toLocaleString()}ì›</td>
                    <td>${Number(s.marginAmount || 0).toLocaleString()}ì›</td>
                    <td class="amount positive">${Number(s.actualPayment || 0).toLocaleString()}ì›</td>
                    <td><span class="status-badge ${s.isCompleted ? 'status-completed' : 'status-pending'}">${s.isCompleted ? 'ì •ì‚°ì™„ë£Œ' : 'ì •ì‚°ëŒ€ê¸°'}</span></td>
                    <td><button class="view-btn" onclick="showDetail(${idx})">ìƒì„¸ë³´ê¸°</button></td>
                </tr>
            `).join('');
        }

        function showDetail(idx) {
            const s = settlements[idx];
            const detail = document.getElementById('statementDetail');

            detail.innerHTML = `
                <div class="statement-header">
                    <div class="statement-logo">ëª¨ì—¬ë¼ë”œ</div>
                    <div class="statement-title">ì…€ëŸ¬ ì •ì‚°ì„œ</div>
                </div>

                <div class="statement-info">
                    <div>
                        <div class="info-row"><span class="info-label">ì…€ëŸ¬ëª…</span><span class="info-value">${s.sellerName || '-'}</span></div>
                        <div class="info-row"><span class="info-label">ë¸Œëœë“œ</span><span class="info-value">${s.brandName || '-'}</span></div>
                        <div class="info-row"><span class="info-label">ê³µêµ¬ê¸°ê°„</span><span class="info-value">${s.dealPeriod || '-'}</span></div>
                    </div>
                    <div>
                        <div class="info-row"><span class="info-label">ì •ì‚°ì¼</span><span class="info-value">${s.settlementDate || '-'}</span></div>
                        <div class="info-row"><span class="info-label">ìƒí’ˆìœ í˜•</span><span class="info-value">${s.productType === 'inhouse' ? 'ìì‚¬ìƒí’ˆ' : 'íƒ€ì‚¬ìƒí’ˆ'}</span></div>
                        <div class="info-row"><span class="info-label">ì •ì‚°ìƒíƒœ</span><span class="info-value">${s.isCompleted ? 'ì •ì‚°ì™„ë£Œ' : 'ì •ì‚°ëŒ€ê¸°'}</span></div>
                    </div>
                </div>

                <div class="statement-summary">
                    <div class="summary-row"><span>ì´ íŒë§¤ê¸ˆì•¡</span><span>${Number(s.salesAmount || 0).toLocaleString()}ì›</span></div>
                    <div class="summary-row"><span>ë§ˆì§„ìœ¨</span><span>${s.marginRate || 0}%</span></div>
                    <div class="summary-row"><span>ë§ˆì§„ê¸ˆì•¡</span><span>${Number(s.marginAmount || 0).toLocaleString()}ì›</span></div>
                    <div class="summary-row"><span>ì›ì²œì„¸ (3.3%)</span><span>-${Number(s.withholdingTax || 0).toLocaleString()}ì›</span></div>
                    <div class="summary-row total"><span>ì‹¤ì§€ê¸‰ì•¡</span><span>${Number(s.actualPayment || 0).toLocaleString()}ì›</span></div>
                </div>

                <button class="download-btn" onclick="downloadStatement(${idx})">ì •ì‚°ì„œ ë‹¤ìš´ë¡œë“œ</button>
            `;

            document.getElementById('statementModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('statementModal').classList.remove('active');
        }

        function renderBestProducts() {
            const productSales = {};

            settlements.forEach(s => {
                // salesItems ë˜ëŠ” items ë°°ì—´ì—ì„œ ìƒí’ˆë³„ íŒë§¤ì•¡ ì§‘ê³„
                const items = s.salesItems || s.items || [];
                items.forEach(item => {
                    const name = item.productName || item.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const amount = Number(item.amount) || Number(item.price) || 0;
                    const qty = Number(item.quantity) || Number(item.qty) || 1;
                    productSales[name] = (productSales[name] || 0) + (amount * qty);
                });

                // itemsê°€ ì—†ìœ¼ë©´ brandNameìœ¼ë¡œ ì§‘ê³„
                if (items.length === 0 && s.brandName) {
                    productSales[s.brandName] = (productSales[s.brandName] || 0) + (Number(s.salesAmount) || 0);
                }
            });

            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const container = document.getElementById('bestProducts');
            if (topProducts.length === 0) {
                container.innerHTML = '<div style="color: #999; font-size: 12px;">íŒë§¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = topProducts.map(([name, amount], i) => `
                <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 20px; height: 20px; background: ${i === 0 ? '#fef3c7' : i === 1 ? '#f3f4f6' : i === 2 ? '#fed7aa' : '#f9fafb'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: ${i === 0 ? '#d97706' : '#666'};">${i + 1}</span>
                        <span style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${name}</span>
                    </div>
                    <span style="font-weight: 600; color: #dc2626;">${Number(amount).toLocaleString()}ì›</span>
                </div>
            `).join('');
        }

        function renderMonthlyStats() {
            const monthlyData = {};

            settlements.forEach(s => {
                const date = s.settlementDate || s.createdAt || '';
                const month = date.substring(0, 7) || 'ë¯¸ì •';
                if (!monthlyData[month]) {
                    monthlyData[month] = { count: 0, amount: 0, completed: 0 };
                }
                monthlyData[month].count++;
                monthlyData[month].amount += Number(s.actualPayment) || 0;
                if (s.isCompleted) monthlyData[month].completed++;
            });

            const sortedMonths = Object.entries(monthlyData)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 4);

            const container = document.getElementById('monthlyStats');
            if (sortedMonths.length === 0) {
                container.innerHTML = '<div style="color: #999; font-size: 12px;">ì •ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = sortedMonths.map(([month, data]) => `
                <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-weight: 500;">${month}</span>
                        <span style="font-size: 11px; color: #999; margin-left: 6px;">${data.count}ê±´</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: #2563eb;">${Number(data.amount).toLocaleString()}ì›</div>
                        <div style="font-size: 10px; color: ${data.completed === data.count ? '#10b981' : '#f59e0b'};">${data.completed}/${data.count} ì™„ë£Œ</div>
                    </div>
                </div>
            `).join('');
        }

        function downloadStatement(idx) {
            const s = settlements[idx];
            const content = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì…€ëŸ¬ ì •ì‚°ì„œ - ${s.sellerName}</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
        .header { text-align: center; border-bottom: 3px solid #fe9f29; padding-bottom: 20px; margin-bottom: 30px; }
        .logo { font-size: 28px; font-weight: 700; color: #fe9f29; }
        .title { font-size: 22px; margin-top: 10px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .label { color: #666; }
        .summary { background: #f9f9f9; padding: 20px; border-radius: 8px; }
        .summary-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .summary-row:last-child { border-bottom: none; }
        .total { font-size: 20px; font-weight: 700; color: #fe9f29; }
        .footer { margin-top: 40px; text-align: center; color: #999; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ëª¨ì—¬ë¼ë”œ</div>
        <div class="title">ì…€ëŸ¬ ì •ì‚°ì„œ</div>
    </div>
    <div class="info-grid">
        <div>
            <div class="info-item"><span class="label">ì…€ëŸ¬ëª…</span><span>${s.sellerName || '-'}</span></div>
            <div class="info-item"><span class="label">ë¸Œëœë“œ</span><span>${s.brandName || '-'}</span></div>
            <div class="info-item"><span class="label">ê³µêµ¬ê¸°ê°„</span><span>${s.dealPeriod || '-'}</span></div>
        </div>
        <div>
            <div class="info-item"><span class="label">ì •ì‚°ì¼</span><span>${s.settlementDate || '-'}</span></div>
            <div class="info-item"><span class="label">ìƒí’ˆìœ í˜•</span><span>${s.productType === 'inhouse' ? 'ìì‚¬ìƒí’ˆ' : 'íƒ€ì‚¬ìƒí’ˆ'}</span></div>
            <div class="info-item"><span class="label">ì •ì‚°ìƒíƒœ</span><span>${s.isCompleted ? 'ì •ì‚°ì™„ë£Œ' : 'ì •ì‚°ëŒ€ê¸°'}</span></div>
        </div>
    </div>
    <div class="summary">
        <div class="summary-row"><span>ì´ íŒë§¤ê¸ˆì•¡</span><span>${Number(s.salesAmount || 0).toLocaleString()}ì›</span></div>
        <div class="summary-row"><span>ë§ˆì§„ìœ¨</span><span>${s.marginRate || 0}%</span></div>
        <div class="summary-row"><span>ë§ˆì§„ê¸ˆì•¡</span><span>${Number(s.marginAmount || 0).toLocaleString()}ì›</span></div>
        <div class="summary-row"><span>ì›ì²œì„¸ (3.3%)</span><span>-${Number(s.withholdingTax || 0).toLocaleString()}ì›</span></div>
        <div class="summary-row total"><span>ì‹¤ì§€ê¸‰ì•¡</span><span>${Number(s.actualPayment || 0).toLocaleString()}ì›</span></div>
    </div>
    <div class="footer">
        <p>ë°œí–‰ì¼: ${new Date().toLocaleDateString('ko-KR')}</p>
        <p>ëª¨ì—¬ë¼ë”œ | moyeora-deal.com</p>
    </div>
</body>
</html>`;

            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì •ì‚°ì„œ_${s.sellerName}_${s.settlementDate || 'unknown'}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Enter key support
        document.getElementById('sellerNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        // Close modal on backdrop click
        document.getElementById('statementModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // ========== J.A.R.V.I.S. ì±—ë´‡ ==========
        let chatbotInitialized = false;

        function toggleChatbot() {
            const chatbot = document.getElementById('chatbot-window');
            const isActive = chatbot.classList.contains('active');

            if (!isActive) {
                chatbot.classList.add('active');
                if (!chatbotInitialized) {
                    initChatbot();
                    chatbotInitialized = true;
                }
            } else {
                chatbot.classList.remove('active');
            }
        }

        function initChatbot() {
            const messagesContainer = document.getElementById('chatbot-messages');
            messagesContainer.innerHTML = '';

            addBotMessage('ì•ˆë…•í•˜ì„¸ìš”! ì…€ëŸ¬ íŒŒíŠ¸ë„ˆë‹˜ì„ ìœ„í•œ J.A.R.V.I.S.ì…ë‹ˆë‹¤ ğŸ¤–');

            setTimeout(() => {
                const quickQuestionsHTML = `
                    <div class="quick-questions">
                        <button class="quick-question-btn" onclick="askQuestion('ì •ì‚° í”„ë¡œì„¸ìŠ¤')">ğŸ“‹ ì •ì‚° í”„ë¡œì„¸ìŠ¤</button>
                        <button class="quick-question-btn" onclick="askQuestion('ìˆ˜ìˆ˜ë£Œ ì•ˆë‚´')">ğŸ’° ìˆ˜ìˆ˜ë£Œ ì•ˆë‚´</button>
                        <button class="quick-question-btn" onclick="askQuestion('ì£¼ë¬¸ ê´€ë¦¬')">ğŸ“¦ ì£¼ë¬¸ ê´€ë¦¬</button>
                        <button class="quick-question-btn" onclick="askQuestion('ê³µêµ¬ ì§„í–‰')">ğŸ¯ ê³µêµ¬ ì§„í–‰</button>
                        <button class="quick-question-btn" onclick="askQuestion('ë¬¸ì˜í•˜ê¸°')">ğŸ’¬ ë¬¸ì˜í•˜ê¸°</button>
                        <button class="quick-question-btn" onclick="askQuestion('ê³„ì • ê´€ë¦¬')">ğŸ‘¤ ê³„ì • ê´€ë¦¬</button>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', quickQuestionsHTML);
                scrollToBottom();
            }, 500);
        }

        function addBotMessage(message) {
            const messagesContainer = document.getElementById('chatbot-messages');
            const messageHTML = `
                <div class="chat-message bot">
                    <div class="bot-avatar">ğŸ¤–</div>
                    <div class="message-bubble bot">${message}</div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
            scrollToBottom();
        }

        function addUserMessage(message) {
            const messagesContainer = document.getElementById('chatbot-messages');
            const messageHTML = `
                <div class="chat-message user">
                    <div class="message-bubble user">${message}</div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
            scrollToBottom();
        }

        function askQuestion(question) {
            addUserMessage(question);

            setTimeout(() => {
                const answer = getChatbotAnswer(question);
                addBotMessage(answer);
            }, 500);
        }

        function getChatbotAnswer(question) {
            const answers = {
                'ì •ì‚° í”„ë¡œì„¸ìŠ¤': `<strong>ğŸ“‹ ì •ì‚° í”„ë¡œì„¸ìŠ¤</strong><br><br>
                    1ï¸âƒ£ <strong>ê³µêµ¬ ì§„í–‰</strong><br>
                    ì½˜í…ì¸  ì—…ë¡œë“œ â†’ ê³µêµ¬ ì§„í–‰ â†’ íŒë§¤ ì™„ë£Œ<br><br>
                    2ï¸âƒ£ <strong>ì •ì‚°ì„œ ìƒì„±</strong><br>
                    ê³µêµ¬ ì¢…ë£Œ í›„ ëª¨ì—¬ë¼ë”œì—ì„œ ìë™ ì •ì‚°ì„œ ìƒì„±<br><br>
                    3ï¸âƒ£ <strong>ì •ì‚° í™•ì¸</strong><br>
                    ì´ í¬í„¸ì—ì„œ ì •ì‚° ë‚´ì—­ í™•ì¸ ê°€ëŠ¥<br><br>
                    4ï¸âƒ£ <strong>ì‹¤ì§€ê¸‰</strong><br>
                    ì •ì‚° í™•ì • í›„ 3~7ì¼ ì´ë‚´ ì…ê¸ˆ<br><br>
                    ğŸ’¡ ì •ì‚°ì„œëŠ” ìƒë‹¨ ë©”ë‰´ì—ì„œ í™•ì¸í•˜ì„¸ìš”!`,

                'ìˆ˜ìˆ˜ë£Œ ì•ˆë‚´': `<strong>ğŸ’° ìˆ˜ìˆ˜ë£Œ ì•ˆë‚´</strong><br><br>
                    <strong>ê¸°ë³¸ ë§ˆì§„ìœ¨: 15~20%</strong><br><br>
                    âœ¨ <strong>ë“±ê¸‰ë³„ ìˆ˜ìˆ˜ë£Œ</strong><br>
                    â€¢ ì¼ë°˜: 15%<br>
                    â€¢ ì‹¤ë²„: 17%<br>
                    â€¢ ê³¨ë“œ: 20%<br>
                    â€¢ VIP: ë³„ë„ í˜‘ì˜<br><br>
                    ğŸ“ˆ íŒë§¤ ì‹¤ì ì— ë”°ë¼ ìë™ ë“±ê¸‰ ìƒí–¥!<br><br>
                    ğŸ’¡ ì›ì²œì„¸(3.3%) ê³µì œ í›„ ì§€ê¸‰<br>
                    ğŸ’¡ ì‹¤ì§€ê¸‰ì•¡ = ë§ˆì§„ê¸ˆ - ì›ì²œì„¸`,

                'ì£¼ë¬¸ ê´€ë¦¬': `<strong>ğŸ“¦ ì£¼ë¬¸ ê´€ë¦¬</strong><br><br>
                    ìƒë‹¨ ë©”ë‰´ "<strong>ì£¼ë¬¸í˜„í™©</strong>"ì—ì„œ í™•ì¸ ê°€ëŠ¥<br><br>
                    âœ… <strong>í™•ì¸ ê°€ëŠ¥ ì •ë³´</strong><br>
                    â€¢ ì‹¤ì‹œê°„ ì£¼ë¬¸ í˜„í™©<br>
                    â€¢ ë°°ì†¡ ìƒíƒœ<br>
                    â€¢ ê³ ê° ë¬¸ì˜ì‚¬í•­<br>
                    â€¢ ì·¨ì†Œ/ë°˜í’ˆ í˜„í™©<br><br>
                    ğŸ’¡ ì¹´í˜24 ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œê³¼ ì—°ë™ë˜ì–´ ìˆìŠµë‹ˆë‹¤!`,

                'ê³µêµ¬ ì§„í–‰': `<strong>ğŸ¯ ê³µêµ¬ ì§„í–‰ ê°€ì´ë“œ</strong><br><br>
                    1ï¸âƒ£ <strong>ìƒí’ˆ ì„ íƒ</strong><br>
                    ë‹´ë‹¹ ë§¤ë‹ˆì €ê°€ ê³„ì •ì— ë§ëŠ” ìƒí’ˆ ì¶”ì²œ<br><br>
                    2ï¸âƒ£ <strong>ì½˜í…ì¸  ì œì‘</strong><br>
                    â€¢ ì§ì ‘ ì œì‘ ë˜ëŠ”<br>
                    â€¢ ì— ë²„ì„œë” ì½˜í…ì¸  ê³µìœ <br><br>
                    3ï¸âƒ£ <strong>ê³µêµ¬ ê²Œì‹œ</strong><br>
                    ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ/ìŠ¤í† ë¦¬ ì—…ë¡œë“œ<br><br>
                    4ï¸âƒ£ <strong>ì£¼ë¬¸ ê´€ë¦¬</strong><br>
                    ì£¼ë¬¸ í™•ì¸ ë° ë°°ì†¡ ì¡°íšŒ<br><br>
                    ğŸ’¡ ì „ ê³¼ì • ë‹´ë‹¹ ë§¤ë‹ˆì €ê°€ ì¼€ì–´í•©ë‹ˆë‹¤!`,

                'ë¬¸ì˜í•˜ê¸°': `<strong>ğŸ’¬ ë¬¸ì˜í•˜ê¸°</strong><br><br>
                    <strong>ë‹´ë‹¹ ë§¤ë‹ˆì €ì—ê²Œ ì—°ë½</strong><br><br>
                    â€¢ ì¹´ì¹´ì˜¤í†¡ ì±„ë„: @ëª¨ì—¬ë¼ë”œ<br>
                    â€¢ ì´ë©”ì¼: contact@moyeora-deal.com<br>
                    â€¢ ì „í™”: 1544-0000<br><br>
                    <strong>ìš´ì˜ì‹œê°„</strong><br>
                    í‰ì¼ 10:00 - 18:00<br>
                    (ì ì‹¬ì‹œê°„ 12:00 - 13:00)<br><br>
                    ğŸ’¡ ê¸´ê¸‰ ë¬¸ì˜ëŠ” ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì£¼ì„¸ìš”!`,

                'ê³„ì • ê´€ë¦¬': `<strong>ğŸ‘¤ ê³„ì • ê´€ë¦¬</strong><br><br>
                    <strong>ê³„ì • ì •ë³´ ë³€ê²½</strong><br>
                    ë‹´ë‹¹ ë§¤ë‹ˆì €ì—ê²Œ ìš”ì²­<br><br>
                    <strong>ì •ì‚° ê³„ì¢Œ ë³€ê²½</strong><br>
                    ë‹´ë‹¹ ë§¤ë‹ˆì €ì—ê²Œ ìš”ì²­<br>
                    (í†µì¥ ì‚¬ë³¸ í•„ìš”)<br><br>
                    <strong>í™œë™ íœ´ì§€</strong><br>
                    ìµœì†Œ 1ê°œì›” ì „ ì‚¬ì „ í†µë³´<br><br>
                    ğŸ’¡ ì¤‘ìš” ì •ë³´ ë³€ê²½ ì‹œ ì„œë¥˜ í•„ìš”`
            };

            return answers[question] || `ì£„ì†¡í•©ë‹ˆë‹¤. "${question}"ì— ëŒ€í•œ ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.<br><br>ë‹´ë‹¹ ë§¤ë‹ˆì €ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”!`;
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatbot-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ì±—ë´‡ ì…ë ¥ ì²˜ë¦¬
        document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const input = e.target;
                const question = input.value.trim();
                if (question) {
                    askQuestion(question);
                    input.value = '';
                }
            }
        });
    </script>
</body>
</html>

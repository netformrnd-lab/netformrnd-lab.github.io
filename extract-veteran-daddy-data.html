<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë² í…Œë‘ëŒ€ë”” ë°ì´í„° ì¶”ì¶œ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #fc9600;
      padding-bottom: 10px;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #fc9600;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #e08600;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .data-count {
      font-size: 24px;
      font-weight: bold;
      color: #fc9600;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” ë² í…Œë‘ëŒ€ë”” ë°ì´í„° ì¶”ì¶œ ë„êµ¬</h1>

  <div class="section">
    <h2>1. ë°ì´í„° ì¶”ì¶œ</h2>
    <button onclick="extractData()" id="extractBtn">ë°ì´í„° ì¶”ì¶œ ì‹œì‘</button>
    <button onclick="exportToJSON()" id="exportBtn" disabled>JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
    <button onclick="copyToClipboard()" id="copyBtn" disabled>í´ë¦½ë³´ë“œì— ë³µì‚¬</button>
    <div id="status"></div>
  </div>

  <div class="section">
    <h2>2. ì¶”ì¶œëœ ë°ì´í„°</h2>
    <div id="results"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBlXq0tC0xYY9XHggkYM9k6rBOkqAEv-R8",
      authDomain: "moyeoradeal-test.firebaseapp.com",
      projectId: "moyeoradeal-test",
      storageBucket: "moyeoradeal-test.firebasestorage.app",
      messagingSenderId: "559819212501",
      appId: "1:559819212501:web:f43f1feff99c8ffbb4bfa1",
      measurementId: "G-G6CBXDQCN6"
    };

    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let extractedData = null;

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    async function extractData() {
      const extractBtn = document.getElementById('extractBtn');
      extractBtn.disabled = true;
      extractBtn.textContent = 'ì¶”ì¶œ ì¤‘...';

      showStatus('ğŸ” ë² í…Œë‘ëŒ€ë”” ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

      try {
        const data = {
          searchTerm: 'ë² í…Œë‘ëŒ€ë””',
          timestamp: new Date().toISOString(),
          suppliers: [],
          products: []
        };

        // 1. suppliers ì»¬ë ‰ì…˜ì—ì„œ ë² í…Œë‘ëŒ€ë”” ê²€ìƒ‰
        showStatus('ğŸ“‹ ê³µê¸‰ì‚¬(suppliers) ë°ì´í„° ê²€ìƒ‰ ì¤‘...', 'info');
        const suppliersSnapshot = await db.collection('suppliers').get();
        const allSuppliers = [];

        suppliersSnapshot.forEach(doc => {
          const supplierData = { id: doc.id, ...doc.data() };
          allSuppliers.push(supplierData);

          // ë² í…Œë‘ëŒ€ë””ì™€ ê´€ë ¨ëœ ë°ì´í„° ì°¾ê¸° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
          const searchFields = [
            supplierData.name,
            supplierData.brandName,
            supplierData.businessName,
            supplierData.representativeName,
            supplierData.contactPerson
          ].filter(Boolean).join(' ').toLowerCase();

          if (searchFields.includes('ë² í…Œë‘') ||
              searchFields.includes('ëŒ€ë””') ||
              searchFields.includes('ë² í…Œë‘ëŒ€ë””') ||
              searchFields.includes('veteran') ||
              searchFields.includes('daddy')) {
            data.suppliers.push(supplierData);
          }
        });

        // 2. supplierProducts ì»¬ë ‰ì…˜ì—ì„œ ë² í…Œë‘ëŒ€ë”” ê´€ë ¨ ìƒí’ˆ ê²€ìƒ‰
        showStatus('ğŸ›ï¸ ìƒí’ˆ(supplierProducts) ë°ì´í„° ê²€ìƒ‰ ì¤‘...', 'info');
        const productsSnapshot = await db.collection('supplierProducts').get();
        const allProducts = [];

        productsSnapshot.forEach(doc => {
          const productData = { id: doc.id, ...doc.data() };
          allProducts.push(productData);

          // ë² í…Œë‘ëŒ€ë””ì™€ ê´€ë ¨ëœ ìƒí’ˆ ì°¾ê¸°
          const searchFields = [
            productData.brandName,
            productData.supplierName,
            productData.productName
          ].filter(Boolean).join(' ').toLowerCase();

          if (searchFields.includes('ë² í…Œë‘') ||
              searchFields.includes('ëŒ€ë””') ||
              searchFields.includes('ë² í…Œë‘ëŒ€ë””') ||
              searchFields.includes('veteran') ||
              searchFields.includes('daddy')) {
            data.products.push(productData);
          }

          // supplierIdë¡œë„ ë§¤ì¹­
          if (data.suppliers.length > 0) {
            const supplierIds = data.suppliers.map(s => s.id);
            if (productData.supplierId && supplierIds.includes(productData.supplierId)) {
              // ì¤‘ë³µ ì²´í¬
              if (!data.products.find(p => p.id === productData.id)) {
                data.products.push(productData);
              }
            }
          }
        });

        // 3. ì „ì²´ í†µê³„ ì¶”ê°€
        data.statistics = {
          totalSuppliers: allSuppliers.length,
          totalProducts: allProducts.length,
          matchedSuppliers: data.suppliers.length,
          matchedProducts: data.products.length
        };

        extractedData = data;
        displayResults(data);

        if (data.suppliers.length === 0 && data.products.length === 0) {
          showStatus('âš ï¸ "ë² í…Œë‘ëŒ€ë””"ì™€ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ ê³µê¸‰ì‚¬ ëª©ë¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
        } else {
          showStatus(`âœ… ì¶”ì¶œ ì™„ë£Œ! ê³µê¸‰ì‚¬ ${data.suppliers.length}ê°œ, ìƒí’ˆ ${data.products.length}ê°œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success');
          document.getElementById('exportBtn').disabled = false;
          document.getElementById('copyBtn').disabled = false;
        }

      } catch (error) {
        console.error('Error:', error);
        showStatus(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      } finally {
        extractBtn.disabled = false;
        extractBtn.textContent = 'ë°ì´í„° ì¶”ì¶œ ì‹œì‘';
      }
    }

    function displayResults(data) {
      const resultsDiv = document.getElementById('results');

      let html = `
        <div class="data-count">
          ğŸ“Š ì „ì²´: ê³µê¸‰ì‚¬ ${data.statistics.totalSuppliers}ê°œ / ìƒí’ˆ ${data.statistics.totalProducts}ê°œ
        </div>
        <div class="data-count">
          âœ… ë§¤ì¹­: ê³µê¸‰ì‚¬ ${data.statistics.matchedSuppliers}ê°œ / ìƒí’ˆ ${data.statistics.matchedProducts}ê°œ
        </div>
        <hr>
      `;

      if (data.suppliers.length > 0) {
        html += '<h3>ğŸ¢ ë² í…Œë‘ëŒ€ë”” ê³µê¸‰ì‚¬ ì •ë³´</h3>';
        data.suppliers.forEach((supplier, index) => {
          html += `
            <div style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px;">
              <strong>#${index + 1} ${supplier.name || 'ì´ë¦„ì—†ìŒ'}</strong><br>
              <small>ID: ${supplier.id}</small><br>
              ${supplier.brandName ? `ë¸Œëœë“œëª…: ${supplier.brandName}<br>` : ''}
              ${supplier.businessName ? `ì‚¬ì—…ìëª…: ${supplier.businessName}<br>` : ''}
              ${supplier.representativeName ? `ëŒ€í‘œì: ${supplier.representativeName}<br>` : ''}
              ${supplier.contactPerson ? `ë‹´ë‹¹ì: ${supplier.contactPerson}<br>` : ''}
              ${supplier.phone ? `ì „í™”: ${supplier.phone}<br>` : ''}
              ${supplier.email ? `ì´ë©”ì¼: ${supplier.email}<br>` : ''}
              ìƒì„±ì¼: ${supplier.createdAt || 'N/A'}
            </div>
          `;
        });
      }

      if (data.products.length > 0) {
        html += '<h3>ğŸ“¦ ë² í…Œë‘ëŒ€ë”” ìƒí’ˆ ëª©ë¡</h3>';
        data.products.forEach((product, index) => {
          html += `
            <div style="margin: 10px 0; padding: 10px; background: #fff8f0; border-radius: 4px;">
              <strong>#${index + 1} ${product.productName || 'ìƒí’ˆëª… ì—†ìŒ'}</strong><br>
              <small>ID: ${product.id}</small><br>
              ë¸Œëœë“œ: ${product.brandName || 'N/A'}<br>
              ê³µê¸‰ì‚¬ID: ${product.supplierId || 'N/A'}<br>
              ê³µê¸‰ê°€: ${product.supplyPrice ? product.supplyPrice.toLocaleString() + 'ì›' : 'N/A'}<br>
              ì†Œë¹„ìê°€: ${product.retailPrice ? product.retailPrice.toLocaleString() + 'ì›' : 'N/A'}<br>
              ìƒì„±ì¼: ${product.createdAt || 'N/A'}
            </div>
          `;
        });
      }

      html += '<h3>ğŸ“„ ì „ì²´ ë°ì´í„° (JSON)</h3>';
      html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

      resultsDiv.innerHTML = html;
    }

    function exportToJSON() {
      if (!extractedData) return;

      const dataStr = JSON.stringify(extractedData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `ë² í…Œë‘ëŒ€ë””_ë°ì´í„°_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);

      showStatus('âœ… JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }

    function copyToClipboard() {
      if (!extractedData) return;

      const dataStr = JSON.stringify(extractedData, null, 2);
      navigator.clipboard.writeText(dataStr).then(() => {
        showStatus('âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }).catch(err => {
        showStatus('âŒ ë³µì‚¬ ì‹¤íŒ¨: ' + err.message, 'error');
      });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
    window.addEventListener('load', () => {
      showStatus('ğŸ‘† "ë°ì´í„° ì¶”ì¶œ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë² í…Œë‘ëŒ€ë”” ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.', 'info');
    });
  </script>
</body>
</html>

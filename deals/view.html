<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µêµ¬ ìƒí’ˆ - ëª¨ì—¬ë¼ë”œ</title>
    <meta name="description" content="ëª¨ì—¬ë¼ë”œ ê³µêµ¬ ìƒí’ˆ ìƒì„¸ í˜ì´ì§€">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Kakao SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.5.0/kakao.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* í—¤ë” */
        .header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 20px 0;
            margin-bottom: 40px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: #fc9600;
            text-decoration: none;
        }

        /* ë ˆí¼ëŸ´ ì•Œë¦¼ ë°°ë„ˆ */
        .referral-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 30px;
            display: none;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .referral-banner.active {
            display: flex;
        }

        .referral-icon {
            font-size: 48px;
            flex-shrink: 0;
        }

        .referral-content {
            flex: 1;
        }

        .referral-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .referral-desc {
            font-size: 15px;
            opacity: 0.95;
        }

        /* ìƒí’ˆ ì˜ì—­ */
        .product-section {
            background: white;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            margin-bottom: 40px;
        }

        .product-image-area {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .product-image {
            width: 100%;
            border-radius: 12px;
            background: #f8f9fa;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }

        .product-info-area {
            display: flex;
            flex-direction: column;
        }

        .deal-status {
            display: inline-block;
            padding: 6px 12px;
            background: #10b981;
            color: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
            width: fit-content;
        }

        .deal-status.upcoming { background: #3b82f6; }
        .deal-status.completed { background: #6b7280; }

        .product-title {
            font-size: 32px;
            font-weight: 800;
            color: #212529;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .product-meta {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 2px solid #f1f3f5;
        }

        .meta-item {
            font-size: 14px;
            color: #6c757d;
        }

        .product-price {
            margin-bottom: 32px;
        }

        .price-label {
            font-size: 15px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .price-amount {
            font-size: 36px;
            font-weight: 800;
            color: #212529;
        }

        .price-amount span {
            font-size: 20px;
            font-weight: 600;
            margin-left: 4px;
        }

        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn {
            flex: 1;
            padding: 18px 32px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #fc9600;
            color: white;
        }

        .btn-primary:hover {
            background: #e08800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(252, 150, 0, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-invite {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-invite:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* ë ˆí¼ëŸ´ ì„¹ì…˜ */
        .referral-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #fff5f0 100%);
            border-radius: 16px;
            padding: 32px;
            margin-top: 32px;
            border: 2px dashed #667eea;
        }

        .referral-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .referral-header h3 {
            font-size: 24px;
            font-weight: 800;
            color: #212529;
            margin-bottom: 8px;
        }

        .referral-header p {
            font-size: 15px;
            color: #6c757d;
        }

        .referral-rewards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .reward-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .reward-emoji {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .reward-label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .reward-amount {
            font-size: 28px;
            font-weight: 800;
            color: #667eea;
        }

        /* ìƒí’ˆ ì„¤ëª… */
        .product-description {
            font-size: 16px;
            line-height: 1.8;
            color: #495057;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid #f1f3f5;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .modal-emoji {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            color: #212529;
            margin-bottom: 8px;
        }

        .modal-desc {
            font-size: 15px;
            color: #6c757d;
        }

        .referral-link-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .referral-link-text {
            flex: 1;
            font-size: 14px;
            color: #495057;
            word-break: break-all;
            font-family: monospace;
        }

        .btn-copy {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-copy:hover {
            background: #5568d3;
        }

        .share-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn-share {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-kakao {
            background: #fee500;
            color: #3c1e1e;
        }

        .btn-link {
            background: #495057;
            color: white;
        }

        .btn-close {
            width: 100%;
            padding: 14px;
            background: #e9ecef;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            color: #495057;
        }

        .btn-close:hover {
            background: #dee2e6;
        }

        /* ë¡œë”© */
        .loading {
            text-align: center;
            padding: 100px 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #fc9600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .product-image-area {
                position: relative;
            }

            .product-title {
                font-size: 24px;
            }

            .price-amount {
                font-size: 28px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .referral-rewards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <div class="header-content">
            <a href="/" class="logo">ëª¨ì—¬ë¼ë”œ</a>
        </div>
    </div>

    <!-- ë ˆí¼ëŸ´ ì•Œë¦¼ ë°°ë„ˆ -->
    <div class="container">
        <div class="referral-banner" id="referralBanner">
            <div class="referral-icon">ğŸ</div>
            <div class="referral-content">
                <div class="referral-title">ì¹œêµ¬ ì´ˆëŒ€ í˜œíƒì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                <div class="referral-desc">ì§€ê¸ˆ êµ¬ë§¤í•˜ì‹œë©´ 3,000ì› ìºì‹œë°±ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆì–´ìš”</div>
            </div>
        </div>

        <!-- ë¡œë”© -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>ê³µêµ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ìƒí’ˆ ì„¹ì…˜ -->
        <div class="product-section" id="productSection" style="display: none;">
            <div class="product-grid">
                <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                <div class="product-image-area">
                    <img id="productImage" class="product-image" src="https://via.placeholder.com/600" alt="ìƒí’ˆ ì´ë¯¸ì§€">
                </div>

                <!-- ìƒí’ˆ ì •ë³´ -->
                <div class="product-info-area">
                    <div class="deal-status" id="dealStatus">ì§„í–‰ì¤‘</div>
                    <h1 class="product-title" id="productTitle">ê³µêµ¬ ìƒí’ˆëª…</h1>

                    <div class="product-meta">
                        <div class="meta-item">
                            <strong>ê³µêµ¬ ê¸°ê°„:</strong> <span id="dealPeriod">-</span>
                        </div>
                    </div>

                    <div class="product-price">
                        <div class="price-label">ê³µêµ¬ ê°€ê²©</div>
                        <div class="price-amount" id="productPrice">0<span>ì›</span></div>
                    </div>

                    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="btnBuy" onclick="goToShop()">
                            ğŸ›’ êµ¬ë§¤í•˜ê¸°
                        </button>
                        <button class="btn btn-invite" onclick="openReferralModal()">
                            ğŸ ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°
                        </button>
                    </div>

                    <!-- ë ˆí¼ëŸ´ ì„¹ì…˜ -->
                    <div class="referral-section">
                        <div class="referral-header">
                            <h3>ì¹œêµ¬ ì´ˆëŒ€í•˜ê³  í•¨ê»˜ í˜œíƒ ë°›ê¸°</h3>
                            <p>ì¹œêµ¬ê°€ êµ¬ë§¤í•˜ë©´ ë‘˜ ë‹¤ ìºì‹œë°±ì„ ë°›ì•„ìš”!</p>
                        </div>
                        <div class="referral-rewards">
                            <div class="reward-card">
                                <div class="reward-emoji">ğŸ˜Š</div>
                                <div class="reward-label">ë‚´ê°€ ë°›ëŠ” í˜œíƒ</div>
                                <div class="reward-amount" id="referrerReward">5,000ì›</div>
                            </div>
                            <div class="reward-card">
                                <div class="reward-emoji">ğŸ‰</div>
                                <div class="reward-label">ì¹œêµ¬ê°€ ë°›ëŠ” í˜œíƒ</div>
                                <div class="reward-amount" id="refereeReward">3,000ì›</div>
                            </div>
                        </div>
                    </div>

                    <!-- ìƒí’ˆ ì„¤ëª… -->
                    <div class="product-description" id="productDescription">
                        ìƒí’ˆ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë ˆí¼ëŸ´ ëª¨ë‹¬ -->
    <div class="modal" id="referralModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-emoji">ğŸ</div>
                <h3 class="modal-title">ì¹œêµ¬ ì´ˆëŒ€ ë§í¬</h3>
                <p class="modal-desc">ì´ ë§í¬ë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”!</p>
            </div>

            <div class="referral-link-box">
                <div class="referral-link-text" id="referralLinkText">ìƒì„± ì¤‘...</div>
                <button class="btn-copy" onclick="copyReferralLink()">ë³µì‚¬</button>
            </div>

            <div class="share-buttons">
                <button class="btn-share btn-kakao" onclick="shareKakao()">
                    ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
                </button>
                <button class="btn-share btn-link" onclick="copyReferralLink()">
                    ğŸ”— ë§í¬ ë³µì‚¬
                </button>
            </div>

            <button class="btn-close" onclick="closeReferralModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBK0U0xF5_CsLlF8jM6sM0VWF2MR7rLScc",
            authDomain: "moyeora-deal-manager.firebaseapp.com",
            projectId: "moyeora-deal-manager",
            storageBucket: "moyeora-deal-manager.appspot.com",
            messagingSenderId: "878495183009",
            appId: "1:878495183009:web:7c7f5f3b6c3d5f5f5f5f5f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Kakao SDK ì´ˆê¸°í™”
        if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
            Kakao.init('YOUR_KAKAO_JS_KEY'); // ì‹¤ì œ í‚¤ë¡œ êµì²´ í•„ìš”
        }

        // ì „ì—­ ë³€ìˆ˜
        let currentDeal = null;
        let currentReferralCode = null;
        let shopProductUrl = null; // ì•„ì„ì›¹ ë˜ëŠ” ì¹´í˜24 ìƒí’ˆ URL

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê°’ ì¶”ì¶œ
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // ì¿ í‚¤ ì €ì¥
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + d.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        // ì¿ í‚¤ ì½ê¸°
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', async () => {
            const dealId = getUrlParam('id');
            const referralCode = getUrlParam('ref');

            if (!dealId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                return;
            }

            // ë ˆí¼ëŸ´ ì½”ë“œ ì²˜ë¦¬
            if (referralCode) {
                // ì¿ í‚¤ì— ì €ì¥ (7ì¼ê°„ ìœ íš¨)
                setCookie('moyeora_ref', referralCode, 7);

                // ë ˆí¼ëŸ´ ë°°ë„ˆ í‘œì‹œ
                document.getElementById('referralBanner').classList.add('active');

                // Firestoreì— í´ë¦­ ì¶”ì 
                try {
                    await db.collection('referrals').doc(referralCode).update({
                        clicks: firebase.firestore.FieldValue.increment(1),
                        lastClickAt: new Date()
                    });
                    console.log('âœ… ë ˆí¼ëŸ´ í´ë¦­ ì¶”ì :', referralCode);
                } catch (error) {
                    console.error('ë ˆí¼ëŸ´ ì¶”ì  ì˜¤ë¥˜:', error);
                }
            } else {
                // ê¸°ì¡´ ì¿ í‚¤ í™•ì¸
                const existingRef = getCookie('moyeora_ref');
                if (existingRef) {
                    document.getElementById('referralBanner').classList.add('active');
                }
            }

            // ê³µêµ¬ ì •ë³´ ë¡œë“œ
            await loadDealInfo(dealId);
        });

        // ê³µêµ¬ ì •ë³´ ë¡œë“œ
        async function loadDealInfo(dealId) {
            try {
                const dealDoc = await db.collection('deals').doc(dealId).get();

                if (!dealDoc.exists) {
                    alert('í•´ë‹¹ ê³µêµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                currentDeal = { id: dealDoc.id, ...dealDoc.data() };

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('productTitle').textContent = currentDeal.title || 'ê³µêµ¬ ìƒí’ˆ';

                // ê³µêµ¬ ìƒíƒœ
                const status = currentDeal.status || 'ongoing';
                const statusEl = document.getElementById('dealStatus');
                if (status === 'ongoing') {
                    statusEl.textContent = 'ì§„í–‰ì¤‘';
                    statusEl.classList.remove('upcoming', 'completed');
                } else if (status === 'confirmed') {
                    statusEl.textContent = 'ì§„í–‰ ì˜ˆì •';
                    statusEl.classList.add('upcoming');
                } else if (status === 'completed') {
                    statusEl.textContent = 'ì¢…ë£Œ';
                    statusEl.classList.add('completed');
                }

                // ê³µêµ¬ ê¸°ê°„
                if (currentDeal.startDate && currentDeal.endDate) {
                    document.getElementById('dealPeriod').textContent =
                        `${currentDeal.startDate} ~ ${currentDeal.endDate}`;
                }

                // ê°€ê²© (ì²« ë²ˆì§¸ ìƒí’ˆ ê°€ê²© í‘œì‹œ)
                if (currentDeal.selectedProducts && currentDeal.selectedProducts.length > 0) {
                    const product = currentDeal.selectedProducts[0];
                    const price = product.supplyPrice || 0;
                    document.getElementById('productPrice').innerHTML =
                        `${price.toLocaleString()}<span>ì›</span>`;
                }

                // ìºì‹œë°± ê¸ˆì•¡
                document.getElementById('referrerReward').textContent =
                    `${(currentDeal.referrerCashback || 5000).toLocaleString()}ì›`;
                document.getElementById('refereeReward').textContent =
                    `${(currentDeal.refereeCashback || 3000).toLocaleString()}ì›`;

                // ìƒí’ˆ ì„¤ëª…
                document.getElementById('productDescription').textContent =
                    currentDeal.notes || currentDeal.description || 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';

                // ì‡¼í•‘ëª° ìƒí’ˆ URL (ì•„ì„ì›¹ ìš°ì„ , ì—†ìœ¼ë©´ ì¹´í˜24)
                if (currentDeal.imwebProductUrl) {
                    // ì•„ì„ì›¹ ìƒí’ˆ URL (ì§ì ‘ ì…ë ¥ëœ URL ì‚¬ìš©)
                    shopProductUrl = currentDeal.imwebProductUrl;
                } else if (currentDeal.imwebProductNo) {
                    // ì•„ì„ì›¹ ìƒí’ˆ ë²ˆí˜¸ë¡œ URL ìƒì„± (ì‚¬ì´íŠ¸ URL í•„ìš”)
                    const imwebSiteUrl = currentDeal.imwebSiteUrl || 'https://YOUR_IMWEB_SITE.imweb.me';
                    shopProductUrl = `${imwebSiteUrl}/shop_view/?idx=${currentDeal.imwebProductNo}`;
                } else if (currentDeal.cafe24ProductNo) {
                    // ì¹´í˜24 URL (ë ˆê±°ì‹œ ì§€ì›)
                    shopProductUrl = `https://YOUR_CAFE24_MALL.cafe24.com/product/detail.html?product_no=${currentDeal.cafe24ProductNo}`;
                }

                // ë¡œë”© ìˆ¨ê¸°ê³  ìƒí’ˆ í‘œì‹œ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('productSection').style.display = 'block';

            } catch (error) {
                console.error('ê³µêµ¬ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ê³µêµ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‡¼í•‘ëª°ë¡œ ì´ë™ (ì•„ì„ì›¹/ì¹´í˜24)
        function goToShop() {
            if (!shopProductUrl) {
                alert('êµ¬ë§¤ í˜ì´ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const referralCode = getCookie('moyeora_ref');

            if (referralCode) {
                // ë ˆí¼ëŸ´ ì½”ë“œë¥¼ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
                const separator = shopProductUrl.includes('?') ? '&' : '?';
                window.location.href = `${shopProductUrl}${separator}ref=${referralCode}`;
            } else {
                // ì¼ë°˜ êµ¬ë§¤
                window.location.href = shopProductUrl;
            }
        }

        // ë ˆê±°ì‹œ í•¨ìˆ˜ëª… ì§€ì›
        function goToCafe24() {
            goToShop();
        }

        // ë ˆí¼ëŸ´ ëª¨ë‹¬ ì—´ê¸°
        async function openReferralModal() {
            if (!currentDeal) {
                alert('ê³µêµ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë ˆí¼ëŸ´ ì½”ë“œ ìƒì„± (ì„ì‹œë¡œ ì‚¬ìš©ì ID ì—†ì´)
            // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID ì‚¬ìš©
            const userId = 'user_' + Date.now(); // ì„ì‹œ ID

            try {
                // ë ˆí¼ëŸ´ ì½”ë“œ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ (Adminì—ì„œ êµ¬í˜„í•œ í•¨ìˆ˜)
                currentReferralCode = await generateReferralCodeForDeal(userId, currentDeal.id, currentDeal.title);

                // ë ˆí¼ëŸ´ ë§í¬ ìƒì„±
                const referralLink = `${window.location.origin}/deals/view.html?id=${currentDeal.id}&ref=${currentReferralCode}`;

                document.getElementById('referralLinkText').textContent = referralLink;
                document.getElementById('referralModal').classList.add('active');

            } catch (error) {
                console.error('ë ˆí¼ëŸ´ ë§í¬ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ì´ˆëŒ€ ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë ˆí¼ëŸ´ ì½”ë“œ ìƒì„± (Admin í•¨ìˆ˜ ë³µì œ)
        async function generateReferralCodeForDeal(userId, dealId, dealTitle) {
            let code;
            let attempts = 0;
            const maxAttempts = 5;

            while (attempts < maxAttempts) {
                code = Math.random().toString(36).substring(2, 10).toUpperCase();

                const existing = await db.collection('referrals').doc(code).get();
                if (!existing.exists) {
                    break;
                }
                attempts++;
            }

            if (attempts >= maxAttempts) {
                throw new Error('ë ˆí¼ëŸ´ ì½”ë“œ ìƒì„± ì‹¤íŒ¨');
            }

            const referralData = {
                referralCode: code,
                referrerId: userId,
                dealId: dealId,
                dealTitle: dealTitle || '',
                createdAt: new Date(),
                expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                clicks: 0,
                conversions: 0,
                totalSales: 0,
                referrerCashback: 0,
                refereeCashback: 0,
                totalCashback: 0,
                status: 'active',
                purchases: []
            };

            await db.collection('referrals').doc(code).set(referralData);
            console.log('âœ… ë ˆí¼ëŸ´ ì½”ë“œ ìƒì„±:', code);

            return code;
        }

        // ë ˆí¼ëŸ´ ëª¨ë‹¬ ë‹«ê¸°
        function closeReferralModal() {
            document.getElementById('referralModal').classList.remove('active');
        }

        // ë ˆí¼ëŸ´ ë§í¬ ë³µì‚¬
        async function copyReferralLink() {
            const linkText = document.getElementById('referralLinkText').textContent;

            try {
                await navigator.clipboard.writeText(linkText);
                alert('âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë³µì‚¬ ì˜¤ë¥˜:', error);
                alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
        function shareKakao() {
            if (typeof Kakao === 'undefined' || !Kakao.isInitialized()) {
                alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const referralLink = document.getElementById('referralLinkText').textContent;

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: `ğŸ ${currentDeal.title}`,
                    description: `ì¹œêµ¬ ì´ˆëŒ€ í˜œíƒ! ì§€ê¸ˆ ê°€ì…í•˜ë©´ ${(currentDeal.refereeCashback || 3000).toLocaleString()}ì› ìºì‹œë°±`,
                    imageUrl: 'https://moyeoradeal.com/images/share-thumbnail.jpg', // ì‹¤ì œ ì´ë¯¸ì§€ë¡œ êµì²´
                    link: {
                        mobileWebUrl: referralLink,
                        webUrl: referralLink
                    }
                },
                buttons: [
                    {
                        title: 'ìì„¸íˆ ë³´ê¸°',
                        link: {
                            mobileWebUrl: referralLink,
                            webUrl: referralLink
                        }
                    }
                ]
            });
        }
    </script>
</body>
</html>

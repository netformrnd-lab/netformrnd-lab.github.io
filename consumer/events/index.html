<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë²¤íŠ¸ - ëª¨ì—¬ë¼ë”œ</title>
    <meta name="description" content="ëª¨ì—¬ë¼ë”œ ì´ë²¤íŠ¸ í˜ì´ì§€">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.6;
        }

        /* í—¤ë” */
        .header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            color: #fc9600;
            text-decoration: none;
        }

        .header-back {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            color: #495057;
            cursor: pointer;
            text-decoration: none;
        }

        /* ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #fc9600;
            color: white;
        }

        /* íƒ­ ì½˜í…ì¸  */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ì´ë²¤íŠ¸ ì¹´ë“œ */
        .event-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .event-image {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
        }

        .event-content {
            padding: 20px;
        }

        .event-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .event-badge.ongoing {
            background: #10b981;
            color: white;
        }

        .event-badge.ended {
            background: #6b7280;
            color: white;
        }

        .event-badge.upcoming {
            background: #3b82f6;
            color: white;
        }

        .event-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .event-desc {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 12px;
        }

        .event-reward {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #fff8f0;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .event-reward-icon {
            font-size: 24px;
        }

        .event-reward-text {
            font-size: 14px;
            font-weight: 600;
            color: #fc9600;
        }

        .event-meta {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #adb5bd;
        }

        .event-btn {
            width: 100%;
            padding: 14px;
            background: #fc9600;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .event-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        /* ì„ ì°©ìˆœ ì´ë²¤íŠ¸ í”„ë¡œê·¸ë ˆìŠ¤ */
        .flash-progress {
            margin-top: 12px;
        }

        .flash-progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .flash-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fc9600, #f97316);
            border-radius: 4px;
        }

        .flash-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #6c757d;
        }

        /* í›„ê¸° ì´ë²¤íŠ¸ ì„¹ì…˜ */
        .review-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* í›„ê¸° ì‘ì„± í¼ */
        .review-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #fc9600;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* ë¯¸ë””ì–´ ì—…ë¡œë“œ */
        .media-upload {
            margin-bottom: 16px;
        }

        .media-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .media-upload-area:hover {
            border-color: #fc9600;
            background: #fff8f0;
        }

        .media-upload-area.dragover {
            border-color: #fc9600;
            background: #fff8f0;
        }

        .media-upload-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .media-upload-text {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .media-upload-hint {
            font-size: 12px;
            color: #adb5bd;
        }

        .media-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 16px;
        }

        .media-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
        }

        .media-preview-item img,
        .media-preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-submit-review {
            width: 100%;
            padding: 16px;
            background: #fc9600;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-submit-review:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        /* í›„ê¸° ëª©ë¡ */
        .review-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .review-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .review-author {
            font-size: 14px;
            font-weight: 600;
        }

        .review-date {
            font-size: 12px;
            color: #adb5bd;
        }

        .review-product {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .review-media {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .review-media-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        .review-media-item img,
        .review-media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .review-text {
            font-size: 14px;
            color: #495057;
            line-height: 1.7;
        }

        .review-reward-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #fff8f0;
            color: #fc9600;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #adb5bd;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 15px;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-media {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #212529;
            color: white;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.active {
            opacity: 1;
        }

        /* ë¡œë”© */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #fc9600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <div class="header-content">
            <a href="/" class="logo">ëª¨ì—¬ë¼ë”œ</a>
            <a href="/consumer/my-cashback/" class="header-back">ë‚´ ìºì‹œë°±</a>
        </div>
    </div>

    <div class="container">
        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('review')">í›„ê¸° ì´ë²¤íŠ¸</button>
            <button class="tab-btn" onclick="switchTab('flash')">ì„ ì°©ìˆœ ì´ë²¤íŠ¸</button>
            <button class="tab-btn" onclick="switchTab('special')">íŠ¹ë³„ ì´ë²¤íŠ¸</button>
        </div>

        <!-- í›„ê¸° ì´ë²¤íŠ¸ íƒ­ -->
        <div class="tab-content active" id="tab-review">
            <!-- í›„ê¸° ì‘ì„± -->
            <div class="review-section">
                <div class="section-title">
                    <span>ğŸ“</span> í›„ê¸° ì‘ì„±í•˜ê³  í˜ì´ë°± ë°›ê¸°
                </div>

                <div class="review-form">
                    <div class="form-group">
                        <label class="form-label">êµ¬ë§¤ ìƒí’ˆ ì„ íƒ</label>
                        <select class="form-select" id="reviewProductSelect">
                            <option value="">ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ì£¼ë¬¸ë²ˆí˜¸ (ì„ íƒ)</label>
                        <input type="text" class="form-input" id="reviewOrderId" placeholder="ì¹´í˜24 ì£¼ë¬¸ë²ˆí˜¸">
                    </div>

                    <div class="media-upload">
                        <label class="form-label">ì‚¬ì§„/ë™ì˜ìƒ ì²¨ë¶€ (í•„ìˆ˜)</label>
                        <div class="media-upload-area" id="mediaUploadArea" onclick="document.getElementById('mediaInput').click()">
                            <div class="media-upload-icon">ğŸ“·</div>
                            <div class="media-upload-text">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                            <div class="media-upload-hint">ì´ë¯¸ì§€ ë˜ëŠ” ë™ì˜ìƒ ìµœëŒ€ 5ê°œ, ê° 10MB ì´í•˜</div>
                        </div>
                        <input type="file" id="mediaInput" accept="image/*,video/*" multiple style="display: none;" onchange="handleMediaUpload(event)">
                        <div class="media-preview" id="mediaPreview"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">í›„ê¸° ë‚´ìš©</label>
                        <textarea class="form-textarea" id="reviewContent" placeholder="ìƒí’ˆ ì‚¬ìš© í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš” (ìµœì†Œ 20ì)"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ì—°ë½ì²˜ (ìºì‹œë°± ì§€ê¸‰ìš©)</label>
                        <input type="tel" class="form-input" id="reviewPhone" placeholder="010-0000-0000">
                    </div>

                    <button class="btn-submit-review" onclick="submitReview()">
                        í›„ê¸° ë“±ë¡í•˜ê³  í˜ì´ë°± ë°›ê¸°
                    </button>
                </div>

                <!-- ë¦¬ì›Œë“œ ì•ˆë‚´ -->
                <div class="event-reward">
                    <span class="event-reward-icon">ğŸ</span>
                    <span class="event-reward-text">í…ìŠ¤íŠ¸ í›„ê¸° 1,000ì› / ì‚¬ì§„ í›„ê¸° 2,000ì› / ì˜ìƒ í›„ê¸° 5,000ì›</span>
                </div>
            </div>

            <!-- í›„ê¸° ëª©ë¡ -->
            <div class="review-section">
                <div class="section-title">
                    <span>ğŸ’¬</span> ìµœê·¼ í›„ê¸°
                </div>
                <div class="review-list" id="reviewList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„ ì°©ìˆœ ì´ë²¤íŠ¸ íƒ­ -->
        <div class="tab-content" id="tab-flash">
            <div id="flashEventList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- íŠ¹ë³„ ì´ë²¤íŠ¸ íƒ­ -->
        <div class="tab-content" id="tab-special">
            <div id="specialEventList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¯¸ë””ì–´ ë·°ì–´ ëª¨ë‹¬ -->
    <div class="modal" id="mediaModal" onclick="closeMediaModal()">
        <button class="modal-close" onclick="closeMediaModal()">X</button>
        <img class="modal-media" id="modalImage" src="" alt="">
        <video class="modal-media" id="modalVideo" src="" controls style="display: none;"></video>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
            authDomain: "moyeora-deal-manager.firebaseapp.com",
            projectId: "moyeora-deal-manager",
            storageBucket: "moyeora-deal-manager.firebasestorage.app",
            messagingSenderId: "878495183009",
            appId: "1:878495183009:web:7c7f5f3b6c3d5f5f5f5f5f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ì „ì—­ ë³€ìˆ˜
        let uploadedFiles = [];
        let deals = [];

        // í† ìŠ¤íŠ¸
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(
                    tabName === 'review' ? 'í›„ê¸°' :
                    tabName === 'flash' ? 'ì„ ì°©ìˆœ' : 'íŠ¹ë³„'
                ));
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                loadDeals(),
                loadReviews(),
                loadFlashEvents(),
                loadSpecialEvents()
            ]);
        });

        // ê³µêµ¬ ìƒí’ˆ ëª©ë¡ ë¡œë“œ
        async function loadDeals() {
            try {
                const snapshot = await db.collection('deals')
                    .where('status', 'in', ['ongoing', 'active', 'completed'])
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();

                deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const select = document.getElementById('reviewProductSelect');
                deals.forEach(deal => {
                    const option = document.createElement('option');
                    option.value = deal.id;
                    option.textContent = deal.title;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('ê³µêµ¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // í›„ê¸° ëª©ë¡ ë¡œë“œ
        async function loadReviews() {
            try {
                const snapshot = await db.collection('reviews')
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();

                const listEl = document.getElementById('reviewList');

                if (snapshot.empty) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div class="empty-state-text">ì•„ì§ ì‘ì„±ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = snapshot.docs.map(doc => {
                    const review = doc.data();
                    const hasVideo = review.mediaUrls?.some(url => url.includes('.mp4') || url.includes('.mov') || url.includes('.webm'));
                    const hasImage = review.mediaUrls?.some(url => !url.includes('.mp4') && !url.includes('.mov') && !url.includes('.webm'));

                    let rewardAmount = 1000; // í…ìŠ¤íŠ¸
                    if (hasVideo) rewardAmount = 5000;
                    else if (hasImage) rewardAmount = 2000;

                    return `
                        <div class="review-item">
                            <div class="review-header">
                                <div class="review-author">${maskPhone(review.phone)}</div>
                                <div class="review-date">${formatDate(review.createdAt)}</div>
                            </div>
                            <div class="review-product">${review.productTitle || 'ìƒí’ˆëª…'}</div>
                            ${review.mediaUrls?.length ? `
                                <div class="review-media">
                                    ${review.mediaUrls.slice(0, 3).map(url => `
                                        <div class="review-media-item" onclick="openMediaModal('${url}')">
                                            ${url.includes('.mp4') || url.includes('.mov') || url.includes('.webm')
                                                ? `<video src="${url}"></video>`
                                                : `<img src="${url}" alt="í›„ê¸° ì´ë¯¸ì§€">`
                                            }
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="review-text">${review.content}</div>
                            <div class="review-reward-badge">
                                ğŸ ${rewardAmount.toLocaleString()}ì› í˜ì´ë°± ì§€ê¸‰
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('í›„ê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('reviewList').innerHTML = '<div class="empty-state">í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ë¡œë“œ
        async function loadFlashEvents() {
            try {
                const snapshot = await db.collection('deals')
                    .where('flashSale.enabled', '==', true)
                    .orderBy('createdAt', 'desc')
                    .get();

                const listEl = document.getElementById('flashEventList');

                if (snapshot.empty) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš¡</div>
                            <div class="empty-state-text">ì§„í–‰ ì¤‘ì¸ ì„ ì°©ìˆœ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = snapshot.docs.map(doc => {
                    const deal = doc.data();
                    const flashSale = deal.flashSale || {};
                    const current = flashSale.currentCount || 0;
                    const total = flashSale.totalSlots || 100;
                    const progress = (current / total) * 100;
                    const isEnded = current >= total;

                    return `
                        <div class="event-card">
                            <div class="event-content">
                                <span class="event-badge ${isEnded ? 'ended' : 'ongoing'}">
                                    ${isEnded ? 'ë§ˆê°' : 'ì§„í–‰ì¤‘'}
                                </span>
                                <h3 class="event-title">${deal.title} - ì„ ì°©ìˆœ ì´ë²¤íŠ¸</h3>
                                <p class="event-desc">ì„ ì°©ìˆœ ${total}ëª…ì—ê²Œ íŠ¹ë³„ í˜œíƒì„ ë“œë¦½ë‹ˆë‹¤!</p>

                                <div class="flash-progress">
                                    <div class="flash-progress-bar">
                                        <div class="flash-progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="flash-progress-text">
                                        <span>${current}ëª… ì°¸ì—¬</span>
                                        <span>ì„ ì°©ìˆœ ${total}ëª…</span>
                                    </div>
                                </div>

                                <div class="event-reward">
                                    <span class="event-reward-icon">ğŸ</span>
                                    <span class="event-reward-text">${(flashSale.reward || 5000).toLocaleString()}ì› í˜ì´ë°±</span>
                                </div>

                                <button class="event-btn" ${isEnded ? 'disabled' : ''}
                                    onclick="location.href='/consumer/product/?id=${doc.id}'">
                                    ${isEnded ? 'ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ì°¸ì—¬í•˜ê¸°'}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // íŠ¹ë³„ ì´ë²¤íŠ¸ ë¡œë“œ
        async function loadSpecialEvents() {
            try {
                const snapshot = await db.collection('events')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                const listEl = document.getElementById('specialEventList');

                if (snapshot.empty) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‰</div>
                            <div class="empty-state-text">ì§„í–‰ ì¤‘ì¸ íŠ¹ë³„ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = snapshot.docs.map(doc => {
                    const event = doc.data();
                    const now = new Date();
                    const endDate = event.endDate?.toDate ? event.endDate.toDate() : new Date(event.endDate);
                    const isEnded = endDate < now;

                    return `
                        <div class="event-card">
                            ${event.imageUrl ? `<img class="event-image" src="${event.imageUrl}" alt="${event.title}">` : ''}
                            <div class="event-content">
                                <span class="event-badge ${isEnded ? 'ended' : 'ongoing'}">
                                    ${isEnded ? 'ì¢…ë£Œ' : 'ì§„í–‰ì¤‘'}
                                </span>
                                <h3 class="event-title">${event.title}</h3>
                                <p class="event-desc">${event.description}</p>
                                <div class="event-reward">
                                    <span class="event-reward-icon">ğŸ</span>
                                    <span class="event-reward-text">${event.rewardText || 'ë‹¤ì–‘í•œ í˜œíƒ'}</span>
                                </div>
                                <div class="event-meta">
                                    <span>ê¸°ê°„: ${formatDate(event.startDate)} ~ ${formatDate(event.endDate)}</span>
                                </div>
                                <button class="event-btn" ${isEnded ? 'disabled' : ''}
                                    onclick="location.href='${event.linkUrl || '#'}'">
                                    ${isEnded ? 'ì¢…ë£Œëœ ì´ë²¤íŠ¸ì…ë‹ˆë‹¤' : 'ì°¸ì—¬í•˜ê¸°'}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('íŠ¹ë³„ ì´ë²¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¯¸ë””ì–´ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
        function handleMediaUpload(event) {
            const files = Array.from(event.target.files);

            if (uploadedFiles.length + files.length > 5) {
                showToast('ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`${file.name}ì€(ëŠ”) 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                    return;
                }

                uploadedFiles.push(file);
            });

            renderMediaPreview();
        }

        function renderMediaPreview() {
            const previewEl = document.getElementById('mediaPreview');

            previewEl.innerHTML = uploadedFiles.map((file, index) => {
                const url = URL.createObjectURL(file);
                const isVideo = file.type.startsWith('video/');

                return `
                    <div class="media-preview-item">
                        ${isVideo
                            ? `<video src="${url}"></video>`
                            : `<img src="${url}" alt="ë¯¸ë¦¬ë³´ê¸°">`
                        }
                        <button class="media-preview-remove" onclick="removeMedia(${index})">X</button>
                    </div>
                `;
            }).join('');
        }

        function removeMedia(index) {
            uploadedFiles.splice(index, 1);
            renderMediaPreview();
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadArea = document.getElementById('mediaUploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFilesUpload(files);
            });
        }

        function handleFilesUpload(files) {
            if (uploadedFiles.length + files.length > 5) {
                showToast('ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            files.forEach(file => {
                if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                    showToast(`${file.name}ì€(ëŠ”) ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤.`);
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    showToast(`${file.name}ì€(ëŠ”) 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                    return;
                }

                uploadedFiles.push(file);
            });

            renderMediaPreview();
        }

        // í›„ê¸° ì œì¶œ
        async function submitReview() {
            const productId = document.getElementById('reviewProductSelect').value;
            const orderId = document.getElementById('reviewOrderId').value.trim();
            const content = document.getElementById('reviewContent').value.trim();
            const phone = document.getElementById('reviewPhone').value.trim();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!productId) {
                showToast('ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (uploadedFiles.length === 0) {
                showToast('ì‚¬ì§„ ë˜ëŠ” ë™ì˜ìƒì„ 1ê°œ ì´ìƒ ì²¨ë¶€í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (content.length < 20) {
                showToast('í›„ê¸° ë‚´ìš©ì„ 20ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!phone) {
                showToast('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const submitBtn = document.querySelector('.btn-submit-review');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';

            try {
                // íŒŒì¼ ì—…ë¡œë“œ
                const mediaUrls = [];
                for (const file of uploadedFiles) {
                    const fileName = `reviews/${Date.now()}_${Math.random().toString(36).substring(2, 8)}_${file.name}`;
                    const ref = storage.ref(fileName);
                    await ref.put(file);
                    const url = await ref.getDownloadURL();
                    mediaUrls.push(url);
                }

                // í˜ì´ë°± ê¸ˆì•¡ ê³„ì‚°
                const hasVideo = uploadedFiles.some(f => f.type.startsWith('video/'));
                const hasImage = uploadedFiles.some(f => f.type.startsWith('image/'));
                let rewardAmount = 1000;
                if (hasVideo) rewardAmount = 5000;
                else if (hasImage) rewardAmount = 2000;

                // ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const selectedDeal = deals.find(d => d.id === productId);

                // Firestoreì— ì €ì¥
                await db.collection('reviews').add({
                    dealId: productId,
                    productTitle: selectedDeal?.title || '',
                    orderId: orderId,
                    content: content,
                    mediaUrls: mediaUrls,
                    phone: phone,
                    rewardAmount: rewardAmount,
                    status: 'pending', // pending -> approved -> rewarded
                    createdAt: new Date()
                });

                // ì„±ê³µ
                showToast(`í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê²€í†  í›„ ${rewardAmount.toLocaleString()}ì›ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.`);

                // í¼ ì´ˆê¸°í™”
                document.getElementById('reviewProductSelect').value = '';
                document.getElementById('reviewOrderId').value = '';
                document.getElementById('reviewContent').value = '';
                uploadedFiles = [];
                renderMediaPreview();

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadReviews();

            } catch (error) {
                console.error('í›„ê¸° ë“±ë¡ ì˜¤ë¥˜:', error);
                showToast('í›„ê¸° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'í›„ê¸° ë“±ë¡í•˜ê³  í˜ì´ë°± ë°›ê¸°';
            }
        }

        // ë¯¸ë””ì–´ ëª¨ë‹¬
        function openMediaModal(url) {
            const modal = document.getElementById('mediaModal');
            const image = document.getElementById('modalImage');
            const video = document.getElementById('modalVideo');

            const isVideo = url.includes('.mp4') || url.includes('.mov') || url.includes('.webm');

            if (isVideo) {
                image.style.display = 'none';
                video.style.display = 'block';
                video.src = url;
            } else {
                video.style.display = 'none';
                image.style.display = 'block';
                image.src = url;
            }

            modal.classList.add('active');
        }

        function closeMediaModal() {
            const modal = document.getElementById('mediaModal');
            const video = document.getElementById('modalVideo');
            video.pause();
            modal.classList.remove('active');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function maskPhone(phone) {
            if (!phone) return 'ìµëª…';
            return phone.replace(/(\d{3})-?(\d{2})\d{2}-?(\d{4})/, '$1-**$3');
        }

        function formatDate(date) {
            if (!date) return '';
            const d = date.toDate ? date.toDate() : new Date(date);
            return `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}`;
        }
    </script>
</body>
</html>

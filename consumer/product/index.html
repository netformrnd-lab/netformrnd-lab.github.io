<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ìƒì„¸ - ëª¨ì—¬ë¼ë”œ</title>
    <meta name="description" content="ëª¨ì—¬ë¼ë”œ ê³µêµ¬ ìƒí’ˆ ìƒì„¸ í˜ì´ì§€">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Kakao SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.5.0/kakao.min.js"></script>

    <!-- Swiper -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.6;
        }

        /* í—¤ë” */
        .header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            color: #fc9600;
            text-decoration: none;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            color: #495057;
            cursor: pointer;
            text-decoration: none;
        }

        /* ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        /* ë ˆí¼ëŸ´ ë°°ë„ˆ */
        .referral-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .referral-banner.active {
            display: flex;
        }

        .referral-banner-icon {
            font-size: 32px;
        }

        .referral-banner-text {
            flex: 1;
        }

        .referral-banner-title {
            font-size: 15px;
            font-weight: 700;
        }

        .referral-banner-desc {
            font-size: 13px;
            opacity: 0.9;
        }

        /* ìƒí’ˆ ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” */
        .product-gallery {
            background: white;
        }

        .product-gallery .swiper-slide img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
        }

        .product-gallery .swiper-pagination-bullet-active {
            background: #fc9600;
        }

        /* ìƒí’ˆ ì •ë³´ */
        .product-info {
            background: white;
            padding: 20px;
            border-bottom: 8px solid #f1f3f5;
        }

        .product-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-status {
            background: #10b981;
            color: white;
        }

        .badge-status.upcoming {
            background: #3b82f6;
        }

        .badge-status.ended {
            background: #6b7280;
        }

        .badge-limited {
            background: #ef4444;
            color: white;
        }

        .badge-hot {
            background: #f97316;
            color: white;
        }

        .product-title {
            font-size: 20px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .product-subtitle {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 16px;
        }

        .price-section {
            margin-bottom: 16px;
        }

        .original-price {
            font-size: 14px;
            color: #adb5bd;
            text-decoration: line-through;
        }

        .sale-price {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .discount-rate {
            font-size: 22px;
            font-weight: 800;
            color: #ef4444;
        }

        .current-price {
            font-size: 26px;
            font-weight: 800;
            color: #212529;
        }

        .current-price span {
            font-size: 16px;
        }

        /* ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ì¹´ìš´í„° */
        .flash-sale-section {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            margin: 0;
            display: none;
        }

        .flash-sale-section.active {
            display: block;
        }

        .flash-sale-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .flash-sale-title {
            font-size: 16px;
            font-weight: 700;
        }

        .flash-sale-countdown {
            font-size: 14px;
            font-weight: 600;
            background: rgba(0,0,0,0.2);
            padding: 4px 10px;
            border-radius: 4px;
        }

        .flash-sale-progress {
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .flash-sale-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .flash-sale-btn {
            width: 100%;
            padding: 14px;
            background: white;
            color: #ef4444;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
        }

        .flash-sale-btn:disabled {
            background: rgba(255,255,255,0.5);
            color: rgba(0,0,0,0.3);
            cursor: not-allowed;
        }

        /* ì•Œë¦¼ ì‹ ì²­ ì„¹ì…˜ */
        .notification-section {
            background: white;
            padding: 20px;
            border-bottom: 8px solid #f1f3f5;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .notification-desc {
            font-size: 14px;
            color: #495057;
            margin-bottom: 16px;
            text-align: center;
        }

        .notification-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-row {
            display: flex;
            gap: 8px;
        }

        .form-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            font-size: 15px;
            outline: none;
        }

        .form-input:focus {
            border-color: #fc9600;
        }

        .notification-types {
            display: flex;
            gap: 8px;
        }

        .notification-type-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .notification-type-btn.active {
            border-color: #fc9600;
            background: #fff8f0;
            color: #fc9600;
        }

        .btn-submit-notification {
            width: 100%;
            padding: 16px;
            background: #fc9600;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-submit-notification:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        .notification-success {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .notification-success.active {
            display: block;
        }

        .notification-success-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .notification-success-text {
            font-size: 16px;
            font-weight: 600;
            color: #10b981;
        }

        /* ì¹œêµ¬ ê³µìœ  ì„¹ì…˜ */
        .share-section {
            background: white;
            padding: 20px;
            border-bottom: 8px solid #f1f3f5;
        }

        .share-reward-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .share-reward-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #fff5f0 100%);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .share-reward-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .share-reward-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .share-reward-amount {
            font-size: 20px;
            font-weight: 800;
            color: #667eea;
        }

        .share-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .share-btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .share-btn-kakao {
            background: #fee500;
            color: #3c1e1e;
        }

        .share-btn-sms {
            background: #10b981;
            color: white;
        }

        .share-btn-link {
            background: #495057;
            color: white;
            grid-column: 1 / -1;
        }

        /* ìƒí’ˆ ì„¤ëª… */
        .description-section {
            background: white;
            padding: 20px;
        }

        .description-content {
            font-size: 14px;
            color: #495057;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 20px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .bottom-bar-content {
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
        }

        .btn-buy {
            flex: 1;
            padding: 16px;
            background: #fc9600;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-buy:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        .btn-share-bottom {
            padding: 16px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-desc {
            font-size: 14px;
            color: #6c757d;
            margin-top: 8px;
        }

        .referral-link-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .referral-link-text {
            flex: 1;
            font-size: 12px;
            color: #495057;
            word-break: break-all;
            font-family: monospace;
        }

        .btn-copy {
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .modal-share-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .btn-close-modal {
            width: 100%;
            padding: 14px;
            background: #e9ecef;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            color: #495057;
        }

        /* ë¡œë”© */
        .loading {
            text-align: center;
            padding: 100px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #fc9600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #212529;
            color: white;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <div class="header-content">
            <a href="/" class="logo">ëª¨ì—¬ë¼ë”œ</a>
            <div class="header-actions">
                <a href="/consumer/events/" class="header-btn">ì´ë²¤íŠ¸</a>
                <a href="/consumer/my-cashback/" class="header-btn">ë‚´ ìºì‹œë°±</a>
            </div>
        </div>
    </div>

    <!-- ë ˆí¼ëŸ´ ë°°ë„ˆ -->
    <div class="referral-banner" id="referralBanner">
        <div class="referral-banner-icon">ğŸ</div>
        <div class="referral-banner-text">
            <div class="referral-banner-title">ì¹œêµ¬ ì´ˆëŒ€ í˜œíƒì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
            <div class="referral-banner-desc">êµ¬ë§¤ ì‹œ <strong id="bannerCashback">3,000</strong>ì› ìºì‹œë°±</div>
        </div>
    </div>

    <!-- ë¡œë”© -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="container" id="mainContent" style="display: none;">
        <!-- ìƒí’ˆ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
        <div class="product-gallery">
            <div class="swiper" id="productSwiper">
                <div class="swiper-wrapper" id="productImages">
                    <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
                </div>
                <div class="swiper-pagination"></div>
            </div>
        </div>

        <!-- ìƒí’ˆ ì •ë³´ -->
        <div class="product-info">
            <div class="product-badges" id="productBadges">
                <span class="badge badge-status" id="statusBadge">ì§„í–‰ì¤‘</span>
            </div>
            <h1 class="product-title" id="productTitle">ìƒí’ˆëª…</h1>
            <p class="product-subtitle" id="productSubtitle"></p>

            <div class="price-section">
                <div class="original-price" id="originalPrice"></div>
                <div class="sale-price">
                    <span class="discount-rate" id="discountRate"></span>
                    <span class="current-price" id="currentPrice">0<span>ì›</span></span>
                </div>
            </div>
        </div>

        <!-- ì„ ì°©ìˆœ ì´ë²¤íŠ¸ -->
        <div class="flash-sale-section" id="flashSaleSection">
            <div class="flash-sale-header">
                <span class="flash-sale-title">ì„ ì°©ìˆœ ì´ë²¤íŠ¸</span>
                <span class="flash-sale-countdown" id="flashCountdown">00:00:00</span>
            </div>
            <div class="flash-sale-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="flashProgress" style="width: 0%"></div>
                </div>
            </div>
            <div class="flash-sale-stats">
                <span><span id="flashCurrent">0</span>ëª… ì°¸ì—¬</span>
                <span>ì„ ì°©ìˆœ <span id="flashTotal">100</span>ëª…</span>
            </div>
            <button class="flash-sale-btn" id="flashSaleBtn" onclick="joinFlashSale()">
                ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ì°¸ì—¬í•˜ê¸°
            </button>
        </div>

        <!-- ì•Œë¦¼ ì‹ ì²­ (ì˜¤í”ˆ ì˜ˆì • ìƒí’ˆ) -->
        <div class="notification-section" id="notificationSection" style="display: none;">
            <div class="section-title">
                <span>ğŸ””</span> ì˜¤í”ˆ ì•Œë¦¼ ì‹ ì²­
            </div>
            <div class="notification-box">
                <div class="notification-form" id="notificationForm">
                    <p class="notification-desc">ìƒí’ˆ íŒë§¤ ì˜¤í”ˆ ì‹œ ì•Œë¦¼ì„ ë°›ìœ¼ì„¸ìš”!</p>
                    <div class="notification-types">
                        <button class="notification-type-btn active" data-type="kakao" onclick="selectNotificationType('kakao')">
                            ğŸ’¬ ì¹´ì¹´ì˜¤í†¡
                        </button>
                        <button class="notification-type-btn" data-type="sms" onclick="selectNotificationType('sms')">
                            ğŸ“± ë¬¸ì
                        </button>
                    </div>
                    <input type="tel" class="form-input" id="phoneInput" placeholder="ì—°ë½ì²˜ (010-0000-0000)">
                    <button class="btn-submit-notification" onclick="submitNotification()">
                        ì•Œë¦¼ ì‹ ì²­í•˜ê¸°
                    </button>
                </div>
                <div class="notification-success" id="notificationSuccess">
                    <div class="notification-success-icon">âœ…</div>
                    <div class="notification-success-text">ì•Œë¦¼ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                </div>
            </div>
        </div>

        <!-- ì¹œêµ¬ ê³µìœ  -->
        <div class="share-section">
            <div class="section-title">
                <span>ğŸ</span> ì¹œêµ¬ ì´ˆëŒ€í•˜ê³  í•¨ê»˜ í˜œíƒ ë°›ê¸°
            </div>
            <div class="share-reward-cards">
                <div class="share-reward-card">
                    <div class="share-reward-icon">ğŸ˜Š</div>
                    <div class="share-reward-label">ë‚´ê°€ ë°›ëŠ” í˜œíƒ</div>
                    <div class="share-reward-amount" id="referrerReward">5,000ì›</div>
                </div>
                <div class="share-reward-card">
                    <div class="share-reward-icon">ğŸ‰</div>
                    <div class="share-reward-label">ì¹œêµ¬ê°€ ë°›ëŠ” í˜œíƒ</div>
                    <div class="share-reward-amount" id="refereeReward">3,000ì›</div>
                </div>
            </div>
            <div class="share-buttons">
                <button class="share-btn share-btn-kakao" onclick="shareKakao()">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡</button>
                <button class="share-btn share-btn-sms" onclick="shareSMS()">ğŸ“± ë¬¸ì</button>
                <button class="share-btn share-btn-link" onclick="openShareModal()">ğŸ”— ê³µìœ  ë§í¬ ë³µì‚¬</button>
            </div>
        </div>

        <!-- ìƒí’ˆ ì„¤ëª… -->
        <div class="description-section">
            <div class="section-title">ìƒí’ˆ ì„¤ëª…</div>
            <div class="description-content" id="productDescription">
                ìƒí’ˆ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
    <div class="bottom-bar" id="bottomBar" style="display: none;">
        <div class="bottom-bar-content">
            <button class="btn-share-bottom" onclick="openShareModal()">ğŸ”—</button>
            <button class="btn-buy" id="btnBuy" onclick="goToCafe24()">êµ¬ë§¤í•˜ê¸°</button>
        </div>
    </div>

    <!-- ê³µìœ  ëª¨ë‹¬ -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">ğŸ</div>
                <h3 class="modal-title">ì¹œêµ¬ ì´ˆëŒ€ ë§í¬</h3>
                <p class="modal-desc">ì´ ë§í¬ë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”!</p>
            </div>

            <div class="referral-link-box">
                <div class="referral-link-text" id="referralLinkText">ìƒì„± ì¤‘...</div>
                <button class="btn-copy" onclick="copyReferralLink()">ë³µì‚¬</button>
            </div>

            <div class="modal-share-buttons">
                <button class="share-btn share-btn-kakao" onclick="shareKakao()">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡</button>
                <button class="share-btn share-btn-sms" onclick="shareSMS()">ğŸ“± ë¬¸ì</button>
            </div>

            <button class="btn-close-modal" onclick="closeShareModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ì„ ì°©ìˆœ ì°¸ì—¬ ëª¨ë‹¬ -->
    <div class="modal" id="flashResultModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon" id="flashResultIcon">ğŸ‰</div>
                <h3 class="modal-title" id="flashResultTitle">ì¶•í•˜í•©ë‹ˆë‹¤!</h3>
                <p class="modal-desc" id="flashResultDesc">ì„ ì°©ìˆœ ì´ë²¤íŠ¸ì— ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
            </div>
            <button class="btn-close-modal" onclick="closeFlashResultModal()">í™•ì¸</button>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
            authDomain: "moyeora-deal-manager.firebaseapp.com",
            projectId: "moyeora-deal-manager",
            storageBucket: "moyeora-deal-manager.firebasestorage.app",
            messagingSenderId: "878495183009",
            appId: "1:878495183009:web:7c7f5f3b6c3d5f5f5f5f5f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ì „ì—­ ë³€ìˆ˜
        let currentDeal = null;
        let currentReferralCode = null;
        let cafe24ProductUrl = null;
        let notificationType = 'kakao';
        let flashSaleInterval = null;

        // URL íŒŒë¼ë¯¸í„°
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // ì¿ í‚¤ í•¨ìˆ˜
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + "=" + value + ";expires=" + d.toUTCString() + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
            }
            return null;
        }

        // í† ìŠ¤íŠ¸
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // í˜ì´ì§€ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', async () => {
            const dealId = getUrlParam('id');
            const referralCode = getUrlParam('ref');

            if (!dealId) {
                showToast('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                return;
            }

            // ë ˆí¼ëŸ´ ì½”ë“œ ì²˜ë¦¬
            if (referralCode) {
                setCookie('moyeora_ref', referralCode, 7);
                document.getElementById('referralBanner').classList.add('active');

                try {
                    await db.collection('referrals').doc(referralCode).update({
                        clicks: firebase.firestore.FieldValue.increment(1),
                        lastClickAt: new Date()
                    });
                } catch (e) {
                    console.log('ë ˆí¼ëŸ´ ì¶”ì :', e.message);
                }
            } else {
                const existingRef = getCookie('moyeora_ref');
                if (existingRef) {
                    document.getElementById('referralBanner').classList.add('active');
                }
            }

            await loadDealInfo(dealId);
        });

        // ê³µêµ¬ ì •ë³´ ë¡œë“œ
        async function loadDealInfo(dealId) {
            try {
                const dealDoc = await db.collection('deals').doc(dealId).get();

                if (!dealDoc.exists) {
                    showToast('í•´ë‹¹ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                currentDeal = { id: dealDoc.id, ...dealDoc.data() };

                // ì œëª©
                document.getElementById('productTitle').textContent = currentDeal.title || 'ê³µêµ¬ ìƒí’ˆ';
                document.getElementById('productSubtitle').textContent = currentDeal.subtitle || '';

                // ìƒíƒœ ë°°ì§€
                const statusBadge = document.getElementById('statusBadge');
                const status = currentDeal.status || 'ongoing';

                if (status === 'ongoing' || status === 'active') {
                    statusBadge.textContent = 'ì§„í–‰ì¤‘';
                    statusBadge.classList.remove('upcoming', 'ended');
                } else if (status === 'confirmed' || status === 'upcoming') {
                    statusBadge.textContent = 'ì˜¤í”ˆ ì˜ˆì •';
                    statusBadge.classList.add('upcoming');
                    // ì˜¤í”ˆ ì˜ˆì •ì´ë©´ ì•Œë¦¼ ì‹ ì²­ ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('notificationSection').style.display = 'block';
                } else if (status === 'completed' || status === 'ended') {
                    statusBadge.textContent = 'ì¢…ë£Œ';
                    statusBadge.classList.add('ended');
                    document.getElementById('btnBuy').disabled = true;
                    document.getElementById('btnBuy').textContent = 'íŒë§¤ ì¢…ë£Œ';
                }

                // ë±ƒì§€ ì¶”ê°€
                const badgesContainer = document.getElementById('productBadges');
                if (currentDeal.isLimited) {
                    const limitBadge = document.createElement('span');
                    limitBadge.className = 'badge badge-limited';
                    limitBadge.textContent = 'í•œì •ìˆ˜ëŸ‰';
                    badgesContainer.appendChild(limitBadge);
                }
                if (currentDeal.isHot) {
                    const hotBadge = document.createElement('span');
                    hotBadge.className = 'badge badge-hot';
                    hotBadge.textContent = 'HOT';
                    badgesContainer.appendChild(hotBadge);
                }

                // ê°€ê²©
                if (currentDeal.selectedProducts && currentDeal.selectedProducts.length > 0) {
                    const product = currentDeal.selectedProducts[0];
                    const salePrice = product.supplyPrice || 0;
                    const originalPrice = product.originalPrice || product.retailPrice || salePrice;

                    if (originalPrice > salePrice) {
                        document.getElementById('originalPrice').textContent = originalPrice.toLocaleString() + 'ì›';
                        const discountRate = Math.round((1 - salePrice / originalPrice) * 100);
                        document.getElementById('discountRate').textContent = discountRate + '%';
                    }
                    document.getElementById('currentPrice').innerHTML = salePrice.toLocaleString() + '<span>ì›</span>';
                }

                // ìºì‹œë°± ê¸ˆì•¡
                const referrerCashback = currentDeal.referrerCashback || 5000;
                const refereeCashback = currentDeal.refereeCashback || 3000;
                document.getElementById('referrerReward').textContent = referrerCashback.toLocaleString() + 'ì›';
                document.getElementById('refereeReward').textContent = refereeCashback.toLocaleString() + 'ì›';
                document.getElementById('bannerCashback').textContent = refereeCashback.toLocaleString();

                // ìƒí’ˆ ì„¤ëª…
                document.getElementById('productDescription').textContent =
                    currentDeal.description || currentDeal.notes || 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';

                // ì´ë¯¸ì§€
                const imagesContainer = document.getElementById('productImages');
                const images = currentDeal.images || [];
                if (images.length > 0) {
                    imagesContainer.innerHTML = images.map(img =>
                        `<div class="swiper-slide"><img src="${img}" alt="ìƒí’ˆ ì´ë¯¸ì§€"></div>`
                    ).join('');
                } else {
                    imagesContainer.innerHTML = `<div class="swiper-slide"><img src="https://via.placeholder.com/480x480?text=ìƒí’ˆ+ì´ë¯¸ì§€" alt="ìƒí’ˆ ì´ë¯¸ì§€"></div>`;
                }

                // ì„ ì°©ìˆœ ì´ë²¤íŠ¸
                if (currentDeal.flashSale && currentDeal.flashSale.enabled) {
                    initFlashSale(currentDeal.flashSale);
                }

                // ì¹´í˜24 URL
                if (currentDeal.cafe24ProductUrl) {
                    cafe24ProductUrl = currentDeal.cafe24ProductUrl;
                } else if (currentDeal.cafe24ProductNo) {
                    cafe24ProductUrl = `https://moyeora02.cafe24.com/product/detail.html?product_no=${currentDeal.cafe24ProductNo}`;
                }

                // Swiper ì´ˆê¸°í™”
                new Swiper('#productSwiper', {
                    pagination: {
                        el: '.swiper-pagination',
                        clickable: true
                    }
                });

                // UI í‘œì‹œ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('bottomBar').style.display = 'block';

            } catch (error) {
                console.error('ìƒí’ˆ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
        function initFlashSale(flashSale) {
            const section = document.getElementById('flashSaleSection');
            section.classList.add('active');

            const total = flashSale.totalSlots || 100;
            const current = flashSale.currentCount || 0;
            const endTime = flashSale.endTime?.toDate ? flashSale.endTime.toDate() : new Date(flashSale.endTime);

            document.getElementById('flashTotal').textContent = total;
            document.getElementById('flashCurrent').textContent = current;
            document.getElementById('flashProgress').style.width = (current / total * 100) + '%';

            // ë§ˆê° ì—¬ë¶€ ì²´í¬
            if (current >= total) {
                document.getElementById('flashSaleBtn').disabled = true;
                document.getElementById('flashSaleBtn').textContent = 'ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤';
                return;
            }

            // ì¹´ìš´íŠ¸ë‹¤ìš´
            flashSaleInterval = setInterval(() => {
                const now = new Date();
                const diff = endTime - now;

                if (diff <= 0) {
                    clearInterval(flashSaleInterval);
                    document.getElementById('flashCountdown').textContent = 'ì¢…ë£Œ';
                    document.getElementById('flashSaleBtn').disabled = true;
                    document.getElementById('flashSaleBtn').textContent = 'ì´ë²¤íŠ¸ ì¢…ë£Œ';
                    return;
                }

                const hours = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                document.getElementById('flashCountdown').textContent =
                    `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
        }

        // ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ì°¸ì—¬
        async function joinFlashSale() {
            if (!currentDeal || !currentDeal.flashSale) return;

            const btn = document.getElementById('flashSaleBtn');
            btn.disabled = true;
            btn.textContent = 'ì°¸ì—¬ ì¤‘...';

            try {
                // ì°¸ì—¬ì ì •ë³´ ì €ì¥
                const phoneInput = document.getElementById('phoneInput');
                let phone = phoneInput?.value?.trim() || getCookie('moyeora_phone') || '';

                if (!phone) {
                    // ì „í™”ë²ˆí˜¸ ì…ë ¥ ìš”ì²­
                    phone = prompt('ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ì°¸ì—¬ë¥¼ ìœ„í•´ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì˜ˆ: 010-1234-5678)');
                    if (!phone) {
                        btn.disabled = false;
                        btn.textContent = 'ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ì°¸ì—¬í•˜ê¸°';
                        return;
                    }
                    setCookie('moyeora_phone', phone, 30);
                }

                // Firestore íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì°¸ì—¬
                const dealRef = db.collection('deals').doc(currentDeal.id);
                const result = await db.runTransaction(async (transaction) => {
                    const dealDoc = await transaction.get(dealRef);
                    const flashSale = dealDoc.data().flashSale;

                    const current = flashSale.currentCount || 0;
                    const total = flashSale.totalSlots || 100;

                    if (current >= total) {
                        throw new Error('ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤');
                    }

                    // ì°¸ì—¬ ê¸°ë¡
                    const participantRef = db.collection('flashSaleParticipants').doc();
                    transaction.set(participantRef, {
                        dealId: currentDeal.id,
                        phone: phone,
                        participatedAt: new Date(),
                        position: current + 1
                    });

                    // ì¹´ìš´íŠ¸ ì¦ê°€
                    transaction.update(dealRef, {
                        'flashSale.currentCount': current + 1
                    });

                    return { position: current + 1, total };
                });

                // ì„±ê³µ ëª¨ë‹¬
                document.getElementById('flashResultIcon').textContent = 'ğŸ‰';
                document.getElementById('flashResultTitle').textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤!';
                document.getElementById('flashResultDesc').textContent =
                    `${result.position}/${result.total}ë²ˆì§¸ë¡œ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤!`;
                document.getElementById('flashResultModal').classList.add('active');

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('flashCurrent').textContent = result.position;
                document.getElementById('flashProgress').style.width = (result.position / result.total * 100) + '%';
                btn.textContent = 'ì°¸ì—¬ ì™„ë£Œ!';

            } catch (error) {
                console.error('ì„ ì°©ìˆœ ì°¸ì—¬ ì˜¤ë¥˜:', error);

                if (error.message === 'ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤') {
                    document.getElementById('flashResultIcon').textContent = 'ğŸ˜¢';
                    document.getElementById('flashResultTitle').textContent = 'ì•„ì‰½ê²Œë„...';
                    document.getElementById('flashResultDesc').textContent = 'ì„ ì°©ìˆœì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.';
                } else {
                    document.getElementById('flashResultIcon').textContent = 'âš ï¸';
                    document.getElementById('flashResultTitle').textContent = 'ì˜¤ë¥˜ ë°œìƒ';
                    document.getElementById('flashResultDesc').textContent = 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    btn.disabled = false;
                    btn.textContent = 'ì„ ì°©ìˆœ ì´ë²¤íŠ¸ ì°¸ì—¬í•˜ê¸°';
                }
                document.getElementById('flashResultModal').classList.add('active');
            }
        }

        function closeFlashResultModal() {
            document.getElementById('flashResultModal').classList.remove('active');
        }

        // ì•Œë¦¼ ì‹ ì²­
        function selectNotificationType(type) {
            notificationType = type;
            document.querySelectorAll('.notification-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
        }

        async function submitNotification() {
            const phone = document.getElementById('phoneInput').value.trim();

            if (!phone) {
                showToast('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦
            const phoneRegex = /^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$/;
            if (!phoneRegex.test(phone.replace(/-/g, ''))) {
                showToast('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                return;
            }

            try {
                await db.collection('notifications').add({
                    dealId: currentDeal.id,
                    dealTitle: currentDeal.title,
                    phone: phone,
                    type: notificationType,
                    createdAt: new Date(),
                    status: 'pending'
                });

                // ì¿ í‚¤ì— ì €ì¥
                setCookie('moyeora_phone', phone, 30);

                // ì„±ê³µ UI
                document.getElementById('notificationForm').style.display = 'none';
                document.getElementById('notificationSuccess').classList.add('active');
                showToast('ì•Œë¦¼ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                console.error('ì•Œë¦¼ ì‹ ì²­ ì˜¤ë¥˜:', error);
                showToast('ì•Œë¦¼ ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì¹´í˜24ë¡œ ì´ë™
        function goToCafe24() {
            if (!cafe24ProductUrl) {
                showToast('êµ¬ë§¤ í˜ì´ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const referralCode = getCookie('moyeora_ref');
            let url = cafe24ProductUrl;

            if (referralCode) {
                const separator = url.includes('?') ? '&' : '?';
                url = `${url}${separator}ref=${referralCode}`;
            }

            window.location.href = url;
        }

        // ê³µìœ  ê¸°ëŠ¥
        async function generateReferralCode() {
            if (currentReferralCode) return currentReferralCode;

            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6);

            let code;
            let attempts = 0;
            while (attempts < 5) {
                code = Math.random().toString(36).substring(2, 10).toUpperCase();
                const existing = await db.collection('referrals').doc(code).get();
                if (!existing.exists) break;
                attempts++;
            }

            const referralData = {
                referralCode: code,
                referrerId: userId,
                dealId: currentDeal.id,
                dealTitle: currentDeal.title || '',
                createdAt: new Date(),
                expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                clicks: 0,
                conversions: 0,
                totalSales: 0,
                referrerCashback: 0,
                refereeCashback: 0,
                status: 'active',
                purchases: []
            };

            await db.collection('referrals').doc(code).set(referralData);
            currentReferralCode = code;
            return code;
        }

        function getReferralLink() {
            return `${window.location.origin}/consumer/product/?id=${currentDeal.id}&ref=${currentReferralCode}`;
        }

        async function openShareModal() {
            if (!currentDeal) {
                showToast('ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                await generateReferralCode();
                document.getElementById('referralLinkText').textContent = getReferralLink();
                document.getElementById('shareModal').classList.add('active');
            } catch (error) {
                console.error('ê³µìœ  ë§í¬ ìƒì„± ì˜¤ë¥˜:', error);
                showToast('ê³µìœ  ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        async function copyReferralLink() {
            if (!currentReferralCode) await generateReferralCode();

            try {
                await navigator.clipboard.writeText(getReferralLink());
                showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                showToast('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function shareKakao() {
            if (!currentReferralCode) await generateReferralCode();

            if (typeof Kakao === 'undefined' || !Kakao.isInitialized()) {
                // Kakao SDK ì´ˆê¸°í™” (ì‹¤ì œ í‚¤ë¡œ êµì²´ í•„ìš”)
                try {
                    Kakao.init('2e874ef8e5b6a792564592d49632a83e');
                } catch (e) {
                    showToast('ì¹´ì¹´ì˜¤í†¡ ê³µìœ ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            const referralLink = getReferralLink();
            const refereeCashback = currentDeal.refereeCashback || 3000;

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: `ğŸ ${currentDeal.title}`,
                    description: `ì¹œêµ¬ ì´ˆëŒ€ í˜œíƒ! ì§€ê¸ˆ êµ¬ë§¤í•˜ë©´ ${refereeCashback.toLocaleString()}ì› ìºì‹œë°±`,
                    imageUrl: currentDeal.images?.[0] || 'https://moyeoradeal.shop/images/share-thumbnail.jpg',
                    link: {
                        mobileWebUrl: referralLink,
                        webUrl: referralLink
                    }
                },
                buttons: [{
                    title: 'ìƒí’ˆ ë³´ê¸°',
                    link: {
                        mobileWebUrl: referralLink,
                        webUrl: referralLink
                    }
                }]
            });
        }

        async function shareSMS() {
            if (!currentReferralCode) await generateReferralCode();

            const referralLink = getReferralLink();
            const refereeCashback = currentDeal.refereeCashback || 3000;
            const message = `ğŸ ${currentDeal.title}\n\nì¹œêµ¬ ì´ˆëŒ€ í˜œíƒìœ¼ë¡œ ${refereeCashback.toLocaleString()}ì› ìºì‹œë°± ë°›ìœ¼ì„¸ìš”!\n\n${referralLink}`;

            window.location.href = `sms:?body=${encodeURIComponent(message)}`;
        }
    </script>
</body>
</html>

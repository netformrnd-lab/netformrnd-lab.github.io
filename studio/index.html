<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>ëª¨ì—¬ë¼ë”œ ì½˜í…ì¸  ìŠ¤íŠœë””ì˜¤</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0f;
            min-height: 100vh;
            color: white;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #0a0a0f;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }

        .login-box {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            width: 360px;
            text-align: center;
        }
        .login-logo {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .login-subtitle { font-size: 13px; color: #666; margin-bottom: 30px; }
        .login-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(255,71,87,0.2);
            color: #ff6b81;
            margin-bottom: 24px;
        }
        .password-input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
        }
        .password-input:focus { outline: none; border-color: #00d9ff; }
        .password-input.error { border-color: #ff4757; animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        .login-error { margin-top: 16px; font-size: 12px; color: #ff6b81; min-height: 18px; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-box {
            background: #1a1a22;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px;
            width: 360px;
        }
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .modal-input-group { margin-bottom: 16px; }
        .modal-label { font-size: 12px; color: #888; margin-bottom: 6px; display: block; }
        .modal-input {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            text-align: center;
            letter-spacing: 6px;
        }
        .modal-input:focus { outline: none; border-color: #00d9ff; }
        .modal-btns { display: flex; gap: 10px; margin-top: 24px; }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-btn.cancel { background: rgba(255,255,255,0.1); color: #888; }
        .modal-btn.confirm { background: linear-gradient(135deg, #00d9ff, #00ff88); color: #000; }
        .modal-error { font-size: 11px; color: #ff6b81; text-align: center; margin-top: 12px; }

        /* Main App */
        .main-app { display: none; }
        .main-app.visible { display: block; }

        .app-header {
            background: linear-gradient(135deg, rgba(0,217,255,0.1), rgba(0,255,136,0.1));
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .badges { display: flex; gap: 6px; }
        .badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        .badge.meta { background: #ff4757; }
        .badge.blog { background: #1e90ff; }
        .badge.proposal { background: #a55eea; }
        .header-btn {
            padding: 5px 10px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            color: #aaa;
            font-size: 11px;
            cursor: pointer;
        }
        .header-btn:hover { background: rgba(255,255,255,0.12); color: white; }
        .header-btn.danger:hover { background: rgba(255,71,87,0.2); color: #ff6b81; }

        .app-container {
            display: flex;
            height: calc(100vh - 48px);
        }

        /* Left Sidebar */
        .sidebar-left {
            width: 280px;
            background: rgba(255,255,255,0.02);
            border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }
        .category-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .category-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .category-tab:hover { color: #aaa; }
        .category-tab.active { color: #00d9ff; border-color: #00d9ff; }
        .category-tab.active.meta { color: #ff6b81; border-color: #ff6b81; }
        .category-tab.active.blog { color: #1e90ff; border-color: #1e90ff; }
        .category-tab.active.proposal { color: #a55eea; border-color: #a55eea; }

        .template-section { padding: 12px; }
        .template-section.hidden { display: none; }
        .section-title {
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .template-grid { display: flex; flex-direction: column; gap: 8px; }
        .template-card {
            background: rgba(255,255,255,0.04);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .template-card:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); }
        .template-card.active { border-color: #00d9ff; background: rgba(0,217,255,0.1); }
        .template-card.active.meta { border-color: #ff6b81; background: rgba(255,107,129,0.1); }
        .template-card.active.blog { border-color: #1e90ff; background: rgba(30,144,255,0.1); }
        .template-card.active.proposal { border-color: #a55eea; background: rgba(165,94,234,0.1); }
        .template-icon {
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .template-info { flex: 1; }
        .template-name { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
        .template-desc { font-size: 10px; color: #666; }
        .template-badge {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .template-badge.new { background: #00ff88; color: #000; }

        /* Center Preview */
        .preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: #0d0d12;
        }
        .canvas-container {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        #canvas { display: block; background: #000; }
        .canvas-9-16 { width: 240px; height: 426px; }
        .canvas-1-1 { width: 340px; height: 340px; }
        .canvas-16-9 { width: 480px; height: 270px; }
        .canvas-4-3 { width: 400px; height: 300px; }
        .spec-badge {
            position: absolute;
            top: 6px; right: 6px;
            background: rgba(0,0,0,0.7);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 9px;
            color: #00ff88;
        }
        .controls { display: flex; gap: 8px; margin-top: 16px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-play { background: linear-gradient(135deg, #00ff88, #00d9ff); color: #000; }
        .btn-record { background: linear-gradient(135deg, #ff4757, #ff6b81); color: white; }
        .btn-record.recording { animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,71,87,0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255,71,87,0); }
        }
        .btn-download { background: linear-gradient(135deg, #5f27cd, #a55eea); color: white; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .status-bar {
            margin-top: 10px;
            padding: 6px 14px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            font-size: 11px;
            color: #888;
        }
        .status-bar.recording { background: rgba(255,71,87,0.2); color: #ff6b81; }

        /* Right Sidebar */
        .sidebar-right {
            width: 300px;
            background: rgba(255,255,255,0.02);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 12px;
            overflow-y: auto;
        }
        .panel {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .panel-title { font-size: 12px; font-weight: 600; }
        .panel-actions { display: flex; gap: 6px; }
        .panel-action {
            background: rgba(0,217,255,0.15);
            border: none;
            color: #00d9ff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
        .panel-action:hover { background: rgba(0,217,255,0.25); }
        .panel-action.danger { background: rgba(255,71,87,0.15); color: #ff6b81; }

        .media-count-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
        }
        .media-count-label { font-size: 11px; color: #888; }
        .media-count-btns { display: flex; gap: 4px; margin-left: auto; }
        .count-btn {
            width: 28px; height: 28px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .count-btn:hover { background: rgba(255,255,255,0.2); }
        .count-display {
            width: 36px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #00d9ff;
        }

        .media-slots { display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto; }
        .media-slot {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.03);
            padding: 6px;
            border-radius: 6px;
            border: 1px dashed rgba(255,255,255,0.15);
        }
        .media-slot.filled { border-color: #00ff88; border-style: solid; }
        .media-slot.video-filled { border-color: #a55eea; border-style: solid; }
        .slot-preview {
            width: 40px; height: 40px;
            border-radius: 4px;
            background: rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-size: 11px;
            color: #555;
            position: relative;
        }
        .slot-preview img, .slot-preview video { width: 100%; height: 100%; object-fit: cover; }
        .slot-info { flex: 1; min-width: 0; }
        .slot-label { font-size: 9px; color: #555; }
        .slot-name { font-size: 10px; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .slot-btn {
            background: rgba(0,217,255,0.15);
            border: none;
            color: #00d9ff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 9px;
        }
        .slot-btn.remove { background: rgba(255,71,87,0.15); color: #ff6b81; }

        .input-group { margin-bottom: 8px; }
        .input-label { font-size: 10px; color: #666; margin-bottom: 4px; display: block; }
        .text-input {
            width: 100%;
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            color: white;
            font-size: 11px;
        }
        .text-input:focus { outline: none; border-color: #00d9ff; }

        .color-options { display: flex; gap: 5px; flex-wrap: wrap; }
        .color-btn {
            width: 26px; height: 26px;
            border-radius: 5px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .color-btn.active { border-color: white; transform: scale(1.1); }

        .range-group { display: flex; align-items: center; gap: 10px; }
        .range-group input[type="range"] { flex: 1; }
        .range-value { font-size: 12px; color: #00d9ff; min-width: 40px; text-align: right; }

        .tip-box {
            background: rgba(0,217,255,0.1);
            border: 1px solid rgba(0,217,255,0.2);
            border-radius: 6px;
            padding: 8px;
            font-size: 10px;
            color: #888;
            line-height: 1.5;
        }
        .tip-box strong { color: #00d9ff; }

        /* AI Panel */
        .ai-panel {
            background: linear-gradient(135deg, rgba(138,43,226,0.15), rgba(0,217,255,0.1));
            border: 1px solid rgba(138,43,226,0.3);
        }
        .ai-panel .panel-title { color: #a55eea; }
        .ai-prompt-input {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(138,43,226,0.3);
            border-radius: 6px;
            color: white;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            margin-bottom: 8px;
        }
        .ai-prompt-input:focus { outline: none; border-color: #a55eea; }
        .ai-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #a55eea, #5f27cd);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .ai-btn:hover { opacity: 0.9; }
        .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .ai-btn.loading { animation: pulse 1s infinite; }
        .ai-result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            font-size: 11px;
            line-height: 1.6;
            color: #ddd;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        .ai-result.visible { display: block; }
        .ai-result-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        .ai-result-btn {
            flex: 1;
            padding: 6px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: #aaa;
            font-size: 10px;
            cursor: pointer;
        }
        .ai-result-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .ai-result-btn.apply { background: rgba(0,255,136,0.2); color: #00ff88; }
        .api-key-section {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        .api-key-input {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: white;
            font-size: 10px;
            margin-top: 4px;
        }
        .api-key-input:focus { outline: none; border-color: #a55eea; }
        .api-key-status {
            font-size: 9px;
            margin-top: 4px;
        }
        .api-key-status.connected { color: #00ff88; }
        .api-key-status.disconnected { color: #ff6b81; }

        .hidden-input { display: none; }
        .hidden-videos { position: absolute; left: -9999px; top: -9999px; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        @media (max-width: 1200px) {
            .sidebar-left { width: 240px; }
            .sidebar-right { width: 260px; }
        }
        @media (max-width: 900px) {
            .app-container { flex-direction: column; height: auto; }
            .sidebar-left, .sidebar-right { width: 100%; border: none; }
            .preview-area { min-height: 450px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">ğŸ¬ ëª¨ì—¬ë¼ë”œ ìŠ¤íŠœë””ì˜¤</div>
            <div class="login-subtitle">ë§ˆì¼€íŒ… & ì½˜í…ì¸  ì œì‘ì†Œ</div>
            <div class="login-badge">INTERNAL ACCESS ONLY</div>
            <input type="password" class="password-input" id="passwordInput" placeholder="****" maxlength="10" autocomplete="off">
            <button class="login-btn" id="loginBtn">ì ‘ì†í•˜ê¸°</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal-overlay" id="pwModal">
        <div class="modal-box">
            <div class="modal-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
            <div class="modal-input-group">
                <label class="modal-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="modal-input" id="currentPw" placeholder="****" maxlength="10">
            </div>
            <div class="modal-input-group">
                <label class="modal-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="modal-input" id="newPw" placeholder="****" maxlength="10">
            </div>
            <div class="modal-input-group">
                <label class="modal-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" class="modal-input" id="confirmPw" placeholder="****" maxlength="10">
            </div>
            <div class="modal-error" id="pwModalError"></div>
            <div class="modal-btns">
                <button class="modal-btn cancel" id="pwModalCancel">ì·¨ì†Œ</button>
                <button class="modal-btn confirm" id="pwModalConfirm">ë³€ê²½í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <header class="app-header">
            <div class="logo">ğŸ¬ ëª¨ì—¬ë¼ë”œ ì½˜í…ì¸  ìŠ¤íŠœë””ì˜¤</div>
            <div class="header-right">
                <div class="badges">
                    <span class="badge meta">META</span>
                    <span class="badge blog">BLOG</span>
                    <span class="badge proposal">ì œì•ˆì„œ</span>
                </div>
                <button class="header-btn" id="changePwBtn">ë¹„ë°€ë²ˆí˜¸</button>
                <button class="header-btn danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <div class="app-container">
            <!-- Left Sidebar - Templates -->
            <aside class="sidebar-left">
                <div class="category-tabs">
                    <div class="category-tab active meta" data-category="meta">ğŸ“¢ ë©”íƒ€ê´‘ê³ </div>
                    <div class="category-tab blog" data-category="blog">ğŸ“ ë¸”ë¡œê·¸</div>
                    <div class="category-tab proposal" data-category="proposal">ğŸ“Š ì œì•ˆì„œ</div>
                </div>

                <!-- Meta Templates -->
                <div class="template-section" id="meta-templates">
                    <div class="section-title">ë¦´ìŠ¤ / ìŠ¤í† ë¦¬ (9:16)</div>
                    <div class="template-grid">
                        <div class="template-card meta active" data-template="grid-pop" data-ratio="9:16">
                            <div class="template-icon">âŠ</div>
                            <div class="template-info">
                                <div class="template-name">ê·¸ë¦¬ë“œ íŒì—…</div>
                                <div class="template-desc">ì´ë¯¸ì§€ ìˆœì°¨ íŒì—…</div>
                            </div>
                        </div>
                        <div class="template-card meta" data-template="slideshow" data-ratio="9:16">
                            <div class="template-icon">â–¶</div>
                            <div class="template-info">
                                <div class="template-name">ìŠ¬ë¼ì´ë“œì‡¼</div>
                                <div class="template-desc">í’€ìŠ¤í¬ë¦° í˜ì´ë“œ</div>
                            </div>
                        </div>
                        <div class="template-card meta" data-template="stack-cards" data-ratio="9:16">
                            <div class="template-icon">ğŸƒ</div>
                            <div class="template-info">
                                <div class="template-name">ìŠ¤íƒ ì¹´ë“œ</div>
                                <div class="template-desc">ì¹´ë“œ í¼ì¹˜ê¸° íš¨ê³¼</div>
                            </div>
                        </div>
                        <div class="template-card meta" data-template="mosaic" data-ratio="9:16">
                            <div class="template-icon">â–¦</div>
                            <div class="template-info">
                                <div class="template-name">ëª¨ìì´í¬</div>
                                <div class="template-desc">ë‹¤ì–‘í•œ í¬ê¸° ë°°ì¹˜</div>
                            </div>
                        </div>
                        <div class="template-card meta" data-template="zoom-reveal" data-ratio="9:16">
                            <div class="template-icon">â—</div>
                            <div class="template-info">
                                <div class="template-name">ì¤Œ ë¦¬ë¹Œ</div>
                                <div class="template-desc">ì›í˜• í™•ëŒ€ ì „í™˜</div>
                            </div>
                        </div>
                        <div class="template-card meta" data-template="dynamic-grid" data-ratio="9:16">
                            <div class="template-icon">â–£</div>
                            <div class="template-info">
                                <div class="template-name">ë‹¤ì´ë‚˜ë¯¹ ê·¸ë¦¬ë“œ</div>
                                <div class="template-desc">íšŒì „ ë“±ì¥</div>
                            </div>
                        </div>
                        <div class="template-card meta" data-template="bounce-in" data-ratio="9:16">
                            <div class="template-icon">âš¡</div>
                            <div class="template-info">
                                <div class="template-name">ë°”ìš´ìŠ¤ ì¸</div>
                                <div class="template-desc">í†µí†µ íŠ€ëŠ” ë“±ì¥</div>
                            </div>
                            <span class="template-badge new">NEW</span>
                        </div>
                        <div class="template-card meta" data-template="split-reveal" data-ratio="9:16">
                            <div class="template-icon">â—§</div>
                            <div class="template-info">
                                <div class="template-name">ìŠ¤í”Œë¦¿ ë¦¬ë¹Œ</div>
                                <div class="template-desc">ì¢Œìš° ë¶„í•  ê³µê°œ</div>
                            </div>
                            <span class="template-badge new">NEW</span>
                        </div>
                    </div>

                    <div class="section-title" style="margin-top: 16px;">í”¼ë“œ (1:1)</div>
                    <div class="template-grid">
                        <div class="template-card meta" data-template="feed-carousel" data-ratio="1:1">
                            <div class="template-icon">ğŸ </div>
                            <div class="template-info">
                                <div class="template-name">ìºëŸ¬ì…€</div>
                                <div class="template-desc">ì¢Œìš° ìŠ¬ë¼ì´ë“œ</div>
                            </div>
                        </div>
                        <div class="template-card meta" data-template="feed-zoom" data-ratio="1:1">
                            <div class="template-icon">ğŸ”</div>
                            <div class="template-info">
                                <div class="template-name">ì¤Œ í¬ì»¤ìŠ¤</div>
                                <div class="template-desc">í™•ëŒ€ ì „í™˜</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Blog Templates -->
                <div class="template-section hidden" id="blog-templates">
                    <div class="section-title">ë¸”ë¡œê·¸ ì¸ë„¤ì¼ (16:9)</div>
                    <div class="template-grid">
                        <div class="template-card blog" data-template="blog-thumbnail" data-ratio="16:9">
                            <div class="template-icon">ğŸ–¼ï¸</div>
                            <div class="template-info">
                                <div class="template-name">í´ë˜ì‹ ì¸ë„¤ì¼</div>
                                <div class="template-desc">ì œëª© + ì´ë¯¸ì§€</div>
                            </div>
                        </div>
                        <div class="template-card blog" data-template="blog-quote" data-ratio="16:9">
                            <div class="template-icon">ğŸ’¬</div>
                            <div class="template-info">
                                <div class="template-name">ì¸ìš©êµ¬ ì¹´ë“œ</div>
                                <div class="template-desc">í…ìŠ¤íŠ¸ ì¤‘ì‹¬</div>
                            </div>
                        </div>
                        <div class="template-card blog" data-template="blog-collage" data-ratio="16:9">
                            <div class="template-icon">ğŸ“¸</div>
                            <div class="template-info">
                                <div class="template-name">ì½œë¼ì£¼</div>
                                <div class="template-desc">ë‹¤ì¤‘ ì´ë¯¸ì§€ ë°°ì¹˜</div>
                            </div>
                        </div>
                        <div class="template-card blog" data-template="blog-minimal" data-ratio="16:9">
                            <div class="template-icon">â—»ï¸</div>
                            <div class="template-info">
                                <div class="template-name">ë¯¸ë‹ˆë©€</div>
                                <div class="template-desc">ê¹”ë”í•œ ë””ìì¸</div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title" style="margin-top: 16px;">ë¸”ë¡œê·¸ ì¹´ë“œ (4:3)</div>
                    <div class="template-grid">
                        <div class="template-card blog" data-template="blog-feature" data-ratio="4:3">
                            <div class="template-icon">â­</div>
                            <div class="template-info">
                                <div class="template-name">íŠ¹ì§• ì¹´ë“œ</div>
                                <div class="template-desc">í¬ì¸íŠ¸ ê°•ì¡°</div>
                            </div>
                        </div>
                        <div class="template-card blog" data-template="blog-list" data-ratio="4:3">
                            <div class="template-icon">ğŸ“‹</div>
                            <div class="template-info">
                                <div class="template-name">ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ</div>
                                <div class="template-desc">í•­ëª© ë‚˜ì—´</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Proposal Templates -->
                <div class="template-section hidden" id="proposal-templates">
                    <div class="section-title">í”„ë ˆì  í…Œì´ì…˜ (16:9)</div>
                    <div class="template-grid">
                        <div class="template-card proposal" data-template="proposal-cover" data-ratio="16:9">
                            <div class="template-icon">ğŸ“‘</div>
                            <div class="template-info">
                                <div class="template-name">í‘œì§€ ìŠ¬ë¼ì´ë“œ</div>
                                <div class="template-desc">ì œì•ˆì„œ ì»¤ë²„</div>
                            </div>
                        </div>
                        <div class="template-card proposal" data-template="proposal-stats" data-ratio="16:9">
                            <div class="template-icon">ğŸ“Š</div>
                            <div class="template-info">
                                <div class="template-name">í†µê³„ ì°¨íŠ¸</div>
                                <div class="template-desc">ìˆ«ì ê°•ì¡°</div>
                            </div>
                        </div>
                        <div class="template-card proposal" data-template="proposal-compare" data-ratio="16:9">
                            <div class="template-icon">âš–ï¸</div>
                            <div class="template-info">
                                <div class="template-name">ë¹„êµ ë¶„ì„</div>
                                <div class="template-desc">Before/After</div>
                            </div>
                        </div>
                        <div class="template-card proposal" data-template="proposal-timeline" data-ratio="16:9">
                            <div class="template-icon">ğŸ“…</div>
                            <div class="template-info">
                                <div class="template-name">íƒ€ì„ë¼ì¸</div>
                                <div class="template-desc">ì¼ì • í‘œì‹œ</div>
                            </div>
                        </div>
                        <div class="template-card proposal" data-template="proposal-team" data-ratio="16:9">
                            <div class="template-icon">ğŸ‘¥</div>
                            <div class="template-info">
                                <div class="template-name">íŒ€ ì†Œê°œ</div>
                                <div class="template-desc">ë©¤ë²„ í”„ë¡œí•„</div>
                            </div>
                        </div>
                        <div class="template-card proposal" data-template="proposal-cta" data-ratio="16:9">
                            <div class="template-icon">ğŸ¯</div>
                            <div class="template-info">
                                <div class="template-name">CTA ìŠ¬ë¼ì´ë“œ</div>
                                <div class="template-desc">ì•¡ì…˜ ìœ ë„</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Center Preview -->
            <main class="preview-area">
                <div class="canvas-container">
                    <canvas id="canvas" width="1080" height="1920" class="canvas-9-16"></canvas>
                    <div class="spec-badge" id="specBadge">1080Ã—1920</div>
                </div>
                <div class="controls">
                    <button class="btn btn-play" id="playBtn">â–¶ ë¯¸ë¦¬ë³´ê¸°</button>
                    <button class="btn btn-record" id="recordBtn">â— ë…¹í™”</button>
                    <button class="btn btn-download" id="downloadBtn" disabled>â¬‡ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                <div class="status-bar" id="status">ì´ë¯¸ì§€ ë˜ëŠ” ì˜ìƒì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
            </main>

            <!-- Right Sidebar -->
            <aside class="sidebar-right">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">ğŸ“· ë¯¸ë””ì–´</div>
                        <div class="panel-actions">
                            <button class="panel-action" id="addAllMedia">ì „ì²´ ì¶”ê°€</button>
                            <button class="panel-action danger" id="clearAllMedia">ì „ì²´ ì‚­ì œ</button>
                        </div>
                    </div>
                    <div class="media-count-control">
                        <span class="media-count-label">ìŠ¬ë¡¯ ê°œìˆ˜</span>
                        <div class="media-count-btns">
                            <button class="count-btn" id="decreaseSlot">âˆ’</button>
                            <span class="count-display" id="slotCount">5</span>
                            <button class="count-btn" id="increaseSlot">+</button>
                        </div>
                    </div>
                    <div class="media-slots" id="mediaSlots"></div>
                </div>

                <div class="panel">
                    <div class="panel-title" style="margin-bottom: 10px;">âœï¸ í…ìŠ¤íŠ¸</div>
                    <div class="input-group">
                        <label class="input-label">ë©”ì¸ íƒ€ì´í‹€</label>
                        <input type="text" class="text-input" id="mainTitle" value="ì¸í”Œë£¨ì–¸ì„œì™€ í•¨ê»˜í•˜ëŠ”">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ì„œë¸Œ íƒ€ì´í‹€</label>
                        <input type="text" class="text-input" id="subTitle" value="íŠ¹ë³„í•œ ê³µë™êµ¬ë§¤">
                    </div>
                    <div class="input-group">
                        <label class="input-label">CTA ë¬¸êµ¬</label>
                        <input type="text" class="text-input" id="ctaText" value="ì§€ê¸ˆ ë°”ë¡œ ì‹ ì²­ â†’">
                    </div>
                    <div class="input-group">
                        <label class="input-label">í•˜ë‹¨ URL</label>
                        <input type="text" class="text-input" id="urlText" value="moyeoradeal.com">
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title" style="margin-bottom: 10px;">ğŸ¨ ìŠ¤íƒ€ì¼</div>
                    <div class="input-group">
                        <label class="input-label">ì»¬ëŸ¬ í…Œë§ˆ</label>
                        <div class="color-options">
                            <button class="color-btn active" style="background: linear-gradient(135deg, #00ff88, #00d9ff);" data-theme="mint"></button>
                            <button class="color-btn" style="background: linear-gradient(135deg, #ff6b81, #ff4757);" data-theme="coral"></button>
                            <button class="color-btn" style="background: linear-gradient(135deg, #a55eea, #5f27cd);" data-theme="purple"></button>
                            <button class="color-btn" style="background: linear-gradient(135deg, #ffa502, #ff6348);" data-theme="orange"></button>
                            <button class="color-btn" style="background: linear-gradient(135deg, #1e90ff, #00bfff);" data-theme="blue"></button>
                            <button class="color-btn" style="background: linear-gradient(135deg, #2d3436, #636e72);" data-theme="dark"></button>
                            <button class="color-btn" style="background: linear-gradient(135deg, #fff, #ddd);" data-theme="white"></button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ì˜ìƒ ê¸¸ì´</label>
                        <div class="range-group">
                            <input type="range" id="duration" min="5" max="20" value="10">
                            <span class="range-value" id="durationVal">10ì´ˆ</span>
                        </div>
                    </div>
                </div>

                <div class="tip-box">
                    <strong>ğŸ’¡ íŒ:</strong> ì˜ìƒì€ MP4, WebM ì§€ì›. ë¯¸ë””ì–´ ìŠ¬ë¡¯ ê°œìˆ˜ë¥¼ ì¡°ì ˆí•˜ì—¬ ì›í•˜ëŠ” ë§Œí¼ ì´ë¯¸ì§€/ì˜ìƒì„ ì¶”ê°€í•˜ì„¸ìš”.
                </div>

                <!-- AI Content Generator -->
                <div class="panel ai-panel">
                    <div class="panel-title" style="margin-bottom: 10px;">ğŸ¤– AI ë¬¸êµ¬ ìƒì„±</div>
                    <div class="api-key-section">
                        <label class="input-label">API Key</label>
                        <input type="password" class="api-key-input" id="apiKeyInput" placeholder="sk-ant-api03-...">
                        <div class="api-key-status disconnected" id="apiKeyStatus">ì—°ê²° ì•ˆë¨</div>
                    </div>
                    <textarea class="ai-prompt-input" id="aiPrompt" placeholder="ì˜ˆ: ëª¨ì—¬ë¼ë”œ ê³µë™êµ¬ë§¤ ê´‘ê³  ë¬¸êµ¬ ë§Œë“¤ì–´ì¤˜. í• ì¸ìœ¨ 50%, ì¸í”Œë£¨ì–¸ì„œ í˜‘ì°¬ ìƒí’ˆ."></textarea>
                    <button class="ai-btn" id="aiGenerateBtn">
                        <span>âœ¨</span> AI ë¬¸êµ¬ ìƒì„±
                    </button>
                    <div class="ai-result" id="aiResult">
                        <div id="aiResultText"></div>
                        <div class="ai-result-actions">
                            <button class="ai-result-btn" id="aiCopyBtn">ğŸ“‹ ë³µì‚¬</button>
                            <button class="ai-result-btn apply" id="aiApplyBtn">âœ… ì ìš©</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden-input" accept="image/*,video/*" multiple>
    <div class="hidden-videos" id="hiddenVideos"></div>

    <script>
        // ========== PASSWORD ==========
        const DEFAULT_PASSWORD = '0000';
        const STORAGE_KEY = 'moyeoradeal_studio_pw';
        const SESSION_KEY = 'moyeoradeal_studio_session';

        const getPassword = () => localStorage.getItem(STORAGE_KEY) || DEFAULT_PASSWORD;
        const setPassword = (pw) => localStorage.setItem(STORAGE_KEY, pw);
        const isLoggedIn = () => sessionStorage.getItem(SESSION_KEY) === 'true';
        const setLoggedIn = (v) => v ? sessionStorage.setItem(SESSION_KEY, 'true') : sessionStorage.removeItem(SESSION_KEY);

        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');

        if (isLoggedIn()) {
            loginScreen.classList.add('hidden');
            mainApp.classList.add('visible');
            init();
        }

        loginBtn.onclick = () => {
            if (passwordInput.value === getPassword()) {
                setLoggedIn(true);
                loginScreen.classList.add('hidden');
                mainApp.classList.add('visible');
                init();
            } else {
                passwordInput.classList.add('error');
                loginError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤';
                setTimeout(() => passwordInput.classList.remove('error'), 500);
            }
        };
        passwordInput.onkeypress = (e) => e.key === 'Enter' && loginBtn.click();

        document.getElementById('logoutBtn').onclick = () => {
            setLoggedIn(false);
            location.reload();
        };

        // Password modal
        const pwModal = document.getElementById('pwModal');
        document.getElementById('changePwBtn').onclick = () => pwModal.classList.add('visible');
        document.getElementById('pwModalCancel').onclick = () => pwModal.classList.remove('visible');
        pwModal.onclick = (e) => e.target === pwModal && pwModal.classList.remove('visible');
        document.getElementById('pwModalConfirm').onclick = () => {
            const cur = document.getElementById('currentPw').value;
            const newPw = document.getElementById('newPw').value;
            const conf = document.getElementById('confirmPw').value;
            const err = document.getElementById('pwModalError');

            if (cur !== getPassword()) { err.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤'; return; }
            if (newPw.length < 4) { err.textContent = '4ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”'; return; }
            if (newPw !== conf) { err.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'; return; }

            setPassword(newPw);
            pwModal.classList.remove('visible');
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
        };

        // ========== MAIN APP ==========
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const state = {
            category: 'meta',
            template: 'grid-pop',
            ratio: '9:16',
            media: [],
            maxMedia: 5,
            colorTheme: 'mint',
            isPlaying: false,
            isRecording: false,
            videoBlob: null,
            currentSlot: 0,
            animationId: null,
            lastFrameTime: 0
        };

        const colorThemes = {
            mint: { primary: '#00ff88', secondary: '#00d9ff', bg: '#0a0a0f', text: '#ffffff' },
            coral: { primary: '#ff6b81', secondary: '#ff4757', bg: '#0f0a0a', text: '#ffffff' },
            purple: { primary: '#a55eea', secondary: '#5f27cd', bg: '#0a0a0f', text: '#ffffff' },
            orange: { primary: '#ffa502', secondary: '#ff6348', bg: '#0f0d0a', text: '#ffffff' },
            blue: { primary: '#1e90ff', secondary: '#00bfff', bg: '#0a0c0f', text: '#ffffff' },
            dark: { primary: '#74b9ff', secondary: '#a29bfe', bg: '#1a1a2e', text: '#ffffff' },
            white: { primary: '#333333', secondary: '#666666', bg: '#ffffff', text: '#000000' }
        };

        const ratioSizes = {
            '9:16': { w: 1080, h: 1920, cls: 'canvas-9-16' },
            '1:1': { w: 1080, h: 1080, cls: 'canvas-1-1' },
            '16:9': { w: 1920, h: 1080, cls: 'canvas-16-9' },
            '4:3': { w: 1200, h: 900, cls: 'canvas-4-3' }
        };

        function init() {
            updateMediaSlots();
            setupEventListeners();
            updatePreview();
            initAI();
        }

        function setupEventListeners() {
            // Category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.category = tab.dataset.category;

                    document.querySelectorAll('.template-section').forEach(s => s.classList.add('hidden'));
                    document.getElementById(`${state.category}-templates`).classList.remove('hidden');

                    // Select first template in category
                    const firstCard = document.querySelector(`#${state.category}-templates .template-card`);
                    if (firstCard) firstCard.click();
                };
            });

            // Template cards
            document.querySelectorAll('.template-card').forEach(card => {
                card.onclick = () => {
                    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    state.template = card.dataset.template;
                    state.ratio = card.dataset.ratio;
                    updateCanvasSize();
                    updatePreview();
                };
            });

            // Media slot controls
            document.getElementById('decreaseSlot').onclick = () => {
                if (state.maxMedia > 1) {
                    state.maxMedia--;
                    document.getElementById('slotCount').textContent = state.maxMedia;
                    updateMediaSlots();
                }
            };
            document.getElementById('increaseSlot').onclick = () => {
                if (state.maxMedia < 12) {
                    state.maxMedia++;
                    document.getElementById('slotCount').textContent = state.maxMedia;
                    updateMediaSlots();
                }
            };

            document.getElementById('addAllMedia').onclick = () => {
                state.currentSlot = -1; // -1 means add to all empty slots
                document.getElementById('fileInput').click();
            };
            document.getElementById('clearAllMedia').onclick = () => {
                state.media.forEach(m => {
                    if (m && m.type === 'video') {
                        m.element.pause();
                        m.element.src = '';
                    }
                });
                state.media = [];
                updateMediaSlots();
            };

            // File input
            document.getElementById('fileInput').onchange = handleFileSelect;

            // Color theme
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.colorTheme = btn.dataset.theme;
                    updatePreview();
                };
            });

            // Duration
            const durationInput = document.getElementById('duration');
            durationInput.oninput = () => {
                document.getElementById('durationVal').textContent = durationInput.value + 'ì´ˆ';
            };

            // Text inputs
            ['mainTitle', 'subTitle', 'ctaText', 'urlText'].forEach(id => {
                document.getElementById(id).oninput = () => updatePreview();
            });

            // Controls
            document.getElementById('playBtn').onclick = playAnimation;
            document.getElementById('recordBtn').onclick = toggleRecording;
            document.getElementById('downloadBtn').onclick = downloadVideo;
        }

        function updateCanvasSize() {
            const size = ratioSizes[state.ratio];
            canvas.width = size.w;
            canvas.height = size.h;
            canvas.className = size.cls;
            document.getElementById('specBadge').textContent = `${size.w}Ã—${size.h}`;
        }

        function updateMediaSlots() {
            const container = document.getElementById('mediaSlots');
            container.innerHTML = '';
            document.getElementById('slotCount').textContent = state.maxMedia;

            for (let i = 0; i < state.maxMedia; i++) {
                const media = state.media[i];
                const hasMedia = media != null;
                const isVideo = hasMedia && media.type === 'video';

                const slot = document.createElement('div');
                slot.className = `media-slot${hasMedia ? (isVideo ? ' video-filled' : ' filled') : ''}`;
                slot.innerHTML = `
                    <div class="slot-preview">${hasMedia ?
                        (isVideo ? `<video src="${media.src}" muted></video>` : `<img src="${media.src}">`) :
                        (i + 1)}</div>
                    <div class="slot-info">
                        <div class="slot-label">ìŠ¬ë¡¯ ${i + 1}</div>
                        <div class="slot-name">${hasMedia ? (isVideo ? 'ì˜ìƒ' : 'ì´ë¯¸ì§€') : 'í´ë¦­í•˜ì—¬ ì„ íƒ'}</div>
                    </div>
                    ${hasMedia ?
                        `<button class="slot-btn remove" data-slot="${i}">âœ•</button>` :
                        `<button class="slot-btn" data-slot="${i}">ì„ íƒ</button>`}
                `;
                container.appendChild(slot);

                const btn = slot.querySelector('.slot-btn');
                if (hasMedia) {
                    btn.onclick = () => removeMedia(i);
                } else {
                    btn.onclick = () => {
                        state.currentSlot = i;
                        document.getElementById('fileInput').click();
                    };
                }
            }
        }

        function removeMedia(slot) {
            if (state.media[slot]?.type === 'video') {
                state.media[slot].element.pause();
                state.media[slot].element.src = '';
            }
            state.media[slot] = null;
            updateMediaSlots();
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (!files.length) return;

            let slotIndex = state.currentSlot === -1 ? 0 : state.currentSlot;

            files.forEach((file, idx) => {
                // Find next empty slot
                if (state.currentSlot === -1) {
                    while (slotIndex < state.maxMedia && state.media[slotIndex]) slotIndex++;
                    if (slotIndex >= state.maxMedia) return;
                }

                const targetSlot = state.currentSlot === -1 ? slotIndex : state.currentSlot;
                if (targetSlot >= state.maxMedia) return;

                const isVideo = file.type.startsWith('video/');
                const reader = new FileReader();

                reader.onload = (ev) => {
                    if (isVideo) {
                        const video = document.createElement('video');
                        video.src = ev.target.result;
                        video.muted = true;
                        video.loop = true;
                        video.playsInline = true;
                        video.preload = 'metadata';
                        document.getElementById('hiddenVideos').appendChild(video);

                        video.onloadedmetadata = () => {
                            state.media[targetSlot] = { type: 'video', element: video, src: ev.target.result };
                            updateMediaSlots();
                            video.play().catch(() => {});
                        };
                    } else {
                        const img = new Image();
                        img.onload = () => {
                            state.media[targetSlot] = { type: 'image', element: img, src: ev.target.result };
                            updateMediaSlots();
                        };
                        img.src = ev.target.result;
                    }
                };
                reader.readAsDataURL(file);

                if (state.currentSlot === -1) slotIndex++;
            });

            e.target.value = '';
        }

        // ========== DRAWING ==========
        function roundRect(x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        function drawMediaCover(mediaObj, x, y, w, h, radius = 0) {
            if (!mediaObj) return;
            const el = mediaObj.element;
            const sw = mediaObj.type === 'video' ? el.videoWidth : el.width;
            const sh = mediaObj.type === 'video' ? el.videoHeight : el.height;
            if (!sw || !sh) return;

            ctx.save();
            if (radius > 0) { roundRect(x, y, w, h, radius); ctx.clip(); }
            const scale = Math.max(w / sw, h / sh);
            ctx.drawImage(el, x - (sw * scale - w) / 2, y - (sh * scale - h) / 2, sw * scale, sh * scale);
            ctx.restore();
        }

        const ease = {
            outBack: t => { const c = 2.70158; return 1 + (c + 1) * Math.pow(t - 1, 3) + c * Math.pow(t - 1, 2); },
            outQuad: t => 1 - (1 - t) * (1 - t),
            outCubic: t => 1 - Math.pow(1 - t, 3),
            outElastic: t => t === 0 ? 0 : t === 1 ? 1 : Math.pow(2, -10 * t) * Math.sin((t * 10 - 0.75) * ((2 * Math.PI) / 3)) + 1
        };

        function drawText(text, x, y, opts = {}) {
            const { size = 60, weight = '700', color = '#fff', align = 'center', shadow = false } = opts;
            ctx.save();
            ctx.font = `${weight} ${size}px 'Noto Sans KR', sans-serif`;
            ctx.fillStyle = color;
            ctx.textAlign = align;
            ctx.textBaseline = 'middle';
            if (shadow) { ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 20; ctx.shadowOffsetY = 4; }
            ctx.fillText(text, x, y);
            ctx.restore();
        }

        function drawCTA(theme, y, alpha = 1) {
            const ctaText = document.getElementById('ctaText').value;
            const urlText = document.getElementById('urlText').value;
            const w = canvas.width, h = canvas.height;
            const btnW = w * 0.75, btnH = h * 0.07, btnX = (w - btnW) / 2;

            ctx.globalAlpha = alpha;
            const grad = ctx.createLinearGradient(btnX, y, btnX + btnW, y);
            grad.addColorStop(0, theme.primary);
            grad.addColorStop(1, theme.secondary);

            ctx.shadowColor = theme.primary;
            ctx.shadowBlur = 30;
            roundRect(btnX, y, btnW, btnH, 20);
            ctx.fillStyle = grad;
            ctx.fill();
            ctx.shadowBlur = 0;

            const btnTextColor = theme.bg === '#ffffff' ? '#fff' : '#000';
            drawText(ctaText, w / 2, y + btnH / 2, { size: h * 0.025, weight: '900', color: btnTextColor });
            drawText(urlText, w / 2, y + btnH + h * 0.04, { size: h * 0.018, weight: '400', color: theme.text });
            ctx.globalAlpha = 1;
        }

        function updatePreview() {
            const theme = colorThemes[state.colorTheme];
            const w = canvas.width, h = canvas.height;

            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, w, h);

            const title1 = document.getElementById('mainTitle').value;
            const title2 = document.getElementById('subTitle').value;

            // Draw based on template category
            if (state.category === 'meta') {
                drawText(title1, w / 2, h * 0.18, { size: h * 0.033, weight: '700', color: theme.text });
                drawText(title2, w / 2, h * 0.23, { size: h * 0.038, weight: '900', color: theme.primary });
                drawMetaTemplateStatic(theme);
                drawCTA(theme, h * 0.76);
            } else if (state.category === 'blog') {
                drawBlogTemplateStatic(theme);
            } else if (state.category === 'proposal') {
                drawProposalTemplateStatic(theme);
            }
        }

        function drawMetaTemplateStatic(theme) {
            const w = canvas.width, h = canvas.height;
            const validMedia = state.media.filter(Boolean);

            switch (state.template) {
                case 'grid-pop':
                case 'bounce-in': {
                    const cols = 2, imgSize = w * 0.3, gap = w * 0.03;
                    const startX = (w - (cols * imgSize + gap)) / 2, startY = h * 0.29;
                    validMedia.slice(0, 5).forEach((m, i) => {
                        const col = i % cols, row = Math.floor(i / cols);
                        let x = startX + col * (imgSize + gap), y = startY + row * (imgSize + gap);
                        if (i === 4) { x = (w - imgSize) / 2; y = startY + 2 * (imgSize + gap); }
                        drawMediaCover(m, x, y, imgSize, imgSize, 16);
                        ctx.strokeStyle = m.type === 'video' ? '#a55eea' : theme.primary;
                        ctx.lineWidth = 3;
                        roundRect(x, y, imgSize, imgSize, 16);
                        ctx.stroke();
                    });
                    break;
                }
                case 'slideshow': {
                    if (validMedia[0]) {
                        drawMediaCover(validMedia[0], w * 0.05, h * 0.27, w * 0.9, h * 0.44, 20);
                    }
                    const dots = validMedia.length || 1;
                    for (let i = 0; i < dots; i++) {
                        ctx.beginPath();
                        ctx.arc(w / 2 - (dots - 1) * 12 + i * 24, h * 0.69, i === 0 ? 8 : 5, 0, Math.PI * 2);
                        ctx.fillStyle = i === 0 ? theme.primary : 'rgba(255,255,255,0.4)';
                        ctx.fill();
                    }
                    break;
                }
                case 'stack-cards': {
                    const cardW = w * 0.46, cardH = h * 0.34, cx = w / 2, cy = h * 0.47;
                    validMedia.slice(0, 5).reverse().forEach((m, idx) => {
                        const i = validMedia.length - 1 - idx;
                        ctx.save();
                        ctx.translate(cx, cy);
                        ctx.rotate((i - 2) * 8 * Math.PI / 180);
                        drawMediaCover(m, -cardW / 2, -cardH / 2, cardW, cardH, 16);
                        ctx.strokeStyle = theme.primary;
                        ctx.lineWidth = 3;
                        roundRect(-cardW / 2, -cardH / 2, cardW, cardH, 16);
                        ctx.stroke();
                        ctx.restore();
                    });
                    break;
                }
                case 'mosaic': {
                    const layouts = [
                        { x: 0.04, y: 0.27, w: 0.44, h: 0.29 },
                        { x: 0.52, y: 0.27, w: 0.44, h: 0.135 },
                        { x: 0.52, y: 0.42, w: 0.44, h: 0.135 },
                        { x: 0.04, y: 0.58, w: 0.3, h: 0.16 },
                        { x: 0.36, y: 0.58, w: 0.6, h: 0.16 }
                    ];
                    layouts.forEach((l, i) => {
                        if (!validMedia[i]) return;
                        drawMediaCover(validMedia[i], l.x * w, l.y * h, l.w * w, l.h * h, 12);
                        ctx.strokeStyle = theme.primary;
                        ctx.lineWidth = 2;
                        roundRect(l.x * w, l.y * h, l.w * w, l.h * h, 12);
                        ctx.stroke();
                    });
                    break;
                }
                case 'zoom-reveal': {
                    const cx = w / 2, cy = h * 0.47, r = w * 0.32;
                    if (validMedia[0]) {
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(cx, cy, r, 0, Math.PI * 2);
                        ctx.clip();
                        drawMediaCover(validMedia[0], cx - r, cy - r, r * 2, r * 2);
                        ctx.restore();
                        ctx.strokeStyle = theme.primary;
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.arc(cx, cy, r, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    break;
                }
                case 'dynamic-grid':
                case 'split-reveal': {
                    const size = w * 0.26;
                    const pos = [
                        { x: 0.09, y: 0.29, rot: -5 }, { x: 0.39, y: 0.27, rot: 3 }, { x: 0.67, y: 0.29, rot: -3 },
                        { x: 0.17, y: 0.45, rot: 4 }, { x: 0.5, y: 0.47, rot: -4 }
                    ];
                    validMedia.slice(0, 5).forEach((m, i) => {
                        const p = pos[i];
                        ctx.save();
                        ctx.translate(p.x * w + size / 2, p.y * h + size / 2);
                        ctx.rotate(p.rot * Math.PI / 180);
                        drawMediaCover(m, -size / 2, -size / 2, size, size, 12);
                        ctx.strokeStyle = theme.primary;
                        ctx.lineWidth = 2;
                        roundRect(-size / 2, -size / 2, size, size, 12);
                        ctx.stroke();
                        ctx.restore();
                    });
                    break;
                }
                case 'feed-carousel':
                case 'feed-zoom': {
                    if (validMedia[0]) {
                        drawMediaCover(validMedia[0], w * 0.05, h * 0.2, w * 0.9, h * 0.5, 16);
                    }
                    break;
                }
            }
        }

        function drawBlogTemplateStatic(theme) {
            const w = canvas.width, h = canvas.height;
            const title1 = document.getElementById('mainTitle').value;
            const title2 = document.getElementById('subTitle').value;
            const validMedia = state.media.filter(Boolean);

            switch (state.template) {
                case 'blog-thumbnail': {
                    if (validMedia[0]) drawMediaCover(validMedia[0], 0, 0, w, h);
                    const grad = ctx.createLinearGradient(0, h * 0.5, 0, h);
                    grad.addColorStop(0, 'rgba(0,0,0,0)');
                    grad.addColorStop(1, 'rgba(0,0,0,0.8)');
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, w, h);
                    drawText(title1, w / 2, h * 0.75, { size: h * 0.06, weight: '900', color: '#fff', shadow: true });
                    drawText(title2, w / 2, h * 0.85, { size: h * 0.035, weight: '500', color: theme.primary });
                    break;
                }
                case 'blog-quote': {
                    ctx.fillStyle = theme.bg;
                    ctx.fillRect(0, 0, w, h);
                    drawText('"', w * 0.1, h * 0.25, { size: h * 0.15, weight: '900', color: theme.primary, align: 'left' });
                    drawText(title1, w / 2, h * 0.45, { size: h * 0.045, weight: '700', color: theme.text });
                    drawText(title2, w / 2, h * 0.55, { size: h * 0.045, weight: '700', color: theme.text });
                    drawText('â€” ëª¨ì—¬ë¼ë”œ', w * 0.8, h * 0.75, { size: h * 0.025, weight: '500', color: '#888', align: 'right' });
                    break;
                }
                case 'blog-collage': {
                    const layouts = [
                        { x: 0.02, y: 0.02, w: 0.48, h: 0.58 },
                        { x: 0.52, y: 0.02, w: 0.46, h: 0.28 },
                        { x: 0.52, y: 0.32, w: 0.46, h: 0.28 },
                        { x: 0.02, y: 0.62, w: 0.96, h: 0.36 }
                    ];
                    layouts.forEach((l, i) => {
                        if (!validMedia[i]) return;
                        drawMediaCover(validMedia[i], l.x * w, l.y * h, l.w * w, l.h * h, 8);
                    });
                    break;
                }
                case 'blog-minimal': {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, w, h);
                    if (validMedia[0]) drawMediaCover(validMedia[0], w * 0.1, h * 0.1, w * 0.8, h * 0.5, 8);
                    drawText(title1, w / 2, h * 0.72, { size: h * 0.04, weight: '700', color: '#222' });
                    drawText(title2, w / 2, h * 0.82, { size: h * 0.025, weight: '400', color: '#666' });
                    break;
                }
                case 'blog-feature':
                case 'blog-list': {
                    ctx.fillStyle = theme.bg;
                    ctx.fillRect(0, 0, w, h);
                    if (validMedia[0]) drawMediaCover(validMedia[0], w * 0.05, h * 0.05, w * 0.4, h * 0.9, 12);
                    drawText(title1, w * 0.72, h * 0.3, { size: h * 0.05, weight: '700', color: theme.text });
                    drawText(title2, w * 0.72, h * 0.45, { size: h * 0.035, weight: '500', color: theme.primary });
                    break;
                }
            }
        }

        function drawProposalTemplateStatic(theme) {
            const w = canvas.width, h = canvas.height;
            const title1 = document.getElementById('mainTitle').value;
            const title2 = document.getElementById('subTitle').value;
            const validMedia = state.media.filter(Boolean);

            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, w, h);

            switch (state.template) {
                case 'proposal-cover': {
                    if (validMedia[0]) {
                        ctx.globalAlpha = 0.3;
                        drawMediaCover(validMedia[0], 0, 0, w, h);
                        ctx.globalAlpha = 1;
                    }
                    drawText(title1, w / 2, h * 0.4, { size: h * 0.07, weight: '900', color: theme.text });
                    drawText(title2, w / 2, h * 0.55, { size: h * 0.04, weight: '500', color: theme.primary });
                    drawText('ëª¨ì—¬ë¼ë”œ', w / 2, h * 0.85, { size: h * 0.025, weight: '600', color: '#666' });
                    break;
                }
                case 'proposal-stats': {
                    drawText('í•µì‹¬ ì§€í‘œ', w / 2, h * 0.12, { size: h * 0.04, weight: '700', color: theme.text });
                    const stats = [
                        { num: '350%', label: 'ë§¤ì¶œ ì„±ì¥' },
                        { num: '50K+', label: 'í™œì„± ì‚¬ìš©ì' },
                        { num: '98%', label: 'ê³ ê° ë§Œì¡±ë„' }
                    ];
                    stats.forEach((s, i) => {
                        const x = w * (0.2 + i * 0.3);
                        drawText(s.num, x, h * 0.45, { size: h * 0.08, weight: '900', color: theme.primary });
                        drawText(s.label, x, h * 0.6, { size: h * 0.025, weight: '500', color: '#888' });
                    });
                    break;
                }
                case 'proposal-compare': {
                    drawText('Before & After', w / 2, h * 0.1, { size: h * 0.035, weight: '700', color: theme.text });
                    ctx.fillStyle = 'rgba(255,71,87,0.1)';
                    roundRect(w * 0.05, h * 0.2, w * 0.42, h * 0.65, 12);
                    ctx.fill();
                    ctx.fillStyle = 'rgba(0,255,136,0.1)';
                    roundRect(w * 0.53, h * 0.2, w * 0.42, h * 0.65, 12);
                    ctx.fill();
                    drawText('BEFORE', w * 0.26, h * 0.28, { size: h * 0.025, weight: '700', color: '#ff6b81' });
                    drawText('AFTER', w * 0.74, h * 0.28, { size: h * 0.025, weight: '700', color: '#00ff88' });
                    if (validMedia[0]) drawMediaCover(validMedia[0], w * 0.08, h * 0.35, w * 0.36, h * 0.4, 8);
                    if (validMedia[1]) drawMediaCover(validMedia[1], w * 0.56, h * 0.35, w * 0.36, h * 0.4, 8);
                    break;
                }
                case 'proposal-timeline': {
                    drawText('í”„ë¡œì íŠ¸ íƒ€ì„ë¼ì¸', w / 2, h * 0.1, { size: h * 0.035, weight: '700', color: theme.text });
                    const phases = ['ê¸°íš', 'ë””ìì¸', 'ê°œë°œ', 'í…ŒìŠ¤íŠ¸', 'ëŸ°ì¹­'];
                    ctx.strokeStyle = theme.primary;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(w * 0.1, h * 0.5);
                    ctx.lineTo(w * 0.9, h * 0.5);
                    ctx.stroke();
                    phases.forEach((p, i) => {
                        const x = w * (0.15 + i * 0.175);
                        ctx.beginPath();
                        ctx.arc(x, h * 0.5, 12, 0, Math.PI * 2);
                        ctx.fillStyle = theme.primary;
                        ctx.fill();
                        drawText(p, x, h * 0.6, { size: h * 0.022, weight: '600', color: theme.text });
                    });
                    break;
                }
                case 'proposal-team': {
                    drawText('íŒ€ ì†Œê°œ', w / 2, h * 0.1, { size: h * 0.035, weight: '700', color: theme.text });
                    validMedia.slice(0, 4).forEach((m, i) => {
                        const x = w * (0.15 + i * 0.23);
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(x, h * 0.4, w * 0.08, 0, Math.PI * 2);
                        ctx.clip();
                        drawMediaCover(m, x - w * 0.08, h * 0.4 - w * 0.08, w * 0.16, w * 0.16);
                        ctx.restore();
                        ctx.strokeStyle = theme.primary;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(x, h * 0.4, w * 0.08, 0, Math.PI * 2);
                        ctx.stroke();
                    });
                    break;
                }
                case 'proposal-cta': {
                    drawText(title1, w / 2, h * 0.35, { size: h * 0.05, weight: '700', color: theme.text });
                    drawText(title2, w / 2, h * 0.48, { size: h * 0.035, weight: '500', color: '#888' });
                    drawCTA(theme, h * 0.6);
                    break;
                }
            }
        }

        // ========== ANIMATION ==========
        function playAnimation() {
            if (state.isPlaying) return;
            state.isPlaying = true;

            // Play all videos
            state.media.forEach(m => {
                if (m?.type === 'video') {
                    m.element.currentTime = 0;
                    m.element.play().catch(() => {});
                }
            });

            const duration = parseInt(document.getElementById('duration').value) * 1000;
            const startTime = performance.now();
            const theme = colorThemes[state.colorTheme];

            const animate = (currentTime) => {
                // Throttle to ~30fps for smoother performance
                if (currentTime - state.lastFrameTime < 33) {
                    state.animationId = requestAnimationFrame(animate);
                    return;
                }
                state.lastFrameTime = currentTime;

                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                ctx.fillStyle = theme.bg;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (state.category === 'meta') {
                    animateMetaTemplate(elapsed, duration, theme);
                } else {
                    // For blog/proposal, just show static with fade in
                    const fadeIn = Math.min(elapsed / 500, 1);
                    ctx.globalAlpha = ease.outCubic(fadeIn);
                    if (state.category === 'blog') drawBlogTemplateStatic(theme);
                    else drawProposalTemplateStatic(theme);
                    ctx.globalAlpha = 1;
                }

                if (progress < 1) {
                    state.animationId = requestAnimationFrame(animate);
                } else {
                    state.isPlaying = false;
                    if (state.isRecording) stopRecording();
                    document.getElementById('status').textContent = 'âœ… ì¬ìƒ ì™„ë£Œ!';
                    document.getElementById('status').classList.remove('recording');
                }
            };

            document.getElementById('status').textContent = 'â–¶ ì¬ìƒ ì¤‘...';
            state.animationId = requestAnimationFrame(animate);
        }

        function animateMetaTemplate(elapsed, duration, theme) {
            const w = canvas.width, h = canvas.height;
            const title1 = document.getElementById('mainTitle').value;
            const title2 = document.getElementById('subTitle').value;
            const validMedia = state.media.filter(Boolean);

            // Title animation
            const titleP = Math.min(elapsed / 800, 1);
            const titleY = h * 0.18 - h * 0.03 * (1 - ease.outCubic(titleP));
            ctx.globalAlpha = ease.outCubic(titleP);
            drawText(title1, w / 2, titleY, { size: h * 0.033, weight: '700', color: theme.text });
            drawText(title2, w / 2, titleY + h * 0.05, { size: h * 0.038, weight: '900', color: theme.primary });
            ctx.globalAlpha = 1;

            // Template-specific animations
            switch (state.template) {
                case 'grid-pop': animateGridPop(elapsed, duration, theme, validMedia); break;
                case 'bounce-in': animateBounceIn(elapsed, duration, theme, validMedia); break;
                case 'slideshow': animateSlideshow(elapsed, duration, theme, validMedia); break;
                case 'stack-cards': animateStackCards(elapsed, duration, theme, validMedia); break;
                case 'mosaic': animateMosaic(elapsed, duration, theme, validMedia); break;
                case 'zoom-reveal': animateZoomReveal(elapsed, duration, theme, validMedia); break;
                case 'dynamic-grid': animateDynamicGrid(elapsed, duration, theme, validMedia); break;
                case 'split-reveal': animateSplitReveal(elapsed, duration, theme, validMedia); break;
                default: drawMetaTemplateStatic(theme);
            }

            // CTA animation
            if (elapsed > duration - 2500) {
                const ctaP = Math.min((elapsed - (duration - 2500)) / 600, 1);
                drawCTA(theme, h * 0.76 + h * 0.03 * (1 - ease.outCubic(ctaP)), ease.outCubic(ctaP));
            }
        }

        function animateGridPop(elapsed, duration, theme, validMedia) {
            const w = canvas.width, h = canvas.height;
            const cols = 2, imgSize = w * 0.3, gap = w * 0.03;
            const startX = (w - (cols * imgSize + gap)) / 2, startY = h * 0.29;

            validMedia.slice(0, 5).forEach((m, i) => {
                const imgStart = 600 + i * 300;
                const imgElapsed = Math.max(0, elapsed - imgStart);
                const imgP = Math.min(imgElapsed / 350, 1);
                if (imgP <= 0) return;

                const col = i % cols, row = Math.floor(i / cols);
                let x = startX + col * (imgSize + gap), y = startY + row * (imgSize + gap);
                if (i === 4) { x = (w - imgSize) / 2; y = startY + 2 * (imgSize + gap); }

                const scale = ease.outBack(imgP);
                const cx = x + imgSize / 2, cy = y + imgSize / 2;
                const sz = imgSize * scale;

                ctx.globalAlpha = ease.outQuad(imgP);
                drawMediaCover(m, cx - sz / 2, cy - sz / 2, sz, sz, 16 * scale);
                ctx.strokeStyle = m.type === 'video' ? '#a55eea' : theme.primary;
                ctx.lineWidth = 3;
                roundRect(cx - sz / 2, cy - sz / 2, sz, sz, 16 * scale);
                ctx.stroke();
                ctx.globalAlpha = 1;
            });
        }

        function animateBounceIn(elapsed, duration, theme, validMedia) {
            const w = canvas.width, h = canvas.height;
            const cols = 2, imgSize = w * 0.3, gap = w * 0.03;
            const startX = (w - (cols * imgSize + gap)) / 2, startY = h * 0.29;

            validMedia.slice(0, 5).forEach((m, i) => {
                const imgStart = 500 + i * 250;
                const imgElapsed = Math.max(0, elapsed - imgStart);
                const imgP = Math.min(imgElapsed / 400, 1);
                if (imgP <= 0) return;

                const col = i % cols, row = Math.floor(i / cols);
                let x = startX + col * (imgSize + gap), y = startY + row * (imgSize + gap);
                if (i === 4) { x = (w - imgSize) / 2; y = startY + 2 * (imgSize + gap); }

                const scale = ease.outElastic(imgP);
                const cx = x + imgSize / 2, cy = y + imgSize / 2;
                const sz = imgSize * scale;

                ctx.globalAlpha = Math.min(imgP * 2, 1);
                drawMediaCover(m, cx - sz / 2, cy - sz / 2, sz, sz, 16);
                ctx.strokeStyle = theme.primary;
                ctx.lineWidth = 3;
                roundRect(cx - sz / 2, cy - sz / 2, sz, sz, 16);
                ctx.stroke();
                ctx.globalAlpha = 1;
            });
        }

        function animateSlideshow(elapsed, duration, theme, validMedia) {
            const w = canvas.width, h = canvas.height;
            const count = validMedia.length || 1;
            const transDur = (duration - 2500) / count;
            const mediaElapsed = Math.max(0, elapsed - 400);
            const idx = Math.min(Math.floor(mediaElapsed / transDur), count - 1);
            const localP = (mediaElapsed % transDur) / transDur;

            if (validMedia[idx]) {
                const fadeIn = Math.min(localP * 4, 1);
                const fadeOut = idx < count - 1 ? Math.max(0, 1 - (localP - 0.75) * 4) : 1;
                const scale = 1 + localP * 0.08;

                ctx.globalAlpha = fadeIn * fadeOut;
                ctx.save();
                ctx.translate(w / 2, h * 0.49);
                ctx.scale(scale, scale);
                ctx.translate(-w / 2, -h * 0.49);
                drawMediaCover(validMedia[idx], w * 0.05, h * 0.27, w * 0.9, h * 0.44, 20);
                ctx.restore();
                ctx.globalAlpha = 1;
            }

            for (let i = 0; i < count; i++) {
                ctx.beginPath();
                ctx.arc(w / 2 - (count - 1) * 12 + i * 24, h * 0.69, i === idx ? 8 : 5, 0, Math.PI * 2);
                ctx.fillStyle = i === idx ? theme.primary : 'rgba(255,255,255,0.4)';
                ctx.fill();
            }
        }

        function animateStackCards(elapsed, duration, theme, validMedia) {
            const w = canvas.width, h = canvas.height;
            const cardW = w * 0.46, cardH = h * 0.34, cx = w / 2, cy = h * 0.47;
            const spreadStart = 800;

            validMedia.slice(0, 5).forEach((m, i) => {
                const cardDelay = i * 180;
                const cardElapsed = Math.max(0, elapsed - spreadStart - cardDelay);
                const cardP = Math.min(cardElapsed / 450, 1);

                const mid = Math.floor(validMedia.length / 2);
                const targetRot = (i - mid) * 10;
                const rotation = targetRot * ease.outBack(cardP);
                const xOffset = (i - mid) * 35 * ease.outCubic(cardP);
                const stackOffset = (validMedia.length - 1 - i) * 12 * (1 - ease.outCubic(cardP));

                ctx.save();
                ctx.translate(cx + xOffset, cy + stackOffset);
                ctx.rotate(rotation * Math.PI / 180);
                drawMediaCover(m, -cardW / 2, -cardH / 2, cardW, cardH, 16);
                ctx.strokeStyle = theme.primary;
                ctx.lineWidth = 3;
                roundRect(-cardW / 2, -cardH / 2, cardW, cardH, 16);
                ctx.stroke();
                ctx.restore();
            });
        }

        function animateMosaic(elapsed, duration, theme, validMedia) {
            const w = canvas.width, h = canvas.height;
            const layouts = [
                { x: 0.04, y: 0.27, w: 0.44, h: 0.29, dir: 'left' },
                { x: 0.52, y: 0.27, w: 0.44, h: 0.135, dir: 'right' },
                { x: 0.52, y: 0.42, w: 0.44, h: 0.135, dir: 'right' },
                { x: 0.04, y: 0.58, w: 0.3, h: 0.16, dir: 'bottom' },
                { x: 0.36, y: 0.58, w: 0.6, h: 0.16, dir: 'bottom' }
            ];

            layouts.forEach((l, i) => {
                if (!validMedia[i]) return;
                const imgStart = 500 + i * 250;
                const imgElapsed = Math.max(0, elapsed - imgStart);
                const imgP = Math.min(imgElapsed / 400, 1);
                if (imgP <= 0) return;

                let offsetX = 0, offsetY = 0;
                if (l.dir === 'left') offsetX = -w * 0.15 * (1 - ease.outCubic(imgP));
                else if (l.dir === 'right') offsetX = w * 0.15 * (1 - ease.outCubic(imgP));
                else if (l.dir === 'bottom') offsetY = h * 0.1 * (1 - ease.outCubic(imgP));

                ctx.globalAlpha = ease.outCubic(imgP);
                drawMediaCover(validMedia[i], l.x * w + offsetX, l.y * h + offsetY, l.w * w, l.h * h, 12);
                ctx.strokeStyle = theme.primary;
                ctx.lineWidth = 2;
                roundRect(l.x * w + offsetX, l.y * h + offsetY, l.w * w, l.h * h, 12);
                ctx.stroke();
                ctx.globalAlpha = 1;
            });
        }

        function animateZoomReveal(elapsed, duration, theme, validMedia) {
            const w = canvas.width, h = canvas.height;
            const cx = w / 2, cy = h * 0.47, maxR = w * 0.32;
            const count = validMedia.length || 1;
            const mediaDur = (duration - 2500) / count;
            const mediaElapsed = Math.max(0, elapsed - 600);
            const idx = Math.min(Math.floor(mediaElapsed / mediaDur), count - 1);
            const localP = (mediaElapsed % mediaDur) / mediaDur;

            if (validMedia[idx]) {
                const zoomP = ease.outCubic(Math.min(localP * 2.5, 1));
                const r = maxR * zoomP;
                const fadeOut = idx < count - 1 ? Math.max(0, 1 - (localP - 0.7) * 3.3) : 1;

                ctx.globalAlpha = fadeOut;
                ctx.save();
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, Math.PI * 2);
                ctx.clip();
                drawMediaCover(validMedia[idx], cx - r, cy - r, r * 2, r * 2);
                ctx.restore();
                ctx.strokeStyle = theme.primary;
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, Math.PI * 2);
                ctx.stroke();
                ctx.globalAlpha = 1;
            }

            // Ripple effect
            const rippleP = (elapsed % 1200) / 1200;
            [1, 1.15, 1.3].forEach((mult, i) => {
                const rp = (rippleP + i * 0.12) % 1;
                ctx.globalAlpha = 0.3 * (1 - rp);
                ctx.strokeStyle = theme.secondary;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(cx, cy, maxR + w * 0.08 * rp, 0, Math.PI * 2);
                ctx.stroke();
            });
            ctx.globalAlpha = 1;
        }

        function animateDynamicGrid(elapsed, duration, theme, validMedia) {
            const w = canvas.width, h = canvas.height;
            const size = w * 0.26;
            const pos = [
                { x: 0.09, y: 0.29, rot: -8 }, { x: 0.39, y: 0.27, rot: 5 }, { x: 0.67, y: 0.29, rot: -4 },
                { x: 0.17, y: 0.45, rot: 6 }, { x: 0.5, y: 0.47, rot: -5 }
            ];

            validMedia.slice(0, 5).forEach((m, i) => {
                const imgStart = 500 + i * 300;
                const imgElapsed = Math.max(0, elapsed - imgStart);
                const imgP = Math.min(imgElapsed / 450, 1);
                if (imgP <= 0) return;

                const p = pos[i];
                const scale = ease.outBack(imgP);
                const rotation = p.rot * ease.outCubic(imgP);

                ctx.save();
                ctx.globalAlpha = ease.outCubic(imgP);
                ctx.translate(p.x * w + size / 2, p.y * h + size / 2);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.scale(scale, scale);
                drawMediaCover(m, -size / 2, -size / 2, size, size, 12);
                ctx.strokeStyle = theme.primary;
                ctx.lineWidth = 3;
                roundRect(-size / 2, -size / 2, size, size, 12);
                ctx.stroke();
                ctx.restore();
            });
        }

        function animateSplitReveal(elapsed, duration, theme, validMedia) {
            const w = canvas.width, h = canvas.height;
            const size = w * 0.26;
            const pos = [
                { x: 0.09, y: 0.29 }, { x: 0.67, y: 0.29 },
                { x: 0.09, y: 0.52 }, { x: 0.67, y: 0.52 },
                { x: 0.38, y: 0.4 }
            ];

            validMedia.slice(0, 5).forEach((m, i) => {
                const imgStart = 600 + i * 200;
                const imgElapsed = Math.max(0, elapsed - imgStart);
                const imgP = Math.min(imgElapsed / 400, 1);
                if (imgP <= 0) return;

                const p = pos[i];
                const fromLeft = i % 2 === 0;
                const offsetX = (fromLeft ? -w * 0.3 : w * 0.3) * (1 - ease.outCubic(imgP));

                ctx.globalAlpha = ease.outCubic(imgP);
                drawMediaCover(m, p.x * w + offsetX, p.y * h, size, size, 12);
                ctx.strokeStyle = theme.primary;
                ctx.lineWidth = 2;
                roundRect(p.x * w + offsetX, p.y * h, size, size, 12);
                ctx.stroke();
                ctx.globalAlpha = 1;
            });
        }

        // ========== RECORDING ==========
        function toggleRecording() {
            state.isRecording ? stopRecording() : startRecording();
        }

        function startRecording() {
            state.videoBlob = null;
            document.getElementById('downloadBtn').disabled = true;

            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 8000000
            });

            const chunks = [];
            recorder.ondataavailable = e => e.data.size > 0 && chunks.push(e.data);
            recorder.onstop = () => {
                state.videoBlob = new Blob(chunks, { type: 'video/webm' });
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('status').textContent = 'âœ… ë…¹í™” ì™„ë£Œ! ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”';
                document.getElementById('status').classList.remove('recording');
            };

            state.mediaRecorder = recorder;
            recorder.start();
            state.isRecording = true;

            document.getElementById('recordBtn').classList.add('recording');
            document.getElementById('recordBtn').textContent = 'â–  ì¤‘ì§€';
            document.getElementById('status').textContent = 'ğŸ”´ ë…¹í™” ì¤‘...';
            document.getElementById('status').classList.add('recording');

            setTimeout(playAnimation, 200);
        }

        function stopRecording() {
            if (state.mediaRecorder?.state !== 'inactive') state.mediaRecorder.stop();
            state.isRecording = false;
            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('recordBtn').textContent = 'â— ë…¹í™”';
        }

        function downloadVideo() {
            if (!state.videoBlob) return;
            const url = URL.createObjectURL(state.videoBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `moyeoradeal_${state.template}_${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            document.getElementById('status').textContent = 'â¬‡ï¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!';
        }

        // ========== AI CONTENT GENERATOR ==========
        const AI_KEY_STORAGE = 'moyeoradeal_ai_key';

        function initAI() {
            const savedKey = localStorage.getItem(AI_KEY_STORAGE);
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKeyStatus = document.getElementById('apiKeyStatus');

            if (savedKey) {
                apiKeyInput.value = savedKey;
                apiKeyStatus.textContent = 'âœ“ ì—°ê²°ë¨';
                apiKeyStatus.classList.remove('disconnected');
                apiKeyStatus.classList.add('connected');
            }

            apiKeyInput.onchange = () => {
                const key = apiKeyInput.value.trim();
                if (key && key.startsWith('sk-ant-')) {
                    localStorage.setItem(AI_KEY_STORAGE, key);
                    apiKeyStatus.textContent = 'âœ“ ì—°ê²°ë¨';
                    apiKeyStatus.classList.remove('disconnected');
                    apiKeyStatus.classList.add('connected');
                } else if (!key) {
                    localStorage.removeItem(AI_KEY_STORAGE);
                    apiKeyStatus.textContent = 'ì—°ê²° ì•ˆë¨';
                    apiKeyStatus.classList.remove('connected');
                    apiKeyStatus.classList.add('disconnected');
                }
            };

            document.getElementById('aiGenerateBtn').onclick = generateAIContent;
            document.getElementById('aiCopyBtn').onclick = copyAIResult;
            document.getElementById('aiApplyBtn').onclick = applyAIResult;
        }

        async function generateAIContent() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const prompt = document.getElementById('aiPrompt').value.trim();
            const btn = document.getElementById('aiGenerateBtn');
            const result = document.getElementById('aiResult');
            const resultText = document.getElementById('aiResultText');

            if (!apiKey) {
                alert('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            if (!prompt) {
                alert('ìƒì„±í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = '<span>â³</span> ìƒì„± ì¤‘...';

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        messages: [{
                            role: 'user',
                            content: `ë‹¹ì‹ ì€ ë§ˆì¼€íŒ… ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ìš”ì²­ì— ë§ëŠ” ê´‘ê³ /ë§ˆì¼€íŒ… ë¬¸êµ¬ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
ê°„ê²°í•˜ê³  ì„íŒ©íŠ¸ ìˆê²Œ ì‘ì„±í•˜ì„¸ìš”. ë©”ì¸ íƒ€ì´í‹€, ì„œë¸Œ íƒ€ì´í‹€, CTA ë¬¸êµ¬ë¥¼ ê°ê° ì œì•ˆí•´ì£¼ì„¸ìš”.

ìš”ì²­: ${prompt}

í˜•ì‹:
[ë©”ì¸ íƒ€ì´í‹€] (15ì ì´ë‚´)
[ì„œë¸Œ íƒ€ì´í‹€] (20ì ì´ë‚´)
[CTA ë¬¸êµ¬] (10ì ì´ë‚´)

ì¶”ê°€ë¡œ 2-3ê°œ ëŒ€ì•ˆë„ ì œì‹œí•´ì£¼ì„¸ìš”.`
                        }]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API ì˜¤ë¥˜');
                }

                const data = await response.json();
                const content = data.content[0].text;

                resultText.innerHTML = content.replace(/\n/g, '<br>').replace(/\[([^\]]+)\]/g, '<strong style="color:#a55eea">[$1]</strong>');
                result.classList.add('visible');

                // Parse and store for apply
                state.aiGeneratedContent = parseAIContent(content);

            } catch (err) {
                alert('ì˜¤ë¥˜: ' + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = '<span>âœ¨</span> AI ë¬¸êµ¬ ìƒì„±';
            }
        }

        function parseAIContent(text) {
            const lines = text.split('\n');
            const result = { mainTitle: '', subTitle: '', cta: '' };

            for (const line of lines) {
                if (line.includes('[ë©”ì¸ íƒ€ì´í‹€]') || line.includes('ë©”ì¸ íƒ€ì´í‹€:')) {
                    result.mainTitle = line.replace(/\[ë©”ì¸ íƒ€ì´í‹€\]|ë©”ì¸ íƒ€ì´í‹€:/g, '').trim();
                } else if (line.includes('[ì„œë¸Œ íƒ€ì´í‹€]') || line.includes('ì„œë¸Œ íƒ€ì´í‹€:')) {
                    result.subTitle = line.replace(/\[ì„œë¸Œ íƒ€ì´í‹€\]|ì„œë¸Œ íƒ€ì´í‹€:/g, '').trim();
                } else if (line.includes('[CTA ë¬¸êµ¬]') || line.includes('CTA ë¬¸êµ¬:') || line.includes('CTA:')) {
                    result.cta = line.replace(/\[CTA ë¬¸êµ¬\]|CTA ë¬¸êµ¬:|CTA:/g, '').trim();
                }
            }

            return result;
        }

        function copyAIResult() {
            const text = document.getElementById('aiResultText').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('aiCopyBtn');
                btn.textContent = 'âœ“ ë³µì‚¬ë¨';
                setTimeout(() => btn.textContent = 'ğŸ“‹ ë³µì‚¬', 2000);
            });
        }

        function applyAIResult() {
            if (!state.aiGeneratedContent) return;

            const { mainTitle, subTitle, cta } = state.aiGeneratedContent;

            if (mainTitle) document.getElementById('mainTitle').value = mainTitle;
            if (subTitle) document.getElementById('subTitle').value = subTitle;
            if (cta) document.getElementById('ctaText').value = cta;

            updatePreview();

            const btn = document.getElementById('aiApplyBtn');
            btn.textContent = 'âœ“ ì ìš©ë¨';
            setTimeout(() => btn.textContent = 'âœ… ì ìš©', 2000);
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì—¬ë¼ë”œ íŒŒíŠ¸ë„ˆ í¬í„¸</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #fc9600;
      --primary-light: #fff8f0;
      --primary-dark: #e08600;
      --white: #ffffff;
      --gray-900: #191f28;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      --success: #00c073;
      --success-light: #e8f7f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --info: #3182f6;
      --info-light: #eef4ff;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      min-height: 100vh; 
      background: var(--gray-100);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    /* ===== ë¡œê·¸ì¸ í˜ì´ì§€ ===== */
    .login-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-container {
      width: 100%;
      max-width: 400px;
    }
    
    .logo-section {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .logo-img {
      height: 48px;
      margin-bottom: 8px;
    }
    
    .logo-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-top: 8px;
    }
    
    .login-card {
      background: var(--white);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    
    .tab-buttons {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--gray-100);
      padding: 4px;
      border-radius: 10px;
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    
    .tab-btn.active {
      background: var(--white);
      color: var(--gray-900);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .tab-btn.supplier.active { color: var(--info); }
    .tab-btn.seller.active { color: var(--primary); }
    
    .form-group { margin-bottom: 20px; }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--gray-50);
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--white);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    
    .form-input::placeholder { color: var(--gray-400); }
    
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: var(--white);
      width: 100%;
    }
    
    .btn-primary:hover { background: var(--primary-dark); }
    
    .btn-supplier {
      background: var(--info);
      color: var(--white);
      width: 100%;
    }
    
    .btn-supplier:hover { background: #2563eb; }
    
    .btn-seller {
      background: var(--primary);
      color: var(--white);
      width: 100%;
    }
    
    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }
    
    .btn-secondary:hover { background: var(--gray-200); }
    
    .btn.loading {
      position: relative;
      color: transparent;
      pointer-events: none;
    }
    
    .btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .input-icon {
      position: relative;
    }
    
    .input-icon .icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }
    
    .input-icon .form-input {
      padding-left: 48px;
    }
    
    .error-message {
      background: var(--danger-light);
      border: 1px solid #fecaca;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }
    
    .error-message.show { display: block; }
    
    .help-text {
      text-align: center;
      margin-top: 24px;
      font-size: 13px;
      color: var(--gray-500);
    }
    
    .footer-text {
      margin-top: 40px;
      text-align: center;
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* ===== í¬í„¸ ë ˆì´ì•„ì›ƒ ===== */
    .portal-page {
      display: none;
    }
    
    .portal-page.active {
      display: block;
    }
    
    .portal-header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .portal-header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .portal-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .portal-logo img {
      height: 32px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .user-badge.supplier {
      background: var(--info-light);
      color: var(--info);
    }
    
    .user-badge.seller {
      background: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .logout-btn {
      padding: 8px 16px;
      background: var(--gray-100);
      border: none;
      border-radius: 8px;
      font-size: 13px;
      color: var(--gray-600);
      cursor: pointer;
      font-family: inherit;
    }
    
    .logout-btn:hover {
      background: var(--gray-200);
    }
    
    /* ë„¤ë¹„ê²Œì´ì…˜ */
    .portal-nav {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      overflow-x: auto;
    }
    
    .portal-nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 4px;
      padding: 8px 24px;
    }
    
    .nav-item {
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
      transition: all 0.15s;
    }
    
    .nav-item:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }
    
    .nav-item.active {
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }
    
    /* ë©”ì¸ ì½˜í…ì¸  */
    .portal-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .page-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 24px;
    }
    
    .card {
      background: var(--white);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* ëŒ€ì‹œë³´ë“œ í†µê³„ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .stat-card.highlight {
      background: var(--primary);
      color: var(--white);
    }
    
    .stat-card.highlight .stat-label,
    .stat-card.highlight .stat-value {
      color: var(--white);
    }
    
    /* ë¦¬ìŠ¤íŠ¸ */
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    .list-item:hover {
      background: var(--gray-50);
    }
    
    .list-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .list-meta {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* ìƒíƒœ ë±ƒì§€ */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-ongoing {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .status-upcoming {
      background: var(--info-light);
      color: var(--info);
    }
    
    .status-completed {
      background: var(--gray-100);
      color: var(--gray-600);
    }
    
    /* ìº˜ë¦°ë” */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .calendar-nav button {
      width: 36px;
      height: 36px;
      border: 1px solid var(--gray-200);
      background: var(--white);
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .calendar-nav button:hover {
      background: var(--gray-50);
    }
    
    .calendar-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .calendar-weekday {
      background: var(--gray-50);
      padding: 12px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
    }
    
    .calendar-weekday:first-child {
      color: var(--danger);
    }
    
    .calendar-weekday:last-child {
      color: var(--info);
    }
    
    .calendar-day {
      background: var(--white);
      min-height: 100px;
      padding: 8px;
    }
    
    .calendar-day.other-month {
      background: var(--gray-50);
    }
    
    .calendar-day.other-month .day-number {
      color: var(--gray-400);
    }
    
    .calendar-day.today {
      background: var(--primary-light);
    }
    
    .day-number {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .day-number.sunday { color: var(--danger); }
    .day-number.saturday { color: var(--info); }
    
    .deal-badge {
      display: block;
      padding: 4px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      background: var(--primary);
      color: var(--white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    
    .deal-badge:hover {
      filter: brightness(0.95);
    }
    
    /* ê³µì§€ì‚¬í•­ */
    .notice-item {
      padding: 20px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
    }
    
    .notice-item:hover {
      background: var(--gray-50);
    }
    
    .notice-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .notice-badge.important {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .notice-badge.normal {
      background: var(--gray-100);
      color: var(--gray-600);
    }
    
    .notice-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .notice-date {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* ì†Œí†µ/ë©”ì‹œì§€ */
    .message-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .message-item {
      padding: 16px;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .message-item:last-child {
      border-bottom: none;
    }
    
    .message-item.mine {
      background: var(--primary-light);
    }
    
    .message-item.admin {
      background: var(--info-light);
    }
    
    .message-sender {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .message-item.mine .message-sender {
      color: var(--primary-dark);
    }
    
    .message-item.admin .message-sender {
      color: var(--info);
    }
    
    .message-content {
      font-size: 14px;
      line-height: 1.6;
    }
    
    .message-time {
      font-size: 11px;
      color: var(--gray-400);
      margin-top: 4px;
    }
    
    .message-input-area {
      display: flex;
      gap: 12px;
    }
    
    .message-input-area .form-input {
      flex: 1;
    }
    
    /* ìƒí’ˆ ë“±ë¡ (ê³µê¸‰ì‚¬) */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    
    .product-card {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 16px;
    }
    
    .product-name {
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .product-info {
      font-size: 13px;
      color: var(--gray-600);
    }
    
    /* ì •ì‚°ì„œ */
    .settlement-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      padding: 20px;
      background: var(--gray-50);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .settlement-item {
      text-align: center;
    }
    
    .settlement-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }
    
    .settlement-value {
      font-size: 20px;
      font-weight: 700;
    }
    
    /* í…Œì´ë¸” */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .data-table th {
      background: var(--gray-50);
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-600);
    }
    
    .data-table tbody tr:hover {
      background: var(--gray-50);
    }
    
    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: 8px;
      font-size: 20px;
      cursor: pointer;
      color: var(--gray-500);
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-100);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-900);
      color: var(--white);
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .portal-header-inner {
        flex-direction: column;
        gap: 12px;
      }
      
      .user-info {
        width: 100%;
        justify-content: space-between;
      }
      
      .portal-nav-inner {
        padding: 8px 16px;
      }
      
      .portal-content {
        padding: 16px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .calendar-day {
        min-height: 80px;
        padding: 4px;
      }
      
      .day-number {
        font-size: 12px;
      }
      
      .deal-badge {
        font-size: 10px;
        padding: 2px 4px;
      }
    }
  </style>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
  <div id="login-page" class="login-page">
    <div class="login-container">
      <div class="logo-section">
        <img src="logo-horizontal.png" alt="ëª¨ì—¬ë¼ë”œ" class="logo-img">
        <div class="logo-desc">íŒŒíŠ¸ë„ˆ í¬í„¸</div>
      </div>
      
      <div class="login-card">
        <div class="tab-buttons">
          <button class="tab-btn supplier active" onclick="switchLoginTab('supplier')">ğŸ­ ê³µê¸‰ì‚¬</button>
          <button class="tab-btn seller" onclick="switchLoginTab('seller')">ğŸ‘¤ ì…€ëŸ¬</button>
        </div>
        
        <div id="error-message" class="error-message">
          ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
        
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label">ì•„ì´ë””</label>
            <div class="input-icon">
              <span class="icon">ğŸ‘¤</span>
              <input type="text" class="form-input" id="login-id" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required autocomplete="off">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
            <div class="input-icon">
              <span class="icon">ğŸ”’</span>
              <input type="password" class="form-input" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #666;">
              <input type="checkbox" id="remember-id" style="width: 16px; height: 16px; cursor: pointer;">
              ì•„ì´ë”” ì €ì¥
            </label>
          </div>
          
          <button type="submit" class="btn btn-supplier" id="login-btn">ë¡œê·¸ì¸</button>
        </form>
        
        <div class="help-text">
          ë¡œê·¸ì¸ ì •ë³´ëŠ” ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
        </div>
      </div>
      
      <div class="footer-text">
        Â© 2025 ëª¨ì—¬ë¼ë”œ. All rights reserved.
      </div>
    </div>
  </div>
  
  <!-- í¬í„¸ í˜ì´ì§€ -->
  <div id="portal-page" class="portal-page">
    <!-- í—¤ë” -->
    <header class="portal-header">
      <div class="portal-header-inner">
        <div class="portal-logo">
          <img src="logo-horizontal.png" alt="ëª¨ì—¬ë¼ë”œ">
        </div>
        <div class="user-info">
          <span id="user-badge" class="user-badge supplier">ğŸ­ ê³µê¸‰ì‚¬ëª…</span>
          <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </header>
    
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="portal-nav">
      <div class="portal-nav-inner" id="nav-menu">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
    </nav>
    
    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="portal-content" id="main-content">
      <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
    </main>
  </div>
  
  <!-- ëª¨ë‹¬ -->
  <div id="modal" class="modal" onclick="if(event.target===this)closeModal()"></div>
  
  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
  authDomain: "moyeora-deal-manager.firebaseapp.com",
  projectId: "moyeora-deal-manager",
  storageBucket: "moyeora-deal-manager.firebasestorage.app",
  messagingSenderId: "527148187832",
  appId: "1:527148187832:web:dc35b0413a7157db34744d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ìƒíƒœ ê´€ë¦¬
let state = {
  currentUser: null,
  userType: null, // 'supplier' or 'seller'
  currentPage: 'dashboard',
  suppliers: [],
  sellers: [],
  deals: [],
  supplierProducts: [],
  notices: [],
  messages: [],
  settlements: [],
  supplierSettlements: []
};

let loginTab = 'supplier';

// ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
const formatDate = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

const formatDateKR = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
};

const formatNumber = (num) => {
  return (num || 0).toLocaleString();
};

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function closeModal() {
  document.getElementById('modal').className = 'modal';
}

// ===== ë¡œê·¸ì¸ ê´€ë ¨ =====
function switchLoginTab(tab) {
  loginTab = tab;
  
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.tab-btn.${tab}`).classList.add('active');
  
  const loginBtn = document.getElementById('login-btn');
  loginBtn.className = `btn btn-${tab}`;
  
  document.getElementById('error-message').classList.remove('show');
  
  // íƒ­ ì „í™˜ì‹œ ì €ì¥ëœ ì•„ì´ë”” ë¶ˆëŸ¬ì˜¤ê¸°
  loadSavedLoginId();
  document.getElementById('login-pw').value = '';
}

// ì €ì¥ëœ ì•„ì´ë”” ë¶ˆëŸ¬ì˜¤ê¸°
function loadSavedLoginId() {
  const savedId = localStorage.getItem(`partner_${loginTab}_id`);
  const rememberCheck = document.getElementById('remember-id');
  const loginIdInput = document.getElementById('login-id');
  
  if (savedId) {
    loginIdInput.value = savedId;
    rememberCheck.checked = true;
  } else {
    loginIdInput.value = '';
    rememberCheck.checked = false;
  }
}

async function handleLogin(e) {
  e.preventDefault();
  
  const loginId = document.getElementById('login-id').value.trim();
  const loginPw = document.getElementById('login-pw').value;
  const loginBtn = document.getElementById('login-btn');
  const errorMsg = document.getElementById('error-message');
  const rememberCheck = document.getElementById('remember-id');
  
  errorMsg.classList.remove('show');
  loginBtn.classList.add('loading');
  
  // ë°ì´í„° ë¡œë“œ ëŒ€ê¸° (ìµœëŒ€ 5ì´ˆ)
  let waitCount = 0;
  while ((state.suppliers.length === 0 && state.sellers.length === 0) && waitCount < 50) {
    await new Promise(r => setTimeout(r, 100));
    waitCount++;
  }
  
  await new Promise(r => setTimeout(r, 300));
  
  let matched = null;
  
  if (loginTab === 'supplier') {
    matched = state.suppliers.find(s => s.loginId === loginId && s.loginPw === loginPw);
    
    if (matched) {
      // ì•„ì´ë”” ì €ì¥ ì²˜ë¦¬
      if (rememberCheck.checked) {
        localStorage.setItem('partner_supplier_id', loginId);
      } else {
        localStorage.removeItem('partner_supplier_id');
      }
      
      state.currentUser = matched;
      state.userType = 'supplier';
      loginBtn.classList.remove('loading');
      showPortal();
      return;
    }
  } else {
    matched = state.sellers.find(s => s.loginId === loginId && s.loginPw === loginPw);
    
    if (matched) {
      // ì•„ì´ë”” ì €ì¥ ì²˜ë¦¬
      if (rememberCheck.checked) {
        localStorage.setItem('partner_seller_id', loginId);
      } else {
        localStorage.removeItem('partner_seller_id');
      }
      
      state.currentUser = matched;
      state.userType = 'seller';
      loginBtn.classList.remove('loading');
      showPortal();
      return;
    }
  }
  
  loginBtn.classList.remove('loading');
  errorMsg.classList.add('show');
  document.getElementById('login-pw').value = '';
}

function handleLogout() {
  state.currentUser = null;
  state.userType = null;
  state.currentPage = 'dashboard';
  
  document.getElementById('login-page').style.display = 'flex';
  document.getElementById('portal-page').classList.remove('active');
  
  // ì €ì¥ëœ ì•„ì´ë”” ë¶ˆëŸ¬ì˜¤ê¸°
  loadSavedLoginId();
  document.getElementById('login-pw').value = '';
}

// ===== í¬í„¸ í‘œì‹œ =====
function showPortal() {
  document.getElementById('login-page').style.display = 'none';
  document.getElementById('portal-page').classList.add('active');
  
  // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
  const badge = document.getElementById('user-badge');
  if (state.userType === 'supplier') {
    badge.className = 'user-badge supplier';
    badge.innerHTML = `ğŸ­ ${state.currentUser.name}`;
  } else {
    badge.className = 'user-badge seller';
    badge.innerHTML = `ğŸ‘¤ ${state.currentUser.name}`;
  }
  
  renderNav();
  renderPage('dashboard');
}

function renderNav() {
  const nav = document.getElementById('nav-menu');
  
  const commonMenus = [
    { id: 'dashboard', icon: 'ğŸ“Š', label: 'ëŒ€ì‹œë³´ë“œ' },
    { id: 'calendar', icon: 'ğŸ“…', label: 'ë‚´ ì¼ì •' },
    { id: 'notice', icon: 'ğŸ“¢', label: 'ê³µì§€ì‚¬í•­' }
  ];
  
  const supplierMenus = [
    { id: 'products', icon: 'ğŸ“¦', label: 'ìƒí’ˆ ë“±ë¡' },
    { id: 'settlement', icon: 'ğŸ’°', label: 'ì •ì‚°ì„œ' }
  ];
  
  const sellerMenus = [
    { id: 'suggest', icon: 'ğŸ’¡', label: 'ê³µêµ¬ ì œì•ˆ' }
  ];
  
  const menus = state.userType === 'supplier' 
    ? [...commonMenus, ...supplierMenus]
    : [...commonMenus, ...sellerMenus];
  
  nav.innerHTML = menus.map(m => `
    <button class="nav-item ${state.currentPage === m.id ? 'active' : ''}" onclick="renderPage('${m.id}')">
      ${m.icon} ${m.label}
    </button>
  `).join('');
}

// ===== í˜ì´ì§€ ë Œë”ë§ =====
function renderPage(page) {
  state.currentPage = page;
  renderNav();
  
  const content = document.getElementById('main-content');
  
  switch(page) {
    case 'dashboard': renderDashboard(content); break;
    case 'calendar': renderCalendar(content); break;
    case 'notice': renderNotice(content); break;
    case 'message': renderMessage(content); break;
    case 'products': renderProducts(content); break;
    case 'settlement': renderSettlement(content); break;
    case 'suggest': renderSuggest(content); break;
  }
}

// ===== ëŒ€ì‹œë³´ë“œ =====
function renderDashboard(container) {
  const myDeals = getMyDeals();
  const today = new Date();
  today.setHours(0,0,0,0);
  
  const ongoingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    const end = new Date(d.endDate);
    return today >= start && today <= end;
  });
  
  const upcomingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    return today < start;
  }).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
  
  const completedDeals = myDeals.filter(d => {
    const end = new Date(d.endDate);
    return today > end;
  });
  
  // ê³µê¸‰ì‚¬ìš©: ê³µêµ¬ ì§„í–‰ TOP 5 ê³„ì‚°
  let topProductsHtml = '';
  let productStats = [];
  if (state.userType === 'supplier') {
    // ë‚´ ìƒí’ˆ ëª©ë¡
    const myProducts = state.supplierProducts.filter(p => {
      if (p.supplierId === state.currentUser.id) return true;
      if (p.brandName && state.currentUser.name && 
          p.brandName.includes(state.currentUser.name)) return true;
      return false;
    });
    
    // ìƒí’ˆë³„ ê³µêµ¬ ì—°ê²° ìˆ˜ ê³„ì‚°
    productStats = myProducts.map(p => {
      // selectedProductsê°€ ê°ì²´ ë°°ì—´ ë˜ëŠ” ë¬¸ìì—´ ë°°ì—´ì¼ ìˆ˜ ìˆìŒ
      const linkedDeals = state.deals.filter(d => {
        if (!d.selectedProducts) return false;
        return d.selectedProducts.some(item => {
          const pid = typeof item === 'string' ? item : item.productId;
          return pid === p.id;
        });
      });
      return {
        ...p,
        dealCount: linkedDeals.length
      };
    }).filter(p => p.dealCount > 0)
      .sort((a, b) => b.dealCount - a.dealCount)
      .slice(0, 5);
  }
  
  // íŒë§¤ ë² ìŠ¤íŠ¸ TOP 5 (ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œ ì •ì‚°ì™„ë£Œ ê¸°ì¤€) - ê³µê¸‰ì‚¬ìš©
  let salesBestHtml = '';
  if (state.userType === 'supplier') {
    const salesByProduct = {};
    
    // 1. sellerSettlementsì—ì„œ ì •ì‚°ì™„ë£Œëœ ë‚´ ë¸Œëœë“œ ë°ì´í„°
    (state.sellerSettlements || []).forEach(ss => {
      // ì •ì‚°ì™„ë£Œëœ ê²ƒë§Œ
      if (!ss.isCompleted) return;
      
      // ë‚´ ë¸Œëœë“œ í•„í„°ë§: supplierId ë˜ëŠ” brandNameìœ¼ë¡œ ë§¤ì¹­
      const isMyBrand = ss.supplierId === state.currentUser.id ||
        (ss.brandName && state.currentUser.name && ss.brandName.includes(state.currentUser.name));
      if (!isMyBrand) return;
      
      // salesItemsì—ì„œ ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const items = ss.salesItems || ss.items || [];
      if (items.length > 0) {
        items.forEach(item => {
          const productName = item.productName || item.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
          if (!salesByProduct[productName]) {
            salesByProduct[productName] = { productName, totalQty: 0, totalAmount: 0 };
          }
          salesByProduct[productName].totalQty += Number(item.quantity) || 0;
          salesByProduct[productName].totalAmount += Number(item.amount) || 0;
        });
      } else {
        // salesItemsê°€ ì—†ëŠ” ê²½ìš° - ê³µêµ¬ì—ì„œ ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
        const deal = state.deals.find(d => d.id === ss.dealId);
        if (deal && deal.selectedProducts) {
          deal.selectedProducts.forEach(sp => {
            const productName = typeof sp === 'string' ? 
              (state.supplierProducts.find(p => p.id === sp)?.productName || 'ìƒí’ˆ') :
              (sp.productName || 'ìƒí’ˆ');
            if (!salesByProduct[productName]) {
              salesByProduct[productName] = { productName, totalQty: 0, totalAmount: 0 };
            }
            // ê¸ˆì•¡ì„ ìƒí’ˆ ìˆ˜ë¡œ ë‚˜ëˆ„ì–´ ë°°ë¶„
            const productCount = deal.selectedProducts.length || 1;
            salesByProduct[productName].totalQty += Math.ceil((Number(ss.quantity) || 0) / productCount);
            salesByProduct[productName].totalAmount += Math.round((Number(ss.salesAmount) || 0) / productCount);
          });
        } else {
          // ê³µêµ¬ ì •ë³´ë„ ì—†ìœ¼ë©´ ì…€ëŸ¬ëª…ìœ¼ë¡œ í‘œì‹œ
          const productName = ss.sellerName || 'ì •ì‚°ê±´';
          if (!salesByProduct[productName]) {
            salesByProduct[productName] = { productName, totalQty: 0, totalAmount: 0 };
          }
          salesByProduct[productName].totalQty += Number(ss.quantity) || 1;
          salesByProduct[productName].totalAmount += Number(ss.salesAmount) || 0;
        }
      }
    });
    
    // 2. supplierSettlementsì—ì„œ ì •ì‚°ì™„ë£Œëœ ë‚´ ë°ì´í„°ë„ í™•ì¸
    (state.supplierSettlements || []).forEach(ss => {
      // ì •ì‚°ì™„ë£Œëœ ê²ƒë§Œ
      if (!ss.isCompleted) return;
      
      // ë‚´ ë¸Œëœë“œ í•„í„°ë§
      const isMyBrand = ss.supplierId === state.currentUser.id ||
        (ss.brandName && state.currentUser.name && ss.brandName.includes(state.currentUser.name));
      if (!isMyBrand) return;
      
      // ì´ë¯¸ sellerSettlementsì—ì„œ ì²˜ë¦¬ëœ dealIdëŠ” ê±´ë„ˆë›°ê¸° (ì¤‘ë³µ ë°©ì§€)
      // supplierSettlementsëŠ” ê³µê¸‰ì‚¬ ì •ì‚° ê¸ˆì•¡ ì •ë³´ë§Œ ìˆìœ¼ë¯€ë¡œ ìƒí’ˆ ì •ë³´ëŠ” sellerSettlementsì—ì„œ ê°€ì ¸ì˜´
    });
    
    const salesBestStats = Object.values(salesByProduct)
      .filter(p => p.totalAmount > 0)
      .sort((a, b) => b.totalAmount - a.totalAmount)
      .slice(0, 5);
    
    // ë°ì´í„° ìœ ë¬´ì™€ ê´€ê³„ì—†ì´ ì¹´ë“œ í‘œì‹œ
    salesBestHtml = `
      <div class="card" style="height: 100%;">
        <h3 class="card-title">ğŸ”¥ íŒë§¤ ë² ìŠ¤íŠ¸ TOP 5</h3>
        <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">ì •ì‚° ì™„ë£Œëœ ìƒí’ˆ ì¤‘ íŒë§¤ì•¡ì´ ë†’ì€ ìˆœì„œì…ë‹ˆë‹¤.</p>
        ${salesBestStats.length === 0 ? `
          <div style="text-align: center; padding: 40px 20px; color: var(--gray-400);">
            <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“Š</div>
            <p style="font-size: 13px;">ì•„ì§ ì •ì‚°ëœ íŒë§¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        ` : salesBestStats.map((p, idx) => `
          <div style="display: flex; align-items: center; padding: 12px 0; ${idx < salesBestStats.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : ''}">
            <div style="width: 28px; height: 28px; background: ${idx === 0 ? 'linear-gradient(135deg, #dc2626, #f97316)' : idx === 1 ? 'linear-gradient(135deg, #ea580c, #f59e0b)' : idx === 2 ? 'linear-gradient(135deg, #f59e0b, #fbbf24)' : 'var(--gray-200)'}; color: ${idx < 3 ? 'white' : 'var(--gray-600)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; margin-right: 12px;">${idx + 1}</div>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--gray-800);">${p.productName}</div>
              <div style="font-size: 12px; color: var(--gray-500);">${p.totalQty}ê°œ íŒë§¤</div>
            </div>
            <div style="font-weight: 700; color: #dc2626; font-size: 14px;">${formatNumber(p.totalAmount)}ì›</div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  // ê³µêµ¬ ì§„í–‰ TOP 5 HTML ìˆ˜ì • (ë°ì´í„° ì—†ì„ ë•Œë„ í‘œì‹œ)
  if (state.userType === 'supplier') {
    topProductsHtml = `
      <div class="card" style="height: 100%;">
        <h3 class="card-title">ğŸ“¦ ê³µêµ¬ ì§„í–‰ TOP 5</h3>
        <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">ê³µêµ¬ì— ë“±ë¡ëœ íšŸìˆ˜ê°€ ë§ì€ ìˆœì„œì…ë‹ˆë‹¤.</p>
        ${productStats.length === 0 ? `
          <div style="text-align: center; padding: 40px 20px; color: var(--gray-400);">
            <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“¦</div>
            <p style="font-size: 13px;">ì•„ì§ ê³µêµ¬ì— ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        ` : productStats.map((p, idx) => `
          <div style="display: flex; align-items: center; padding: 12px 0; ${idx < productStats.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : ''}">
            <div style="width: 28px; height: 28px; background: ${idx === 0 ? 'linear-gradient(135deg, #FFD700, #FFA500)' : idx === 1 ? 'linear-gradient(135deg, #C0C0C0, #A0A0A0)' : idx === 2 ? 'linear-gradient(135deg, #CD7F32, #8B4513)' : 'var(--gray-200)'}; color: ${idx < 3 ? 'white' : 'var(--gray-600)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; margin-right: 12px;">${idx + 1}</div>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--gray-800);">${p.productName}</div>
              <div style="font-size: 12px; color: var(--gray-500);">ê³µê¸‰ê°€: ${formatNumber(p.supplyPrice || 0)}ì›</div>
            </div>
            <div style="background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${p.dealCount}ê±´</div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  container.innerHTML = `
    <h1 class="page-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h1>
    <p class="page-desc">ì•ˆë…•í•˜ì„¸ìš”, ${state.currentUser.name}ë‹˜! ì˜¤ëŠ˜ì˜ í˜„í™©ì…ë‹ˆë‹¤.</p>
    
    <!-- í†µê³„ ì¹´ë“œ - í´ë¦­ ì‹œ í•´ë‹¹ ì„¹ì…˜ìœ¼ë¡œ ì´ë™ -->
    <div class="stats-grid">
      <div class="stat-card highlight" style="cursor: pointer;" onclick="document.getElementById('section-ongoing')?.scrollIntoView({behavior: 'smooth'})">
        <div class="stat-label">ì§„í–‰ì¤‘ì¸ ê³µêµ¬</div>
        <div class="stat-value">${ongoingDeals.length}</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="document.getElementById('section-upcoming')?.scrollIntoView({behavior: 'smooth'})">
        <div class="stat-label">ì˜ˆì •ëœ ê³µêµ¬</div>
        <div class="stat-value">${upcomingDeals.length}</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="document.getElementById('section-completed')?.scrollIntoView({behavior: 'smooth'})">
        <div class="stat-label">ì™„ë£Œëœ ê³µêµ¬</div>
        <div class="stat-value">${completedDeals.length}</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="document.getElementById('section-all')?.scrollIntoView({behavior: 'smooth'})">
        <div class="stat-label">ì „ì²´ ê³µêµ¬</div>
        <div class="stat-value">${myDeals.length}</div>
      </div>
    </div>
    
    <!-- TOP 5 ì„¹ì…˜ (2ì—´) - ê³µê¸‰ì‚¬ë§Œ -->
    ${state.userType === 'supplier' ? `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div>${topProductsHtml}</div>
        <div>${salesBestHtml}</div>
      </div>
    ` : ''}
    
    <!-- ì§„í–‰ì¤‘ì¸ ê³µêµ¬ -->
    <div id="section-ongoing">
      ${ongoingDeals.length > 0 ? `
        <div class="card" style="border-left: 4px solid var(--primary);">
          <h3 class="card-title">ğŸ”¥ ì§„í–‰ì¤‘ì¸ ê³µêµ¬ <span style="color: var(--primary); font-weight: 600;">(${ongoingDeals.length})</span></h3>
          ${ongoingDeals.map(d => renderDealItem(d, 'ongoing')).join('')}
        </div>
      ` : ''}
    </div>
    
    <!-- ì˜ˆì •ëœ ê³µêµ¬ -->
    <div id="section-upcoming">
      ${upcomingDeals.length > 0 ? `
        <div class="card" style="border-left: 4px solid #2563eb;">
          <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleUpcomingDeals()">
            <h3 class="card-title" style="margin: 0;">ğŸ“… ì˜ˆì •ëœ ê³µêµ¬ <span style="color: #2563eb; font-weight: 600;">(${upcomingDeals.length})</span></h3>
            <span id="upcoming-deals-toggle" style="font-size: 20px; color: var(--gray-400);">â–²</span>
          </div>
          <div id="upcoming-deals-content" style="margin-top: 16px;">
            ${upcomingDeals.map(d => renderDealItem(d, 'upcoming')).join('')}
          </div>
        </div>
      ` : ''}
    </div>
    
    <!-- ì™„ë£Œëœ ê³µêµ¬ (ì ‘íŒ ìƒíƒœ) -->
    <div id="section-completed">
      ${completedDeals.length > 0 ? `
        <div class="card" style="border-left: 4px solid #059669;">
          <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleCompletedDeals()">
            <h3 class="card-title" style="margin: 0;">âœ… ì™„ë£Œëœ ê³µêµ¬ <span style="color: #059669; font-weight: 600;">(${completedDeals.length})</span></h3>
            <span id="completed-deals-toggle" style="font-size: 20px; color: var(--gray-400);">â–¼</span>
          </div>
          <div id="completed-deals-content" style="display: none; margin-top: 16px;">
            ${completedDeals.map(d => renderDealItem(d, 'completed')).join('')}
          </div>
        </div>
      ` : ''}
    </div>
    
    <!-- ì „ì²´ ê³µêµ¬ (ì ‘íŒ ìƒíƒœ) -->
    <div id="section-all">
      ${myDeals.length > 0 ? `
        <div class="card" style="border-left: 4px solid var(--gray-400);">
          <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleAllDeals()">
            <h3 class="card-title" style="margin: 0;">ğŸ“‹ ì „ì²´ ê³µêµ¬ <span style="color: var(--gray-500); font-weight: 600;">(${myDeals.length})</span></h3>
            <span id="all-deals-toggle" style="font-size: 20px; color: var(--gray-400);">â–¼</span>
          </div>
          <div id="all-deals-content" style="display: none; margin-top: 16px;">
            ${myDeals.map(d => {
              const today = new Date();
              today.setHours(0, 0, 0, 0);
              const start = new Date(d.startDate);
              const end = new Date(d.endDate);
              let statusType = 'upcoming';
              if (today >= start && today <= end) statusType = 'ongoing';
              else if (today > end) statusType = 'completed';
              return renderDealItem(d, statusType);
            }).join('')}
          </div>
        </div>
      ` : `
        <div class="card">
          <div class="empty-state">
            <div class="icon">ğŸ“¦</div>
            <p>ì•„ì§ ë“±ë¡ëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      `}
    </div>
  `;
}

// ì˜ˆì •ëœ ê³µêµ¬ í† ê¸€
function toggleUpcomingDeals() {
  const content = document.getElementById('upcoming-deals-content');
  const toggle = document.getElementById('upcoming-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = 'â–²';
  } else {
    content.style.display = 'none';
    toggle.textContent = 'â–¼';
  }
}

// ì™„ë£Œëœ ê³µêµ¬ í† ê¸€
function toggleCompletedDeals() {
  const content = document.getElementById('completed-deals-content');
  const toggle = document.getElementById('completed-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = 'â–²';
  } else {
    content.style.display = 'none';
    toggle.textContent = 'â–¼';
  }
}

// ì „ì²´ ê³µêµ¬ í† ê¸€
function toggleAllDeals() {
  const content = document.getElementById('all-deals-content');
  const toggle = document.getElementById('all-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = 'â–²';
  } else {
    content.style.display = 'none';
    toggle.textContent = 'â–¼';
  }
}

function getMyDeals() {
  if (state.userType === 'supplier') {
    return state.deals.filter(d => d.supplierId === state.currentUser.id);
  } else {
    return state.deals.filter(d => d.sellerId === state.currentUser.id);
  }
}

function renderDealItem(deal, status) {
  let statusClass, statusText;
  if (status === 'ongoing') {
    statusClass = 'status-ongoing';
    statusText = 'ì§„í–‰ì¤‘';
  } else if (status === 'completed') {
    statusClass = 'status-completed';
    statusText = 'ì™„ë£Œ';
  } else {
    statusClass = 'status-upcoming';
    statusText = 'D-' + getDday(deal.startDate);
  }
  
  // ê³µê¸‰ì‚¬ì¸ ê²½ìš° ì…€ëŸ¬ ë‹‰ë„¤ì„ë§Œ í‘œì‹œ
  let displayTitle = deal.title;
  if (state.userType === 'supplier') {
    const seller = state.sellers.find(s => s.id === deal.sellerId);
    if (seller && seller.name) {
      const parts = seller.name.split('/');
      if (parts.length > 1) {
        displayTitle = parts[1]; // ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)
      } else {
        displayTitle = seller.name;
      }
    }
  }
  
  return `
    <div class="list-item" onclick="openDealModal('${deal.id}')">
      <div>
        <div class="list-title">${displayTitle}</div>
        <div class="list-meta">${deal.startDate} ~ ${deal.endDate}</div>
      </div>
      <span class="status-badge ${statusClass}">${statusText}</span>
    </div>
  `;
}

function getDday(dateStr) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const target = new Date(dateStr);
  target.setHours(0,0,0,0);
  const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
  return diff;
}

// ===== ìº˜ë¦°ë” =====
let calendarYear, calendarMonth;

function renderCalendar(container) {
  const today = new Date();
  if (!calendarYear) calendarYear = today.getFullYear();
  if (!calendarMonth) calendarMonth = today.getMonth();
  
  const myDeals = getMyDeals();
  const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
  const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
  const prevMonthDays = new Date(calendarYear, calendarMonth, 0).getDate();
  
  let calendarDays = '';
  
  // ì´ì „ ë‹¬
  for (let i = firstDay - 1; i >= 0; i--) {
    calendarDays += `<div class="calendar-day other-month"><div class="day-number">${prevMonthDays - i}</div></div>`;
  }
  
  // í˜„ì¬ ë‹¬
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === formatDate(today);
    const dayOfWeek = new Date(calendarYear, calendarMonth, day).getDay();
    
    const dayDeals = myDeals.filter(d => dateStr >= d.startDate && dateStr <= d.endDate);
    
    let badges = dayDeals.slice(0, 3).map(d => {
      // ê³µê¸‰ì‚¬ì¸ ê²½ìš° ì…€ëŸ¬ ë‹‰ë„¤ì„ë§Œ í‘œì‹œ (ì´ë¦„ ì œì™¸)
      let displayTitle = d.title;
      if (state.userType === 'supplier') {
        const seller = state.sellers.find(s => s.id === d.sellerId);
        if (seller && seller.name) {
          // ì…€ëŸ¬ëª… í˜•ì‹: "ì´ë¦„/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)" -> "ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)"ë§Œ ì¶”ì¶œ
          const parts = seller.name.split('/');
          if (parts.length > 1) {
            displayTitle = parts[1]; // ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜) ë¶€ë¶„ë§Œ
          } else {
            displayTitle = seller.name;
          }
        }
      }
      return `<div class="deal-badge" onclick="event.stopPropagation();openDealModal('${d.id}')">${displayTitle}</div>`;
    }).join('');
    
    if (dayDeals.length > 3) {
      badges += `<div style="font-size:11px;color:var(--gray-500);">+${dayDeals.length - 3}ê°œ</div>`;
    }
    
    calendarDays += `
      <div class="calendar-day ${isToday ? 'today' : ''}">
        <div class="day-number ${dayOfWeek === 0 ? 'sunday' : ''} ${dayOfWeek === 6 ? 'saturday' : ''}">${day}</div>
        ${badges}
      </div>
    `;
  }
  
  // ë‹¤ìŒ ë‹¬
  const totalCells = firstDay + daysInMonth;
  const nextDays = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
  for (let i = 1; i <= nextDays; i++) {
    calendarDays += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
  }
  
  container.innerHTML = `
    <h1 class="page-title">ğŸ“… ë‚´ ì¼ì •</h1>
    <p class="page-desc">ë‚´ ê³µêµ¬ ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš”.</p>
    
    <div class="card">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="changeMonth(-1)">â—€</button>
          <span class="calendar-title">${calendarYear}ë…„ ${calendarMonth + 1}ì›”</span>
          <button onclick="changeMonth(1)">â–¶</button>
        </div>
        <button class="btn btn-secondary" onclick="goToday()">ì˜¤ëŠ˜</button>
      </div>
      
      <div class="calendar-grid">
        <div class="calendar-weekday">ì¼</div>
        <div class="calendar-weekday">ì›”</div>
        <div class="calendar-weekday">í™”</div>
        <div class="calendar-weekday">ìˆ˜</div>
        <div class="calendar-weekday">ëª©</div>
        <div class="calendar-weekday">ê¸ˆ</div>
        <div class="calendar-weekday">í† </div>
        ${calendarDays}
      </div>
    </div>
  `;
}

function changeMonth(delta) {
  calendarMonth += delta;
  if (calendarMonth < 0) {
    calendarMonth = 11;
    calendarYear--;
  } else if (calendarMonth > 11) {
    calendarMonth = 0;
    calendarYear++;
  }
  renderCalendar(document.getElementById('main-content'));
}

function goToday() {
  const today = new Date();
  calendarYear = today.getFullYear();
  calendarMonth = today.getMonth();
  renderCalendar(document.getElementById('main-content'));
}

// ===== ê³µì§€ì‚¬í•­ =====
function renderNotice(container) {
  const notices = state.notices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  container.innerHTML = `
    <h1 class="page-title">ğŸ“¢ ê³µì§€ì‚¬í•­</h1>
    <p class="page-desc">ëª¨ì—¬ë¼ë”œì˜ ìƒˆë¡œìš´ ì†Œì‹ì„ í™•ì¸í•˜ì„¸ìš”.</p>
    
    <div class="card" style="padding: 0; overflow: hidden;">
      ${notices.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ“¢</div>
          <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      ` : notices.map(n => `
        <div class="notice-item" onclick="openNoticeModal('${n.id}')">
          <div>
            <span class="notice-badge ${n.important ? 'important' : 'normal'}">${n.important ? 'ì¤‘ìš”' : 'ì¼ë°˜'}</span>
            <span class="notice-title">${n.title}</span>
          </div>
          <div class="notice-date">${formatDateKR(n.createdAt)}</div>
        </div>
      `).join('')}
    </div>
  `;
}

function openNoticeModal(noticeId) {
  const notice = state.notices.find(n => n.id === noticeId);
  if (!notice) return;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ“¢ ê³µì§€ì‚¬í•­</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <h2 style="margin-bottom: 8px;">${notice.title}</h2>
        <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 20px;">${formatDateKR(notice.createdAt)}</p>
        <div style="white-space: pre-wrap; line-height: 1.8;">${notice.content || 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
      </div>
    </div>
  `;
}

// ===== ì†Œí†µ =====
function renderMessage(container) {
  const myMessages = state.messages
    .filter(m => m.partnerId === state.currentUser.id && m.partnerType === state.userType)
    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
  
  container.innerHTML = `
    <h1 class="page-title">ğŸ’¬ ì†Œí†µ</h1>
    <p class="page-desc">ë‹´ë‹¹ìì™€ 1:1ë¡œ ì†Œí†µí•˜ì„¸ìš”.</p>
    
    <div class="card">
      <div class="message-list" id="message-list">
        ${myMessages.length === 0 ? `
          <div class="empty-state" style="padding: 40px;">
            <div class="icon">ğŸ’¬</div>
            <p>ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•´ë³´ì„¸ìš”!</p>
          </div>
        ` : myMessages.map(m => `
          <div class="message-item ${m.isAdmin ? 'admin' : 'mine'}">
            <div class="message-sender">${m.isAdmin ? 'ëª¨ì—¬ë¼ë”œ ë‹´ë‹¹ì' : 'ë‚˜'}</div>
            <div class="message-content">${m.content}</div>
            <div class="message-time">${formatDateKR(m.createdAt)}</div>
          </div>
        `).join('')}
      </div>
      
      <div class="message-input-area">
        <input type="text" class="form-input" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="btn btn-primary" style="width: auto;" onclick="sendMessage()">ì „ì†¡</button>
      </div>
    </div>
  `;
  
  // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
  setTimeout(() => {
    const list = document.getElementById('message-list');
    if (list) list.scrollTop = list.scrollHeight;
  }, 100);
}

async function sendMessage() {
  const input = document.getElementById('message-input');
  const content = input.value.trim();
  if (!content) return;
  
  try {
    await db.collection('partnerMessages').add({
      partnerId: state.currentUser.id,
      partnerType: state.userType,
      partnerName: state.currentUser.name,
      content: content,
      isAdmin: false,
      createdAt: new Date().toISOString()
    });
    
    input.value = '';
    showToast('ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    console.error(e);
    showToast('ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ===== ìƒí’ˆ ë“±ë¡ (ê³µê¸‰ì‚¬ ì „ìš©) =====
function renderProducts(container) {
  // supplierId ë˜ëŠ” brandNameìœ¼ë¡œ ë§¤ì¹­ (ê´€ë¦¬ì‹œìŠ¤í…œ ì—°ë™)
  const myProducts = state.supplierProducts.filter(p => {
    if (p.supplierId === state.currentUser.id) return true;
    if (p.brandName && state.currentUser.name && 
        p.brandName.includes(state.currentUser.name)) return true;
    return false;
  });
  
  container.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <div>
        <h1 class="page-title">ğŸ“¦ ìƒí’ˆ ë“±ë¡</h1>
        <p class="page-desc">ê³µê¸‰ ìƒí’ˆì„ ë“±ë¡í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.</p>
      </div>
      <div style="display: flex; gap: 8px;">
        <button class="btn btn-secondary" onclick="openExcelUploadModal()">ğŸ“¥ ì—‘ì…€ ì¼ê´„ë“±ë¡</button>
        <button class="btn btn-primary" onclick="openProductModal()">+ ìƒí’ˆ ë“±ë¡</button>
      </div>
    </div>
    
    <div class="card">
      ${myProducts.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ“¦</div>
          <p>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="border-bottom: 2px solid var(--gray-200); background: var(--gray-50);">
                <th style="padding: 12px 8px; text-align: left; font-weight: 600;">ìƒí’ˆëª…</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">ì •ê°€(V+)</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">ê³µêµ¬íŒë§¤ê°€</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">ê³µê¸‰ê°€(V+)</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">ìˆ˜ìˆ˜ë£Œìœ¨</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 600;">ê³µêµ¬ì—°ê²°</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 600; width: 120px;"></th>
              </tr>
            </thead>
            <tbody>
              ${myProducts.map(p => {
                // ì´ ìƒí’ˆì´ ì—°ê²°ëœ ê³µêµ¬ ìˆ˜ (selectedProductsê°€ ê°ì²´ ë°°ì—´ ë˜ëŠ” ë¬¸ìì—´ ë°°ì—´)
                const linkedDeals = state.deals.filter(d => {
                  if (!d.selectedProducts) return false;
                  return d.selectedProducts.some(item => {
                    const pid = typeof item === 'string' ? item : item.productId;
                    return pid === p.id;
                  });
                }).length;
                return `
                <tr style="border-bottom: 1px solid var(--gray-100);">
                  <td style="padding: 12px 8px;"><strong>${p.productName || '-'}</strong></td>
                  <td style="padding: 12px 8px; text-align: right;">${Number(p.originalPrice || 0) > 0 ? formatNumber(p.originalPrice) + 'ì›' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right;">${Number(p.salePrice || 0) > 0 ? formatNumber(p.salePrice) + 'ì›' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right; color: var(--primary); font-weight: 600;">${Number(p.supplyPrice || 0) > 0 ? formatNumber(p.supplyPrice) + 'ì›' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right;">${p.commission ? p.commission + '%' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: center;">
                    ${linkedDeals > 0 ? `<span style="background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${linkedDeals}ê±´</span>` : '<span style="color: var(--gray-400);">-</span>'}
                  </td>
                  <td style="padding: 12px 8px; text-align: center;">
                    <div style="display: flex; gap: 4px; justify-content: center;">
                      <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openProductModal('${p.id}')">ìˆ˜ì •</button>
                      <button class="btn" style="padding: 6px 12px; font-size: 12px; background: #fee2e2; color: #dc2626;" onclick="deleteProduct('${p.id}')">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;}).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

function openProductModal(productId) {
  const product = productId ? state.supplierProducts.find(p => p.id === productId) : null;
  const isEdit = !!product;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">${isEdit ? 'ìƒí’ˆ ìˆ˜ì •' : 'ìƒí’ˆ ë“±ë¡'}</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="saveProduct(event, '${productId || ''}')">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ìƒí’ˆëª… *</label>
            <input type="text" class="form-input" id="prod-name" value="${product?.productName || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">ì •ê°€ (ì›)</label>
            <input type="number" class="form-input" id="prod-original" value="${product?.originalPrice || ''}">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">ê³µê¸‰ê°€ (V+, ì›)</label>
              <input type="number" class="form-input" id="prod-supply" value="${product?.supplyPrice || ''}" oninput="calcCommissionFromSupply()">
              <small style="color: var(--gray-500); font-size: 11px;">ìˆ˜ìˆ˜ë£Œì™€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥</small>
            </div>
            <div class="form-group">
              <label class="form-label">ìˆ˜ìˆ˜ë£Œ (%)</label>
              <input type="number" class="form-input" id="prod-commission" value="${product?.commission || ''}" step="0.1" oninput="calcSupplyFromCommission()">
              <small style="color: var(--gray-500); font-size: 11px;">ê³µê¸‰ê°€ì™€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥</small>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ê³µë™êµ¬ë§¤ íŒë§¤ê°€ (ì›)</label>
            <input type="number" class="form-input" id="prod-sale" value="${product?.salePrice || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">ìƒí’ˆ ì„¤ëª…</label>
            <textarea class="form-textarea" id="prod-desc" rows="3">${product?.description || ''}</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary" style="width: auto;">${isEdit ? 'ìˆ˜ì •' : 'ë“±ë¡'}</button>
        </div>
      </form>
    </div>
  `;
}

// ê³µê¸‰ê°€ â†’ ìˆ˜ìˆ˜ë£Œ ìë™ê³„ì‚°
function calcCommissionFromSupply() {
  const supply = Number(document.getElementById('prod-supply').value);
  const sale = Number(document.getElementById('prod-sale').value);
  if (supply && sale && sale > 0) {
    const commission = ((sale - supply) / sale * 100).toFixed(1);
    document.getElementById('prod-commission').value = commission;
  }
}

// ìˆ˜ìˆ˜ë£Œ â†’ ê³µê¸‰ê°€ ìë™ê³„ì‚°
function calcSupplyFromCommission() {
  const commission = Number(document.getElementById('prod-commission').value);
  const sale = Number(document.getElementById('prod-sale').value);
  if (commission && sale && sale > 0) {
    const supply = Math.round(sale * (1 - commission / 100));
    document.getElementById('prod-supply').value = supply;
  }
}

// ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ ëª¨ë‹¬
function openExcelUploadModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ“¥ ì—‘ì…€ ì¼ê´„ë“±ë¡</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="background: var(--info-light); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="color: var(--info); margin-bottom: 8px;">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì•ˆë‚´</h4>
          <p style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px;">
            ì•„ë˜ ì—´ ìˆœì„œëŒ€ë¡œ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
            <strong>ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ë¡œ ì¸ì‹ë˜ì–´ ì œì™¸ë©ë‹ˆë‹¤.</strong>
          </p>
          <table style="width: 100%; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
              <tr style="background: var(--gray-100);">
                <th style="padding: 8px; text-align: left;">A</th>
                <th style="padding: 8px; text-align: left;">B</th>
                <th style="padding: 8px; text-align: left;">C</th>
                <th style="padding: 8px; text-align: left;">D</th>
                <th style="padding: 8px; text-align: left;">E</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 8px;">ìƒí’ˆëª…*</td>
                <td style="padding: 8px;">ì •ê°€</td>
                <td style="padding: 8px;">ê³µê¸‰ê°€(V+)</td>
                <td style="padding: 8px;">ê³µêµ¬íŒë§¤ê°€</td>
                <td style="padding: 8px;">ìˆ˜ìˆ˜ë£Œ(%)</td>
              </tr>
            </tbody>
          </table>
          <p style="font-size: 11px; color: var(--gray-500); margin-top: 8px;">
            * ê³µê¸‰ê°€ì™€ ìˆ˜ìˆ˜ë£ŒëŠ” ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•˜ë©´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.
          </p>
        </div>
        
        <div style="margin-bottom: 16px;">
          <button class="btn btn-secondary" style="width: 100%;" onclick="downloadExcelTemplate()">
            ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì—‘ì…€ íŒŒì¼ ì„ íƒ</label>
          <input type="file" class="form-input" id="excel-file" accept=".xlsx,.xls,.csv" style="padding: 12px;">
        </div>
        
        <div id="excel-preview" style="display: none; margin-top: 16px;">
          <h4 style="margin-bottom: 12px;">ë¯¸ë¦¬ë³´ê¸°</h4>
          <div id="excel-preview-content" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" style="width: auto;" onclick="uploadExcelProducts()">ì¼ê´„ ë“±ë¡</button>
      </div>
    </div>
  `;
  
  // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
  document.getElementById('excel-file').addEventListener('change', previewExcel);
}

// ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
function downloadExcelTemplate() {
  const csvContent = "ìƒí’ˆëª…,ì •ê°€,ê³µê¸‰ê°€(V+),ê³µêµ¬íŒë§¤ê°€,ìˆ˜ìˆ˜ë£Œ(%)\nì˜ˆì‹œìƒí’ˆ,50000,35000,40000,12.5";
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'ìƒí’ˆë“±ë¡_ì–‘ì‹.csv';
  link.click();
}

// ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸°
async function previewExcel(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const preview = document.getElementById('excel-preview');
  const content = document.getElementById('excel-preview-content');
  
  try {
    const data = await parseExcelFile(file);
    if (data.length === 0) {
      content.innerHTML = '<p style="color: var(--danger);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      preview.style.display = 'block';
      return;
    }
    
    // í—¤ë” ì œì™¸
    const rows = data.slice(1);
    window.excelData = rows;
    
    content.innerHTML = `
      <p style="margin-bottom: 8px; color: var(--success);">âœ“ ${rows.length}ê°œ ìƒí’ˆ í™•ì¸ë¨</p>
      <table class="data-table" style="font-size: 12px;">
        <thead>
          <tr>
            <th>ìƒí’ˆëª…</th>
            <th>ì •ê°€</th>
            <th>ê³µê¸‰ê°€</th>
            <th>íŒë§¤ê°€</th>
            <th>ìˆ˜ìˆ˜ë£Œ</th>
          </tr>
        </thead>
        <tbody>
          ${rows.slice(0, 5).map(row => `
            <tr>
              <td>${row[0] || '-'}</td>
              <td>${row[1] ? formatNumber(row[1]) + 'ì›' : '-'}</td>
              <td>${row[2] ? formatNumber(row[2]) + 'ì›' : '-'}</td>
              <td>${row[3] ? formatNumber(row[3]) + 'ì›' : '-'}</td>
              <td>${row[4] ? row[4] + '%' : '-'}</td>
            </tr>
          `).join('')}
          ${rows.length > 5 ? `<tr><td colspan="5" style="text-align:center; color: var(--gray-500);">... ì™¸ ${rows.length - 5}ê°œ</td></tr>` : ''}
        </tbody>
      </table>
    `;
    preview.style.display = 'block';
  } catch (err) {
    content.innerHTML = `<p style="color: var(--danger);">íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${err.message}</p>`;
    preview.style.display = 'block';
  }
}

// ì—‘ì…€ íŒŒì¼ íŒŒì‹±
function parseExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = e.target.result;
        if (file.name.endsWith('.csv')) {
          // CSV íŒŒì‹±
          const rows = data.split('\n').map(row => row.split(',').map(cell => cell.trim().replace(/^"|"$/g, '')));
          resolve(rows.filter(row => row.some(cell => cell)));
        } else {
          // XLSX íŒŒì‹± (SheetJS ì‚¬ìš©)
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          resolve(rows);
        }
      } catch (err) {
        reject(err);
      }
    };
    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsBinaryString(file);
    }
  });
}

// ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ
async function uploadExcelProducts() {
  if (!window.excelData || window.excelData.length === 0) {
    showToast('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  try {
    const batch = db.batch();
    let count = 0;
    
    for (const row of window.excelData) {
      const productName = row[0];
      if (!productName) continue;
      
      const originalPrice = Number(row[1]) || 0;
      const supplyPrice = Number(row[2]) || 0;
      const salePrice = Number(row[3]) || 0;
      let commission = Number(row[4]) || 0;
      
      // ê³µê¸‰ê°€ë§Œ ìˆê³  ìˆ˜ìˆ˜ë£Œê°€ ì—†ìœ¼ë©´ ìë™ê³„ì‚°
      if (supplyPrice && !commission && salePrice) {
        commission = parseFloat(((salePrice - supplyPrice) / salePrice * 100).toFixed(1));
      }
      
      // ìˆ˜ìˆ˜ë£Œë§Œ ìˆê³  ê³µê¸‰ê°€ê°€ ì—†ìœ¼ë©´ ìë™ê³„ì‚°
      let finalSupplyPrice = supplyPrice;
      if (!supplyPrice && commission && salePrice) {
        finalSupplyPrice = Math.round(salePrice * (1 - commission / 100));
      }
      
      const docRef = db.collection('supplierProducts').doc();
      batch.set(docRef, {
        supplierId: state.currentUser.id,
        brandName: state.currentUser.name,
        productName,
        originalPrice,
        supplyPrice: finalSupplyPrice,
        salePrice,
        commission,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
      count++;
    }
    
    await batch.commit();
    showToast(`${count}ê°œ ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    closeModal();
    window.excelData = null;
  } catch (err) {
    console.error(err);
    showToast('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

async function saveProduct(e, productId) {
  e.preventDefault();
  
  const data = {
    supplierId: state.currentUser.id,
    brandName: state.currentUser.name,
    productName: document.getElementById('prod-name').value,
    originalPrice: Number(document.getElementById('prod-original').value) || 0,
    supplyPrice: Number(document.getElementById('prod-supply').value) || 0,
    salePrice: Number(document.getElementById('prod-sale').value) || 0,
    commission: Number(document.getElementById('prod-commission').value) || 0,
    description: document.getElementById('prod-desc').value,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (productId) {
      await db.collection('supplierProducts').doc(productId).update(data);
      showToast('ìƒí’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('supplierProducts').add(data);
      showToast('ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ìƒí’ˆ ì‚­ì œ
async function deleteProduct(productId) {
  if (!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('supplierProducts').doc(productId).delete();
    showToast('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ===== ì •ì‚°ì„œ (ê³µê¸‰ì‚¬ ì „ìš©) =====
function renderSettlement(container) {
  // ì •ì‚° ê´€ë ¨ ë°ì´í„° (sellerSettlementsì—ì„œ ë‚´ ë¸Œëœë“œ ê²ƒë§Œ + supplierSettlements ë§¤ì¹­)
  const mySettlements = state.settlements.filter(s => s.brandName === state.currentUser.name);
  const supplierSettlements = state.supplierSettlements || [];
  
  // ê° ì •ì‚°ì— ëŒ€í•´ supplierSettlementsì™€ ë§¤ì¹­í•˜ì—¬ ê³µê¸‰ì‚¬ ì •ì‚° ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°
  const enrichedSettlements = mySettlements.map(s => {
    // ë§¤ì¹­ë˜ëŠ” ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸° (ê²½ì˜íŒ€ ì‹œìŠ¤í…œê³¼ ë™ì¼í•œ ë¡œì§)
    const matchingSupplier = supplierSettlements.find(sup => 
      ((sup.sellerName || '').includes(s.sellerName || '') || (s.sellerName || '').includes(sup.sellerName || '')) &&
      ((sup.brandName || '').includes(s.brandName || '') || (s.brandName || '').includes(sup.brandName || ''))
    );
    
    // supplierSettlementsì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜, sellerSettlementsì— ì €ì¥ëœ ê°’ ì‚¬ìš©
    const totalSupplyAmount = matchingSupplier ? Number(matchingSupplier.totalSupplyAmount) || 0 : Number(s.supplyAmount) || 0;
    const totalVatAmount = matchingSupplier ? Number(matchingSupplier.totalVatAmount) || 0 : Number(s.vatAmount) || 0;
    const totalAmount = matchingSupplier ? Number(matchingSupplier.totalAmount) || 0 : Number(s.supplierTotalAmount) || 0;
    
    // products ê°€ì ¸ì˜¤ê¸° (supplierSettlementsì˜ items ë˜ëŠ” sellerSettlementsì˜ salesItems)
    let products = s.products || s.salesItems || [];
    if (products.length === 0 && matchingSupplier && matchingSupplier.items) {
      products = matchingSupplier.items;
    }
    
    return {
      ...s,
      products,
      supplierSupplyAmount: totalSupplyAmount,
      supplierVatAmount: totalVatAmount,
      supplierTotalAmount: totalAmount
    };
  });
  
  // ê³µê¸‰ì‚¬ ì •ì‚° ê¸ˆì•¡ í•©ê³„ ê³„ì‚°
  const totalSupplyAmount = enrichedSettlements.reduce((sum, s) => sum + (s.supplierSupplyAmount || 0), 0);
  const totalVat = enrichedSettlements.reduce((sum, s) => sum + (s.supplierVatAmount || 0), 0);
  const totalFinal = enrichedSettlements.reduce((sum, s) => sum + (s.supplierTotalAmount || 0), 0);
  const totalSales = enrichedSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  
  // í…Œì´ë¸” í–‰ ìƒì„±
  let tableRows = '';
  enrichedSettlements.forEach(s => {
    const products = s.products || [];
    const sellerName = s.sellerName || '-';
    const sellerParts = sellerName.split('/');
    const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
    
    const supplyAmount = s.supplierSupplyAmount || 0;
    const vatAmount = s.supplierVatAmount || 0;
    const finalAmount = s.supplierTotalAmount || 0;
    
    if (products.length === 0) {
      tableRows += '<tr>' +
        '<td style="text-align: center;"><strong>' + sellerDisplay + '</strong></td>' +
        '<td style="text-align: center; font-size: 11px;">' + (s.dealPeriod || '-') + '</td>' +
        '<td style="text-align: center; color: var(--gray-400);">(ìƒí’ˆì •ë³´ì—†ìŒ)</td>' +
        '<td style="text-align: center;">-</td>' +
        '<td style="text-align: center;">' + (s.totalQuantity || '-') + '</td>' +
        '<td style="text-align: right;">' + formatNumber(s.salesAmount || 0) + 'ì›</td>' +
        '<td style="text-align: right; background: #fffbeb;">' + formatNumber(supplyAmount) + 'ì›</td>' +
        '<td style="text-align: right; background: #fffbeb;">' + formatNumber(vatAmount) + 'ì›</td>' +
        '<td style="text-align: right; background: var(--primary-light); font-weight: 700; color: var(--primary);">' + formatNumber(finalAmount) + 'ì›</td>' +
        '<td style="text-align: center;">' + (s.settlementDate || '-') + '</td>' +
        '</tr>';
    } else {
      products.forEach((p, idx) => {
        const isFirst = idx === 0;
        const price = Number(p.salePrice) || Number(p.price) || 0;
        const qty = Number(p.quantity) || 0;
        const amount = price * qty;
        
        tableRows += '<tr>' +
          (isFirst ? '<td rowspan="' + products.length + '" style="text-align: center; vertical-align: middle;"><strong>' + sellerDisplay + '</strong></td>' : '') +
          (isFirst ? '<td rowspan="' + products.length + '" style="text-align: center; vertical-align: middle; font-size: 11px;">' + (s.dealPeriod || '-') + '</td>' : '') +
          '<td style="font-size: 11px;">' + (p.productName || '-') + '</td>' +
          '<td style="text-align: right;">' + formatNumber(price) + 'ì›</td>' +
          '<td style="text-align: center;">' + qty + '</td>' +
          '<td style="text-align: right;">' + formatNumber(amount) + 'ì›</td>' +
          (isFirst ? '<td rowspan="' + products.length + '" style="text-align: right; vertical-align: middle; background: #fffbeb;">' + formatNumber(supplyAmount) + 'ì›</td>' : '') +
          (isFirst ? '<td rowspan="' + products.length + '" style="text-align: right; vertical-align: middle; background: #fffbeb;">' + formatNumber(vatAmount) + 'ì›</td>' : '') +
          (isFirst ? '<td rowspan="' + products.length + '" style="text-align: right; vertical-align: middle; background: var(--primary-light); font-weight: 700; color: var(--primary);">' + formatNumber(finalAmount) + 'ì›</td>' : '') +
          (isFirst ? '<td rowspan="' + products.length + '" style="text-align: center; vertical-align: middle;">' + (s.settlementDate || '-') + '</td>' : '') +
          '</tr>';
      });
    }
  });
  
  container.innerHTML = `
    <h1 class="page-title">ğŸ’° ì •ì‚°ì„œ</h1>
    <p class="page-desc">ì •ì‚° í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”.</p>
    
    <div class="settlement-summary">
      <div class="settlement-item">
        <div class="settlement-label">ì •ì‚° ê±´ìˆ˜</div>
        <div class="settlement-value">${enrichedSettlements.length}ê±´</div>
      </div>
      <div class="settlement-item">
        <div class="settlement-label">ì´ ì •ì‚°ê¸ˆì•¡ (V+)</div>
        <div class="settlement-value" style="color: var(--primary);">${formatNumber(totalFinal)}ì›</div>
      </div>
    </div>
    
    <div class="card">
      <h3 class="card-title">ğŸ“‹ ì •ì‚° ë‚´ì—­</h3>
      ${enrichedSettlements.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ’°</div>
          <p>ì•„ì§ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table" style="font-size: 12px;">
            <thead>
              <tr style="background: linear-gradient(90deg, #fff8f0 0%, #fef9c3 100%);">
                <th style="text-align: center; white-space: nowrap;">ì…€ëŸ¬</th>
                <th style="text-align: center; white-space: nowrap;">ê³µêµ¬ê¸°ê°„</th>
                <th style="text-align: center; white-space: nowrap;">íŒë§¤ìƒí’ˆ</th>
                <th style="text-align: center; white-space: nowrap;">ë‹¨ê°€</th>
                <th style="text-align: center; white-space: nowrap;">ìˆ˜ëŸ‰</th>
                <th style="text-align: center; white-space: nowrap;">íŒë§¤ê¸ˆì•¡</th>
                <th style="text-align: center; white-space: nowrap; background: #fef9c3;">ê³µê¸‰ê°€ì•¡</th>
                <th style="text-align: center; white-space: nowrap; background: #fef9c3;">ë¶€ê°€ì„¸(10%)</th>
                <th style="text-align: center; white-space: nowrap; background: var(--primary-light); font-weight: 700;">ì •ì‚°ê¸ˆì•¡(V+)</th>
                <th style="text-align: center; white-space: nowrap;">ì •ì‚°ì¼</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
            <tfoot>
              <tr style="background: var(--gray-100); font-weight: 700;">
                <td colspan="5" style="text-align: center;">í•©ê³„</td>
                <td style="text-align: right;">${formatNumber(totalSales)}ì›</td>
                <td style="text-align: right; background: #fef9c3;">${formatNumber(totalSupplyAmount)}ì›</td>
                <td style="text-align: right; background: #fef9c3;">${formatNumber(totalVat)}ì›</td>
                <td style="text-align: right; background: var(--primary-light); color: var(--primary);">${formatNumber(totalFinal)}ì›</td>
                <td>-</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
          ğŸ’¡ <span style="color: var(--primary);">ë…¸ë€ìƒ‰ ì˜ì—­</span>: ê³µê¸‰ì‚¬ ì •ì‚° í•­ëª©
        </div>
      `}
    </div>
  `;
}

// ===== ê³µêµ¬ ì œì•ˆ (ì…€ëŸ¬ ì „ìš©) =====
function renderSuggest(container) {
  const mySuggestions = state.suggestions?.filter(s => s.sellerId === state.currentUser.id) || [];
  
  container.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <div>
        <h1 class="page-title">ğŸ’¡ ê³µêµ¬ ì œì•ˆ</h1>
        <p class="page-desc">ìƒˆë¡œìš´ ê³µêµ¬ ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”!</p>
      </div>
      <button class="btn btn-primary" onclick="openSuggestModal()">+ ì œì•ˆí•˜ê¸°</button>
    </div>
    
    <div class="card">
      ${mySuggestions.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ’¡</div>
          <p>ì•„ì§ ì œì•ˆí•œ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•´ë³´ì„¸ìš”!</p>
        </div>
      ` : mySuggestions.map(s => `
        <div class="list-item">
          <div>
            <div class="list-title">${s.title}</div>
            <div class="list-meta">${formatDateKR(s.createdAt)}</div>
          </div>
          <span class="status-badge ${s.status === 'approved' ? 'status-ongoing' : s.status === 'rejected' ? 'status-completed' : 'status-upcoming'}">
            ${s.status === 'approved' ? 'ìŠ¹ì¸' : s.status === 'rejected' ? 'ë°˜ë ¤' : 'ê²€í† ì¤‘'}
          </span>
        </div>
      `).join('')}
    </div>
  `;
}

function openSuggestModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ’¡ ê³µêµ¬ ì œì•ˆ</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="saveSuggestion(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ì œì•ˆ ì œëª© *</label>
            <input type="text" class="form-input" id="sug-title" placeholder="ì˜ˆ: OOë¸Œëœë“œ ì‹ ì œí’ˆ ê³µêµ¬ ì œì•ˆ" required>
          </div>
          <div class="form-group">
            <label class="form-label">ë¸Œëœë“œ/ìƒí’ˆëª…</label>
            <input type="text" class="form-input" id="sug-brand" placeholder="ë¸Œëœë“œ ë˜ëŠ” ìƒí’ˆëª…">
          </div>
          <div class="form-group">
            <label class="form-label">ì˜ˆìƒ íŒë§¤ê°€</label>
            <input type="text" class="form-input" id="sug-price" placeholder="ì˜ˆ: 30,000ì›">
          </div>
          <div class="form-group">
            <label class="form-label">ì œì•ˆ ë‚´ìš© *</label>
            <textarea class="form-textarea" id="sug-content" rows="5" placeholder="ê³µêµ¬ ì œì•ˆ ì´ìœ , ì˜ˆìƒ ë°˜ì‘ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">ì°¸ê³  ë§í¬</label>
            <input type="text" class="form-input" id="sug-link" placeholder="ìƒí’ˆ ë§í¬ ë˜ëŠ” ì°¸ê³  URL">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary" style="width: auto;">ì œì•ˆí•˜ê¸°</button>
        </div>
      </form>
    </div>
  `;
}

async function saveSuggestion(e) {
  e.preventDefault();
  
  try {
    await db.collection('dealSuggestions').add({
      sellerId: state.currentUser.id,
      sellerName: state.currentUser.name,
      title: document.getElementById('sug-title').value,
      brand: document.getElementById('sug-brand').value,
      price: document.getElementById('sug-price').value,
      content: document.getElementById('sug-content').value,
      link: document.getElementById('sug-link').value,
      status: 'pending',
      createdAt: new Date().toISOString()
    });
    
    showToast('ì œì•ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    renderPage('suggest');
  } catch (e) {
    console.error(e);
    showToast('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ===== ê³µêµ¬ ìƒì„¸ ëª¨ë‹¬ =====
function openDealModal(dealId) {
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;
  
  const supplier = state.suppliers.find(s => s.id === deal.supplierId);
  const seller = state.sellers.find(s => s.id === deal.sellerId);
  
  // ìƒí’ˆ ì •ë³´
  const products = (deal.selectedProducts || []).map(item => {
    const pid = typeof item === 'string' ? item : item.productId;
    const product = state.supplierProducts.find(p => p.id === pid);
    return product ? {
      ...product,
      marginRate: typeof item === 'object' ? item.marginRate : 0
    } : null;
  }).filter(Boolean);
  
  const today = new Date();
  const start = new Date(deal.startDate);
  const end = new Date(deal.endDate);
  let statusText = 'ì˜ˆì •';
  let statusClass = 'status-upcoming';
  
  if (today >= start && today <= end) {
    statusText = 'ì§„í–‰ì¤‘';
    statusClass = 'status-ongoing';
  } else if (today > end) {
    statusText = 'ì™„ë£Œ';
    statusClass = 'status-completed';
  }
  
  // ê³µê¸‰ì‚¬ìš©: ì…€ëŸ¬ ë‹‰ë„¤ì„ë§Œ í‘œì‹œ
  let displayTitle = deal.title;
  let sellerDisplayName = '';
  if (state.userType === 'supplier' && seller && seller.name) {
    const parts = seller.name.split('/');
    if (parts.length > 1) {
      sellerDisplayName = parts[1]; // ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)
      displayTitle = parts[1];
    } else {
      sellerDisplayName = seller.name;
      displayTitle = seller.name;
    }
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  // ê³µê¸‰ì‚¬ìš© ëª¨ë‹¬
  if (state.userType === 'supplier') {
    m.innerHTML = `
      <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
          <h3 class="modal-title">ğŸ“… ê³µêµ¬ ìƒì„¸</h3>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 8px;">${displayTitle}</h2>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          <div style="background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ğŸ“… ê¸°ê°„</span>
                <span style="font-weight: 600;">${deal.startDate} ~ ${deal.endDate}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ğŸ‘¤ ì…€ëŸ¬</span>
                <span style="font-weight: 600;">${sellerDisplayName}</span>
              </div>
            </div>
          </div>
          
          <!-- ìƒ˜í”Œ ë°°ì†¡ ì •ë³´ (ê³ ì •) -->
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px;">ğŸ“¦ ìƒ˜í”Œ ë°°ì†¡ ì •ë³´</h4>
            <div style="padding: 16px; background: var(--info-light); border-radius: 12px;">
              <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">ë°›ëŠ”ì´</span>
                  <span style="font-weight: 600;">ëª¨ì—¬ë¼ë”œ</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">ì—°ë½ì²˜</span>
                  <span style="font-weight: 600;">010-4320-4179</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <span style="color: var(--gray-500);">ì£¼ì†Œ</span>
                  <span style="font-weight: 600; text-align: right; max-width: 220px;">${seller?.address || '-'}</span>
                </div>
                ${seller?.accountLink ? `
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <span style="color: var(--gray-500);">ê³„ì •</span>
                    <a href="${seller.accountLink.startsWith('http') ? seller.accountLink : 'https://' + seller.accountLink}" target="_blank" style="color: var(--info); font-weight: 500; text-align: right; max-width: 220px; word-break: break-all;">${seller.accountLink}</a>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
          
          <!-- ìƒ˜í”Œ ì „ë‹¬ ìƒíƒœ -->
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px;">ğŸ“‹ ìƒ˜í”Œ ì „ë‹¬</h4>
            <div style="padding: 16px; background: ${deal.journeySample ? 'var(--success-light)' : 'var(--gray-50)'}; border-radius: 12px; border: 2px solid ${deal.journeySample ? 'var(--success)' : 'var(--gray-200)'};">
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <input type="checkbox" ${deal.journeySample ? 'checked' : ''} onchange="toggleSampleDelivery('${deal.id}', this.checked)" style="width: 20px; height: 20px; accent-color: var(--success);">
                <div>
                  <div style="font-weight: 600; color: ${deal.journeySample ? 'var(--success)' : 'var(--gray-700)'};">
                    ${deal.journeySample ? 'âœ“ ìƒ˜í”Œ ì „ë‹¬ ì™„ë£Œ' : 'ìƒ˜í”Œ ì „ë‹¬ ëŒ€ê¸°ì¤‘'}
                  </div>
                  <div style="font-size: 12px; color: var(--gray-500);">ìƒ˜í”Œì„ ì „ë‹¬í–ˆë‹¤ë©´ ì²´í¬í•´ì£¼ì„¸ìš”</div>
                </div>
              </label>
            </div>
          </div>
          
          ${products.length > 0 ? `
            <div style="margin-bottom: 16px;">
              <h4 style="margin-bottom: 12px;">ğŸ›’ ê³µêµ¬ ìƒí’ˆ</h4>
              ${products.map(p => `
                <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
                  <div style="font-weight: 600;">${p.productName}</div>
                  ${p.marginRate ? `<div style="font-size: 13px; color: var(--primary);">ë§ˆì§„ìœ¨: ${p.marginRate}%</div>` : ''}
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          ${deal.notes ? `
            <div style="padding: 16px; background: var(--warning-light); border-radius: 12px;">
              <h4 style="margin-bottom: 8px; color: var(--warning);">ğŸ“ ë©”ëª¨</h4>
              <p style="font-size: 14px;">${deal.notes}</p>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  } else {
    // ì…€ëŸ¬ìš© ëª¨ë‹¬
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">ğŸ“… ê³µêµ¬ ìƒì„¸</h3>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 8px;">${deal.title}</h2>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          <div style="background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ğŸ“… ê¸°ê°„</span>
                <span style="font-weight: 600;">${deal.startDate} ~ ${deal.endDate}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ğŸ­ ê³µê¸‰ì‚¬</span>
                <span style="font-weight: 600;">${supplier?.name || '-'}</span>
              </div>
            </div>
          </div>
          
          ${products.length > 0 ? `
            <div style="margin-bottom: 16px;">
              <h4 style="margin-bottom: 12px;">ğŸ“¦ ê³µêµ¬ ìƒí’ˆ</h4>
              ${products.map(p => `
                <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
                  <div style="font-weight: 600;">${p.productName}</div>
                  ${p.marginRate ? `<div style="font-size: 13px; color: var(--primary);">ë§ˆì§„ìœ¨: ${p.marginRate}%</div>` : ''}
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          ${deal.notes ? `
            <div style="padding: 16px; background: var(--info-light); border-radius: 12px;">
              <h4 style="margin-bottom: 8px; color: var(--info);">ğŸ“ ë©”ëª¨</h4>
              <p style="font-size: 14px;">${deal.notes}</p>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }
}

// ìƒ˜í”Œ ì „ë‹¬ í† ê¸€ (ê³µê¸‰ì‚¬ìš©)
async function toggleSampleDelivery(dealId, checked) {
  try {
    await db.collection('deals').doc(dealId).update({
      journeySample: checked
    });
    showToast(checked ? 'ìƒ˜í”Œ ì „ë‹¬ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒ˜í”Œ ì „ë‹¬ ìƒíƒœê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ===== ë°ì´í„° ë¡œë“œ =====
function loadData() {
  // ê³µê¸‰ì‚¬
  db.collection('suppliers').onSnapshot(snapshot => {
    state.suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }, error => {
    console.error('ê³µê¸‰ì‚¬ ë¡œë“œ ì˜¤ë¥˜:', error);
  });
  
  // ì…€ëŸ¬
  db.collection('sellers').onSnapshot(snapshot => {
    state.sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }, error => {
    console.error('ì…€ëŸ¬ ë¡œë“œ ì˜¤ë¥˜:', error);
  });
  
  // ê³µêµ¬
  db.collection('deals').onSnapshot(snapshot => {
    state.deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'dashboard') {
      renderPage('dashboard');
    }
  });
  
  // ìƒí’ˆ
  db.collection('supplierProducts').onSnapshot(snapshot => {
    state.supplierProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'products') {
      renderPage('products');
    }
  });
  
  // ê³µì§€ì‚¬í•­
  db.collection('partnerNotices').onSnapshot(snapshot => {
    state.notices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'notice') {
      renderPage('notice');
    }
  });
  
  // ë©”ì‹œì§€
  db.collection('partnerMessages').onSnapshot(snapshot => {
    state.messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'message') {
      renderPage('message');
    }
  });
  
  // ì •ì‚° (sellerSettlements)
  db.collection('sellerSettlements').onSnapshot(snapshot => {
    state.settlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'settlement') {
      renderPage('settlement');
    }
  });
  
  // ê³µê¸‰ì‚¬ ì •ì‚° (supplierSettlements)
  db.collection('supplierSettlements').onSnapshot(snapshot => {
    state.supplierSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'settlement') {
      renderPage('settlement');
    }
  });
  
  // ì œì•ˆ
  db.collection('dealSuggestions').onSnapshot(snapshot => {
    state.suggestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'suggest') {
      renderPage('suggest');
    }
  });
}

// ì´ˆê¸°í™”
loadData();

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì•„ì´ë”” ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', function() {
  loadSavedLoginId();
});
</script>

<!-- ì¹´ì¹´ì˜¤í†¡ í€µë°°ë„ˆ -->
<a href="http://pf.kakao.com/_xoxnJHn/chat" target="_blank" id="kakao-quick-banner" style="
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 60px;
  height: 60px;
  background: #FEE500;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 9999;
  text-decoration: none;
  transition: all 0.2s ease;
" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
  <svg width="32" height="32" viewBox="0 0 256 256">
    <path fill="#3C1E1E" d="M128 36C70.562 36 24 72.713 24 118c0 29.279 19.466 54.97 48.748 69.477-1.593 5.494-10.237 35.344-10.581 37.689 0 0-.207 1.762.934 2.434s2.483.15 2.483.15c3.272-.457 37.943-24.811 43.944-29.09 5.995.849 12.168 1.34 18.472 1.34 57.438 0 104-36.712 104-82 0-45.287-46.562-82-104-82z"/>
  </svg>
</a>

<!-- í€µë°°ë„ˆ íˆ´íŒ -->
<div id="kakao-tooltip" style="
  position: fixed;
  bottom: 92px;
  right: 24px;
  background: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 13px;
  z-index: 9998;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
">
  ğŸ’¬ ë¬¸ì˜í•˜ê¸°
  <div style="
    position: absolute;
    bottom: -6px;
    right: 24px;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid #333;
  "></div>
</div>

<script>
// 3ì´ˆ í›„ íˆ´íŒ ìˆ¨ê¹€
setTimeout(() => {
  const tooltip = document.getElementById('kakao-tooltip');
  if (tooltip) tooltip.style.display = 'none';
}, 5000);
</script>
</body>
</html>

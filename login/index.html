<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>모여라딜 파트너 포털</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    /* =============================================
       모여라딜 파트너포털 - 디자인 시스템 v2
       이미지 레퍼런스 기반 색상 톤 적용
       ============================================= */
    :root {
      /* Primary - 모여라딜 주황 */
      --primary: #F5A623;
      --primary-hover: #E8941B;
      --primary-light: #FEF7ED;
      --primary-lighter: #FFFBF5;
      
      /* Neutral */
      --white: #ffffff;
      --black: #1A1A1A;
      --gray-900: #222222;
      --gray-800: #333333;
      --gray-700: #555555;
      --gray-600: #666666;
      --gray-500: #888888;
      --gray-400: #AAAAAA;
      --gray-300: #CCCCCC;
      --gray-200: #E5E5E5;
      --gray-100: #F5F5F5;
      --gray-50: #FAFAFA;
      
      /* Semantic */
      --success: #34C759;
      --success-light: #E8F8ED;
      --danger: #FF3B30;
      --danger-light: #FFEEEE;
      --info: #007AFF;
      --info-light: #EEF6FF;
      --warning: #FF9500;
      --warning-light: #FFF8E6;
      
      /* Background */
      --bg-main: #FEF7ED;
      --bg-card: #FFFFFF;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      min-height: 100vh; 
      background: var(--bg-main);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    
    /* ===== 로그인 페이지 ===== */
    .login-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--bg-main);
      position: relative;
      overflow: hidden;
    }
    
    /* 물결 배경 애니메이션 */
    .login-bg-wave {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
      pointer-events: none;
    }
    
    .login-bg-wave::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      top: -50%;
      left: -50%;
      background: 
        radial-gradient(ellipse at 30% 20%, rgba(252, 150, 0, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(252, 150, 0, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 30%, rgba(255, 179, 71, 0.1) 0%, transparent 40%);
      animation: bgWave 15s ease-in-out infinite;
    }
    
    @keyframes bgWave {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(2%, -2%) rotate(1deg); }
      50% { transform: translate(0, -3%) rotate(0deg); }
      75% { transform: translate(-2%, -1%) rotate(-1deg); }
    }
    
    /* 떠다니는 원형 파티클들 */
    .login-particle {
      position: absolute;
      border-radius: 50%;
      opacity: 0;
      animation: particleFloat 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    
    .login-particle:nth-child(1) {
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(252, 150, 0, 0.12) 0%, transparent 70%);
      top: -80px;
      right: -80px;
      animation-delay: 0s;
    }
    
    .login-particle:nth-child(2) {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(252, 150, 0, 0.08) 0%, transparent 70%);
      bottom: -120px;
      left: -120px;
      animation-delay: -5s;
    }
    
    .login-particle:nth-child(3) {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 179, 71, 0.15) 0%, transparent 70%);
      top: 30%;
      right: 5%;
      animation-delay: -10s;
    }
    
    .login-particle:nth-child(4) {
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(252, 150, 0, 0.1) 0%, transparent 70%);
      bottom: 20%;
      left: 10%;
      animation-delay: -7s;
    }
    
    .login-particle:nth-child(5) {
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255, 179, 71, 0.12) 0%, transparent 70%);
      top: 60%;
      right: 20%;
      animation-delay: -3s;
    }
    
    @keyframes particleFloat {
      0% {
        opacity: 0;
        transform: translateY(30px) scale(0.8);
      }
      10% {
        opacity: 1;
      }
      50% {
        transform: translateY(-20px) scale(1.1);
      }
      90% {
        opacity: 1;
      }
      100% {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
    }
    
    /* 그라디언트 흐름 효과 */
    .login-gradient-flow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        45deg,
        transparent 0%,
        rgba(252, 150, 0, 0.03) 25%,
        transparent 50%,
        rgba(255, 179, 71, 0.03) 75%,
        transparent 100%
      );
      background-size: 400% 400%;
      animation: gradientFlow 12s ease infinite;
      z-index: 0;
      pointer-events: none;
    }
    
    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* 진입 애니메이션 */
    @keyframes slideUpFadeIn {
      0% {
        opacity: 0;
        transform: translateY(30px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes scaleIn {
      0% {
        opacity: 0;
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .login-container {
      width: 100%;
      max-width: 400px;
      position: relative;
      z-index: 10;
    }
    
    .logo-section {
      text-align: center;
      margin-bottom: 32px;
      animation: slideUpFadeIn 0.6s ease-out;
    }
    
    .logo-img {
      height: 52px;
      margin-bottom: 8px;
      filter: drop-shadow(0 2px 8px rgba(252, 150, 0, 0.2));
    }
    
    .logo-desc {
      font-size: 15px;
      color: var(--gray-500);
      margin-top: 8px;
      font-weight: 500;
      letter-spacing: -0.3px;
    }
    
    .login-card {
      background: linear-gradient(145deg, #ffffff, #fefefe);
      border-radius: 24px;
      padding: 36px;
      box-shadow: 
        0 20px 60px rgba(252, 150, 0, 0.12),
        0 8px 24px rgba(0,0,0,0.06),
        inset 0 1px 1px rgba(255,255,255,0.9);
      border: 1px solid rgba(252, 150, 0, 0.1);
      animation: scaleIn 0.5s ease-out 0.2s both;
      position: relative;
      z-index: 10;
    }
    
    .tab-buttons {
      display: flex;
      gap: 4px;
      margin-bottom: 28px;
      background: linear-gradient(145deg, #f5f5f5, #eeeeee);
      padding: 5px;
      border-radius: 14px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.04);
      position: relative;
      z-index: 20;
    }
    
    .tab-btn {
      flex: 1;
      padding: 14px;
      border: none;
      background: transparent;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      z-index: 20;
      font-family: inherit;
    }
    
    .tab-btn:hover {
      color: var(--gray-700);
    }
    
    .tab-btn.active {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      color: var(--gray-900);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.08),
        0 2px 4px rgba(0,0,0,0.04);
    }
    
    .tab-btn.supplier.active { 
      color: #2563eb;
      background: linear-gradient(145deg, #eff6ff, #dbeafe);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }
    .tab-btn.seller.active { 
      color: var(--primary);
      background: linear-gradient(145deg, #fff8f0, #ffedd5);
      box-shadow: 0 4px 12px rgba(252, 150, 0, 0.2);
    }
    
    .form-group { 
      margin-bottom: 20px;
      animation: fadeInUp 0.4s ease-out both;
    }
    
    .form-group:nth-child(1) { animation-delay: 0.3s; }
    .form-group:nth-child(2) { animation-delay: 0.4s; }
    .form-group:nth-child(3) { animation-delay: 0.5s; }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 8px;
      letter-spacing: -0.2px;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 16px 18px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
      background: linear-gradient(145deg, #fafafa, #f5f5f5);
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--white);
      box-shadow: 
        0 0 0 4px rgba(252, 150, 0, 0.1),
        0 4px 12px rgba(252, 150, 0, 0.08);
    }
    
    .form-input::placeholder { color: var(--gray-400); }
    
    /* 로그인 화면 카카오 문의 버튼 */
    .login-kakao-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 54px;
      height: 54px;
      background: var(--primary);
      border: none;
      border-radius: 50%;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 2px rgba(255,255,255,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      z-index: 1000;
      animation: scaleIn 0.5s ease-out 0.8s both;
    }
    
    .login-kakao-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 10px 24px rgba(252, 150, 0, 0.4),
        0 5px 10px rgba(252, 150, 0, 0.3);
    }
    
    .login-kakao-btn span {
      font-size: 11px;
      font-weight: 700;
      color: white;
      text-shadow: 0 1px 1px rgba(0,0,0,0.15);
    }
    
    .footer-text {
      text-align: center;
      margin-top: 24px;
      font-size: 12px;
      color: var(--gray-400);
      animation: fadeInUp 0.4s ease-out 0.7s both;
    }
    
    .help-text {
      text-align: center;
      margin-top: 20px;
      font-size: 13px;
      color: var(--gray-500);
    }
    
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: var(--white);
      width: 100%;
      box-shadow: 
        0 4px 12px rgba(252, 150, 0, 0.3),
        0 2px 4px rgba(252, 150, 0, 0.2),
        inset 0 1px 1px rgba(255,255,255,0.2);
    }
    
    .btn-primary:hover { 
      background: linear-gradient(145deg, #ffb347, #fc9600);
      transform: translateY(-1px);
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.4),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 1px rgba(255,255,255,0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 
        0 2px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .btn-supplier {
      background: linear-gradient(145deg, #3b82f6, #2563eb);
      color: var(--white);
      width: 100%;
      box-shadow: 
        0 4px 12px rgba(59, 130, 246, 0.3),
        0 2px 4px rgba(59, 130, 246, 0.2);
    }
    
    .btn-supplier:hover { 
      background: linear-gradient(145deg, #60a5fa, #3b82f6);
      transform: translateY(-1px);
    }
    
    .btn-seller {
      background: var(--primary);
      color: var(--white);
      width: 100%;
    }
    
    .btn-secondary {
      background: linear-gradient(145deg, #f9fafb, #f3f4f6);
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    
    .btn-secondary:hover { 
      background: linear-gradient(145deg, #ffffff, #f9fafb);
      border-color: var(--gray-300);
    }
    
    /* 액션 버튼 - 3D 스타일 */
    .action-btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 
        0 4px 12px rgba(252, 150, 0, 0.35),
        0 2px 4px rgba(252, 150, 0, 0.2),
        inset 0 1px 1px rgba(255,255,255,0.25);
      transition: all 0.2s ease;
    }
    
    .action-btn-primary:hover {
      background: linear-gradient(145deg, #ffb347, #fc9600);
      transform: translateY(-2px);
      box-shadow: 
        0 6px 20px rgba(252, 150, 0, 0.4),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 1px rgba(255,255,255,0.3);
    }
    
    .action-btn-primary:active {
      transform: translateY(0);
      box-shadow: 
        0 2px 8px rgba(252, 150, 0, 0.3),
        inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .action-btn-secondary {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 
        0 2px 6px rgba(0,0,0,0.04),
        inset 0 1px 1px rgba(255,255,255,0.8);
      transition: all 0.2s ease;
    }
    
    .action-btn-secondary:hover {
      background: linear-gradient(145deg, #fff8f0, #ffedd5);
      border-color: rgba(252, 150, 0, 0.3);
      color: #ea580c;
      transform: translateY(-1px);
      box-shadow: 
        0 4px 12px rgba(252, 150, 0, 0.1),
        inset 0 1px 1px rgba(255,255,255,0.9);
    }
    
    .action-btn-secondary:active {
      transform: translateY(0);
      box-shadow: 
        0 1px 3px rgba(0,0,0,0.06),
        inset 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .btn.loading {
      position: relative;
      color: transparent;
      pointer-events: none;
    }
    
    .btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .input-icon {
      position: relative;
    }
    
    .input-icon .icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }
    
    .input-icon .form-input {
      padding-left: 48px;
    }
    
    .error-message {
      background: var(--danger-light);
      border: 1px solid #fecaca;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }
    
    .error-message.show { display: block; }
    
    .help-text {
      text-align: center;
      margin-top: 24px;
      font-size: 13px;
      color: var(--gray-500);
    }
    
    .footer-text {
      margin-top: 40px;
      text-align: center;
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* ===== 포털 레이아웃 ===== */
    .portal-page {
      display: none;
    }
    
    .portal-page.active {
      display: block;
    }
    
    /* 헤더 - 모여라딜 스타일 */
    .portal-header {
      background: var(--bg-main);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .portal-header-inner {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .portal-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .portal-logo img {
      height: 28px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .user-badge.supplier {
      background: var(--info-light);
      color: var(--info);
    }
    
    .user-badge.seller {
      background: var(--primary-light);
      color: var(--primary-hover);
    }
    
    .logout-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      color: var(--gray-600);
      cursor: pointer;
      font-family: inherit;
      transition: color 0.2s;
    }
    
    .logout-btn:hover {
      color: var(--primary);
    }
    
    /* 네비게이션 - 심플하게 */
    .portal-nav {
      background: var(--bg-main);
      overflow-x: auto;
      padding-bottom: 8px;
    }
    
    .portal-nav-inner {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      gap: 8px;
      padding: 0 24px;
    }
    
    .nav-item {
      padding: 10px 18px;
      border: none;
      background: transparent;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .nav-item:hover {
      color: var(--primary);
    }
    
    .nav-item.active {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    
    /* 메인 콘텐츠 */
    .portal-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px 24px 40px;
    }
    
    .page-title {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--gray-900);
    }
    
    .page-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 24px;
    }
    
    /* 카드 - 부드러운 그림자 */
    .card {
      background: var(--white);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
      border: none;
      transition: box-shadow 0.2s ease;
    }
    
    .card:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    
    .card-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--gray-900);
    }
    
    /* 대시보드 통계 - 모여라딜 스타일 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
      transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    .stat-card.highlight {
      background: var(--primary);
      color: var(--white);
    }
    
    .stat-card.highlight .stat-value,
    .stat-card.highlight .stat-label {
      color: var(--white);
    }
    
    /* 리스트 */
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    .list-item:hover {
      background: var(--gray-50);
    }
    
    .list-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .list-meta {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* 상태 뱃지 */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-ongoing {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .status-upcoming {
      background: var(--info-light);
      color: var(--info);
    }
    
    .status-completed {
      background: var(--gray-100);
      color: var(--gray-600);
    }
    
    /* 캘린더 */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .calendar-nav button {
      width: 36px;
      height: 36px;
      border: 1px solid var(--gray-200);
      background: var(--white);
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .calendar-nav button:hover {
      background: var(--gray-50);
    }
    
    .calendar-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .calendar-weekday {
      background: var(--gray-50);
      padding: 12px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
    }
    
    .calendar-weekday:first-child {
      color: var(--danger);
    }
    
    .calendar-weekday:last-child {
      color: var(--info);
    }
    
    .calendar-day {
      background: var(--white);
      min-height: 100px;
      padding: 8px;
    }
    
    .calendar-day.other-month {
      background: var(--gray-50);
    }
    
    .calendar-day.other-month .day-number {
      color: var(--gray-400);
    }
    
    .calendar-day.today {
      background: var(--primary-light);
    }
    
    .day-number {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .day-number.sunday { color: var(--danger); }
    .day-number.saturday { color: var(--info); }
    
    .deal-badge {
      display: block;
      padding: 4px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      background: var(--primary);
      color: var(--white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    
    .deal-badge:hover {
      filter: brightness(0.95);
    }
    
    /* 공지사항 */
    .notice-item {
      padding: 20px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
    }
    
    .notice-item:hover {
      background: var(--gray-50);
    }
    
    .notice-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .notice-badge.important {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .notice-badge.normal {
      background: var(--gray-100);
      color: var(--gray-600);
    }
    
    .notice-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .notice-date {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* 소통/메시지 */
    .message-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .message-item {
      padding: 16px;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .message-item:last-child {
      border-bottom: none;
    }
    
    .message-item.mine {
      background: var(--primary-light);
    }
    
    .message-item.admin {
      background: var(--info-light);
    }
    
    .message-sender {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .message-item.mine .message-sender {
      color: #E8941B;
    }
    
    .message-item.admin .message-sender {
      color: var(--info);
    }
    
    .message-content {
      font-size: 14px;
      line-height: 1.6;
    }
    
    .message-time {
      font-size: 11px;
      color: var(--gray-400);
      margin-top: 4px;
    }
    
    .message-input-area {
      display: flex;
      gap: 12px;
    }
    
    .message-input-area .form-input {
      flex: 1;
    }
    
    /* 상품 등록 (공급사) */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    
    .product-card {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 16px;
    }
    
    .product-name {
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .product-info {
      font-size: 13px;
      color: var(--gray-600);
    }
    
    /* 정산서 */
    .settlement-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      padding: 20px;
      background: var(--gray-50);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .settlement-item {
      text-align: center;
    }
    
    .settlement-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }
    
    .settlement-value {
      font-size: 20px;
      font-weight: 700;
    }
    
    /* 테이블 */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .data-table th {
      background: var(--gray-50);
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-600);
    }
    
    .data-table tbody tr:hover {
      background: var(--gray-50);
    }
    
    /* 모달 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: 8px;
      font-size: 20px;
      cursor: pointer;
      color: var(--gray-500);
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-100);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* 토스트 */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-900);
      color: var(--white);
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    /* 빈 상태 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* 반응형 - 모바일 특화 */
    @media (max-width: 768px) {
      .portal-header {
        padding: 12px 16px;
      }
      
      .portal-header-inner {
        flex-direction: row;
        justify-content: space-between;
      }
      
      .logo-horizontal {
        height: 28px;
      }
      
      .user-info {
        gap: 8px;
      }
      
      .user-badge {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .btn-logout {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .portal-nav {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      }
      
      .portal-nav-inner {
        padding: 8px 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      
      .portal-nav-inner::-webkit-scrollbar {
        display: none;
      }
      
      .nav-item {
        font-size: 13px;
        padding: 8px 12px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      .portal-content {
        padding: 16px;
        padding-bottom: 100px;
      }
      
      .page-title {
        font-size: 20px;
      }
      
      .page-desc {
        font-size: 13px;
      }
      
      .card {
        padding: 14px;
        border-radius: 12px;
      }
      
      .card-title {
        font-size: 14px;
      }
      
      /* TOP 그리드 모바일 1열 */
      .top-grid {
        grid-template-columns: 1fr !important;
      }
      
      .top-item {
        padding: 8px 0 !important;
      }
      
      .top-name {
        font-size: 12px !important;
      }
      
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      
      .stat-card {
        padding: 12px 8px;
      }
      
      .stat-value {
        font-size: 20px;
      }
      
      .stat-label {
        font-size: 10px;
      }
      
      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }
      
      .day-number {
        font-size: 11px;
      }
      
      .deal-badge {
        font-size: 9px;
        padding: 2px 4px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .calendar-weekday {
        font-size: 11px;
        padding: 6px 0;
      }
      
      .form-input, .form-textarea, .form-select {
        font-size: 16px; /* iOS 확대 방지 */
        padding: 12px;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .btn-primary {
        padding: 12px 20px;
      }
      
      .modal-content {
        margin: 0;
        max-height: 100vh;
        border-radius: 16px 16px 0 0;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 100%;
        animation: slideUp 0.3s ease;
      }
      
      @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      
      .modal-body {
        max-height: 60vh;
        overflow-y: auto;
      }
      
      /* 테이블 모바일 최적화 */
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 6px !important;
      }
      
      /* 리스트 아이템 모바일 */
      .list-item {
        padding: 14px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }
    
    /* 작은 모바일 (375px 이하) */
    @media (max-width: 375px) {
      .nav-item {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .portal-content {
        padding: 12px;
      }
      
      .stats-grid {
        gap: 8px;
      }
      
      .stat-card {
        padding: 12px 10px;
      }
      
      .stat-value {
        font-size: 20px;
      }
    }
    
    /* 퀵배너 스타일 - 주황색 기반 3D 디자인 */
    .quick-banner-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      z-index: 9999;
    }
    
    .quick-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 54px;
      height: 54px;
      background: linear-gradient(145deg, #ffffff, #f5f5f5);
      border: none;
      border-radius: 50%;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.15),
        0 3px 6px rgba(0,0,0,0.08),
        inset 0 1px 2px rgba(255,255,255,0.9);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      flex-direction: column;
      gap: 0;
      text-decoration: none;
    }
    
    .quick-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 10px 24px rgba(252, 150, 0, 0.25),
        0 5px 10px rgba(0,0,0,0.1),
        inset 0 1px 2px rgba(255,255,255,1);
    }
    
    .quick-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 
        0 3px 8px rgba(252, 150, 0, 0.15),
        0 2px 4px rgba(0,0,0,0.08),
        inset 0 1px 4px rgba(0,0,0,0.05);
    }
    
    .quick-btn.active {
      background: var(--primary);
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.4),
        0 3px 6px rgba(252, 150, 0, 0.3),
        inset 0 1px 2px rgba(255,255,255,0.3);
    }
    
    .quick-btn.active .quick-label {
      color: white;
      text-shadow: 0 1px 1px rgba(0,0,0,0.15);
    }
    
    /* 정산 버튼 - 흰색 배경 + 연한 회색 테두리 */
    .quick-btn.settlement-btn {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.06),
        0 2px 4px rgba(0,0,0,0.03),
        inset 0 1px 2px rgba(255,255,255,0.9);
    }
    
    .quick-btn.settlement-btn .quick-label {
      color: #fc9600;
      font-weight: 700;
    }
    
    .quick-btn.settlement-btn:hover {
      background: var(--primary);
      border-color: transparent;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25);
    }
    
    .quick-btn.settlement-btn:hover .quick-label {
      color: white;
    }
    
    /* 공지 버튼 - 흰색 배경 + 연한 회색 테두리 */
    .quick-btn.notice-btn {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.06),
        0 2px 4px rgba(0,0,0,0.03),
        inset 0 1px 2px rgba(255,255,255,0.9);
    }
    
    .quick-btn.notice-btn .quick-label {
      color: #fc9600;
      font-weight: 700;
    }
    
    .quick-btn.notice-btn:hover {
      background: var(--primary);
      border-color: transparent;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25);
    }
    
    .quick-btn.notice-btn:hover .quick-label {
      color: white;
    }
    
    /* 문의 버튼 - 진한 주황 */
    .quick-btn.kakao-btn {
      background: var(--primary);
      border: none;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 2px rgba(255,255,255,0.3);
    }
    
    .quick-btn.kakao-btn .quick-label {
      color: white;
      font-weight: 700;
      text-shadow: 0 1px 1px rgba(0,0,0,0.15);
    }
    
    .quick-btn.kakao-btn:hover {
      background: linear-gradient(145deg, #ffb347, #fc9600);
    }
    
    .quick-label {
      font-size: 13px;
      font-weight: 700;
      color: #fc9600;
      letter-spacing: -0.3px;
      line-height: 1;
    }
    
    .quick-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      min-width: 18px;
      height: 18px;
      background: #dc2626;
      color: white;
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }
    
    /* 상품 등록 페이지 스타일 */
    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .product-actions {
      display: flex;
      gap: 8px;
    }
    
    .product-table-pc {
      display: block;
      overflow-x: auto;
    }
    
    .product-list-mobile {
      display: none;
    }
    
    /* 모바일 상품 카드 */
    .product-card-mobile {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .product-name-mobile {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .product-info-mobile {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .info-row.highlight {
      background: #fffbeb;
      margin: 0 -16px;
      padding: 8px 16px;
    }
    
    .info-label {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
    }
    
    .info-value.primary {
      color: var(--primary);
    }
    
    .deal-count {
      background: var(--primary-light);
      color: var(--primary);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    
    .product-actions-mobile {
      display: flex;
      gap: 8px;
    }
    
    .product-actions-mobile .btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
    }
    
    .btn-danger {
      background: #fee2e2 !important;
      color: #dc2626 !important;
    }
    
    @media (max-width: 768px) {
      .quick-banner-container {
        bottom: 16px;
        right: 16px;
        gap: 10px;
      }
      
      .quick-btn {
        width: 50px;
        height: 50px;
      }
      
      .quick-icon {
        font-size: 16px;
      }
      
      .quick-label {
        font-size: 8px;
      }
      
      /* 대시보드 TOP 5 모바일 1열 */
      .top-grid {
        grid-template-columns: 1fr !important;
      }
      
      /* 셀러 그리드 모바일 */
      .seller-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 8px !important;
      }
      
      /* 페이지 타이틀 모바일 */
      .page-title {
        font-size: 20px !important;
      }
      
      .page-desc {
        font-size: 13px !important;
      }
      
      /* 카드 패딩 조정 */
      .card {
        padding: 16px !important;
      }
      
      .card-title {
        font-size: 15px !important;
      }
      
      /* 통계 카드 모바일 */
      .stat-card {
        padding: 14px !important;
      }
      
      .stat-value {
        font-size: 22px !important;
      }
      
      /* 상품 페이지 모바일 */
      .product-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .product-actions {
        width: 100%;
      }
      
      .product-actions .btn-primary {
        flex: 1;
      }
      
      .excel-btn {
        display: none !important;
      }
      
      .product-table-pc {
        display: none !important;
      }
      
      .product-list-mobile {
        display: block !important;
      }
      
      /* 정산 모바일 - 엑셀 버튼 숨김 */
      .settlement-excel-btn {
        display: none !important;
      }
      
      /* 버튼 모바일 */
      .btn {
        padding: 10px 16px !important;
        font-size: 14px !important;
      }
      
      .btn-sm {
        padding: 8px 12px !important;
        font-size: 13px !important;
      }
    }
  </style>
</head>
<body>
  <!-- 로그인 페이지 -->
  <div id="login-page" class="login-page">
    <!-- 배경 모션 효과 -->
    <div class="login-gradient-flow"></div>
    <div class="login-bg-wave"></div>
    <div class="login-particle"></div>
    <div class="login-particle"></div>
    <div class="login-particle"></div>
    <div class="login-particle"></div>
    <div class="login-particle"></div>
    
    <div class="login-container">
      <div class="logo-section">
        <img src="logo-horizontal.png" alt="모여라딜" class="logo-img">
        <div class="logo-desc">파트너 포털</div>
      </div>
      
      <div class="login-card">
        <div class="tab-buttons">
          <button class="tab-btn supplier active" onclick="switchLoginTab('supplier')">공급사</button>
          <button class="tab-btn seller" onclick="switchLoginTab('seller')">셀러</button>
        </div>
        
        <div id="error-message" class="error-message">
          아이디 또는 비밀번호가 일치하지 않습니다.
        </div>
        
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label">아이디</label>
            <input type="text" class="form-input" id="login-id" placeholder="아이디를 입력하세요" required autocomplete="off">
          </div>
          
          <div class="form-group">
            <label class="form-label">비밀번호</label>
            <input type="password" class="form-input" id="login-pw" placeholder="비밀번호를 입력하세요" required>
          </div>
          
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #666;">
              <input type="checkbox" id="remember-id" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
              아이디 저장
            </label>
          </div>
          
          <button type="submit" class="btn btn-supplier" id="login-btn">로그인</button>
        </form>
        
        <div class="help-text">
          로그인 정보는 담당자에게 문의하세요.
        </div>
      </div>
      
      <div class="footer-text">
        © 2025 모여라딜. All rights reserved.
      </div>
    </div>
    
    <!-- 로그인 화면 문의 버튼 -->
    <a href="http://pf.kakao.com/_xoxnJHn" target="_blank" class="login-kakao-btn">
      <span>문의</span>
    </a>
  </div>
  
  <!-- 포털 페이지 -->
  <div id="portal-page" class="portal-page">
    <!-- 헤더 -->
    <header class="portal-header">
      <div class="portal-header-inner">
        <div class="portal-logo">
          <img src="logo-horizontal.png" alt="모여라딜">
        </div>
        <div class="user-info">
          <span id="user-badge" class="user-badge supplier">공급사명</span>
          <button class="logout-btn" onclick="handleLogout()">로그아웃</button>
        </div>
      </div>
    </header>
    
    <!-- 네비게이션 -->
    <nav class="portal-nav">
      <div class="portal-nav-inner" id="nav-menu">
        <!-- 동적으로 생성됨 -->
      </div>
    </nav>
    
    <!-- 메인 콘텐츠 -->
    <main class="portal-content" id="main-content">
      <!-- 동적으로 생성됨 -->
    </main>
  </div>
  
  <!-- 모달 -->
  <div id="modal" class="modal" onclick="if(event.target===this)closeModal()"></div>
  
  <!-- 토스트 -->
  <div id="toast" class="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
  authDomain: "moyeora-deal-manager.firebaseapp.com",
  projectId: "moyeora-deal-manager",
  storageBucket: "moyeora-deal-manager.firebasestorage.app",
  messagingSenderId: "527148187832",
  appId: "1:527148187832:web:dc35b0413a7157db34744d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// 상태 관리
let state = {
  currentUser: null,
  userType: null, // 'supplier' or 'seller'
  currentPage: 'dashboard',
  suppliers: [],
  sellers: [],
  deals: [],
  supplierProducts: [],
  productGroups: [],  // 대표상품 그룹
  notices: [],
  messages: [],
  settlements: [],
  supplierSettlements: [],
  sellerSettlements: [],
  suggestions: [],
  adminProposals: [],
  urgentSales: [],
  cafe24Orders: [],
  orderPeriodFilter: 'month1', // 'all', 'month1', 'month3', 'month6'
  productSearchKeyword: ''
};

let loginTab = 'supplier';

// ===== 유틸리티 함수 =====
const formatDate = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

const formatDateKR = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getMonth()+1}월 ${d.getDate()}일`;
};

const formatNumber = (num) => {
  return (num || 0).toLocaleString();
};

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function closeModal() {
  document.getElementById('modal').className = 'modal';
}

// ===== 로그인 관련 =====
function switchLoginTab(tab) {
  loginTab = tab;
  
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.tab-btn.${tab}`).classList.add('active');
  
  const loginBtn = document.getElementById('login-btn');
  loginBtn.className = `btn btn-${tab}`;
  
  document.getElementById('error-message').classList.remove('show');
  
  // 탭 전환시 저장된 아이디 불러오기
  loadSavedLoginId();
  document.getElementById('login-pw').value = '';
}

// 저장된 아이디 불러오기
function loadSavedLoginId() {
  const savedId = localStorage.getItem(`partner_${loginTab}_id`);
  const rememberCheck = document.getElementById('remember-id');
  const loginIdInput = document.getElementById('login-id');
  
  if (savedId) {
    loginIdInput.value = savedId;
    rememberCheck.checked = true;
  } else {
    loginIdInput.value = '';
    rememberCheck.checked = false;
  }
}

async function handleLogin(e) {
  e.preventDefault();
  
  const loginId = document.getElementById('login-id').value.trim();
  const loginPw = document.getElementById('login-pw').value;
  const loginBtn = document.getElementById('login-btn');
  const errorMsg = document.getElementById('error-message');
  const rememberCheck = document.getElementById('remember-id');
  
  errorMsg.classList.remove('show');
  loginBtn.classList.add('loading');
  
  // 데이터 로드 대기 (최대 5초)
  let waitCount = 0;
  while ((state.suppliers.length === 0 && state.sellers.length === 0) && waitCount < 50) {
    await new Promise(r => setTimeout(r, 100));
    waitCount++;
  }
  
  await new Promise(r => setTimeout(r, 300));
  
  let matched = null;
  
  if (loginTab === 'supplier') {
    matched = state.suppliers.find(s => s.loginId === loginId && s.loginPw === loginPw);
    
    if (matched) {
      // 아이디 저장 처리
      if (rememberCheck.checked) {
        localStorage.setItem('partner_supplier_id', loginId);
      } else {
        localStorage.removeItem('partner_supplier_id');
      }
      
      // 세션 저장 (새로고침 시 자동 로그인용)
      localStorage.setItem('partner_session', JSON.stringify({
        userType: 'supplier',
        loginId: loginId,
        loginPw: loginPw,
        userId: matched.id
      }));
      
      state.currentUser = matched;
      state.userType = 'supplier';
      loginBtn.classList.remove('loading');
      showPortal();
      return;
    }
  } else {
    matched = state.sellers.find(s => s.loginId === loginId && s.loginPw === loginPw);
    
    if (matched) {
      // 아이디 저장 처리
      if (rememberCheck.checked) {
        localStorage.setItem('partner_seller_id', loginId);
      } else {
        localStorage.removeItem('partner_seller_id');
      }
      
      // 세션 저장 (새로고침 시 자동 로그인용)
      localStorage.setItem('partner_session', JSON.stringify({
        userType: 'seller',
        loginId: loginId,
        loginPw: loginPw,
        userId: matched.id
      }));
      
      state.currentUser = matched;
      state.userType = 'seller';
      loginBtn.classList.remove('loading');
      showPortal();
      return;
    }
  }
  
  loginBtn.classList.remove('loading');
  errorMsg.classList.add('show');
  document.getElementById('login-pw').value = '';
}

function handleLogout() {
  state.currentUser = null;
  state.userType = null;
  state.currentPage = 'dashboard';
  
  // 세션 삭제
  localStorage.removeItem('partner_session');
  
  document.getElementById('login-page').style.display = 'flex';
  document.getElementById('portal-page').classList.remove('active');
  
  // 퀵배너 숨기기
  const quickBanner = document.getElementById('quick-banner');
  if (quickBanner) quickBanner.innerHTML = '';
  
  // 저장된 아이디 불러오기
  loadSavedLoginId();
  document.getElementById('login-pw').value = '';
}

// ===== 포털 표시 =====
function showPortal() {
  document.getElementById('login-page').style.display = 'none';
  document.getElementById('portal-page').classList.add('active');
  
  // 사용자 정보 표시 - 아이디로 표시
  const badge = document.getElementById('user-badge');
  const userId = state.currentUser.userId || state.currentUser.loginId || state.currentUser.id || '';
  if (state.userType === 'supplier') {
    badge.className = 'user-badge supplier';
    badge.innerHTML = `${userId}`;
  } else {
    badge.className = 'user-badge seller';
    badge.innerHTML = `${userId}`;
  }
  
  renderNav();
  renderPage('dashboard');
}

function renderNav() {
  const nav = document.getElementById('nav-menu');
  
  const commonMenus = [
    { id: 'dashboard', label: '대시보드' },
    { id: 'calendar', label: '내 일정' },
    { id: 'orders', label: '주문현황' }
  ];
  
  const supplierMenus = [
    { id: 'products', label: '상품관리' },
    { id: 'urgent', label: '긴급판매요청' }
  ];
  
  const sellerMenus = [
    { id: 'suggest', label: '공구 제안' }
  ];
  
  const menus = state.userType === 'supplier' 
    ? [...commonMenus, ...supplierMenus]
    : [...commonMenus, ...sellerMenus];
  
  nav.innerHTML = `
    <div style="display: flex; align-items: center; gap: 4px; flex: 1; overflow-x: auto;">
      ${menus.map(m => `
        <button class="nav-item ${state.currentPage === m.id ? 'active' : ''}" onclick="renderPage('${m.id}')">
          ${m.label}
        </button>
      `).join('')}
    </div>
  `;
  
  // 퀵배너 렌더링
  renderQuickBanner();
}

// 퀵배너 렌더링
function renderQuickBanner() {
  let quickBanner = document.getElementById('quick-banner');
  if (!quickBanner) {
    quickBanner = document.createElement('div');
    quickBanner.id = 'quick-banner';
    document.body.appendChild(quickBanner);
  }
  
  // 읽지 않은 공지사항 수 계산
  const unreadNotices = state.notices?.filter(n => {
    const readNotices = JSON.parse(localStorage.getItem('readNotices') || '[]');
    return !readNotices.includes(n.id);
  }).length || 0;
  
  // 정산 건수 - 더 유연한 매칭
  let pendingSettlements = 0;
  if (state.userType === 'supplier') {
    // 공급사용: supplierSettlements에서 매칭 - isCompleted로 단순 판단
    pendingSettlements = (state.supplierSettlements || []).filter(s => {
      const brandName = (s.brandName || '').trim().toLowerCase();
      const currentName = (state.currentUser?.name || '').trim().toLowerCase();
      const currentId = state.currentUser?.id || '';
      
      if (s.supplierId && s.supplierId === currentId) return !s.isCompleted;
      if (brandName === currentName) return !s.isCompleted;
      const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
      const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
      return (cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand)) && !s.isCompleted;
    }).length;
  } else {
    // 셀러용: sellerSettlements에서 매칭
    pendingSettlements = (state.settlements || []).filter(s => {
      const sellerName = (s.sellerName || '').trim().toLowerCase();
      const currentName = (state.currentUser?.name || '').trim().toLowerCase();
      const currentNickname = (state.currentUser?.nickname || '').trim().toLowerCase();
      const currentId = state.currentUser?.id || '';
      
      // 셀러 정산완료 판단: isSellerCompleted 우선, 없으면 isCompleted
      const isComplete = s.isSellerCompleted !== undefined ? s.isSellerCompleted : (s.isCompleted || false);
      
      if (s.sellerId && s.sellerId === currentId) return !isComplete;
      if (sellerName === currentName || sellerName === currentNickname) return !isComplete;
      const cleanSeller = sellerName.replace(/[\s\-\_\(\)\/]/g, '');
      const cleanName = currentName.replace(/[\s\-\_\(\)\/]/g, '');
      return (cleanSeller.includes(cleanName) || cleanName.includes(cleanSeller)) && !isComplete;
    }).length;
  }
  
  quickBanner.innerHTML = `
    <div class="quick-banner-container">
      <button class="quick-btn settlement-btn ${state.currentPage === 'settlement' ? 'active' : ''}" onclick="renderPage('settlement')">
        <span class="quick-label">정산</span>
        ${pendingSettlements > 0 ? `<span class="quick-badge">${pendingSettlements}</span>` : ''}
      </button>
      <button class="quick-btn notice-btn ${state.currentPage === 'notice' ? 'active' : ''}" onclick="renderPage('notice')">
        <span class="quick-label">공지</span>
        ${unreadNotices > 0 ? `<span class="quick-badge">${unreadNotices}</span>` : ''}
      </button>
      <a href="${state.userType === 'supplier' ? 'https://pf.kakao.com/_xoxnJHn' : 'http://pf.kakao.com/_xdZVkn'}" target="_blank" class="quick-btn kakao-btn">
        <span class="quick-label">문의</span>
      </a>
    </div>
  `;
}

// ===== 페이지 렌더링 =====
function renderPage(page) {
  state.currentPage = page;
  renderNav();
  
  const content = document.getElementById('main-content');
  
  switch(page) {
    case 'dashboard': renderDashboard(content); break;
    case 'calendar': renderCalendar(content); break;
    case 'orders': renderOrders(content); break;
    case 'notice': renderNotice(content); break;
    case 'message': renderMessage(content); break;
    case 'products': renderProducts(content); break;
    case 'urgent': renderUrgentSales(content); break;
    case 'settlement': renderSettlement(content); break;
    case 'suggest': renderSuggest(content); break;
  }
}

// ===== 대시보드 =====
function renderDashboard(container) {
  const myDeals = getMyDeals();
  const today = new Date();
  today.setHours(0,0,0,0);
  
  const ongoingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    const end = new Date(d.endDate);
    return today >= start && today <= end;
  });
  
  const upcomingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    return today < start;
  }).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
  
  const completedDeals = myDeals.filter(d => {
    const end = new Date(d.endDate);
    return today > end;
  });
  
  // 공급사용: 공구 진행 TOP 5 계산
  let topProductsHtml = '';
  let productStats = [];
  if (state.userType === 'supplier') {
    // 내 상품 목록
    const myProducts = state.supplierProducts.filter(p => {
      if (p.supplierId === state.currentUser.id) return true;
      if (p.brandName && state.currentUser.name && 
          p.brandName.includes(state.currentUser.name)) return true;
      return false;
    });
    
    // 상품별 공구 연결 수 계산
    productStats = myProducts.map(p => {
      // selectedProducts가 객체 배열 또는 문자열 배열일 수 있음
      const linkedDeals = state.deals.filter(d => {
        if (!d.selectedProducts) return false;
        return d.selectedProducts.some(item => {
          const pid = typeof item === 'string' ? item : item.productId;
          return pid === p.id;
        });
      });
      return {
        ...p,
        dealCount: linkedDeals.length
      };
    }).filter(p => p.dealCount > 0)
      .sort((a, b) => b.dealCount - a.dealCount)
      .slice(0, 5);
  }
  
  // 🆕 판매 베스트 TOP 5 - 정산예정 + 정산완료 탭 분리 (supplierSettlements + sellerSettlements inhouse)
  let salesBestHtml = '';
  if (state.userType === 'supplier') {
    const salesByProductPending = {};
    const salesByProductCompleted = {};
    
    // 내 브랜드 매칭 함수
    const isMyBrand = (s) => {
      const brandName = (s.brandName || '').trim().toLowerCase();
      const currentName = (state.currentUser.name || '').trim().toLowerCase();
      const currentId = state.currentUser.id || '';
      
      if (s.supplierId && s.supplierId === currentId) return true;
      if (brandName === currentName) return true;
      const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
      const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
      return cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand);
    };
    
    // supplierSettlements에서 내 브랜드 데이터
    (state.supplierSettlements || []).forEach(ss => {
      if (!isMyBrand(ss)) return;
      
      const targetMap = ss.isCompleted ? salesByProductCompleted : salesByProductPending;
      
      const items = ss.items || ss.salesItems || [];
      if (items.length > 0) {
        items.forEach(item => {
          const productName = item.productName || item.name || '알 수 없음';
          if (!targetMap[productName]) {
            targetMap[productName] = { productName, totalQty: 0, totalAmount: 0 };
          }
          targetMap[productName].totalQty += Number(item.quantity) || 0;
          const itemAmount = Number(item.amount) || (Number(item.unitPrice) || Number(item.supplyPrice) || 0) * (Number(item.quantity) || 0);
          targetMap[productName].totalAmount += itemAmount;
        });
      } else {
        const productName = ss.sellerName || '정산건';
        if (!targetMap[productName]) {
          targetMap[productName] = { productName, totalQty: 0, totalAmount: 0 };
        }
        targetMap[productName].totalQty += Number(ss.totalQuantity) || 1;
        targetMap[productName].totalAmount += Number(ss.salesAmount) || 0;
      }
    });
    
    // 🆕 sellerSettlements에서 자사 상품(inhouse) 추가
    (state.settlements || []).forEach(ss => {
      if (ss.productType !== 'inhouse') return;
      if (!isMyBrand(ss)) return;
      
      // 자사 상품: isSellerCompleted 또는 isCompleted 체크
      const isComplete = ss.isSellerCompleted || ss.isCompleted || false;
      const targetMap = isComplete ? salesByProductCompleted : salesByProductPending;
      
      const items = ss.items || ss.salesItems || [];
      if (items.length > 0) {
        items.forEach(item => {
          const productName = item.productName || item.name || '알 수 없음';
          if (!targetMap[productName]) {
            targetMap[productName] = { productName, totalQty: 0, totalAmount: 0 };
          }
          targetMap[productName].totalQty += Number(item.quantity) || 0;
          const itemAmount = Number(item.amount) || (Number(item.salePrice) || 0) * (Number(item.quantity) || 0);
          targetMap[productName].totalAmount += itemAmount;
        });
      } else {
        const productName = ss.sellerName || '정산건';
        if (!targetMap[productName]) {
          targetMap[productName] = { productName, totalQty: 0, totalAmount: 0 };
        }
        targetMap[productName].totalQty += Number(ss.totalQuantity) || 1;
        targetMap[productName].totalAmount += Number(ss.salesAmount) || 0;
      }
    });
    
    const salesBestPending = Object.values(salesByProductPending).filter(p => p.totalAmount > 0).sort((a, b) => b.totalAmount - a.totalAmount).slice(0, 5);
    const salesBestCompleted = Object.values(salesByProductCompleted).filter(p => p.totalAmount > 0).sort((a, b) => b.totalAmount - a.totalAmount).slice(0, 5);
    
    const renderSalesList = (stats, emptyMsg) => stats.length === 0 ? `
      <div style="text-align: center; padding: 40px 20px; color: var(--gray-400);">
        <div style="font-size: 32px; margin-bottom: 8px;">📊</div>
        <p style="font-size: 13px;">${emptyMsg}</p>
      </div>
    ` : stats.map((p, idx) => `
      <div class="top-item" style="display: flex; align-items: center; padding: 10px 0; ${idx < stats.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : ''}">
        <div class="top-rank" style="width: 24px; height: 24px; min-width: 24px; background: ${idx === 0 ? 'linear-gradient(135deg, #dc2626, #f97316)' : idx === 1 ? 'linear-gradient(135deg, #ea580c, #f59e0b)' : idx === 2 ? 'linear-gradient(135deg, #f59e0b, #fbbf24)' : 'var(--gray-200)'}; color: ${idx < 3 ? 'white' : 'var(--gray-600)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; margin-right: 10px; flex-shrink: 0;">${idx + 1}</div>
        <div style="flex: 1; min-width: 0;"><div class="top-name" style="font-weight: 600; color: var(--gray-800); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div><div style="font-size: 11px; color: var(--gray-500);">${p.totalQty}개 판매</div></div>
        <div style="font-weight: 700; color: #dc2626; font-size: 12px; flex-shrink: 0; margin-left: 8px;">${formatNumber(p.totalAmount)}원</div>
      </div>
    `).join('');
    
    salesBestHtml = `
      <div class="card" style="height: 100%;">
        <h3 class="card-title">Best 판매 상품 TOP</h3>
        <div style="display: flex; border-radius: 8px; overflow: hidden; margin-bottom: 12px; border: 1px solid rgba(252, 150, 0, 0.2);">
          <button id="salesTabPending" onclick="switchSalesTab('pending')" style="flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: 500; font-size: 12px; background: #fff8f0; color: var(--gray-600);">정산예정</button>
          <button id="salesTabCompleted" onclick="switchSalesTab('completed')" style="flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 12px; background: var(--primary); color: white;">정산완료</button>
        </div>
        <div id="salesContentPending" style="display: none;">${renderSalesList(salesBestPending, '아직 정산예정 판매 데이터가 없습니다.')}</div>
        <div id="salesContentCompleted">${renderSalesList(salesBestCompleted, '아직 정산완료된 판매 데이터가 없습니다.')}</div>
      </div>
    `;
  }
  
  // 🆕 많이 판매한 셀러 TOP 3 - 정산예정 + 정산완료 탭 분리 (supplierSettlements + sellerSettlements inhouse)
  let topSellersHtml = '';
  if (state.userType === 'supplier') {
    const salesBySellerPending = {};
    const salesBySellerCompleted = {};
    
    // 내 브랜드 매칭 함수
    const isMyBrand = (s) => {
      const brandName = (s.brandName || '').trim().toLowerCase();
      const currentName = (state.currentUser.name || '').trim().toLowerCase();
      const currentId = state.currentUser.id || '';
      
      if (s.supplierId && s.supplierId === currentId) return true;
      if (brandName === currentName) return true;
      const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
      const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
      return cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand);
    };
    
    // supplierSettlements에서 데이터 수집
    (state.supplierSettlements || []).forEach(ss => {
      if (!isMyBrand(ss)) return;
      
      const sellerName = ss.sellerName || '알 수 없음';
      const parts = sellerName.split('/');
      const displayName = parts.length > 1 ? parts[1] : sellerName;
      const sellerKey = sellerName;
      
      const seller = state.sellers.find(s => s.name && s.name.includes(displayName));
      
      const targetMap = ss.isCompleted ? salesBySellerCompleted : salesBySellerPending;
      
      if (!targetMap[sellerKey]) {
        targetMap[sellerKey] = { 
          sellerKey, 
          sellerName: displayName, 
          channelLink: seller?.channelLink || seller?.accountLink || '', 
          totalAmount: 0, 
          dealCount: 0 
        };
      }
      targetMap[sellerKey].totalAmount += Number(ss.salesAmount) || 0;
      targetMap[sellerKey].dealCount += 1;
    });
    
    // 🆕 sellerSettlements에서 자사 상품(inhouse) 추가
    (state.settlements || []).forEach(ss => {
      if (ss.productType !== 'inhouse') return;
      if (!isMyBrand(ss)) return;
      
      const sellerName = ss.sellerName || '알 수 없음';
      const parts = sellerName.split('/');
      const displayName = parts.length > 1 ? parts[1] : sellerName;
      const sellerKey = sellerName;
      
      const seller = state.sellers.find(s => s.name && s.name.includes(displayName));
      
      // 자사 상품: isSellerCompleted 또는 isCompleted
      const isComplete = ss.isSellerCompleted || ss.isCompleted || false;
      const targetMap = isComplete ? salesBySellerCompleted : salesBySellerPending;
      
      if (!targetMap[sellerKey]) {
        targetMap[sellerKey] = { 
          sellerKey, 
          sellerName: displayName, 
          channelLink: seller?.channelLink || seller?.accountLink || '', 
          totalAmount: 0, 
          dealCount: 0 
        };
      }
      targetMap[sellerKey].totalAmount += Number(ss.salesAmount) || 0;
      targetMap[sellerKey].dealCount += 1;
    });
    
    const topSellersPending = Object.values(salesBySellerPending).filter(s => s.totalAmount > 0).sort((a, b) => b.totalAmount - a.totalAmount).slice(0, 3);
    const topSellersCompleted = Object.values(salesBySellerCompleted).filter(s => s.totalAmount > 0).sort((a, b) => b.totalAmount - a.totalAmount).slice(0, 3);
    
    const renderSellersList = (sellers, emptyMsg) => sellers.length === 0 ? `
      <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
        <div style="font-size: 32px; margin-bottom: 8px;">👤</div>
        <p style="font-size: 13px;">${emptyMsg}</p>
      </div>
    ` : `
      <div class="seller-grid" style="display: grid; grid-template-columns: repeat(${Math.min(sellers.length, 3)}, 1fr); gap: 10px;">
        ${sellers.map((s, idx) => `
          <div style="text-align: center; padding: 12px 8px; background: ${idx === 0 ? 'linear-gradient(135deg, #fef3c7, #fde68a)' : idx === 1 ? 'linear-gradient(135deg, #f3f4f6, #e5e7eb)' : 'linear-gradient(135deg, #fed7aa, #fdba74)'}; border-radius: 10px;">
            <div style="font-size: 20px; margin-bottom: 6px;">${idx === 0 ? '🥇' : idx === 1 ? '🥈' : '🥉'}</div>
            <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 4px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.sellerName}</div>
            <div style="font-weight: 700; color: #dc2626; font-size: 13px; margin-bottom: 6px;">${formatNumber(s.totalAmount)}원</div>
            ${s.channelLink ? `<a href="${s.channelLink.startsWith('http') ? s.channelLink : 'https://' + s.channelLink}" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: rgba(255,255,255,0.8); border-radius: 20px; font-size: 10px; color: var(--info); text-decoration: none; font-weight: 500;">${getChannelIconPortal(s.channelLink)} 채널</a>` : ''}
          </div>
        `).join('')}
      </div>
    `;
    
    topSellersHtml = `
      <div class="card" style="height: 100%;">
        <h3 class="card-title">많이 판매한 셀러 TOP</h3>
        <div style="display: flex; border-radius: 8px; overflow: hidden; margin-bottom: 12px; border: 1px solid rgba(252, 150, 0, 0.2);">
          <button id="sellerTabPending" onclick="switchSellerTab('pending')" style="flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: 500; font-size: 12px; background: #fff8f0; color: var(--gray-600);">정산예정</button>
          <button id="sellerTabCompleted" onclick="switchSellerTab('completed')" style="flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 12px; background: var(--primary); color: white;">정산완료</button>
        </div>
        <div id="sellerContentPending" style="display: none;">${renderSellersList(topSellersPending, '아직 정산예정 판매 데이터가 없습니다.')}</div>
        <div id="sellerContentCompleted">${renderSellersList(topSellersCompleted, '아직 정산완료된 판매 데이터가 없습니다.')}</div>
      </div>
    `;
  }
  
  // 공구 진행 TOP 5 HTML 수정 (데이터 없을 때도 표시)
  if (state.userType === 'supplier') {
    topProductsHtml = `
      <div class="card" style="height: 100%;">
        <h3 class="card-title">공구 진행 건수 TOP</h3>
        <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">공구에 등록된 횟수가 많은 순서입니다.</p>
        ${productStats.length === 0 ? `
          <div style="text-align: center; padding: 40px 20px; color: var(--gray-400);">
            <div style="font-size: 32px; margin-bottom: 8px;">📦</div>
            <p style="font-size: 13px;">아직 공구에 등록된 상품이 없습니다.</p>
          </div>
        ` : productStats.map((p, idx) => `
          <div class="top-item" style="display: flex; align-items: center; padding: 10px 0; ${idx < productStats.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : ''}">
            <div class="top-rank" style="width: 24px; height: 24px; min-width: 24px; background: ${idx === 0 ? 'linear-gradient(135deg, #FFD700, #FFA500)' : idx === 1 ? 'linear-gradient(135deg, #C0C0C0, #A0A0A0)' : idx === 2 ? 'linear-gradient(135deg, #CD7F32, #8B4513)' : 'var(--gray-200)'}; color: ${idx < 3 ? 'white' : 'var(--gray-600)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; margin-right: 10px; flex-shrink: 0;">${idx + 1}</div>
            <div style="flex: 1; min-width: 0;">
              <div class="top-name" style="font-weight: 600; color: var(--gray-800); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div>
              <div style="font-size: 11px; color: var(--gray-500);">공급가: ${formatNumber(p.supplyPrice || 0)}원</div>
            </div>
            <div class="top-count" style="background: var(--primary-light); color: var(--primary); padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 8px; flex-shrink: 0;">${p.dealCount}건</div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  container.innerHTML = `
    ${state.userType === 'supplier' ? `
      <!-- ========================================== -->
      <!-- 공급사 대시보드 - 모여라딜 스타일 -->
      <!-- ========================================== -->
      
      <!-- 히어로 섹션 -->
      <div style="text-align: center; padding: 40px 20px 30px;">
        <div style="display: inline-block; background: var(--primary); color: white; padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-bottom: 16px;">
          공급사 전용 대시보드
        </div>
        <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px;">
          ${state.currentUser?.userId || state.currentUser?.loginId || '공급사'}님, 환영해요!
        </h1>
        <p style="font-size: 15px; color: var(--gray-500);">
          오늘도 좋은 제품으로 함께 성장해요 ✨
        </p>
      </div>
      
      <!-- 통계 카드 - 3열 그리드 -->
      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-card" style="cursor: pointer;" onclick="document.getElementById('section-ongoing')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-value" style="color: var(--primary);">${ongoingDeals.length}</div>
          <div class="stat-label">진행중</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="document.getElementById('section-upcoming')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-value" style="color: var(--info);">${upcomingDeals.length}</div>
          <div class="stat-label">예정</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="document.getElementById('section-completed')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-value" style="color: var(--success);">${completedDeals.length}</div>
          <div class="stat-label">완료</div>
        </div>
      </div>
      
      <!-- 공급사 대시보드 매출 통계 -->
      ${renderSupplierDashboardStats()}
    ` : `
      <!-- ========================================== -->
      <!-- 셀러 대시보드 - 모여라딜 스타일 -->
      <!-- ========================================== -->
      
      <!-- 히어로 섹션 -->
      <div style="text-align: center; padding: 40px 20px 30px;">
        <div style="display: inline-block; background: var(--primary); color: white; padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-bottom: 16px;">
          셀러 전용 대시보드
        </div>
        <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px;">
          ${state.currentUser?.userId || state.currentUser?.loginId || '셀러'}님, 환영해요!
        </h1>
        <p style="font-size: 15px; color: var(--gray-500);">
          오늘도 성공적인 공구를 응원합니다 ✨
        </p>
      </div>
      
      <!-- 통계 카드 - 모여라딜 스타일 -->
      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-card" style="cursor: pointer;" onclick="toggleOngoingDeals(); document.getElementById('section-ongoing')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-value" style="color: var(--primary);">${ongoingDeals.length}</div>
          <div class="stat-label">진행중</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="toggleUpcomingDeals(); document.getElementById('section-upcoming')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-value" style="color: var(--info);">${upcomingDeals.length}</div>
          <div class="stat-label">예정</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="toggleCompletedDeals(); document.getElementById('section-completed')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-value" style="color: var(--success);">${completedDeals.length}</div>
          <div class="stat-label">완료</div>
        </div>
      </div>
      
      <!-- 정산 예정 요약 -->
      ${renderSellerDashboardStats()}
    `}
    
    <!-- TOP 섹션 - 공급사만 (2열 2단) -->
    ${state.userType === 'supplier' ? `
      <!-- 1행: Best 판매 상품 TOP / 많이 판매한 셀러 TOP -->
      <div class="top-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div>${salesBestHtml}</div>
        <div>${topSellersHtml}</div>
      </div>
      
      <!-- 2행: 공구 진행 건수 TOP (풀와이드) -->
      <div style="margin-bottom: 16px;">
        ${topProductsHtml}
      </div>
    ` : ''}
    
    <!-- 🔥 진행중인 공구 -->
    <div id="section-ongoing" style="margin-bottom: 12px;">
      <div class="card" style="${ongoingDeals.length > 0 ? 'border: 2px solid var(--primary);' : ''}">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleOngoingDeals()">
          <h3 class="card-title" style="margin: 0;">
            진행중인 공구 
            <span style="background: var(--primary); color: white; padding: 2px 12px; border-radius: 12px; font-size: 13px; margin-left: 8px;">${ongoingDeals.length}</span>
          </h3>
          <span id="ongoing-deals-toggle" style="font-size: 14px; color: var(--gray-400); padding: 8px;">${ongoingDeals.length > 0 ? '▲' : '▼'}</span>
        </div>
        <div id="ongoing-deals-content" style="${ongoingDeals.length > 0 ? 'display: block;' : 'display: none;'} margin-top: 16px;">
          ${ongoingDeals.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: 10px;">
              ${ongoingDeals.map(d => renderDealItem(d, 'ongoing')).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
              <div style="font-size: 32px; margin-bottom: 8px;">🔥</div>
              <p style="font-size: 13px;">진행중인 공구가 없습니다</p>
            </div>
          `}
        </div>
      </div>
    </div>
    
    <!-- 📅 예정된 공구 -->
    <div id="section-upcoming" style="margin-bottom: 12px;">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleUpcomingDeals()">
          <h3 class="card-title" style="margin: 0;">
            예정 공구 
            <span style="background: var(--info); color: white; padding: 2px 12px; border-radius: 12px; font-size: 13px; margin-left: 8px;">${upcomingDeals.length}</span>
          </h3>
          <span id="upcoming-deals-toggle" style="font-size: 14px; color: var(--gray-400); padding: 8px;">▼</span>
        </div>
        <div id="upcoming-deals-content" style="display: none; margin-top: 16px;">
          ${upcomingDeals.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: 10px;">
              ${upcomingDeals.map(d => renderDealItem(d, 'upcoming')).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
              <p style="font-size: 14px;">예정된 공구가 없습니다</p>
            </div>
          `}
        </div>
      </div>
    </div>
    
    <!-- ✅ 완료된 공구 -->
    <div id="section-completed" style="margin-bottom: 12px;">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleCompletedDeals()">
          <h3 class="card-title" style="margin: 0;">
            완료된 공구 
            <span style="background: var(--success); color: white; padding: 2px 12px; border-radius: 12px; font-size: 13px; margin-left: 8px;">${completedDeals.length}</span>
          </h3>
          <span id="completed-deals-toggle" style="font-size: 14px; color: var(--gray-400); padding: 8px;">▼</span>
        </div>
        <div id="completed-deals-content" style="display: none; margin-top: 16px;">
          ${completedDeals.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: 10px;">
              ${completedDeals.map(d => renderDealItem(d, 'completed')).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
              <p style="font-size: 14px;">완료된 공구가 없습니다</p>
            </div>
          `}
        </div>
      </div>
    </div>
    
    <!-- 📦 전체 공구 -->
    <div id="section-all" style="margin-bottom: 12px;">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleAllDeals()">
          <h3 class="card-title" style="margin: 0;">
            전체 공구 
            <span style="background: var(--gray-400); color: white; padding: 2px 12px; border-radius: 12px; font-size: 13px; margin-left: 8px;">${myDeals.length}</span>
          </h3>
          <span id="all-deals-toggle" style="font-size: 14px; color: var(--gray-400); padding: 8px;">▼</span>
        </div>
        <div id="all-deals-content" style="display: none; margin-top: 16px;">
          ${myDeals.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: 10px;">
              ${myDeals.map(d => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const start = new Date(d.startDate);
                const end = new Date(d.endDate);
                let statusType = 'upcoming';
                if (today >= start && today <= end) statusType = 'ongoing';
                else if (today > end) statusType = 'completed';
                return renderDealItem(d, statusType);
              }).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
              <p style="font-size: 14px;">등록된 공구가 없습니다</p>
            </div>
          `}
        </div>
      </div>
    </div>
  `;
}

// 예정된 공구 토글
function toggleUpcomingDeals() {
  const content = document.getElementById('upcoming-deals-content');
  const toggle = document.getElementById('upcoming-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

// 진행중인 공구 토글
function toggleOngoingDeals() {
  const content = document.getElementById('ongoing-deals-content');
  const toggle = document.getElementById('ongoing-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

// 완료된 공구 토글
function toggleCompletedDeals() {
  const content = document.getElementById('completed-deals-content');
  const toggle = document.getElementById('completed-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

// 전체 공구 토글
function toggleAllDeals() {
  const content = document.getElementById('all-deals-content');
  const toggle = document.getElementById('all-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

// 셀러 대시보드 통계 렌더링
function renderSellerDashboardStats() {
  // 내 정산 데이터 (sellerId로 우선 필터, 없으면 sellerName 정확히 매칭)
  const mySettlements = (state.sellerSettlements || []).filter(s => {
    // sellerId가 있으면 정확히 매칭
    if (s.sellerId && state.currentUser.id) {
      return s.sellerId === state.currentUser.id;
    }
    // sellerName이 정확히 일치하거나 현재 유저 이름을 포함하는지 확인
    const sellerName = s.sellerName || '';
    const currentName = state.currentUser.name || '';
    // 정확한 매칭 (셀러명이 "이하늘/하린맘(0.5만)" 형태일 때 "이하늘"이 포함되어야 함)
    if (currentName && sellerName) {
      // currentName의 첫번째 부분 (이름)이 sellerName에 정확히 포함되어야 함
      const namePart = currentName.split('/')[0];
      const sellerNamePart = sellerName.split('/')[0];
      return namePart === sellerNamePart || sellerName === currentName;
    }
    return false;
  });
  
  // 총 판매건(공구 진행건), 총 판매액 계산
  const totalSalesCount = mySettlements.length;
  const totalSalesAmount = mySettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  
  // 상품별 판매 집계
  const salesByProduct = {};
  mySettlements.forEach(s => {
    const items = s.salesItems || s.items || [];
    if (items.length > 0) {
      items.forEach(item => {
        const productName = item.productName || item.name || '알 수 없음';
        if (!salesByProduct[productName]) {
          salesByProduct[productName] = { productName, totalQty: 0, totalAmount: 0 };
        }
        salesByProduct[productName].totalQty += Number(item.quantity) || 0;
        salesByProduct[productName].totalAmount += Number(item.amount) || 0;
      });
    }
  });
  
  // 브랜드별 매출 집계
  const salesByBrand = {};
  mySettlements.forEach(s => {
    const brandName = s.brandName || '기타';
    if (!salesByBrand[brandName]) {
      salesByBrand[brandName] = { brandName, totalAmount: 0, count: 0 };
    }
    salesByBrand[brandName].totalAmount += Number(s.salesAmount) || 0;
    salesByBrand[brandName].count += 1;
  });
  
  // 정산 예정/완료 금액 계산 (actualPayment 기준)
  // 셀러: isSellerCompleted 우선, 없으면 isCompleted 체크
  const isSettlementCompleteForSeller = (s) => {
    if (s.isSellerCompleted !== undefined) return s.isSellerCompleted;
    return s.isCompleted || false;
  };
  const pendingSettlements = mySettlements.filter(s => !isSettlementCompleteForSeller(s));
  const completedSettlements = mySettlements.filter(s => isSettlementCompleteForSeller(s));
  const pendingAmount = pendingSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || Number(s.marginAmount) || 0), 0);
  const completedAmount = completedSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || Number(s.marginAmount) || 0), 0);
  
  // TOP 5 상품
  const topProducts = Object.values(salesByProduct)
    .filter(p => p.totalAmount > 0)
    .sort((a, b) => b.totalQty - a.totalQty)
    .slice(0, 5);
  
  // TOP 브랜드
  const topBrands = Object.values(salesByBrand)
    .filter(b => b.totalAmount > 0)
    .sort((a, b) => b.totalAmount - a.totalAmount)
    .slice(0, 5);
  
  // 진행 중 공구 상세 정보
  const myDeals = state.deals.filter(d => d.sellerId === state.currentUser.id);
  const today = new Date();
  today.setHours(0,0,0,0);
  
  const ongoingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    const end = new Date(d.endDate);
    return today >= start && today <= end;
  });
  
  const upcomingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    return today < start;
  }).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
  
  // 진행 중 공구 상세 카드 HTML - 진행/예정 분리
  let ongoingDealsDetailHtml = '';
  
  // 진행중 공구 카드
  if (ongoingDeals.length > 0) {
    let ongoingCards = ongoingDeals.map(d => {
      const supplier = state.suppliers.find(s => s.id === d.supplierId);
      const products = d.selectedProducts || [];
      const productNames = products.map(p => {
        if (typeof p === 'string') {
          const prod = state.supplierProducts.find(sp => sp.id === p);
          return prod?.productName || '상품';
        }
        return p.productName || '상품';
      }).slice(0, 2);
      
      return `
        <div style="padding: 14px; background: linear-gradient(145deg, #fff5eb, #ffffff); border-radius: 10px; border: 1px solid rgba(252,150,0,0.2); cursor: pointer;" onclick="openDealModal('${d.id}')">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="flex: 1;">
              <div style="font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 2px;">${supplier?.name || '-'}</div>
              <div style="font-weight: 700; font-size: 13px; color: var(--gray-800);">${productNames.join(', ')}${products.length > 2 ? ' 외' : ''}</div>
            </div>
            <span style="background: var(--primary); color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">진행중</span>
          </div>
          <div style="font-size: 11px; color: var(--gray-500);">${d.startDate} ~ ${d.endDate}</div>
        </div>
      `;
    }).join('');
    
    ongoingDealsDetailHtml += `
      <div class="card" style="margin-bottom: 12px; border-left: 4px solid var(--primary);">
        <h3 class="card-title" style="font-size: 14px;">🔥 진행중 공구 <span style="color: var(--primary);">(${ongoingDeals.length})</span></h3>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${ongoingCards}
        </div>
      </div>
    `;
  }
  
  // TOP 5 상품 HTML
  let topProductsHtml = '';
  if (topProducts.length === 0) {
    topProductsHtml = `
      <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
        <div style="font-size: 28px; margin-bottom: 8px;">📦</div>
        <p style="font-size: 12px;">아직 판매 데이터가 없습니다.</p>
      </div>
    `;
  } else {
    topProductsHtml = topProducts.map((p, idx) => {
      const bgColor = idx === 0 ? 'linear-gradient(135deg, #dc2626, #f97316)' : idx === 1 ? 'linear-gradient(135deg, #ea580c, #f59e0b)' : idx === 2 ? 'linear-gradient(135deg, #f59e0b, #fbbf24)' : 'var(--gray-200)';
      const textColor = idx < 3 ? 'white' : 'var(--gray-600)';
      const borderStyle = idx < topProducts.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : '';
      return `
        <div style="display: flex; align-items: center; padding: 8px 0; ${borderStyle}">
          <div style="width: 22px; height: 22px; background: ${bgColor}; color: ${textColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; margin-right: 10px;">${idx + 1}</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: var(--gray-800); font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div>
          </div>
          <div style="font-weight: 700; color: var(--primary); font-size: 11px; margin-left: 8px;">${p.totalQty}개</div>
        </div>
      `;
    }).join('');
  }
  
  // TOP 브랜드 HTML
  let topBrandsHtml = '';
  if (topBrands.length === 0) {
    topBrandsHtml = `
      <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
        <div style="font-size: 28px; margin-bottom: 8px;">🏆</div>
        <p style="font-size: 12px;">아직 판매 데이터가 없습니다.</p>
      </div>
    `;
  } else {
    topBrandsHtml = topBrands.map((b, idx) => {
      const bgColor = idx === 0 ? 'linear-gradient(135deg, #dc2626, #f97316)' : idx === 1 ? 'linear-gradient(135deg, #ea580c, #f59e0b)' : idx === 2 ? 'linear-gradient(135deg, #f59e0b, #fbbf24)' : 'var(--gray-200)';
      const textColor = idx < 3 ? 'white' : 'var(--gray-600)';
      const borderStyle = idx < topBrands.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : '';
      return `
        <div style="display: flex; align-items: center; padding: 8px 0; ${borderStyle}">
          <div style="width: 22px; height: 22px; background: ${bgColor}; color: ${textColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; margin-right: 10px;">${idx + 1}</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: var(--gray-800); font-size: 12px;">${b.brandName}</div>
          </div>
          <div style="font-weight: 700; color: #dc2626; font-size: 11px; margin-left: 8px;">${formatNumber(b.totalAmount)}원</div>
        </div>
      `;
    }).join('');
  }
  
  // 셀러 이름 추출 (성 제외, 이름만)
  const sellerFullName = state.currentUser.name?.split('/')[0] || state.currentUser.name || '';
  // 이름만 추출 (성 제외) - 한글 이름은 보통 2-3글자이므로 마지막 1-2글자
  const sellerFirstName = sellerFullName.length > 1 ? sellerFullName.slice(1) : sellerFullName;
  
  // 매일 다른 감성 멘트 (날짜 기반)
  const motivationalMessages = [
    { greeting: '오늘도 힘내세요!', message: '모여라딜은 언제나 함께합니다 💪' },
    { greeting: '수고 많으셨어요!', message: '당신의 노력이 빛나는 하루였어요 ✨' },
    { greeting: '오늘 하루도 파이팅!', message: '모여라딜은 당신 덕분에 자라고 있어요 🌱' },
    { greeting: '좋은 하루 되세요!', message: '함께해서 행복해요 🧡' },
    { greeting: '늘 응원합니다!', message: '오늘도 멋진 성과 기대할게요 🎯' },
    { greeting: '고생 많으셨어요!', message: '최고의 파트너와 함께해서 영광이에요 🏆' },
    { greeting: '오늘도 감사해요!', message: '좋은 일만 가득하길 바랍니다 🍀' }
  ];
  const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
  const todayMessage = motivationalMessages[dayOfYear % motivationalMessages.length];
  
  return `
    <!-- 진행/예정 공구 (상단 배치) -->
    ${ongoingDealsDetailHtml}
    
    <!-- 판매 요약 -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
      <div class="stat-card highlight" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">공구 진행건</div>
        <div style="font-size: 24px; font-weight: 700;">${totalSalesCount}건</div>
      </div>
      <div class="stat-card highlight" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">총 판매액</div>
        <div style="font-size: 24px; font-weight: 700;">${formatNumber(totalSalesAmount)}원</div>
      </div>
    </div>
    
    <!-- 정산 예정/완료 -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
      <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #2563eb;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 예정</div>
        <div style="font-size: 20px; font-weight: 700; color: #2563eb;">${formatNumber(pendingAmount)}원</div>
        <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${pendingSettlements.length}건</div>
      </div>
      <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #059669;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 완료</div>
        <div style="font-size: 20px; font-weight: 700; color: #059669;">${formatNumber(completedAmount)}원</div>
        <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${completedSettlements.length}건</div>
      </div>
    </div>
    
    <!-- TOP 5 상품 / TOP 브랜드 -->
    <div class="top-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
      <div class="card" style="height: 100%; padding: 16px;">
        <h3 class="card-title" style="font-size: 14px; margin-bottom: 12px;">판매 상품 TOP 5</h3>
        ${topProductsHtml}
      </div>
      
      <div class="card" style="height: 100%; padding: 16px;">
        <h3 class="card-title" style="font-size: 14px; margin-bottom: 12px;">매출 TOP 브랜드</h3>
        ${topBrandsHtml}
      </div>
    </div>
  `;
}

// 공급사 대시보드 매출 통계 렌더링
function renderSupplierDashboardStats() {
  // 내 공급사 정산 데이터 (supplierSettlements에서 필터) - 더 유연한 매칭
  const mySupplierSettlements = (state.supplierSettlements || []).filter(s => {
    const brandName = (s.brandName || '').trim().toLowerCase();
    const currentName = (state.currentUser.name || '').trim().toLowerCase();
    const currentId = state.currentUser.id || '';
    
    // 1. ID로 정확히 매칭 (가장 우선)
    if (s.supplierId && s.supplierId === currentId) return true;
    
    // 2. 이름 정확히 일치
    if (brandName === currentName) return true;
    
    // 3. 부분 일치 (공백, 특수문자 무시)
    const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
    const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
    if (cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand)) return true;
    
    return false;
  });
  
  // 🆕 자사 상품 (sellerSettlements에서 inhouse인 것 중 내 브랜드)
  const myInhouseSettlements = (state.settlements || []).filter(s => {
    if (s.productType !== 'inhouse') return false;
    
    const brandName = (s.brandName || '').trim().toLowerCase();
    const currentName = (state.currentUser.name || '').trim().toLowerCase();
    const currentId = state.currentUser.id || '';
    
    // supplierId 매칭
    if (s.supplierId && s.supplierId === currentId) return true;
    
    // 브랜드명 매칭
    if (brandName === currentName) return true;
    
    // 부분 일치
    const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
    const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
    if (cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand)) return true;
    
    return false;
  });
  
  // 자사 상품을 공급사 정산 형식으로 변환 (판매금액 = 공급사 매출)
  const inhouseAsSupplier = myInhouseSettlements.map(s => ({
    ...s,
    // 자사 상품의 경우: 판매금액이 공급사 매출
    totalAmount: Number(s.salesAmount) || 0,
    salesAmount: Number(s.salesAmount) || 0,
    // 자사 상품 셀러 완료 시 → 공급사도 완료로 간주
    isCompleted: s.isSellerCompleted || s.isCompleted || false
  }));
  
  // 모든 정산 데이터 합치기
  const allMySettlements = [...mySupplierSettlements, ...inhouseAsSupplier];
  
  // 총 판매액 계산
  const totalSalesAmount = allMySettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  
  // 정산 예정/완료 금액 - isCompleted로 단순하게 판단
  const pendingSettlements = allMySettlements.filter(s => !s.isCompleted);
  const pendingAmount = pendingSettlements.reduce((sum, s) => sum + (Number(s.totalAmount) || Number(s.salesAmount) || 0), 0);
  
  // 정산 완료 금액
  const completedSettlements = allMySettlements.filter(s => s.isCompleted === true);
  const completedAmount = completedSettlements.reduce((sum, s) => sum + (Number(s.totalAmount) || Number(s.salesAmount) || 0), 0);
  
  // 공급사 이름
  const supplierName = state.currentUser.name || '공급사';
  
  // 매일 다른 감성 멘트
  const motivationalMessages = [
    { greeting: '오늘도 힘내세요!', message: '좋은 제품으로 함께 성장해요 💪' },
    { greeting: '수고 많으셨어요!', message: '당신의 노력이 빛나는 하루였어요 ✨' },
    { greeting: '오늘 하루도 파이팅!', message: '모여라딜은 당신 덕분에 자라고 있어요 🌱' },
    { greeting: '좋은 하루 되세요!', message: '함께해서 행복해요 🧡' },
    { greeting: '늘 응원합니다!', message: '오늘도 멋진 성과 기대할게요 🎯' },
    { greeting: '고생 많으셨어요!', message: '최고의 파트너와 함께해서 영광이에요 🏆' },
    { greeting: '오늘도 감사해요!', message: '좋은 일만 가득하길 바랍니다 🍀' }
  ];
  const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
  const todayMessage = motivationalMessages[dayOfYear % motivationalMessages.length];
  
  return `
    <!-- 매출/정산 요약 -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
      <div class="stat-card highlight" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">공구 진행건</div>
        <div style="font-size: 24px; font-weight: 700;">${allMySettlements.length}건</div>
      </div>
      <div class="stat-card highlight" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">총 판매액</div>
        <div style="font-size: 24px; font-weight: 700;">${formatNumber(totalSalesAmount)}원</div>
      </div>
    </div>
    
    <!-- 정산 현황 -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
      <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #2563eb;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 예정</div>
        <div style="font-size: 20px; font-weight: 700; color: #2563eb;">${formatNumber(pendingAmount)}원</div>
        <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${pendingSettlements.length}건</div>
      </div>
      <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #059669;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 완료</div>
        <div style="font-size: 20px; font-weight: 700; color: #059669;">${formatNumber(completedAmount)}원</div>
        <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${completedSettlements.length}건</div>
      </div>
    </div>
  `;
}

function getMyDeals() {
  if (state.userType === 'supplier') {
    return state.deals.filter(d => d.supplierId === state.currentUser.id);
  } else {
    return state.deals.filter(d => d.sellerId === state.currentUser.id);
  }
}

function renderDealItem(deal, status) {
  let statusClass, statusText, statusColor;
  if (status === 'ongoing') {
    statusClass = 'status-ongoing';
    statusText = '진행중';
    statusColor = '#f97316';
  } else if (status === 'completed') {
    statusClass = 'status-completed';
    statusText = '완료';
    statusColor = '#059669';
  } else {
    statusClass = 'status-upcoming';
    const dday = getDday(deal.startDate);
    statusText = dday === 0 ? 'D-DAY' : `D-${dday}`;
    statusColor = '#2563eb';
  }
  
  // 셀러: 브랜드명만 크게 표시, 상품수는 서브로
  // 공급사: 셀러 닉네임만 표시
  let mainTitle = '';
  let subText = '';
  
  if (state.userType === 'supplier') {
    const seller = state.sellers.find(s => s.id === deal.sellerId);
    if (seller && seller.name) {
      const parts = seller.name.split('/');
      mainTitle = parts.length > 1 ? parts[1] : seller.name;
    }
    subText = `${deal.startDate} ~ ${deal.endDate}`;
  } else {
    // 셀러: 브랜드명 중심
    const supplier = state.suppliers.find(s => s.id === deal.supplierId);
    const products = deal.selectedProducts || [];
    mainTitle = supplier?.name || '브랜드';
    subText = products.length > 0 ? `상품 ${products.length}종` : '';
  }
  
  return `
    <div class="list-item" style="cursor: pointer; padding: 14px 16px;" onclick="event.stopPropagation(); openDealModal('${deal.id}')">
      <div style="flex: 1; min-width: 0;">
        <div style="font-weight: 700; font-size: 15px; color: #111827; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${mainTitle}</div>
        <div style="font-size: 12px; color: #6b7280;">${subText}</div>
      </div>
      <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
        <span style="font-size: 13px; font-weight: 700; color: ${statusColor};">${statusText}</span>
      </div>
    </div>
  `;
}

function getDday(dateStr) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const target = new Date(dateStr);
  target.setHours(0,0,0,0);
  const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
  return diff;
}

// 채널 아이콘 반환 (파트너 포털용)
function getChannelIconPortal(link) {
  if (!link) return '🔗';
  const lower = link.toLowerCase();
  if (lower.includes('instagram')) return '📷';
  if (lower.includes('youtube')) return '🎬';
  if (lower.includes('naver') || lower.includes('blog')) return '📝';
  if (lower.includes('kakao')) return '💬';
  if (lower.includes('tiktok')) return '🎵';
  return '🔗';
}

// ===== 캘린더 =====
let calendarYear, calendarMonth;

function renderCalendar(container) {
  const today = new Date();
  const todayStr = formatDate(today);
  if (!calendarYear) calendarYear = today.getFullYear();
  if (!calendarMonth) calendarMonth = today.getMonth();
  
  const myDeals = getMyDeals();
  const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
  const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
  const prevMonthDays = new Date(calendarYear, calendarMonth, 0).getDate();
  
  // 🚀 다가오는 공구 계산 (D-day) - 상단에 표시
  const upcomingDealsWithDday = myDeals.filter(d => d.startDate > todayStr).map(d => {
    const start = new Date(d.startDate);
    const diffTime = start.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return { ...d, dDay: diffDays };
  }).sort((a, b) => a.dDay - b.dDay);
  
  const upcomingSoon = upcomingDealsWithDday.filter(d => d.dDay <= 14).slice(0, 5);
  const upcomingListHtml = upcomingSoon.length > 0 ? `
    <div class="card" style="margin-bottom: 20px; border-left: 4px solid var(--primary);">
      <h3 class="card-title">다가오는 공구</h3>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        ${upcomingSoon.map(d => {
          let displayTitle = d.title;
          let subInfo = '';
          if (state.userType === 'supplier') {
            const seller = state.sellers.find(s => s.id === d.sellerId);
            if (seller && seller.name) {
              const parts = seller.name.split('/');
              displayTitle = parts.length > 1 ? parts[1] : seller.name;
            }
          } else {
            // 셀러인 경우 공급사명 + 상품명
            const supplier = state.suppliers.find(s => s.id === d.supplierId);
            const products = d.selectedProducts || [];
            const productNames = products.map(p => {
              if (typeof p === 'string') {
                const prod = state.supplierProducts.find(sp => sp.id === p);
                return prod?.productName || '상품';
              }
              return p.productName || '상품';
            }).slice(0, 2);
            if (productNames.length > 0) {
              displayTitle = productNames.join(', ') + (products.length > 2 ? ' 외' : '');
            }
            if (supplier?.name) {
              subInfo = supplier.name;
            }
          }
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-50); border-radius: 8px; cursor: pointer;" onclick="openDealModal('${d.id}')">
              <div>
                ${subInfo ? `<div style="font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 2px;">${subInfo}</div>` : ''}
                <span style="font-weight: 600;">${displayTitle}</span>
                <span style="font-size: 12px; color: var(--gray-500); margin-left: 8px;">${d.startDate} ~ ${d.endDate}</span>
              </div>
              <span style="background: linear-gradient(135deg, var(--primary), #f59e0b); color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 700;">D-${d.dDay}</span>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  ` : '';
  
  let calendarDays = '';
  
  // 이전 달
  for (let i = firstDay - 1; i >= 0; i--) {
    calendarDays += `<div class="calendar-day other-month"><div class="day-number">${prevMonthDays - i}</div></div>`;
  }
  
  // 현재 달
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === todayStr;
    const dayOfWeek = new Date(calendarYear, calendarMonth, day).getDay();
    
    const dayDeals = myDeals.filter(d => dateStr >= d.startDate && dateStr <= d.endDate);
    
    let badges = dayDeals.slice(0, 3).map(d => {
      // 공급사인 경우 셀러 닉네임만 표시 (이름 제외)
      // 셀러인 경우 공급사명으로 표시
      let displayTitle = d.title;
      if (state.userType === 'supplier') {
        const seller = state.sellers.find(s => s.id === d.sellerId);
        if (seller && seller.name) {
          const parts = seller.name.split('/');
          displayTitle = parts.length > 1 ? parts[1] : seller.name;
        }
      } else {
        // 셀러인 경우 공급사명으로 표시 (짧게)
        const supplier = state.suppliers.find(s => s.id === d.supplierId);
        if (supplier?.name) {
          displayTitle = supplier.name;
        }
      }
      
      // 완료 여부 확인 (종료일이 오늘 이전)
      const isCompleted = d.endDate < todayStr;
      const badgeStyle = isCompleted ? 'background: var(--gray-300); color: var(--gray-500);' : '';
      
      return `<div class="deal-badge" style="${badgeStyle}" onclick="event.stopPropagation();openDealModal('${d.id}')">${displayTitle}</div>`;
    }).join('');
    
    if (dayDeals.length > 3) {
      badges += `<div style="font-size:11px;color:var(--gray-500);">+${dayDeals.length - 3}개</div>`;
    }
    
    calendarDays += `
      <div class="calendar-day ${isToday ? 'today' : ''}">
        <div class="day-number ${dayOfWeek === 0 ? 'sunday' : ''} ${dayOfWeek === 6 ? 'saturday' : ''}">${day}</div>
        ${badges}
      </div>
    `;
  }
  
  // 다음 달
  const totalCells = firstDay + daysInMonth;
  const nextDays = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
  for (let i = 1; i <= nextDays; i++) {
    calendarDays += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
  }
  
  container.innerHTML = `
    <h1 class="page-title">내 일정</h1>
    <p class="page-desc">내 공구 일정을 확인하세요.</p>
    
    ${upcomingListHtml}
    
    <div class="card">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="changeMonth(-1)">◀</button>
          <span class="calendar-title">${calendarYear}년 ${calendarMonth + 1}월</span>
          <button onclick="changeMonth(1)">▶</button>
        </div>
        <button class="btn btn-secondary" onclick="goToday()">오늘</button>
      </div>
      
      <div class="calendar-grid">
        <div class="calendar-weekday">일</div>
        <div class="calendar-weekday">월</div>
        <div class="calendar-weekday">화</div>
        <div class="calendar-weekday">수</div>
        <div class="calendar-weekday">목</div>
        <div class="calendar-weekday">금</div>
        <div class="calendar-weekday">토</div>
        ${calendarDays}
      </div>
    </div>
  `;
}

function changeMonth(delta) {
  calendarMonth += delta;
  if (calendarMonth < 0) {
    calendarMonth = 11;
    calendarYear--;
  } else if (calendarMonth > 11) {
    calendarMonth = 0;
    calendarYear++;
  }
  renderCalendar(document.getElementById('main-content'));
}

function goToday() {
  const today = new Date();
  calendarYear = today.getFullYear();
  calendarMonth = today.getMonth();
  renderCalendar(document.getElementById('main-content'));
}

// 🆕 판매 베스트 탭 전환
function switchSalesTab(tab) {
  const pendingBtn = document.getElementById('salesTabPending');
  const completedBtn = document.getElementById('salesTabCompleted');
  const pendingContent = document.getElementById('salesContentPending');
  const completedContent = document.getElementById('salesContentCompleted');
  
  if (tab === 'pending') {
    pendingBtn.style.background = 'var(--primary)';
    pendingBtn.style.color = 'white';
    pendingBtn.style.fontWeight = '600';
    completedBtn.style.background = 'white';
    completedBtn.style.color = 'var(--gray-600)';
    completedBtn.style.fontWeight = '500';
    pendingContent.style.display = 'block';
    completedContent.style.display = 'none';
  } else {
    completedBtn.style.background = 'var(--primary)';
    completedBtn.style.color = 'white';
    completedBtn.style.fontWeight = '600';
    pendingBtn.style.background = 'white';
    pendingBtn.style.color = 'var(--gray-600)';
    pendingBtn.style.fontWeight = '500';
    pendingContent.style.display = 'none';
    completedContent.style.display = 'block';
  }
}

// 🆕 셀러 TOP 탭 전환
function switchSellerTab(tab) {
  const pendingBtn = document.getElementById('sellerTabPending');
  const completedBtn = document.getElementById('sellerTabCompleted');
  const pendingContent = document.getElementById('sellerContentPending');
  const completedContent = document.getElementById('sellerContentCompleted');
  
  if (tab === 'pending') {
    pendingBtn.style.background = 'var(--primary)';
    pendingBtn.style.color = 'white';
    pendingBtn.style.fontWeight = '600';
    completedBtn.style.background = 'white';
    completedBtn.style.color = 'var(--gray-600)';
    completedBtn.style.fontWeight = '500';
    pendingContent.style.display = 'block';
    completedContent.style.display = 'none';
  } else {
    completedBtn.style.background = 'var(--primary)';
    completedBtn.style.color = 'white';
    completedBtn.style.fontWeight = '600';
    pendingBtn.style.background = 'white';
    pendingBtn.style.color = 'var(--gray-600)';
    pendingBtn.style.fontWeight = '500';
    pendingContent.style.display = 'none';
    completedContent.style.display = 'block';
  }
}

// ===== 공지사항 =====
function renderNotice(container) {
  const notices = state.notices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const readNotices = JSON.parse(localStorage.getItem('readNotices') || '[]');
  
  container.innerHTML = `
    <h1 class="page-title">공지사항</h1>
    <p class="page-desc">모여라딜의 새로운 소식을 확인하세요.</p>
    
    <div class="card" style="padding: 0; overflow: hidden;">
      ${notices.length === 0 ? `
        <div class="empty-state">
          <div class="icon">📢</div>
          <p>등록된 공지사항이 없습니다.</p>
        </div>
      ` : notices.map(n => {
        const isRead = readNotices.includes(n.id);
        return `
        <div class="notice-item" onclick="openNoticeModal('${n.id}')" style="${!isRead ? 'background: #fffbeb;' : ''}">
          <div style="display: flex; align-items: center; gap: 8px;">
            ${!isRead ? '<span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></span>' : ''}
            <span class="notice-badge ${n.important ? 'important' : 'normal'}">${n.important ? '중요' : '일반'}</span>
            <span class="notice-title">${n.title}</span>
          </div>
          <div class="notice-date">${formatDateKR(n.createdAt)}</div>
        </div>
      `}).join('')}
    </div>
  `;
}

function openNoticeModal(noticeId) {
  const notice = state.notices.find(n => n.id === noticeId);
  if (!notice) return;
  
  // 읽음 처리
  const readNotices = JSON.parse(localStorage.getItem('readNotices') || '[]');
  if (!readNotices.includes(noticeId)) {
    readNotices.push(noticeId);
    localStorage.setItem('readNotices', JSON.stringify(readNotices));
    renderNav(); // 네비게이션 업데이트
    renderNotice(document.getElementById('main-content')); // 목록 업데이트
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">공지사항</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div class="modal-body">
        <h2 style="margin-bottom: 8px;">${notice.title}</h2>
        <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 20px;">${formatDateKR(notice.createdAt)}</p>
        <div style="white-space: pre-wrap; line-height: 1.8;">${notice.content || '내용이 없습니다.'}</div>
      </div>
    </div>
  `;
}

// ===== 소통 =====
function renderMessage(container) {
  const myMessages = state.messages
    .filter(m => m.partnerId === state.currentUser.id && m.partnerType === state.userType)
    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
  
  container.innerHTML = `
    <h1 class="page-title">소통</h1>
    <p class="page-desc">담당자와 1:1로 소통하세요.</p>
    
    <div class="card">
      <div class="message-list" id="message-list">
        ${myMessages.length === 0 ? `
          <div class="empty-state" style="padding: 40px;">
            <div class="icon">💬</div>
            <p>아직 메시지가 없습니다.<br>담당자에게 문의해보세요!</p>
          </div>
        ` : myMessages.map(m => `
          <div class="message-item ${m.isAdmin ? 'admin' : 'mine'}">
            <div class="message-sender">${m.isAdmin ? '모여라딜 담당자' : '나'}</div>
            <div class="message-content">${m.content}</div>
            <div class="message-time">${formatDateKR(m.createdAt)}</div>
          </div>
        `).join('')}
      </div>
      
      <div class="message-input-area">
        <input type="text" class="form-input" id="message-input" placeholder="메시지를 입력하세요..." onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="btn btn-primary" style="width: auto;" onclick="sendMessage()">전송</button>
      </div>
    </div>
  `;
  
  // 스크롤 맨 아래로
  setTimeout(() => {
    const list = document.getElementById('message-list');
    if (list) list.scrollTop = list.scrollHeight;
  }, 100);
}

async function sendMessage() {
  const input = document.getElementById('message-input');
  const content = input.value.trim();
  if (!content) return;
  
  try {
    await db.collection('partnerMessages').add({
      partnerId: state.currentUser.id,
      partnerType: state.userType,
      partnerName: state.currentUser.name,
      content: content,
      isAdmin: false,
      createdAt: new Date().toISOString()
    });
    
    input.value = '';
    showToast('메시지를 전송했습니다.');
  } catch (e) {
    console.error(e);
    showToast('전송에 실패했습니다.');
  }
}

// ===== 상품 등록 (공급사 전용) =====
function renderProducts(container) {
  // supplierId 또는 brandName으로 매칭 (관리시스템 연동)
  const allMyProducts = state.supplierProducts.filter(p => {
    if (p.supplierId === state.currentUser.id) return true;
    if (p.brandName && state.currentUser.name && 
        p.brandName.includes(state.currentUser.name)) return true;
    return false;
  });
  
  // 검색 필터 적용
  const searchKeyword = state.productSearchKeyword || '';
  const myProducts = searchKeyword 
    ? allMyProducts.filter(p => (p.productName || '').toLowerCase().includes(searchKeyword.toLowerCase()))
    : allMyProducts;
  
  container.innerHTML = `
    <div class="product-header">
      <div>
        <h1 class="page-title">상품관리</h1>
        <p class="page-desc">공급 상품을 등록하고 관리하세요.</p>
      </div>
      <div class="product-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="btn" onclick="openProductGroupsPage()" style="background: #fffbeb; color: #d97706; border: 1px solid #fcd34d;">🏷️ 대표상품 관리</button>
        <button class="btn action-btn-secondary" onclick="downloadExcelTemplate()">양식 다운로드</button>
        <button class="btn action-btn-secondary" onclick="openExcelUploadModal()">엑셀 일괄등록</button>
        <button class="btn action-btn-primary" onclick="openProductModal()">+ 상품 등록</button>
      </div>
    </div>
    
    <!-- 검색 영역 -->
    <div class="search-box" style="margin-bottom: 16px;">
      <div style="position: relative;">
        <input type="text" class="form-input" id="product-search" placeholder="상품명 검색 후 Enter" 
          value="${searchKeyword}" 
          onkeydown="if(event.key==='Enter') handleProductSearch(this.value)"
          style="padding-left: 40px;">
        <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--gray-400);">🔍</span>
        ${searchKeyword ? `<button onclick="clearProductSearch()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-400); cursor: pointer; font-size: 18px;">×</button>` : ''}
      </div>
      ${searchKeyword ? `<p style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">"${searchKeyword}" 검색 결과: ${myProducts.length}건</p>` : ''}
    </div>
    
    <div class="card">
      ${myProducts.length === 0 ? `
        <div class="empty-state">
          <div class="icon">📦</div>
          <p>${searchKeyword ? '검색 결과가 없습니다.' : '등록된 상품이 없습니다.<br>상품을 등록해보세요!'}</p>
        </div>
      ` : `
        <!-- PC 테이블 -->
        <div class="product-table-pc">
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="border-bottom: 2px solid var(--gray-200); background: var(--gray-50);">
                <th style="padding: 12px 8px; text-align: left; font-weight: 600;">상품명</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">정가(V+)</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">공구판매가</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">공급가(V+)</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">수수료율</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 600;">공구연결</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 600; width: 120px;"></th>
              </tr>
            </thead>
            <tbody>
              ${myProducts.map(p => {
                const linkedDeals = state.deals.filter(d => {
                  if (!d.selectedProducts) return false;
                  return d.selectedProducts.some(item => {
                    const pid = typeof item === 'string' ? item : item.productId;
                    return pid === p.id;
                  });
                }).length;
                return `
                <tr style="border-bottom: 1px solid var(--gray-100);">
                  <td style="padding: 12px 8px;"><strong>${p.productName || '-'}</strong></td>
                  <td style="padding: 12px 8px; text-align: right;">${Number(p.originalPrice || 0) > 0 ? formatNumber(p.originalPrice) + '원' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right;">${Number(p.salePrice || 0) > 0 ? formatNumber(p.salePrice) + '원' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right; color: var(--primary); font-weight: 600;">${Number(p.supplyPrice || 0) > 0 ? formatNumber(p.supplyPrice) + '원' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right;">${p.commission ? p.commission + '%' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: center;">
                    ${linkedDeals > 0 ? `<span style="background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${linkedDeals}건</span>` : '<span style="color: var(--gray-400);">-</span>'}
                  </td>
                  <td style="padding: 12px 8px; text-align: center;">
                    <div style="display: flex; gap: 4px; justify-content: center;">
                      <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openProductModal('${p.id}')">수정</button>
                      <button class="btn" style="padding: 6px 12px; font-size: 12px; background: #fee2e2; color: #dc2626;" onclick="deleteProduct('${p.id}')">삭제</button>
                    </div>
                  </td>
                </tr>
              `;}).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- 모바일 카드 리스트 -->
        <div class="product-list-mobile">
          ${myProducts.map(p => {
            const linkedDeals = state.deals.filter(d => {
              if (!d.selectedProducts) return false;
              return d.selectedProducts.some(item => {
                const pid = typeof item === 'string' ? item : item.productId;
                return pid === p.id;
              });
            }).length;
            return `
            <div class="product-card-mobile">
              <div class="product-name-mobile">${p.productName || '-'}</div>
              <div class="product-info-mobile">
                <div class="info-row">
                  <span class="info-label">정가</span>
                  <span class="info-value">${Number(p.originalPrice || 0) > 0 ? formatNumber(p.originalPrice) + '원' : '-'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">공구가</span>
                  <span class="info-value">${Number(p.salePrice || 0) > 0 ? formatNumber(p.salePrice) + '원' : '-'}</span>
                </div>
                <div class="info-row highlight">
                  <span class="info-label">공급가(V+)</span>
                  <span class="info-value primary">${Number(p.supplyPrice || 0) > 0 ? formatNumber(p.supplyPrice) + '원' : '-'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">수수료</span>
                  <span class="info-value">${p.commission ? p.commission + '%' : '-'}</span>
                </div>
                ${linkedDeals > 0 ? `<div class="info-row"><span class="info-label">공구연결</span><span class="info-value"><span class="deal-count">${linkedDeals}건</span></span></div>` : ''}
              </div>
              <div class="product-actions-mobile">
                <button class="btn btn-secondary" onclick="openProductModal('${p.id}')">수정</button>
                <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">삭제</button>
              </div>
            </div>
          `;}).join('')}
        </div>
      `}
    </div>
  `;
}

// 상품 검색 핸들러
function handleProductSearch(keyword) {
  state.productSearchKeyword = keyword.trim();
  renderPage('products');
}

function clearProductSearch() {
  state.productSearchKeyword = '';
  renderPage('products');
}

function openProductModal(productId) {
  const product = productId ? state.supplierProducts.find(p => p.id === productId) : null;
  const isEdit = !!product;
  
  // 내 대표상품 그룹 목록
  const myProductGroups = (state.productGroups || []).filter(pg => {
    if (state.userType === 'supplier') {
      return pg.supplierId === state.currentUser?.id;
    }
    return true;
  });
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">${isEdit ? '상품 수정' : '상품 등록'}</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form onsubmit="saveProduct(event, '${productId || ''}')">
        <div class="modal-body">
          <!-- 대표상품 그룹 선택 -->
          <div class="form-group">
            <label class="form-label">대표상품 그룹</label>
            <div style="display: flex; gap: 8px;">
              <select class="form-select" id="prod-group" style="flex: 1;">
                <option value="">선택 안함 (개별 상품)</option>
                ${myProductGroups.map(pg => `
                  <option value="${pg.id}" ${product?.productGroupId === pg.id ? 'selected' : ''}>${pg.groupName}</option>
                `).join('')}
              </select>
              <button type="button" class="btn btn-secondary" onclick="openProductGroupModal()" style="white-space: nowrap;">+ 새 그룹</button>
            </div>
            <small style="color: var(--gray-500); font-size: 11px; margin-top: 4px; display: block;">
              💡 같은 상품의 용량별 변형(30팩, 60팩 등)은 하나의 그룹으로 묶으면 챗봇 FAQ를 공유합니다
            </small>
          </div>
          
          <div class="form-group">
            <label class="form-label">상품명 *</label>
            <input type="text" class="form-input" id="prod-name" value="${product?.productName || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">정가 (원)</label>
            <input type="number" class="form-input" id="prod-original" value="${product?.originalPrice || ''}">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">공급가 (V+, 원)</label>
              <input type="number" class="form-input" id="prod-supply" value="${product?.supplyPrice || ''}" oninput="calcCommissionFromSupply()">
              <small style="color: var(--gray-500); font-size: 11px;">수수료와 둘 중 하나만 입력</small>
            </div>
            <div class="form-group">
              <label class="form-label">수수료 (%)</label>
              <input type="number" class="form-input" id="prod-commission" value="${product?.commission || ''}" step="0.1" oninput="calcSupplyFromCommission()">
              <small style="color: var(--gray-500); font-size: 11px;">공급가와 둘 중 하나만 입력</small>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">공동구매 판매가 (원)</label>
            <input type="number" class="form-input" id="prod-sale" value="${product?.salePrice || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">상품 설명</label>
            <textarea class="form-textarea" id="prod-desc" rows="3">${product?.description || ''}</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button type="submit" class="btn btn-primary" style="width: auto;">${isEdit ? '수정' : '등록'}</button>
        </div>
      </form>
    </div>
  `;
}

// 공급가 → 수수료 자동계산
function calcCommissionFromSupply() {
  const supply = Number(document.getElementById('prod-supply').value);
  const sale = Number(document.getElementById('prod-sale').value);
  if (supply && sale && sale > 0) {
    const commission = ((sale - supply) / sale * 100).toFixed(1);
    document.getElementById('prod-commission').value = commission;
  }
}

// 수수료 → 공급가 자동계산
function calcSupplyFromCommission() {
  const commission = Number(document.getElementById('prod-commission').value);
  const sale = Number(document.getElementById('prod-sale').value);
  if (commission && sale && sale > 0) {
    const supply = Math.round(sale * (1 - commission / 100));
    document.getElementById('prod-supply').value = supply;
  }
}

// ============================================================
// 대표상품 그룹 관리 (Product Groups)
// ============================================================

// 대표상품 그룹 생성/수정 모달
function openProductGroupModal(groupId = null) {
  const group = groupId ? (state.productGroups || []).find(g => g.id === groupId) : null;
  const isEdit = !!group;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">🏷️ ${isEdit ? '대표상품 수정' : '대표상품 그룹 생성'}</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form onsubmit="saveProductGroup(event, '${groupId || ''}')">
        <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
          
          <!-- 기본 정보 -->
          <div style="background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--gray-700);">📦 기본 정보</h4>
            <div class="form-group">
              <label class="form-label">대표상품명 *</label>
              <input type="text" class="form-input" id="pg-name" value="${group?.groupName || ''}" required placeholder="예: 배도라지 주스">
              <small style="color: var(--gray-500); font-size: 11px;">용량 제외한 공통 상품명 (30팩, 60팩 등은 개별 상품에서 구분)</small>
            </div>
            <div class="form-group">
              <label class="form-label">한줄 소개</label>
              <input type="text" class="form-input" id="pg-intro" value="${group?.intro || ''}" placeholder="예: 환절기 필수템! 목에 좋은 배도라지">
            </div>
          </div>
          
          <!-- 상품 상세 정보 (챗봇용) -->
          <div style="background: #fffbeb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <h4 style="font-size: 14px; margin-bottom: 12px; color: #d97706;">💬 챗봇 답변용 상세정보</h4>
            <div class="form-group">
              <label class="form-label">주요 성분/원료</label>
              <input type="text" class="form-input" id="pg-ingredients" value="${group?.baseInfo?.ingredients || ''}" placeholder="예: 배, 도라지, 생강, 꿀">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label class="form-label">보관방법</label>
                <input type="text" class="form-input" id="pg-storage" value="${group?.baseInfo?.storage || ''}" placeholder="예: 실온보관">
              </div>
              <div class="form-group">
                <label class="form-label">유통기한</label>
                <input type="text" class="form-input" id="pg-shelflife" value="${group?.baseInfo?.shelfLife || ''}" placeholder="예: 제조일로부터 12개월">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">권장 대상</label>
              <input type="text" class="form-input" id="pg-target" value="${group?.baseInfo?.target || ''}" placeholder="예: 환절기 목 관리가 필요한 분, 3세 이상">
            </div>
            <div class="form-group">
              <label class="form-label">상품 특장점</label>
              <textarea class="form-textarea" id="pg-features" rows="2" placeholder="예: 국내산 배 100%, 무설탕, HACCP 인증">${group?.baseInfo?.features || ''}</textarea>
            </div>
          </div>
          
          <!-- 정책 정보 -->
          <div style="background: #eff6ff; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <h4 style="font-size: 14px; margin-bottom: 12px; color: #2563eb;">📋 공급사 정책</h4>
            <div class="form-group">
              <label class="form-label">배송 안내</label>
              <input type="text" class="form-input" id="pg-shipping" value="${group?.policies?.shipping || '공구 마감 다음날 일괄발송, 발송 후 1-2일 수령'}" placeholder="예: 공구 마감 다음날 일괄발송">
            </div>
            <div class="form-group">
              <label class="form-label">교환/환불 정책</label>
              <input type="text" class="form-input" id="pg-exchange" value="${group?.policies?.exchange || '단순변심 7일 이내, 제품 하자 시 무료 교환/환불'}" placeholder="예: 단순변심 7일, 하자시 무료교환">
            </div>
          </div>
          
          <!-- FAQ (고도화) -->
          <div style="background: #f0fdf4; padding: 16px; border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h4 style="font-size: 14px; color: #16a34a; margin: 0;">❓ 자주 묻는 질문 (FAQ)</h4>
              <button type="button" class="btn btn-secondary" onclick="addFaqRow()" style="padding: 6px 12px; font-size: 12px;">+ 질문 추가</button>
            </div>
            <div id="faq-container">
              ${(group?.faqs || []).length > 0 ? group.faqs.map((faq, idx) => `
                <div class="faq-row" style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 12px; font-weight: 600; color: var(--gray-500);">Q${idx + 1}</span>
                    <button type="button" onclick="this.closest('.faq-row').remove()" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 16px;">×</button>
                  </div>
                  <input type="text" class="form-input faq-question" value="${faq.q}" placeholder="질문" style="margin-bottom: 6px; font-size: 13px;">
                  <input type="text" class="form-input faq-answer" value="${faq.a}" placeholder="답변" style="font-size: 13px;">
                </div>
              `).join('') : `
                <div style="text-align: center; padding: 20px; color: var(--gray-400); font-size: 13px;">
                  FAQ를 추가하면 셀러 챗봇이 더 똑똑해져요!
                </div>
              `}
            </div>
          </div>
          
        </div>
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn" style="color: var(--danger);" onclick="deleteProductGroup('${groupId}')">삭제</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button type="submit" class="btn btn-primary">${isEdit ? '수정' : '생성'}</button>
        </div>
      </form>
    </div>
  `;
}

// FAQ 행 추가
function addFaqRow() {
  const container = document.getElementById('faq-container');
  // 기존 안내 메시지 제거
  const placeholder = container.querySelector('[style*="text-align: center"]');
  if (placeholder) placeholder.remove();
  
  const idx = container.querySelectorAll('.faq-row').length + 1;
  const row = document.createElement('div');
  row.className = 'faq-row';
  row.style.cssText = 'background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;';
  row.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <span style="font-size: 12px; font-weight: 600; color: var(--gray-500);">Q${idx}</span>
      <button type="button" onclick="this.closest('.faq-row').remove()" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 16px;">×</button>
    </div>
    <input type="text" class="form-input faq-question" placeholder="질문 (예: 아이도 먹을 수 있나요?)" style="margin-bottom: 6px; font-size: 13px;">
    <input type="text" class="form-input faq-answer" placeholder="답변 (예: 3세 이상 권장합니다)" style="font-size: 13px;">
  `;
  container.appendChild(row);
}

// 대표상품 그룹 저장
async function saveProductGroup(e, groupId) {
  e.preventDefault();
  
  // FAQ 수집
  const faqs = Array.from(document.querySelectorAll('.faq-row')).map(row => ({
    q: row.querySelector('.faq-question')?.value?.trim() || '',
    a: row.querySelector('.faq-answer')?.value?.trim() || ''
  })).filter(faq => faq.q && faq.a);
  
  const data = {
    groupName: document.getElementById('pg-name').value.trim(),
    intro: document.getElementById('pg-intro').value.trim(),
    baseInfo: {
      ingredients: document.getElementById('pg-ingredients').value.trim(),
      storage: document.getElementById('pg-storage').value.trim(),
      shelfLife: document.getElementById('pg-shelflife').value.trim(),
      target: document.getElementById('pg-target').value.trim(),
      features: document.getElementById('pg-features').value.trim()
    },
    policies: {
      shipping: document.getElementById('pg-shipping').value.trim(),
      exchange: document.getElementById('pg-exchange').value.trim()
    },
    faqs: faqs,
    supplierId: state.currentUser?.id || '',
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (groupId) {
      await db.collection('productGroups').doc(groupId).update(data);
      showToast('대표상품이 수정되었습니다.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('productGroups').add(data);
      showToast('대표상품 그룹이 생성되었습니다.');
    }
    closeModal();
  } catch (err) {
    console.error(err);
    showToast('저장에 실패했습니다.');
  }
}

// 대표상품 그룹 삭제
async function deleteProductGroup(groupId) {
  if (!confirm('이 대표상품 그룹을 삭제하시겠습니까?\n연결된 상품들은 그룹 없음 상태가 됩니다.')) return;
  
  try {
    await db.collection('productGroups').doc(groupId).delete();
    showToast('대표상품 그룹이 삭제되었습니다.');
    closeModal();
  } catch (err) {
    console.error(err);
    showToast('삭제에 실패했습니다.');
  }
}

// 대표상품 관리 페이지 열기
function openProductGroupsPage() {
  const myGroups = (state.productGroups || []).filter(pg => {
    if (state.userType === 'supplier') {
      return pg.supplierId === state.currentUser?.id;
    }
    return true;
  });
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 650px;">
      <div class="modal-header">
        <h3 class="modal-title">🏷️ 대표상품 관리</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <p style="font-size: 13px; color: var(--gray-500); margin: 0;">
            대표상품별 상세정보와 FAQ를 관리하면 셀러 챗봇이 자동으로 학습합니다.
          </p>
          <button class="btn btn-primary" onclick="openProductGroupModal()" style="white-space: nowrap;">+ 새 그룹</button>
        </div>
        
        ${myGroups.length > 0 ? `
          <div style="display: flex; flex-direction: column; gap: 12px;">
            ${myGroups.map(pg => {
              const linkedProducts = state.supplierProducts.filter(p => p.productGroupId === pg.id);
              const faqCount = (pg.faqs || []).length;
              return `
                <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; cursor: pointer;" onclick="openProductGroupModal('${pg.id}')">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                      <h4 style="font-size: 15px; font-weight: 700; margin-bottom: 4px;">${pg.groupName}</h4>
                      <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">${pg.intro || '소개 없음'}</p>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="padding: 3px 8px; background: #dbeafe; color: #2563eb; border-radius: 4px; font-size: 11px;">상품 ${linkedProducts.length}개</span>
                        <span style="padding: 3px 8px; background: ${faqCount > 0 ? '#dcfce7' : '#f3f4f6'}; color: ${faqCount > 0 ? '#16a34a' : '#9ca3af'}; border-radius: 4px; font-size: 11px;">FAQ ${faqCount}개</span>
                        ${pg.baseInfo?.ingredients ? `<span style="padding: 3px 8px; background: #fef3c7; color: #d97706; border-radius: 4px; font-size: 11px;">상세정보 ✓</span>` : ''}
                      </div>
                    </div>
                    <span style="color: var(--gray-400);">›</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        ` : `
          <div style="text-align: center; padding: 40px; color: var(--gray-400);">
            <div style="font-size: 48px; margin-bottom: 12px;">🏷️</div>
            <p>등록된 대표상품 그룹이 없습니다.</p>
            <p style="font-size: 13px;">상품을 그룹으로 묶으면 챗봇 FAQ를 효율적으로 관리할 수 있어요.</p>
          </div>
        `}
      </div>
    </div>
  `;
}

// 엑셀 일괄 업로드 모달
function openExcelUploadModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">📥 엑셀 일괄등록</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div class="modal-body">
        <div style="background: var(--info-light); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="color: var(--info); margin-bottom: 8px;">📋 엑셀 양식 안내</h4>
          <p style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px;">
            아래 열 순서대로 데이터를 입력해주세요.<br>
            <strong>첫 번째 행은 헤더로 인식되어 제외됩니다.</strong>
          </p>
          <table style="width: 100%; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
              <tr style="background: var(--gray-100);">
                <th style="padding: 8px; text-align: left;">A</th>
                <th style="padding: 8px; text-align: left;">B</th>
                <th style="padding: 8px; text-align: left;">C</th>
                <th style="padding: 8px; text-align: left;">D</th>
                <th style="padding: 8px; text-align: left;">E</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 8px;">상품명*</td>
                <td style="padding: 8px;">정가</td>
                <td style="padding: 8px;">공급가(V+)</td>
                <td style="padding: 8px;">공구판매가</td>
                <td style="padding: 8px;">수수료(%)</td>
              </tr>
            </tbody>
          </table>
          <p style="font-size: 11px; color: var(--gray-500); margin-top: 8px;">
            * 공급가와 수수료는 둘 중 하나만 입력하면 자동 계산됩니다.
          </p>
        </div>
        
        <div style="margin-bottom: 16px;">
          <button class="btn btn-secondary" style="width: 100%;" onclick="downloadExcelTemplate()">
            📥 엑셀 양식 다운로드
          </button>
        </div>
        
        <div class="form-group">
          <label class="form-label">엑셀 파일 선택</label>
          <input type="file" class="form-input" id="excel-file" accept=".xlsx,.xls,.csv" style="padding: 12px;">
        </div>
        
        <div id="excel-preview" style="display: none; margin-top: 16px;">
          <h4 style="margin-bottom: 12px;">미리보기</h4>
          <div id="excel-preview-content" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
        <button type="button" class="btn btn-primary" style="width: auto;" onclick="uploadExcelProducts()">일괄 등록</button>
      </div>
    </div>
  `;
  
  // 파일 선택 시 미리보기
  document.getElementById('excel-file').addEventListener('change', previewExcel);
}

// 엑셀 양식 다운로드
function downloadExcelTemplate() {
  const csvContent = "상품명,정가,공급가(V+),공구판매가,수수료(%)\n예시상품,50000,35000,40000,12.5";
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = '상품등록_양식.csv';
  link.click();
}

// 엑셀 미리보기
async function previewExcel(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const preview = document.getElementById('excel-preview');
  const content = document.getElementById('excel-preview-content');
  
  try {
    const data = await parseExcelFile(file);
    if (data.length === 0) {
      content.innerHTML = '<p style="color: var(--danger);">데이터가 없습니다.</p>';
      preview.style.display = 'block';
      return;
    }
    
    // 헤더 제외
    const rows = data.slice(1);
    window.excelData = rows;
    
    content.innerHTML = `
      <p style="margin-bottom: 8px; color: var(--success);">✓ ${rows.length}개 상품 확인됨</p>
      <table class="data-table" style="font-size: 12px;">
        <thead>
          <tr>
            <th>상품명</th>
            <th>정가</th>
            <th>공급가</th>
            <th>판매가</th>
            <th>수수료</th>
          </tr>
        </thead>
        <tbody>
          ${rows.slice(0, 5).map(row => `
            <tr>
              <td>${row[0] || '-'}</td>
              <td>${row[1] ? formatNumber(row[1]) + '원' : '-'}</td>
              <td>${row[2] ? formatNumber(row[2]) + '원' : '-'}</td>
              <td>${row[3] ? formatNumber(row[3]) + '원' : '-'}</td>
              <td>${row[4] ? row[4] + '%' : '-'}</td>
            </tr>
          `).join('')}
          ${rows.length > 5 ? `<tr><td colspan="5" style="text-align:center; color: var(--gray-500);">... 외 ${rows.length - 5}개</td></tr>` : ''}
        </tbody>
      </table>
    `;
    preview.style.display = 'block';
  } catch (err) {
    content.innerHTML = `<p style="color: var(--danger);">파일 읽기 실패: ${err.message}</p>`;
    preview.style.display = 'block';
  }
}

// 엑셀 파일 파싱
function parseExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = e.target.result;
        if (file.name.endsWith('.csv')) {
          // CSV 파싱
          const rows = data.split('\n').map(row => row.split(',').map(cell => cell.trim().replace(/^"|"$/g, '')));
          resolve(rows.filter(row => row.some(cell => cell)));
        } else {
          // XLSX 파싱 (SheetJS 사용)
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          resolve(rows);
        }
      } catch (err) {
        reject(err);
      }
    };
    reader.onerror = () => reject(new Error('파일 읽기 실패'));
    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsBinaryString(file);
    }
  });
}

// 엑셀 일괄 업로드
async function uploadExcelProducts() {
  if (!window.excelData || window.excelData.length === 0) {
    showToast('업로드할 데이터가 없습니다.');
    return;
  }
  
  try {
    const batch = db.batch();
    let count = 0;
    
    for (const row of window.excelData) {
      const productName = row[0];
      if (!productName) continue;
      
      const originalPrice = Number(row[1]) || 0;
      const supplyPrice = Number(row[2]) || 0;
      const salePrice = Number(row[3]) || 0;
      let commission = Number(row[4]) || 0;
      
      // 공급가만 있고 수수료가 없으면 자동계산
      if (supplyPrice && !commission && salePrice) {
        commission = parseFloat(((salePrice - supplyPrice) / salePrice * 100).toFixed(1));
      }
      
      // 수수료만 있고 공급가가 없으면 자동계산
      let finalSupplyPrice = supplyPrice;
      if (!supplyPrice && commission && salePrice) {
        finalSupplyPrice = Math.round(salePrice * (1 - commission / 100));
      }
      
      const docRef = db.collection('supplierProducts').doc();
      batch.set(docRef, {
        supplierId: state.currentUser.id,
        brandName: state.currentUser.name,
        productName,
        originalPrice,
        supplyPrice: finalSupplyPrice,
        salePrice,
        commission,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
      count++;
    }
    
    await batch.commit();
    showToast(`${count}개 상품이 등록되었습니다.`);
    closeModal();
    window.excelData = null;
  } catch (err) {
    console.error(err);
    showToast('등록에 실패했습니다.');
  }
}

async function saveProduct(e, productId) {
  e.preventDefault();
  
  const productGroupId = document.getElementById('prod-group')?.value || '';
  
  const data = {
    supplierId: state.currentUser.id,
    brandName: state.currentUser.name,
    productName: document.getElementById('prod-name').value,
    productGroupId: productGroupId,  // 대표상품 그룹 ID
    originalPrice: Number(document.getElementById('prod-original').value) || 0,
    supplyPrice: Number(document.getElementById('prod-supply').value) || 0,
    salePrice: Number(document.getElementById('prod-sale').value) || 0,
    commission: Number(document.getElementById('prod-commission').value) || 0,
    description: document.getElementById('prod-desc').value,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (productId) {
      await db.collection('supplierProducts').doc(productId).update(data);
      showToast('상품이 수정되었습니다.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('supplierProducts').add(data);
      showToast('상품이 등록되었습니다.');
    }
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('저장에 실패했습니다.');
  }
}

// 상품 삭제
async function deleteProduct(productId) {
  if (!confirm('이 상품을 삭제하시겠습니까?')) return;
  
  try {
    await db.collection('supplierProducts').doc(productId).delete();
    showToast('상품이 삭제되었습니다.');
  } catch (e) {
    console.error(e);
    showToast('삭제에 실패했습니다.');
  }
}

// ===== 긴급판매요청 (공급사 전용) =====
function renderUrgentSales(container) {
  // 내 긴급판매요청 목록
  const myUrgentSales = (state.urgentSales || []).filter(u => 
    u.supplierId === state.currentUser.id || 
    (u.brandName && state.currentUser.name && u.brandName.includes(state.currentUser.name))
  ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  container.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h1 class="page-title" style="margin-bottom: 8px;">긴급판매요청</h1>
      <p class="page-desc" style="font-size: 14px; line-height: 1.6;">빨리 판매가 필요한 상품을 등록해주세요.</p>
    </div>
    
    <!-- 요청등록 버튼 (눈에 띄게) -->
    <div style="margin-bottom: 20px;">
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; border-radius: 12px;" onclick="openUrgentSalesModal()">
        + 요청등록
      </button>
    </div>
    
    <div class="card">
      <h3 class="card-title" style="margin-bottom: 16px;">등록된 요청 (${myUrgentSales.length}건)</h3>
      ${myUrgentSales.length === 0 ? `
        <div class="empty-state" style="padding: 40px 20px;">
          <div class="icon" style="font-size: 48px; margin-bottom: 12px;">🚨</div>
          <p style="font-size: 14px; line-height: 1.6;">등록된 긴급판매요청이 없습니다.<br>신상품 홍보나 재고 처리가 필요하시면<br>등록해주세요!</p>
        </div>
      ` : `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          ${myUrgentSales.map(u => `
            <div style="padding: 16px; background: ${u.status === 'completed' ? 'var(--gray-50)' : u.urgencyLevel === 'high' ? '#fef2f2' : u.urgencyLevel === 'medium' ? '#fffbeb' : 'var(--gray-50)'}; border-radius: 12px; border-left: 4px solid ${u.status === 'completed' ? 'var(--gray-300)' : u.urgencyLevel === 'high' ? '#dc2626' : u.urgencyLevel === 'medium' ? '#f59e0b' : 'var(--gray-400)'};">
              <!-- 상단: 상품명 + 상태 -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 700; font-size: 16px; color: var(--gray-800); margin-bottom: 4px; word-break: break-word;">${u.productName}</div>
                  <span style="display: inline-block; font-size: 12px; padding: 3px 10px; border-radius: 12px; background: ${u.type === 'new' ? '#dbeafe' : '#fef3c7'}; color: ${u.type === 'new' ? '#1d4ed8' : '#b45309'};">${u.type === 'new' ? '신상품' : '재고처리'}</span>
                </div>
                <span style="flex-shrink: 0; font-size: 12px; padding: 6px 12px; border-radius: 12px; background: ${u.status === 'completed' ? 'var(--gray-200)' : u.status === 'processing' ? '#dcfce7' : '#fef3c7'}; color: ${u.status === 'completed' ? 'var(--gray-500)' : u.status === 'processing' ? '#166534' : '#b45309'}; font-weight: 500;">
                  ${u.status === 'completed' ? '완료' : u.status === 'processing' ? '진행중' : '대기'}
                </span>
              </div>
              
              <!-- 중간: 수량, 희망일 -->
              <div style="display: flex; gap: 16px; font-size: 14px; color: var(--gray-600); margin-bottom: 12px;">
                <span>수량: <strong>${u.quantity?.toLocaleString() || '-'}개</strong></span>
                ${u.targetDate ? `<span>희망일: <strong>${u.targetDate}</strong></span>` : ''}
              </div>
              
              <!-- 메모 -->
              ${u.memo ? `<div style="font-size: 13px; color: var(--gray-500); background: white; padding: 10px 14px; border-radius: 8px; margin-bottom: 12px; line-height: 1.5;">${u.memo}</div>` : ''}
              
              <!-- 하단: 날짜 + 버튼 -->
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.05);">
                <span style="font-size: 12px; color: var(--gray-400);">${formatDateKR(u.createdAt)}</span>
                ${u.status === 'pending' ? `
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="openUrgentSalesModal('${u.id}')">수정</button>
                    <button class="btn" style="padding: 8px 16px; font-size: 13px; background: #fee2e2; color: #dc2626;" onclick="deleteUrgentSales('${u.id}')">삭제</button>
                  </div>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

function openUrgentSalesModal(urgentId = null) {
  const isEdit = !!urgentId;
  const u = isEdit ? (state.urgentSales || []).find(item => item.id === urgentId) : {};
  
  // 내 상품 목록
  const myProducts = state.supplierProducts.filter(p => {
    if (p.supplierId === state.currentUser.id) return true;
    if (p.brandName && state.currentUser.name && p.brandName.includes(state.currentUser.name)) return true;
    return false;
  });
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">${isEdit ? '긴급판매요청 수정' : '긴급판매요청 등록'}</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form onsubmit="saveUrgentSales(event, '${urgentId || ''}')">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">상품 선택 *</label>
            ${myProducts.length > 0 ? `
              <div style="position: relative;">
                <input type="text" class="form-input" id="urgent-product-search" placeholder="상품명 검색..." 
                  value="${u.productName || ''}" 
                  onfocus="showProductDropdown()" 
                  oninput="filterProductDropdown(this.value)"
                  autocomplete="off" required>
                <input type="hidden" id="urgent-product-id" value="${u.productId || ''}">
                <div id="product-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100;">
                  ${myProducts.map(p => `
                    <div class="product-option" data-name="${p.productName}" onclick="selectProduct('${p.id}', \`${p.productName.replace(/`/g, "'")}\`)" 
                      style="padding: 12px; cursor: pointer; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center;"
                      onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
                      <span>${p.productName}</span>
                      <span style="font-size: 12px; color: var(--primary);">${p.supplyPrice ? formatNumber(p.supplyPrice) + '원' : ''}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" class="btn btn-secondary" style="flex: 1; font-size: 12px; padding: 8px;" onclick="openQuickProductModal()">+ 새 상품 등록</button>
                <button type="button" class="btn" style="flex: 1; font-size: 12px; padding: 8px; background: var(--gray-100); color: var(--gray-600);" onclick="closeModal(); renderPage('products');">상품등록 페이지</button>
              </div>
            ` : `
              <div style="padding: 20px; background: var(--gray-50); border-radius: 8px; text-align: center;">
                <p style="color: var(--gray-500); margin-bottom: 12px;">등록된 상품이 없습니다.</p>
                <button type="button" class="btn btn-primary" onclick="closeModal(); renderPage('products');">상품 등록하러 가기</button>
              </div>
            `}
          </div>
          
          <div class="form-group">
            <label class="form-label">요청 유형 *</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--gray-50); border-radius: 8px; border: 2px solid ${u.type === 'new' ? 'var(--info)' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-type" value="new" ${u.type === 'new' || !u.type ? 'checked' : ''} onchange="this.closest('.form-group').querySelectorAll('label').forEach(l => l.style.borderColor = 'var(--gray-200)'); this.closest('label').style.borderColor = 'var(--info)';">
                <div>
                  <div style="font-weight: 600; color: var(--info);">신상품</div>
                  <div style="font-size: 11px; color: var(--gray-500);">새로 출시된 상품 홍보</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--gray-50); border-radius: 8px; border: 2px solid ${u.type === 'clearance' ? 'var(--warning)' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-type" value="clearance" ${u.type === 'clearance' ? 'checked' : ''} onchange="this.closest('.form-group').querySelectorAll('label').forEach(l => l.style.borderColor = 'var(--gray-200)'); this.closest('label').style.borderColor = 'var(--warning)';">
                <div>
                  <div style="font-weight: 600; color: var(--warning);">재고처리</div>
                  <div style="font-size: 11px; color: var(--gray-500);">재고 소진이 필요한 상품</div>
                </div>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">긴급도 *</label>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
              <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; background: ${u.urgencyLevel === 'high' ? '#fef2f2' : 'var(--gray-50)'}; border-radius: 8px; border: 2px solid ${u.urgencyLevel === 'high' ? '#dc2626' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-level" value="high" ${u.urgencyLevel === 'high' ? 'checked' : ''} style="display: none;">
                <span style="font-size: 12px; font-weight: 600; color: #dc2626;">긴급</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; background: ${u.urgencyLevel === 'medium' || !u.urgencyLevel ? '#fffbeb' : 'var(--gray-50)'}; border-radius: 8px; border: 2px solid ${u.urgencyLevel === 'medium' || !u.urgencyLevel ? '#f59e0b' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-level" value="medium" ${u.urgencyLevel === 'medium' || !u.urgencyLevel ? 'checked' : ''} style="display: none;">
                <span style="font-size: 12px; font-weight: 600; color: #f59e0b;">보통</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; background: ${u.urgencyLevel === 'low' ? 'var(--gray-100)' : 'var(--gray-50)'}; border-radius: 8px; border: 2px solid ${u.urgencyLevel === 'low' ? 'var(--gray-400)' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-level" value="low" ${u.urgencyLevel === 'low' ? 'checked' : ''} style="display: none;">
                <span style="font-size: 12px; font-weight: 600; color: var(--gray-500);">여유</span>
              </label>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">판매 희망 수량</label>
              <input type="number" class="form-input" id="urgent-quantity" placeholder="예: 100" value="${u.quantity || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">희망 판매일</label>
              <input type="date" class="form-input" id="urgent-target-date" value="${u.targetDate || ''}">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">메모</label>
            <textarea class="form-textarea" id="urgent-memo" rows="3" placeholder="추가 요청사항이나 특이사항을 입력해주세요.">${u.memo || ''}</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button type="submit" class="btn btn-primary">${isEdit ? '수정하기' : '등록하기'}</button>
        </div>
      </form>
    </div>
  `;
  
  // 긴급도 라디오 버튼 클릭 이벤트
  document.querySelectorAll('input[name="urgent-level"]').forEach(radio => {
    radio.closest('label').onclick = function() {
      document.querySelectorAll('input[name="urgent-level"]').forEach(r => {
        r.closest('label').style.background = 'var(--gray-50)';
        r.closest('label').style.borderColor = 'var(--gray-200)';
      });
      const val = this.querySelector('input').value;
      this.style.background = val === 'high' ? '#fef2f2' : val === 'medium' ? '#fffbeb' : 'var(--gray-100)';
      this.style.borderColor = val === 'high' ? '#dc2626' : val === 'medium' ? '#f59e0b' : 'var(--gray-400)';
      this.querySelector('input').checked = true;
    };
  });
  
  // 모달 외부 클릭시 드롭다운 닫기
  document.addEventListener('click', closeProductDropdownOnOutsideClick);
}

// 상품 드롭다운 관련 함수들
function showProductDropdown() {
  const dropdown = document.getElementById('product-dropdown');
  if (dropdown) dropdown.style.display = 'block';
}

function filterProductDropdown(keyword) {
  const dropdown = document.getElementById('product-dropdown');
  if (!dropdown) return;
  
  const options = dropdown.querySelectorAll('.product-option');
  options.forEach(opt => {
    const name = opt.getAttribute('data-name') || opt.textContent;
    if (name.toLowerCase().includes(keyword.toLowerCase())) {
      opt.style.display = 'flex';
    } else {
      opt.style.display = 'none';
    }
  });
  dropdown.style.display = 'block';
}

function selectProduct(productId, productName) {
  document.getElementById('urgent-product-search').value = productName;
  document.getElementById('urgent-product-id').value = productId;
  document.getElementById('product-dropdown').style.display = 'none';
}

function closeProductDropdownOnOutsideClick(e) {
  const dropdown = document.getElementById('product-dropdown');
  const input = document.getElementById('urgent-product-search');
  if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
    dropdown.style.display = 'none';
  }
}

// 빠른 상품 등록 모달
function openQuickProductModal() {
  const urgentModal = document.getElementById('modal').innerHTML;
  
  const m = document.getElementById('modal');
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">새 상품 등록</h3>
        <button class="modal-close" onclick="closeQuickProductModal()">×</button>
      </div>
      <form onsubmit="saveQuickProduct(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">상품명 *</label>
            <input type="text" class="form-input" id="quick-product-name" placeholder="상품명을 입력하세요" required>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">정가</label>
              <input type="number" class="form-input" id="quick-original-price" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">공급가(V+)</label>
              <input type="number" class="form-input" id="quick-supply-price" placeholder="0">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">공구판매가</label>
              <input type="number" class="form-input" id="quick-sale-price" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">수수료율(%)</label>
              <input type="number" class="form-input" id="quick-commission" placeholder="20">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeQuickProductModal()">취소</button>
          <button type="submit" class="btn btn-primary">등록 후 선택</button>
        </div>
      </form>
    </div>
  `;
  
  // 원래 모달 내용 저장
  window.savedUrgentModal = urgentModal;
}

function closeQuickProductModal() {
  // 긴급판매요청 모달 다시 열기
  openUrgentSalesModal();
}

async function saveQuickProduct(e) {
  e.preventDefault();
  
  try {
    const productData = {
      supplierId: state.currentUser.id,
      brandName: state.currentUser.name,
      productName: document.getElementById('quick-product-name').value,
      originalPrice: parseInt(document.getElementById('quick-original-price').value) || 0,
      supplyPrice: parseInt(document.getElementById('quick-supply-price').value) || 0,
      salePrice: parseInt(document.getElementById('quick-sale-price').value) || 0,
      commission: parseInt(document.getElementById('quick-commission').value) || 20,
      createdAt: new Date().toISOString()
    };
    
    const docRef = await db.collection('supplierProducts').add(productData);
    showToast('상품이 등록되었습니다.');
    
    // 잠시 후 긴급판매요청 모달 다시 열기
    setTimeout(() => {
      openUrgentSalesModal();
      // 새로 등록한 상품 자동 선택
      setTimeout(() => {
        const searchInput = document.getElementById('urgent-product-search');
        const idInput = document.getElementById('urgent-product-id');
        if (searchInput && idInput) {
          searchInput.value = productData.productName;
          idInput.value = docRef.id;
        }
      }, 100);
    }, 500);
  } catch (e) {
    console.error(e);
    showToast('등록에 실패했습니다.');
  }
}

async function saveUrgentSales(e, urgentId = '') {
  e.preventDefault();
  
  try {
    const productName = document.getElementById('urgent-product-search')?.value || '';
    const productId = document.getElementById('urgent-product-id')?.value || '';
    
    if (!productName) {
      showToast('상품을 선택해주세요.');
      return;
    }
    
    const data = {
      supplierId: state.currentUser.id,
      brandName: state.currentUser.name,
      productId: productId,
      productName: productName,
      type: document.querySelector('input[name="urgent-type"]:checked').value,
      urgencyLevel: document.querySelector('input[name="urgent-level"]:checked').value,
      quantity: parseInt(document.getElementById('urgent-quantity').value) || null,
      targetDate: document.getElementById('urgent-target-date').value || null,
      memo: document.getElementById('urgent-memo').value,
      status: 'pending',
      updatedAt: new Date().toISOString()
    };
    
    if (urgentId) {
      await db.collection('urgentSales').doc(urgentId).update(data);
      showToast('요청이 수정되었습니다.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('urgentSales').add(data);
      showToast('요청이 등록되었습니다.');
    }
    
    // 이벤트 리스너 제거
    document.removeEventListener('click', closeProductDropdownOnOutsideClick);
    
    closeModal();
    renderPage('urgent');
  } catch (e) {
    console.error(e);
    showToast('저장에 실패했습니다.');
  }
}

async function deleteUrgentSales(urgentId) {
  if (!confirm('이 요청을 삭제하시겠습니까?')) return;
  
  try {
    await db.collection('urgentSales').doc(urgentId).delete();
    showToast('요청이 삭제되었습니다.');
    renderPage('urgent');
  } catch (e) {
    console.error(e);
    showToast('삭제에 실패했습니다.');
  }
}

// ===== 정산 =====
function renderSettlement(container) {
  if (state.userType === 'seller') {
    // 셀러용 정산 화면
    renderSellerSettlement(container);
  } else {
    // 공급사용 정산 화면
    renderSupplierSettlement(container);
  }
}

// 셀러 정산 화면
function renderSellerSettlement(container) {
  // 내 정산 데이터 (sellerSettlements에서 필터) - 더 유연한 매칭
  const mySettlements = (state.settlements || []).filter(s => {
    const sellerName = (s.sellerName || '').trim().toLowerCase();
    const currentName = (state.currentUser.name || '').trim().toLowerCase();
    const currentNickname = (state.currentUser.nickname || '').trim().toLowerCase();
    const currentId = state.currentUser.id || '';
    
    // 1. ID로 정확히 매칭 (가장 우선)
    if (s.sellerId && s.sellerId === currentId) return true;
    
    // 2. 이름/닉네임 정확히 일치
    if (sellerName === currentName || sellerName === currentNickname) return true;
    
    // 3. 부분 일치 (공백, 특수문자 무시)
    const cleanSeller = sellerName.replace(/[\s\-\_\(\)\/]/g, '');
    const cleanName = currentName.replace(/[\s\-\_\(\)\/]/g, '');
    const cleanNick = currentNickname.replace(/[\s\-\_\(\)\/]/g, '');
    if (cleanSeller.includes(cleanName) || cleanName.includes(cleanSeller)) return true;
    if (cleanNick && (cleanSeller.includes(cleanNick) || cleanNick.includes(cleanSeller))) return true;
    
    // 4. sellerNickname 필드 체크
    if (s.sellerNickname && s.sellerNickname.toLowerCase() === currentNickname) return true;
    
    return false;
  });
  
  const totalSales = mySettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  const totalMargin = mySettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
  const totalWithholding = mySettlements.reduce((sum, s) => sum + (Number(s.withholdingTax) || 0), 0);
  const totalFinal = mySettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
  const totalQty = mySettlements.reduce((sum, s) => sum + (Number(s.totalQuantity) || 0), 0);
  
  // 셀러명 추출
  const sellerName = state.currentUser.name?.split('/')[0] || state.currentUser.name || '';
  
  container.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h1 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">정산</h1>
      <p style="font-size: 13px; color: var(--gray-500);">정산 현황을 확인하고 내역서를 다운로드하세요</p>
    </div>
    
    <!-- 통계 카드 -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #ffffff, #f8f8f8);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 건수</div>
        <div style="font-size: 20px; font-weight: 700; color: var(--gray-800);">${mySettlements.length}건</div>
      </div>
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #fff8f0, #fff5eb);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(252,150,0,0.1);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">총 판매액</div>
        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${formatNumber(totalSales)}원</div>
      </div>
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #f0fdf4, #dcfce7);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(34,197,94,0.1);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">총 실지급액</div>
        <div style="font-size: 20px; font-weight: 700; color: #16a34a;">${formatNumber(totalFinal)}원</div>
      </div>
    </div>
    
    <!-- 정산 내역 카드 -->
    <div style="
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      overflow: hidden;
    ">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--gray-100); flex-wrap: wrap; gap: 12px;">
        <h3 style="font-size: 15px; font-weight: 700; color: var(--gray-800); margin: 0;">정산 내역</h3>
        ${mySettlements.length > 0 ? `
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <span id="selectedCount" style="font-size: 12px; color: var(--primary); font-weight: 600;">0건 선택</span>
            <button onclick="downloadSelectedSettlements('excel')" style="
              padding: 8px 14px;
              font-size: 12px;
              font-weight: 600;
              background: var(--gray-100);
              color: var(--gray-600);
              border: 1px solid var(--gray-200);
              border-radius: 8px;
              cursor: pointer;
            ">📊 엑셀</button>
            <button onclick="downloadSelectedSettlements('pdf')" style="
              padding: 8px 14px;
              font-size: 12px;
              font-weight: 600;
              background: var(--primary);
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
            ">📄 PDF</button>
          </div>
        ` : ''}
      </div>
      
      ${mySettlements.length === 0 ? `
        <div style="padding: 48px 20px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">💰</div>
          <p style="color: var(--gray-500); font-size: 14px;">아직 정산 내역이 없습니다.</p>
        </div>
      ` : `
        <!-- 전체 선택 -->
        <div style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--gray-50); border-bottom: 1px solid var(--gray-100);">
          <input type="checkbox" id="selectAllSettlements" onchange="toggleAllSettlements(this.checked)" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
          <label for="selectAllSettlements" style="font-size: 13px; color: var(--gray-600); cursor: pointer;">전체 선택</label>
        </div>
        
        <!-- 테이블 (상품별 표시) -->
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); width: 40px;"></th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">브랜드</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">공구기간</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); background: #fefce8;">판매상품</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); background: #fefce8;">단가</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">수량</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">판매금액</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--primary); border-bottom: 2px solid var(--gray-200); background: #f0fdf4;">마진금액</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: #dc2626; border-bottom: 2px solid var(--gray-200); background: #f0fdf4;">원천세</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: #16a34a; border-bottom: 2px solid var(--gray-200); background: #f0fdf4;">실지급액</th>
                <th style="padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">정산일</th>
              </tr>
            </thead>
            <tbody>
              ${mySettlements.map((s, idx) => renderSellerSettlementRow(s, idx)).join('')}
            </tbody>
            <tfoot>
              <tr style="background: linear-gradient(145deg, #f0fdf4, #dcfce7);">
                <td colspan="5" style="padding: 14px 10px; font-size: 14px; font-weight: 700; text-align: center;">합계</td>
                <td style="padding: 14px 10px; text-align: center; font-size: 14px; font-weight: 700;">${formatNumber(totalQty)}</td>
                <td style="padding: 14px 10px; text-align: center; font-size: 14px; font-weight: 700;">${formatNumber(totalSales)}원</td>
                <td style="padding: 14px 10px; text-align: center; font-size: 14px; font-weight: 700; color: var(--primary);">${formatNumber(totalMargin)}원</td>
                <td style="padding: 14px 10px; text-align: center; font-size: 13px; font-weight: 700; color: #dc2626;">${formatNumber(totalWithholding)}원</td>
                <td style="padding: 14px 10px; text-align: center; font-size: 15px; font-weight: 700; color: #16a34a;">${formatNumber(totalFinal)}원</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <!-- 안내 문구 -->
        <div style="padding: 12px 20px; background: var(--gray-50); border-top: 1px solid var(--gray-100);">
          <p style="font-size: 11px; color: var(--gray-500); margin: 0;">
            💡 녹색 배경: 셀러 정산 항목 | 문의사항은 모여라딜 담당자에게 연락해주세요.
          </p>
        </div>
      `}
    </div>
  `;
}

// 셀러 정산 테이블 행 렌더링 함수
function renderSellerSettlementRow(s, idx) {
  const items = s.salesItems || s.items || [];
  
  if (items.length === 0) {
    // 상품 정보가 없으면 정산 문서 정보로 한 행
    return `
      <tr style="border-bottom: 1px solid var(--gray-100);">
        <td style="padding: 14px 8px; text-align: center; vertical-align: middle;">
          <input type="checkbox" class="settlement-checkbox" data-idx="${idx}" onchange="updateSelectedCount()" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary);">
        </td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 14px; font-weight: 600; color: var(--gray-800);">${s.brandName || '-'}</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 12px; color: var(--gray-600);">${s.dealPeriod || '-'}</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 13px; background: #fefce8;">-</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 13px; background: #fefce8;">-</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 14px; font-weight: 600;">${formatNumber(s.totalQuantity || 0)}</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 14px; font-weight: 600;">${formatNumber(s.salesAmount || 0)}원</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 14px; font-weight: 600; color: var(--primary); background: #f0fdf4;">${formatNumber(s.marginAmount || 0)}원</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 13px; color: #dc2626; background: #f0fdf4;">${formatNumber(s.withholdingTax || 0)}원</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 15px; font-weight: 700; color: #16a34a; background: #f0fdf4;">${formatNumber(s.actualPayment || 0)}원</td>
        <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 12px; color: var(--gray-500);">${s.settlementDate || '-'}</td>
      </tr>
    `;
  }
  
  // 상품별로 행 생성
  return items.map((item, itemIdx) => {
    const isFirst = itemIdx === 0;
    const isLast = itemIdx === items.length - 1;
    const rowspan = items.length;
    const productName = item.productName || item.name || '-';
    const unitPrice = item.salePrice || item.unitPrice || 0;
    const quantity = item.quantity || 0;
    const itemSalesAmount = unitPrice * quantity;
    
    return `
      <tr style="border-bottom: ${isLast ? '2px solid var(--gray-200)' : '1px solid var(--gray-100)'};">
        ${isFirst ? `
          <td style="padding: 14px 8px; text-align: center; vertical-align: middle;" rowspan="${rowspan}">
            <input type="checkbox" class="settlement-checkbox" data-idx="${idx}" onchange="updateSelectedCount()" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary);">
          </td>
          <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 14px; font-weight: 600; color: var(--gray-800);" rowspan="${rowspan}">${s.brandName || '-'}</td>
          <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 12px; color: var(--gray-600);" rowspan="${rowspan}">${s.dealPeriod || '-'}</td>
        ` : ''}
        <td style="padding: 12px 10px; text-align: center; vertical-align: middle; font-size: 13px; background: #fefce8;">${productName}</td>
        <td style="padding: 12px 10px; text-align: center; vertical-align: middle; font-size: 13px; background: #fefce8;">${formatNumber(unitPrice)}원</td>
        <td style="padding: 12px 10px; text-align: center; vertical-align: middle; font-size: 14px; font-weight: 600;">${quantity}</td>
        <td style="padding: 12px 10px; text-align: center; vertical-align: middle; font-size: 14px; font-weight: 600;">${formatNumber(itemSalesAmount)}원</td>
        ${isFirst ? `
          <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 14px; font-weight: 600; color: var(--primary); background: #f0fdf4;" rowspan="${rowspan}">${formatNumber(s.marginAmount || 0)}원</td>
          <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 13px; color: #dc2626; background: #f0fdf4;" rowspan="${rowspan}">${formatNumber(s.withholdingTax || 0)}원</td>
          <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 15px; font-weight: 700; color: #16a34a; background: #f0fdf4;" rowspan="${rowspan}">${formatNumber(s.actualPayment || 0)}원</td>
          <td style="padding: 14px 10px; text-align: center; vertical-align: middle; font-size: 12px; color: var(--gray-500);" rowspan="${rowspan}">${s.settlementDate || '-'}</td>
        ` : ''}
      </tr>
    `;
  }).join('');
}

// 정산 카드 토글 (체크박스)
function toggleSettlementCard(card, idx) {
  const checkbox = card.querySelector('.settlement-checkbox');
  checkbox.checked = !checkbox.checked;
  updateSelectedCount();
}

// 전체 선택 토글
function toggleAllSettlements(checked) {
  document.querySelectorAll('.settlement-checkbox').forEach(cb => {
    cb.checked = checked;
  });
  updateSelectedCount();
}

// 선택 개수 업데이트
function updateSelectedCount() {
  const checkboxes = document.querySelectorAll('.settlement-checkbox');
  const checked = document.querySelectorAll('.settlement-checkbox:checked');
  
  const countEl = document.getElementById('selectedCount');
  if (countEl) {
    countEl.textContent = `${checked.length}건 선택`;
  }
  
  const selectAll = document.getElementById('selectAllSettlements');
  if (selectAll) {
    selectAll.checked = checkboxes.length > 0 && checkboxes.length === checked.length;
  }
}

// 선택된 정산 다운로드
function downloadSelectedSettlements(type) {
  const mySettlements = (state.settlements || []).filter(s => {
    const sellerName = s.sellerName || '';
    return sellerName.includes(state.currentUser.name) || sellerName.includes(state.currentUser.nickname);
  });
  
  const checkedIdxs = [];
  document.querySelectorAll('.settlement-checkbox:checked').forEach(cb => {
    checkedIdxs.push(parseInt(cb.dataset.idx));
  });
  
  if (checkedIdxs.length === 0) {
    showToast('다운로드할 정산 내역을 선택해주세요.');
    return;
  }
  
  const selectedSettlements = checkedIdxs.map(idx => mySettlements[idx]).filter(Boolean);
  
  if (type === 'excel') {
    downloadSelectedExcel(selectedSettlements);
  } else {
    downloadSelectedPDF(selectedSettlements);
  }
}

// 선택된 정산 엑셀 다운로드
function downloadSelectedExcel(settlements) {
  let csvContent = '\uFEFF';
  csvContent += '브랜드(공급사),공구기간,판매상품,단가,수량,판매금액,마진금액,원천세,실지급액,정산일\n';
  
  settlements.forEach(s => {
    const items = s.salesItems || s.items || [];
    if (items.length === 0) {
      // 상품 정보가 없으면 정산 문서 정보로 한 행
      csvContent += `"${s.brandName || '-'}","${s.dealPeriod || '-'}","-","-","${s.totalQuantity || 0}","${s.salesAmount || 0}","${s.marginAmount || 0}","${s.withholdingTax || 0}","${s.actualPayment || 0}","${s.settlementDate || '-'}"\n`;
    } else {
      // 상품별로 행 생성
      items.forEach((item, idx) => {
        const productName = item.productName || item.name || '-';
        const unitPrice = item.salePrice || item.unitPrice || 0;
        const quantity = item.quantity || 0;
        const itemSalesAmount = unitPrice * quantity;
        csvContent += `"${idx === 0 ? s.brandName || '-' : ''}","${idx === 0 ? s.dealPeriod || '-' : ''}","${productName}","${unitPrice}","${quantity}","${itemSalesAmount}","${idx === 0 ? s.marginAmount || 0 : ''}","${idx === 0 ? s.withholdingTax || 0 : ''}","${idx === 0 ? s.actualPayment || 0 : ''}","${idx === 0 ? s.settlementDate || '-' : ''}"\n`;
      });
    }
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  const sellerName = state.currentUser.name?.split('/')[0] || state.currentUser.name || '셀러';
  link.download = `정산내역_${sellerName}_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
  showToast(`${settlements.length}건의 정산 내역이 다운로드되었습니다.`);
}

// 선택된 정산 PDF 다운로드
function downloadSelectedPDF(settlements) {
  const totalSales = settlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  const totalMargin = settlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
  const totalFinal = settlements.reduce((sum, s) => sum + (Number(s.actualPayment) || Number(s.finalAmount) || 0), 0);
  const sellerName = state.currentUser.name?.split('/')[0] || state.currentUser.name || '셀러';
  
  let tableRows = '';
  settlements.forEach(s => {
    const items = s.salesItems || s.items || [];
    if (items.length === 0) {
      // 상품 정보가 없으면 정산 문서 정보로 한 행
      tableRows += `
        <tr>
          <td>${s.brandName || '-'}</td>
          <td>${s.dealPeriod || '-'}</td>
          <td>-</td>
          <td style="text-align:right;">-</td>
          <td style="text-align:right;">${formatNumber(s.totalQuantity || 0)}</td>
          <td style="text-align:right;">${formatNumber(s.salesAmount || 0)}원</td>
          <td style="text-align:right;color:#fc9600;">${formatNumber(s.marginAmount || 0)}원</td>
          <td style="text-align:right;color:#dc2626;">${formatNumber(s.withholdingTax || 0)}원</td>
          <td style="text-align:right;font-weight:bold;color:#16a34a;">${formatNumber(s.actualPayment || 0)}원</td>
          <td>${s.settlementDate || '-'}</td>
        </tr>
      `;
    } else {
      // 상품별로 행 생성
      items.forEach((item, idx) => {
        const productName = item.productName || item.name || '-';
        const unitPrice = item.salePrice || item.unitPrice || 0;
        const quantity = item.quantity || 0;
        const itemSalesAmount = unitPrice * quantity;
        tableRows += `
          <tr>
            <td>${idx === 0 ? s.brandName || '-' : ''}</td>
            <td>${idx === 0 ? s.dealPeriod || '-' : ''}</td>
            <td>${productName}</td>
            <td style="text-align:right;">${formatNumber(unitPrice)}원</td>
            <td style="text-align:right;">${quantity}</td>
            <td style="text-align:right;">${formatNumber(itemSalesAmount)}원</td>
            <td style="text-align:right;color:#fc9600;">${idx === 0 ? formatNumber(s.marginAmount || 0) + '원' : ''}</td>
            <td style="text-align:right;color:#dc2626;">${idx === 0 ? formatNumber(s.withholdingTax || 0) + '원' : ''}</td>
            <td style="text-align:right;font-weight:bold;color:#16a34a;">${idx === 0 ? formatNumber(s.actualPayment || 0) + '원' : ''}</td>
            <td>${idx === 0 ? s.settlementDate || '-' : ''}</td>
          </tr>
        `;
      });
    }
  });
  
  const pdfHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>정산서 - ${sellerName}</title>
      <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 30px; font-size: 12px; }
        h1 { color: #fc9600; border-bottom: 3px solid #fc9600; padding-bottom: 10px; font-size: 24px; }
        .info { margin: 20px 0; }
        .info p { margin: 5px 0; }
        .summary { display: flex; gap: 20px; margin: 20px 0; }
        .summary-item { background: #fff8f0; padding: 15px 20px; border-radius: 8px; }
        .summary-item .label { font-size: 11px; color: #666; }
        .summary-item .value { font-size: 18px; font-weight: bold; }
        .total-amount { color: #16a34a; font-size: 22px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 6px 4px; }
        th { background: #fff8f0; font-weight: 600; }
        tfoot td { background: #fffbeb; font-weight: bold; }
        .footer { margin-top: 30px; font-size: 10px; color: #888; text-align: center; padding-top: 20px; border-top: 1px solid #eee; }
      </style>
    </head>
    <body>
      <h1>📋 정산서</h1>
      <div class="info">
        <p><strong>셀러:</strong> ${sellerName}</p>
        <p><strong>발행일:</strong> ${new Date().toLocaleDateString('ko-KR')}</p>
        <p><strong>정산 건수:</strong> ${settlements.length}건</p>
      </div>
      <div class="summary">
        <div class="summary-item">
          <div class="label">총 판매금액</div>
          <div class="value">${formatNumber(totalSales)}원</div>
        </div>
        <div class="summary-item">
          <div class="label">총 마진금액</div>
          <div class="value" style="color:#fc9600;">${formatNumber(totalMargin)}원</div>
        </div>
        <div class="summary-item">
          <div class="label">총 정산금액</div>
          <div class="value total-amount">${formatNumber(totalFinal)}원</div>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>브랜드</th>
            <th>공구기간</th>
            <th>판매상품</th>
            <th>단가</th>
            <th>수량</th>
            <th>판매금액</th>
            <th>마진금액</th>
            <th>원천세</th>
            <th>실지급액</th>
            <th>정산일</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
        <tfoot>
          <tr>
            <td colspan="5" style="text-align:right;">합계</td>
            <td style="text-align:right;">${formatNumber(totalSales)}원</td>
            <td style="text-align:right;color:#fc9600;">${formatNumber(totalMargin)}원</td>
            <td style="text-align:right;color:#dc2626;">${formatNumber(settlements.reduce((sum, s) => sum + (Number(s.withholdingTax) || 0), 0))}원</td>
            <td style="text-align:right;color:#16a34a;">${formatNumber(totalFinal)}원</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div class="footer">
        <p>모여라딜 파트너 포털에서 발행된 정산서입니다.</p>
        <p>문의: 모여라딜 운영팀</p>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pdfHtml);
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
  }, 500);
  showToast(`${settlements.length}건의 정산서 인쇄 화면이 열렸습니다.`);
}


// 공급사 정산 화면 (어드민 매출관리 타사상품 형식과 동일)
function renderSupplierSettlement(container) {
  // 내 브랜드에 대한 supplierSettlements 가져오기 - 더 유연한 매칭
  const mySupplierSettlements = (state.supplierSettlements || []).filter(s => {
    const brandName = (s.brandName || '').trim().toLowerCase();
    const currentName = (state.currentUser.name || '').trim().toLowerCase();
    const currentId = state.currentUser.id || '';
    
    // 1. ID로 정확히 매칭 (가장 우선)
    if (s.supplierId && s.supplierId === currentId) return true;
    
    // 2. 이름 정확히 일치
    if (brandName === currentName) return true;
    
    // 3. 부분 일치 (공백, 특수문자 무시)
    const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
    const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
    if (cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand)) return true;
    
    return false;
  });
  
  // 각 정산에 items가 없으면 sellerSettlements에서 매칭
  const enrichedSettlements = mySupplierSettlements.map(sup => {
    let items = sup.items || [];
    
    // items가 없으면 sellerSettlements에서 찾기
    if (items.length === 0) {
      const matchingSeller = (state.sellerSettlements || []).find(ss => 
        ((ss.sellerName || '').includes(sup.sellerName || '') || (sup.sellerName || '').includes(ss.sellerName || '')) &&
        ((ss.brandName || '').includes(sup.brandName || '') || (sup.brandName || '').includes(ss.brandName || ''))
      );
      if (matchingSeller) {
        items = matchingSeller.salesItems || matchingSeller.items || [];
      }
    }
    
    return {
      ...sup,
      items
    };
  });
  
  // 공급사 정산 금액 합계 계산
  const totalSupplyAmount = enrichedSettlements.reduce((sum, s) => sum + (Number(s.totalSupplyAmount) || 0), 0);
  const totalVat = enrichedSettlements.reduce((sum, s) => sum + (Number(s.totalVatAmount) || 0), 0);
  const totalFinal = enrichedSettlements.reduce((sum, s) => sum + (Number(s.totalAmount) || 0), 0);
  const totalSales = enrichedSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  
  // 정산 데이터를 전역에 저장 (선택 다운로드용)
  window.supplierEnrichedSettlements = enrichedSettlements;
  
  // 테이블 행 생성 (어드민과 동일한 형식)
  let tableRows = '';
  enrichedSettlements.forEach((s, sIdx) => {
    const items = s.items || [];
    const sellerName = s.sellerName || '-';
    const sellerParts = sellerName.split('/');
    const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
    
    const supplyAmount = Number(s.totalSupplyAmount) || 0;
    const vatAmount = Number(s.totalVatAmount) || 0;
    const finalAmount = Number(s.totalAmount) || 0;
    
    if (items.length === 0) {
      // 품목 정보 없는 경우
      tableRows += '<tr data-settlement-idx="' + sIdx + '">' +
        '<td style="text-align: center; vertical-align: middle;"><input type="checkbox" class="supplier-settlement-checkbox" data-idx="' + sIdx + '" onclick="updateSupplierSelectedCount()" style="width: 16px; height: 16px; cursor: pointer;"></td>' +
        '<td style="text-align: center;"><strong>' + sellerDisplay + '</strong></td>' +
        '<td style="text-align: center; font-size: 11px;">' + (s.dealPeriod || '-') + '</td>' +
        '<td style="text-align: center; color: var(--gray-400);">(상품정보없음)</td>' +
        '<td style="text-align: center;">-</td>' +
        '<td style="text-align: center;">' + (s.totalQuantity || '-') + '</td>' +
        '<td style="text-align: right;">' + formatNumber(s.salesAmount || 0) + '원</td>' +
        '<td style="text-align: right; background: #fffbeb;">' + formatNumber(supplyAmount) + '원</td>' +
        '<td style="text-align: right; background: #fffbeb;">' + formatNumber(vatAmount) + '원</td>' +
        '<td style="text-align: right; background: var(--primary-light); font-weight: 700; color: var(--primary);">' + formatNumber(finalAmount) + '원</td>' +
        '<td style="text-align: center;">' + (s.settlementDate || '-') + '</td>' +
        '</tr>';
    } else {
      // 품목별 상세 표시
      const rowspan = items.length;
      items.forEach((item, idx) => {
        const isFirst = idx === 0;
        const qty = Number(item.quantity) || 0;
        const unitPrice = Number(item.unitPrice) || Number(item.salePrice) || Number(item.supplyPrice) || 0;
        const itemSalesAmount = Number(item.amount) || (unitPrice * qty);
        
        // 공급사 정산 계산 (품목별)
        const supplyPrice = Number(item.supplyPrice) || unitPrice;
        const itemSupplyAmount = Math.round(supplyPrice * qty / 1.1);
        const itemVatAmount = Math.round(itemSupplyAmount * 0.1);
        
        tableRows += '<tr data-settlement-idx="' + sIdx + '">' +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: center; vertical-align: middle;"><input type="checkbox" class="supplier-settlement-checkbox" data-idx="' + sIdx + '" onclick="updateSupplierSelectedCount()" style="width: 16px; height: 16px; cursor: pointer;"></td>' : '') +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: center; vertical-align: middle;"><strong>' + sellerDisplay + '</strong></td>' : '') +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: center; vertical-align: middle; font-size: 11px;">' + (s.dealPeriod || '-') + '</td>' : '') +
          '<td style="font-size: 11px;">' + (item.productName || '-') + '</td>' +
          '<td style="text-align: right;">' + formatNumber(unitPrice) + '원</td>' +
          '<td style="text-align: center;">' + qty + '</td>' +
          '<td style="text-align: right;">' + formatNumber(itemSalesAmount) + '원</td>' +
          '<td style="text-align: right; background: #fffbeb;">' + formatNumber(itemSupplyAmount) + '원</td>' +
          '<td style="text-align: right; background: #fffbeb;">' + formatNumber(itemVatAmount) + '원</td>' +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: right; vertical-align: middle; background: var(--primary-light); font-weight: 700; color: var(--primary);">' + formatNumber(finalAmount) + '원</td>' : '') +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: center; vertical-align: middle;">' + (s.settlementDate || '-') + '</td>' : '') +
          '</tr>';
      });
    }
  });
  
  container.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h1 class="page-title">정산</h1>
      <p class="page-desc">정산 현황을 확인하고 내역서를 다운로드하세요</p>
    </div>
    
    <!-- 통계 카드 - 셀러와 동일한 디자인 -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #ffffff, #f8f8f8);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 건수</div>
        <div style="font-size: 20px; font-weight: 700; color: var(--gray-800);">${enrichedSettlements.length}건</div>
      </div>
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #fff8f0, #fff5eb);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(252,150,0,0.1);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">총 판매액</div>
        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${formatNumber(totalSales)}원</div>
      </div>
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #f0fdf4, #dcfce7);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(34,197,94,0.1);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">총 정산금액(V+)</div>
        <div style="font-size: 20px; font-weight: 700; color: #16a34a;">${formatNumber(totalFinal)}원</div>
      </div>
    </div>
    
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
        <h3 class="card-title" style="margin: 0;">정산 내역</h3>
        ${enrichedSettlements.length > 0 ? `
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <span id="supplierSelectedCount" style="font-size: 13px; color: var(--primary); font-weight: 600;">0건 선택</span>
            <button class="btn action-btn-secondary" onclick="downloadSupplierSelectedSettlements('excel')">엑셀 다운로드</button>
            <button class="btn action-btn-primary" onclick="downloadSupplierSelectedSettlements('pdf')">PDF 다운로드</button>
          </div>
        ` : ''}
      </div>
      
      ${enrichedSettlements.length === 0 ? `
        <div class="empty-state">
          <div class="icon">💰</div>
          <p>아직 정산 내역이 없습니다.</p>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table" style="font-size: 12px;">
            <thead>
              <tr style="background: linear-gradient(90deg, #fff8f0 0%, #fef9c3 100%);">
                <th style="text-align: center; white-space: nowrap; width: 40px;">
                  <input type="checkbox" id="selectAllSupplierSettlements" onchange="toggleAllSupplierSettlements(this.checked)" style="width: 16px; height: 16px; cursor: pointer;">
                </th>
                <th style="text-align: center; white-space: nowrap;">셀러</th>
                <th style="text-align: center; white-space: nowrap;">공구기간</th>
                <th style="text-align: center; white-space: nowrap;">판매상품</th>
                <th style="text-align: center; white-space: nowrap;">단가</th>
                <th style="text-align: center; white-space: nowrap;">수량</th>
                <th style="text-align: center; white-space: nowrap;">판매금액</th>
                <th style="text-align: center; white-space: nowrap; background: #fef9c3;">공급가액</th>
                <th style="text-align: center; white-space: nowrap; background: #fef9c3;">부가세(10%)</th>
                <th style="text-align: center; white-space: nowrap; background: var(--primary-light); font-weight: 700;">정산금액(V+)</th>
                <th style="text-align: center; white-space: nowrap;">정산일</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
            <tfoot>
              <tr style="background: var(--gray-100); font-weight: 700;">
                <td></td>
                <td colspan="5" style="text-align: center;">합계</td>
                <td style="text-align: right;">${formatNumber(totalSales)}원</td>
                <td style="text-align: right; background: #fef9c3;">${formatNumber(totalSupplyAmount)}원</td>
                <td style="text-align: right; background: #fef9c3;">${formatNumber(totalVat)}원</td>
                <td style="text-align: right; background: var(--primary-light); color: var(--primary);">${formatNumber(totalFinal)}원</td>
                <td>-</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
          💡 <span style="color: var(--primary);">노란색 영역</span>: 공급사 정산 항목
        </div>
      `}
    </div>
  `;
}

// 공급사 정산 전체 선택 토글
function toggleAllSupplierSettlements(checked) {
  document.querySelectorAll('.supplier-settlement-checkbox').forEach(cb => {
    cb.checked = checked;
  });
  updateSupplierSelectedCount();
}

// 공급사 정산 선택 개수 업데이트
function updateSupplierSelectedCount() {
  const checkboxes = document.querySelectorAll('.supplier-settlement-checkbox');
  const checked = document.querySelectorAll('.supplier-settlement-checkbox:checked');
  
  const countEl = document.getElementById('supplierSelectedCount');
  if (countEl) {
    countEl.textContent = `${checked.length}건 선택`;
  }
  
  const selectAll = document.getElementById('selectAllSupplierSettlements');
  if (selectAll) {
    selectAll.checked = checkboxes.length > 0 && checkboxes.length === checked.length;
  }
}

// 공급사 선택된 정산 다운로드
function downloadSupplierSelectedSettlements(type) {
  const enrichedSettlements = window.supplierEnrichedSettlements || [];
  
  const checkedIdxs = [];
  document.querySelectorAll('.supplier-settlement-checkbox:checked').forEach(cb => {
    checkedIdxs.push(parseInt(cb.dataset.idx));
  });
  
  if (checkedIdxs.length === 0) {
    showToast('다운로드할 정산 내역을 선택해주세요.');
    return;
  }
  
  const selectedSettlements = checkedIdxs.map(idx => enrichedSettlements[idx]).filter(Boolean);
  
  if (type === 'excel') {
    downloadSupplierSelectedExcel(selectedSettlements);
  } else {
    downloadSupplierSelectedPDF(selectedSettlements);
  }
}

// 공급사 선택된 정산 엑셀 다운로드
function downloadSupplierSelectedExcel(settlements) {
  let csvContent = '\uFEFF';
  csvContent += '셀러,공구기간,판매상품,수량,판매금액,공급가액,부가세,정산금액,정산일\n';
  
  settlements.forEach(s => {
    const products = s.items || s.products || [];
    const sellerName = s.sellerName || '-';
    const sellerParts = sellerName.split('/');
    const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
    
    if (products.length === 0) {
      csvContent += `"${sellerDisplay}","${s.dealPeriod || '-'}","-","-","${s.salesAmount || 0}","${s.totalSupplyAmount || 0}","${s.totalVatAmount || 0}","${s.totalAmount || 0}","${s.settlementDate || '-'}"\n`;
    } else {
      products.forEach((p, idx) => {
        csvContent += `"${idx === 0 ? sellerDisplay : ''}","${idx === 0 ? s.dealPeriod || '-' : ''}","${p.productName || p.name || '-'}","${p.quantity || 0}","${idx === 0 ? s.salesAmount || 0 : ''}","${idx === 0 ? s.totalSupplyAmount || 0 : ''}","${idx === 0 ? s.totalVatAmount || 0 : ''}","${idx === 0 ? s.totalAmount || 0 : ''}","${idx === 0 ? s.settlementDate || '-' : ''}"\n`;
      });
    }
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `정산내역_${state.currentUser.name}_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
  showToast(`${settlements.length}건의 정산 내역이 다운로드되었습니다.`);
}

// 공급사 선택된 정산 PDF 다운로드
function downloadSupplierSelectedPDF(settlements) {
  const totalFinal = settlements.reduce((sum, s) => sum + (Number(s.totalAmount) || 0), 0);
  
  let tableRows = '';
  settlements.forEach(s => {
    const products = s.items || s.products || [];
    const sellerName = s.sellerName || '-';
    const sellerParts = sellerName.split('/');
    const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
    
    if (products.length === 0) {
      // 상품 정보가 없으면 한 행
      tableRows += `
        <tr>
          <td>${sellerDisplay}</td>
          <td>${s.dealPeriod || '-'}</td>
          <td>-</td>
          <td style="text-align:center;">-</td>
          <td style="text-align:right;">${formatNumber(s.salesAmount || 0)}원</td>
          <td style="text-align:right;">${formatNumber(s.totalSupplyAmount || 0)}원</td>
          <td style="text-align:right;">${formatNumber(s.totalVatAmount || 0)}원</td>
          <td style="text-align:right;font-weight:bold;color:#ea580c;">${formatNumber(s.totalAmount || 0)}원</td>
          <td>${s.settlementDate || '-'}</td>
        </tr>
      `;
    } else {
      // 상품별로 행 생성
      products.forEach((p, idx) => {
        const productName = p.productName || p.name || '-';
        const quantity = p.quantity || 0;
        tableRows += `
          <tr>
            <td>${idx === 0 ? sellerDisplay : ''}</td>
            <td>${idx === 0 ? s.dealPeriod || '-' : ''}</td>
            <td>${productName}</td>
            <td style="text-align:center;">${quantity}</td>
            <td style="text-align:right;">${idx === 0 ? formatNumber(s.salesAmount || 0) + '원' : ''}</td>
            <td style="text-align:right;">${idx === 0 ? formatNumber(s.totalSupplyAmount || 0) + '원' : ''}</td>
            <td style="text-align:right;">${idx === 0 ? formatNumber(s.totalVatAmount || 0) + '원' : ''}</td>
            <td style="text-align:right;font-weight:bold;color:#ea580c;">${idx === 0 ? formatNumber(s.totalAmount || 0) + '원' : ''}</td>
            <td>${idx === 0 ? s.settlementDate || '-' : ''}</td>
          </tr>
        `;
      });
    }
  });
  
  const pdfHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>정산서 - ${state.currentUser.name}</title>
      <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 40px; }
        h1 { color: #ea580c; border-bottom: 2px solid #ea580c; padding-bottom: 10px; }
        .info { margin: 20px 0; font-size: 14px; }
        .total { font-size: 24px; color: #ea580c; font-weight: bold; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #fff7ed; }
        .footer { margin-top: 30px; font-size: 11px; color: #888; }
      </style>
    </head>
    <body>
      <h1>공급사 정산서</h1>
      <div class="info">
        <p><strong>공급사:</strong> ${state.currentUser.name}</p>
        <p><strong>발행일:</strong> ${new Date().toLocaleDateString('ko-KR')}</p>
        <p><strong>선택 건수:</strong> ${settlements.length}건</p>
      </div>
      <div class="total">선택 정산금액 (V+): ${formatNumber(totalFinal)}원</div>
      <table>
        <thead>
          <tr>
            <th>셀러</th>
            <th>공구기간</th>
            <th>판매상품</th>
            <th>수량</th>
            <th>판매금액</th>
            <th>공급가액</th>
            <th>부가세</th>
            <th>정산금액</th>
            <th>정산일</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
      </table>
      <div class="footer">
        <p>모여라딜 파트너 포털에서 발행된 정산서입니다.</p>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pdfHtml);
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
  }, 500);
  showToast(`${settlements.length}건의 정산서 인쇄 화면이 열렸습니다.`);
}

// 정산 엑셀 다운로드
function downloadSettlementExcel() {
  const mySettlements = state.settlements.filter(s => s.brandName === state.currentUser.name);
  if (mySettlements.length === 0) {
    showToast('다운로드할 정산 내역이 없습니다.');
    return;
  }
  
  let csvContent = '\uFEFF'; // BOM for Korean
  csvContent += '셀러,공구기간,판매상품,단가,수량,판매금액,공급가액,부가세,정산금액,정산일\n';
  
  mySettlements.forEach(s => {
    const products = s.products || s.salesItems || [];
    if (products.length === 0) {
      csvContent += `"${s.sellerName || '-'}","${s.dealPeriod || '-'}","-","-","${s.totalQuantity || '-'}","${s.salesAmount || 0}","${s.supplyAmount || 0}","${s.vatAmount || 0}","${s.supplierTotalAmount || 0}","${s.settlementDate || '-'}"\n`;
    } else {
      products.forEach((p, idx) => {
        const price = Number(p.salePrice) || Number(p.price) || 0;
        const qty = Number(p.quantity) || 0;
        csvContent += `"${idx === 0 ? s.sellerName || '-' : ''}","${idx === 0 ? s.dealPeriod || '-' : ''}","${p.productName || '-'}","${price}","${qty}","${price * qty}","${idx === 0 ? s.supplyAmount || 0 : ''}","${idx === 0 ? s.vatAmount || 0 : ''}","${idx === 0 ? s.supplierTotalAmount || 0 : ''}","${idx === 0 ? s.settlementDate || '-' : ''}"\n`;
      });
    }
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `정산내역_${state.currentUser.name}_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
  showToast('엑셀 파일이 다운로드되었습니다.');
}

// 정산 PDF 다운로드
function downloadSettlementPDF() {
  const mySettlements = state.settlements.filter(s => s.brandName === state.currentUser.name);
  if (mySettlements.length === 0) {
    showToast('다운로드할 정산 내역이 없습니다.');
    return;
  }
  
  // PDF용 HTML 생성
  const totalFinal = mySettlements.reduce((sum, s) => sum + (Number(s.supplierTotalAmount) || 0), 0);
  
  let tableRows = '';
  mySettlements.forEach(s => {
    const products = s.products || s.salesItems || [];
    if (products.length === 0) {
      tableRows += `<tr>
        <td>${s.sellerName || '-'}</td>
        <td>${s.dealPeriod || '-'}</td>
        <td>-</td>
        <td style="text-align:right;">${formatNumber(s.salesAmount || 0)}원</td>
        <td style="text-align:right;">${formatNumber(s.supplierTotalAmount || 0)}원</td>
        <td>${s.settlementDate || '-'}</td>
      </tr>`;
    } else {
      products.forEach((p, idx) => {
        const price = Number(p.salePrice) || Number(p.price) || 0;
        const qty = Number(p.quantity) || 0;
        tableRows += `<tr>
          ${idx === 0 ? `<td rowspan="${products.length}">${s.sellerName || '-'}</td>` : ''}
          ${idx === 0 ? `<td rowspan="${products.length}">${s.dealPeriod || '-'}</td>` : ''}
          <td>${p.productName || '-'} (${qty}개)</td>
          <td style="text-align:right;">${formatNumber(price * qty)}원</td>
          ${idx === 0 ? `<td rowspan="${products.length}" style="text-align:right;font-weight:bold;color:#ea580c;">${formatNumber(s.supplierTotalAmount || 0)}원</td>` : ''}
          ${idx === 0 ? `<td rowspan="${products.length}">${s.settlementDate || '-'}</td>` : ''}
        </tr>`;
      });
    }
  });
  
  const pdfHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>정산서 - ${state.currentUser.name}</title>
      <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 40px; }
        h1 { color: #ea580c; border-bottom: 2px solid #ea580c; padding-bottom: 10px; }
        .info { margin: 20px 0; font-size: 14px; }
        .total { font-size: 24px; color: #ea580c; font-weight: bold; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #fff7ed; }
        .footer { margin-top: 30px; font-size: 11px; color: #888; }
      </style>
    </head>
    <body>
      <h1>정산서</h1>
      <div class="info">
        <p><strong>공급사:</strong> ${state.currentUser.name}</p>
        <p><strong>발행일:</strong> ${new Date().toLocaleDateString('ko-KR')}</p>
      </div>
      <div class="total">총 정산금액: ${formatNumber(totalFinal)}원</div>
      <table>
        <thead>
          <tr>
            <th>셀러</th>
            <th>공구기간</th>
            <th>상품</th>
            <th>판매금액</th>
            <th>정산금액(V+)</th>
            <th>정산일</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
      </table>
      <div class="footer">
        <p>모여라딜 파트너 포털에서 발행된 정산서입니다.</p>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pdfHtml);
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
  }, 500);
  showToast('PDF 인쇄 화면이 열렸습니다.');
}

// ===== 공구 제안 (셀러 전용) =====
function renderSuggest(container) {
  const mySuggestions = state.suggestions?.filter(s => s.sellerId === state.currentUser.id) || [];
  
  // 모여라딜에서 받은 제안 (내 sellerId로 온 것 or 전체 공개된 것)
  const receivedProposals = state.adminProposals?.filter(p => 
    p.targetSellerId === state.currentUser.id || 
    (p.isPublic && !p.targetSellerId)
  ) || [];
  
  const pendingReceived = receivedProposals.filter(p => p.sellerStatus !== 'accepted' && p.sellerStatus !== 'rejected');
  
  container.innerHTML = `
    <!-- 헤더 - 모바일 최적화 -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px;">
      <div style="flex: 1;">
        <h1 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">공구 제안</h1>
        <p style="font-size: 13px; color: var(--gray-500);">아이디어 제안 및 받은 제안 확인</p>
      </div>
      <button onclick="openSuggestModal()" style="
        padding: 10px 16px;
        font-size: 13px;
        font-weight: 600;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
      ">
        <span style="font-size: 16px; font-weight: 400;">+</span> 제안하기
      </button>
    </div>
    
    <!-- 탭 - 3D 스타일 -->
    <div style="display: flex; border-radius: 14px; overflow: hidden; margin-bottom: 16px; background: linear-gradient(145deg, #f5f5f5, #e8e8e8); padding: 4px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);">
      <button id="suggestTab-my" onclick="switchSuggestTab('my')" style="
        flex: 1;
        padding: 12px 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        background: var(--primary);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        transition: all 0.2s;
      ">
        내 제안 <span style="opacity: 0.85;">(${mySuggestions.length})</span>
      </button>
      <button id="suggestTab-received" onclick="switchSuggestTab('received')" style="
        flex: 1;
        padding: 12px 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        background: transparent;
        color: var(--gray-500);
        border-radius: 10px;
        transition: all 0.2s;
      ">
        받은 제안 <span style="opacity: 0.85;">(${receivedProposals.length})</span>
        ${pendingReceived.length > 0 ? `<span style="background: linear-gradient(145deg, #ef4444, #dc2626); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 4px; box-shadow: 0 2px 4px rgba(220,38,38,0.3);">${pendingReceived.length}</span>` : ''}
      </button>
    </div>
    
    <!-- 내 제안 목록 -->
    <div id="suggestContent-my">
      ${mySuggestions.length === 0 ? `
        <div style="padding: 48px 20px; text-align: center; background: linear-gradient(145deg, #ffffff, #f8f8f8); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);">
          <div style="font-size: 48px; margin-bottom: 16px;">💡</div>
          <p style="color: var(--gray-500); font-size: 14px; line-height: 1.6;">아직 제안한 공구가 없습니다.<br>새로운 아이디어를 제안해보세요!</p>
        </div>
      ` : `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          ${mySuggestions.map(s => `
            <div style="
              padding: 16px;
              background: linear-gradient(145deg, #ffffff, #f9f9f9);
              border-radius: 14px;
              box-shadow: 0 4px 16px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.9);
              border: 1px solid rgba(0,0,0,0.04);
            ">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 700; font-size: 15px; color: var(--gray-800); margin-bottom: 4px;">${s.title}</div>
                  <div style="font-size: 12px; color: var(--gray-500);">${formatDateKR(s.createdAt)}${s.brand ? ` · ${s.brand}` : ''}</div>
                </div>
                <span style="
                  flex-shrink: 0;
                  padding: 5px 10px;
                  border-radius: 8px;
                  font-size: 11px;
                  font-weight: 600;
                  background: ${s.status === 'approved' ? 'linear-gradient(145deg, #22c55e, #16a34a)' : s.status === 'rejected' ? 'linear-gradient(145deg, #9ca3af, #6b7280)' : 'linear-gradient(145deg, #3b82f6, #2563eb)'};
                  color: white;
                  box-shadow: 0 2px 6px ${s.status === 'approved' ? 'rgba(34,197,94,0.3)' : s.status === 'rejected' ? 'rgba(107,114,128,0.3)' : 'rgba(59,130,246,0.3)'};
                ">
                  ${s.status === 'approved' ? '승인' : s.status === 'rejected' ? '반려' : '검토중'}
                </span>
              </div>
              ${s.status === 'pending' || s.status === 'rejected' ? `
                <div style="display: flex; gap: 8px; justify-content: flex-end; padding-top: 12px; border-top: 1px solid var(--gray-100);">
                  ${s.status === 'pending' ? `
                    <button type="button" onclick="event.stopPropagation(); openSuggestModal('${s.id}')" style="
                      padding: 8px 14px;
                      font-size: 12px;
                      font-weight: 600;
                      background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                      color: var(--gray-600);
                      border: 1px solid var(--gray-200);
                      border-radius: 8px;
                      cursor: pointer;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
                    ">수정</button>
                    <button type="button" onclick="event.stopPropagation(); deleteSuggestion('${s.id}')" style="
                      padding: 8px 14px;
                      font-size: 12px;
                      font-weight: 600;
                      background: linear-gradient(145deg, #fef2f2, #fee2e2);
                      color: #dc2626;
                      border: 1px solid #fecaca;
                      border-radius: 8px;
                      cursor: pointer;
                      box-shadow: 0 2px 4px rgba(220,38,38,0.1);
                    ">삭제</button>
                  ` : `
                    <button type="button" onclick="event.stopPropagation(); resubmitSuggestion('${s.id}')" style="
                      padding: 8px 16px;
                      font-size: 12px;
                      font-weight: 600;
                      background: var(--primary);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      cursor: pointer;
                      box-shadow: 0 4px 12px rgba(252,150,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
                    ">수정 후 재신청</button>
                  `}
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `}
    </div>
    
    <!-- 받은 제안 목록 - 아코디언 형식 -->
    <div id="suggestContent-received" style="display: none;">
      ${receivedProposals.length === 0 ? `
        <div style="padding: 48px 20px; text-align: center; background: linear-gradient(145deg, #ffffff, #f8f8f8); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);">
          <div style="font-size: 48px; margin-bottom: 16px;">📬</div>
          <p style="color: var(--gray-500); font-size: 14px; line-height: 1.6;">아직 받은 제안이 없습니다.<br>모여라딜에서 좋은 제안을 보내드릴게요!</p>
        </div>
      ` : `
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${receivedProposals.map((p, idx) => `
            <!-- 아코디언 헤더 -->
            <div style="
              background: ${p.sellerStatus === 'accepted' ? 'linear-gradient(145deg, #f0fdf4, #dcfce7)' : p.sellerStatus === 'rejected' ? 'linear-gradient(145deg, #fef2f2, #fee2e2)' : 'linear-gradient(145deg, #ffffff, #f9f9f9)'};
              border-radius: 12px;
              border: 1px solid ${p.sellerStatus === 'accepted' ? '#86efac' : p.sellerStatus === 'rejected' ? '#fecaca' : 'var(--gray-200)'};
              box-shadow: 0 2px 8px rgba(0,0,0,0.04);
              overflow: hidden;
            ">
              <div onclick="toggleReceivedProposal(${idx})" style="
                padding: 14px 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                transition: background 0.2s;
              ">
                <div style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 10px;">
                  <span id="proposalArrow-${idx}" style="font-size: 10px; color: var(--gray-400); transition: transform 0.2s;">▶</span>
                  <div>
                    <div style="font-weight: 600; font-size: 14px; color: var(--gray-800); margin-bottom: 2px;">${p.title}</div>
                    <div style="font-size: 11px; color: var(--gray-500);">${formatDateKR(p.createdAt)}${p.brandName ? ` · ${p.brandName}` : ''}</div>
                  </div>
                </div>
                <span style="
                  flex-shrink: 0;
                  padding: 4px 8px;
                  border-radius: 6px;
                  font-size: 10px;
                  font-weight: 600;
                  background: ${p.sellerStatus === 'accepted' ? 'linear-gradient(145deg, #22c55e, #16a34a)' : p.sellerStatus === 'rejected' ? 'linear-gradient(145deg, #9ca3af, #6b7280)' : 'var(--primary)'};
                  color: white;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                ">
                  ${p.sellerStatus === 'accepted' ? '수락함' : p.sellerStatus === 'rejected' ? '거절함' : '검토대기'}
                </span>
              </div>
              
              <!-- 아코디언 컨텐츠 (기본 숨김) -->
              <div id="proposalContent-${idx}" style="display: none; padding: 0 16px 16px 16px; border-top: 1px solid ${p.sellerStatus === 'accepted' ? '#86efac' : p.sellerStatus === 'rejected' ? '#fecaca' : 'var(--gray-100)'};">
                ${p.content ? `<div style="font-size: 13px; color: var(--gray-600); margin: 12px 0; padding: 12px; background: rgba(255,255,255,0.8); border-radius: 10px; line-height: 1.6;">${p.content}</div>` : ''}
                
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0;">
                  ${p.expectedPeriod ? `<span style="background: var(--gray-100); padding: 6px 12px; border-radius: 8px; font-size: 12px; color: var(--gray-600);"><strong>희망일자</strong> ${p.expectedPeriod}</span>` : ''}
                  ${p.expectedMargin ? `<span style="background: var(--gray-100); padding: 6px 12px; border-radius: 8px; font-size: 12px; color: var(--gray-600);"><strong>수수료율</strong> ${p.expectedMargin}</span>` : ''}
                  ${p.productLink ? `<a href="${p.productLink}" target="_blank" style="background: var(--info-light); padding: 6px 12px; border-radius: 8px; font-size: 12px; color: var(--info); text-decoration: none; font-weight: 500;">상품보기 →</a>` : ''}
                </div>
                
                ${!p.sellerStatus || p.sellerStatus === 'pending' ? `
                  <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;">
                    <button type="button" onclick="respondToProposal('${p.id}', 'rejected')" style="
                      padding: 10px 20px;
                      font-size: 13px;
                      font-weight: 600;
                      background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                      color: var(--gray-600);
                      border: 1px solid var(--gray-300);
                      border-radius: 10px;
                      cursor: pointer;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
                    ">거절하기</button>
                    <button type="button" onclick="respondToProposal('${p.id}', 'accepted')" style="
                      padding: 10px 20px;
                      font-size: 13px;
                      font-weight: 600;
                      background: var(--primary);
                      color: white;
                      border: none;
                      border-radius: 10px;
                      cursor: pointer;
                      box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
                    ">수락하기</button>
                  </div>
                ` : `
                  <div style="text-align: right; font-size: 12px; color: var(--gray-400); margin-top: 8px;">
                    ${p.respondedAt ? formatDateKR(p.respondedAt) + '에 응답함' : ''}
                  </div>
                `}
              </div>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

// ===== 주문현황 =====
function renderOrders(container) {
  const myDeals = getMyDeals();
  const myDealIds = myDeals.map(d => d.id);

  // 기간 필터링 날짜 계산
  const now = new Date();
  const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
  const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
  const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());

  // 내 딜과 연결된 주문만 필터링
  let myOrders = state.cafe24Orders.filter(order =>
    order.deal_id && myDealIds.includes(order.deal_id)
  );

  // 기간별 필터링
  const allOrders = [...myOrders]; // 전체 주문 보관
  if (state.orderPeriodFilter !== 'all') {
    let filterDate;
    if (state.orderPeriodFilter === 'month1') filterDate = oneMonthAgo;
    else if (state.orderPeriodFilter === 'month3') filterDate = threeMonthsAgo;
    else if (state.orderPeriodFilter === 'month6') filterDate = sixMonthsAgo;

    myOrders = myOrders.filter(order => {
      if (!order.order_date) return false;
      const orderDate = new Date(order.order_date);
      return orderDate >= filterDate;
    });
  }

  // 딜별로 그룹화
  const ordersByDeal = {};
  myOrders.forEach(order => {
    const dealId = order.deal_id;
    if (!ordersByDeal[dealId]) {
      const deal = myDeals.find(d => d.id === dealId);
      ordersByDeal[dealId] = {
        deal: deal,
        orders: []
      };
    }
    ordersByDeal[dealId].orders.push(order);
  });

  // 통계 계산
  const totalOrders = myOrders.length;
  const paidOrders = myOrders.filter(o => o.order_status && o.order_status.includes('결제완료')).length;
  const pendingOrders = totalOrders - paidOrders;
  const totalAmount = myOrders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);

  const isSupplier = state.userType === 'supplier';
  const themeColor = isSupplier ? 'var(--primary)' : '#10b981';

  // 기간 텍스트
  let periodText = '';
  if (state.orderPeriodFilter === 'month1') periodText = '최근 1개월';
  else if (state.orderPeriodFilter === 'month3') periodText = '최근 3개월';
  else if (state.orderPeriodFilter === 'month6') periodText = '최근 6개월';
  else periodText = '전체';

  container.innerHTML = `
    <!-- 헤더 -->
    <div style="margin-bottom: 16px;">
      <h1 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">주문현황</h1>
      <p style="font-size: 13px; color: var(--gray-500);">카페24 자동 수집 주문 내역 (${periodText})</p>
    </div>

    <!-- 기간 선택 필터 -->
    <div style="display: flex; gap: 6px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px;">
      <button onclick="filterOrdersByPeriod('all')" style="
        padding: 8px 14px;
        font-size: 12px;
        font-weight: 600;
        background: ${state.orderPeriodFilter === 'all' ? 'linear-gradient(145deg, ' + themeColor + ', ' + themeColor + ')' : 'linear-gradient(145deg, #ffffff, #f9f9f9)'};
        color: ${state.orderPeriodFilter === 'all' ? 'white' : 'var(--gray-600)'};
        border: 1px solid ${state.orderPeriodFilter === 'all' ? themeColor : 'var(--gray-200)'};
        border-radius: 10px;
        cursor: pointer;
        white-space: nowrap;
        box-shadow: ${state.orderPeriodFilter === 'all' ? '0 4px 12px rgba(252,150,0,0.3)' : '0 2px 4px rgba(0,0,0,0.04)'};
        transition: all 0.2s;
      ">전체</button>
      <button onclick="filterOrdersByPeriod('month1')" style="
        padding: 8px 14px;
        font-size: 12px;
        font-weight: 600;
        background: ${state.orderPeriodFilter === 'month1' ? 'linear-gradient(145deg, ' + themeColor + ', ' + themeColor + ')' : 'linear-gradient(145deg, #ffffff, #f9f9f9)'};
        color: ${state.orderPeriodFilter === 'month1' ? 'white' : 'var(--gray-600)'};
        border: 1px solid ${state.orderPeriodFilter === 'month1' ? themeColor : 'var(--gray-200)'};
        border-radius: 10px;
        cursor: pointer;
        white-space: nowrap;
        box-shadow: ${state.orderPeriodFilter === 'month1' ? '0 4px 12px rgba(252,150,0,0.3)' : '0 2px 4px rgba(0,0,0,0.04)'};
        transition: all 0.2s;
      ">최근 1개월</button>
      <button onclick="filterOrdersByPeriod('month3')" style="
        padding: 8px 14px;
        font-size: 12px;
        font-weight: 600;
        background: ${state.orderPeriodFilter === 'month3' ? 'linear-gradient(145deg, ' + themeColor + ', ' + themeColor + ')' : 'linear-gradient(145deg, #ffffff, #f9f9f9)'};
        color: ${state.orderPeriodFilter === 'month3' ? 'white' : 'var(--gray-600)'};
        border: 1px solid ${state.orderPeriodFilter === 'month3' ? themeColor : 'var(--gray-200)'};
        border-radius: 10px;
        cursor: pointer;
        white-space: nowrap;
        box-shadow: ${state.orderPeriodFilter === 'month3' ? '0 4px 12px rgba(252,150,0,0.3)' : '0 2px 4px rgba(0,0,0,0.04)'};
        transition: all 0.2s;
      ">최근 3개월</button>
      <button onclick="filterOrdersByPeriod('month6')" style="
        padding: 8px 14px;
        font-size: 12px;
        font-weight: 600;
        background: ${state.orderPeriodFilter === 'month6' ? 'linear-gradient(145deg, ' + themeColor + ', ' + themeColor + ')' : 'linear-gradient(145deg, #ffffff, #f9f9f9)'};
        color: ${state.orderPeriodFilter === 'month6' ? 'white' : 'var(--gray-600)'};
        border: 1px solid ${state.orderPeriodFilter === 'month6' ? themeColor : 'var(--gray-200)'};
        border-radius: 10px;
        cursor: pointer;
        white-space: nowrap;
        box-shadow: ${state.orderPeriodFilter === 'month6' ? '0 4px 12px rgba(252,150,0,0.3)' : '0 2px 4px rgba(0,0,0,0.04)'};
        transition: all 0.2s;
      ">최근 6개월</button>
    </div>

    <!-- 통계 카드 -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
      <div class="stat-card" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">총 주문</div>
        <div style="font-size: 24px; font-weight: 700; color: ${themeColor};">${totalOrders}</div>
      </div>
      <div class="stat-card" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">총 금액</div>
        <div style="font-size: 24px; font-weight: 700; color: ${themeColor};">${formatNumber(totalAmount)}원</div>
      </div>
      <div class="stat-card" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">결제완료</div>
        <div style="font-size: 20px; font-weight: 700; color: #10b981;">${paidOrders}</div>
      </div>
      <div class="stat-card" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">결제대기</div>
        <div style="font-size: 20px; font-weight: 700; color: var(--gray-500);">${pendingOrders}</div>
      </div>
    </div>

    <!-- 딜별 주문 목록 -->
    ${Object.keys(ordersByDeal).length === 0 ? `
      <div style="padding: 60px 20px; text-align: center; background: linear-gradient(145deg, #ffffff, #f8f8f8); border-radius: 16px;">
        <div style="font-size: 48px; margin-bottom: 16px;">📦</div>
        <p style="color: var(--gray-500); font-size: 14px;">주문 내역이 없습니다</p>
      </div>
    ` : Object.entries(ordersByDeal).map(([dealId, data]) => {
      const deal = data.deal;
      const orders = data.orders;
      return `
        <div style="background: linear-gradient(145deg, #ffffff, #f9f9f9); border-radius: 14px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.06); border-left: 4px solid ${themeColor};">
          <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid ${themeColor};">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <span style="font-size: 16px;">📦</span>
              <div style="font-weight: 700; font-size: 17px; color: var(--gray-900);">${deal?.title || '공구명 없음'}</div>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
              ${deal?.startDate && deal?.endDate ? `
                <div style="display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--gray-600);">
                  <span>📅</span>
                  <span>${deal.startDate} ~ ${deal.endDate}</span>
                </div>
              ` : ''}
              <div style="font-size: 12px; color: ${themeColor}; font-weight: 600;">
                주문 ${orders.length}건 · ${formatNumber(orders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0))}원
              </div>
            </div>
          </div>

          <div style="overflow-x: auto;">
            <table style="width: 100%; font-size: 12px;">
              <thead>
                <tr style="background: var(--gray-50);">
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--gray-600);">주문번호</th>
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--gray-600);">주문일</th>
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--gray-600);">상품명</th>
                  <th style="padding: 8px; text-align: center; font-weight: 600; color: var(--gray-600);">수량</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--gray-600);">금액</th>
                  <th style="padding: 8px; text-align: center; font-weight: 600; color: var(--gray-600);">상태</th>
                  ${isSupplier ? '<th style="padding: 8px; text-align: left; font-weight: 600; color: var(--gray-600);">송장번호</th>' : ''}
                </tr>
              </thead>
              <tbody>
                ${orders.map(order => {
                  // 최근 1개월 내역 체크
                  let isRecentOrder = false;
                  if (order.order_date) {
                    const orderDate = new Date(order.order_date);
                    isRecentOrder = orderDate >= oneMonthAgo;
                  }
                  return `
                  <tr style="border-bottom: 1px solid var(--gray-100);">
                    <td style="padding: 10px 8px; color: var(--gray-700);">${order.order_id || '-'}</td>
                    <td style="padding: 10px 8px; color: var(--gray-700);">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <span>${order.order_date ? order.order_date.substring(0, 10) : '-'}</span>
                        ${isRecentOrder ? '<span style="background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; font-size: 9px; padding: 2px 6px; border-radius: 6px; font-weight: 600; white-space: nowrap;">최근</span>' : ''}
                      </div>
                    </td>
                    <td style="padding: 10px 8px; color: var(--gray-700);">${order.product_name || '-'}</td>
                    <td style="padding: 10px 8px; text-align: center; color: var(--gray-700);">${order.quantity || 0}</td>
                    <td style="padding: 10px 8px; text-align: right; font-weight: 600; color: var(--gray-900);">${formatNumber(Number(order.total_amount) || 0)}원</td>
                    <td style="padding: 10px 8px; text-align: center;">
                      <span style="
                        padding: 4px 8px;
                        border-radius: 6px;
                        font-size: 10px;
                        font-weight: 600;
                        background: ${order.order_status && order.order_status.includes('결제완료') ? '#e8f5e9' : '#fff3e0'};
                        color: ${order.order_status && order.order_status.includes('결제완료') ? '#2e7d32' : '#ef6c00'};
                      ">
                        ${order.order_status || '-'}
                      </span>
                    </td>
                    ${isSupplier ? `
                      <td style="padding: 10px 8px;">
                        <input
                          type="text"
                          value="${order.tracking_number || ''}"
                          placeholder="송장번호"
                          onchange="updateTrackingNumber('${order.id}', this.value)"
                          style="
                            width: 120px;
                            padding: 4px 8px;
                            border: 1px solid var(--gray-300);
                            border-radius: 4px;
                            font-size: 11px;
                          "
                        />
                      </td>
                    ` : ''}
                  </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }).join('')}
  `;
}

// 송장번호 업데이트 (공급사만)
async function updateTrackingNumber(orderId, trackingNumber) {
  try {
    await db.collection('cafe24_orders').doc(orderId).update({
      tracking_number: trackingNumber,
      tracking_updated_at: new Date().toISOString()
    });
    alert('송장번호가 등록되었습니다.');
  } catch (error) {
    console.error('송장번호 등록 오류:', error);
    alert('송장번호 등록에 실패했습니다.');
  }
}

// 주문 조회기간 필터
function filterOrdersByPeriod(period) {
  state.orderPeriodFilter = period;
  renderPage('orders');
}

// 받은 제안 아코디언 토글
function toggleReceivedProposal(idx) {
  const content = document.getElementById('proposalContent-' + idx);
  const arrow = document.getElementById('proposalArrow-' + idx);
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    arrow.style.transform = 'rotate(90deg)';
  } else {
    content.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  }
}

// 제안 탭 전환
function switchSuggestTab(tab) {
  const myTab = document.getElementById('suggestTab-my');
  const receivedTab = document.getElementById('suggestTab-received');
  
  if (tab === 'my') {
    myTab.style.background = 'var(--primary)';
    myTab.style.color = 'white';
    myTab.style.boxShadow = '0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2)';
    receivedTab.style.background = 'transparent';
    receivedTab.style.color = 'var(--gray-500)';
    receivedTab.style.boxShadow = 'none';
  } else {
    receivedTab.style.background = 'var(--primary)';
    receivedTab.style.color = 'white';
    receivedTab.style.boxShadow = '0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2)';
    myTab.style.background = 'transparent';
    myTab.style.color = 'var(--gray-500)';
    myTab.style.boxShadow = 'none';
  }
  
  document.getElementById('suggestContent-my').style.display = tab === 'my' ? 'block' : 'none';
  document.getElementById('suggestContent-received').style.display = tab === 'received' ? 'block' : 'none';
}

// 받은 제안에 응답
async function respondToProposal(proposalId, status) {
  const action = status === 'accepted' ? '수락' : '거절';
  if (!confirm(`이 제안을 ${action}하시겠습니까?`)) return;
  
  try {
    await db.collection('adminProposals').doc(proposalId).update({
      sellerStatus: status,
      respondedAt: new Date().toISOString()
    });
    showToast(`제안을 ${action}했습니다.`);
    renderPage('suggest');
  } catch (e) {
    console.error(e);
    showToast('처리에 실패했습니다.');
  }
}

function openSuggestModal(suggestionId = null, isResubmit = false) {
  const isEdit = !!suggestionId;
  const s = isEdit ? (state.suggestions.find(sug => sug.id === suggestionId) || state.dealSuggestions.find(sug => sug.id === suggestionId)) : {};
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">💡 ${isResubmit ? '공구 제안 재신청' : isEdit ? '공구 제안 수정' : '공구 제안'}</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form onsubmit="saveSuggestion(event, '${suggestionId || ''}', ${isResubmit})">
        <div class="modal-body">
          ${isResubmit ? `
            <div style="background: #fff8f0; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(252,150,0,0.2);">
              <div style="font-size: 13px; color: var(--gray-700);">
                💡 반려된 제안을 수정하여 다시 신청합니다.<br>
                <span style="color: var(--gray-500);">수정 후 저장하면 다시 검토 대기 상태가 됩니다.</span>
              </div>
            </div>
          ` : ''}
          <div class="form-group">
            <label class="form-label">제안 제목 *</label>
            <input type="text" class="form-input" id="sug-title" placeholder="예: OO브랜드 신제품 공구 제안" value="${s.title || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">브랜드/상품명</label>
            <input type="text" class="form-input" id="sug-brand" placeholder="브랜드 또는 상품명" value="${s.brand || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">예상 판매가</label>
            <input type="text" class="form-input" id="sug-price" placeholder="예: 30,000원" value="${s.price || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">제안 내용 *</label>
            <textarea class="form-textarea" id="sug-content" rows="5" placeholder="공구 제안 이유, 예상 반응 등을 자유롭게 작성해주세요." required>${s.content || ''}</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">참고 링크</label>
            <input type="text" class="form-input" id="sug-link" placeholder="상품 링크 또는 참고 URL" value="${s.link || ''}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button type="submit" class="btn btn-primary" style="width: auto;">${isResubmit ? '재신청하기' : isEdit ? '수정하기' : '제안하기'}</button>
        </div>
      </form>
    </div>
  `;
}

async function saveSuggestion(e, suggestionId = '', isResubmit = false) {
  e.preventDefault();
  
  try {
    const data = {
      sellerId: state.currentUser.id,
      sellerName: state.currentUser.name,
      title: document.getElementById('sug-title').value,
      brand: document.getElementById('sug-brand').value,
      price: document.getElementById('sug-price').value,
      content: document.getElementById('sug-content').value,
      link: document.getElementById('sug-link').value,
      status: 'pending',
      updatedAt: new Date().toISOString()
    };
    
    if (suggestionId) {
      // 수정 또는 재신청
      await db.collection('dealSuggestions').doc(suggestionId).update(data);
      showToast(isResubmit ? '제안이 재신청되었습니다.' : '제안이 수정되었습니다.');
    } else {
      // 새로 추가
      data.createdAt = new Date().toISOString();
      await db.collection('dealSuggestions').add(data);
      showToast('제안이 등록되었습니다.');
    }
    
    closeModal();
    renderPage('suggest');
  } catch (e) {
    console.error(e);
    showToast('저장에 실패했습니다.');
  }
}

async function deleteSuggestion(suggestionId) {
  if (!confirm('이 제안을 삭제하시겠습니까?')) return;
  
  try {
    await db.collection('dealSuggestions').doc(suggestionId).delete();
    showToast('제안이 삭제되었습니다.');
    renderPage('suggest');
  } catch (e) {
    console.error(e);
    showToast('삭제에 실패했습니다.');
  }
}

// 반려된 제안 재신청
async function resubmitSuggestion(suggestionId) {
  const suggestion = state.suggestions?.find(s => s.id === suggestionId);
  if (!suggestion) {
    showToast('제안을 찾을 수 없습니다.');
    return;
  }
  
  // 수정 모달을 열되, 상태를 pending으로 변경할 것임을 알림
  openSuggestModal(suggestionId, true);
}

// ===== 공구 상세 모달 =====
function openDealModal(dealId) {
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;
  
  const supplier = state.suppliers.find(s => s.id === deal.supplierId);
  const seller = state.sellers.find(s => s.id === deal.sellerId);
  
  // 상품 정보
  const products = (deal.selectedProducts || []).map(item => {
    const pid = typeof item === 'string' ? item : item.productId;
    const product = state.supplierProducts.find(p => p.id === pid);
    return product ? {
      ...product,
      marginRate: typeof item === 'object' ? item.marginRate : 0
    } : null;
  }).filter(Boolean);
  
  const today = new Date();
  const start = new Date(deal.startDate);
  const end = new Date(deal.endDate);
  let statusText = '예정';
  let statusClass = 'status-upcoming';
  
  if (today >= start && today <= end) {
    statusText = '진행중';
    statusClass = 'status-ongoing';
  } else if (today > end) {
    statusText = '완료';
    statusClass = 'status-completed';
  }
  
  // 공급사용: 셀러 닉네임만 표시
  let displayTitle = deal.title;
  let sellerDisplayName = '';
  if (state.userType === 'supplier' && seller && seller.name) {
    const parts = seller.name.split('/');
    if (parts.length > 1) {
      sellerDisplayName = parts[1]; // 닉네임(팔로워수)
      displayTitle = parts[1];
    } else {
      sellerDisplayName = seller.name;
      displayTitle = seller.name;
    }
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  // 공급사용 모달
  if (state.userType === 'supplier') {
    m.innerHTML = `
      <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
          <h3 class="modal-title">📅 공구 상세</h3>
          <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 8px;">${displayTitle}</h2>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          <div style="background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">📅 기간</span>
                <span style="font-weight: 600;">${deal.startDate} ~ ${deal.endDate}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--gray-500);">셀러</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-weight: 600;">${sellerDisplayName}</span>
                  ${(seller?.channelLink || seller?.accountLink) ? `
                    <a href="${(seller.channelLink || seller.accountLink).startsWith('http') ? (seller.channelLink || seller.accountLink) : 'https://' + (seller.channelLink || seller.accountLink)}" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--info-light); border-radius: 20px; font-size: 12px; color: var(--info); text-decoration: none; font-weight: 500;">
                      ${getChannelIconPortal(seller.channelLink || seller.accountLink)} 채널
                    </a>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
          
          <!-- 샘플 배송 정보 (고정) -->
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px;">📦 샘플 배송 정보</h4>
            <div style="padding: 16px; background: var(--info-light); border-radius: 12px;">
              <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">받는이</span>
                  <span style="font-weight: 600;">모여라딜</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">연락처</span>
                  <span style="font-weight: 600;">010-4320-4179</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <span style="color: var(--gray-500);">주소</span>
                  <span style="font-weight: 600; text-align: right; max-width: 220px;">${seller?.address || '-'}</span>
                </div>
                ${(seller?.channelLink || seller?.accountLink) ? `
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <span style="color: var(--gray-500);">계정</span>
                    <a href="${(seller.channelLink || seller.accountLink).startsWith('http') ? (seller.channelLink || seller.accountLink) : 'https://' + (seller.channelLink || seller.accountLink)}" target="_blank" style="color: var(--info); font-weight: 500; text-align: right; max-width: 220px; word-break: break-all;">${seller.channelLink || seller.accountLink}</a>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
          
          <!-- 샘플 전달 상태 -->
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px;">📋 샘플 전달</h4>
            <div style="padding: 16px; background: ${deal.journeySample ? 'var(--success-light)' : 'var(--gray-50)'}; border-radius: 12px; border: 2px solid ${deal.journeySample ? 'var(--success)' : 'var(--gray-200)'};">
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <input type="checkbox" ${deal.journeySample ? 'checked' : ''} onchange="toggleSampleDelivery('${deal.id}', this.checked)" style="width: 20px; height: 20px; accent-color: var(--success);">
                <div>
                  <div style="font-weight: 600; color: ${deal.journeySample ? 'var(--success)' : 'var(--gray-700)'};">
                    ${deal.journeySample ? '✓ 샘플 전달 완료' : '샘플 전달 대기중'}
                  </div>
                  <div style="font-size: 12px; color: var(--gray-500);">샘플을 전달했다면 체크해주세요</div>
                </div>
              </label>
            </div>
          </div>
          
          ${products.length > 0 ? `
            <div style="margin-bottom: 16px;">
              <h4 style="margin-bottom: 12px;">🛒 공구 상품</h4>
              ${products.map(p => `
                <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
                  <div style="font-weight: 600;">${p.productName}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          <!-- 셀러 업로드 컨텐츠 파일 -->
          ${(deal.contentFiles && deal.contentFiles.length > 0) ? `
            <div style="margin-bottom: 16px;">
              <h4 style="margin-bottom: 12px;">📁 셀러 업로드 컨텐츠</h4>
              <div style="padding: 16px; background: #f0fdf4; border-radius: 12px; border: 1px solid #86efac;">
                <div style="font-size: 12px; color: #16a34a; margin-bottom: 12px;">✓ 셀러가 ${deal.contentFiles.length}개 파일을 업로드했습니다</div>
                ${deal.contentFiles.map((file, idx) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <span style="font-size: 18px;">${file.type === 'image' ? '🖼️' : file.type === 'video' ? '🎬' : '📄'}</span>
                      <div>
                        <div style="font-weight: 600; font-size: 12px;">${file.name}</div>
                        <div style="font-size: 10px; color: var(--gray-500);">${file.uploadedAt || ''}</div>
                      </div>
                    </div>
                    <a href="${file.url}" target="_blank" style="padding: 6px 12px; background: var(--primary); color: white; border-radius: 6px; font-size: 12px; text-decoration: none; font-weight: 600;">다운로드</a>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          ${deal.notes ? `
            <div style="padding: 16px; background: var(--warning-light); border-radius: 12px;">
              <h4 style="margin-bottom: 8px; color: var(--warning);">📝 메모</h4>
              <p style="font-size: 14px;">${deal.notes}</p>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  } else {
    // ========================================================
    // 셀러용 모달 - 공구 준비에 집중한 심플한 UX
    // ========================================================
    const checklist = deal.sellerChecklist || {};
    const sampleDelivered = deal.journeySample || false;
    
    const checklistItems = [
      { key: 'sampleReceived', label: '샘플 수령', auto: true, checked: sampleDelivered },
      { key: 'shooting', label: '촬영 완료' },
      { key: 'contentDone', label: '컨텐츠 업로드' }
    ];
    
    const manualItems = checklistItems.filter(item => !item.auto);
    const manualCompleted = manualItems.filter(item => checklist[item.key]).length;
    const totalCompleted = (sampleDelivered ? 1 : 0) + manualCompleted;
    const progress = Math.round((totalCompleted / checklistItems.length) * 100);
    
    const contentFiles = deal.contentFiles || [];
    const brandName = supplier?.name || '브랜드';
    
    // 혜택 목록
    const benefits = [deal.negotiation?.eventSupplier, deal.negotiation?.eventMoyeora, deal.negotiation?.event]
      .filter(Boolean).join(', ').split(',').map(s => s.trim()).filter(Boolean);
    
    m.innerHTML = `
      <div class="modal-content" style="max-width: 440px; padding: 0; overflow: hidden;">
        
        <!-- 헤더: 브랜드 중심 -->
        <div style="background: var(--primary); padding: 24px; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">${deal.startDate} ~ ${deal.endDate}</div>
              <h2 style="font-size: 22px; font-weight: 700; margin: 0;">${brandName}</h2>
              <div style="font-size: 13px; margin-top: 8px; opacity: 0.9;">상품 ${products.length}종</div>
            </div>
            <button onclick="closeModal()" style="background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; font-size: 18px; cursor: pointer;">×</button>
          </div>
          
          <!-- 진행률 -->
          <div style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px;">
              <span>공구 준비</span>
              <span style="font-weight: 700;">${progress}%</span>
            </div>
            <div style="height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden;">
              <div style="width: ${progress}%; height: 100%; background: white; border-radius: 3px; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>
        
        <div style="padding: 20px;">
          
          <!-- 준비 체크리스트 -->
          <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            ${checklistItems.map((item, idx) => {
              const isChecked = item.auto ? item.checked : checklist[item.key];
              return `
                <div style="flex: 1; text-align: center; padding: 12px 8px; background: ${isChecked ? '#f0fdf4' : '#f9fafb'}; border-radius: 12px; border: 1px solid ${isChecked ? '#86efac' : '#e5e7eb'}; ${item.auto ? '' : 'cursor: pointer;'}" 
                     ${item.auto ? '' : `onclick="toggleSellerChecklist('${deal.id}', '${item.key}', ${!isChecked})"`}>
                  <div style="width: 28px; height: 28px; margin: 0 auto 6px; background: ${isChecked ? '#22c55e' : '#d1d5db'}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 14px;">${isChecked ? '✓' : (idx + 1)}</span>
                  </div>
                  <div style="font-size: 11px; font-weight: 600; color: ${isChecked ? '#16a34a' : '#6b7280'};">${item.label}</div>
                </div>
              `;
            }).join('')}
          </div>
          
          <!-- 메인 액션 버튼들 -->
          <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
            <button onclick="openGuideModal('${deal.id}')" 
               style="display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 16px; background: var(--primary); color: white; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; font-size: 15px;">
              📋 맞춤공구 가이드
              <span style="font-size: 12px; opacity: 0.8;">상품정보 · 캡션 · Q&A</span>
            </button>
            
            <button onclick="document.getElementById('upload-section').scrollIntoView({behavior:'smooth'})" 
               style="display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 14px; background: #f9fafb; color: #374151; border-radius: 12px; border: 1px solid #e5e7eb; cursor: pointer; font-weight: 600; font-size: 14px;">
              📁 컨텐츠 업로드
              <span style="background: ${contentFiles.length > 0 ? '#22c55e' : '#9ca3af'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${contentFiles.length}개</span>
            </button>
          </div>
          
          ${benefits.length > 0 ? `
          <!-- 혜택 요약 -->
          <div style="padding: 14px; background: #fffbeb; border-radius: 12px; margin-bottom: 20px;">
            <div style="font-size: 12px; font-weight: 600; color: #d97706; margin-bottom: 8px;">🎁 이번 공구 혜택</div>
            <div style="font-size: 13px; color: #92400e; line-height: 1.6;">
              ${benefits.map((b, i) => `<span style="display: inline-block; margin-right: 4px;">${i > 0 ? '·' : ''} ${b}</span>`).join('')}
            </div>
          </div>
          ` : ''}
          
          <!-- 컨텐츠 업로드 섹션 -->
          <div id="upload-section" style="padding: 16px; background: #f9fafb; border-radius: 12px; border: 1px dashed #d1d5db;">
            <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">📁 업로드된 컨텐츠</div>
            
            ${contentFiles.length > 0 ? `
              <div style="margin-bottom: 12px;">
                ${contentFiles.map((file, idx) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: white; border-radius: 8px; margin-bottom: 6px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 8px; min-width: 0; flex: 1;">
                      <span>${file.type === 'image' ? '🖼️' : file.type === 'video' ? '🎬' : '📄'}</span>
                      <span style="font-size: 12px; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</span>
                    </div>
                    <div style="display: flex; gap: 4px; flex-shrink: 0;">
                      <a href="${file.url}" target="_blank" style="padding: 4px 8px; background: #eff6ff; color: #2563eb; border-radius: 4px; font-size: 11px; text-decoration: none;">보기</a>
                      <button onclick="removeContentFile('${deal.id}', ${idx})" style="padding: 4px 8px; background: #fef2f2; color: #dc2626; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">삭제</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                아직 업로드된 파일이 없어요
              </div>
            `}
            
            <div style="display: flex; gap: 8px;">
              <button onclick="addContentFileUrl('${deal.id}')" style="flex: 1; padding: 10px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 12px; font-weight: 600; color: #374151; cursor: pointer;">
                🔗 URL 추가
              </button>
              <button onclick="openGoogleDriveUpload('${deal.id}')" style="flex: 1; padding: 10px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 12px; font-weight: 600; color: #374151; cursor: pointer;">
                📂 드라이브 링크
              </button>
            </div>
          </div>
          
          ${deal.notes ? `
            <div style="margin-top: 16px; padding: 12px; background: #eff6ff; border-radius: 8px;">
              <div style="font-size: 11px; color: #2563eb; font-weight: 600; margin-bottom: 4px;">📝 메모</div>
              <div style="font-size: 13px; color: #1e40af;">${deal.notes}</div>
            </div>
          ` : ''}
          
        </div>
      </div>
    `;
  }
}

// 샘플 전달 토글 (공급사용)
async function toggleSampleDelivery(dealId, checked) {
  try {
    await db.collection('deals').doc(dealId).update({
      journeySample: checked
    });
    showToast(checked ? '샘플 전달 완료 처리되었습니다.' : '샘플 전달 상태가 취소되었습니다.');
    // 모달 새로고침
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('처리에 실패했습니다.');
  }
}

// 셀러 체크리스트 토글
async function toggleSellerChecklist(dealId, key, checked) {
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const currentChecklist = deal?.sellerChecklist || {};
    currentChecklist[key] = checked;
    
    await db.collection('deals').doc(dealId).update({
      sellerChecklist: currentChecklist
    });
    showToast(checked ? '체크 완료!' : '체크 해제됨');
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('처리에 실패했습니다.');
  }
}

// ============================================================
// 📝 컨텐츠 가이드 모달
// ============================================================
// 🎨 디자인 가이드라인 (새 기능 추가 시 반드시 준수)
// ------------------------------------------------------------
// ✅ 컬러 시스템:
//    - Primary: #fc9600 (메인 주황)
//    - Primary Dark: #e08600 (진한 주황)
//    - Primary Light: #fff8f0 (연한 주황 배경)
//    - Primary Lighter: #fffbeb (더 연한 주황)
//    - White: #ffffff
//    - Gray-50: #f9fafb (배경)
//    - Gray-100: #f3f4f6 (구분선, 비활성)
//    - Gray-500: #6b7280 (보조 텍스트)
//    - Gray-900: #111827 (주요 텍스트)
// 
// ✅ 간격 시스템 (4px 단위):
//    - xs: 4px, sm: 8px, md: 12px, lg: 16px, xl: 20px, 2xl: 24px
// 
// ✅ 모서리 반경:
//    - sm: 6px, md: 8px, lg: 12px, xl: 16px
// 
// ✅ 폰트:
//    - 제목: 16px/700, 소제목: 14px/600, 본문: 13px/400, 캡션: 12px/400
// 
// ✅ 그림자: 없음 (플랫 디자인)
// ✅ 테두리: 1px solid #f3f4f6 (얇고 연하게)
// ============================================================

function openGuideModal(dealId) {
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;
  
  const supplier = state.suppliers.find(s => s.id === deal.supplierId);
  const seller = state.sellers.find(s => s.id === deal.sellerId);
  
  // 셀러 닉네임 추출
  let sellerNickname = '셀러';
  if (seller?.name) {
    const parts = seller.name.split('/');
    sellerNickname = parts.length > 1 ? parts[1].replace(/\([^)]*\)/g, '').trim() : seller.name;
  }
  
  const brandName = supplier?.name || '브랜드';
  
  // 상품 정보
  const products = (deal.selectedProducts || []).map(item => {
    const pid = typeof item === 'string' ? item : item.productId;
    const product = state.supplierProducts.find(p => p.id === pid);
    return product ? {
      ...product,
      marginRate: typeof item === 'object' ? item.marginRate : 0
    } : null;
  }).filter(Boolean);
  
  // 혜택 (쉼표로 분리)
  const nego = deal.negotiation || {};
  const benefits = [nego.eventSupplier, nego.eventMoyeora, nego.event]
    .filter(Boolean)
    .join(', ')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="guide-modal">
      <!-- 헤더 -->
      <div class="guide-header">
        <div class="guide-header-content">
          <div class="guide-title">${brandName} 맞춤공구 가이드</div>
          <div class="guide-subtitle">${sellerNickname}</div>
        </div>
        <button class="guide-close" onclick="closeModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <!-- 탭 -->
      <div class="guide-tabs">
        <button class="guide-tab active" data-tab="product" onclick="showGuideTab('product', this)">상품</button>
        <button class="guide-tab" data-tab="schedule" onclick="showGuideTab('schedule', this)">일정</button>
        <button class="guide-tab" data-tab="caption" onclick="showGuideTab('caption', this)">캡션</button>
        <button class="guide-tab" data-tab="chatbot" onclick="showGuideTab('chatbot', this)">💬 Q&A</button>
      </div>
      
      <!-- 컨텐츠 -->
      <div class="guide-body">
        
        <!-- 상품 탭 -->
        <div id="guide-product" class="guide-content active">
          <div class="guide-section">
            <div class="guide-section-title">공구 상품</div>
            <div class="guide-product-list">
              ${products.length > 0 ? products.map((p, idx) => `
                <div class="guide-product-item ${idx === 0 ? 'featured' : ''}">
                  <div class="guide-product-info">
                    <div class="guide-product-name">${p.productName}</div>
                    <div class="guide-product-brand">${brandName}</div>
                  </div>
                  <div class="guide-product-margin">
                    <span class="margin-value">${p.marginRate || 0}%</span>
                    <span class="margin-label">마진</span>
                  </div>
                </div>
              `).join('') : '<div class="guide-empty">등록된 상품이 없습니다</div>'}
            </div>
          </div>
          
          ${benefits.length > 0 ? `
            <div class="guide-section">
              <div class="guide-section-title">이번 공구 혜택</div>
              <div class="guide-benefit-box">
                ${benefits.map((b, idx) => `
                  <div class="guide-benefit-item">
                    <span class="benefit-num">${idx + 1}</span>
                    <span class="benefit-text">${b}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
        
        <!-- 일정 탭 -->
        <div id="guide-schedule" class="guide-content">
          <div class="guide-section">
            <div class="guide-section-title">📅 필수 피드 3개</div>
            <div class="guide-timeline">
              <div class="timeline-item">
                <div class="timeline-num">1</div>
                <div class="timeline-content">
                  <div class="timeline-title">🔥 공구예고 D-1</div>
                  <div class="timeline-desc">"알림" 댓글 이벤트 진행</div>
                  ${benefits[0] ? `<div class="timeline-badge">${benefits[0]}</div>` : ''}
                  <div class="timeline-sub">당첨발표는 공구오픈 피드에서!</div>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-num">2</div>
                <div class="timeline-content">
                  <div class="timeline-title">🔥 공구예고 D-8시간</div>
                  <div class="timeline-desc">선착순/후기인증 이벤트 리마인드</div>
                  ${benefits[1] ? `<div class="timeline-badge">${benefits[1]}</div>` : ''}
                  ${benefits[2] ? `<div class="timeline-badge">${benefits[2]}</div>` : ''}
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-num">3</div>
                <div class="timeline-content">
                  <div class="timeline-title">🔥 공구오픈</div>
                  <div class="timeline-desc">D-1 알림댓글 당첨자 발표 (피드 내)<br>상품 상세 소개</div>
                  <div class="timeline-badge">선착순/후기인증 → 댓글 고정으로 발표</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="guide-tip-box">
            <div class="tip-icon">💡</div>
            <div class="tip-content">
              <div class="tip-title">판매 UP 꿀팁!</div>
              <div class="tip-desc">스토리나 추가 피드로 홍보하면 판매량이 더 올라가요!</div>
            </div>
          </div>
        </div>
        
        <!-- 캡션 탭 -->
        <div id="guide-caption" class="guide-content">
          <div class="guide-section">
            <div class="guide-section-title">🔗 상품 링크</div>
            ${(deal.productLinks || []).length > 0 ? `
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${(deal.productLinks || []).map(link => `
                  <a href="${link.url}" target="_blank" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; text-decoration: none; border: 1px solid #e5e7eb;">
                    <div>
                      <div style="font-size: 13px; font-weight: 600; color: #111827;">${link.name || '상품링크'}</div>
                      <div style="font-size: 11px; color: #6b7280; margin-top: 2px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${link.url}</div>
                    </div>
                    <button type="button" onclick="event.preventDefault(); copyToClipboard('${link.url}'); showToast('📋 링크가 복사되었습니다!');" style="padding: 6px 12px; background: #fc9600; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">복사</button>
                  </a>
                `).join('')}
              </div>
            ` : `
              <div style="padding: 16px; background: #f9fafb; border-radius: 8px; text-align: center; color: #6b7280; font-size: 13px;">
                등록된 상품링크가 없습니다<br>
                <span style="font-size: 11px; color: #9ca3af;">어드민에서 상품링크를 등록해주세요</span>
              </div>
            `}
          </div>
          
          <div class="guide-section">
            <div class="guide-section-title">✍️ 캡션 복사</div>
            
            <div class="guide-caption-card">
              <div class="caption-header">
                <span class="caption-num">1</span>
                <span class="caption-title">공구예고 D-1</span>
              </div>
              <div class="caption-body" id="caption-1">🔥 공구오픈 D-1

환절기 필수템!
${brandName} 🍐

체험하실분~ 댓글 남겨주는 분께
${benefits[0] ? benefits[0] + ' 보내드릴게요~!' : '혜택을 드려요!'}

"알림" 댓글 남겨주세요 :)
당첨발표는 공구오픈피드에서 만나요~!

${benefits[1] ? `🎁 ${benefits[1]}` : ''}
${benefits[2] ? `🎁 ${benefits[2]}` : ''}

📍 오픈일시: ${deal.startDate}
📍 프로필 링크 확인해주세요!</div>
              <button class="caption-copy-btn" onclick="copyGuideCaption(1)">복사</button>
            </div>
            
            <div class="guide-caption-card">
              <div class="caption-header">
                <span class="caption-num">2</span>
                <span class="caption-title">공구예고 D-8시간</span>
              </div>
              <div class="caption-body" id="caption-2">🔥 공구오픈 D-8시간

${benefits[1] ? `🎁 ${benefits[1]}` : ''}
${benefits[2] ? `🎁 ${benefits[2]}` : ''}

━━━━━━━━━━━━

D-1 공구예고 피드에 댓글주시면
${benefits[0] ? benefits[0] + ' 보내드리니까' : '혜택 드리니까'}
잊지마세요!

📍 오늘 오픈!
📍 프로필 링크 확인해주세요!</div>
              <button class="caption-copy-btn" onclick="copyGuideCaption(2)">복사</button>
            </div>
            
            <div class="guide-caption-card">
              <div class="caption-header">
                <span class="caption-num">3</span>
                <span class="caption-title">공구오픈</span>
              </div>
              <div class="caption-body" id="caption-3">🔥 공구 오픈! 🔥

🍐 ${brandName} 특별할인 🍐
${sellerNickname} X ${brandName}

📢 알림댓글 당첨자
[@당첨자1 @당첨자2 ...]
축하드려요! DM 주세요 💌

━━━━━━━━━━━━

📦 상품 구성
${products.map(p => `• ${p.productName}`).join('\n')}

━━━━━━━━━━━━

🛒 구매는 프로필 링크에서!

✨ 선착순/후기인증 당첨자는
댓글 고정으로 발표해요!</div>
              <button class="caption-copy-btn" onclick="copyGuideCaption(3)">복사</button>
            </div>
          </div>
          
          <div class="guide-section">
            <div class="guide-section-title">#️⃣ 해시태그</div>
            <div class="guide-hashtag-box">
              <div class="hashtag-list">
                <span class="hashtag-item">#${brandName.replace(/\s/g, '')}</span>
                <span class="hashtag-item">#공동구매</span>
                <span class="hashtag-item">#모여라딜</span>
                <span class="hashtag-item">#특가</span>
                <span class="hashtag-item">#환절기</span>
              </div>
              <button class="hashtag-copy-btn" onclick="copyGuideHashtags('${brandName}')">전체 복사</button>
            </div>
          </div>
        </div>
        
        <!-- 💬 챗봇 탭 -->
        <div id="guide-chatbot" class="guide-content">
          <div class="guide-section">
            <div class="guide-section-title">💬 상품 Q&A 챗봇</div>
            <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px;">
              고객 질문에 대한 답변을 AI가 도와드려요!<br>
              상품 정보를 기반으로 답변을 생성합니다.
            </p>
            
            <!-- 챗봇 대화창 -->
            <div id="chatbot-messages" style="height: 280px; overflow-y: auto; background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 12px;">
              <div class="chat-message bot">
                <div class="chat-bubble">안녕하세요! 🙋‍♀️<br>${brandName} 상품에 대해 궁금한 점을 물어보세요!</div>
              </div>
            </div>
            
            <!-- 빠른 질문 버튼 -->
            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
              <button type="button" class="quick-question-btn" onclick="askQuickQuestion('이 상품의 장점이 뭐예요?')">장점이 뭐예요?</button>
              <button type="button" class="quick-question-btn" onclick="askQuickQuestion('유통기한은 어떻게 되나요?')">유통기한은?</button>
              <button type="button" class="quick-question-btn" onclick="askQuickQuestion('배송은 얼마나 걸려요?')">배송 기간은?</button>
              <button type="button" class="quick-question-btn" onclick="askQuickQuestion('교환/환불 가능한가요?')">교환/환불?</button>
            </div>
            
            <!-- 입력창 -->
            <div style="display: flex; gap: 8px;">
              <input type="text" id="chatbot-input" class="guide-input" placeholder="질문을 입력하세요..." onkeypress="if(event.key==='Enter') sendChatMessage('${dealId}')">
              <button type="button" onclick="sendChatMessage('${dealId}')" style="padding: 10px 16px; background: #fc9600; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">전송</button>
            </div>
          </div>
          
          <!-- 자주 묻는 질문 답변 템플릿 -->
          <div class="guide-section">
            <div class="guide-section-title">📝 답변 템플릿</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <div class="template-item" onclick="copyTemplate(this)">
                <div class="template-q">Q. 배송은 얼마나 걸리나요?</div>
                <div class="template-a">A. 공구 마감 다음날 일괄발송되고, 발송 후 1-2일이면 받아보실 수 있어요! 🚚</div>
              </div>
              <div class="template-item" onclick="copyTemplate(this)">
                <div class="template-q">Q. 교환/환불 가능한가요?</div>
                <div class="template-a">A. 단순 변심은 수령 후 7일 이내 가능하고, 제품 하자 시 무료 교환/환불됩니다! 💯</div>
              </div>
              <div class="template-item" onclick="copyTemplate(this)">
                <div class="template-q">Q. 유통기한은 어떻게 되나요?</div>
                <div class="template-a">A. 제조일로부터 12개월이며, 넉넉하게 6개월 이상 남은 제품으로 발송됩니다! 📦</div>
              </div>
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- 푸터 -->
      <div class="guide-footer">
        <button class="guide-back-btn" onclick="openDealModal('${dealId}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          공구 상세로 돌아가기
        </button>
      </div>
    </div>
  `;
  
  // 가이드 모달 스타일 (토스 스타일)
  if (!document.getElementById('guide-modal-style')) {
    const style = document.createElement('style');
    style.id = 'guide-modal-style';
    style.textContent = `
      /* ============================================================
         🎨 가이드 모달 스타일 - 토스 스타일 디자인 시스템
         새 기능 추가 시 이 스타일 가이드를 따라주세요!
         ============================================================ */
      
      .guide-modal {
        width: 100%;
        max-width: 420px;
        max-height: 90vh;
        background: #fff;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      /* 헤더 */
      .guide-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 20px 16px;
        background: #fff;
        border-bottom: 1px solid #f3f4f6;
      }
      .guide-header-content { flex: 1; }
      .guide-title {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 2px;
      }
      .guide-subtitle {
        font-size: 13px;
        color: #fc9600;
        font-weight: 500;
      }
      .guide-close {
        width: 32px;
        height: 32px;
        border: none;
        background: #f3f4f6;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
      }
      .guide-close:hover { background: #e5e7eb; }
      
      /* 탭 */
      .guide-tabs {
        display: flex;
        padding: 0 20px;
        background: #fff;
        border-bottom: 1px solid #f3f4f6;
      }
      .guide-tab {
        flex: 1;
        padding: 14px 0;
        border: none;
        background: none;
        font-size: 14px;
        font-weight: 500;
        color: #9ca3af;
        cursor: pointer;
        position: relative;
        transition: color 0.2s;
      }
      .guide-tab.active {
        color: #fc9600;
        font-weight: 600;
      }
      .guide-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 20%;
        right: 20%;
        height: 2px;
        background: #fc9600;
        border-radius: 2px;
      }
      
      /* 바디 */
      .guide-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f9fafb;
      }
      .guide-content { display: none; }
      .guide-content.active { display: block; }
      
      /* 섹션 */
      .guide-section {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
      }
      .guide-section:last-child { margin-bottom: 0; }
      .guide-section-title {
        font-size: 13px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 12px;
      }
      
      /* 상품 리스트 */
      .guide-product-list { display: flex; flex-direction: column; gap: 8px; }
      .guide-product-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
      }
      .guide-product-item.featured {
        background: #fff8f0;
        border: 1px solid #fed7aa;
      }
      .guide-product-name {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 2px;
      }
      .guide-product-brand {
        font-size: 12px;
        color: #9ca3af;
      }
      .guide-product-margin { text-align: right; }
      .margin-value {
        font-size: 16px;
        font-weight: 700;
        color: #fc9600;
      }
      .margin-label {
        display: block;
        font-size: 11px;
        color: #9ca3af;
      }
      .guide-empty {
        text-align: center;
        padding: 24px;
        color: #9ca3af;
        font-size: 13px;
      }
      
      /* 혜택 박스 */
      .guide-benefit-box {
        background: #fffbeb;
        border-radius: 8px;
        padding: 12px;
      }
      .guide-benefit-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 8px;
      }
      .guide-benefit-item:last-child { margin-bottom: 0; }
      .benefit-num {
        width: 20px;
        height: 20px;
        background: #fc9600;
        color: #fff;
        border-radius: 50%;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .benefit-text {
        font-size: 13px;
        color: #92400e;
        line-height: 1.4;
      }
      
      /* 타임라인 */
      .guide-timeline { display: flex; flex-direction: column; gap: 0; }
      .timeline-item {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
      }
      .timeline-item:last-child { border-bottom: none; }
      .timeline-num {
        width: 28px;
        height: 28px;
        background: #fc9600;
        color: #fff;
        border-radius: 50%;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .timeline-content { flex: 1; padding-top: 2px; }
      .timeline-title {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 2px;
      }
      .timeline-desc {
        font-size: 12px;
        color: #6b7280;
      }
      .timeline-badge {
        display: inline-block;
        margin-top: 6px;
        margin-right: 4px;
        padding: 3px 8px;
        background: #fff8f0;
        color: #fc9600;
        font-size: 11px;
        font-weight: 600;
        border-radius: 4px;
      }
      .timeline-sub {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
      }
      
      /* 팁 박스 */
      .guide-tip-box {
        display: flex;
        gap: 12px;
        padding: 14px;
        background: #fff;
        border-radius: 12px;
        border: 1px solid #f3f4f6;
      }
      .tip-icon { font-size: 20px; }
      .tip-title {
        font-size: 13px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 2px;
      }
      .tip-desc {
        font-size: 12px;
        color: #6b7280;
      }
      
      /* 인풋 */
      .guide-input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
      }
      .guide-input:focus {
        outline: none;
        border-color: #fc9600;
      }
      .guide-input-hint {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 6px;
      }
      
      /* 캡션 카드 */
      .guide-caption-card {
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
      }
      .guide-caption-card:last-of-type { margin-bottom: 0; }
      .caption-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: #fff;
        border-bottom: 1px solid #f3f4f6;
      }
      .caption-num {
        width: 20px;
        height: 20px;
        background: #fc9600;
        color: #fff;
        border-radius: 50%;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .caption-title {
        font-size: 13px;
        font-weight: 600;
        color: #111827;
      }
      .caption-body {
        padding: 12px;
        font-size: 12px;
        line-height: 1.6;
        color: #374151;
        white-space: pre-line;
        max-height: 120px;
        overflow-y: auto;
      }
      .caption-copy-btn {
        display: block;
        width: 100%;
        padding: 10px;
        border: none;
        background: #fff;
        border-top: 1px solid #f3f4f6;
        font-size: 13px;
        font-weight: 600;
        color: #fc9600;
        cursor: pointer;
        transition: background 0.2s;
      }
      .caption-copy-btn:hover { background: #fff8f0; }
      
      /* 해시태그 */
      .guide-hashtag-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .hashtag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        flex: 1;
      }
      .hashtag-item {
        padding: 4px 10px;
        background: #fff8f0;
        color: #fc9600;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
      }
      .hashtag-copy-btn {
        padding: 8px 14px;
        border: 1px solid #fc9600;
        background: #fff;
        color: #fc9600;
        font-size: 12px;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        white-space: nowrap;
      }
      .hashtag-copy-btn:hover { background: #fff8f0; }
      
      /* 챗봇 스타일 */
      .chat-message {
        display: flex;
        margin-bottom: 12px;
      }
      .chat-message.bot { justify-content: flex-start; }
      .chat-message.user { justify-content: flex-end; }
      .chat-bubble {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 13px;
        line-height: 1.5;
      }
      .chat-message.bot .chat-bubble {
        background: #fff;
        color: #111827;
        border: 1px solid #e5e7eb;
        border-bottom-left-radius: 4px;
      }
      .chat-message.user .chat-bubble {
        background: #fc9600;
        color: #fff;
        border-bottom-right-radius: 4px;
      }
      .quick-question-btn {
        padding: 6px 12px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        font-size: 12px;
        color: #374151;
        cursor: pointer;
        transition: all 0.15s;
      }
      .quick-question-btn:hover {
        background: #fff8f0;
        border-color: #fc9600;
        color: #fc9600;
      }
      .template-item {
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.15s;
      }
      .template-item:hover { background: #fff8f0; }
      .template-q {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
      }
      .template-a {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* 푸터 */
      .guide-footer {
        padding: 16px 20px;
        background: #fff;
        border-top: 1px solid #f3f4f6;
      }
      .guide-back-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
        padding: 12px;
        border: none;
        background: #f3f4f6;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        transition: background 0.2s;
      }
      .guide-back-btn:hover { background: #e5e7eb; }
    `;
    document.head.appendChild(style);
  }
}

// 가이드 탭 전환
function showGuideTab(tabId, btn) {
  document.querySelectorAll('.guide-content').forEach(el => {
    el.classList.remove('active');
  });
  document.getElementById('guide-' + tabId).classList.add('active');
  
  document.querySelectorAll('.guide-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// 가이드 캡션 복사
function copyGuideCaption(num) {
  const captionEl = document.getElementById('caption-' + num);
  if (captionEl) {
    navigator.clipboard.writeText(captionEl.textContent).then(() => {
      showToast('📋 캡션이 복사되었습니다!');
    });
  }
}

// 가이드 해시태그 복사
function copyGuideHashtags(brandName) {
  const hashtags = `#${brandName.replace(/\s/g, '')} #공동구매 #모여라딜 #특가 #할인`;
  navigator.clipboard.writeText(hashtags).then(() => {
    showToast('📋 해시태그가 복사되었습니다!');
  });
}

// 클립보드 복사 헬퍼
function copyToClipboard(text) {
  navigator.clipboard.writeText(text);
}

// 챗봇 - 빠른 질문
function askQuickQuestion(question) {
  const input = document.getElementById('chatbot-input');
  input.value = question;
  // 자동 전송
  const dealId = document.querySelector('.guide-back-btn')?.onclick?.toString().match(/'([^']+)'/)?.[1];
  if (dealId) sendChatMessage(dealId);
}

// 챗봇 - 메시지 전송
function sendChatMessage(dealId) {
  const input = document.getElementById('chatbot-input');
  const question = input.value.trim();
  if (!question) return;
  
  const messagesContainer = document.getElementById('chatbot-messages');
  
  // 사용자 메시지 추가
  messagesContainer.innerHTML += `
    <div class="chat-message user">
      <div class="chat-bubble">${question}</div>
    </div>
  `;
  
  input.value = '';
  
  // 로딩 표시
  messagesContainer.innerHTML += `
    <div class="chat-message bot" id="chatbot-loading">
      <div class="chat-bubble">답변 생성 중...</div>
    </div>
  `;
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // 상품 정보 기반 답변 생성 (간단한 규칙 기반)
  const deal = state.deals.find(d => d.id === dealId);
  const supplier = state.suppliers.find(s => s.id === deal?.supplierId);
  const brandName = supplier?.name || '브랜드';
  
  setTimeout(() => {
    const loadingEl = document.getElementById('chatbot-loading');
    if (loadingEl) loadingEl.remove();
    
    const answer = generateChatbotAnswer(question, brandName, deal);
    
    messagesContainer.innerHTML += `
      <div class="chat-message bot">
        <div class="chat-bubble">${answer}</div>
      </div>
    `;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }, 800);
}

// 챗봇 답변 생성 (규칙 기반)
function generateChatbotAnswer(question, brandName, deal) {
  const q = question.toLowerCase();
  const endDate = deal?.endDate || '공구 마감일';
  
  // 대표상품 그룹 정보 가져오기
  const products = deal?.selectedProducts || [];
  const productGroupIds = [...new Set(products.map(p => {
    const prod = state.supplierProducts.find(sp => sp.id === (typeof p === 'string' ? p : p.productId));
    return prod?.productGroupId;
  }).filter(Boolean))];
  
  // 대표상품 그룹 데이터 (첫 번째 그룹 기준)
  const productGroup = productGroupIds.length > 0 
    ? (state.productGroups || []).find(pg => pg.id === productGroupIds[0]) 
    : null;
  
  const baseInfo = productGroup?.baseInfo || {};
  const policies = productGroup?.policies || {};
  const faqs = productGroup?.faqs || [];
  
  // 1. 공급사가 등록한 FAQ에서 먼저 검색
  for (const faq of faqs) {
    const faqKeywords = faq.q.toLowerCase().split(/\s+/);
    const matchCount = faqKeywords.filter(kw => kw.length > 1 && q.includes(kw)).length;
    if (matchCount >= 2 || (faqKeywords.length <= 2 && matchCount >= 1)) {
      return faq.a;
    }
  }
  
  // 2. 기본 정보 기반 답변
  if (q.includes('성분') || q.includes('원료') || q.includes('뭐로') || q.includes('재료')) {
    if (baseInfo.ingredients) {
      return `${brandName} 제품의 주요 성분은 ${baseInfo.ingredients}입니다! 🍀`;
    }
    return `${brandName} 제품은 엄선된 원료를 사용해요. 상세페이지에서 확인해보세요! 🍀`;
  }
  
  if (q.includes('유통기한') || q.includes('유효기간') || q.includes('언제까지')) {
    if (baseInfo.shelfLife) {
      return `유통기한은 ${baseInfo.shelfLife}이고, 넉넉하게 남은 제품으로 발송됩니다! 📦`;
    }
    return `보통 제조일로부터 12개월 정도이며, 넉넉하게 남은 제품으로 발송됩니다! 📦`;
  }
  
  if (q.includes('보관') || q.includes('냉장') || q.includes('냉동') || q.includes('상온')) {
    if (baseInfo.storage) {
      return `${baseInfo.storage}으로 보관해주시면 됩니다! 📦`;
    }
    return `상세페이지의 보관방법을 확인해주세요!`;
  }
  
  if (q.includes('아이') || q.includes('아기') || q.includes('어린이') || q.includes('몇살')) {
    if (baseInfo.target) {
      return `${baseInfo.target}에게 권장됩니다! 👶`;
    }
    return `상세페이지에 권장 연령이 표기되어 있어요. 확인해주세요! 👶`;
  }
  
  if (q.includes('장점') || q.includes('좋은점') || q.includes('추천') || q.includes('특징')) {
    if (baseInfo.features) {
      return `${brandName} 제품의 특장점은 ${baseInfo.features}입니다! 💪`;
    }
    return `${brandName} 제품은 품질이 검증되었고, 이번 공구 특가로 저렴하게 구매하실 수 있어요! 💪`;
  }
  
  // 3. 정책 기반 답변
  if (q.includes('배송') || q.includes('도착') || q.includes('발송') || q.includes('언제 와')) {
    const shippingInfo = policies.shipping || '공구 마감 다음날 일괄발송';
    return `${shippingInfo} 📦\n\n이번 공구 마감일: ${endDate}\n예상 수령: 발송 후 1-2일\n\n조금만 기다려주시면 빠르게 받아보실 수 있어요! 🚚`;
  }
  
  if (q.includes('교환') || q.includes('환불') || q.includes('반품')) {
    const exchangeInfo = policies.exchange || '단순변심 7일 이내, 제품 하자 시 무료 교환/환불';
    return `${exchangeInfo} 💯 안심하고 구매하세요!`;
  }
  
  if (q.includes('가격') || q.includes('할인') || q.includes('특가')) {
    return `이번 공구는 정말 특별한 할인가예요! 이런 가격 다시 없을 수도 있으니 꼭 놓치지 마세요! 🎉`;
  }
  
  return `좋은 질문이에요! "${question}"에 대해서는 상세페이지를 참고해주시거나, DM으로 문의 주시면 자세히 안내해드릴게요! 😊`;
}

// 템플릿 복사
function copyTemplate(el) {
  const answer = el.querySelector('.template-a').textContent;
  navigator.clipboard.writeText(answer).then(() => {
    showToast('📋 답변이 복사되었습니다!');
  });
}

// 컨텐츠 URL 추가
async function addContentFileUrl(dealId) {
  const url = prompt('컨텐츠 URL을 입력하세요 (이미지, 영상, 드라이브 링크 등):');
  if (!url) return;
  
  const name = prompt('파일 이름을 입력하세요:', 'content_' + Date.now());
  if (!name) return;
  
  // 파일 타입 추정
  let type = 'file';
  if (url.match(/\.(jpg|jpeg|png|gif|webp)/i)) type = 'image';
  else if (url.match(/\.(mp4|mov|avi|webm)/i)) type = 'video';
  else if (url.includes('drive.google.com')) type = 'drive';
  
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const contentFiles = deal?.contentFiles || [];
    contentFiles.push({
      name,
      url,
      type,
      uploadedAt: new Date().toLocaleDateString('ko-KR')
    });
    
    await db.collection('deals').doc(dealId).update({ contentFiles });
    showToast('파일이 추가되었습니다.');
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('파일 추가에 실패했습니다.');
  }
}

// 구글 드라이브 링크 추가
async function openGoogleDriveUpload(dealId) {
  const url = prompt('구글 드라이브 공유 링크를 입력하세요:');
  if (!url) return;
  
  if (!url.includes('drive.google.com')) {
    showToast('구글 드라이브 링크가 아닙니다.');
    return;
  }
  
  const name = prompt('파일 이름을 입력하세요:', '구글드라이브_컨텐츠');
  if (!name) return;
  
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const contentFiles = deal?.contentFiles || [];
    contentFiles.push({
      name,
      url,
      type: 'drive',
      uploadedAt: new Date().toLocaleDateString('ko-KR')
    });
    
    await db.collection('deals').doc(dealId).update({ contentFiles });
    showToast('구글 드라이브 링크가 추가되었습니다.');
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('링크 추가에 실패했습니다.');
  }
}

// 컨텐츠 파일 삭제
async function removeContentFile(dealId, fileIdx) {
  if (!confirm('이 파일을 삭제하시겠습니까?')) return;
  
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const contentFiles = deal?.contentFiles || [];
    contentFiles.splice(fileIdx, 1);
    
    await db.collection('deals').doc(dealId).update({ contentFiles });
    showToast('파일이 삭제되었습니다.');
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('파일 삭제에 실패했습니다.');
  }
}

// ===== 데이터 로드 =====
function loadData() {
  // 공급사
  db.collection('suppliers').onSnapshot(snapshot => {
    state.suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }, error => {
    console.error('공급사 로드 오류:', error);
  });
  
  // 셀러
  db.collection('sellers').onSnapshot(snapshot => {
    state.sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }, error => {
    console.error('셀러 로드 오류:', error);
  });
  
  // 공구
  db.collection('deals').onSnapshot(snapshot => {
    state.deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'dashboard') {
      renderPage('dashboard');
    }
  });
  
  // 상품
  db.collection('supplierProducts').onSnapshot(snapshot => {
    state.supplierProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'products') {
      renderPage('products');
    }
  });
  
  // 대표상품 그룹
  db.collection('productGroups').onSnapshot(snapshot => {
    state.productGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  });
  
  // 공지사항
  db.collection('partnerNotices').onSnapshot(snapshot => {
    state.notices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'notice') {
      renderPage('notice');
    }
  });
  
  // 메시지
  db.collection('partnerMessages').onSnapshot(snapshot => {
    state.messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'message') {
      renderPage('message');
    }
  });
  
  // 정산 (sellerSettlements)
  db.collection('sellerSettlements').onSnapshot(snapshot => {
    state.settlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    state.sellerSettlements = state.settlements; // 대시보드용으로도 저장
    if (state.currentUser && (state.currentPage === 'settlement' || state.currentPage === 'dashboard')) {
      renderPage(state.currentPage);
    }
  });
  
  // 공급사 정산 (supplierSettlements)
  db.collection('supplierSettlements').onSnapshot(snapshot => {
    state.supplierSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'settlement') {
      renderPage('settlement');
    }
  });
  
  // 제안
  db.collection('dealSuggestions').onSnapshot(snapshot => {
    state.suggestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'suggest') {
      renderPage('suggest');
    }
  });
  
  // 모여라딜→셀러 제안 (adminProposals)
  db.collection('adminProposals').onSnapshot(snapshot => {
    state.adminProposals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'suggest') {
      renderPage('suggest');
    }
  });
  
  // 긴급판매요청
  db.collection('urgentSales').onSnapshot(snapshot => {
    state.urgentSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'urgent') {
      renderPage('urgent');
    }
  });

  // 카페24 주문
  db.collection('cafe24_orders').onSnapshot(snapshot => {
    state.cafe24Orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'orders') {
      renderPage('orders');
    }
  });
}

// 초기화
loadData();

// 페이지 로드 시 저장된 아이디 불러오기
document.addEventListener('DOMContentLoaded', function() {
  loadSavedLoginId();
  
  // 세션 복구 시도 (새로고침 시 자동 로그인)
  tryRestoreSession();
});

// 세션 복구 함수
async function tryRestoreSession() {
  const sessionStr = localStorage.getItem('partner_session');
  if (!sessionStr) return;
  
  try {
    const session = JSON.parse(sessionStr);
    if (!session.userType || !session.loginId || !session.loginPw) return;
    
    // 데이터 로드 대기 (최대 5초)
    let waitCount = 0;
    while ((state.suppliers.length === 0 && state.sellers.length === 0) && waitCount < 50) {
      await new Promise(r => setTimeout(r, 100));
      waitCount++;
    }
    
    let matched = null;
    
    if (session.userType === 'supplier') {
      matched = state.suppliers.find(s => s.loginId === session.loginId && s.loginPw === session.loginPw);
      if (matched) {
        state.currentUser = matched;
        state.userType = 'supplier';
        showPortal();
      }
    } else if (session.userType === 'seller') {
      matched = state.sellers.find(s => s.loginId === session.loginId && s.loginPw === session.loginPw);
      if (matched) {
        state.currentUser = matched;
        state.userType = 'seller';
        showPortal();
      }
    }
    
    // 매칭 실패 시 세션 삭제
    if (!matched) {
      localStorage.removeItem('partner_session');
    }
  } catch (e) {
    console.error('세션 복구 실패:', e);
    localStorage.removeItem('partner_session');
  }
}
</script>

</body>
</html>

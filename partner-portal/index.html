<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>모여라딜 파트너 포털</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #fc9600;
      --primary-light: #fff8f0;
      --primary-dark: #e08600;
      --white: #ffffff;
      --gray-900: #191f28;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      --success: #00c073;
      --success-light: #e8f7f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --info: #3182f6;
      --info-light: #eef4ff;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      min-height: 100vh; 
      background: var(--gray-100);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    /* ===== 로그인 페이지 ===== */
    .login-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #fff8f0 0%, #fff5eb 50%, #ffedd5 100%);
      position: relative;
      overflow: hidden;
    }
    
    /* 물결 배경 애니메이션 */
    .login-bg-wave {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
      pointer-events: none;
    }
    
    .login-bg-wave::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      top: -50%;
      left: -50%;
      background: 
        radial-gradient(ellipse at 30% 20%, rgba(252, 150, 0, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(252, 150, 0, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 30%, rgba(255, 179, 71, 0.1) 0%, transparent 40%);
      animation: bgWave 15s ease-in-out infinite;
    }
    
    @keyframes bgWave {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(2%, -2%) rotate(1deg); }
      50% { transform: translate(0, -3%) rotate(0deg); }
      75% { transform: translate(-2%, -1%) rotate(-1deg); }
    }
    
    /* 떠다니는 원형 파티클들 */
    .login-particle {
      position: absolute;
      border-radius: 50%;
      opacity: 0;
      animation: particleFloat 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    
    .login-particle:nth-child(1) {
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(252, 150, 0, 0.12) 0%, transparent 70%);
      top: -80px;
      right: -80px;
      animation-delay: 0s;
    }
    
    .login-particle:nth-child(2) {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(252, 150, 0, 0.08) 0%, transparent 70%);
      bottom: -120px;
      left: -120px;
      animation-delay: -5s;
    }
    
    .login-particle:nth-child(3) {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 179, 71, 0.15) 0%, transparent 70%);
      top: 30%;
      right: 5%;
      animation-delay: -10s;
    }
    
    .login-particle:nth-child(4) {
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(252, 150, 0, 0.1) 0%, transparent 70%);
      bottom: 20%;
      left: 10%;
      animation-delay: -7s;
    }
    
    .login-particle:nth-child(5) {
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255, 179, 71, 0.12) 0%, transparent 70%);
      top: 60%;
      right: 20%;
      animation-delay: -3s;
    }
    
    @keyframes particleFloat {
      0% {
        opacity: 0;
        transform: translateY(30px) scale(0.8);
      }
      10% {
        opacity: 1;
      }
      50% {
        transform: translateY(-20px) scale(1.1);
      }
      90% {
        opacity: 1;
      }
      100% {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
    }
    
    /* 그라디언트 흐름 효과 */
    .login-gradient-flow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        45deg,
        transparent 0%,
        rgba(252, 150, 0, 0.03) 25%,
        transparent 50%,
        rgba(255, 179, 71, 0.03) 75%,
        transparent 100%
      );
      background-size: 400% 400%;
      animation: gradientFlow 12s ease infinite;
      z-index: 0;
      pointer-events: none;
    }
    
    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* 진입 애니메이션 */
    @keyframes slideUpFadeIn {
      0% {
        opacity: 0;
        transform: translateY(30px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes scaleIn {
      0% {
        opacity: 0;
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .login-container {
      width: 100%;
      max-width: 400px;
      position: relative;
      z-index: 10;
    }
    
    .logo-section {
      text-align: center;
      margin-bottom: 32px;
      animation: slideUpFadeIn 0.6s ease-out;
    }
    
    .logo-img {
      height: 52px;
      margin-bottom: 8px;
      filter: drop-shadow(0 2px 8px rgba(252, 150, 0, 0.2));
    }
    
    .logo-desc {
      font-size: 15px;
      color: var(--gray-500);
      margin-top: 8px;
      font-weight: 500;
      letter-spacing: -0.3px;
    }
    
    .login-card {
      background: linear-gradient(145deg, #ffffff, #fefefe);
      border-radius: 24px;
      padding: 36px;
      box-shadow: 
        0 20px 60px rgba(252, 150, 0, 0.12),
        0 8px 24px rgba(0,0,0,0.06),
        inset 0 1px 1px rgba(255,255,255,0.9);
      border: 1px solid rgba(252, 150, 0, 0.1);
      animation: scaleIn 0.5s ease-out 0.2s both;
      position: relative;
      z-index: 10;
    }
    
    .tab-buttons {
      display: flex;
      gap: 4px;
      margin-bottom: 28px;
      background: linear-gradient(145deg, #f5f5f5, #eeeeee);
      padding: 5px;
      border-radius: 14px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.04);
      position: relative;
      z-index: 20;
    }
    
    .tab-btn {
      flex: 1;
      padding: 14px;
      border: none;
      background: transparent;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      z-index: 20;
      font-family: inherit;
    }
    
    .tab-btn:hover {
      color: var(--gray-700);
    }
    
    .tab-btn.active {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      color: var(--gray-900);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.08),
        0 2px 4px rgba(0,0,0,0.04);
    }
    
    .tab-btn.supplier.active { 
      color: #2563eb;
      background: linear-gradient(145deg, #eff6ff, #dbeafe);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }
    .tab-btn.seller.active { 
      color: var(--primary);
      background: linear-gradient(145deg, #fff8f0, #ffedd5);
      box-shadow: 0 4px 12px rgba(252, 150, 0, 0.2);
    }
    
    .form-group { 
      margin-bottom: 20px;
      animation: fadeInUp 0.4s ease-out both;
    }
    
    .form-group:nth-child(1) { animation-delay: 0.3s; }
    .form-group:nth-child(2) { animation-delay: 0.4s; }
    .form-group:nth-child(3) { animation-delay: 0.5s; }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 8px;
      letter-spacing: -0.2px;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 16px 18px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
      background: linear-gradient(145deg, #fafafa, #f5f5f5);
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--white);
      box-shadow: 
        0 0 0 4px rgba(252, 150, 0, 0.1),
        0 4px 12px rgba(252, 150, 0, 0.08);
    }
    
    .form-input::placeholder { color: var(--gray-400); }
    
    /* 로그인 화면 카카오 문의 버튼 */
    .login-kakao-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 54px;
      height: 54px;
      background: linear-gradient(145deg, #fc9600, #e08600);
      border: none;
      border-radius: 50%;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 2px rgba(255,255,255,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      z-index: 1000;
      animation: scaleIn 0.5s ease-out 0.8s both;
    }
    
    .login-kakao-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 10px 24px rgba(252, 150, 0, 0.4),
        0 5px 10px rgba(252, 150, 0, 0.3);
    }
    
    .login-kakao-btn span {
      font-size: 11px;
      font-weight: 700;
      color: white;
      text-shadow: 0 1px 1px rgba(0,0,0,0.15);
    }
    
    .footer-text {
      text-align: center;
      margin-top: 24px;
      font-size: 12px;
      color: var(--gray-400);
      animation: fadeInUp 0.4s ease-out 0.7s both;
    }
    
    .help-text {
      text-align: center;
      margin-top: 20px;
      font-size: 13px;
      color: var(--gray-500);
    }
    
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(145deg, #fc9600, #e08600);
      color: var(--white);
      width: 100%;
      box-shadow: 
        0 4px 12px rgba(252, 150, 0, 0.3),
        0 2px 4px rgba(252, 150, 0, 0.2),
        inset 0 1px 1px rgba(255,255,255,0.2);
    }
    
    .btn-primary:hover { 
      background: linear-gradient(145deg, #ffb347, #fc9600);
      transform: translateY(-1px);
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.4),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 1px rgba(255,255,255,0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 
        0 2px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .btn-supplier {
      background: linear-gradient(145deg, #3b82f6, #2563eb);
      color: var(--white);
      width: 100%;
      box-shadow: 
        0 4px 12px rgba(59, 130, 246, 0.3),
        0 2px 4px rgba(59, 130, 246, 0.2);
    }
    
    .btn-supplier:hover { 
      background: linear-gradient(145deg, #60a5fa, #3b82f6);
      transform: translateY(-1px);
    }
    
    .btn-seller {
      background: linear-gradient(145deg, #fc9600, #e08600);
      color: var(--white);
      width: 100%;
    }
    
    .btn-secondary {
      background: linear-gradient(145deg, #f9fafb, #f3f4f6);
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    
    .btn-secondary:hover { 
      background: linear-gradient(145deg, #ffffff, #f9fafb);
      border-color: var(--gray-300);
    }
    
    /* 액션 버튼 - 3D 스타일 */
    .action-btn-primary {
      background: linear-gradient(145deg, #fc9600, #e08600);
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 
        0 4px 12px rgba(252, 150, 0, 0.35),
        0 2px 4px rgba(252, 150, 0, 0.2),
        inset 0 1px 1px rgba(255,255,255,0.25);
      transition: all 0.2s ease;
    }
    
    .action-btn-primary:hover {
      background: linear-gradient(145deg, #ffb347, #fc9600);
      transform: translateY(-2px);
      box-shadow: 
        0 6px 20px rgba(252, 150, 0, 0.4),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 1px rgba(255,255,255,0.3);
    }
    
    .action-btn-primary:active {
      transform: translateY(0);
      box-shadow: 
        0 2px 8px rgba(252, 150, 0, 0.3),
        inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .action-btn-secondary {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 
        0 2px 6px rgba(0,0,0,0.04),
        inset 0 1px 1px rgba(255,255,255,0.8);
      transition: all 0.2s ease;
    }
    
    .action-btn-secondary:hover {
      background: linear-gradient(145deg, #fff8f0, #ffedd5);
      border-color: rgba(252, 150, 0, 0.3);
      color: #ea580c;
      transform: translateY(-1px);
      box-shadow: 
        0 4px 12px rgba(252, 150, 0, 0.1),
        inset 0 1px 1px rgba(255,255,255,0.9);
    }
    
    .action-btn-secondary:active {
      transform: translateY(0);
      box-shadow: 
        0 1px 3px rgba(0,0,0,0.06),
        inset 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .btn.loading {
      position: relative;
      color: transparent;
      pointer-events: none;
    }
    
    .btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .input-icon {
      position: relative;
    }
    
    .input-icon .icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }
    
    .input-icon .form-input {
      padding-left: 48px;
    }
    
    .error-message {
      background: var(--danger-light);
      border: 1px solid #fecaca;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }
    
    .error-message.show { display: block; }
    
    .help-text {
      text-align: center;
      margin-top: 24px;
      font-size: 13px;
      color: var(--gray-500);
    }
    
    .footer-text {
      margin-top: 40px;
      text-align: center;
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* ===== 포털 레이아웃 ===== */
    .portal-page {
      display: none;
    }
    
    .portal-page.active {
      display: block;
    }
    
    .portal-header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .portal-header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .portal-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .portal-logo img {
      height: 32px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .user-badge.supplier {
      background: var(--info-light);
      color: var(--info);
    }
    
    .user-badge.seller {
      background: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .logout-btn {
      padding: 8px 16px;
      background: var(--gray-100);
      border: none;
      border-radius: 8px;
      font-size: 13px;
      color: var(--gray-600);
      cursor: pointer;
      font-family: inherit;
    }
    
    .logout-btn:hover {
      background: var(--gray-200);
    }
    
    /* 네비게이션 */
    .portal-nav {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      overflow-x: auto;
    }
    
    .portal-nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 4px;
      padding: 8px 24px;
    }
    
    .nav-item {
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
      transition: all 0.15s;
    }
    
    .nav-item:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }
    
    .nav-item.active {
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }
    
    /* 메인 콘텐츠 */
    .portal-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .page-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 24px;
    }
    
    .card {
      background: var(--white);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 
        0 2px 8px rgba(252, 150, 0, 0.06),
        0 1px 3px rgba(0,0,0,0.04);
      border: 1px solid rgba(252, 150, 0, 0.08);
      transition: box-shadow 0.2s ease;
    }
    
    .card:hover {
      box-shadow: 
        0 4px 16px rgba(252, 150, 0, 0.1),
        0 2px 6px rgba(0,0,0,0.06);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--gray-800);
    }
    
    /* 대시보드 통계 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 
        0 4px 12px rgba(252, 150, 0, 0.08),
        0 2px 4px rgba(0,0,0,0.04),
        inset 0 1px 2px rgba(255,255,255,0.8);
      border: 1px solid rgba(252, 150, 0, 0.1);
      transition: all 0.25s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 20px rgba(252, 150, 0, 0.15),
        0 4px 8px rgba(0,0,0,0.06),
        inset 0 1px 2px rgba(255,255,255,0.9);
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .stat-card.highlight {
      background: linear-gradient(145deg, #fc9600, #e08600);
      color: var(--white);
      border: none;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 2px rgba(255,255,255,0.2);
    }
    
    .stat-card.highlight .stat-label,
    .stat-card.highlight .stat-value {
      color: var(--white);
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* 리스트 */
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    .list-item:hover {
      background: var(--gray-50);
    }
    
    .list-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .list-meta {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* 상태 뱃지 */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-ongoing {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .status-upcoming {
      background: var(--info-light);
      color: var(--info);
    }
    
    .status-completed {
      background: var(--gray-100);
      color: var(--gray-600);
    }
    
    /* 캘린더 */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .calendar-nav button {
      width: 36px;
      height: 36px;
      border: 1px solid var(--gray-200);
      background: var(--white);
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .calendar-nav button:hover {
      background: var(--gray-50);
    }
    
    .calendar-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .calendar-weekday {
      background: var(--gray-50);
      padding: 12px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
    }
    
    .calendar-weekday:first-child {
      color: var(--danger);
    }
    
    .calendar-weekday:last-child {
      color: var(--info);
    }
    
    .calendar-day {
      background: var(--white);
      min-height: 100px;
      padding: 8px;
    }
    
    .calendar-day.other-month {
      background: var(--gray-50);
    }
    
    .calendar-day.other-month .day-number {
      color: var(--gray-400);
    }
    
    .calendar-day.today {
      background: var(--primary-light);
    }
    
    .day-number {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .day-number.sunday { color: var(--danger); }
    .day-number.saturday { color: var(--info); }
    
    .deal-badge {
      display: block;
      padding: 4px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      background: var(--primary);
      color: var(--white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    
    .deal-badge:hover {
      filter: brightness(0.95);
    }
    
    /* 공지사항 */
    .notice-item {
      padding: 20px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
    }
    
    .notice-item:hover {
      background: var(--gray-50);
    }
    
    .notice-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .notice-badge.important {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .notice-badge.normal {
      background: var(--gray-100);
      color: var(--gray-600);
    }
    
    .notice-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .notice-date {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* 소통/메시지 */
    .message-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .message-item {
      padding: 16px;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .message-item:last-child {
      border-bottom: none;
    }
    
    .message-item.mine {
      background: var(--primary-light);
    }
    
    .message-item.admin {
      background: var(--info-light);
    }
    
    .message-sender {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .message-item.mine .message-sender {
      color: var(--primary-dark);
    }
    
    .message-item.admin .message-sender {
      color: var(--info);
    }
    
    .message-content {
      font-size: 14px;
      line-height: 1.6;
    }
    
    .message-time {
      font-size: 11px;
      color: var(--gray-400);
      margin-top: 4px;
    }
    
    .message-input-area {
      display: flex;
      gap: 12px;
    }
    
    .message-input-area .form-input {
      flex: 1;
    }
    
    /* 상품 등록 (공급사) */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    
    .product-card {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 16px;
    }
    
    .product-name {
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .product-info {
      font-size: 13px;
      color: var(--gray-600);
    }
    
    /* 정산서 */
    .settlement-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      padding: 20px;
      background: var(--gray-50);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .settlement-item {
      text-align: center;
    }
    
    .settlement-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }
    
    .settlement-value {
      font-size: 20px;
      font-weight: 700;
    }
    
    /* 테이블 */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .data-table th {
      background: var(--gray-50);
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-600);
    }
    
    .data-table tbody tr:hover {
      background: var(--gray-50);
    }
    
    /* 모달 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: 8px;
      font-size: 20px;
      cursor: pointer;
      color: var(--gray-500);
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-100);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* 토스트 */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-900);
      color: var(--white);
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    /* 빈 상태 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* 반응형 - 모바일 특화 */
    @media (max-width: 768px) {
      .portal-header {
        padding: 12px 16px;
      }
      
      .portal-header-inner {
        flex-direction: row;
        justify-content: space-between;
      }
      
      .logo-horizontal {
        height: 28px;
      }
      
      .user-info {
        gap: 8px;
      }
      
      .user-badge {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .btn-logout {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .portal-nav {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      }
      
      .portal-nav-inner {
        padding: 8px 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      
      .portal-nav-inner::-webkit-scrollbar {
        display: none;
      }
      
      .nav-item {
        font-size: 13px;
        padding: 8px 12px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      .portal-content {
        padding: 16px;
        padding-bottom: 100px;
      }
      
      .page-title {
        font-size: 20px;
      }
      
      .page-desc {
        font-size: 13px;
      }
      
      .card {
        padding: 14px;
        border-radius: 12px;
      }
      
      .card-title {
        font-size: 14px;
      }
      
      /* TOP 그리드 모바일 1열 */
      .top-grid {
        grid-template-columns: 1fr !important;
      }
      
      .top-item {
        padding: 8px 0 !important;
      }
      
      .top-name {
        font-size: 12px !important;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .stat-card {
        padding: 14px 12px;
      }
      
      .stat-value {
        font-size: 24px;
      }
      
      .stat-label {
        font-size: 11px;
      }
      
      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }
      
      .day-number {
        font-size: 11px;
      }
      
      .deal-badge {
        font-size: 9px;
        padding: 2px 4px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .calendar-weekday {
        font-size: 11px;
        padding: 6px 0;
      }
      
      .form-input, .form-textarea, .form-select {
        font-size: 16px; /* iOS 확대 방지 */
        padding: 12px;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .btn-primary {
        padding: 12px 20px;
      }
      
      .modal-content {
        margin: 0;
        max-height: 100vh;
        border-radius: 16px 16px 0 0;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 100%;
        animation: slideUp 0.3s ease;
      }
      
      @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      
      .modal-body {
        max-height: 60vh;
        overflow-y: auto;
      }
      
      /* 테이블 모바일 최적화 */
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 6px !important;
      }
      
      /* 리스트 아이템 모바일 */
      .list-item {
        padding: 14px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }
    
    /* 작은 모바일 (375px 이하) */
    @media (max-width: 375px) {
      .nav-item {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .portal-content {
        padding: 12px;
      }
      
      .stats-grid {
        gap: 8px;
      }
      
      .stat-card {
        padding: 12px 10px;
      }
      
      .stat-value {
        font-size: 20px;
      }
    }
    
    /* 퀵배너 스타일 - 주황색 기반 3D 디자인 */
    .quick-banner-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      z-index: 9999;
    }
    
    .quick-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 54px;
      height: 54px;
      background: linear-gradient(145deg, #ffffff, #f5f5f5);
      border: none;
      border-radius: 50%;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.15),
        0 3px 6px rgba(0,0,0,0.08),
        inset 0 1px 2px rgba(255,255,255,0.9);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      flex-direction: column;
      gap: 0;
      text-decoration: none;
    }
    
    .quick-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 10px 24px rgba(252, 150, 0, 0.25),
        0 5px 10px rgba(0,0,0,0.1),
        inset 0 1px 2px rgba(255,255,255,1);
    }
    
    .quick-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 
        0 3px 8px rgba(252, 150, 0, 0.15),
        0 2px 4px rgba(0,0,0,0.08),
        inset 0 1px 4px rgba(0,0,0,0.05);
    }
    
    .quick-btn.active {
      background: linear-gradient(145deg, #fc9600, #e08600);
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.4),
        0 3px 6px rgba(252, 150, 0, 0.3),
        inset 0 1px 2px rgba(255,255,255,0.3);
    }
    
    .quick-btn.active .quick-label {
      color: white;
      text-shadow: 0 1px 1px rgba(0,0,0,0.15);
    }
    
    /* 정산 버튼 - 흰색 배경 + 연한 회색 테두리 */
    .quick-btn.settlement-btn {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.06),
        0 2px 4px rgba(0,0,0,0.03),
        inset 0 1px 2px rgba(255,255,255,0.9);
    }
    
    .quick-btn.settlement-btn .quick-label {
      color: #fc9600;
      font-weight: 700;
    }
    
    .quick-btn.settlement-btn:hover {
      background: linear-gradient(145deg, #fc9600, #e08600);
      border-color: transparent;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25);
    }
    
    .quick-btn.settlement-btn:hover .quick-label {
      color: white;
    }
    
    /* 공지 버튼 - 흰색 배경 + 연한 회색 테두리 */
    .quick-btn.notice-btn {
      background: linear-gradient(145deg, #ffffff, #fafafa);
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.06),
        0 2px 4px rgba(0,0,0,0.03),
        inset 0 1px 2px rgba(255,255,255,0.9);
    }
    
    .quick-btn.notice-btn .quick-label {
      color: #fc9600;
      font-weight: 700;
    }
    
    .quick-btn.notice-btn:hover {
      background: linear-gradient(145deg, #fc9600, #e08600);
      border-color: transparent;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25);
    }
    
    .quick-btn.notice-btn:hover .quick-label {
      color: white;
    }
    
    /* 문의 버튼 - 진한 주황 */
    .quick-btn.kakao-btn {
      background: linear-gradient(145deg, #fc9600, #e08600);
      border: none;
      box-shadow: 
        0 6px 16px rgba(252, 150, 0, 0.35),
        0 3px 6px rgba(252, 150, 0, 0.25),
        inset 0 1px 2px rgba(255,255,255,0.3);
    }
    
    .quick-btn.kakao-btn .quick-label {
      color: white;
      font-weight: 700;
      text-shadow: 0 1px 1px rgba(0,0,0,0.15);
    }
    
    .quick-btn.kakao-btn:hover {
      background: linear-gradient(145deg, #ffb347, #fc9600);
    }
    
    .quick-label {
      font-size: 13px;
      font-weight: 700;
      color: #fc9600;
      letter-spacing: -0.3px;
      line-height: 1;
    }
    
    .quick-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      min-width: 18px;
      height: 18px;
      background: #dc2626;
      color: white;
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }
    
    /* 상품 등록 페이지 스타일 */
    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .product-actions {
      display: flex;
      gap: 8px;
    }
    
    .product-table-pc {
      display: block;
      overflow-x: auto;
    }
    
    .product-list-mobile {
      display: none;
    }
    
    /* 모바일 상품 카드 */
    .product-card-mobile {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .product-name-mobile {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .product-info-mobile {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .info-row.highlight {
      background: #fffbeb;
      margin: 0 -16px;
      padding: 8px 16px;
    }
    
    .info-label {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
    }
    
    .info-value.primary {
      color: var(--primary);
    }
    
    .deal-count {
      background: var(--primary-light);
      color: var(--primary);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    
    .product-actions-mobile {
      display: flex;
      gap: 8px;
    }
    
    .product-actions-mobile .btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
    }
    
    .btn-danger {
      background: #fee2e2 !important;
      color: #dc2626 !important;
    }
    
    @media (max-width: 768px) {
      .quick-banner-container {
        bottom: 16px;
        right: 16px;
        gap: 10px;
      }
      
      .quick-btn {
        width: 50px;
        height: 50px;
      }
      
      .quick-icon {
        font-size: 16px;
      }
      
      .quick-label {
        font-size: 8px;
      }
      
      /* 대시보드 TOP 5 모바일 1열 */
      .top-grid {
        grid-template-columns: 1fr !important;
      }
      
      /* 셀러 그리드 모바일 */
      .seller-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 8px !important;
      }
      
      /* 페이지 타이틀 모바일 */
      .page-title {
        font-size: 20px !important;
      }
      
      .page-desc {
        font-size: 13px !important;
      }
      
      /* 카드 패딩 조정 */
      .card {
        padding: 16px !important;
      }
      
      .card-title {
        font-size: 15px !important;
      }
      
      /* 통계 카드 모바일 */
      .stat-card {
        padding: 14px !important;
      }
      
      .stat-value {
        font-size: 22px !important;
      }
      
      /* 상품 페이지 모바일 */
      .product-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .product-actions {
        width: 100%;
      }
      
      .product-actions .btn-primary {
        flex: 1;
      }
      
      .excel-btn {
        display: none !important;
      }
      
      .product-table-pc {
        display: none !important;
      }
      
      .product-list-mobile {
        display: block !important;
      }
      
      /* 정산 모바일 - 엑셀 버튼 숨김 */
      .settlement-excel-btn {
        display: none !important;
      }
      
      /* 버튼 모바일 */
      .btn {
        padding: 10px 16px !important;
        font-size: 14px !important;
      }
      
      .btn-sm {
        padding: 8px 12px !important;
        font-size: 13px !important;
      }
    }
  </style>
</head>
<body>
  <!-- 로그인 페이지 -->
  <div id="login-page" class="login-page">
    <!-- 배경 모션 효과 -->
    <div class="login-gradient-flow"></div>
    <div class="login-bg-wave"></div>
    <div class="login-particle"></div>
    <div class="login-particle"></div>
    <div class="login-particle"></div>
    <div class="login-particle"></div>
    <div class="login-particle"></div>
    
    <div class="login-container">
      <div class="logo-section">
        <img src="logo-horizontal.png" alt="모여라딜" class="logo-img">
        <div class="logo-desc">파트너 포털</div>
      </div>
      
      <div class="login-card">
        <div class="tab-buttons">
          <button class="tab-btn supplier active" onclick="switchLoginTab('supplier')">공급사</button>
          <button class="tab-btn seller" onclick="switchLoginTab('seller')">셀러</button>
        </div>
        
        <div id="error-message" class="error-message">
          아이디 또는 비밀번호가 일치하지 않습니다.
        </div>
        
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label">아이디</label>
            <input type="text" class="form-input" id="login-id" placeholder="아이디를 입력하세요" required autocomplete="off">
          </div>
          
          <div class="form-group">
            <label class="form-label">비밀번호</label>
            <input type="password" class="form-input" id="login-pw" placeholder="비밀번호를 입력하세요" required>
          </div>
          
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #666;">
              <input type="checkbox" id="remember-id" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
              아이디 저장
            </label>
          </div>
          
          <button type="submit" class="btn btn-supplier" id="login-btn">로그인</button>
        </form>
        
        <div class="help-text">
          로그인 정보는 담당자에게 문의하세요.
        </div>
      </div>
      
      <div class="footer-text">
        © 2025 모여라딜. All rights reserved.
      </div>
    </div>
    
    <!-- 로그인 화면 문의 버튼 -->
    <a href="http://pf.kakao.com/_xoxnJHn" target="_blank" class="login-kakao-btn">
      <span>문의</span>
    </a>
  </div>
  
  <!-- 포털 페이지 -->
  <div id="portal-page" class="portal-page">
    <!-- 헤더 -->
    <header class="portal-header">
      <div class="portal-header-inner">
        <div class="portal-logo">
          <img src="logo-horizontal.png" alt="모여라딜">
        </div>
        <div class="user-info">
          <span id="user-badge" class="user-badge supplier">공급사명</span>
          <button class="logout-btn" onclick="handleLogout()">로그아웃</button>
        </div>
      </div>
    </header>
    
    <!-- 네비게이션 -->
    <nav class="portal-nav">
      <div class="portal-nav-inner" id="nav-menu">
        <!-- 동적으로 생성됨 -->
      </div>
    </nav>
    
    <!-- 메인 콘텐츠 -->
    <main class="portal-content" id="main-content">
      <!-- 동적으로 생성됨 -->
    </main>
  </div>
  
  <!-- 모달 -->
  <div id="modal" class="modal" onclick="if(event.target===this)closeModal()"></div>
  
  <!-- 토스트 -->
  <div id="toast" class="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
  authDomain: "moyeora-deal-manager.firebaseapp.com",
  projectId: "moyeora-deal-manager",
  storageBucket: "moyeora-deal-manager.firebasestorage.app",
  messagingSenderId: "527148187832",
  appId: "1:527148187832:web:dc35b0413a7157db34744d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// 상태 관리
let state = {
  currentUser: null,
  userType: null, // 'supplier' or 'seller'
  currentPage: 'dashboard',
  suppliers: [],
  sellers: [],
  deals: [],
  supplierProducts: [],
  notices: [],
  messages: [],
  settlements: [],
  supplierSettlements: [],
  sellerSettlements: [],
  suggestions: [],
  adminProposals: [],
  urgentSales: [],
  productSearchKeyword: ''
};

let loginTab = 'supplier';

// ===== 유틸리티 함수 =====
const formatDate = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

const formatDateKR = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getMonth()+1}월 ${d.getDate()}일`;
};

const formatNumber = (num) => {
  return (num || 0).toLocaleString();
};

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function closeModal() {
  document.getElementById('modal').className = 'modal';
}

// ===== 로그인 관련 =====
function switchLoginTab(tab) {
  loginTab = tab;
  
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.tab-btn.${tab}`).classList.add('active');
  
  const loginBtn = document.getElementById('login-btn');
  loginBtn.className = `btn btn-${tab}`;
  
  document.getElementById('error-message').classList.remove('show');
  
  // 탭 전환시 저장된 아이디 불러오기
  loadSavedLoginId();
  document.getElementById('login-pw').value = '';
}

// 저장된 아이디 불러오기
function loadSavedLoginId() {
  const savedId = localStorage.getItem(`partner_${loginTab}_id`);
  const rememberCheck = document.getElementById('remember-id');
  const loginIdInput = document.getElementById('login-id');
  
  if (savedId) {
    loginIdInput.value = savedId;
    rememberCheck.checked = true;
  } else {
    loginIdInput.value = '';
    rememberCheck.checked = false;
  }
}

async function handleLogin(e) {
  e.preventDefault();
  
  const loginId = document.getElementById('login-id').value.trim();
  const loginPw = document.getElementById('login-pw').value;
  const loginBtn = document.getElementById('login-btn');
  const errorMsg = document.getElementById('error-message');
  const rememberCheck = document.getElementById('remember-id');
  
  errorMsg.classList.remove('show');
  loginBtn.classList.add('loading');
  
  // 데이터 로드 대기 (최대 5초)
  let waitCount = 0;
  while ((state.suppliers.length === 0 && state.sellers.length === 0) && waitCount < 50) {
    await new Promise(r => setTimeout(r, 100));
    waitCount++;
  }
  
  await new Promise(r => setTimeout(r, 300));
  
  let matched = null;
  
  if (loginTab === 'supplier') {
    matched = state.suppliers.find(s => s.loginId === loginId && s.loginPw === loginPw);
    
    if (matched) {
      // 아이디 저장 처리
      if (rememberCheck.checked) {
        localStorage.setItem('partner_supplier_id', loginId);
      } else {
        localStorage.removeItem('partner_supplier_id');
      }
      
      // 세션 저장 (새로고침 시 자동 로그인용)
      localStorage.setItem('partner_session', JSON.stringify({
        userType: 'supplier',
        loginId: loginId,
        loginPw: loginPw,
        userId: matched.id
      }));
      
      state.currentUser = matched;
      state.userType = 'supplier';
      loginBtn.classList.remove('loading');
      showPortal();
      return;
    }
  } else {
    matched = state.sellers.find(s => s.loginId === loginId && s.loginPw === loginPw);
    
    if (matched) {
      // 아이디 저장 처리
      if (rememberCheck.checked) {
        localStorage.setItem('partner_seller_id', loginId);
      } else {
        localStorage.removeItem('partner_seller_id');
      }
      
      // 세션 저장 (새로고침 시 자동 로그인용)
      localStorage.setItem('partner_session', JSON.stringify({
        userType: 'seller',
        loginId: loginId,
        loginPw: loginPw,
        userId: matched.id
      }));
      
      state.currentUser = matched;
      state.userType = 'seller';
      loginBtn.classList.remove('loading');
      showPortal();
      return;
    }
  }
  
  loginBtn.classList.remove('loading');
  errorMsg.classList.add('show');
  document.getElementById('login-pw').value = '';
}

function handleLogout() {
  state.currentUser = null;
  state.userType = null;
  state.currentPage = 'dashboard';
  
  // 세션 삭제
  localStorage.removeItem('partner_session');
  
  document.getElementById('login-page').style.display = 'flex';
  document.getElementById('portal-page').classList.remove('active');
  
  // 퀵배너 숨기기
  const quickBanner = document.getElementById('quick-banner');
  if (quickBanner) quickBanner.innerHTML = '';
  
  // 저장된 아이디 불러오기
  loadSavedLoginId();
  document.getElementById('login-pw').value = '';
}

// ===== 포털 표시 =====
function showPortal() {
  document.getElementById('login-page').style.display = 'none';
  document.getElementById('portal-page').classList.add('active');
  
  // 사용자 정보 표시 - 셀러는 성함만 표시
  const badge = document.getElementById('user-badge');
  if (state.userType === 'supplier') {
    badge.className = 'user-badge supplier';
    badge.innerHTML = `${state.currentUser.name}`;
  } else {
    badge.className = 'user-badge seller';
    // 셀러 이름에서 성함만 추출 (형식: 성함/닉네임(팔로워수))
    const sellerName = state.currentUser.name || '';
    const firstName = sellerName.split('/')[0] || sellerName;
    badge.innerHTML = `${firstName}`;
  }
  
  renderNav();
  renderPage('dashboard');
}

function renderNav() {
  const nav = document.getElementById('nav-menu');
  
  const commonMenus = [
    { id: 'dashboard', label: '대시보드' },
    { id: 'calendar', label: '내 일정' }
  ];
  
  const supplierMenus = [
    { id: 'products', label: '상품관리' },
    { id: 'urgent', label: '긴급판매요청' }
  ];
  
  const sellerMenus = [
    { id: 'suggest', label: '공구 제안' }
  ];
  
  const menus = state.userType === 'supplier' 
    ? [...commonMenus, ...supplierMenus]
    : [...commonMenus, ...sellerMenus];
  
  nav.innerHTML = `
    <div style="display: flex; align-items: center; gap: 4px; flex: 1; overflow-x: auto;">
      ${menus.map(m => `
        <button class="nav-item ${state.currentPage === m.id ? 'active' : ''}" onclick="renderPage('${m.id}')">
          ${m.label}
        </button>
      `).join('')}
    </div>
  `;
  
  // 퀵배너 렌더링
  renderQuickBanner();
}

// 퀵배너 렌더링
function renderQuickBanner() {
  let quickBanner = document.getElementById('quick-banner');
  if (!quickBanner) {
    quickBanner = document.createElement('div');
    quickBanner.id = 'quick-banner';
    document.body.appendChild(quickBanner);
  }
  
  // 읽지 않은 공지사항 수 계산
  const unreadNotices = state.notices?.filter(n => {
    const readNotices = JSON.parse(localStorage.getItem('readNotices') || '[]');
    return !readNotices.includes(n.id);
  }).length || 0;
  
  // 정산 건수 - 더 유연한 매칭
  let pendingSettlements = 0;
  if (state.userType === 'supplier') {
    // 공급사용: supplierSettlements에서 매칭
    pendingSettlements = (state.supplierSettlements || []).filter(s => {
      const brandName = (s.brandName || '').trim().toLowerCase();
      const currentName = (state.currentUser?.name || '').trim().toLowerCase();
      const currentId = state.currentUser?.id || '';
      if (s.supplierId && s.supplierId === currentId) return !s.isCompleted;
      if (brandName === currentName) return !s.isCompleted;
      const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
      const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
      return (cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand)) && !s.isCompleted;
    }).length;
  } else {
    // 셀러용: sellerSettlements에서 매칭
    pendingSettlements = (state.settlements || []).filter(s => {
      const sellerName = (s.sellerName || '').trim().toLowerCase();
      const currentName = (state.currentUser?.name || '').trim().toLowerCase();
      const currentNickname = (state.currentUser?.nickname || '').trim().toLowerCase();
      const currentId = state.currentUser?.id || '';
      if (s.sellerId && s.sellerId === currentId) return !s.isCompleted;
      if (sellerName === currentName || sellerName === currentNickname) return !s.isCompleted;
      const cleanSeller = sellerName.replace(/[\s\-\_\(\)\/]/g, '');
      const cleanName = currentName.replace(/[\s\-\_\(\)\/]/g, '');
      return (cleanSeller.includes(cleanName) || cleanName.includes(cleanSeller)) && !s.isCompleted;
    }).length;
  }
  
  quickBanner.innerHTML = `
    <div class="quick-banner-container">
      <button class="quick-btn settlement-btn ${state.currentPage === 'settlement' ? 'active' : ''}" onclick="renderPage('settlement')">
        <span class="quick-label">정산</span>
        ${pendingSettlements > 0 ? `<span class="quick-badge">${pendingSettlements}</span>` : ''}
      </button>
      <button class="quick-btn notice-btn ${state.currentPage === 'notice' ? 'active' : ''}" onclick="renderPage('notice')">
        <span class="quick-label">공지</span>
        ${unreadNotices > 0 ? `<span class="quick-badge">${unreadNotices}</span>` : ''}
      </button>
      <a href="${state.userType === 'supplier' ? 'https://pf.kakao.com/_xoxnJHn' : 'http://pf.kakao.com/_xdZVkn'}" target="_blank" class="quick-btn kakao-btn">
        <span class="quick-label">문의</span>
      </a>
    </div>
  `;
}

// ===== 페이지 렌더링 =====
function renderPage(page) {
  state.currentPage = page;
  renderNav();
  
  const content = document.getElementById('main-content');
  
  switch(page) {
    case 'dashboard': renderDashboard(content); break;
    case 'calendar': renderCalendar(content); break;
    case 'notice': renderNotice(content); break;
    case 'message': renderMessage(content); break;
    case 'products': renderProducts(content); break;
    case 'urgent': renderUrgentSales(content); break;
    case 'settlement': renderSettlement(content); break;
    case 'suggest': renderSuggest(content); break;
  }
}

// ===== 대시보드 =====
function renderDashboard(container) {
  const myDeals = getMyDeals();
  const today = new Date();
  today.setHours(0,0,0,0);
  
  const ongoingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    const end = new Date(d.endDate);
    return today >= start && today <= end;
  });
  
  const upcomingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    return today < start;
  }).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
  
  const completedDeals = myDeals.filter(d => {
    const end = new Date(d.endDate);
    return today > end;
  });
  
  // 공급사용: 공구 진행 TOP 5 계산
  let topProductsHtml = '';
  let productStats = [];
  if (state.userType === 'supplier') {
    // 내 상품 목록
    const myProducts = state.supplierProducts.filter(p => {
      if (p.supplierId === state.currentUser.id) return true;
      if (p.brandName && state.currentUser.name && 
          p.brandName.includes(state.currentUser.name)) return true;
      return false;
    });
    
    // 상품별 공구 연결 수 계산
    productStats = myProducts.map(p => {
      // selectedProducts가 객체 배열 또는 문자열 배열일 수 있음
      const linkedDeals = state.deals.filter(d => {
        if (!d.selectedProducts) return false;
        return d.selectedProducts.some(item => {
          const pid = typeof item === 'string' ? item : item.productId;
          return pid === p.id;
        });
      });
      return {
        ...p,
        dealCount: linkedDeals.length
      };
    }).filter(p => p.dealCount > 0)
      .sort((a, b) => b.dealCount - a.dealCount)
      .slice(0, 5);
  }
  
  // 🆕 판매 베스트 TOP 5 - 정산예정 + 정산완료 탭 분리 (supplierSettlements 기준)
  let salesBestHtml = '';
  if (state.userType === 'supplier') {
    const salesByProductPending = {};
    const salesByProductCompleted = {};
    
    // supplierSettlements에서 내 브랜드 데이터 분리
    (state.supplierSettlements || []).forEach(ss => {
      // 내 브랜드 필터링: supplierId 또는 brandName으로 매칭
      const isMyBrand = ss.supplierId === state.currentUser.id ||
        (ss.brandName && state.currentUser.name && 
         (ss.brandName.includes(state.currentUser.name) || state.currentUser.name.includes(ss.brandName)));
      if (!isMyBrand) return;
      
      const targetMap = ss.isCompleted ? salesByProductCompleted : salesByProductPending;
      
      // items에서 상품 정보 가져오기
      const items = ss.items || ss.salesItems || [];
      if (items.length > 0) {
        items.forEach(item => {
          const productName = item.productName || item.name || '알 수 없음';
          if (!targetMap[productName]) {
            targetMap[productName] = { productName, totalQty: 0, totalAmount: 0 };
          }
          targetMap[productName].totalQty += Number(item.quantity) || 0;
          const itemAmount = Number(item.amount) || (Number(item.unitPrice) || Number(item.supplyPrice) || 0) * (Number(item.quantity) || 0);
          targetMap[productName].totalAmount += itemAmount;
        });
      } else {
        // items가 없으면 전체 금액을 하나의 상품으로 표시
        const productName = ss.sellerName || '정산건';
        if (!targetMap[productName]) {
          targetMap[productName] = { productName, totalQty: 0, totalAmount: 0 };
        }
        targetMap[productName].totalQty += Number(ss.totalQuantity) || 1;
        targetMap[productName].totalAmount += Number(ss.salesAmount) || 0;
      }
    });
    
    const salesBestPending = Object.values(salesByProductPending).filter(p => p.totalAmount > 0).sort((a, b) => b.totalAmount - a.totalAmount).slice(0, 5);
    const salesBestCompleted = Object.values(salesByProductCompleted).filter(p => p.totalAmount > 0).sort((a, b) => b.totalAmount - a.totalAmount).slice(0, 5);
    
    const renderSalesList = (stats, emptyMsg) => stats.length === 0 ? `
      <div style="text-align: center; padding: 40px 20px; color: var(--gray-400);">
        <div style="font-size: 32px; margin-bottom: 8px;">📊</div>
        <p style="font-size: 13px;">${emptyMsg}</p>
      </div>
    ` : stats.map((p, idx) => `
      <div class="top-item" style="display: flex; align-items: center; padding: 10px 0; ${idx < stats.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : ''}">
        <div class="top-rank" style="width: 24px; height: 24px; min-width: 24px; background: ${idx === 0 ? 'linear-gradient(135deg, #dc2626, #f97316)' : idx === 1 ? 'linear-gradient(135deg, #ea580c, #f59e0b)' : idx === 2 ? 'linear-gradient(135deg, #f59e0b, #fbbf24)' : 'var(--gray-200)'}; color: ${idx < 3 ? 'white' : 'var(--gray-600)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; margin-right: 10px; flex-shrink: 0;">${idx + 1}</div>
        <div style="flex: 1; min-width: 0;"><div class="top-name" style="font-weight: 600; color: var(--gray-800); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div><div style="font-size: 11px; color: var(--gray-500);">${p.totalQty}개 판매</div></div>
        <div style="font-weight: 700; color: #dc2626; font-size: 12px; flex-shrink: 0; margin-left: 8px;">${formatNumber(p.totalAmount)}원</div>
      </div>
    `).join('');
    
    salesBestHtml = `
      <div class="card" style="height: 100%;">
        <h3 class="card-title">Best 판매 상품 TOP</h3>
        <div style="display: flex; border-radius: 8px; overflow: hidden; margin-bottom: 12px; border: 1px solid rgba(252, 150, 0, 0.2);">
          <button id="salesTabPending" onclick="switchSalesTab('pending')" style="flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 12px; background: var(--primary); color: white;">정산예정</button>
          <button id="salesTabCompleted" onclick="switchSalesTab('completed')" style="flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: 500; font-size: 12px; background: #fff8f0; color: var(--gray-600);">정산완료</button>
        </div>
        <div id="salesContentPending">${renderSalesList(salesBestPending, '아직 정산예정 판매 데이터가 없습니다.')}</div>
        <div id="salesContentCompleted" style="display: none;">${renderSalesList(salesBestCompleted, '아직 정산완료된 판매 데이터가 없습니다.')}</div>
      </div>
    `;
  }
  
  // 🆕 많이 판매한 셀러 TOP 3 - 정산예정 + 정산완료 탭 분리 (supplierSettlements 기준)
  let topSellersHtml = '';
  if (state.userType === 'supplier') {
    const salesBySellerPending = {};
    const salesBySellerCompleted = {};
    
    (state.supplierSettlements || []).forEach(ss => {
      const isMyBrand = ss.supplierId === state.currentUser.id ||
        (ss.brandName && state.currentUser.name && 
         (ss.brandName.includes(state.currentUser.name) || state.currentUser.name.includes(ss.brandName)));
      if (!isMyBrand) return;
      
      // sellerName에서 셀러 정보 가져오기
      const sellerName = ss.sellerName || '알 수 없음';
      const parts = sellerName.split('/');
      const displayName = parts.length > 1 ? parts[1] : sellerName;
      const sellerKey = sellerName;
      
      // 셀러 채널 링크 찾기
      const seller = state.sellers.find(s => s.name && s.name.includes(displayName));
      
      const targetMap = ss.isCompleted ? salesBySellerCompleted : salesBySellerPending;
      
      if (!targetMap[sellerKey]) {
        targetMap[sellerKey] = { 
          sellerKey, 
          sellerName: displayName, 
          channelLink: seller?.channelLink || seller?.accountLink || '', 
          totalAmount: 0, 
          dealCount: 0 
        };
      }
      targetMap[sellerKey].totalAmount += Number(ss.salesAmount) || 0;
      targetMap[sellerKey].dealCount += 1;
    });
    
    const topSellersPending = Object.values(salesBySellerPending).filter(s => s.totalAmount > 0).sort((a, b) => b.totalAmount - a.totalAmount).slice(0, 3);
    const topSellersCompleted = Object.values(salesBySellerCompleted).filter(s => s.totalAmount > 0).sort((a, b) => b.totalAmount - a.totalAmount).slice(0, 3);
    
    const renderSellersList = (sellers, emptyMsg) => sellers.length === 0 ? `
      <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
        <div style="font-size: 32px; margin-bottom: 8px;">👤</div>
        <p style="font-size: 13px;">${emptyMsg}</p>
      </div>
    ` : `
      <div class="seller-grid" style="display: grid; grid-template-columns: repeat(${Math.min(sellers.length, 3)}, 1fr); gap: 10px;">
        ${sellers.map((s, idx) => `
          <div style="text-align: center; padding: 12px 8px; background: ${idx === 0 ? 'linear-gradient(135deg, #fef3c7, #fde68a)' : idx === 1 ? 'linear-gradient(135deg, #f3f4f6, #e5e7eb)' : 'linear-gradient(135deg, #fed7aa, #fdba74)'}; border-radius: 10px;">
            <div style="font-size: 20px; margin-bottom: 6px;">${idx === 0 ? '🥇' : idx === 1 ? '🥈' : '🥉'}</div>
            <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 4px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.sellerName}</div>
            <div style="font-weight: 700; color: #dc2626; font-size: 13px; margin-bottom: 6px;">${formatNumber(s.totalAmount)}원</div>
            ${s.channelLink ? `<a href="${s.channelLink.startsWith('http') ? s.channelLink : 'https://' + s.channelLink}" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: rgba(255,255,255,0.8); border-radius: 20px; font-size: 10px; color: var(--info); text-decoration: none; font-weight: 500;">${getChannelIconPortal(s.channelLink)} 채널</a>` : ''}
          </div>
        `).join('')}
      </div>
    `;
    
    topSellersHtml = `
      <div class="card" style="height: 100%;">
        <h3 class="card-title">많이 판매한 셀러 TOP</h3>
        <div style="display: flex; border-radius: 8px; overflow: hidden; margin-bottom: 12px; border: 1px solid rgba(252, 150, 0, 0.2);">
          <button id="sellerTabPending" onclick="switchSellerTab('pending')" style="flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 12px; background: var(--primary); color: white;">정산예정</button>
          <button id="sellerTabCompleted" onclick="switchSellerTab('completed')" style="flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: 500; font-size: 12px; background: #fff8f0; color: var(--gray-600);">정산완료</button>
        </div>
        <div id="sellerContentPending">${renderSellersList(topSellersPending, '아직 정산예정 판매 데이터가 없습니다.')}</div>
        <div id="sellerContentCompleted" style="display: none;">${renderSellersList(topSellersCompleted, '아직 정산완료된 판매 데이터가 없습니다.')}</div>
      </div>
    `;
  }
  
  // 공구 진행 TOP 5 HTML 수정 (데이터 없을 때도 표시)
  if (state.userType === 'supplier') {
    topProductsHtml = `
      <div class="card" style="height: 100%;">
        <h3 class="card-title">공구 진행 건수 TOP</h3>
        <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">공구에 등록된 횟수가 많은 순서입니다.</p>
        ${productStats.length === 0 ? `
          <div style="text-align: center; padding: 40px 20px; color: var(--gray-400);">
            <div style="font-size: 32px; margin-bottom: 8px;">📦</div>
            <p style="font-size: 13px;">아직 공구에 등록된 상품이 없습니다.</p>
          </div>
        ` : productStats.map((p, idx) => `
          <div class="top-item" style="display: flex; align-items: center; padding: 10px 0; ${idx < productStats.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : ''}">
            <div class="top-rank" style="width: 24px; height: 24px; min-width: 24px; background: ${idx === 0 ? 'linear-gradient(135deg, #FFD700, #FFA500)' : idx === 1 ? 'linear-gradient(135deg, #C0C0C0, #A0A0A0)' : idx === 2 ? 'linear-gradient(135deg, #CD7F32, #8B4513)' : 'var(--gray-200)'}; color: ${idx < 3 ? 'white' : 'var(--gray-600)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; margin-right: 10px; flex-shrink: 0;">${idx + 1}</div>
            <div style="flex: 1; min-width: 0;">
              <div class="top-name" style="font-weight: 600; color: var(--gray-800); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div>
              <div style="font-size: 11px; color: var(--gray-500);">공급가: ${formatNumber(p.supplyPrice || 0)}원</div>
            </div>
            <div class="top-count" style="background: var(--primary-light); color: var(--primary); padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 8px; flex-shrink: 0;">${p.dealCount}건</div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  container.innerHTML = `
    ${state.userType === 'supplier' ? `
      <!-- 공급사 대시보드 매출 통계 -->
      ${renderSupplierDashboardStats()}
      
      <!-- 통계 카드 - 2x2 그리드 -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
        <div class="stat-card" style="cursor: pointer; padding: 16px; text-align: center;" onclick="document.getElementById('section-ongoing')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-label" style="font-size: 12px; margin-bottom: 6px;">진행중</div>
          <div class="stat-value" style="font-size: 24px; color: var(--primary);">${ongoingDeals.length}</div>
        </div>
        <div class="stat-card" style="cursor: pointer; padding: 16px; text-align: center;" onclick="document.getElementById('section-upcoming')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-label" style="font-size: 12px; margin-bottom: 6px;">진행예정</div>
          <div class="stat-value" style="font-size: 24px; color: #2563eb;">${upcomingDeals.length}</div>
        </div>
        <div class="stat-card" style="cursor: pointer; padding: 16px; text-align: center;" onclick="document.getElementById('section-completed')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-label" style="font-size: 12px; margin-bottom: 6px;">완료</div>
          <div class="stat-value" style="font-size: 24px; color: #059669;">${completedDeals.length}</div>
        </div>
        <div class="stat-card" style="cursor: pointer; padding: 16px; text-align: center;" onclick="document.getElementById('section-all')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-label" style="font-size: 12px; margin-bottom: 6px;">전체</div>
          <div class="stat-value" style="font-size: 24px; color: var(--gray-600);">${myDeals.length}</div>
        </div>
      </div>
    ` : `
      <!-- 셀러 대시보드 -->
      ${renderSellerDashboardStats()}
      
      <!-- 셀러 공구 현황 카드 -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px;">
        <div class="stat-card" style="cursor: pointer; padding: 12px; text-align: center;" onclick="toggleOngoingDeals(); document.getElementById('section-ongoing')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-label" style="font-size: 11px; margin-bottom: 4px;">진행중</div>
          <div class="stat-value" style="font-size: 20px; color: var(--primary);">${ongoingDeals.length}</div>
        </div>
        <div class="stat-card" style="cursor: pointer; padding: 12px; text-align: center;" onclick="toggleUpcomingDeals(); document.getElementById('section-upcoming')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-label" style="font-size: 11px; margin-bottom: 4px;">예정</div>
          <div class="stat-value" style="font-size: 20px; color: #2563eb;">${upcomingDeals.length}</div>
        </div>
        <div class="stat-card" style="cursor: pointer; padding: 12px; text-align: center;" onclick="toggleCompletedDeals(); document.getElementById('section-completed')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-label" style="font-size: 11px; margin-bottom: 4px;">완료</div>
          <div class="stat-value" style="font-size: 20px; color: #059669;">${completedDeals.length}</div>
        </div>
        <div class="stat-card" style="cursor: pointer; padding: 12px; text-align: center;" onclick="toggleAllDeals(); document.getElementById('section-all')?.scrollIntoView({behavior: 'smooth'})">
          <div class="stat-label" style="font-size: 11px; margin-bottom: 4px;">전체</div>
          <div class="stat-value" style="font-size: 20px; color: var(--gray-600);">${myDeals.length}</div>
        </div>
      </div>
    `}
    
    <!-- TOP 섹션 - 공급사만 (2열 2단) -->
    ${state.userType === 'supplier' ? `
      <!-- 1행: Best 판매 상품 TOP / 많이 판매한 셀러 TOP -->
      <div class="top-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div>${salesBestHtml}</div>
        <div>${topSellersHtml}</div>
      </div>
      
      <!-- 2행: 공구 진행 건수 TOP (풀와이드) -->
      <div style="margin-bottom: 16px;">
        ${topProductsHtml}
      </div>
    ` : ''}
    
    <!-- 진행중인 공구 (접힌 상태) -->
    <div id="section-ongoing">
      <div class="card" style="border-left: 4px solid var(--primary);">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 4px 0;" onclick="toggleOngoingDeals()">
          <h3 class="card-title" style="margin: 0;">진행중인 공구 <span style="color: var(--primary); font-weight: 600;">(${ongoingDeals.length})</span></h3>
          <span id="ongoing-deals-toggle" style="font-size: 16px; color: var(--gray-400); padding: 8px;">▼</span>
        </div>
        <div id="ongoing-deals-content" style="display: none; margin-top: 16px;">
          ${ongoingDeals.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${ongoingDeals.map(d => renderDealItem(d, 'ongoing')).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
              <div style="font-size: 32px; margin-bottom: 8px;">🔥</div>
              <p style="font-size: 13px;">진행중인 공구가 없습니다</p>
            </div>
          `}
        </div>
      </div>
    </div>
    
    <!-- 예정된 공구 (닫힌 상태) -->
    <div id="section-upcoming">
      <div class="card" style="border-left: 4px solid #2563eb;">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 4px 0;" onclick="toggleUpcomingDeals()">
          <h3 class="card-title" style="margin: 0;">진행예정 공구 <span style="color: #2563eb; font-weight: 600;">(${upcomingDeals.length})</span></h3>
          <span id="upcoming-deals-toggle" style="font-size: 16px; color: var(--gray-400); padding: 8px;">▼</span>
        </div>
        <div id="upcoming-deals-content" style="display: none; margin-top: 16px;">
          ${upcomingDeals.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${upcomingDeals.map(d => renderDealItem(d, 'upcoming')).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
              <div style="font-size: 32px; margin-bottom: 8px;">📅</div>
              <p style="font-size: 13px;">예정된 공구가 없습니다</p>
            </div>
          `}
        </div>
      </div>
    </div>
    
    <!-- 완료된 공구 (접힌 상태) -->
    <div id="section-completed">
      <div class="card" style="border-left: 4px solid #059669;">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 4px 0;" onclick="toggleCompletedDeals()">
          <h3 class="card-title" style="margin: 0;">완료된 공구 <span style="color: #059669; font-weight: 600;">(${completedDeals.length})</span></h3>
          <span id="completed-deals-toggle" style="font-size: 16px; color: var(--gray-400); padding: 8px;">▼</span>
        </div>
        <div id="completed-deals-content" style="display: none; margin-top: 16px;">
          ${completedDeals.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${completedDeals.map(d => renderDealItem(d, 'completed')).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
              <div style="font-size: 32px; margin-bottom: 8px;">✅</div>
              <p style="font-size: 13px;">완료된 공구가 없습니다</p>
            </div>
          `}
        </div>
      </div>
    </div>
    
    <!-- 전체 공구 (접힌 상태) -->
    <div id="section-all">
      <div class="card" style="border-left: 4px solid var(--gray-400);">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 4px 0;" onclick="toggleAllDeals()">
          <h3 class="card-title" style="margin: 0;">전체 공구 <span style="color: var(--gray-500); font-weight: 600;">(${myDeals.length})</span></h3>
          <span id="all-deals-toggle" style="font-size: 16px; color: var(--gray-400); padding: 8px;">▼</span>
        </div>
        <div id="all-deals-content" style="display: none; margin-top: 16px;">
          ${myDeals.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${myDeals.map(d => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const start = new Date(d.startDate);
                const end = new Date(d.endDate);
                let statusType = 'upcoming';
                if (today >= start && today <= end) statusType = 'ongoing';
                else if (today > end) statusType = 'completed';
                return renderDealItem(d, statusType);
              }).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
              <div style="font-size: 32px; margin-bottom: 8px;">📦</div>
              <p style="font-size: 13px;">등록된 공구가 없습니다</p>
            </div>
          `}
        </div>
      </div>
    </div>
  `;
}

// 예정된 공구 토글
function toggleUpcomingDeals() {
  const content = document.getElementById('upcoming-deals-content');
  const toggle = document.getElementById('upcoming-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

// 진행중인 공구 토글
function toggleOngoingDeals() {
  const content = document.getElementById('ongoing-deals-content');
  const toggle = document.getElementById('ongoing-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

// 완료된 공구 토글
function toggleCompletedDeals() {
  const content = document.getElementById('completed-deals-content');
  const toggle = document.getElementById('completed-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

// 전체 공구 토글
function toggleAllDeals() {
  const content = document.getElementById('all-deals-content');
  const toggle = document.getElementById('all-deals-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

// 셀러 대시보드 통계 렌더링
function renderSellerDashboardStats() {
  // 내 정산 데이터 (sellerId로 우선 필터, 없으면 sellerName 정확히 매칭)
  const mySettlements = (state.sellerSettlements || []).filter(s => {
    // sellerId가 있으면 정확히 매칭
    if (s.sellerId && state.currentUser.id) {
      return s.sellerId === state.currentUser.id;
    }
    // sellerName이 정확히 일치하거나 현재 유저 이름을 포함하는지 확인
    const sellerName = s.sellerName || '';
    const currentName = state.currentUser.name || '';
    // 정확한 매칭 (셀러명이 "이하늘/하린맘(0.5만)" 형태일 때 "이하늘"이 포함되어야 함)
    if (currentName && sellerName) {
      // currentName의 첫번째 부분 (이름)이 sellerName에 정확히 포함되어야 함
      const namePart = currentName.split('/')[0];
      const sellerNamePart = sellerName.split('/')[0];
      return namePart === sellerNamePart || sellerName === currentName;
    }
    return false;
  });
  
  // 총 판매건(공구 진행건), 총 판매액 계산
  const totalSalesCount = mySettlements.length;
  const totalSalesAmount = mySettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  
  // 상품별 판매 집계
  const salesByProduct = {};
  mySettlements.forEach(s => {
    const items = s.salesItems || s.items || [];
    if (items.length > 0) {
      items.forEach(item => {
        const productName = item.productName || item.name || '알 수 없음';
        if (!salesByProduct[productName]) {
          salesByProduct[productName] = { productName, totalQty: 0, totalAmount: 0 };
        }
        salesByProduct[productName].totalQty += Number(item.quantity) || 0;
        salesByProduct[productName].totalAmount += Number(item.amount) || 0;
      });
    }
  });
  
  // 브랜드별 매출 집계
  const salesByBrand = {};
  mySettlements.forEach(s => {
    const brandName = s.brandName || '기타';
    if (!salesByBrand[brandName]) {
      salesByBrand[brandName] = { brandName, totalAmount: 0, count: 0 };
    }
    salesByBrand[brandName].totalAmount += Number(s.salesAmount) || 0;
    salesByBrand[brandName].count += 1;
  });
  
  // 정산 예정/완료 금액 계산 (actualPayment 기준)
  const pendingSettlements = mySettlements.filter(s => !s.isCompleted);
  const completedSettlements = mySettlements.filter(s => s.isCompleted);
  const pendingAmount = pendingSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || Number(s.marginAmount) || 0), 0);
  const completedAmount = completedSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || Number(s.marginAmount) || 0), 0);
  
  // TOP 5 상품
  const topProducts = Object.values(salesByProduct)
    .filter(p => p.totalAmount > 0)
    .sort((a, b) => b.totalQty - a.totalQty)
    .slice(0, 5);
  
  // TOP 브랜드
  const topBrands = Object.values(salesByBrand)
    .filter(b => b.totalAmount > 0)
    .sort((a, b) => b.totalAmount - a.totalAmount)
    .slice(0, 5);
  
  // 진행 중 공구 상세 정보
  const myDeals = state.deals.filter(d => d.sellerId === state.currentUser.id);
  const today = new Date();
  today.setHours(0,0,0,0);
  
  const ongoingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    const end = new Date(d.endDate);
    return today >= start && today <= end;
  });
  
  const upcomingDeals = myDeals.filter(d => {
    const start = new Date(d.startDate);
    return today < start;
  }).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
  
  // 진행 중 공구 상세 카드 HTML - 진행/예정 분리
  let ongoingDealsDetailHtml = '';
  
  // 진행중 공구 카드
  if (ongoingDeals.length > 0) {
    let ongoingCards = ongoingDeals.map(d => {
      const supplier = state.suppliers.find(s => s.id === d.supplierId);
      const products = d.selectedProducts || [];
      const productNames = products.map(p => {
        if (typeof p === 'string') {
          const prod = state.supplierProducts.find(sp => sp.id === p);
          return prod?.productName || '상품';
        }
        return p.productName || '상품';
      }).slice(0, 2);
      
      return `
        <div style="padding: 14px; background: linear-gradient(145deg, #fff5eb, #ffffff); border-radius: 10px; border: 1px solid rgba(252,150,0,0.2); cursor: pointer;" onclick="openDealModal('${d.id}')">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="flex: 1;">
              <div style="font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 2px;">${supplier?.name || '-'}</div>
              <div style="font-weight: 700; font-size: 13px; color: var(--gray-800);">${productNames.join(', ')}${products.length > 2 ? ' 외' : ''}</div>
            </div>
            <span style="background: var(--primary); color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">진행중</span>
          </div>
          <div style="font-size: 11px; color: var(--gray-500);">${d.startDate} ~ ${d.endDate}</div>
        </div>
      `;
    }).join('');
    
    ongoingDealsDetailHtml += `
      <div class="card" style="margin-bottom: 12px; border-left: 4px solid var(--primary);">
        <h3 class="card-title" style="font-size: 14px;">🔥 진행중 공구 <span style="color: var(--primary);">(${ongoingDeals.length})</span></h3>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${ongoingCards}
        </div>
      </div>
    `;
  }
  
  // TOP 5 상품 HTML
  let topProductsHtml = '';
  if (topProducts.length === 0) {
    topProductsHtml = `
      <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
        <div style="font-size: 28px; margin-bottom: 8px;">📦</div>
        <p style="font-size: 12px;">아직 판매 데이터가 없습니다.</p>
      </div>
    `;
  } else {
    topProductsHtml = topProducts.map((p, idx) => {
      const bgColor = idx === 0 ? 'linear-gradient(135deg, #dc2626, #f97316)' : idx === 1 ? 'linear-gradient(135deg, #ea580c, #f59e0b)' : idx === 2 ? 'linear-gradient(135deg, #f59e0b, #fbbf24)' : 'var(--gray-200)';
      const textColor = idx < 3 ? 'white' : 'var(--gray-600)';
      const borderStyle = idx < topProducts.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : '';
      return `
        <div style="display: flex; align-items: center; padding: 8px 0; ${borderStyle}">
          <div style="width: 22px; height: 22px; background: ${bgColor}; color: ${textColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; margin-right: 10px;">${idx + 1}</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: var(--gray-800); font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div>
          </div>
          <div style="font-weight: 700; color: var(--primary); font-size: 11px; margin-left: 8px;">${p.totalQty}개</div>
        </div>
      `;
    }).join('');
  }
  
  // TOP 브랜드 HTML
  let topBrandsHtml = '';
  if (topBrands.length === 0) {
    topBrandsHtml = `
      <div style="text-align: center; padding: 30px 20px; color: var(--gray-400);">
        <div style="font-size: 28px; margin-bottom: 8px;">🏆</div>
        <p style="font-size: 12px;">아직 판매 데이터가 없습니다.</p>
      </div>
    `;
  } else {
    topBrandsHtml = topBrands.map((b, idx) => {
      const bgColor = idx === 0 ? 'linear-gradient(135deg, #dc2626, #f97316)' : idx === 1 ? 'linear-gradient(135deg, #ea580c, #f59e0b)' : idx === 2 ? 'linear-gradient(135deg, #f59e0b, #fbbf24)' : 'var(--gray-200)';
      const textColor = idx < 3 ? 'white' : 'var(--gray-600)';
      const borderStyle = idx < topBrands.length - 1 ? 'border-bottom: 1px solid var(--gray-100);' : '';
      return `
        <div style="display: flex; align-items: center; padding: 8px 0; ${borderStyle}">
          <div style="width: 22px; height: 22px; background: ${bgColor}; color: ${textColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; margin-right: 10px;">${idx + 1}</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: var(--gray-800); font-size: 12px;">${b.brandName}</div>
          </div>
          <div style="font-weight: 700; color: #dc2626; font-size: 11px; margin-left: 8px;">${formatNumber(b.totalAmount)}원</div>
        </div>
      `;
    }).join('');
  }
  
  // 셀러 이름 추출 (성 제외, 이름만)
  const sellerFullName = state.currentUser.name?.split('/')[0] || state.currentUser.name || '';
  // 이름만 추출 (성 제외) - 한글 이름은 보통 2-3글자이므로 마지막 1-2글자
  const sellerFirstName = sellerFullName.length > 1 ? sellerFullName.slice(1) : sellerFullName;
  
  // 매일 다른 감성 멘트 (날짜 기반)
  const motivationalMessages = [
    { greeting: '오늘도 힘내세요!', message: '모여라딜은 언제나 함께합니다 💪' },
    { greeting: '수고 많으셨어요!', message: '당신의 노력이 빛나는 하루였어요 ✨' },
    { greeting: '오늘 하루도 파이팅!', message: '모여라딜은 당신 덕분에 자라고 있어요 🌱' },
    { greeting: '좋은 하루 되세요!', message: '함께해서 행복해요 🧡' },
    { greeting: '늘 응원합니다!', message: '오늘도 멋진 성과 기대할게요 🎯' },
    { greeting: '고생 많으셨어요!', message: '최고의 파트너와 함께해서 영광이에요 🏆' },
    { greeting: '오늘도 감사해요!', message: '좋은 일만 가득하길 바랍니다 🍀' }
  ];
  const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
  const todayMessage = motivationalMessages[dayOfYear % motivationalMessages.length];
  
  return `
    <!-- 셀러 인사 - 감성 멘트 -->
    <div style="margin-bottom: 16px; padding: 20px; background: linear-gradient(135deg, var(--primary), #f97316); border-radius: 16px; color: white; box-shadow: 0 6px 20px rgba(252, 150, 0, 0.3);">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">👋</div>
        <div>
          <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">안녕하세요, ${sellerFirstName}님! ${todayMessage.greeting}</div>
          <div style="font-size: 13px; opacity: 0.9;">${todayMessage.message}</div>
        </div>
      </div>
    </div>
    
    <!-- 진행/예정 공구 (상단 배치) -->
    ${ongoingDealsDetailHtml}
    
    <!-- 판매 요약 -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
      <div class="stat-card highlight" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">공구 진행건</div>
        <div style="font-size: 24px; font-weight: 700;">${totalSalesCount}건</div>
      </div>
      <div class="stat-card highlight" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">총 판매액</div>
        <div style="font-size: 24px; font-weight: 700;">${formatNumber(totalSalesAmount)}원</div>
      </div>
    </div>
    
    <!-- 정산 예정/완료 -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
      <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #2563eb;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 예정</div>
        <div style="font-size: 20px; font-weight: 700; color: #2563eb;">${formatNumber(pendingAmount)}원</div>
        <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${pendingSettlements.length}건</div>
      </div>
      <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #059669;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 완료</div>
        <div style="font-size: 20px; font-weight: 700; color: #059669;">${formatNumber(completedAmount)}원</div>
        <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${completedSettlements.length}건</div>
      </div>
    </div>
    
    <!-- TOP 5 상품 / TOP 브랜드 -->
    <div class="top-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
      <div class="card" style="height: 100%; padding: 16px;">
        <h3 class="card-title" style="font-size: 14px; margin-bottom: 12px;">판매 상품 TOP 5</h3>
        ${topProductsHtml}
      </div>
      
      <div class="card" style="height: 100%; padding: 16px;">
        <h3 class="card-title" style="font-size: 14px; margin-bottom: 12px;">매출 TOP 브랜드</h3>
        ${topBrandsHtml}
      </div>
    </div>
  `;
}

// 공급사 대시보드 매출 통계 렌더링
function renderSupplierDashboardStats() {
  // 내 공급사 정산 데이터 (supplierSettlements에서 필터) - 더 유연한 매칭
  const mySupplierSettlements = (state.supplierSettlements || []).filter(s => {
    const brandName = (s.brandName || '').trim().toLowerCase();
    const currentName = (state.currentUser.name || '').trim().toLowerCase();
    const currentId = state.currentUser.id || '';
    
    // 1. ID로 정확히 매칭 (가장 우선)
    if (s.supplierId && s.supplierId === currentId) return true;
    
    // 2. 이름 정확히 일치
    if (brandName === currentName) return true;
    
    // 3. 부분 일치 (공백, 특수문자 무시)
    const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
    const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
    if (cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand)) return true;
    
    return false;
  });
  
  // 총 판매액 계산 (supplierSettlements 기준)
  const totalSalesAmount = mySupplierSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  
  // 정산 예정 금액 (isCompleted가 false 또는 없는 것) - totalAmount(V+) 기준
  const pendingSettlements = mySupplierSettlements.filter(s => !s.isCompleted);
  const pendingAmount = pendingSettlements.reduce((sum, s) => sum + (Number(s.totalAmount) || 0), 0);
  
  // 정산 완료 금액 (isCompleted가 true) - totalAmount(V+) 기준
  const completedSettlements = mySupplierSettlements.filter(s => s.isCompleted === true);
  const completedAmount = completedSettlements.reduce((sum, s) => sum + (Number(s.totalAmount) || 0), 0);
  
  // 공급사 이름
  const supplierName = state.currentUser.name || '공급사';
  
  // 매일 다른 감성 멘트
  const motivationalMessages = [
    { greeting: '오늘도 힘내세요!', message: '좋은 제품으로 함께 성장해요 💪' },
    { greeting: '수고 많으셨어요!', message: '당신의 노력이 빛나는 하루였어요 ✨' },
    { greeting: '오늘 하루도 파이팅!', message: '모여라딜은 당신 덕분에 자라고 있어요 🌱' },
    { greeting: '좋은 하루 되세요!', message: '함께해서 행복해요 🧡' },
    { greeting: '늘 응원합니다!', message: '오늘도 멋진 성과 기대할게요 🎯' },
    { greeting: '고생 많으셨어요!', message: '최고의 파트너와 함께해서 영광이에요 🏆' },
    { greeting: '오늘도 감사해요!', message: '좋은 일만 가득하길 바랍니다 🍀' }
  ];
  const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
  const todayMessage = motivationalMessages[dayOfYear % motivationalMessages.length];
  
  return `
    <!-- 공급사 인사 - 감성 멘트 -->
    <div style="margin-bottom: 16px; padding: 20px; background: linear-gradient(135deg, var(--primary), #f97316); border-radius: 16px; color: white; box-shadow: 0 6px 20px rgba(252, 150, 0, 0.3);">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">👋</div>
        <div>
          <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">안녕하세요, ${supplierName}님! ${todayMessage.greeting}</div>
          <div style="font-size: 13px; opacity: 0.9;">${todayMessage.message}</div>
        </div>
      </div>
    </div>
    
    <!-- 매출/정산 요약 -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
      <div class="stat-card highlight" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">공구 진행건</div>
        <div style="font-size: 24px; font-weight: 700;">${mySupplierSettlements.length}건</div>
      </div>
      <div class="stat-card highlight" style="padding: 16px; text-align: center;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">총 판매액</div>
        <div style="font-size: 24px; font-weight: 700;">${formatNumber(totalSalesAmount)}원</div>
      </div>
    </div>
    
    <!-- 정산 현황 -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
      <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #2563eb;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 예정</div>
        <div style="font-size: 20px; font-weight: 700; color: #2563eb;">${formatNumber(pendingAmount)}원</div>
        <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${pendingSettlements.length}건</div>
      </div>
      <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #059669;">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 완료</div>
        <div style="font-size: 20px; font-weight: 700; color: #059669;">${formatNumber(completedAmount)}원</div>
        <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${completedSettlements.length}건</div>
      </div>
    </div>
  `;
}

function getMyDeals() {
  if (state.userType === 'supplier') {
    return state.deals.filter(d => d.supplierId === state.currentUser.id);
  } else {
    return state.deals.filter(d => d.sellerId === state.currentUser.id);
  }
}

function renderDealItem(deal, status) {
  let statusClass, statusText;
  if (status === 'ongoing') {
    statusClass = 'status-ongoing';
    statusText = '진행중';
  } else if (status === 'completed') {
    statusClass = 'status-completed';
    statusText = '완료';
  } else {
    statusClass = 'status-upcoming';
    statusText = 'D-' + getDday(deal.startDate);
  }
  
  // 공급사인 경우 셀러 닉네임만 표시
  // 셀러인 경우 공급사명 + 상품명으로 표시
  let displayTitle = deal.title;
  let subInfo = '';
  if (state.userType === 'supplier') {
    const seller = state.sellers.find(s => s.id === deal.sellerId);
    if (seller && seller.name) {
      const parts = seller.name.split('/');
      if (parts.length > 1) {
        displayTitle = parts[1]; // 닉네임(팔로워수)
      } else {
        displayTitle = seller.name;
      }
    }
  } else {
    // 셀러인 경우 공급사명 + 상품명 표시
    const supplier = state.suppliers.find(s => s.id === deal.supplierId);
    const products = deal.selectedProducts || [];
    const productNames = products.map(p => {
      if (typeof p === 'string') {
        const prod = state.supplierProducts.find(sp => sp.id === p);
        return prod?.productName || '상품';
      }
      return p.productName || '상품';
    }).slice(0, 2);
    if (productNames.length > 0) {
      displayTitle = productNames.join(', ') + (products.length > 2 ? ' 외' : '');
    }
    if (supplier?.name) {
      subInfo = supplier.name;
    }
  }
  
  return `
    <div class="list-item" onclick="openDealModal('${deal.id}')">
      <div>
        ${subInfo ? `<div style="font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 2px;">${subInfo}</div>` : ''}
        <div class="list-title">${displayTitle}</div>
        <div class="list-meta">${deal.startDate} ~ ${deal.endDate}</div>
      </div>
      <span class="status-badge ${statusClass}">${statusText}</span>
    </div>
  `;
}

function getDday(dateStr) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const target = new Date(dateStr);
  target.setHours(0,0,0,0);
  const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
  return diff;
}

// 채널 아이콘 반환 (파트너 포털용)
function getChannelIconPortal(link) {
  if (!link) return '🔗';
  const lower = link.toLowerCase();
  if (lower.includes('instagram')) return '📷';
  if (lower.includes('youtube')) return '🎬';
  if (lower.includes('naver') || lower.includes('blog')) return '📝';
  if (lower.includes('kakao')) return '💬';
  if (lower.includes('tiktok')) return '🎵';
  return '🔗';
}

// ===== 캘린더 =====
let calendarYear, calendarMonth;

function renderCalendar(container) {
  const today = new Date();
  const todayStr = formatDate(today);
  if (!calendarYear) calendarYear = today.getFullYear();
  if (!calendarMonth) calendarMonth = today.getMonth();
  
  const myDeals = getMyDeals();
  const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
  const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
  const prevMonthDays = new Date(calendarYear, calendarMonth, 0).getDate();
  
  // 🚀 다가오는 공구 계산 (D-day) - 상단에 표시
  const upcomingDealsWithDday = myDeals.filter(d => d.startDate > todayStr).map(d => {
    const start = new Date(d.startDate);
    const diffTime = start.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return { ...d, dDay: diffDays };
  }).sort((a, b) => a.dDay - b.dDay);
  
  const upcomingSoon = upcomingDealsWithDday.filter(d => d.dDay <= 14).slice(0, 5);
  const upcomingListHtml = upcomingSoon.length > 0 ? `
    <div class="card" style="margin-bottom: 20px; border-left: 4px solid var(--primary);">
      <h3 class="card-title">다가오는 공구</h3>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        ${upcomingSoon.map(d => {
          let displayTitle = d.title;
          let subInfo = '';
          if (state.userType === 'supplier') {
            const seller = state.sellers.find(s => s.id === d.sellerId);
            if (seller && seller.name) {
              const parts = seller.name.split('/');
              displayTitle = parts.length > 1 ? parts[1] : seller.name;
            }
          } else {
            // 셀러인 경우 공급사명 + 상품명
            const supplier = state.suppliers.find(s => s.id === d.supplierId);
            const products = d.selectedProducts || [];
            const productNames = products.map(p => {
              if (typeof p === 'string') {
                const prod = state.supplierProducts.find(sp => sp.id === p);
                return prod?.productName || '상품';
              }
              return p.productName || '상품';
            }).slice(0, 2);
            if (productNames.length > 0) {
              displayTitle = productNames.join(', ') + (products.length > 2 ? ' 외' : '');
            }
            if (supplier?.name) {
              subInfo = supplier.name;
            }
          }
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-50); border-radius: 8px; cursor: pointer;" onclick="openDealModal('${d.id}')">
              <div>
                ${subInfo ? `<div style="font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 2px;">${subInfo}</div>` : ''}
                <span style="font-weight: 600;">${displayTitle}</span>
                <span style="font-size: 12px; color: var(--gray-500); margin-left: 8px;">${d.startDate} ~ ${d.endDate}</span>
              </div>
              <span style="background: linear-gradient(135deg, var(--primary), #f59e0b); color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 700;">D-${d.dDay}</span>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  ` : '';
  
  let calendarDays = '';
  
  // 이전 달
  for (let i = firstDay - 1; i >= 0; i--) {
    calendarDays += `<div class="calendar-day other-month"><div class="day-number">${prevMonthDays - i}</div></div>`;
  }
  
  // 현재 달
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === todayStr;
    const dayOfWeek = new Date(calendarYear, calendarMonth, day).getDay();
    
    const dayDeals = myDeals.filter(d => dateStr >= d.startDate && dateStr <= d.endDate);
    
    let badges = dayDeals.slice(0, 3).map(d => {
      // 공급사인 경우 셀러 닉네임만 표시 (이름 제외)
      // 셀러인 경우 공급사명으로 표시
      let displayTitle = d.title;
      if (state.userType === 'supplier') {
        const seller = state.sellers.find(s => s.id === d.sellerId);
        if (seller && seller.name) {
          const parts = seller.name.split('/');
          displayTitle = parts.length > 1 ? parts[1] : seller.name;
        }
      } else {
        // 셀러인 경우 공급사명으로 표시 (짧게)
        const supplier = state.suppliers.find(s => s.id === d.supplierId);
        if (supplier?.name) {
          displayTitle = supplier.name;
        }
      }
      
      // 완료 여부 확인 (종료일이 오늘 이전)
      const isCompleted = d.endDate < todayStr;
      const badgeStyle = isCompleted ? 'background: var(--gray-300); color: var(--gray-500);' : '';
      
      return `<div class="deal-badge" style="${badgeStyle}" onclick="event.stopPropagation();openDealModal('${d.id}')">${displayTitle}</div>`;
    }).join('');
    
    if (dayDeals.length > 3) {
      badges += `<div style="font-size:11px;color:var(--gray-500);">+${dayDeals.length - 3}개</div>`;
    }
    
    calendarDays += `
      <div class="calendar-day ${isToday ? 'today' : ''}">
        <div class="day-number ${dayOfWeek === 0 ? 'sunday' : ''} ${dayOfWeek === 6 ? 'saturday' : ''}">${day}</div>
        ${badges}
      </div>
    `;
  }
  
  // 다음 달
  const totalCells = firstDay + daysInMonth;
  const nextDays = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
  for (let i = 1; i <= nextDays; i++) {
    calendarDays += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
  }
  
  container.innerHTML = `
    <h1 class="page-title">내 일정</h1>
    <p class="page-desc">내 공구 일정을 확인하세요.</p>
    
    ${upcomingListHtml}
    
    <div class="card">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="changeMonth(-1)">◀</button>
          <span class="calendar-title">${calendarYear}년 ${calendarMonth + 1}월</span>
          <button onclick="changeMonth(1)">▶</button>
        </div>
        <button class="btn btn-secondary" onclick="goToday()">오늘</button>
      </div>
      
      <div class="calendar-grid">
        <div class="calendar-weekday">일</div>
        <div class="calendar-weekday">월</div>
        <div class="calendar-weekday">화</div>
        <div class="calendar-weekday">수</div>
        <div class="calendar-weekday">목</div>
        <div class="calendar-weekday">금</div>
        <div class="calendar-weekday">토</div>
        ${calendarDays}
      </div>
    </div>
  `;
}

function changeMonth(delta) {
  calendarMonth += delta;
  if (calendarMonth < 0) {
    calendarMonth = 11;
    calendarYear--;
  } else if (calendarMonth > 11) {
    calendarMonth = 0;
    calendarYear++;
  }
  renderCalendar(document.getElementById('main-content'));
}

function goToday() {
  const today = new Date();
  calendarYear = today.getFullYear();
  calendarMonth = today.getMonth();
  renderCalendar(document.getElementById('main-content'));
}

// 🆕 판매 베스트 탭 전환
function switchSalesTab(tab) {
  const pendingBtn = document.getElementById('salesTabPending');
  const completedBtn = document.getElementById('salesTabCompleted');
  const pendingContent = document.getElementById('salesContentPending');
  const completedContent = document.getElementById('salesContentCompleted');
  
  if (tab === 'pending') {
    pendingBtn.style.background = 'var(--primary)';
    pendingBtn.style.color = 'white';
    pendingBtn.style.fontWeight = '600';
    completedBtn.style.background = 'white';
    completedBtn.style.color = 'var(--gray-600)';
    completedBtn.style.fontWeight = '500';
    pendingContent.style.display = 'block';
    completedContent.style.display = 'none';
  } else {
    completedBtn.style.background = 'var(--primary)';
    completedBtn.style.color = 'white';
    completedBtn.style.fontWeight = '600';
    pendingBtn.style.background = 'white';
    pendingBtn.style.color = 'var(--gray-600)';
    pendingBtn.style.fontWeight = '500';
    pendingContent.style.display = 'none';
    completedContent.style.display = 'block';
  }
}

// 🆕 셀러 TOP 탭 전환
function switchSellerTab(tab) {
  const pendingBtn = document.getElementById('sellerTabPending');
  const completedBtn = document.getElementById('sellerTabCompleted');
  const pendingContent = document.getElementById('sellerContentPending');
  const completedContent = document.getElementById('sellerContentCompleted');
  
  if (tab === 'pending') {
    pendingBtn.style.background = 'var(--primary)';
    pendingBtn.style.color = 'white';
    pendingBtn.style.fontWeight = '600';
    completedBtn.style.background = 'white';
    completedBtn.style.color = 'var(--gray-600)';
    completedBtn.style.fontWeight = '500';
    pendingContent.style.display = 'block';
    completedContent.style.display = 'none';
  } else {
    completedBtn.style.background = 'var(--primary)';
    completedBtn.style.color = 'white';
    completedBtn.style.fontWeight = '600';
    pendingBtn.style.background = 'white';
    pendingBtn.style.color = 'var(--gray-600)';
    pendingBtn.style.fontWeight = '500';
    pendingContent.style.display = 'none';
    completedContent.style.display = 'block';
  }
}

// ===== 공지사항 =====
function renderNotice(container) {
  const notices = state.notices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const readNotices = JSON.parse(localStorage.getItem('readNotices') || '[]');
  
  container.innerHTML = `
    <h1 class="page-title">공지사항</h1>
    <p class="page-desc">모여라딜의 새로운 소식을 확인하세요.</p>
    
    <div class="card" style="padding: 0; overflow: hidden;">
      ${notices.length === 0 ? `
        <div class="empty-state">
          <div class="icon">📢</div>
          <p>등록된 공지사항이 없습니다.</p>
        </div>
      ` : notices.map(n => {
        const isRead = readNotices.includes(n.id);
        return `
        <div class="notice-item" onclick="openNoticeModal('${n.id}')" style="${!isRead ? 'background: #fffbeb;' : ''}">
          <div style="display: flex; align-items: center; gap: 8px;">
            ${!isRead ? '<span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></span>' : ''}
            <span class="notice-badge ${n.important ? 'important' : 'normal'}">${n.important ? '중요' : '일반'}</span>
            <span class="notice-title">${n.title}</span>
          </div>
          <div class="notice-date">${formatDateKR(n.createdAt)}</div>
        </div>
      `}).join('')}
    </div>
  `;
}

function openNoticeModal(noticeId) {
  const notice = state.notices.find(n => n.id === noticeId);
  if (!notice) return;
  
  // 읽음 처리
  const readNotices = JSON.parse(localStorage.getItem('readNotices') || '[]');
  if (!readNotices.includes(noticeId)) {
    readNotices.push(noticeId);
    localStorage.setItem('readNotices', JSON.stringify(readNotices));
    renderNav(); // 네비게이션 업데이트
    renderNotice(document.getElementById('main-content')); // 목록 업데이트
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">공지사항</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div class="modal-body">
        <h2 style="margin-bottom: 8px;">${notice.title}</h2>
        <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 20px;">${formatDateKR(notice.createdAt)}</p>
        <div style="white-space: pre-wrap; line-height: 1.8;">${notice.content || '내용이 없습니다.'}</div>
      </div>
    </div>
  `;
}

// ===== 소통 =====
function renderMessage(container) {
  const myMessages = state.messages
    .filter(m => m.partnerId === state.currentUser.id && m.partnerType === state.userType)
    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
  
  container.innerHTML = `
    <h1 class="page-title">소통</h1>
    <p class="page-desc">담당자와 1:1로 소통하세요.</p>
    
    <div class="card">
      <div class="message-list" id="message-list">
        ${myMessages.length === 0 ? `
          <div class="empty-state" style="padding: 40px;">
            <div class="icon">💬</div>
            <p>아직 메시지가 없습니다.<br>담당자에게 문의해보세요!</p>
          </div>
        ` : myMessages.map(m => `
          <div class="message-item ${m.isAdmin ? 'admin' : 'mine'}">
            <div class="message-sender">${m.isAdmin ? '모여라딜 담당자' : '나'}</div>
            <div class="message-content">${m.content}</div>
            <div class="message-time">${formatDateKR(m.createdAt)}</div>
          </div>
        `).join('')}
      </div>
      
      <div class="message-input-area">
        <input type="text" class="form-input" id="message-input" placeholder="메시지를 입력하세요..." onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="btn btn-primary" style="width: auto;" onclick="sendMessage()">전송</button>
      </div>
    </div>
  `;
  
  // 스크롤 맨 아래로
  setTimeout(() => {
    const list = document.getElementById('message-list');
    if (list) list.scrollTop = list.scrollHeight;
  }, 100);
}

async function sendMessage() {
  const input = document.getElementById('message-input');
  const content = input.value.trim();
  if (!content) return;
  
  try {
    await db.collection('partnerMessages').add({
      partnerId: state.currentUser.id,
      partnerType: state.userType,
      partnerName: state.currentUser.name,
      content: content,
      isAdmin: false,
      createdAt: new Date().toISOString()
    });
    
    input.value = '';
    showToast('메시지를 전송했습니다.');
  } catch (e) {
    console.error(e);
    showToast('전송에 실패했습니다.');
  }
}

// ===== 상품 등록 (공급사 전용) =====
function renderProducts(container) {
  // supplierId 또는 brandName으로 매칭 (관리시스템 연동)
  const allMyProducts = state.supplierProducts.filter(p => {
    if (p.supplierId === state.currentUser.id) return true;
    if (p.brandName && state.currentUser.name && 
        p.brandName.includes(state.currentUser.name)) return true;
    return false;
  });
  
  // 검색 필터 적용
  const searchKeyword = state.productSearchKeyword || '';
  const myProducts = searchKeyword 
    ? allMyProducts.filter(p => (p.productName || '').toLowerCase().includes(searchKeyword.toLowerCase()))
    : allMyProducts;
  
  container.innerHTML = `
    <div class="product-header">
      <div>
        <h1 class="page-title">상품관리</h1>
        <p class="page-desc">공급 상품을 등록하고 관리하세요.</p>
      </div>
      <div class="product-actions" style="display: flex; gap: 8px;">
        <button class="btn action-btn-secondary" onclick="downloadExcelTemplate()">양식 다운로드</button>
        <button class="btn action-btn-secondary" onclick="openExcelUploadModal()">엑셀 일괄등록</button>
        <button class="btn action-btn-primary" onclick="openProductModal()">+ 상품 등록</button>
      </div>
    </div>
    
    <!-- 검색 영역 -->
    <div class="search-box" style="margin-bottom: 16px;">
      <div style="position: relative;">
        <input type="text" class="form-input" id="product-search" placeholder="상품명 검색 후 Enter" 
          value="${searchKeyword}" 
          onkeydown="if(event.key==='Enter') handleProductSearch(this.value)"
          style="padding-left: 40px;">
        <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--gray-400);">🔍</span>
        ${searchKeyword ? `<button onclick="clearProductSearch()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-400); cursor: pointer; font-size: 18px;">×</button>` : ''}
      </div>
      ${searchKeyword ? `<p style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">"${searchKeyword}" 검색 결과: ${myProducts.length}건</p>` : ''}
    </div>
    
    <div class="card">
      ${myProducts.length === 0 ? `
        <div class="empty-state">
          <div class="icon">📦</div>
          <p>${searchKeyword ? '검색 결과가 없습니다.' : '등록된 상품이 없습니다.<br>상품을 등록해보세요!'}</p>
        </div>
      ` : `
        <!-- PC 테이블 -->
        <div class="product-table-pc">
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="border-bottom: 2px solid var(--gray-200); background: var(--gray-50);">
                <th style="padding: 12px 8px; text-align: left; font-weight: 600;">상품명</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">정가(V+)</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">공구판매가</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">공급가(V+)</th>
                <th style="padding: 12px 8px; text-align: right; font-weight: 600;">수수료율</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 600;">공구연결</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 600; width: 120px;"></th>
              </tr>
            </thead>
            <tbody>
              ${myProducts.map(p => {
                const linkedDeals = state.deals.filter(d => {
                  if (!d.selectedProducts) return false;
                  return d.selectedProducts.some(item => {
                    const pid = typeof item === 'string' ? item : item.productId;
                    return pid === p.id;
                  });
                }).length;
                return `
                <tr style="border-bottom: 1px solid var(--gray-100);">
                  <td style="padding: 12px 8px;"><strong>${p.productName || '-'}</strong></td>
                  <td style="padding: 12px 8px; text-align: right;">${Number(p.originalPrice || 0) > 0 ? formatNumber(p.originalPrice) + '원' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right;">${Number(p.salePrice || 0) > 0 ? formatNumber(p.salePrice) + '원' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right; color: var(--primary); font-weight: 600;">${Number(p.supplyPrice || 0) > 0 ? formatNumber(p.supplyPrice) + '원' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: right;">${p.commission ? p.commission + '%' : '-'}</td>
                  <td style="padding: 12px 8px; text-align: center;">
                    ${linkedDeals > 0 ? `<span style="background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${linkedDeals}건</span>` : '<span style="color: var(--gray-400);">-</span>'}
                  </td>
                  <td style="padding: 12px 8px; text-align: center;">
                    <div style="display: flex; gap: 4px; justify-content: center;">
                      <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openProductModal('${p.id}')">수정</button>
                      <button class="btn" style="padding: 6px 12px; font-size: 12px; background: #fee2e2; color: #dc2626;" onclick="deleteProduct('${p.id}')">삭제</button>
                    </div>
                  </td>
                </tr>
              `;}).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- 모바일 카드 리스트 -->
        <div class="product-list-mobile">
          ${myProducts.map(p => {
            const linkedDeals = state.deals.filter(d => {
              if (!d.selectedProducts) return false;
              return d.selectedProducts.some(item => {
                const pid = typeof item === 'string' ? item : item.productId;
                return pid === p.id;
              });
            }).length;
            return `
            <div class="product-card-mobile">
              <div class="product-name-mobile">${p.productName || '-'}</div>
              <div class="product-info-mobile">
                <div class="info-row">
                  <span class="info-label">정가</span>
                  <span class="info-value">${Number(p.originalPrice || 0) > 0 ? formatNumber(p.originalPrice) + '원' : '-'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">공구가</span>
                  <span class="info-value">${Number(p.salePrice || 0) > 0 ? formatNumber(p.salePrice) + '원' : '-'}</span>
                </div>
                <div class="info-row highlight">
                  <span class="info-label">공급가(V+)</span>
                  <span class="info-value primary">${Number(p.supplyPrice || 0) > 0 ? formatNumber(p.supplyPrice) + '원' : '-'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">수수료</span>
                  <span class="info-value">${p.commission ? p.commission + '%' : '-'}</span>
                </div>
                ${linkedDeals > 0 ? `<div class="info-row"><span class="info-label">공구연결</span><span class="info-value"><span class="deal-count">${linkedDeals}건</span></span></div>` : ''}
              </div>
              <div class="product-actions-mobile">
                <button class="btn btn-secondary" onclick="openProductModal('${p.id}')">수정</button>
                <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">삭제</button>
              </div>
            </div>
          `;}).join('')}
        </div>
      `}
    </div>
  `;
}

// 상품 검색 핸들러
function handleProductSearch(keyword) {
  state.productSearchKeyword = keyword.trim();
  renderPage('products');
}

function clearProductSearch() {
  state.productSearchKeyword = '';
  renderPage('products');
}

function openProductModal(productId) {
  const product = productId ? state.supplierProducts.find(p => p.id === productId) : null;
  const isEdit = !!product;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">${isEdit ? '상품 수정' : '상품 등록'}</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form onsubmit="saveProduct(event, '${productId || ''}')">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">상품명 *</label>
            <input type="text" class="form-input" id="prod-name" value="${product?.productName || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">정가 (원)</label>
            <input type="number" class="form-input" id="prod-original" value="${product?.originalPrice || ''}">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">공급가 (V+, 원)</label>
              <input type="number" class="form-input" id="prod-supply" value="${product?.supplyPrice || ''}" oninput="calcCommissionFromSupply()">
              <small style="color: var(--gray-500); font-size: 11px;">수수료와 둘 중 하나만 입력</small>
            </div>
            <div class="form-group">
              <label class="form-label">수수료 (%)</label>
              <input type="number" class="form-input" id="prod-commission" value="${product?.commission || ''}" step="0.1" oninput="calcSupplyFromCommission()">
              <small style="color: var(--gray-500); font-size: 11px;">공급가와 둘 중 하나만 입력</small>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">공동구매 판매가 (원)</label>
            <input type="number" class="form-input" id="prod-sale" value="${product?.salePrice || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">상품 설명</label>
            <textarea class="form-textarea" id="prod-desc" rows="3">${product?.description || ''}</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button type="submit" class="btn btn-primary" style="width: auto;">${isEdit ? '수정' : '등록'}</button>
        </div>
      </form>
    </div>
  `;
}

// 공급가 → 수수료 자동계산
function calcCommissionFromSupply() {
  const supply = Number(document.getElementById('prod-supply').value);
  const sale = Number(document.getElementById('prod-sale').value);
  if (supply && sale && sale > 0) {
    const commission = ((sale - supply) / sale * 100).toFixed(1);
    document.getElementById('prod-commission').value = commission;
  }
}

// 수수료 → 공급가 자동계산
function calcSupplyFromCommission() {
  const commission = Number(document.getElementById('prod-commission').value);
  const sale = Number(document.getElementById('prod-sale').value);
  if (commission && sale && sale > 0) {
    const supply = Math.round(sale * (1 - commission / 100));
    document.getElementById('prod-supply').value = supply;
  }
}

// 엑셀 일괄 업로드 모달
function openExcelUploadModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">📥 엑셀 일괄등록</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div class="modal-body">
        <div style="background: var(--info-light); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="color: var(--info); margin-bottom: 8px;">📋 엑셀 양식 안내</h4>
          <p style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px;">
            아래 열 순서대로 데이터를 입력해주세요.<br>
            <strong>첫 번째 행은 헤더로 인식되어 제외됩니다.</strong>
          </p>
          <table style="width: 100%; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
              <tr style="background: var(--gray-100);">
                <th style="padding: 8px; text-align: left;">A</th>
                <th style="padding: 8px; text-align: left;">B</th>
                <th style="padding: 8px; text-align: left;">C</th>
                <th style="padding: 8px; text-align: left;">D</th>
                <th style="padding: 8px; text-align: left;">E</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 8px;">상품명*</td>
                <td style="padding: 8px;">정가</td>
                <td style="padding: 8px;">공급가(V+)</td>
                <td style="padding: 8px;">공구판매가</td>
                <td style="padding: 8px;">수수료(%)</td>
              </tr>
            </tbody>
          </table>
          <p style="font-size: 11px; color: var(--gray-500); margin-top: 8px;">
            * 공급가와 수수료는 둘 중 하나만 입력하면 자동 계산됩니다.
          </p>
        </div>
        
        <div style="margin-bottom: 16px;">
          <button class="btn btn-secondary" style="width: 100%;" onclick="downloadExcelTemplate()">
            📥 엑셀 양식 다운로드
          </button>
        </div>
        
        <div class="form-group">
          <label class="form-label">엑셀 파일 선택</label>
          <input type="file" class="form-input" id="excel-file" accept=".xlsx,.xls,.csv" style="padding: 12px;">
        </div>
        
        <div id="excel-preview" style="display: none; margin-top: 16px;">
          <h4 style="margin-bottom: 12px;">미리보기</h4>
          <div id="excel-preview-content" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
        <button type="button" class="btn btn-primary" style="width: auto;" onclick="uploadExcelProducts()">일괄 등록</button>
      </div>
    </div>
  `;
  
  // 파일 선택 시 미리보기
  document.getElementById('excel-file').addEventListener('change', previewExcel);
}

// 엑셀 양식 다운로드
function downloadExcelTemplate() {
  const csvContent = "상품명,정가,공급가(V+),공구판매가,수수료(%)\n예시상품,50000,35000,40000,12.5";
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = '상품등록_양식.csv';
  link.click();
}

// 엑셀 미리보기
async function previewExcel(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const preview = document.getElementById('excel-preview');
  const content = document.getElementById('excel-preview-content');
  
  try {
    const data = await parseExcelFile(file);
    if (data.length === 0) {
      content.innerHTML = '<p style="color: var(--danger);">데이터가 없습니다.</p>';
      preview.style.display = 'block';
      return;
    }
    
    // 헤더 제외
    const rows = data.slice(1);
    window.excelData = rows;
    
    content.innerHTML = `
      <p style="margin-bottom: 8px; color: var(--success);">✓ ${rows.length}개 상품 확인됨</p>
      <table class="data-table" style="font-size: 12px;">
        <thead>
          <tr>
            <th>상품명</th>
            <th>정가</th>
            <th>공급가</th>
            <th>판매가</th>
            <th>수수료</th>
          </tr>
        </thead>
        <tbody>
          ${rows.slice(0, 5).map(row => `
            <tr>
              <td>${row[0] || '-'}</td>
              <td>${row[1] ? formatNumber(row[1]) + '원' : '-'}</td>
              <td>${row[2] ? formatNumber(row[2]) + '원' : '-'}</td>
              <td>${row[3] ? formatNumber(row[3]) + '원' : '-'}</td>
              <td>${row[4] ? row[4] + '%' : '-'}</td>
            </tr>
          `).join('')}
          ${rows.length > 5 ? `<tr><td colspan="5" style="text-align:center; color: var(--gray-500);">... 외 ${rows.length - 5}개</td></tr>` : ''}
        </tbody>
      </table>
    `;
    preview.style.display = 'block';
  } catch (err) {
    content.innerHTML = `<p style="color: var(--danger);">파일 읽기 실패: ${err.message}</p>`;
    preview.style.display = 'block';
  }
}

// 엑셀 파일 파싱
function parseExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = e.target.result;
        if (file.name.endsWith('.csv')) {
          // CSV 파싱
          const rows = data.split('\n').map(row => row.split(',').map(cell => cell.trim().replace(/^"|"$/g, '')));
          resolve(rows.filter(row => row.some(cell => cell)));
        } else {
          // XLSX 파싱 (SheetJS 사용)
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          resolve(rows);
        }
      } catch (err) {
        reject(err);
      }
    };
    reader.onerror = () => reject(new Error('파일 읽기 실패'));
    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsBinaryString(file);
    }
  });
}

// 엑셀 일괄 업로드
async function uploadExcelProducts() {
  if (!window.excelData || window.excelData.length === 0) {
    showToast('업로드할 데이터가 없습니다.');
    return;
  }
  
  try {
    const batch = db.batch();
    let count = 0;
    
    for (const row of window.excelData) {
      const productName = row[0];
      if (!productName) continue;
      
      const originalPrice = Number(row[1]) || 0;
      const supplyPrice = Number(row[2]) || 0;
      const salePrice = Number(row[3]) || 0;
      let commission = Number(row[4]) || 0;
      
      // 공급가만 있고 수수료가 없으면 자동계산
      if (supplyPrice && !commission && salePrice) {
        commission = parseFloat(((salePrice - supplyPrice) / salePrice * 100).toFixed(1));
      }
      
      // 수수료만 있고 공급가가 없으면 자동계산
      let finalSupplyPrice = supplyPrice;
      if (!supplyPrice && commission && salePrice) {
        finalSupplyPrice = Math.round(salePrice * (1 - commission / 100));
      }
      
      const docRef = db.collection('supplierProducts').doc();
      batch.set(docRef, {
        supplierId: state.currentUser.id,
        brandName: state.currentUser.name,
        productName,
        originalPrice,
        supplyPrice: finalSupplyPrice,
        salePrice,
        commission,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
      count++;
    }
    
    await batch.commit();
    showToast(`${count}개 상품이 등록되었습니다.`);
    closeModal();
    window.excelData = null;
  } catch (err) {
    console.error(err);
    showToast('등록에 실패했습니다.');
  }
}

async function saveProduct(e, productId) {
  e.preventDefault();
  
  const data = {
    supplierId: state.currentUser.id,
    brandName: state.currentUser.name,
    productName: document.getElementById('prod-name').value,
    originalPrice: Number(document.getElementById('prod-original').value) || 0,
    supplyPrice: Number(document.getElementById('prod-supply').value) || 0,
    salePrice: Number(document.getElementById('prod-sale').value) || 0,
    commission: Number(document.getElementById('prod-commission').value) || 0,
    description: document.getElementById('prod-desc').value,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (productId) {
      await db.collection('supplierProducts').doc(productId).update(data);
      showToast('상품이 수정되었습니다.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('supplierProducts').add(data);
      showToast('상품이 등록되었습니다.');
    }
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('저장에 실패했습니다.');
  }
}

// 상품 삭제
async function deleteProduct(productId) {
  if (!confirm('이 상품을 삭제하시겠습니까?')) return;
  
  try {
    await db.collection('supplierProducts').doc(productId).delete();
    showToast('상품이 삭제되었습니다.');
  } catch (e) {
    console.error(e);
    showToast('삭제에 실패했습니다.');
  }
}

// ===== 긴급판매요청 (공급사 전용) =====
function renderUrgentSales(container) {
  // 내 긴급판매요청 목록
  const myUrgentSales = (state.urgentSales || []).filter(u => 
    u.supplierId === state.currentUser.id || 
    (u.brandName && state.currentUser.name && u.brandName.includes(state.currentUser.name))
  ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  container.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h1 class="page-title" style="margin-bottom: 8px;">긴급판매요청</h1>
      <p class="page-desc" style="font-size: 14px; line-height: 1.6;">빨리 판매가 필요한 상품을 등록해주세요.</p>
    </div>
    
    <!-- 요청등록 버튼 (눈에 띄게) -->
    <div style="margin-bottom: 20px;">
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; border-radius: 12px;" onclick="openUrgentSalesModal()">
        + 요청등록
      </button>
    </div>
    
    <div class="card">
      <h3 class="card-title" style="margin-bottom: 16px;">등록된 요청 (${myUrgentSales.length}건)</h3>
      ${myUrgentSales.length === 0 ? `
        <div class="empty-state" style="padding: 40px 20px;">
          <div class="icon" style="font-size: 48px; margin-bottom: 12px;">🚨</div>
          <p style="font-size: 14px; line-height: 1.6;">등록된 긴급판매요청이 없습니다.<br>신상품 홍보나 재고 처리가 필요하시면<br>등록해주세요!</p>
        </div>
      ` : `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          ${myUrgentSales.map(u => `
            <div style="padding: 16px; background: ${u.status === 'completed' ? 'var(--gray-50)' : u.urgencyLevel === 'high' ? '#fef2f2' : u.urgencyLevel === 'medium' ? '#fffbeb' : 'var(--gray-50)'}; border-radius: 12px; border-left: 4px solid ${u.status === 'completed' ? 'var(--gray-300)' : u.urgencyLevel === 'high' ? '#dc2626' : u.urgencyLevel === 'medium' ? '#f59e0b' : 'var(--gray-400)'};">
              <!-- 상단: 상품명 + 상태 -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 700; font-size: 16px; color: var(--gray-800); margin-bottom: 4px; word-break: break-word;">${u.productName}</div>
                  <span style="display: inline-block; font-size: 12px; padding: 3px 10px; border-radius: 12px; background: ${u.type === 'new' ? '#dbeafe' : '#fef3c7'}; color: ${u.type === 'new' ? '#1d4ed8' : '#b45309'};">${u.type === 'new' ? '신상품' : '재고처리'}</span>
                </div>
                <span style="flex-shrink: 0; font-size: 12px; padding: 6px 12px; border-radius: 12px; background: ${u.status === 'completed' ? 'var(--gray-200)' : u.status === 'processing' ? '#dcfce7' : '#fef3c7'}; color: ${u.status === 'completed' ? 'var(--gray-500)' : u.status === 'processing' ? '#166534' : '#b45309'}; font-weight: 500;">
                  ${u.status === 'completed' ? '완료' : u.status === 'processing' ? '진행중' : '대기'}
                </span>
              </div>
              
              <!-- 중간: 수량, 희망일 -->
              <div style="display: flex; gap: 16px; font-size: 14px; color: var(--gray-600); margin-bottom: 12px;">
                <span>수량: <strong>${u.quantity?.toLocaleString() || '-'}개</strong></span>
                ${u.targetDate ? `<span>희망일: <strong>${u.targetDate}</strong></span>` : ''}
              </div>
              
              <!-- 메모 -->
              ${u.memo ? `<div style="font-size: 13px; color: var(--gray-500); background: white; padding: 10px 14px; border-radius: 8px; margin-bottom: 12px; line-height: 1.5;">${u.memo}</div>` : ''}
              
              <!-- 하단: 날짜 + 버튼 -->
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.05);">
                <span style="font-size: 12px; color: var(--gray-400);">${formatDateKR(u.createdAt)}</span>
                ${u.status === 'pending' ? `
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="openUrgentSalesModal('${u.id}')">수정</button>
                    <button class="btn" style="padding: 8px 16px; font-size: 13px; background: #fee2e2; color: #dc2626;" onclick="deleteUrgentSales('${u.id}')">삭제</button>
                  </div>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

function openUrgentSalesModal(urgentId = null) {
  const isEdit = !!urgentId;
  const u = isEdit ? (state.urgentSales || []).find(item => item.id === urgentId) : {};
  
  // 내 상품 목록
  const myProducts = state.supplierProducts.filter(p => {
    if (p.supplierId === state.currentUser.id) return true;
    if (p.brandName && state.currentUser.name && p.brandName.includes(state.currentUser.name)) return true;
    return false;
  });
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">${isEdit ? '긴급판매요청 수정' : '긴급판매요청 등록'}</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form onsubmit="saveUrgentSales(event, '${urgentId || ''}')">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">상품 선택 *</label>
            ${myProducts.length > 0 ? `
              <div style="position: relative;">
                <input type="text" class="form-input" id="urgent-product-search" placeholder="상품명 검색..." 
                  value="${u.productName || ''}" 
                  onfocus="showProductDropdown()" 
                  oninput="filterProductDropdown(this.value)"
                  autocomplete="off" required>
                <input type="hidden" id="urgent-product-id" value="${u.productId || ''}">
                <div id="product-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100;">
                  ${myProducts.map(p => `
                    <div class="product-option" data-name="${p.productName}" onclick="selectProduct('${p.id}', \`${p.productName.replace(/`/g, "'")}\`)" 
                      style="padding: 12px; cursor: pointer; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center;"
                      onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
                      <span>${p.productName}</span>
                      <span style="font-size: 12px; color: var(--primary);">${p.supplyPrice ? formatNumber(p.supplyPrice) + '원' : ''}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" class="btn btn-secondary" style="flex: 1; font-size: 12px; padding: 8px;" onclick="openQuickProductModal()">+ 새 상품 등록</button>
                <button type="button" class="btn" style="flex: 1; font-size: 12px; padding: 8px; background: var(--gray-100); color: var(--gray-600);" onclick="closeModal(); renderPage('products');">상품등록 페이지</button>
              </div>
            ` : `
              <div style="padding: 20px; background: var(--gray-50); border-radius: 8px; text-align: center;">
                <p style="color: var(--gray-500); margin-bottom: 12px;">등록된 상품이 없습니다.</p>
                <button type="button" class="btn btn-primary" onclick="closeModal(); renderPage('products');">상품 등록하러 가기</button>
              </div>
            `}
          </div>
          
          <div class="form-group">
            <label class="form-label">요청 유형 *</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--gray-50); border-radius: 8px; border: 2px solid ${u.type === 'new' ? 'var(--info)' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-type" value="new" ${u.type === 'new' || !u.type ? 'checked' : ''} onchange="this.closest('.form-group').querySelectorAll('label').forEach(l => l.style.borderColor = 'var(--gray-200)'); this.closest('label').style.borderColor = 'var(--info)';">
                <div>
                  <div style="font-weight: 600; color: var(--info);">신상품</div>
                  <div style="font-size: 11px; color: var(--gray-500);">새로 출시된 상품 홍보</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--gray-50); border-radius: 8px; border: 2px solid ${u.type === 'clearance' ? 'var(--warning)' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-type" value="clearance" ${u.type === 'clearance' ? 'checked' : ''} onchange="this.closest('.form-group').querySelectorAll('label').forEach(l => l.style.borderColor = 'var(--gray-200)'); this.closest('label').style.borderColor = 'var(--warning)';">
                <div>
                  <div style="font-weight: 600; color: var(--warning);">재고처리</div>
                  <div style="font-size: 11px; color: var(--gray-500);">재고 소진이 필요한 상품</div>
                </div>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">긴급도 *</label>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
              <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; background: ${u.urgencyLevel === 'high' ? '#fef2f2' : 'var(--gray-50)'}; border-radius: 8px; border: 2px solid ${u.urgencyLevel === 'high' ? '#dc2626' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-level" value="high" ${u.urgencyLevel === 'high' ? 'checked' : ''} style="display: none;">
                <span style="font-size: 12px; font-weight: 600; color: #dc2626;">긴급</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; background: ${u.urgencyLevel === 'medium' || !u.urgencyLevel ? '#fffbeb' : 'var(--gray-50)'}; border-radius: 8px; border: 2px solid ${u.urgencyLevel === 'medium' || !u.urgencyLevel ? '#f59e0b' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-level" value="medium" ${u.urgencyLevel === 'medium' || !u.urgencyLevel ? 'checked' : ''} style="display: none;">
                <span style="font-size: 12px; font-weight: 600; color: #f59e0b;">보통</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; background: ${u.urgencyLevel === 'low' ? 'var(--gray-100)' : 'var(--gray-50)'}; border-radius: 8px; border: 2px solid ${u.urgencyLevel === 'low' ? 'var(--gray-400)' : 'var(--gray-200)'}; cursor: pointer;">
                <input type="radio" name="urgent-level" value="low" ${u.urgencyLevel === 'low' ? 'checked' : ''} style="display: none;">
                <span style="font-size: 12px; font-weight: 600; color: var(--gray-500);">여유</span>
              </label>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">판매 희망 수량</label>
              <input type="number" class="form-input" id="urgent-quantity" placeholder="예: 100" value="${u.quantity || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">희망 판매일</label>
              <input type="date" class="form-input" id="urgent-target-date" value="${u.targetDate || ''}">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">메모</label>
            <textarea class="form-textarea" id="urgent-memo" rows="3" placeholder="추가 요청사항이나 특이사항을 입력해주세요.">${u.memo || ''}</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button type="submit" class="btn btn-primary">${isEdit ? '수정하기' : '등록하기'}</button>
        </div>
      </form>
    </div>
  `;
  
  // 긴급도 라디오 버튼 클릭 이벤트
  document.querySelectorAll('input[name="urgent-level"]').forEach(radio => {
    radio.closest('label').onclick = function() {
      document.querySelectorAll('input[name="urgent-level"]').forEach(r => {
        r.closest('label').style.background = 'var(--gray-50)';
        r.closest('label').style.borderColor = 'var(--gray-200)';
      });
      const val = this.querySelector('input').value;
      this.style.background = val === 'high' ? '#fef2f2' : val === 'medium' ? '#fffbeb' : 'var(--gray-100)';
      this.style.borderColor = val === 'high' ? '#dc2626' : val === 'medium' ? '#f59e0b' : 'var(--gray-400)';
      this.querySelector('input').checked = true;
    };
  });
  
  // 모달 외부 클릭시 드롭다운 닫기
  document.addEventListener('click', closeProductDropdownOnOutsideClick);
}

// 상품 드롭다운 관련 함수들
function showProductDropdown() {
  const dropdown = document.getElementById('product-dropdown');
  if (dropdown) dropdown.style.display = 'block';
}

function filterProductDropdown(keyword) {
  const dropdown = document.getElementById('product-dropdown');
  if (!dropdown) return;
  
  const options = dropdown.querySelectorAll('.product-option');
  options.forEach(opt => {
    const name = opt.getAttribute('data-name') || opt.textContent;
    if (name.toLowerCase().includes(keyword.toLowerCase())) {
      opt.style.display = 'flex';
    } else {
      opt.style.display = 'none';
    }
  });
  dropdown.style.display = 'block';
}

function selectProduct(productId, productName) {
  document.getElementById('urgent-product-search').value = productName;
  document.getElementById('urgent-product-id').value = productId;
  document.getElementById('product-dropdown').style.display = 'none';
}

function closeProductDropdownOnOutsideClick(e) {
  const dropdown = document.getElementById('product-dropdown');
  const input = document.getElementById('urgent-product-search');
  if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
    dropdown.style.display = 'none';
  }
}

// 빠른 상품 등록 모달
function openQuickProductModal() {
  const urgentModal = document.getElementById('modal').innerHTML;
  
  const m = document.getElementById('modal');
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">새 상품 등록</h3>
        <button class="modal-close" onclick="closeQuickProductModal()">×</button>
      </div>
      <form onsubmit="saveQuickProduct(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">상품명 *</label>
            <input type="text" class="form-input" id="quick-product-name" placeholder="상품명을 입력하세요" required>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">정가</label>
              <input type="number" class="form-input" id="quick-original-price" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">공급가(V+)</label>
              <input type="number" class="form-input" id="quick-supply-price" placeholder="0">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">공구판매가</label>
              <input type="number" class="form-input" id="quick-sale-price" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">수수료율(%)</label>
              <input type="number" class="form-input" id="quick-commission" placeholder="20">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeQuickProductModal()">취소</button>
          <button type="submit" class="btn btn-primary">등록 후 선택</button>
        </div>
      </form>
    </div>
  `;
  
  // 원래 모달 내용 저장
  window.savedUrgentModal = urgentModal;
}

function closeQuickProductModal() {
  // 긴급판매요청 모달 다시 열기
  openUrgentSalesModal();
}

async function saveQuickProduct(e) {
  e.preventDefault();
  
  try {
    const productData = {
      supplierId: state.currentUser.id,
      brandName: state.currentUser.name,
      productName: document.getElementById('quick-product-name').value,
      originalPrice: parseInt(document.getElementById('quick-original-price').value) || 0,
      supplyPrice: parseInt(document.getElementById('quick-supply-price').value) || 0,
      salePrice: parseInt(document.getElementById('quick-sale-price').value) || 0,
      commission: parseInt(document.getElementById('quick-commission').value) || 20,
      createdAt: new Date().toISOString()
    };
    
    const docRef = await db.collection('supplierProducts').add(productData);
    showToast('상품이 등록되었습니다.');
    
    // 잠시 후 긴급판매요청 모달 다시 열기
    setTimeout(() => {
      openUrgentSalesModal();
      // 새로 등록한 상품 자동 선택
      setTimeout(() => {
        const searchInput = document.getElementById('urgent-product-search');
        const idInput = document.getElementById('urgent-product-id');
        if (searchInput && idInput) {
          searchInput.value = productData.productName;
          idInput.value = docRef.id;
        }
      }, 100);
    }, 500);
  } catch (e) {
    console.error(e);
    showToast('등록에 실패했습니다.');
  }
}

async function saveUrgentSales(e, urgentId = '') {
  e.preventDefault();
  
  try {
    const productName = document.getElementById('urgent-product-search')?.value || '';
    const productId = document.getElementById('urgent-product-id')?.value || '';
    
    if (!productName) {
      showToast('상품을 선택해주세요.');
      return;
    }
    
    const data = {
      supplierId: state.currentUser.id,
      brandName: state.currentUser.name,
      productId: productId,
      productName: productName,
      type: document.querySelector('input[name="urgent-type"]:checked').value,
      urgencyLevel: document.querySelector('input[name="urgent-level"]:checked').value,
      quantity: parseInt(document.getElementById('urgent-quantity').value) || null,
      targetDate: document.getElementById('urgent-target-date').value || null,
      memo: document.getElementById('urgent-memo').value,
      status: 'pending',
      updatedAt: new Date().toISOString()
    };
    
    if (urgentId) {
      await db.collection('urgentSales').doc(urgentId).update(data);
      showToast('요청이 수정되었습니다.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('urgentSales').add(data);
      showToast('요청이 등록되었습니다.');
    }
    
    // 이벤트 리스너 제거
    document.removeEventListener('click', closeProductDropdownOnOutsideClick);
    
    closeModal();
    renderPage('urgent');
  } catch (e) {
    console.error(e);
    showToast('저장에 실패했습니다.');
  }
}

async function deleteUrgentSales(urgentId) {
  if (!confirm('이 요청을 삭제하시겠습니까?')) return;
  
  try {
    await db.collection('urgentSales').doc(urgentId).delete();
    showToast('요청이 삭제되었습니다.');
    renderPage('urgent');
  } catch (e) {
    console.error(e);
    showToast('삭제에 실패했습니다.');
  }
}

// ===== 정산 =====
function renderSettlement(container) {
  if (state.userType === 'seller') {
    // 셀러용 정산 화면
    renderSellerSettlement(container);
  } else {
    // 공급사용 정산 화면
    renderSupplierSettlement(container);
  }
}

// 셀러 정산 화면
function renderSellerSettlement(container) {
  // 내 정산 데이터 (sellerSettlements에서 필터) - 더 유연한 매칭
  const mySettlements = (state.settlements || []).filter(s => {
    const sellerName = (s.sellerName || '').trim().toLowerCase();
    const currentName = (state.currentUser.name || '').trim().toLowerCase();
    const currentNickname = (state.currentUser.nickname || '').trim().toLowerCase();
    const currentId = state.currentUser.id || '';
    
    // 1. ID로 정확히 매칭 (가장 우선)
    if (s.sellerId && s.sellerId === currentId) return true;
    
    // 2. 이름/닉네임 정확히 일치
    if (sellerName === currentName || sellerName === currentNickname) return true;
    
    // 3. 부분 일치 (공백, 특수문자 무시)
    const cleanSeller = sellerName.replace(/[\s\-\_\(\)\/]/g, '');
    const cleanName = currentName.replace(/[\s\-\_\(\)\/]/g, '');
    const cleanNick = currentNickname.replace(/[\s\-\_\(\)\/]/g, '');
    if (cleanSeller.includes(cleanName) || cleanName.includes(cleanSeller)) return true;
    if (cleanNick && (cleanSeller.includes(cleanNick) || cleanNick.includes(cleanSeller))) return true;
    
    // 4. sellerNickname 필드 체크
    if (s.sellerNickname && s.sellerNickname.toLowerCase() === currentNickname) return true;
    
    return false;
  });
  
  const totalSales = mySettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  const totalMargin = mySettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
  const totalWithholding = mySettlements.reduce((sum, s) => sum + (Number(s.withholdingTax) || 0), 0);
  const totalFinal = mySettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
  const totalQty = mySettlements.reduce((sum, s) => sum + (Number(s.totalQuantity) || 0), 0);
  
  // 셀러명 추출
  const sellerName = state.currentUser.name?.split('/')[0] || state.currentUser.name || '';
  
  container.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h1 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">정산</h1>
      <p style="font-size: 13px; color: var(--gray-500);">정산 현황을 확인하고 내역서를 다운로드하세요</p>
    </div>
    
    <!-- 통계 카드 -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #ffffff, #f8f8f8);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">정산 건수</div>
        <div style="font-size: 20px; font-weight: 700; color: var(--gray-800);">${mySettlements.length}건</div>
      </div>
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #fff8f0, #fff5eb);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(252,150,0,0.1);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">총 판매액</div>
        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${formatNumber(totalSales)}원</div>
      </div>
      <div style="
        padding: 16px;
        background: linear-gradient(145deg, #f0fdf4, #dcfce7);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(34,197,94,0.1);
        text-align: center;
      ">
        <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">총 실지급액</div>
        <div style="font-size: 20px; font-weight: 700; color: #16a34a;">${formatNumber(totalFinal)}원</div>
      </div>
    </div>
    
    <!-- 정산 내역 카드 -->
    <div style="
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      overflow: hidden;
    ">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--gray-100); flex-wrap: wrap; gap: 12px;">
        <h3 style="font-size: 15px; font-weight: 700; color: var(--gray-800); margin: 0;">정산 내역</h3>
        ${mySettlements.length > 0 ? `
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <span id="selectedCount" style="font-size: 12px; color: var(--primary); font-weight: 600;">0건 선택</span>
            <button onclick="downloadSelectedSettlements('excel')" style="
              padding: 8px 14px;
              font-size: 12px;
              font-weight: 600;
              background: var(--gray-100);
              color: var(--gray-600);
              border: 1px solid var(--gray-200);
              border-radius: 8px;
              cursor: pointer;
            ">📊 엑셀</button>
            <button onclick="downloadSelectedSettlements('pdf')" style="
              padding: 8px 14px;
              font-size: 12px;
              font-weight: 600;
              background: linear-gradient(145deg, #fc9600, #e08600);
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
            ">📄 PDF</button>
          </div>
        ` : ''}
      </div>
      
      ${mySettlements.length === 0 ? `
        <div style="padding: 48px 20px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">💰</div>
          <p style="color: var(--gray-500); font-size: 14px;">아직 정산 내역이 없습니다.</p>
        </div>
      ` : `
        <!-- 전체 선택 -->
        <div style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--gray-50); border-bottom: 1px solid var(--gray-100);">
          <input type="checkbox" id="selectAllSettlements" onchange="toggleAllSettlements(this.checked)" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
          <label for="selectAllSettlements" style="font-size: 13px; color: var(--gray-600); cursor: pointer;">전체 선택</label>
        </div>
        
        <!-- 테이블 (경영팀 정산서 양식) -->
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); width: 40px;"></th>
                <th style="padding: 12px 8px; text-align: left; font-size: 12px; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">브랜드</th>
                <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">공구기간</th>
                <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">수량</th>
                <th style="padding: 12px 8px; text-align: right; font-size: 12px; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">판매금액</th>
                <th style="padding: 12px 8px; text-align: right; font-size: 12px; color: var(--primary); border-bottom: 2px solid var(--gray-200);">마진금액</th>
                <th style="padding: 12px 8px; text-align: right; font-size: 12px; color: #dc2626; border-bottom: 2px solid var(--gray-200);">원천세</th>
                <th style="padding: 12px 8px; text-align: right; font-size: 12px; color: #16a34a; border-bottom: 2px solid var(--gray-200);">실지급액</th>
                <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">정산일</th>
              </tr>
            </thead>
            <tbody>
              ${mySettlements.map((s, idx) => `
                <tr style="border-bottom: 1px solid var(--gray-100);">
                  <td style="padding: 14px 8px; text-align: center;">
                    <input type="checkbox" class="settlement-checkbox" data-idx="${idx}" onchange="updateSelectedCount()" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary);">
                  </td>
                  <td style="padding: 14px 8px;">
                    <div style="font-weight: 600; color: var(--gray-800);">${s.brandName || '-'}</div>
                  </td>
                  <td style="padding: 14px 8px; text-align: center; font-size: 13px; color: var(--gray-600);">${s.dealPeriod || '-'}</td>
                  <td style="padding: 14px 8px; text-align: center; font-weight: 600;">${formatNumber(s.totalQuantity || 0)}</td>
                  <td style="padding: 14px 8px; text-align: right; font-weight: 600;">${formatNumber(s.salesAmount || 0)}원</td>
                  <td style="padding: 14px 8px; text-align: right; color: var(--primary); font-weight: 600;">${formatNumber(s.marginAmount || 0)}원</td>
                  <td style="padding: 14px 8px; text-align: right; color: #dc2626; font-size: 13px;">${formatNumber(s.withholdingTax || 0)}원</td>
                  <td style="padding: 14px 8px; text-align: right; color: #16a34a; font-weight: 700;">${formatNumber(s.actualPayment || 0)}원</td>
                  <td style="padding: 14px 8px; text-align: center; font-size: 12px; color: var(--gray-500);">${s.settlementDate || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr style="background: linear-gradient(145deg, #f0fdf4, #dcfce7);">
                <td colspan="3" style="padding: 14px 8px; font-size: 14px; font-weight: 700; text-align: right;">합계</td>
                <td style="padding: 14px 8px; text-align: center; font-weight: 700;">${formatNumber(totalQty)}</td>
                <td style="padding: 14px 8px; text-align: right; font-weight: 700;">${formatNumber(totalSales)}원</td>
                <td style="padding: 14px 8px; text-align: right; font-weight: 700; color: var(--primary);">${formatNumber(totalMargin)}원</td>
                <td style="padding: 14px 8px; text-align: right; font-weight: 700; color: #dc2626;">${formatNumber(totalWithholding)}원</td>
                <td style="padding: 14px 8px; text-align: right; font-weight: 700; font-size: 15px; color: #16a34a;">${formatNumber(totalFinal)}원</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <!-- 안내 문구 -->
        <div style="padding: 12px 20px; background: var(--gray-50); border-top: 1px solid var(--gray-100);">
          <p style="font-size: 11px; color: var(--gray-500); margin: 0;">
            💡 녹색 배경: 셀러 정산 항목 | 문의사항은 모여라딜 담당자에게 연락해주세요.
          </p>
        </div>
      `}
    </div>
  `;
}

// 정산 카드 토글 (체크박스)
function toggleSettlementCard(card, idx) {
  const checkbox = card.querySelector('.settlement-checkbox');
  checkbox.checked = !checkbox.checked;
  updateSelectedCount();
}

// 전체 선택 토글
function toggleAllSettlements(checked) {
  document.querySelectorAll('.settlement-checkbox').forEach(cb => {
    cb.checked = checked;
  });
  updateSelectedCount();
}

// 선택 개수 업데이트
function updateSelectedCount() {
  const checkboxes = document.querySelectorAll('.settlement-checkbox');
  const checked = document.querySelectorAll('.settlement-checkbox:checked');
  
  const countEl = document.getElementById('selectedCount');
  if (countEl) {
    countEl.textContent = `${checked.length}건 선택`;
  }
  
  const selectAll = document.getElementById('selectAllSettlements');
  if (selectAll) {
    selectAll.checked = checkboxes.length > 0 && checkboxes.length === checked.length;
  }
}

// 선택된 정산 다운로드
function downloadSelectedSettlements(type) {
  const mySettlements = (state.settlements || []).filter(s => {
    const sellerName = s.sellerName || '';
    return sellerName.includes(state.currentUser.name) || sellerName.includes(state.currentUser.nickname);
  });
  
  const checkedIdxs = [];
  document.querySelectorAll('.settlement-checkbox:checked').forEach(cb => {
    checkedIdxs.push(parseInt(cb.dataset.idx));
  });
  
  if (checkedIdxs.length === 0) {
    showToast('다운로드할 정산 내역을 선택해주세요.');
    return;
  }
  
  const selectedSettlements = checkedIdxs.map(idx => mySettlements[idx]).filter(Boolean);
  
  if (type === 'excel') {
    downloadSelectedExcel(selectedSettlements);
  } else {
    downloadSelectedPDF(selectedSettlements);
  }
}

// 선택된 정산 엑셀 다운로드
function downloadSelectedExcel(settlements) {
  let csvContent = '\uFEFF';
  csvContent += '브랜드(공급사),공구기간,판매상품,단가,수량,판매금액,마진금액,원천세,소계,총실지급액,정산일\n';
  
  settlements.forEach(s => {
    csvContent += `"${s.brandName || '-'}","${s.dealPeriod || '-'}","${s.productName || '-'}","${s.unitPrice || 0}","${s.quantity || 0}","${s.salesAmount || 0}","${s.marginAmount || 0}","${s.withholdingTax || 0}","${s.subtotal || 0}","${s.actualPayment || s.finalAmount || 0}","${s.settlementDate || '-'}"\n`;
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  const sellerName = state.currentUser.name?.split('/')[0] || state.currentUser.name || '셀러';
  link.download = `정산내역_${sellerName}_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
  showToast(`${settlements.length}건의 정산 내역이 다운로드되었습니다.`);
}

// 선택된 정산 PDF 다운로드
function downloadSelectedPDF(settlements) {
  const totalSales = settlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  const totalMargin = settlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
  const totalFinal = settlements.reduce((sum, s) => sum + (Number(s.actualPayment) || Number(s.finalAmount) || 0), 0);
  const sellerName = state.currentUser.name?.split('/')[0] || state.currentUser.name || '셀러';
  
  let tableRows = settlements.map(s => `
    <tr>
      <td>${s.brandName || '-'}</td>
      <td>${s.dealPeriod || '-'}</td>
      <td>${s.productName || '-'}</td>
      <td style="text-align:right;">${formatNumber(s.unitPrice || 0)}원</td>
      <td style="text-align:right;">${formatNumber(s.quantity || 0)}</td>
      <td style="text-align:right;">${formatNumber(s.salesAmount || 0)}원</td>
      <td style="text-align:right;color:#fc9600;">${formatNumber(s.marginAmount || 0)}원</td>
      <td style="text-align:right;color:#dc2626;">${formatNumber(s.withholdingTax || 0)}원</td>
      <td style="text-align:right;">${formatNumber(s.subtotal || 0)}원</td>
      <td style="text-align:right;font-weight:bold;color:#16a34a;">${formatNumber(s.actualPayment || s.finalAmount || 0)}원</td>
      <td>${s.settlementDate || '-'}</td>
    </tr>
  `).join('');
  
  const pdfHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>정산서 - ${sellerName}</title>
      <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 30px; font-size: 12px; }
        h1 { color: #fc9600; border-bottom: 3px solid #fc9600; padding-bottom: 10px; font-size: 24px; }
        .info { margin: 20px 0; }
        .info p { margin: 5px 0; }
        .summary { display: flex; gap: 20px; margin: 20px 0; }
        .summary-item { background: #fff8f0; padding: 15px 20px; border-radius: 8px; }
        .summary-item .label { font-size: 11px; color: #666; }
        .summary-item .value { font-size: 18px; font-weight: bold; }
        .total-amount { color: #16a34a; font-size: 22px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 6px 4px; }
        th { background: #fff8f0; font-weight: 600; }
        tfoot td { background: #fffbeb; font-weight: bold; }
        .footer { margin-top: 30px; font-size: 10px; color: #888; text-align: center; padding-top: 20px; border-top: 1px solid #eee; }
      </style>
    </head>
    <body>
      <h1>📋 정산서</h1>
      <div class="info">
        <p><strong>셀러:</strong> ${sellerName}</p>
        <p><strong>발행일:</strong> ${new Date().toLocaleDateString('ko-KR')}</p>
        <p><strong>정산 건수:</strong> ${settlements.length}건</p>
      </div>
      <div class="summary">
        <div class="summary-item">
          <div class="label">총 판매금액</div>
          <div class="value">${formatNumber(totalSales)}원</div>
        </div>
        <div class="summary-item">
          <div class="label">총 마진금액</div>
          <div class="value" style="color:#fc9600;">${formatNumber(totalMargin)}원</div>
        </div>
        <div class="summary-item">
          <div class="label">총 정산금액</div>
          <div class="value total-amount">${formatNumber(totalFinal)}원</div>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>브랜드</th>
            <th>공구기간</th>
            <th>판매상품</th>
            <th>단가</th>
            <th>수량</th>
            <th>판매금액</th>
            <th>마진금액</th>
            <th>원천세</th>
            <th>소계</th>
            <th>총실지급액</th>
            <th>정산일</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
        <tfoot>
          <tr>
            <td colspan="5" style="text-align:right;">합계</td>
            <td style="text-align:right;">${formatNumber(totalSales)}원</td>
            <td style="text-align:right;color:#fc9600;">${formatNumber(totalMargin)}원</td>
            <td style="text-align:right;color:#dc2626;">${formatNumber(settlements.reduce((sum, s) => sum + (Number(s.withholdingTax) || 0), 0))}원</td>
            <td style="text-align:right;">${formatNumber(settlements.reduce((sum, s) => sum + (Number(s.subtotal) || 0), 0))}원</td>
            <td style="text-align:right;color:#16a34a;">${formatNumber(totalFinal)}원</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div class="footer">
        <p>모여라딜 파트너 포털에서 발행된 정산서입니다.</p>
        <p>문의: 모여라딜 운영팀</p>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pdfHtml);
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
  }, 500);
  showToast(`${settlements.length}건의 정산서 인쇄 화면이 열렸습니다.`);
}


// 공급사 정산 화면 (어드민 매출관리 타사상품 형식과 동일)
function renderSupplierSettlement(container) {
  // 내 브랜드에 대한 supplierSettlements 가져오기 - 더 유연한 매칭
  const mySupplierSettlements = (state.supplierSettlements || []).filter(s => {
    const brandName = (s.brandName || '').trim().toLowerCase();
    const currentName = (state.currentUser.name || '').trim().toLowerCase();
    const currentId = state.currentUser.id || '';
    
    // 1. ID로 정확히 매칭 (가장 우선)
    if (s.supplierId && s.supplierId === currentId) return true;
    
    // 2. 이름 정확히 일치
    if (brandName === currentName) return true;
    
    // 3. 부분 일치 (공백, 특수문자 무시)
    const cleanBrand = brandName.replace(/[\s\-\_\(\)]/g, '');
    const cleanCurrent = currentName.replace(/[\s\-\_\(\)]/g, '');
    if (cleanBrand.includes(cleanCurrent) || cleanCurrent.includes(cleanBrand)) return true;
    
    return false;
  });
  
  // 각 정산에 items가 없으면 sellerSettlements에서 매칭
  const enrichedSettlements = mySupplierSettlements.map(sup => {
    let items = sup.items || [];
    
    // items가 없으면 sellerSettlements에서 찾기
    if (items.length === 0) {
      const matchingSeller = (state.sellerSettlements || []).find(ss => 
        ((ss.sellerName || '').includes(sup.sellerName || '') || (sup.sellerName || '').includes(ss.sellerName || '')) &&
        ((ss.brandName || '').includes(sup.brandName || '') || (sup.brandName || '').includes(ss.brandName || ''))
      );
      if (matchingSeller) {
        items = matchingSeller.salesItems || matchingSeller.items || [];
      }
    }
    
    return {
      ...sup,
      items
    };
  });
  
  // 공급사 정산 금액 합계 계산
  const totalSupplyAmount = enrichedSettlements.reduce((sum, s) => sum + (Number(s.totalSupplyAmount) || 0), 0);
  const totalVat = enrichedSettlements.reduce((sum, s) => sum + (Number(s.totalVatAmount) || 0), 0);
  const totalFinal = enrichedSettlements.reduce((sum, s) => sum + (Number(s.totalAmount) || 0), 0);
  const totalSales = enrichedSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  
  // 정산 데이터를 전역에 저장 (선택 다운로드용)
  window.supplierEnrichedSettlements = enrichedSettlements;
  
  // 테이블 행 생성 (어드민과 동일한 형식)
  let tableRows = '';
  enrichedSettlements.forEach((s, sIdx) => {
    const items = s.items || [];
    const sellerName = s.sellerName || '-';
    const sellerParts = sellerName.split('/');
    const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
    
    const supplyAmount = Number(s.totalSupplyAmount) || 0;
    const vatAmount = Number(s.totalVatAmount) || 0;
    const finalAmount = Number(s.totalAmount) || 0;
    
    if (items.length === 0) {
      // 품목 정보 없는 경우
      tableRows += '<tr data-settlement-idx="' + sIdx + '">' +
        '<td style="text-align: center; vertical-align: middle;"><input type="checkbox" class="supplier-settlement-checkbox" data-idx="' + sIdx + '" onclick="updateSupplierSelectedCount()" style="width: 16px; height: 16px; cursor: pointer;"></td>' +
        '<td style="text-align: center;"><strong>' + sellerDisplay + '</strong></td>' +
        '<td style="text-align: center; font-size: 11px;">' + (s.dealPeriod || '-') + '</td>' +
        '<td style="text-align: center; color: var(--gray-400);">(상품정보없음)</td>' +
        '<td style="text-align: center;">-</td>' +
        '<td style="text-align: center;">' + (s.totalQuantity || '-') + '</td>' +
        '<td style="text-align: right;">' + formatNumber(s.salesAmount || 0) + '원</td>' +
        '<td style="text-align: right; background: #fffbeb;">' + formatNumber(supplyAmount) + '원</td>' +
        '<td style="text-align: right; background: #fffbeb;">' + formatNumber(vatAmount) + '원</td>' +
        '<td style="text-align: right; background: var(--primary-light); font-weight: 700; color: var(--primary);">' + formatNumber(finalAmount) + '원</td>' +
        '<td style="text-align: center;">' + (s.settlementDate || '-') + '</td>' +
        '</tr>';
    } else {
      // 품목별 상세 표시
      const rowspan = items.length;
      items.forEach((item, idx) => {
        const isFirst = idx === 0;
        const qty = Number(item.quantity) || 0;
        const unitPrice = Number(item.unitPrice) || Number(item.salePrice) || Number(item.supplyPrice) || 0;
        const itemSalesAmount = Number(item.amount) || (unitPrice * qty);
        
        // 공급사 정산 계산 (품목별)
        const supplyPrice = Number(item.supplyPrice) || unitPrice;
        const itemSupplyAmount = Math.round(supplyPrice * qty / 1.1);
        const itemVatAmount = Math.round(itemSupplyAmount * 0.1);
        
        tableRows += '<tr data-settlement-idx="' + sIdx + '">' +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: center; vertical-align: middle;"><input type="checkbox" class="supplier-settlement-checkbox" data-idx="' + sIdx + '" onclick="updateSupplierSelectedCount()" style="width: 16px; height: 16px; cursor: pointer;"></td>' : '') +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: center; vertical-align: middle;"><strong>' + sellerDisplay + '</strong></td>' : '') +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: center; vertical-align: middle; font-size: 11px;">' + (s.dealPeriod || '-') + '</td>' : '') +
          '<td style="font-size: 11px;">' + (item.productName || '-') + '</td>' +
          '<td style="text-align: right;">' + formatNumber(unitPrice) + '원</td>' +
          '<td style="text-align: center;">' + qty + '</td>' +
          '<td style="text-align: right;">' + formatNumber(itemSalesAmount) + '원</td>' +
          '<td style="text-align: right; background: #fffbeb;">' + formatNumber(itemSupplyAmount) + '원</td>' +
          '<td style="text-align: right; background: #fffbeb;">' + formatNumber(itemVatAmount) + '원</td>' +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: right; vertical-align: middle; background: var(--primary-light); font-weight: 700; color: var(--primary);">' + formatNumber(finalAmount) + '원</td>' : '') +
          (isFirst ? '<td rowspan="' + rowspan + '" style="text-align: center; vertical-align: middle;">' + (s.settlementDate || '-') + '</td>' : '') +
          '</tr>';
      });
    }
  });
  
  container.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h1 class="page-title">정산</h1>
      <p class="page-desc">정산 현황을 확인하고 내역서를 다운로드하세요</p>
    </div>
    
    <div class="settlement-summary">
      <div class="settlement-item">
        <div class="settlement-label">정산 건수</div>
        <div class="settlement-value">${enrichedSettlements.length}건</div>
      </div>
      <div class="settlement-item highlight">
        <div class="settlement-label">총 판매액</div>
        <div class="settlement-value" style="color: var(--primary);">${formatNumber(totalSales)}원</div>
      </div>
      <div class="settlement-item highlight">
        <div class="settlement-label">총 정산금액 (V+)</div>
        <div class="settlement-value" style="color: var(--primary);">${formatNumber(totalFinal)}원</div>
      </div>
    </div>
    
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
        <h3 class="card-title" style="margin: 0;">정산 내역</h3>
        ${enrichedSettlements.length > 0 ? `
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <span id="supplierSelectedCount" style="font-size: 13px; color: var(--primary); font-weight: 600;">0건 선택</span>
            <button class="btn action-btn-secondary" onclick="downloadSupplierSelectedSettlements('excel')">엑셀 다운로드</button>
            <button class="btn action-btn-primary" onclick="downloadSupplierSelectedSettlements('pdf')">PDF 다운로드</button>
          </div>
        ` : ''}
      </div>
      
      ${enrichedSettlements.length === 0 ? `
        <div class="empty-state">
          <div class="icon">💰</div>
          <p>아직 정산 내역이 없습니다.</p>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table" style="font-size: 12px;">
            <thead>
              <tr style="background: linear-gradient(90deg, #fff8f0 0%, #fef9c3 100%);">
                <th style="text-align: center; white-space: nowrap; width: 40px;">
                  <input type="checkbox" id="selectAllSupplierSettlements" onchange="toggleAllSupplierSettlements(this.checked)" style="width: 16px; height: 16px; cursor: pointer;">
                </th>
                <th style="text-align: center; white-space: nowrap;">셀러</th>
                <th style="text-align: center; white-space: nowrap;">공구기간</th>
                <th style="text-align: center; white-space: nowrap;">판매상품</th>
                <th style="text-align: center; white-space: nowrap;">단가</th>
                <th style="text-align: center; white-space: nowrap;">수량</th>
                <th style="text-align: center; white-space: nowrap;">판매금액</th>
                <th style="text-align: center; white-space: nowrap; background: #fef9c3;">공급가액</th>
                <th style="text-align: center; white-space: nowrap; background: #fef9c3;">부가세(10%)</th>
                <th style="text-align: center; white-space: nowrap; background: var(--primary-light); font-weight: 700;">정산금액(V+)</th>
                <th style="text-align: center; white-space: nowrap;">정산일</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
            <tfoot>
              <tr style="background: var(--gray-100); font-weight: 700;">
                <td></td>
                <td colspan="5" style="text-align: center;">합계</td>
                <td style="text-align: right;">${formatNumber(totalSales)}원</td>
                <td style="text-align: right; background: #fef9c3;">${formatNumber(totalSupplyAmount)}원</td>
                <td style="text-align: right; background: #fef9c3;">${formatNumber(totalVat)}원</td>
                <td style="text-align: right; background: var(--primary-light); color: var(--primary);">${formatNumber(totalFinal)}원</td>
                <td>-</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
          💡 <span style="color: var(--primary);">노란색 영역</span>: 공급사 정산 항목
        </div>
      `}
    </div>
  `;
}

// 공급사 정산 전체 선택 토글
function toggleAllSupplierSettlements(checked) {
  document.querySelectorAll('.supplier-settlement-checkbox').forEach(cb => {
    cb.checked = checked;
  });
  updateSupplierSelectedCount();
}

// 공급사 정산 선택 개수 업데이트
function updateSupplierSelectedCount() {
  const checkboxes = document.querySelectorAll('.supplier-settlement-checkbox');
  const checked = document.querySelectorAll('.supplier-settlement-checkbox:checked');
  
  const countEl = document.getElementById('supplierSelectedCount');
  if (countEl) {
    countEl.textContent = `${checked.length}건 선택`;
  }
  
  const selectAll = document.getElementById('selectAllSupplierSettlements');
  if (selectAll) {
    selectAll.checked = checkboxes.length > 0 && checkboxes.length === checked.length;
  }
}

// 공급사 선택된 정산 다운로드
function downloadSupplierSelectedSettlements(type) {
  const enrichedSettlements = window.supplierEnrichedSettlements || [];
  
  const checkedIdxs = [];
  document.querySelectorAll('.supplier-settlement-checkbox:checked').forEach(cb => {
    checkedIdxs.push(parseInt(cb.dataset.idx));
  });
  
  if (checkedIdxs.length === 0) {
    showToast('다운로드할 정산 내역을 선택해주세요.');
    return;
  }
  
  const selectedSettlements = checkedIdxs.map(idx => enrichedSettlements[idx]).filter(Boolean);
  
  if (type === 'excel') {
    downloadSupplierSelectedExcel(selectedSettlements);
  } else {
    downloadSupplierSelectedPDF(selectedSettlements);
  }
}

// 공급사 선택된 정산 엑셀 다운로드
function downloadSupplierSelectedExcel(settlements) {
  let csvContent = '\uFEFF';
  csvContent += '셀러,공구기간,판매상품,수량,판매금액,공급가액,부가세,정산금액,정산일\n';
  
  settlements.forEach(s => {
    const products = s.products || [];
    const sellerName = s.sellerName || '-';
    const sellerParts = sellerName.split('/');
    const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
    
    if (products.length === 0) {
      csvContent += `"${sellerDisplay}","${s.dealPeriod || '-'}","-","-","${s.salesAmount || 0}","${s.supplierSupplyAmount || 0}","${s.supplierVatAmount || 0}","${s.supplierTotalAmount || 0}","${s.settlementDate || '-'}"\n`;
    } else {
      products.forEach((p, idx) => {
        csvContent += `"${idx === 0 ? sellerDisplay : ''}","${idx === 0 ? s.dealPeriod || '-' : ''}","${p.productName || '-'}","${p.quantity || 0}","${idx === 0 ? s.salesAmount || 0 : ''}","${idx === 0 ? s.supplierSupplyAmount || 0 : ''}","${idx === 0 ? s.supplierVatAmount || 0 : ''}","${idx === 0 ? s.supplierTotalAmount || 0 : ''}","${idx === 0 ? s.settlementDate || '-' : ''}"\n`;
      });
    }
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `정산내역_${state.currentUser.name}_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
  showToast(`${settlements.length}건의 정산 내역이 다운로드되었습니다.`);
}

// 공급사 선택된 정산 PDF 다운로드
function downloadSupplierSelectedPDF(settlements) {
  const totalFinal = settlements.reduce((sum, s) => sum + (s.supplierTotalAmount || 0), 0);
  
  let tableRows = settlements.map(s => {
    const sellerName = s.sellerName || '-';
    const sellerParts = sellerName.split('/');
    const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
    return `
      <tr>
        <td>${sellerDisplay}</td>
        <td>${s.dealPeriod || '-'}</td>
        <td style="text-align:right;">${formatNumber(s.salesAmount || 0)}원</td>
        <td style="text-align:right;">${formatNumber(s.supplierSupplyAmount || 0)}원</td>
        <td style="text-align:right;">${formatNumber(s.supplierVatAmount || 0)}원</td>
        <td style="text-align:right;font-weight:bold;color:#ea580c;">${formatNumber(s.supplierTotalAmount || 0)}원</td>
        <td>${s.settlementDate || '-'}</td>
      </tr>
    `;
  }).join('');
  
  const pdfHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>정산서 - ${state.currentUser.name}</title>
      <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 40px; }
        h1 { color: #ea580c; border-bottom: 2px solid #ea580c; padding-bottom: 10px; }
        .info { margin: 20px 0; font-size: 14px; }
        .total { font-size: 24px; color: #ea580c; font-weight: bold; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #fff7ed; }
        .footer { margin-top: 30px; font-size: 11px; color: #888; }
      </style>
    </head>
    <body>
      <h1>공급사 정산서</h1>
      <div class="info">
        <p><strong>공급사:</strong> ${state.currentUser.name}</p>
        <p><strong>발행일:</strong> ${new Date().toLocaleDateString('ko-KR')}</p>
        <p><strong>선택 건수:</strong> ${settlements.length}건</p>
      </div>
      <div class="total">선택 정산금액 (V+): ${formatNumber(totalFinal)}원</div>
      <table>
        <thead>
          <tr>
            <th>셀러</th>
            <th>공구기간</th>
            <th>판매금액</th>
            <th>공급가액</th>
            <th>부가세</th>
            <th>정산금액</th>
            <th>정산일</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
      </table>
      <div class="footer">
        <p>모여라딜 파트너 포털에서 발행된 정산서입니다.</p>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pdfHtml);
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
  }, 500);
  showToast(`${settlements.length}건의 정산서 인쇄 화면이 열렸습니다.`);
}

// 정산 엑셀 다운로드
function downloadSettlementExcel() {
  const mySettlements = state.settlements.filter(s => s.brandName === state.currentUser.name);
  if (mySettlements.length === 0) {
    showToast('다운로드할 정산 내역이 없습니다.');
    return;
  }
  
  let csvContent = '\uFEFF'; // BOM for Korean
  csvContent += '셀러,공구기간,판매상품,단가,수량,판매금액,공급가액,부가세,정산금액,정산일\n';
  
  mySettlements.forEach(s => {
    const products = s.products || s.salesItems || [];
    if (products.length === 0) {
      csvContent += `"${s.sellerName || '-'}","${s.dealPeriod || '-'}","-","-","${s.totalQuantity || '-'}","${s.salesAmount || 0}","${s.supplyAmount || 0}","${s.vatAmount || 0}","${s.supplierTotalAmount || 0}","${s.settlementDate || '-'}"\n`;
    } else {
      products.forEach((p, idx) => {
        const price = Number(p.salePrice) || Number(p.price) || 0;
        const qty = Number(p.quantity) || 0;
        csvContent += `"${idx === 0 ? s.sellerName || '-' : ''}","${idx === 0 ? s.dealPeriod || '-' : ''}","${p.productName || '-'}","${price}","${qty}","${price * qty}","${idx === 0 ? s.supplyAmount || 0 : ''}","${idx === 0 ? s.vatAmount || 0 : ''}","${idx === 0 ? s.supplierTotalAmount || 0 : ''}","${idx === 0 ? s.settlementDate || '-' : ''}"\n`;
      });
    }
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `정산내역_${state.currentUser.name}_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
  showToast('엑셀 파일이 다운로드되었습니다.');
}

// 정산 PDF 다운로드
function downloadSettlementPDF() {
  const mySettlements = state.settlements.filter(s => s.brandName === state.currentUser.name);
  if (mySettlements.length === 0) {
    showToast('다운로드할 정산 내역이 없습니다.');
    return;
  }
  
  // PDF용 HTML 생성
  const totalFinal = mySettlements.reduce((sum, s) => sum + (Number(s.supplierTotalAmount) || 0), 0);
  
  let tableRows = '';
  mySettlements.forEach(s => {
    const products = s.products || s.salesItems || [];
    if (products.length === 0) {
      tableRows += `<tr>
        <td>${s.sellerName || '-'}</td>
        <td>${s.dealPeriod || '-'}</td>
        <td>-</td>
        <td style="text-align:right;">${formatNumber(s.salesAmount || 0)}원</td>
        <td style="text-align:right;">${formatNumber(s.supplierTotalAmount || 0)}원</td>
        <td>${s.settlementDate || '-'}</td>
      </tr>`;
    } else {
      products.forEach((p, idx) => {
        const price = Number(p.salePrice) || Number(p.price) || 0;
        const qty = Number(p.quantity) || 0;
        tableRows += `<tr>
          ${idx === 0 ? `<td rowspan="${products.length}">${s.sellerName || '-'}</td>` : ''}
          ${idx === 0 ? `<td rowspan="${products.length}">${s.dealPeriod || '-'}</td>` : ''}
          <td>${p.productName || '-'} (${qty}개)</td>
          <td style="text-align:right;">${formatNumber(price * qty)}원</td>
          ${idx === 0 ? `<td rowspan="${products.length}" style="text-align:right;font-weight:bold;color:#ea580c;">${formatNumber(s.supplierTotalAmount || 0)}원</td>` : ''}
          ${idx === 0 ? `<td rowspan="${products.length}">${s.settlementDate || '-'}</td>` : ''}
        </tr>`;
      });
    }
  });
  
  const pdfHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>정산서 - ${state.currentUser.name}</title>
      <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 40px; }
        h1 { color: #ea580c; border-bottom: 2px solid #ea580c; padding-bottom: 10px; }
        .info { margin: 20px 0; font-size: 14px; }
        .total { font-size: 24px; color: #ea580c; font-weight: bold; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #fff7ed; }
        .footer { margin-top: 30px; font-size: 11px; color: #888; }
      </style>
    </head>
    <body>
      <h1>정산서</h1>
      <div class="info">
        <p><strong>공급사:</strong> ${state.currentUser.name}</p>
        <p><strong>발행일:</strong> ${new Date().toLocaleDateString('ko-KR')}</p>
      </div>
      <div class="total">총 정산금액: ${formatNumber(totalFinal)}원</div>
      <table>
        <thead>
          <tr>
            <th>셀러</th>
            <th>공구기간</th>
            <th>상품</th>
            <th>판매금액</th>
            <th>정산금액(V+)</th>
            <th>정산일</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
      </table>
      <div class="footer">
        <p>모여라딜 파트너 포털에서 발행된 정산서입니다.</p>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pdfHtml);
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
  }, 500);
  showToast('PDF 인쇄 화면이 열렸습니다.');
}

// ===== 공구 제안 (셀러 전용) =====
function renderSuggest(container) {
  const mySuggestions = state.suggestions?.filter(s => s.sellerId === state.currentUser.id) || [];
  
  // 모여라딜에서 받은 제안 (내 sellerId로 온 것 or 전체 공개된 것)
  const receivedProposals = state.adminProposals?.filter(p => 
    p.targetSellerId === state.currentUser.id || 
    (p.isPublic && !p.targetSellerId)
  ) || [];
  
  const pendingReceived = receivedProposals.filter(p => p.sellerStatus !== 'accepted' && p.sellerStatus !== 'rejected');
  
  container.innerHTML = `
    <!-- 헤더 - 모바일 최적화 -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px;">
      <div style="flex: 1;">
        <h1 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">공구 제안</h1>
        <p style="font-size: 13px; color: var(--gray-500);">아이디어 제안 및 받은 제안 확인</p>
      </div>
      <button onclick="openSuggestModal()" style="
        padding: 10px 16px;
        font-size: 13px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
      ">
        <span style="font-size: 16px; font-weight: 400;">+</span> 제안하기
      </button>
    </div>
    
    <!-- 탭 - 3D 스타일 -->
    <div style="display: flex; border-radius: 14px; overflow: hidden; margin-bottom: 16px; background: linear-gradient(145deg, #f5f5f5, #e8e8e8); padding: 4px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);">
      <button id="suggestTab-my" onclick="switchSuggestTab('my')" style="
        flex: 1;
        padding: 12px 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        transition: all 0.2s;
      ">
        내 제안 <span style="opacity: 0.85;">(${mySuggestions.length})</span>
      </button>
      <button id="suggestTab-received" onclick="switchSuggestTab('received')" style="
        flex: 1;
        padding: 12px 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        background: transparent;
        color: var(--gray-500);
        border-radius: 10px;
        transition: all 0.2s;
      ">
        받은 제안 <span style="opacity: 0.85;">(${receivedProposals.length})</span>
        ${pendingReceived.length > 0 ? `<span style="background: linear-gradient(145deg, #ef4444, #dc2626); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 4px; box-shadow: 0 2px 4px rgba(220,38,38,0.3);">${pendingReceived.length}</span>` : ''}
      </button>
    </div>
    
    <!-- 내 제안 목록 -->
    <div id="suggestContent-my">
      ${mySuggestions.length === 0 ? `
        <div style="padding: 48px 20px; text-align: center; background: linear-gradient(145deg, #ffffff, #f8f8f8); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);">
          <div style="font-size: 48px; margin-bottom: 16px;">💡</div>
          <p style="color: var(--gray-500); font-size: 14px; line-height: 1.6;">아직 제안한 공구가 없습니다.<br>새로운 아이디어를 제안해보세요!</p>
        </div>
      ` : `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          ${mySuggestions.map(s => `
            <div style="
              padding: 16px;
              background: linear-gradient(145deg, #ffffff, #f9f9f9);
              border-radius: 14px;
              box-shadow: 0 4px 16px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.9);
              border: 1px solid rgba(0,0,0,0.04);
            ">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 700; font-size: 15px; color: var(--gray-800); margin-bottom: 4px;">${s.title}</div>
                  <div style="font-size: 12px; color: var(--gray-500);">${formatDateKR(s.createdAt)}${s.brand ? ` · ${s.brand}` : ''}</div>
                </div>
                <span style="
                  flex-shrink: 0;
                  padding: 5px 10px;
                  border-radius: 8px;
                  font-size: 11px;
                  font-weight: 600;
                  background: ${s.status === 'approved' ? 'linear-gradient(145deg, #22c55e, #16a34a)' : s.status === 'rejected' ? 'linear-gradient(145deg, #9ca3af, #6b7280)' : 'linear-gradient(145deg, #3b82f6, #2563eb)'};
                  color: white;
                  box-shadow: 0 2px 6px ${s.status === 'approved' ? 'rgba(34,197,94,0.3)' : s.status === 'rejected' ? 'rgba(107,114,128,0.3)' : 'rgba(59,130,246,0.3)'};
                ">
                  ${s.status === 'approved' ? '승인' : s.status === 'rejected' ? '반려' : '검토중'}
                </span>
              </div>
              ${s.status === 'pending' || s.status === 'rejected' ? `
                <div style="display: flex; gap: 8px; justify-content: flex-end; padding-top: 12px; border-top: 1px solid var(--gray-100);">
                  ${s.status === 'pending' ? `
                    <button type="button" onclick="event.stopPropagation(); openSuggestModal('${s.id}')" style="
                      padding: 8px 14px;
                      font-size: 12px;
                      font-weight: 600;
                      background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                      color: var(--gray-600);
                      border: 1px solid var(--gray-200);
                      border-radius: 8px;
                      cursor: pointer;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
                    ">수정</button>
                    <button type="button" onclick="event.stopPropagation(); deleteSuggestion('${s.id}')" style="
                      padding: 8px 14px;
                      font-size: 12px;
                      font-weight: 600;
                      background: linear-gradient(145deg, #fef2f2, #fee2e2);
                      color: #dc2626;
                      border: 1px solid #fecaca;
                      border-radius: 8px;
                      cursor: pointer;
                      box-shadow: 0 2px 4px rgba(220,38,38,0.1);
                    ">삭제</button>
                  ` : `
                    <button type="button" onclick="event.stopPropagation(); resubmitSuggestion('${s.id}')" style="
                      padding: 8px 16px;
                      font-size: 12px;
                      font-weight: 600;
                      background: linear-gradient(145deg, #fc9600, #e08600);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      cursor: pointer;
                      box-shadow: 0 4px 12px rgba(252,150,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
                    ">수정 후 재신청</button>
                  `}
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `}
    </div>
    
    <!-- 받은 제안 목록 - 아코디언 형식 -->
    <div id="suggestContent-received" style="display: none;">
      ${receivedProposals.length === 0 ? `
        <div style="padding: 48px 20px; text-align: center; background: linear-gradient(145deg, #ffffff, #f8f8f8); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);">
          <div style="font-size: 48px; margin-bottom: 16px;">📬</div>
          <p style="color: var(--gray-500); font-size: 14px; line-height: 1.6;">아직 받은 제안이 없습니다.<br>모여라딜에서 좋은 제안을 보내드릴게요!</p>
        </div>
      ` : `
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${receivedProposals.map((p, idx) => `
            <!-- 아코디언 헤더 -->
            <div style="
              background: ${p.sellerStatus === 'accepted' ? 'linear-gradient(145deg, #f0fdf4, #dcfce7)' : p.sellerStatus === 'rejected' ? 'linear-gradient(145deg, #fef2f2, #fee2e2)' : 'linear-gradient(145deg, #ffffff, #f9f9f9)'};
              border-radius: 12px;
              border: 1px solid ${p.sellerStatus === 'accepted' ? '#86efac' : p.sellerStatus === 'rejected' ? '#fecaca' : 'var(--gray-200)'};
              box-shadow: 0 2px 8px rgba(0,0,0,0.04);
              overflow: hidden;
            ">
              <div onclick="toggleReceivedProposal(${idx})" style="
                padding: 14px 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                transition: background 0.2s;
              ">
                <div style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 10px;">
                  <span id="proposalArrow-${idx}" style="font-size: 10px; color: var(--gray-400); transition: transform 0.2s;">▶</span>
                  <div>
                    <div style="font-weight: 600; font-size: 14px; color: var(--gray-800); margin-bottom: 2px;">${p.title}</div>
                    <div style="font-size: 11px; color: var(--gray-500);">${formatDateKR(p.createdAt)}${p.brandName ? ` · ${p.brandName}` : ''}</div>
                  </div>
                </div>
                <span style="
                  flex-shrink: 0;
                  padding: 4px 8px;
                  border-radius: 6px;
                  font-size: 10px;
                  font-weight: 600;
                  background: ${p.sellerStatus === 'accepted' ? 'linear-gradient(145deg, #22c55e, #16a34a)' : p.sellerStatus === 'rejected' ? 'linear-gradient(145deg, #9ca3af, #6b7280)' : 'linear-gradient(145deg, #fc9600, #e08600)'};
                  color: white;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                ">
                  ${p.sellerStatus === 'accepted' ? '수락함' : p.sellerStatus === 'rejected' ? '거절함' : '검토대기'}
                </span>
              </div>
              
              <!-- 아코디언 컨텐츠 (기본 숨김) -->
              <div id="proposalContent-${idx}" style="display: none; padding: 0 16px 16px 16px; border-top: 1px solid ${p.sellerStatus === 'accepted' ? '#86efac' : p.sellerStatus === 'rejected' ? '#fecaca' : 'var(--gray-100)'};">
                ${p.content ? `<div style="font-size: 13px; color: var(--gray-600); margin: 12px 0; padding: 12px; background: rgba(255,255,255,0.8); border-radius: 10px; line-height: 1.6;">${p.content}</div>` : ''}
                
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0;">
                  ${p.expectedPeriod ? `<span style="background: var(--gray-100); padding: 6px 12px; border-radius: 8px; font-size: 12px; color: var(--gray-600);"><strong>희망일자</strong> ${p.expectedPeriod}</span>` : ''}
                  ${p.expectedMargin ? `<span style="background: var(--gray-100); padding: 6px 12px; border-radius: 8px; font-size: 12px; color: var(--gray-600);"><strong>수수료율</strong> ${p.expectedMargin}</span>` : ''}
                  ${p.productLink ? `<a href="${p.productLink}" target="_blank" style="background: var(--info-light); padding: 6px 12px; border-radius: 8px; font-size: 12px; color: var(--info); text-decoration: none; font-weight: 500;">상품보기 →</a>` : ''}
                </div>
                
                ${!p.sellerStatus || p.sellerStatus === 'pending' ? `
                  <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;">
                    <button type="button" onclick="respondToProposal('${p.id}', 'rejected')" style="
                      padding: 10px 20px;
                      font-size: 13px;
                      font-weight: 600;
                      background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                      color: var(--gray-600);
                      border: 1px solid var(--gray-300);
                      border-radius: 10px;
                      cursor: pointer;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
                    ">거절하기</button>
                    <button type="button" onclick="respondToProposal('${p.id}', 'accepted')" style="
                      padding: 10px 20px;
                      font-size: 13px;
                      font-weight: 600;
                      background: linear-gradient(145deg, #fc9600, #e08600);
                      color: white;
                      border: none;
                      border-radius: 10px;
                      cursor: pointer;
                      box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
                    ">수락하기</button>
                  </div>
                ` : `
                  <div style="text-align: right; font-size: 12px; color: var(--gray-400); margin-top: 8px;">
                    ${p.respondedAt ? formatDateKR(p.respondedAt) + '에 응답함' : ''}
                  </div>
                `}
              </div>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

// 받은 제안 아코디언 토글
function toggleReceivedProposal(idx) {
  const content = document.getElementById('proposalContent-' + idx);
  const arrow = document.getElementById('proposalArrow-' + idx);
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    arrow.style.transform = 'rotate(90deg)';
  } else {
    content.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  }
}

// 제안 탭 전환
function switchSuggestTab(tab) {
  const myTab = document.getElementById('suggestTab-my');
  const receivedTab = document.getElementById('suggestTab-received');
  
  if (tab === 'my') {
    myTab.style.background = 'linear-gradient(145deg, #fc9600, #e08600)';
    myTab.style.color = 'white';
    myTab.style.boxShadow = '0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2)';
    receivedTab.style.background = 'transparent';
    receivedTab.style.color = 'var(--gray-500)';
    receivedTab.style.boxShadow = 'none';
  } else {
    receivedTab.style.background = 'linear-gradient(145deg, #fc9600, #e08600)';
    receivedTab.style.color = 'white';
    receivedTab.style.boxShadow = '0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2)';
    myTab.style.background = 'transparent';
    myTab.style.color = 'var(--gray-500)';
    myTab.style.boxShadow = 'none';
  }
  
  document.getElementById('suggestContent-my').style.display = tab === 'my' ? 'block' : 'none';
  document.getElementById('suggestContent-received').style.display = tab === 'received' ? 'block' : 'none';
}

// 받은 제안에 응답
async function respondToProposal(proposalId, status) {
  const action = status === 'accepted' ? '수락' : '거절';
  if (!confirm(`이 제안을 ${action}하시겠습니까?`)) return;
  
  try {
    await db.collection('adminProposals').doc(proposalId).update({
      sellerStatus: status,
      respondedAt: new Date().toISOString()
    });
    showToast(`제안을 ${action}했습니다.`);
    renderPage('suggest');
  } catch (e) {
    console.error(e);
    showToast('처리에 실패했습니다.');
  }
}

function openSuggestModal(suggestionId = null, isResubmit = false) {
  const isEdit = !!suggestionId;
  const s = isEdit ? (state.suggestions.find(sug => sug.id === suggestionId) || state.dealSuggestions.find(sug => sug.id === suggestionId)) : {};
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">💡 ${isResubmit ? '공구 제안 재신청' : isEdit ? '공구 제안 수정' : '공구 제안'}</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form onsubmit="saveSuggestion(event, '${suggestionId || ''}', ${isResubmit})">
        <div class="modal-body">
          ${isResubmit ? `
            <div style="background: #fff8f0; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(252,150,0,0.2);">
              <div style="font-size: 13px; color: var(--gray-700);">
                💡 반려된 제안을 수정하여 다시 신청합니다.<br>
                <span style="color: var(--gray-500);">수정 후 저장하면 다시 검토 대기 상태가 됩니다.</span>
              </div>
            </div>
          ` : ''}
          <div class="form-group">
            <label class="form-label">제안 제목 *</label>
            <input type="text" class="form-input" id="sug-title" placeholder="예: OO브랜드 신제품 공구 제안" value="${s.title || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">브랜드/상품명</label>
            <input type="text" class="form-input" id="sug-brand" placeholder="브랜드 또는 상품명" value="${s.brand || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">예상 판매가</label>
            <input type="text" class="form-input" id="sug-price" placeholder="예: 30,000원" value="${s.price || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">제안 내용 *</label>
            <textarea class="form-textarea" id="sug-content" rows="5" placeholder="공구 제안 이유, 예상 반응 등을 자유롭게 작성해주세요." required>${s.content || ''}</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">참고 링크</label>
            <input type="text" class="form-input" id="sug-link" placeholder="상품 링크 또는 참고 URL" value="${s.link || ''}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button type="submit" class="btn btn-primary" style="width: auto;">${isResubmit ? '재신청하기' : isEdit ? '수정하기' : '제안하기'}</button>
        </div>
      </form>
    </div>
  `;
}

async function saveSuggestion(e, suggestionId = '', isResubmit = false) {
  e.preventDefault();
  
  try {
    const data = {
      sellerId: state.currentUser.id,
      sellerName: state.currentUser.name,
      title: document.getElementById('sug-title').value,
      brand: document.getElementById('sug-brand').value,
      price: document.getElementById('sug-price').value,
      content: document.getElementById('sug-content').value,
      link: document.getElementById('sug-link').value,
      status: 'pending',
      updatedAt: new Date().toISOString()
    };
    
    if (suggestionId) {
      // 수정 또는 재신청
      await db.collection('dealSuggestions').doc(suggestionId).update(data);
      showToast(isResubmit ? '제안이 재신청되었습니다.' : '제안이 수정되었습니다.');
    } else {
      // 새로 추가
      data.createdAt = new Date().toISOString();
      await db.collection('dealSuggestions').add(data);
      showToast('제안이 등록되었습니다.');
    }
    
    closeModal();
    renderPage('suggest');
  } catch (e) {
    console.error(e);
    showToast('저장에 실패했습니다.');
  }
}

async function deleteSuggestion(suggestionId) {
  if (!confirm('이 제안을 삭제하시겠습니까?')) return;
  
  try {
    await db.collection('dealSuggestions').doc(suggestionId).delete();
    showToast('제안이 삭제되었습니다.');
    renderPage('suggest');
  } catch (e) {
    console.error(e);
    showToast('삭제에 실패했습니다.');
  }
}

// 반려된 제안 재신청
async function resubmitSuggestion(suggestionId) {
  const suggestion = state.suggestions?.find(s => s.id === suggestionId);
  if (!suggestion) {
    showToast('제안을 찾을 수 없습니다.');
    return;
  }
  
  // 수정 모달을 열되, 상태를 pending으로 변경할 것임을 알림
  openSuggestModal(suggestionId, true);
}

// ===== 공구 상세 모달 =====
function openDealModal(dealId) {
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;
  
  const supplier = state.suppliers.find(s => s.id === deal.supplierId);
  const seller = state.sellers.find(s => s.id === deal.sellerId);
  
  // 상품 정보
  const products = (deal.selectedProducts || []).map(item => {
    const pid = typeof item === 'string' ? item : item.productId;
    const product = state.supplierProducts.find(p => p.id === pid);
    return product ? {
      ...product,
      marginRate: typeof item === 'object' ? item.marginRate : 0
    } : null;
  }).filter(Boolean);
  
  const today = new Date();
  const start = new Date(deal.startDate);
  const end = new Date(deal.endDate);
  let statusText = '예정';
  let statusClass = 'status-upcoming';
  
  if (today >= start && today <= end) {
    statusText = '진행중';
    statusClass = 'status-ongoing';
  } else if (today > end) {
    statusText = '완료';
    statusClass = 'status-completed';
  }
  
  // 공급사용: 셀러 닉네임만 표시
  let displayTitle = deal.title;
  let sellerDisplayName = '';
  if (state.userType === 'supplier' && seller && seller.name) {
    const parts = seller.name.split('/');
    if (parts.length > 1) {
      sellerDisplayName = parts[1]; // 닉네임(팔로워수)
      displayTitle = parts[1];
    } else {
      sellerDisplayName = seller.name;
      displayTitle = seller.name;
    }
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  // 공급사용 모달
  if (state.userType === 'supplier') {
    m.innerHTML = `
      <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
          <h3 class="modal-title">📅 공구 상세</h3>
          <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 8px;">${displayTitle}</h2>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          <div style="background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">📅 기간</span>
                <span style="font-weight: 600;">${deal.startDate} ~ ${deal.endDate}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--gray-500);">셀러</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-weight: 600;">${sellerDisplayName}</span>
                  ${(seller?.channelLink || seller?.accountLink) ? `
                    <a href="${(seller.channelLink || seller.accountLink).startsWith('http') ? (seller.channelLink || seller.accountLink) : 'https://' + (seller.channelLink || seller.accountLink)}" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--info-light); border-radius: 20px; font-size: 12px; color: var(--info); text-decoration: none; font-weight: 500;">
                      ${getChannelIconPortal(seller.channelLink || seller.accountLink)} 채널
                    </a>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
          
          <!-- 샘플 배송 정보 (고정) -->
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px;">📦 샘플 배송 정보</h4>
            <div style="padding: 16px; background: var(--info-light); border-radius: 12px;">
              <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">받는이</span>
                  <span style="font-weight: 600;">모여라딜</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">연락처</span>
                  <span style="font-weight: 600;">010-4320-4179</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <span style="color: var(--gray-500);">주소</span>
                  <span style="font-weight: 600; text-align: right; max-width: 220px;">${seller?.address || '-'}</span>
                </div>
                ${(seller?.channelLink || seller?.accountLink) ? `
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <span style="color: var(--gray-500);">계정</span>
                    <a href="${(seller.channelLink || seller.accountLink).startsWith('http') ? (seller.channelLink || seller.accountLink) : 'https://' + (seller.channelLink || seller.accountLink)}" target="_blank" style="color: var(--info); font-weight: 500; text-align: right; max-width: 220px; word-break: break-all;">${seller.channelLink || seller.accountLink}</a>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
          
          <!-- 샘플 전달 상태 -->
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px;">📋 샘플 전달</h4>
            <div style="padding: 16px; background: ${deal.journeySample ? 'var(--success-light)' : 'var(--gray-50)'}; border-radius: 12px; border: 2px solid ${deal.journeySample ? 'var(--success)' : 'var(--gray-200)'};">
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <input type="checkbox" ${deal.journeySample ? 'checked' : ''} onchange="toggleSampleDelivery('${deal.id}', this.checked)" style="width: 20px; height: 20px; accent-color: var(--success);">
                <div>
                  <div style="font-weight: 600; color: ${deal.journeySample ? 'var(--success)' : 'var(--gray-700)'};">
                    ${deal.journeySample ? '✓ 샘플 전달 완료' : '샘플 전달 대기중'}
                  </div>
                  <div style="font-size: 12px; color: var(--gray-500);">샘플을 전달했다면 체크해주세요</div>
                </div>
              </label>
            </div>
          </div>
          
          ${products.length > 0 ? `
            <div style="margin-bottom: 16px;">
              <h4 style="margin-bottom: 12px;">🛒 공구 상품</h4>
              ${products.map(p => `
                <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
                  <div style="font-weight: 600;">${p.productName}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          <!-- 셀러 업로드 컨텐츠 파일 -->
          ${(deal.contentFiles && deal.contentFiles.length > 0) ? `
            <div style="margin-bottom: 16px;">
              <h4 style="margin-bottom: 12px;">📁 셀러 업로드 컨텐츠</h4>
              <div style="padding: 16px; background: #f0fdf4; border-radius: 12px; border: 1px solid #86efac;">
                <div style="font-size: 12px; color: #16a34a; margin-bottom: 12px;">✓ 셀러가 ${deal.contentFiles.length}개 파일을 업로드했습니다</div>
                ${deal.contentFiles.map((file, idx) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <span style="font-size: 18px;">${file.type === 'image' ? '🖼️' : file.type === 'video' ? '🎬' : '📄'}</span>
                      <div>
                        <div style="font-weight: 600; font-size: 12px;">${file.name}</div>
                        <div style="font-size: 10px; color: var(--gray-500);">${file.uploadedAt || ''}</div>
                      </div>
                    </div>
                    <a href="${file.url}" target="_blank" style="padding: 6px 12px; background: var(--primary); color: white; border-radius: 6px; font-size: 12px; text-decoration: none; font-weight: 600;">다운로드</a>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          ${deal.notes ? `
            <div style="padding: 16px; background: var(--warning-light); border-radius: 12px;">
              <h4 style="margin-bottom: 8px; color: var(--warning);">📝 메모</h4>
              <p style="font-size: 14px;">${deal.notes}</p>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  } else {
    // 셀러용 모달 - 간소화된 체크리스트
    const checklist = deal.sellerChecklist || {};
    
    // 샘플 전달 상태 - 공급사/모여라딜에서 설정한 journeySample 자동 연동
    const sampleDelivered = deal.journeySample || false;
    
    const checklistItems = [
      { key: 'sampleReceived', label: '샘플전달', desc: sampleDelivered ? '✓ 샘플 전달 완료!' : '공급사에서 전달 시 자동 체크됩니다', auto: true, checked: sampleDelivered },
      { key: 'shooting', label: '컨텐츠 촬영중', desc: '사진/영상 촬영 진행' },
      { key: 'contentDone', label: '컨텐츠 제작완료', desc: '최종 컨텐츠 완성' }
    ];
    
    const manualItems = checklistItems.filter(item => !item.auto);
    const manualCompleted = manualItems.filter(item => checklist[item.key]).length;
    const totalCompleted = (sampleDelivered ? 1 : 0) + manualCompleted;
    const progress = Math.round((totalCompleted / checklistItems.length) * 100);
    
    // 컨텐츠 파일 목록
    const contentFiles = deal.contentFiles || [];
    
    // 상품명 목록
    const productNames = products.map(p => p.productName).slice(0, 3);
    const productDisplay = productNames.join(', ') + (products.length > 3 ? ' 외' : '');
    
    m.innerHTML = `
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3 class="modal-title">📅 공구 상세</h3>
          <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <div style="text-align: center; margin-bottom: 16px;">
            <h2 style="margin-bottom: 8px; font-size: 18px;">${productDisplay || deal.title}</h2>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          <div style="background: var(--gray-50); padding: 14px; border-radius: 12px; margin-bottom: 16px;">
            <div style="display: grid; gap: 10px; font-size: 13px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">📅 기간</span>
                <span style="font-weight: 600;">${deal.startDate} ~ ${deal.endDate}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">공급사</span>
                <span style="font-weight: 600; color: var(--primary);">${supplier?.name || '-'}</span>
              </div>
            </div>
          </div>
          
          <!-- 공구 진행 체크리스트 (간소화) -->
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
              <span>✅ 공구 진행 현황</span>
              <span style="font-size: 12px; color: var(--primary); font-weight: 600;">${progress}%</span>
            </h4>
            
            <!-- 진행률 바 -->
            <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; margin-bottom: 14px;">
              <div style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, var(--primary), #22c55e); transition: width 0.3s;"></div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
              ${checklistItems.map((item, idx) => {
                const isChecked = item.auto ? item.checked : checklist[item.key];
                const bgColor = isChecked ? '#f0fdf4' : 'var(--gray-50)';
                const borderColor = isChecked ? '#86efac' : 'var(--gray-200)';
                const stepColors = ['#f97316', '#3b82f6', '#22c55e'];
                
                return `
                  <div style="padding: 14px; background: ${bgColor}; border-radius: 12px; border: 1px solid ${borderColor};">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: ${item.auto ? 'default' : 'pointer'};">
                      ${item.auto ? `
                        <div style="width: 22px; height: 22px; background: ${isChecked ? '#22c55e' : 'var(--gray-300)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                          <span style="color: white; font-size: 12px;">${isChecked ? '✓' : '...'}</span>
                        </div>
                      ` : `
                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                          onchange="toggleSellerChecklist('${deal.id}', '${item.key}', this.checked)"
                          style="width: 22px; height: 22px; accent-color: #22c55e; flex-shrink: 0;">
                      `}
                      <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: ${stepColors[idx]}; color: white; border-radius: 50%; font-size: 11px; font-weight: 700;">${idx + 1}</span>
                          <span style="font-weight: 600; color: ${isChecked ? '#16a34a' : 'var(--gray-700)'}; font-size: 14px;">${item.label}</span>
                          ${item.auto ? `<span style="font-size: 10px; background: var(--info-light); color: var(--info); padding: 2px 6px; border-radius: 4px; cursor: help;" title="공급사가 '샘플전달완료'를 체크하면 자동으로 체크됩니다">자동 ❓</span>` : ''}
                        </div>
                        <div style="font-size: 12px; color: var(--gray-500); margin-left: 28px; margin-top: 2px;">${item.desc}</div>
                      </div>
                    </label>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          
          <!-- 컨텐츠 업로드 섹션 -->
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px; font-size: 14px;">📁 컨텐츠 파일</h4>
            <div style="padding: 16px; background: var(--gray-50); border-radius: 12px; border: 2px dashed var(--gray-300);">
              ${contentFiles.length > 0 ? `
                <div style="margin-bottom: 12px;">
                  ${contentFiles.map((file, idx) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px;">
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">${file.type === 'image' ? '🖼️' : file.type === 'video' ? '🎬' : '📄'}</span>
                        <div>
                          <div style="font-weight: 600; font-size: 12px;">${file.name}</div>
                          <div style="font-size: 10px; color: var(--gray-500);">${file.uploadedAt || ''}</div>
                        </div>
                      </div>
                      <div style="display: flex; gap: 6px;">
                        <a href="${file.url}" target="_blank" style="padding: 5px 8px; background: var(--info-light); color: var(--info); border-radius: 6px; font-size: 11px; text-decoration: none;">다운로드</a>
                        <button onclick="removeContentFile('${deal.id}', ${idx})" style="padding: 5px 8px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;">삭제</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              <div style="text-align: center;">
                <div style="color: var(--gray-500); margin-bottom: 12px; font-size: 13px;">
                  ${contentFiles.length === 0 ? '아직 업로드된 파일이 없습니다.' : '파일 추가'}
                </div>
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                  <button onclick="addContentFileUrl('${deal.id}')" class="btn" style="background: linear-gradient(145deg, #fff8f0, #ffedd5); color: #ea580c; border: 1px solid rgba(252,150,0,0.2); padding: 10px 16px; font-size: 13px;">
                    🔗 URL 추가
                  </button>
                  <button onclick="openGoogleDriveUpload('${deal.id}')" class="btn" style="background: linear-gradient(145deg, #ffffff, #f3f4f6); color: var(--gray-700); border: 1px solid var(--gray-200); padding: 10px 16px; font-size: 13px;">
                    📂 구글드라이브 링크
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          ${deal.notes ? `
            <div style="padding: 16px; background: var(--info-light); border-radius: 12px;">
              <h4 style="margin-bottom: 8px; color: var(--info);">📝 메모</h4>
              <p style="font-size: 14px;">${deal.notes}</p>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }
}

// 샘플 전달 토글 (공급사용)
async function toggleSampleDelivery(dealId, checked) {
  try {
    await db.collection('deals').doc(dealId).update({
      journeySample: checked
    });
    showToast(checked ? '샘플 전달 완료 처리되었습니다.' : '샘플 전달 상태가 취소되었습니다.');
    // 모달 새로고침
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('처리에 실패했습니다.');
  }
}

// 셀러 체크리스트 토글
async function toggleSellerChecklist(dealId, key, checked) {
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const currentChecklist = deal?.sellerChecklist || {};
    currentChecklist[key] = checked;
    
    await db.collection('deals').doc(dealId).update({
      sellerChecklist: currentChecklist
    });
    showToast(checked ? '체크 완료!' : '체크 해제됨');
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('처리에 실패했습니다.');
  }
}

// 컨텐츠 URL 추가
async function addContentFileUrl(dealId) {
  const url = prompt('컨텐츠 URL을 입력하세요 (이미지, 영상, 드라이브 링크 등):');
  if (!url) return;
  
  const name = prompt('파일 이름을 입력하세요:', 'content_' + Date.now());
  if (!name) return;
  
  // 파일 타입 추정
  let type = 'file';
  if (url.match(/\.(jpg|jpeg|png|gif|webp)/i)) type = 'image';
  else if (url.match(/\.(mp4|mov|avi|webm)/i)) type = 'video';
  else if (url.includes('drive.google.com')) type = 'drive';
  
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const contentFiles = deal?.contentFiles || [];
    contentFiles.push({
      name,
      url,
      type,
      uploadedAt: new Date().toLocaleDateString('ko-KR')
    });
    
    await db.collection('deals').doc(dealId).update({ contentFiles });
    showToast('파일이 추가되었습니다.');
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('파일 추가에 실패했습니다.');
  }
}

// 구글 드라이브 링크 추가
async function openGoogleDriveUpload(dealId) {
  const url = prompt('구글 드라이브 공유 링크를 입력하세요:');
  if (!url) return;
  
  if (!url.includes('drive.google.com')) {
    showToast('구글 드라이브 링크가 아닙니다.');
    return;
  }
  
  const name = prompt('파일 이름을 입력하세요:', '구글드라이브_컨텐츠');
  if (!name) return;
  
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const contentFiles = deal?.contentFiles || [];
    contentFiles.push({
      name,
      url,
      type: 'drive',
      uploadedAt: new Date().toLocaleDateString('ko-KR')
    });
    
    await db.collection('deals').doc(dealId).update({ contentFiles });
    showToast('구글 드라이브 링크가 추가되었습니다.');
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('링크 추가에 실패했습니다.');
  }
}

// 컨텐츠 파일 삭제
async function removeContentFile(dealId, fileIdx) {
  if (!confirm('이 파일을 삭제하시겠습니까?')) return;
  
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const contentFiles = deal?.contentFiles || [];
    contentFiles.splice(fileIdx, 1);
    
    await db.collection('deals').doc(dealId).update({ contentFiles });
    showToast('파일이 삭제되었습니다.');
    openDealModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('파일 삭제에 실패했습니다.');
  }
}

// ===== 데이터 로드 =====
function loadData() {
  // 공급사
  db.collection('suppliers').onSnapshot(snapshot => {
    state.suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }, error => {
    console.error('공급사 로드 오류:', error);
  });
  
  // 셀러
  db.collection('sellers').onSnapshot(snapshot => {
    state.sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }, error => {
    console.error('셀러 로드 오류:', error);
  });
  
  // 공구
  db.collection('deals').onSnapshot(snapshot => {
    state.deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'dashboard') {
      renderPage('dashboard');
    }
  });
  
  // 상품
  db.collection('supplierProducts').onSnapshot(snapshot => {
    state.supplierProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'products') {
      renderPage('products');
    }
  });
  
  // 공지사항
  db.collection('partnerNotices').onSnapshot(snapshot => {
    state.notices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'notice') {
      renderPage('notice');
    }
  });
  
  // 메시지
  db.collection('partnerMessages').onSnapshot(snapshot => {
    state.messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'message') {
      renderPage('message');
    }
  });
  
  // 정산 (sellerSettlements)
  db.collection('sellerSettlements').onSnapshot(snapshot => {
    state.settlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    state.sellerSettlements = state.settlements; // 대시보드용으로도 저장
    if (state.currentUser && (state.currentPage === 'settlement' || state.currentPage === 'dashboard')) {
      renderPage(state.currentPage);
    }
  });
  
  // 공급사 정산 (supplierSettlements)
  db.collection('supplierSettlements').onSnapshot(snapshot => {
    state.supplierSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'settlement') {
      renderPage('settlement');
    }
  });
  
  // 제안
  db.collection('dealSuggestions').onSnapshot(snapshot => {
    state.suggestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'suggest') {
      renderPage('suggest');
    }
  });
  
  // 모여라딜→셀러 제안 (adminProposals)
  db.collection('adminProposals').onSnapshot(snapshot => {
    state.adminProposals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'suggest') {
      renderPage('suggest');
    }
  });
  
  // 긴급판매요청
  db.collection('urgentSales').onSnapshot(snapshot => {
    state.urgentSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser && state.currentPage === 'urgent') {
      renderPage('urgent');
    }
  });
}

// 초기화
loadData();

// 페이지 로드 시 저장된 아이디 불러오기
document.addEventListener('DOMContentLoaded', function() {
  loadSavedLoginId();
  
  // 세션 복구 시도 (새로고침 시 자동 로그인)
  tryRestoreSession();
});

// 세션 복구 함수
async function tryRestoreSession() {
  const sessionStr = localStorage.getItem('partner_session');
  if (!sessionStr) return;
  
  try {
    const session = JSON.parse(sessionStr);
    if (!session.userType || !session.loginId || !session.loginPw) return;
    
    // 데이터 로드 대기 (최대 5초)
    let waitCount = 0;
    while ((state.suppliers.length === 0 && state.sellers.length === 0) && waitCount < 50) {
      await new Promise(r => setTimeout(r, 100));
      waitCount++;
    }
    
    let matched = null;
    
    if (session.userType === 'supplier') {
      matched = state.suppliers.find(s => s.loginId === session.loginId && s.loginPw === session.loginPw);
      if (matched) {
        state.currentUser = matched;
        state.userType = 'supplier';
        showPortal();
      }
    } else if (session.userType === 'seller') {
      matched = state.sellers.find(s => s.loginId === session.loginId && s.loginPw === session.loginPw);
      if (matched) {
        state.currentUser = matched;
        state.userType = 'seller';
        showPortal();
      }
    }
    
    // 매칭 실패 시 세션 삭제
    if (!matched) {
      localStorage.removeItem('partner_session');
    }
  } catch (e) {
    console.error('세션 복구 실패:', e);
    localStorage.removeItem('partner_session');
  }
}
</script>

</body>
</html>

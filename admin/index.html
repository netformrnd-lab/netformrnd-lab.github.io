<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì—¬ë¼ë”œ - ê´€ë¦¬ì ì‹œìŠ¤í…œ</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/admin/manifest.json">

  <!-- í…Œë§ˆ ì»¬ëŸ¬ -->
  <meta name="theme-color" content="#fc9600">

  <!-- iOS Safari ì§€ì› -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ëª¨ì—¬ë¼ë”œ">
  <link rel="apple-touch-icon" href="/admin/icon-192.png">

  <!-- ìŠ¤í”Œë˜ì‹œ ìŠ¤í¬ë¦° (iOS) -->
  <link rel="apple-touch-startup-image" href="/admin/icon-512.png">

  <!-- ì•± ì„¤ëª… -->
  <meta name="description" content="ëª¨ì—¬ë¼ë”œ ì˜ì—… ê´€ë¦¬ ì‹œìŠ¤í…œ - ì–¸ì œ ì–´ë””ì„œë‚˜ ì˜ì—… í™œë™">

  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      /* ëª¨ì—¬ë¼ë”œ ë©”ì¸ ì»¬ëŸ¬ */
      --primary: #fc9600;
      --primary-light: #fff8f0;
      --primary-dark: #e08600;
      --white: #ffffff;
      /* í† ìŠ¤ ìŠ¤íƒ€ì¼ - ì±„ë„ ë‚®ì€ ë°ì€ ê·¸ë ˆì´ */
      --gray-900: #191f28;
      --gray-800: #333d4b;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      /* ìƒíƒœ ìƒ‰ìƒ - ë¶€ë“œëŸ¬ìš´ í†¤ */
      --success: #00c073;
      --success-light: #e8f7f0;
      --warning: #fc9600;
      --warning-light: #fff8f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --info: #3182f6;
      --info-light: #eef4ff;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      min-height: 100vh; 
      background: var(--gray-100);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    /* ë¡œê·¸ì¸ í™”ë©´ */
    .login-screen {
      min-height: 100vh;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-container {
      width: 100%;
      max-width: 400px;
    }
    
    .login-logo {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .login-logo img {
      height: 48px;
    }
    
    .login-logo-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-top: 8px;
    }
    
    .login-card {
      background: var(--white);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    
    .login-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      color: var(--gray-900);
    }
    
    .login-error {
      background: var(--danger-light);
      border: 1px solid #fecaca;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }
    
    .login-error.show {
      display: block;
    }
    
    .login-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
      margin-bottom: 12px;
    }
    
    .login-input:focus {
      outline: none;
      border-color: var(--gray-400);
      box-shadow: 0 0 0 3px var(--gray-100);
    }
    
    .login-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: var(--gray-900);
      color: var(--white);
      font-family: inherit;
      transition: all 0.15s ease;
    }
    
    .login-btn:hover {
      background: var(--gray-800);
    }
    
    .login-btn.loading {
      position: relative;
      color: transparent;
      pointer-events: none;
    }
    
    .login-btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ë ˆì´ì•„ì›ƒ */
    .app-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 260px;
      background: var(--white);
      border-right: 1px solid var(--gray-200);
      padding: 24px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 20px;
      margin-bottom: 32px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .nav-section {
      margin-bottom: 32px;
    }

    .nav-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-500);
      letter-spacing: -0.2px;
      padding: 0 20px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      border-radius: 0;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      font-weight: 500;
      color: var(--gray-700);
      position: relative;
    }

    .nav-item:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }

    .nav-item.active {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary);
    }

    .nav-item .icon {
      width: 20px;
      text-align: center;
      font-size: 16px;
    }

    /* í•˜ìœ„ ë©”ë‰´ ìŠ¤íƒ€ì¼ ê°œì„  (í† ìŠ¤ ìŠ¤íƒ€ì¼) */
    .nav-section .nav-label[onclick] {
      padding: 12px 20px !important;
      margin-bottom: 8px !important;
      border-radius: 8px !important;
    }

    #deal-submenu,
    #partner-submenu {
      margin-top: 4px;
      padding-left: 0 !important;
    }

    #deal-submenu .nav-item,
    #partner-submenu > div .nav-item {
      padding-left: 44px !important;
      font-size: 14px !important;
      color: var(--gray-600);
      margin-bottom: 2px;
    }

    #deal-submenu .nav-item:hover,
    #partner-submenu > div .nav-item:hover {
      background: var(--gray-50);
    }

    /* 3ë‹¨ê³„ í•˜ìœ„ ë©”ë‰´ (ê³µê¸‰ì‚¬/ì…€ëŸ¬) */
    #partner-submenu > div {
      margin-bottom: 8px;
    }

    #partner-submenu > div > .nav-item {
      padding-left: 44px !important;
      background: transparent !important;
      border-radius: 0 !important;
      margin-bottom: 4px !important;
      font-weight: 600 !important;
    }

    #supplier-submenu,
    #seller-submenu {
      margin-top: 4px;
      padding-left: 0 !important;
    }

    #supplier-submenu .nav-item,
    #seller-submenu .nav-item {
      padding-left: 64px !important;
      font-size: 14px !important;
      color: var(--gray-600);
      font-weight: 400 !important;
    }

    /* ë©”ë‰´ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ */
    #deal-menu-arrow,
    #partner-menu-arrow,
    #supplier-menu-arrow,
    #seller-menu-arrow {
      color: var(--gray-500);
      font-size: 12px;
    }

    /* ì‚¬ìš©ì í”„ë¡œí•„ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ê°œì„  */
    #userProfileBox {
      padding: 16px 20px !important;
      margin-bottom: 20px !important;
      border-bottom: 1px solid var(--gray-200) !important;
      background: var(--gray-50);
      border-radius: 8px;
      margin-left: 12px;
      margin-right: 12px;
    }

    #userName {
      font-weight: 600 !important;
      font-size: 15px !important;
      color: var(--gray-900) !important;
    }

    #userRole {
      font-size: 12px !important;
      color: var(--gray-500) !important;
      margin-left: 8px !important;
    }

    #userGoalRate {
      font-size: 18px !important;
      font-weight: 700 !important;
      color: var(--primary) !important;
    }

    .inquiry-badge {
      background: var(--danger);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: auto;
    }
    
    /* ë©”ì¸ ì»¨í…ì¸  */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 28px 32px;
      max-width: 1400px;
    }

    /* í–„ë²„ê±° ë©”ë‰´ */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 150;
      background: var(--primary);
      color: var(--white);
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
    }

    .mobile-menu-btn:active {
      transform: scale(0.95);
    }

    /* ëª¨ë°”ì¼ ì˜¤ë²„ë ˆì´ */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 90;
    }
    
    /* í—¤ë” */
    .page-header {
      margin-bottom: 24px;
    }
    
    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    
    .page-desc {
      font-size: 14px;
      color: var(--gray-500);
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    
    /* ë²„íŠ¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--white);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }
    
    .btn-secondary:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
    }
    
    .btn-ghost:hover {
      background: var(--gray-100);
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
    }
    
    /* ì¹´ë“œ */
    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
    }
    
    /* í†µê³„ ì¹´ë“œ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: 10px;
      padding: 16px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 6px;
    }
    
    .stat-value {
      font-size: 26px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .stat-card.highlight {
      background: var(--primary);
    }
    
    .stat-card.highlight .stat-label,
    .stat-card.highlight .stat-value {
      color: var(--white);
    }
    
    /* ì•Œë¦¼ ë°°ë„ˆ */
    .alert {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .alert-warning {
      background: var(--warning-light);
      color: #b45309;
    }
    
    .alert-danger {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .alert-info {
      background: var(--gray-100);
      color: var(--gray-700);
    }
    
    /* í•„í„° ë°” */
    .filter-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      background: var(--gray-100);
      border-radius: 6px;
      padding: 3px;
    }
    
    .filter-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    
    .filter-btn.active {
      background: var(--white);
      color: var(--gray-900);
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    
    /* ìº˜ë¦°ë” */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .calendar-nav button {
      width: 32px;
      height: 32px;
      border: 1px solid var(--gray-200);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      color: var(--gray-600);
      transition: all 0.15s ease;
    }
    
    .calendar-nav button:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }
    
    .calendar-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
      min-width: 140px;
      text-align: center;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    
    .calendar-weekday {
      text-align: center;
      padding: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-500);
    }
    
    .calendar-weekday:first-child { color: var(--danger); }
    .calendar-weekday:last-child { color: var(--info); }
    
    .calendar-day {
      min-height: 90px;
      padding: 8px;
      background: var(--white);
      border: 1px solid var(--gray-100);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }
    
    .calendar-day:hover {
      border-color: var(--gray-300);
    }
    
    .calendar-day.other-month {
      opacity: 0.4;
      background: var(--gray-50);
    }
    
    .calendar-day.today {
      border-color: var(--primary);
      background: var(--primary-light);
    }
    
    .calendar-day.today .day-number {
      background: var(--primary);
      color: var(--white);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .day-number {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    
    .calendar-day.sunday .day-number { color: var(--danger); }
    .calendar-day.saturday .day-number { color: var(--info); }
    .calendar-day.today .day-number { color: var(--white); }
    
    /* ê³µêµ¬ ë±ƒì§€ */
    .deal-badge {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 4px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    
    .deal-badge:hover {
      transform: translateX(2px);
    }
    
    .deal-badge.supplier {
      background: var(--info-light);
      color: var(--info);
    }
    
    .deal-badge.seller {
      background: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .deal-badge.both {
      background: var(--success-light);
      color: var(--success);
    }
    
    /* ë²”ë¡€ */
    .legend {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--gray-500);
    }
    
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
    }
    
    .legend-dot.supplier { background: var(--info); }
    .legend-dot.seller { background: var(--primary); }
    .legend-dot.both { background: var(--success); }
    
    /* ê³µêµ¬ ë¦¬ìŠ¤íŠ¸ */
    .deal-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .deal-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .deal-item:hover {
      border-color: var(--gray-300);
      background: var(--gray-50);
    }
    
    .deal-color {
      width: 3px;
      height: 40px;
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .deal-color.negotiating { background: var(--gray-400); }
    .deal-color.confirmed { background: var(--info); }
    .deal-color.ongoing { background: var(--success); }
    .deal-color.completed { background: var(--gray-300); }
    
    .deal-info {
      flex: 1;
      min-width: 0;
    }
    
    .deal-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 2px;
    }
    
    .deal-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--gray-500);
    }
    
    .deal-status {
      flex-shrink: 0;
    }
    
    /* ìƒíƒœ ë±ƒì§€ */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-negotiating { background: var(--gray-100); color: var(--gray-600); }
    .status-confirmed { background: var(--info-light); color: var(--info); }
    .status-ongoing { background: var(--success-light); color: var(--success); }
    .status-completed { background: var(--gray-100); color: var(--gray-400); }
    
    /* ì •ì‚° ì²´í¬ */
    .settlement-badges {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    
    .settlement-badge {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .settlement-badge.pending {
      background: var(--gray-100);
      color: var(--gray-500);
    }
    
    .settlement-badge.done {
      background: var(--success-light);
      color: var(--success);
    }
    
    /* í…Œì´ë¸” */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--gray-100);
      font-size: 13px;
    }

    .data-table th {
      font-weight: 600;
      color: var(--gray-500);
      font-size: 12px;
      background: var(--gray-50);
    }

    .data-table tr:hover td {
      background: var(--gray-50);
    }

    .data-table .actions {
      display: flex;
      gap: 6px;
    }
    
    /* í¼ */
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 6px;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      color: var(--gray-900);
      background: var(--white);
      transition: all 0.15s ease;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--gray-400);
      box-shadow: 0 0 0 3px var(--gray-100);
    }
    
    .form-input::placeholder {
      color: var(--gray-400);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    /* ëª¨ë‹¬ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--white);
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.2s ease;
    }
    
    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    
    .modal-close:hover {
      background: var(--gray-200);
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-100);
    }
    
    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background: var(--gray-900);
      color: var(--white);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 9999;
      display: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    /* ì²´í¬ë°•ìŠ¤ ì»¤ìŠ¤í…€ */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--gray-50);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid var(--gray-200);
    }
    
    .checkbox-wrapper:hover {
      background: var(--gray-100);
    }
    
    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--gray-900);
      cursor: pointer;
    }
    
    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 13px;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.15s ease;
      opacity: 0.5;
    }
    
    .btn-icon:hover {
      background: var(--gray-100);
      opacity: 1;
    }
    
    .btn-icon.has-notes {
      opacity: 1;
      background: var(--gray-100);
    }
    
    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--gray-500);
    }
    
    .empty-state .icon {
      font-size: 40px;
      margin-bottom: 12px;
    }
    
    .empty-state .text {
      font-size: 14px;
    }
    
    /* ë¡œë”© */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-100);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ì„ íƒ ë“œë¡­ë‹¤ìš´ */
    .select-wrapper {
      position: relative;
    }
    
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238b95a1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 44px;
    }
    
    /* ë„ì›€ë§ íˆ´íŒ */
    .help-tooltip-wrapper:hover .help-tooltip-content {
      display: block !important;
    }
    
    .help-tooltip-btn:hover {
      background: var(--gray-100) !important;
      border-color: var(--gray-400) !important;
      color: var(--gray-700) !important;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 1200px) {
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 900px) {
      /* ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ í‘œì‹œ */
      .mobile-menu-btn {
        display: flex;
      }

      /* ì‚¬ì´ë“œë°”ë¥¼ ì™¼ìª½ ë°–ìœ¼ë¡œ ìˆ¨ê¹€ */
      .sidebar {
        transform: translateX(-100%);
        width: 300px;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
      }

      /* ëª¨ë°”ì¼ ì˜ì—… ê¸°ëŠ¥ í™œì„±í™” */
      .mobile-fab {
        display: block;
      }

      .mobile-quick-filters {
        display: block;
      }

      .mobile-quick-actions {
        display: block;
      }

      /* ëª¨ë°”ì¼ì—ì„œ í†µê³„ ì¹´ë“œ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
      .stats-row {
        display: flex;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
        gap: 12px;
        padding: 4px;
        grid-template-columns: none;
      }

      .stats-row .card {
        min-width: 280px;
        scroll-snap-align: start;
        flex-shrink: 0;
      }

      .stats-row::-webkit-scrollbar {
        display: none;
      }

      /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸” ìˆ¨ê¸°ê³  ì¹´ë“œë·° í‘œì‹œ */
      .desktop-table-view {
        display: none !important;
      }

      .mobile-card-view {
        display: block !important;
      }

      /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” - ë²„íŠ¼ í¬ê¸° ì¦ê°€ */
      .btn {
        min-height: 44px;
        padding: 12px 20px;
        font-size: 15px;
      }

      .btn-sm {
        min-height: 40px;
        padding: 10px 16px;
        font-size: 14px;
      }

      /* ëª¨ë°”ì¼ ë©”ë‰´ í„°ì¹˜ ì˜ì—­ ì¦ê°€ */
      .nav-item {
        min-height: 44px;
        padding: 12px 14px;
      }

      /* ëª¨ë°”ì¼ ì…ë ¥ í•„ë“œ ìµœì†Œ í¬ê¸° (iOS zoom ë°©ì§€) */
      input, select, textarea {
        font-size: 16px !important;
      }

      /* ì‚¬ì´ë“œë°” ì—´ë¦¼ ìƒíƒœ */
      .sidebar.open {
        transform: translateX(0);
      }

      /* ì˜¤ë²„ë ˆì´ í‘œì‹œ */
      .sidebar-overlay.show {
        display: block;
      }

      .main-content {
        margin-left: 0;
        padding: 72px 20px 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      /* í—¤ë” ì•¡ì…˜ ë²„íŠ¼ */
      .header-actions {
        flex-wrap: wrap;
      }

      /* í…Œì´ë¸” ìµœì í™” */
      .data-table th,
      .data-table td {
        padding: 10px 8px;
        font-size: 12px;
      }

      /* ì¹´ë“œ íŒ¨ë”© ì¡°ì • */
      .card {
        padding: 16px;
      }

      /* ëª¨ë‹¬ */
      .modal-content {
        max-width: 100%;
        margin: 0 16px;
      }
    }

    @media (max-width: 640px) {
      /* í†µê³„ ì¹´ë“œ 1ì—´ë¡œ */
      .stats-row {
        grid-template-columns: 1fr;
      }

      /* í˜ì´ì§€ íƒ€ì´í‹€ í¬ê¸° ì¡°ì • */
      .page-title {
        font-size: 20px;
      }

      /* ë²„íŠ¼ ì „ì²´ ë„ˆë¹„ */
      .header-actions .btn {
        flex: 1;
        min-width: 0;
      }

      /* í…Œì´ë¸” ë” ì‘ê²Œ */
      .data-table {
        min-width: 500px;
      }

      .data-table th,
      .data-table td {
        padding: 8px 6px;
        font-size: 11px;
      }

      /* ëª¨ë°”ì¼ì—ì„œ ë§ˆì§€ë§‰ ê´€ë¦¬ ì—´ stickyë¡œ ê³ ì • */
      .data-table th:last-child,
      .data-table td.actions {
        position: sticky;
        right: 0;
        background: var(--white);
        box-shadow: -2px 0 4px rgba(0, 0, 0, 0.05);
        z-index: 1;
      }

      .data-table th:last-child {
        background: var(--gray-50);
      }

      .data-table tr:hover td.actions {
        background: var(--gray-50);
      }

      /* í†µê³„ ê°’ í¬ê¸° ì¡°ì • */
      .stat-value {
        font-size: 22px;
      }

      .stat-label {
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      .main-content {
        padding: 64px 12px 12px;
      }

      /* ì¹´ë“œ ì‘ê²Œ */
      .card {
        padding: 12px;
        border-radius: 8px;
      }

      /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
      .btn {
        padding: 12px 16px;
        font-size: 13px;
      }

      .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
        min-width: 36px;
        min-height: 36px;
      }

      /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ í‘œì‹œ */
      .card > div[style*="overflow-x: auto"] {
        position: relative;
      }

      .card > div[style*="overflow-x: auto"]::after {
        content: 'â† ìŠ¤í¬ë¡¤ â†’';
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 10px;
        pointer-events: none;
        opacity: 0;
        animation: scrollHint 3s ease-in-out 0.5s;
      }

      @keyframes scrollHint {
        0%, 100% { opacity: 0; }
        10%, 90% { opacity: 1; }
      }

      /* í¼ ì¸í’‹ í¬ê¸° ì¡°ì • (í„°ì¹˜ ìµœì í™”) */
      .form-input,
      .form-select,
      .form-textarea {
        padding: 12px;
        font-size: 16px; /* iOS zoom ë°©ì§€ */
      }

      .form-label {
        font-size: 12px;
      }

      /* í…Œì´ë¸” ìµœì†Œ í¬ê¸° ë” ì‘ê²Œ */
      .data-table {
        min-width: 400px;
      }
    }
    
    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }
    
    /* ìˆœìˆ˜ìµ íˆ´íŒ hover ìŠ¤íƒ€ì¼ */
    .profit-tooltip-trigger:hover .profit-tooltip {
      display: block !important;
    }

    /* ==================== ëª¨ë°”ì¼ ì˜ì—… ê¸°ëŠ¥ ê³ ë„í™” ==================== */

    /* ëª¨ë°”ì¼ ì „ìš© FAB (Floating Action Button) */
    .mobile-fab {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 999;
    }

    .mobile-fab-main {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(252, 150, 0, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s ease;
    }

    .mobile-fab-main:active {
      transform: scale(0.95);
    }

    .mobile-fab-main.active {
      transform: rotate(45deg);
    }

    .mobile-fab-menu {
      position: absolute;
      bottom: 72px;
      right: 0;
      display: none;
      flex-direction: column;
      gap: 12px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .mobile-fab-menu.active {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }

    .mobile-fab-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
      padding: 12px 16px;
      border-radius: 28px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .mobile-fab-item:active {
      transform: scale(0.95);
    }

    .mobile-fab-item-icon {
      font-size: 20px;
    }

    .mobile-fab-item-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-900);
    }

    /* ëª¨ë°”ì¼ ì¹´ë“œë·° */
    .mobile-card-view {
      display: none;
    }

    .mobile-order-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      position: relative;
      transition: transform 0.2s ease;
    }

    .mobile-order-card.swipe-left {
      transform: translateX(-80px);
    }

    .mobile-order-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .mobile-order-card-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--gray-900);
    }

    .mobile-order-card-meta {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .mobile-order-card-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mobile-order-card-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }

    .mobile-order-card-label {
      color: var(--gray-600);
    }

    .mobile-order-card-value {
      font-weight: 600;
      color: var(--gray-900);
    }

    .mobile-order-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--gray-100);
    }

    .mobile-order-card-actions button {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    /* ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ì•¡ì…˜ ë²„íŠ¼ */
    .swipe-actions {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      gap: 4px;
      padding-right: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .mobile-order-card.swipe-left .swipe-actions {
      opacity: 1;
      pointer-events: all;
    }

    .swipe-action-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.15s ease;
    }

    .swipe-action-btn.edit {
      background: var(--info);
      color: white;
    }

    .swipe-action-btn.delete {
      background: var(--danger);
      color: white;
    }

    /* ëª¨ë°”ì¼ ë¹ ë¥¸ í•„í„° */
    .mobile-quick-filters {
      display: none;
      overflow-x: auto;
      white-space: nowrap;
      padding: 12px 0;
      margin-bottom: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .mobile-quick-filters::-webkit-scrollbar {
      display: none;
    }

    .mobile-filter-chip {
      display: inline-block;
      padding: 8px 16px;
      margin-right: 8px;
      border-radius: 20px;
      background: var(--gray-100);
      color: var(--gray-700);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mobile-filter-chip.active {
      background: var(--primary);
      color: white;
    }

    /* ëª¨ë°”ì¼ í†µê³„ ì¹´ë“œ ìŠ¤ì™€ì´í”„ */
    .mobile-stats-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      display: flex;
      gap: 12px;
      padding: 4px;
    }

    .mobile-stats-scroll::-webkit-scrollbar {
      display: none;
    }

    .mobile-stats-scroll .card {
      min-width: 280px;
      scroll-snap-align: start;
      flex-shrink: 0;
    }

    /* ëª¨ë°”ì¼ ë¹ ë¥¸ ì•¡ì…˜ ë°” */
    .mobile-quick-actions {
      display: none;
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--gray-200);
      padding: 12px 16px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 50;
    }

    .mobile-quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .mobile-quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mobile-quick-action-btn:active {
      background: var(--gray-100);
      transform: scale(0.95);
    }

    .mobile-quick-action-icon {
      font-size: 20px;
    }

    .mobile-quick-action-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-700);
    }

    /* ğŸ¯ ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    body.guest-mode input[type="checkbox"]:not([id*="filter"]):not([id*="Filter"]) {
      pointer-events: none;
      opacity: 0.6;
    }
    body.guest-mode .btn-primary:not([onclick*="download"]):not([onclick*="export"]):not([onclick*="Excel"]),
    body.guest-mode .btn-danger,
    body.guest-mode button[onclick*="delete"],
    body.guest-mode button[onclick*="Delete"],
    body.guest-mode button[onclick*="save"],
    body.guest-mode button[onclick*="Save"],
    body.guest-mode button[onclick*="open"][onclick*="Modal"],
    body.guest-mode button[onclick*="edit"],
    body.guest-mode button[onclick*="Edit"] {
      opacity: 0.5;
      cursor: not-allowed;
    }
    body.guest-mode input[type="file"] {
      pointer-events: none;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <!-- OAuth ì½œë°± ì¦‰ì‹œ ì²˜ë¦¬ (ë¡œê·¸ì¸ í™”ë©´ë³´ë‹¤ ë¨¼ì €) -->
  <script>
  (function() {
    // URLì—ì„œ OAuth íŒŒë¼ë¯¸í„° í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const error = urlParams.get('error');

    // OAuth ì½œë°±ì´ë©´ ì²˜ë¦¬ ëŒ€ê¸° í”Œë˜ê·¸ ì„¤ì •
    if (code || error) {
      window.__OAUTH_CALLBACK_PENDING__ = true;
      window.__OAUTH_CODE__ = code;
      window.__OAUTH_STATE__ = state;
      window.__OAUTH_ERROR__ = error;
      window.__OAUTH_ERROR_DESC__ = urlParams.get('error_description');

      // URL ì •ë¦¬ (íŒŒë¼ë¯¸í„° ì œê±°)
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);

      // ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¸°ê³  ë¡œë”© í‘œì‹œ
      document.addEventListener('DOMContentLoaded', function() {
        const loginScreen = document.getElementById('login-screen');
        if (loginScreen) {
          loginScreen.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;"><div style="font-size:48px;margin-bottom:16px;">â³</div><div style="font-size:16px;color:#333;">ì¹´í˜24 ì¸ì¦ ì²˜ë¦¬ ì¤‘...</div></div>';
        }
      });
    }
  })();
  </script>

  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-logo">
        <img src="logo-horizontal.png" alt="ëª¨ì—¬ë¼ë”œ">
        <div class="login-logo-desc">ê´€ë¦¬ì ì „ìš©</div>
      </div>
      
      <div class="login-card">
        <div class="login-title">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</div>
        
        <div id="admin-login-error" class="login-error">
          ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
        
        <div>
          <input type="text" class="login-input" id="admin-login-id" placeholder="ì•„ì´ë””" required>
          <input type="password" class="login-input" id="admin-login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" required onkeypress="if(event.key==='Enter') handleAdminLogin(event)">
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; cursor: pointer; font-size: 13px; color: var(--gray-600);">
            <input type="checkbox" id="admin-remember-me" style="width: 16px; height: 16px; cursor: pointer;">
            ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥
          </label>
          <button type="button" class="login-btn" id="admin-login-btn" onclick="handleAdminLogin(event)">ë¡œê·¸ì¸</button>
        </div>
        
        <div style="text-align: center; margin-top: 16px; font-size: 12px; color: var(--gray-400);">
          íŒ€ì› ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”
        </div>
      </div>
    </div>
  </div>

  <!-- ë©”ì¸ ì•± (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
  <div id="app-wrapper" style="display: none;">
    <!-- ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ -->
    <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>

    <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileMenu()"></div>

    <div class="app-container">
      <aside class="sidebar" id="sidebar">
        <div class="logo">
          <img src="logo-horizontal.png" alt="ëª¨ì—¬ë¼ë”œ" style="height: 32px;">
        </div>
        
        <!-- ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ -->
        <div id="userProfileBox" style="padding: 12px 16px; margin-bottom: 12px; border-bottom: 1px solid #E5E8EB;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span style="font-weight: 600; font-size: 14px; color: #191F28;" id="userName">-</span>
              <span style="font-size: 12px; color: #8B95A1; margin-left: 6px;" id="userRole">-</span>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 16px; font-weight: 700; color: #0064FF;" id="userGoalRate">-</div>
            </div>
          </div>
        </div>
        
        <nav>
          <!-- ì˜ì—…í˜„í™© (ë§¨ ìœ„) - ë„·í¼ ê³„ì •ì€ ìˆ¨ê¹€ -->
          <div id="sales-dashboard-section" class="nav-section" style="margin-bottom: 12px;">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #1e40af, #3b82f6); padding: 12px 14px; border-radius: 10px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);" onclick="switchTab('salesDashboard')">
              <span style="font-weight: 600; color: white;">ğŸ“Š ì˜ì—…í˜„í™©</span>
              <span style="color: rgba(255,255,255,0.7);">â†’</span>
            </div>
          </div>
          
          <!-- ê³µêµ¬ì„¼í„° ì„¹ì…˜ -->
          <div class="nav-section">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: #e5e7eb; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px;" onclick="toggleDealMenu()">
              <span style="font-weight: 600; color: var(--gray-700);">ê³µêµ¬ì„¼í„°</span>
              <span id="deal-menu-arrow" style="transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
            </div>
            <div id="deal-submenu" style="display: block; padding-left: 8px;">
              <div class="nav-item active" data-tab="calendar" onclick="switchTab('calendar')" style="font-size: 13px;">
                <span>ìº˜ë¦°ë”</span>
              </div>
              <div class="nav-item" data-tab="dealManagement" onclick="switchTab('dealManagement')" style="font-size: 13px;">
                <span>ê³µêµ¬ í˜„í™©/ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
              </div>
              <div class="nav-item" data-tab="dealCenter" onclick="switchTab('dealCenter')" style="font-size: 13px;">
                <span>ê³µêµ¬ ì œì•ˆ ê´€ë¦¬</span>
              </div>
              <div class="nav-item" data-tab="settlement" onclick="switchTab('settlement')" style="font-size: 13px;">
                <span>ì •ì‚° ê´€ë¦¬</span>
              </div>
            </div>
          </div>
          
          <!-- íŒŒíŠ¸ë„ˆ ê´€ë¦¬ ì„¹ì…˜ (ì—´ë¦° ìƒíƒœ) -->
          <div class="nav-section">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: #e5e7eb; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px;" onclick="togglePartnerMenu()">
              <span style="font-weight: 600; color: var(--gray-700);">íŒŒíŠ¸ë„ˆ ê´€ë¦¬</span>
              <span id="partner-menu-arrow" style="transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
            </div>
            <div id="partner-submenu" style="display: block;">
              
              <!-- ê³µê¸‰ì‚¬ ê´€ë¦¬ (3ì¤‘ í•˜ìœ„, ì—´ë¦° ìƒíƒœ) -->
              <div style="padding-left: 8px;">
                <div class="nav-item" style="font-size: 13px; background: #f3f4f6; border-radius: 4px; margin-bottom: 2px;" onclick="toggleSupplierMenu(event)">
                  <span style="color: var(--gray-600); font-weight: 500;">ê³µê¸‰ì‚¬ ê´€ë¦¬</span>
                  <span id="supplier-menu-arrow" style="margin-left: auto; font-size: 10px; transition: transform 0.2s; transform: rotate(90deg);">â–¶</span>
                </div>
                <div id="supplier-submenu" style="display: block; padding-left: 20px;">
                  <div class="nav-item" data-tab="suppliers" onclick="switchTab('suppliers')" style="font-size: 13px;">
                    <span>ê³µê¸‰ì‚¬ DB</span>
                  </div>
                  <div class="nav-item" data-tab="productDB" onclick="switchTab('productDB')" style="font-size: 13px;">
                    <span>ìƒí’ˆ DB</span>
                  </div>
                  <div class="nav-item" data-tab="productList" onclick="switchTab('productList')" style="font-size: 13px;">
                    <span>ìƒí’ˆ ë¦¬ìŠ¤íŠ¸</span>
                  </div>
                </div>
              </div>
              
              <!-- ì…€ëŸ¬ ê´€ë¦¬ (3ì¤‘ í•˜ìœ„, ì—´ë¦° ìƒíƒœ) -->
              <div style="padding-left: 8px;">
                <div class="nav-item" style="font-size: 13px; background: #f3f4f6; border-radius: 4px; margin-bottom: 2px;" onclick="toggleSellerMenu(event)">
                  <span style="color: var(--gray-600); font-weight: 500;">ì…€ëŸ¬ ê´€ë¦¬</span>
                  <span id="seller-menu-arrow" style="margin-left: auto; font-size: 10px; transition: transform 0.2s; transform: rotate(90deg);">â–¶</span>
                </div>
                <div id="seller-submenu" style="display: block; padding-left: 20px;">
                  <div class="nav-item" data-tab="sellers" onclick="switchTab('sellers')" style="font-size: 13px;">
                    <span>ì…€ëŸ¬ DB</span>
                  </div>
                  <div class="nav-item" data-tab="sellerList" onclick="switchTab('sellerList')" style="font-size: 13px;">
                    <span>ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</span>
                  </div>
                </div>
              </div>
              
              <!-- íŒŒíŠ¸ë„ˆ ê³„ì • ê´€ë¦¬ -->
              <div style="padding-left: 8px;">
                <div class="nav-item" data-tab="shareLinks" onclick="switchTab('shareLinks')" style="font-size: 13px;">
                  <span>íŒŒíŠ¸ë„ˆ ê³„ì •ê´€ë¦¬</span>
                </div>
              </div>
              
              <!-- íŒŒíŠ¸ë„ˆ ê³µì§€ -->
              <div style="padding-left: 8px;">
                <div class="nav-item" data-tab="partnerNotices" onclick="switchTab('partnerNotices')" style="font-size: 13px;">
                  <span>íŒŒíŠ¸ë„ˆ ê³µì§€</span>
                </div>
              </div>
              
            </div>
          </div>
          
          <!-- ì¹´í˜24 ê´€ë¦¬ ì„¹ì…˜ -->
          <div class="nav-section">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #2563eb, #3b82f6); padding: 10px 14px; border-radius: 8px; margin-bottom: 4px; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);" onclick="toggleCafe24Menu()">
              <span style="font-weight: 600; color: white;">ğŸ›’ ì¹´í˜24</span>
              <span id="cafe24-menu-arrow" style="transition: transform 0.2s; color: white; transform: rotate(180deg);">â–¼</span>
            </div>
            <div id="cafe24-submenu" style="display: block; padding-left: 8px;">
              <div class="nav-item" data-tab="cafe24Dashboard" onclick="switchTab('cafe24Dashboard')" style="font-size: 13px;">
                <span>ğŸ“Š ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</span>
              </div>
              <div class="nav-item" data-tab="cafe24Orders" onclick="switchTab('cafe24Orders')" style="font-size: 13px;">
                <span>ğŸ“¦ ì£¼ë¬¸ ê´€ë¦¬</span>
              </div>
              <div class="nav-item" data-tab="productDataManager" onclick="switchTab('productDataManager')" style="font-size: 13px;">
                <span>ğŸ“‹ ìƒí’ˆ ë°ì´í„° ê´€ë¦¬</span>
              </div>
              <div class="nav-item" data-tab="cafe24Settings" onclick="switchTab('cafe24Settings')" style="font-size: 13px;">
                <span>âš™ï¸ API ì—°ë™ ì„¤ì •</span>
              </div>
            </div>
          </div>

          <!-- ê°€ì´ë“œ ì„¹ì…˜ -->
          <div class="nav-section" style="margin-top: 12px;">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #fc9600, #e08600); padding: 10px 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(252,150,0,0.3);" onclick="switchTab('guide')">
              <span style="font-weight: 600; color: white;">ğŸ“š ì—…ë¬´ ê°€ì´ë“œ</span>
              <span style="color: rgba(255,255,255,0.7);">â†’</span>
            </div>
          </div>

          <!-- ê·¸ë¡œìŠ¤ë³´ë“œ ì„¹ì…˜ (ë„·í¼ ê³„ì •ì€ ìˆ¨ê¹€) -->
          <div id="okr-section" class="nav-section" style="margin-top: 12px;">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #10b981, #059669); padding: 10px 14px; border-radius: 8px; margin-bottom: 4px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);" onclick="toggleOKRMenu()">
              <span style="font-weight: 600; color: white;">ğŸ¯ ê·¸ë¡œìŠ¤ë³´ë“œ</span>
              <span id="okr-menu-arrow" style="transition: transform 0.2s; color: white; transform: rotate(180deg);">â–¼</span>
            </div>
            <div id="okr-submenu" style="display: block; padding-left: 8px;">
              <div class="nav-item" data-tab="growthDashboard" onclick="switchTab('growthDashboard')" style="font-size: 13px;">
                <span>ğŸ  ê·¸ë¡œìŠ¤ ëŒ€ì‹œë³´ë“œ</span>
              </div>
              <div class="nav-item" data-tab="okrManagement" onclick="switchTab('okrManagement')" style="font-size: 13px;">
                <span>âœï¸ OKR ê´€ë¦¬</span>
              </div>
              <div class="nav-item" data-tab="okrReview" onclick="switchTab('okrReview')" style="font-size: 13px;">
                <span>ğŸ“ˆ ë¶„ê¸°ë³„ ë¦¬ë·°</span>
              </div>
              <div class="nav-item" data-tab="workLog" onclick="switchTab('workLog')" style="font-size: 13px;">
                <span>ğŸ““ ì—…ë¬´ì¼ì§€</span>
              </div>
            </div>
          </div>

          <!-- ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¹ì…˜ -->
          <div class="nav-section" style="margin-top: 12px;">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #8B5CF6, #A78BFA); padding: 10px 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);" onclick="switchTab('referenceLibrary')">
              <span style="font-weight: 600; color: white;">ğŸ“š ë ˆí¼ëŸ°ìŠ¤</span>
              <span style="color: rgba(255,255,255,0.7);">â†’</span>
            </div>
          </div>

          <!-- ê´€ë¦¬ì ì„¹ì…˜ (ë‹«íŒ ìƒíƒœ, ë¹„ë°€ë²ˆí˜¸ í•„ìš”) -->
          <div class="nav-section" style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--gray-300);">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #374151, #4b5563); padding: 10px 14px; border-radius: 8px; margin-bottom: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" onclick="toggleAdminMenu()">
              <span style="font-weight: 600; color: white;">ê´€ë¦¬ì ğŸ”</span>
              <span id="admin-menu-arrow" style="transition: transform 0.2s; color: white;">â–¼</span>
            </div>
            <div id="admin-submenu" style="display: none; padding-left: 8px; background: #f9fafb; border-radius: 8px; padding: 8px; margin-top: 4px;">
              <div class="nav-item" data-tab="teamMembers" onclick="switchTab('teamMembers')" style="font-size: 13px;">
                <span>íŒ€ì› ê´€ë¦¬</span>
              </div>
              <div class="nav-item" data-tab="dataUsage" onclick="switchTab('dataUsage')" style="font-size: 13px;">
                <span>ë°ì´í„° ì‚¬ìš©ëŸ‰</span>
              </div>
              <div style="border-top: 1px dashed var(--gray-300); margin: 8px 0;"></div>
              <div class="nav-item" onclick="toggleAdvancedAdminMenu()" style="font-size: 12px; color: var(--gray-500); padding: 6px 12px;">
                <span>ê³ ê¸‰ ì„¤ì • â–¼</span>
              </div>
              <div id="advanced-admin-submenu" style="display: none; padding-left: 12px;">
                <div class="nav-item" onclick="openAdminSettings()" style="font-size: 12px; color: var(--gray-500);">
                  <span>ì‹œìŠ¤í…œ ì„¤ì •</span>
                </div>
                <div class="nav-item" onclick="exportAllData()" style="font-size: 12px; color: var(--gray-500);">
                  <span>ë°ì´í„° ë°±ì—…</span>
                </div>
                <div class="nav-item" onclick="openRestoreModal()" style="font-size: 12px; color: var(--gray-500);">
                  <span>ë°ì´í„° ë³µì›</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ / ë¡œê·¸ì•„ì›ƒ -->
          <div class="nav-section" style="margin-top: auto; padding-top: 12px; border-top: 1px solid var(--gray-200);">
            <div class="nav-item" onclick="showMyPasswordChangeModal()" style="color: var(--gray-500); font-size: 13px;">
              <span>ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</span>
            </div>
            <div class="nav-item" onclick="handleAdminLogout()" style="color: var(--gray-500); font-size: 13px;">
              <span>ğŸšª ë¡œê·¸ì•„ì›ƒ</span>
            </div>
          </div>
        </nav>
      </aside>
      
      <main class="main-content">
        <div id="app"></div>
      </main>
    </div>

    <!-- ëª¨ë°”ì¼ FAB (Floating Action Button) -->
    <div class="mobile-fab" id="mobile-fab">
      <div class="mobile-fab-menu" id="mobile-fab-menu">
        <div class="mobile-fab-item" onclick="switchTab('dealManagement'); toggleMobileFAB();">
          <span class="mobile-fab-item-icon">ğŸ“‹</span>
          <span class="mobile-fab-item-label">ê³µêµ¬ í˜„í™©</span>
        </div>
        <div class="mobile-fab-item" onclick="switchTab('cafe24Orders'); toggleMobileFAB();">
          <span class="mobile-fab-item-icon">ğŸ“¦</span>
          <span class="mobile-fab-item-label">ì£¼ë¬¸ ê´€ë¦¬</span>
        </div>
        <div class="mobile-fab-item" onclick="switchTab('settlement'); toggleMobileFAB();">
          <span class="mobile-fab-item-icon">ğŸ’°</span>
          <span class="mobile-fab-item-label">ì •ì‚°</span>
        </div>
        <div class="mobile-fab-item" onclick="switchTab('salesDashboard'); toggleMobileFAB();">
          <span class="mobile-fab-item-icon">ğŸ“Š</span>
          <span class="mobile-fab-item-label">ì˜ì—… í˜„í™©</span>
        </div>
      </div>
      <button class="mobile-fab-main" id="mobile-fab-main" onclick="toggleMobileFAB()">
        +
      </button>
    </div>
  </div>
  
  <div class="toast" id="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>
  <div class="modal" id="modal"></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
// ========== ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ ==========
function toggleMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

function closeMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// ì‚¬ì´ë“œë°” ë©”ë‰´ ì•„ì´í…œ í´ë¦­ì‹œ ëª¨ë°”ì¼ì—ì„œ ìë™ìœ¼ë¡œ ë‹«ê¸°
document.addEventListener('DOMContentLoaded', function() {
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', function() {
      // ëª¨ë°”ì¼ í™”ë©´ì—ì„œë§Œ ìë™ìœ¼ë¡œ ë‹«ê¸° (900px ì´í•˜)
      if (window.innerWidth <= 900) {
        closeMobileMenu();
      }
    });
  });
});

// ========== PWA Service Worker ë“±ë¡ ==========
// ë¡œì»¬ file:// í”„ë¡œí† ì½œì—ì„œëŠ” ë¹„í™œì„±í™”
if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/admin/sw.js')
      .then(registration => {
        console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);

        // ì—…ë°ì´íŠ¸ í™•ì¸
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // ìƒˆ ë²„ì „ ì‚¬ìš© ê°€ëŠ¥
              if (confirm('ìƒˆë¡œìš´ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(error => {
        console.log('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
      });
  });
}

// PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  // ê¸°ë³¸ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ë°©ì§€
  e.preventDefault();
  deferredPrompt = e;

  // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ (ë¡œê·¸ì¸ í›„ì—ë§Œ)
  if (document.getElementById('app-wrapper').style.display !== 'none') {
    showInstallPrompt();
  }
});

function showInstallPrompt() {
  // ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° í‘œì‹œ ì•ˆ í•¨
  if (window.matchMedia('(display-mode: standalone)').matches) {
    return;
  }

  // ì„¤ì¹˜ ë°°ë„ˆ ìƒì„±
  const banner = document.createElement('div');
  banner.id = 'pwa-install-banner';
  banner.style.cssText = `
    position: fixed;
    bottom: 80px;
    left: 16px;
    right: 16px;
    background: linear-gradient(135deg, #fc9600, #e08600);
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(252, 150, 0, 0.4);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideUp 0.3s ease;
  `;

  banner.innerHTML = `
    <div style="flex: 1;">
      <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</div>
      <div style="font-size: 13px; opacity: 0.9;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì—¬ ë” ë¹ ë¥´ê²Œ ì ‘ê·¼í•˜ì„¸ìš”</div>
    </div>
    <button onclick="installPWA()" style="background: white; color: #fc9600; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; white-space: nowrap;">ì„¤ì¹˜</button>
    <button onclick="document.getElementById('pwa-install-banner').remove()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 12px; border-radius: 8px; font-size: 18px; cursor: pointer; line-height: 1;">Ã—</button>
  `;

  document.body.appendChild(banner);
}

async function installPWA() {
  if (!deferredPrompt) {
    return;
  }

  // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
  deferredPrompt.prompt();

  // ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸°
  const { outcome } = await deferredPrompt.userChoice;

  if (outcome === 'accepted') {
    console.log('âœ… PWA ì„¤ì¹˜ ì™„ë£Œ');
  } else {
    console.log('âŒ PWA ì„¤ì¹˜ ì·¨ì†Œ');
  }

  deferredPrompt = null;
  document.getElementById('pwa-install-banner')?.remove();
}

// ì•± ì„¤ì¹˜ ì™„ë£Œ í›„
window.addEventListener('appinstalled', () => {
  console.log('âœ… ì•±ì´ í™ˆ í™”ë©´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
  document.getElementById('pwa-install-banner')?.remove();
  showToast('âœ… ì•±ì´ í™ˆ í™”ë©´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
});

// iOS Safari ì„¤ì¹˜ ì•ˆë‚´ (PWA API ë¯¸ì§€ì›)
if (isIOS() && !isInStandaloneMode()) {
  setTimeout(() => {
    if (document.getElementById('app-wrapper').style.display !== 'none') {
      showIOSInstallPrompt();
    }
  }, 3000);
}

function isIOS() {
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

function isInStandaloneMode() {
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
}

function showIOSInstallPrompt() {
  const banner = document.createElement('div');
  banner.id = 'ios-install-banner';
  banner.style.cssText = `
    position: fixed;
    bottom: 80px;
    left: 16px;
    right: 16px;
    background: linear-gradient(135deg, #fc9600, #e08600);
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(252, 150, 0, 0.4);
    z-index: 1000;
    animation: slideUp 0.3s ease;
  `;

  banner.innerHTML = `
    <div style="margin-bottom: 12px;">
      <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</div>
      <div style="font-size: 13px; opacity: 0.9; line-height: 1.5;">
        1. í•˜ë‹¨ì˜ <strong>ê³µìœ </strong> ë²„íŠ¼ (<svg width="16" height="16" viewBox="0 0 24 24" fill="white" style="vertical-align: middle;"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg>) í„°ì¹˜<br>
        2. <strong>í™ˆ í™”ë©´ì— ì¶”ê°€</strong> ì„ íƒ
      </div>
    </div>
    <button onclick="document.getElementById('ios-install-banner').remove()" style="background: white; color: #fc9600; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; width: 100%;">í™•ì¸</button>
  `;

  document.body.appendChild(banner);
}

// ìŠ¬ë¼ì´ë“œ ì—… ì• ë‹ˆë©”ì´ì…˜
const style = document.createElement('style');
style.textContent = `
  @keyframes slideUp {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
`;
document.head.appendChild(style);

// ========== ëª¨ë°”ì¼ FAB í† ê¸€ ==========
function toggleMobileFAB() {
  const fabMain = document.getElementById('mobile-fab-main');
  const fabMenu = document.getElementById('mobile-fab-menu');

  fabMain.classList.toggle('active');
  fabMenu.classList.toggle('active');
}

// FAB ë©”ë‰´ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
  const fab = document.getElementById('mobile-fab');
  const fabMain = document.getElementById('mobile-fab-main');
  const fabMenu = document.getElementById('mobile-fab-menu');

  if (fab && !fab.contains(e.target) && fabMenu.classList.contains('active')) {
    fabMain.classList.remove('active');
    fabMenu.classList.remove('active');
  }
});

// ========== ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ==========
let touchStartX = 0;
let touchEndX = 0;
let currentSwipeCard = null;

function handleTouchStart(e, cardElement) {
  touchStartX = e.touches[0].clientX;
  currentSwipeCard = cardElement;
}

function handleTouchMove(e, cardElement) {
  if (!currentSwipeCard) return;

  touchEndX = e.touches[0].clientX;
  const diff = touchStartX - touchEndX;

  // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ì‚­ì œ/í¸ì§‘ ë²„íŠ¼ í‘œì‹œ)
  if (diff > 30) {
    cardElement.classList.add('swipe-left');
  } else if (diff < -30) {
    cardElement.classList.remove('swipe-left');
  }
}

function handleTouchEnd(e) {
  touchStartX = 0;
  touchEndX = 0;
  currentSwipeCard = null;
}

// ëª¨ë“  ìŠ¤ì™€ì´í”„ ì¹´ë“œ ë¦¬ì…‹
function resetAllSwipeCards() {
  const cards = document.querySelectorAll('.mobile-order-card');
  cards.forEach(card => card.classList.remove('swipe-left'));
}

// ========== ëª¨ë°”ì¼ ë¹ ë¥¸ í•„í„° ==========
function applyMobileQuickFilter(filterType, value) {
  // í•„í„° ì¹© í™œì„±í™” í† ê¸€
  const chips = document.querySelectorAll('.mobile-filter-chip');
  chips.forEach(chip => {
    if (chip.dataset.filterType === filterType && chip.dataset.filterValue === value) {
      chip.classList.toggle('active');
    }
  });

  // ì‹¤ì œ í•„í„° ì ìš© (ê¸°ì¡´ í•„í„° í•¨ìˆ˜ ì¬ì‚¬ìš©)
  if (filterType === 'date') {
    const dateFilter = document.getElementById('cafe24DateFilter');
    if (dateFilter) {
      dateFilter.value = value;
      filterCafe24Orders();
    }
  } else if (filterType === 'status') {
    const statusFilter = document.getElementById('cafe24StatusFilter');
    if (statusFilter) {
      statusFilter.value = value;
      filterCafe24Orders();
    }
  }
}

// ========== ê´€ë¦¬ì ë¡œê·¸ì¸ ==========
// EmailJS ì„¤ì • (https://www.emailjs.com ì—ì„œ ë¬´ë£Œ ê°€ì… í›„ ì„¤ì •)
const EMAILJS_CONFIG = {
  publicKey: 'YOUR_PUBLIC_KEY',      // EmailJS Public Key
  serviceId: 'YOUR_SERVICE_ID',      // EmailJS Service ID
  templateId: 'YOUR_TEMPLATE_ID'     // EmailJS Template ID
};

// ê´€ë¦¬ì ì´ë©”ì¼ (ì¸ì¦ë²ˆí˜¸ ë°›ì„ ì´ë©”ì¼)
const ADMIN_EMAIL = 'songhee44@netformrnd.com';

// ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ (Firebaseì— ì €ì¥ëœ ê°’ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
const DEFAULT_PASSWORD = 'ahdufk124!';
let adminPassword = DEFAULT_PASSWORD;
let verificationCode = '';

// Firebaseì—ì„œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë¡œë“œ
async function loadAdminPassword() {
  try {
    const doc = await db.collection('settings').doc('admin').get();
    if (doc.exists && doc.data().password) {
      adminPassword = doc.data().password;
      console.log('Firebase ë¹„ë°€ë²ˆí˜¸ ë¡œë“œë¨');
    } else {
      adminPassword = DEFAULT_PASSWORD;
      console.log('ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš© (Firebaseì— ì—†ìŒ)');
    }
  } catch (e) {
    adminPassword = DEFAULT_PASSWORD;
    console.log('ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš© (Firebase ì˜¤ë¥˜)');
  }
}

// ğŸ¯ ê¶Œí•œ ì²´í¬ í•¨ìˆ˜ - ê²ŒìŠ¤íŠ¸ëŠ” ë³´ê¸°ë§Œ ê°€ëŠ¥
function canEdit() {
  const user = state.currentAdmin;
  if (!user) return false;
  // ê²ŒìŠ¤íŠ¸ëŠ” ìˆ˜ì • ë¶ˆê°€
  if (user.role === 'guest') return false;
  return true;
}

// ğŸ¯ ê´€ë¦¬ì ì „ìš© ê¶Œí•œ ì²´í¬ - admin ì—­í• ë§Œ ê°€ëŠ¥
function isAdminRole() {
  const user = state.currentAdmin || state.currentUser;
  if (!user) return false;
  return user.role === 'admin';
}

// ğŸ¯ ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ ì•Œë¦¼
function showAdminOnlyPermission() {
  showToast('ğŸ”’ ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
  return false;
}

// ğŸ¯ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
function getCurrentUserId() {
  const user = state.currentAdmin || state.currentUser;
  if (!user) return '';
  // loginId > name > id ìˆœì„œë¡œ ë°˜í™˜
  return user.loginId || user.name || user.id || '';
}

// ğŸ¯ ë„·í¼ ê³„ì • í™•ì¸ (ì œí•œ ëª¨ë“œ - 1ì£¼ì¼ ì „ ê¸°ë³¸ ë²„ì „ë§Œ ë³´ì´ë„ë¡)
function isNetformAccount() {
  const user = state.currentAdmin || state.currentUser;
  if (!user) return false;

  // ë„·í¼ ê³„ì • ì²´í¬ (loginId, name, id ëª¨ë‘ í™•ì¸)
  const identifier = (user.loginId || user.name || user.id || '').toLowerCase();
  return identifier === 'ë„·í¼' || identifier === 'netform';
}

// ğŸ¯ ê¶Œí•œ ì—†ìŒ ì•Œë¦¼
function showNoPermission() {
  showToast('ğŸ‘€ ê²ŒìŠ¤íŠ¸ ê³„ì •ì€ ë³´ê¸°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  return false;
}

// ğŸ¯ ê¶Œí•œ ì²´í¬ ë˜í¼ - ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ì— ì‚¬ìš©
function requireEditPermission(callback) {
  if (!canEdit()) {
    showNoPermission();
    return;
  }
  callback();
}

// ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
function checkLoginStatus() {
  const isLoggedIn = sessionStorage.getItem('moyeora_admin_logged_in') === 'true';
  if (isLoggedIn) {
    showApp();
  } else {
    showLogin();
  }
}

// ìˆ«ì í¬ë§· (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
function formatNumber(num) {
  if (num === null || num === undefined) return '0';
  return Number(num).toLocaleString('ko-KR');
}

function showLogin() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app-wrapper').style.display = 'none';
  
  // ë§ˆì§„ê³„ì‚°ê¸° FAB ìˆ¨ê¸°ê¸°
  const fab = document.getElementById('margin-calc-fab');
  const fabLabel = document.getElementById('margin-calc-label');
  if (fab) fab.style.display = 'none';
  if (fabLabel) fabLabel.style.display = 'none';
  
  // ì €ì¥ëœ ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ë³µì›
  setTimeout(() => {
    const savedId = localStorage.getItem('moyeora_admin_saved_id');
    const savedPw = localStorage.getItem('moyeora_admin_saved_pw');
    const remember = localStorage.getItem('moyeora_admin_remember');
    
    if (remember === 'true' && savedId && savedPw) {
      const idInput = document.getElementById('admin-login-id');
      const pwInput = document.getElementById('admin-login-pw');
      const rememberCheckbox = document.getElementById('admin-remember-me');
      
      if (idInput) idInput.value = savedId;
      if (pwInput) pwInput.value = savedPw;
      if (rememberCheckbox) rememberCheckbox.checked = true;
    }
  }, 100);
}

function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-wrapper').style.display = 'block';

  // ë§ˆì§„ê³„ì‚°ê¸° FAB ë³´ì´ê¸°
  const fab = document.getElementById('margin-calc-fab');
  const fabLabel = document.getElementById('margin-calc-label');
  if (fab) fab.style.display = 'flex';
  if (fabLabel) fabLabel.style.display = 'block';

  // ë¡œê·¸ì¸ ì‚¬ìš©ì ë³µì›
  const savedUser = sessionStorage.getItem('moyeora_admin_user');
  if (savedUser) {
    try {
      state.currentAdmin = JSON.parse(savedUser);
      state.currentUser = state.currentAdmin;
    } catch (e) {}
  }

  // ğŸ¯ ë„·í¼ ê³„ì • ì œí•œ ëª¨ë“œ - ê³ ë„í™” ê¸°ëŠ¥ ìˆ¨ê¸°ê¸° (1ì£¼ì¼ ì „ ë²„ì „)
  if (isNetformAccount()) {
    // ê·¸ë¡œìŠ¤ë³´ë“œ OKR ë©”ë‰´ ìˆ¨ê¹€
    const okrSection = document.getElementById('okr-section');
    if (okrSection) okrSection.style.display = 'none';

    // ì˜ì—…í˜„í™© ë©”ë‰´ ìˆ¨ê¹€
    const salesDashboardSection = document.getElementById('sales-dashboard-section');
    if (salesDashboardSection) salesDashboardSection.style.display = 'none';

    // ëª¨ë°”ì¼ FAB (í€µë°°ë„ˆ) ìˆ¨ê¹€
    const mobileFab = document.getElementById('mobile-fab');
    if (mobileFab) mobileFab.style.display = 'none';
  }

  // ğŸ¯ ê²ŒìŠ¤íŠ¸ ë°°ë„ˆ í‘œì‹œ
  showGuestBannerIfNeeded();

  // ì‚¬ì´ë“œë°” ì‚¬ìš©ì í”„ë¡œí•„ ì—…ë°ì´íŠ¸
  updateSidebarUserProfile();

  // ğŸ¯ ì²« í˜ì´ì§€ë¥¼ ì˜ì—…í˜„í™©ìœ¼ë¡œ ì„¤ì • (ë„·í¼ ê³„ì • ì œì™¸)
  if (!isNetformAccount()) {
    switchTab('salesDashboard');
  } else {
    switchTab('calendar');
  }
}

// ğŸ¯ ê²ŒìŠ¤íŠ¸ ë°°ë„ˆ í‘œì‹œ
function showGuestBannerIfNeeded() {
  // ê¸°ì¡´ ë°°ë„ˆ ì œê±°
  const existingBanner = document.getElementById('guest-banner');
  if (existingBanner) existingBanner.remove();
  
  // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ í´ë˜ìŠ¤ ì œê±°
  document.body.classList.remove('guest-mode');
  
  const user = state.currentAdmin || state.currentUser;
  if (!user || user.role !== 'guest') return;
  
  // ğŸ¯ ê²ŒìŠ¤íŠ¸ ëª¨ë“œ í´ë˜ìŠ¤ ì¶”ê°€
  document.body.classList.add('guest-mode');
  
  const banner = document.createElement('div');
  banner.id = 'guest-banner';
  banner.innerHTML = `
    <div style="
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #fef3c7, #fde68a);
      color: #92400e;
      padding: 10px 20px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      z-index: 9999;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    ">
      ğŸ‘€ ê²ŒìŠ¤íŠ¸ ëª¨ë“œ - ë³´ê¸°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë“±ë¡/ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ì€ ì œí•œë©ë‹ˆë‹¤.
    </div>
  `;
  document.body.appendChild(banner);
  
  // app-wrapperì— ìƒë‹¨ íŒ¨ë”© ì¶”ê°€
  const appWrapper = document.getElementById('app-wrapper');
  if (appWrapper) {
    appWrapper.style.paddingTop = '44px';
  }
  
  // ğŸ¯ ê²ŒìŠ¤íŠ¸ ëª¨ë“œ: ì²´í¬ë°•ìŠ¤, ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì°¨ë‹¨
  setupGuestRestrictions();
}

// ğŸ¯ ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ì œí•œ ì„¤ì •
function setupGuestRestrictions() {
  // ì „ì—­ í´ë¦­ ì´ë²¤íŠ¸ ìº¡ì²˜
  document.addEventListener('click', function(e) {
    if (canEdit()) return; // ê¶Œí•œ ìˆìœ¼ë©´ í†µê³¼
    
    const target = e.target;
    
    // ì²´í¬ë°•ìŠ¤ í´ë¦­ ì°¨ë‹¨
    if (target.type === 'checkbox' || target.closest('label')?.querySelector('input[type="checkbox"]')) {
      e.preventDefault();
      e.stopPropagation();
      showNoPermission();
      return false;
    }
    
    // ìˆ˜ì •/ì‚­ì œ/ë“±ë¡ ë²„íŠ¼ ì°¨ë‹¨
    const btnText = target.textContent || '';
    const btnClass = target.className || '';
    if (
      btnText.includes('ìˆ˜ì •') || 
      btnText.includes('ì‚­ì œ') || 
      btnText.includes('ë“±ë¡') || 
      btnText.includes('ì €ì¥') ||
      btnText.includes('ì¶”ê°€') ||
      btnText.includes('ë³´ë‚´ê¸°') ||
      btnText.includes('ì™„ë£Œ') ||
      btnText.includes('ì·¨ì†Œ') ||
      btnClass.includes('btn-danger') ||
      target.closest('button')?.textContent?.includes('ìˆ˜ì •') ||
      target.closest('button')?.textContent?.includes('ì‚­ì œ')
    ) {
      // ë‹¨, ì¡°íšŒ/ê²€ìƒ‰/ë‹¤ìš´ë¡œë“œ/ë‹«ê¸°ëŠ” í—ˆìš©
      if (
        btnText.includes('ì¡°íšŒ') || 
        btnText.includes('ê²€ìƒ‰') || 
        btnText.includes('ë‹¤ìš´ë¡œë“œ') ||
        btnText.includes('Excel') ||
        btnText.includes('ë‹«ê¸°') ||
        btnText.includes('ì´ì „') ||
        btnText.includes('ë‹¤ìŒ')
      ) {
        return; // í—ˆìš©
      }
      
      if (target.tagName === 'BUTTON' || target.closest('button')) {
        e.preventDefault();
        e.stopPropagation();
        showNoPermission();
        return false;
      }
    }
  }, true); // ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ì²˜ë¦¬
  
  // ì „ì—­ change ì´ë²¤íŠ¸ ìº¡ì²˜ (ì²´í¬ë°•ìŠ¤, select ë“±)
  document.addEventListener('change', function(e) {
    if (canEdit()) return;
    
    const target = e.target;
    if (target.type === 'checkbox' || target.tagName === 'SELECT') {
      // í•„í„°ìš© selectëŠ” í—ˆìš© (ê²€ìƒ‰/í•„í„° ê¸°ëŠ¥)
      if (target.id?.includes('filter') || target.id?.includes('Filter') || target.id?.includes('search')) {
        return;
      }
      
      e.preventDefault();
      e.stopPropagation();
      
      // ì²´í¬ë°•ìŠ¤ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
      if (target.type === 'checkbox') {
        target.checked = !target.checked;
      }
      
      showNoPermission();
      return false;
    }
  }, true);
  
  // íŒŒì¼ ì—…ë¡œë“œ ì°¨ë‹¨
  document.addEventListener('change', function(e) {
    if (canEdit()) return;
    
    if (e.target.type === 'file') {
      e.preventDefault();
      e.stopPropagation();
      e.target.value = '';
      showNoPermission();
      return false;
    }
  }, true);
}

// ì‚¬ì´ë“œë°” ì‚¬ìš©ì í”„ë¡œí•„ ì—…ë°ì´íŠ¸
function updateSidebarUserProfile() {
  const user = state.currentUser;
  if (!user) return;
  
  // ì´ë¦„
  document.getElementById('userName').textContent = user.name || '-';
  
  // ì—­í• 
  const roleText = user.role === 'admin' ? 'ê´€ë¦¬ì' : user.role === 'manager' ? 'ë§¤ë‹ˆì €' : user.role === 'guest' ? 'ê²ŒìŠ¤íŠ¸' : 'ì¼ë°˜';
  document.getElementById('userRole').textContent = roleText;
  
  // ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚°
  calculateUserGoalRate();
}

// ì‚¬ìš©ì ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚° (ì˜ì—…í˜„í™©ê³¼ ë™ì¼í•œ ë¡œì§)
function calculateUserGoalRate() {
  const user = state.currentUser;
  if (!user) return;

  // ëª©í‘œ ë°ì´í„°
  const goals = state.salesGoals || {};
  const memberGoals = goals.memberGoals || {};
  const myGoal = memberGoals[user.id] || memberGoals[user.loginId] || {};

  // ë‹´ë‹¹ ì…€ëŸ¬ ëª©ë¡ (ì˜ì—…í˜„í™©ê³¼ ë™ì¼í•œ ë°©ì‹)
  const mySellers = (state.sellers || []).filter(s => s.registeredBy === user.id);
  const sellerNames = mySellers.map(s => s.name).filter(Boolean);

  // ì •ì‚° ë°ì´í„° ì—°ë™ (ì˜ì—…í˜„í™©ê³¼ ë™ì¼í•œ ë°©ì‹)
  const allSettlements = state.sellerSettlements || [];
  const mySettlements = allSettlements.filter(s => {
    // 1. registeredByë¡œ ì§ì ‘ ì—°ê²°
    if (s.registeredBy === user.id) return true;
    // 2. ë‹´ë‹¹ ì…€ëŸ¬ ì´ë¦„ìœ¼ë¡œ ì—°ê²°
    const settlementSellerName = s.sellerName || '';
    return sellerNames.some(name => {
      if (!name) return false;
      const namePart = name.split('/')[0];
      return settlementSellerName.includes(namePart) || settlementSellerName.includes(name);
    });
  });

  const mySales = mySettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);

  // ê°œì¸ ëª©í‘œ ì‚¬ìš©
  const targetSales = myGoal.salesAmount || 0;

  let rate = 0;
  if (targetSales > 0) {
    rate = (mySales / targetSales) * 100;
  }

  const rateEl = document.getElementById('userGoalRate');
  if (rateEl) rateEl.textContent = rate.toFixed(2) + '%';
}

async function handleAdminLogin(e) {
  if (e) e.preventDefault();

  try {
    const loginId = document.getElementById('admin-login-id')?.value?.trim();
    const loginPw = document.getElementById('admin-login-pw')?.value;
    const rememberMe = document.getElementById('admin-remember-me')?.checked;
    const loginBtn = document.getElementById('admin-login-btn');
    const errorMsg = document.getElementById('admin-login-error');

    if (!loginId || !loginPw) {
      alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì—ëŸ¬ ìˆ¨ê¸°ê¸°
    if (errorMsg) errorMsg.classList.remove('show');

    // ë¡œë”© ìƒíƒœ
    if (loginBtn) {
      loginBtn.classList.add('loading');
      loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
    }

    // ì•½ê°„ì˜ ë”œë ˆì´ (UX)
    await new Promise(r => setTimeout(r, 300));

  // ë§ˆìŠ¤í„° ê³„ì • í™•ì¸
  if (loginId === 'admin' && loginPw === 'ahdufk124!') {
    // ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥
    if (rememberMe) {
      localStorage.setItem('moyeora_admin_saved_id', loginId);
      localStorage.setItem('moyeora_admin_saved_pw', loginPw);
      localStorage.setItem('moyeora_admin_remember', 'true');
    } else {
      localStorage.removeItem('moyeora_admin_saved_id');
      localStorage.removeItem('moyeora_admin_saved_pw');
      localStorage.removeItem('moyeora_admin_remember');
    }
    sessionStorage.setItem('moyeora_admin_logged_in', 'true');
    sessionStorage.setItem('moyeora_admin_user', JSON.stringify({ id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin' }));
    state.currentAdmin = { id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin' };
    state.currentUser = state.currentAdmin;
    showApp();
    return;
  }

    // íŒ€ì› ê³„ì • í™•ì¸ - Firebaseì—ì„œ ì§ì ‘ ë¡œë“œ
    const teamSnapshot = await db.collection('teamMembers').get();
    const teamMembers = [];
    teamSnapshot.forEach(doc => {
      teamMembers.push({ id: doc.id, ...doc.data() });
    });

    // ë””ë²„ê¹…: ë¡œë“œëœ íŒ€ì› ì •ë³´ í™•ì¸
    console.log('ğŸ” ë¡œë“œëœ íŒ€ì› ìˆ˜:', teamMembers.length);
    console.log('ğŸ” íŒ€ì› ëª©ë¡:', teamMembers.map(m => ({ ì´ë¦„: m.name, ì•„ì´ë””: m.loginId })));
    console.log('ğŸ” ì…ë ¥í•œ ID:', loginId);

    // íŒ€ì›ì´ ì—†ìœ¼ë©´ ì•Œë¦¼
    if (teamMembers.length === 0) {
      alert('âš ï¸ Firebaseì—ì„œ íŒ€ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      loginBtn.classList.remove('loading');
      loginBtn.textContent = 'ë¡œê·¸ì¸';
      return;
    }

    const teamMember = teamMembers.find(m => m.loginId === loginId && m.loginPw === loginPw);

    if (teamMember) {
      // ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥
      if (rememberMe) {
        localStorage.setItem('moyeora_admin_saved_id', loginId);
        localStorage.setItem('moyeora_admin_saved_pw', loginPw);
        localStorage.setItem('moyeora_admin_remember', 'true');
      } else {
        localStorage.removeItem('moyeora_admin_saved_id');
        localStorage.removeItem('moyeora_admin_saved_pw');
        localStorage.removeItem('moyeora_admin_remember');
      }
      // ë¡œê·¸ì¸ ì„±ê³µ
      sessionStorage.setItem('moyeora_admin_logged_in', 'true');
      sessionStorage.setItem('moyeora_admin_user', JSON.stringify({ id: teamMember.id, name: teamMember.name, role: teamMember.role, loginId: teamMember.loginId, email: teamMember.email }));
      state.currentAdmin = { id: teamMember.id, name: teamMember.name, role: teamMember.role, loginId: teamMember.loginId, email: teamMember.email };
      state.currentUser = state.currentAdmin;
      showApp();

      // ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš© ì¤‘ì´ë©´ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
      if (teamMember.needPasswordChange) {
        setTimeout(() => {
          showToast('âš ï¸ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.');
        }, 500);
      }
    } else {
      // ë¡œê·¸ì¸ ì‹¤íŒ¨
      loginBtn.classList.remove('loading');
      loginBtn.textContent = 'ë¡œê·¸ì¸';
      errorMsg.classList.add('show');
      document.getElementById('admin-login-pw').value = '';
    }
  } catch (error) {
    console.error('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
    loginBtn.classList.remove('loading');
    loginBtn.textContent = 'ë¡œê·¸ì¸';
    errorMsg.classList.add('show');
    document.getElementById('admin-login-pw').value = '';
  }
}

function handleAdminLogout() {
  if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    sessionStorage.removeItem('moyeora_admin_logged_in');
    sessionStorage.removeItem('moyeora_admin_user');
    state.currentAdmin = null;
    showLogin();
    document.getElementById('admin-login-id').value = '';
    document.getElementById('admin-login-pw').value = '';
  }
}

// í•„ìˆ˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ (ì²« ë¡œê·¸ì¸ ì‹œ)
function showMustChangePasswordModal() {
  const currentUser = state.currentAdmin || state.currentUser || {};
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 420px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìš”</h2>
      </div>
      <form onsubmit="saveMustChangePassword(event)">
        <div style="padding: 20px;">
          <div style="background: #fef3c7; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <p style="font-size: 14px; color: #92400e; margin: 0;">
              âš ï¸ ê´€ë¦¬ìê°€ ë°œê¸‰í•œ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.<br>
              ë³´ì•ˆì„ ìœ„í•´ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
            </p>
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" class="form-input" id="must-new-pw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required minlength="4">
          </div>

          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" class="form-input" id="must-new-pw-confirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" required>
          </div>

          <div id="must-pw-error" style="color: var(--danger); font-size: 13px; margin-top: 12px; display: none;"></div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" style="width: 100%;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>
      </form>
    </div>
  `;
}

// í•„ìˆ˜ ë¹„ë°€ë²ˆí˜¸ ì €ì¥
async function saveMustChangePassword(e) {
  e.preventDefault();

  const currentUser = state.currentAdmin || state.currentUser || {};
  const newPw = document.getElementById('must-new-pw').value;
  const confirmPw = document.getElementById('must-new-pw-confirm').value;
  const errorEl = document.getElementById('must-pw-error');

  if (newPw !== confirmPw) {
    errorEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }

  if (newPw.length < 4) {
    errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }

  try {
    await db.collection('teamMembers').doc(currentUser.id).update({
      loginPw: newPw,
      needPasswordChange: false,
      updatedAt: new Date().toISOString()
    });

    // ì„¸ì…˜ ì—…ë°ì´íŠ¸
    state.currentAdmin.needPasswordChange = false;
    sessionStorage.setItem('moyeora_admin_user', JSON.stringify(state.currentAdmin));

    showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (err) {
    console.error(err);
    errorEl.textContent = 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    errorEl.style.display = 'block';
  }
}

// 6ìë¦¬ ì¸ì¦ì½”ë“œ ìƒì„±
function generateVerificationCode() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬
function showChangePasswordModal() {
  const modal = document.getElementById('modal');
  modal.className = 'modal show';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 420px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
        <button class="modal-close" onclick="closeChangePasswordModal()">Ã—</button>
      </div>
      
      <!-- Step 1: ì´ë©”ì¼ ì¸ì¦ ìš”ì²­ -->
      <div id="pw-change-step1">
        <div style="padding: 20px;">
          <div style="background: var(--info-light); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <p style="font-size: 14px; color: var(--info);">
              ğŸ“§ ë“±ë¡ëœ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.
            </p>
            <p style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">
              ${ADMIN_EMAIL.replace(/(.{3}).*(@.*)/, '$1***$2')}
            </p>
          </div>
          
          <div id="send-error" style="color: var(--danger); font-size: 13px; margin-bottom: 12px; display: none;">
            ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="send-code-btn" onclick="sendVerificationEmail()">
            ğŸ“§ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
          </button>
        </div>
      </div>
      
      <!-- Step 2: ì¸ì¦ë²ˆí˜¸ ì…ë ¥ -->
      <div id="pw-change-step2" style="display: none;">
        <div style="padding: 20px;">
          <div style="background: var(--success-light); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
            <span style="font-size: 24px;">ğŸ“¬</span>
            <p style="color: var(--success); font-weight: 600; margin-top: 8px;">ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤</p>
            <p style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš” (ìŠ¤íŒ¸í•¨ë„ í™•ì¸)</p>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì¸ì¦ë²ˆí˜¸ 6ìë¦¬</label>
            <input type="text" class="form-input" id="verify-code-input" maxlength="6" placeholder="000000" style="text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: 700;">
          </div>
          
          <div id="verify-error" style="color: var(--danger); font-size: 13px; margin-bottom: 12px; display: none;">
            ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
          
          <div style="text-align: center; margin-top: 12px;">
            <button type="button" onclick="sendVerificationEmail()" style="background: none; border: none; color: var(--info); font-size: 13px; cursor: pointer; text-decoration: underline;">
              ì¸ì¦ë²ˆí˜¸ ì¬ë°œì†¡
            </button>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="verifyCode()">í™•ì¸</button>
        </div>
      </div>
      
      <!-- Step 3: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
      <div id="pw-change-step3" style="display: none;">
        <div style="padding: 20px;">
          <div style="background: var(--success-light); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
            <span style="font-size: 24px;">âœ…</span>
            <p style="color: var(--success); font-weight: 600; margin-top: 8px;">ì¸ì¦ ì™„ë£Œ</p>
          </div>
          
          <div class="form-group">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" class="form-input" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          </div>
          
          <div class="form-group">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" class="form-input" id="new-password-confirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥">
          </div>
          
          <div id="pw-match-error" style="color: var(--danger); font-size: 13px; display: none;">
            ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="changePassword()">ë³€ê²½í•˜ê¸°</button>
        </div>
      </div>
    </div>
  `;
}

function closeChangePasswordModal() {
  document.getElementById('modal').className = 'modal';
  verificationCode = '';
}

// ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
async function sendVerificationEmail() {
  const sendBtn = document.getElementById('send-code-btn');
  const errorEl = document.getElementById('send-error');
  
  if (sendBtn) {
    sendBtn.disabled = true;
    sendBtn.innerHTML = 'ë°œì†¡ ì¤‘...';
  }
  
  // ì¸ì¦ë²ˆí˜¸ ìƒì„±
  verificationCode = generateVerificationCode();
  
  try {
    // EmailJS ì´ˆê¸°í™” í™•ì¸
    if (EMAILJS_CONFIG.publicKey === 'YOUR_PUBLIC_KEY') {
      // EmailJS ë¯¸ì„¤ì • ì‹œ - ì½˜ì†”ì— ì¸ì¦ë²ˆí˜¸ ì¶œë ¥ (ê°œë°œìš©)
      console.log('========================================');
      console.log('ğŸ“§ ì¸ì¦ë²ˆí˜¸:', verificationCode);
      console.log('(EmailJS ì„¤ì • í›„ ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ë©ë‹ˆë‹¤)');
      console.log('========================================');
      
      // ê°œë°œ ëª¨ë“œì—ì„œëŠ” ë°”ë¡œ step2ë¡œ ì´ë™
      document.getElementById('pw-change-step1').style.display = 'none';
      document.getElementById('pw-change-step2').style.display = 'block';
      return;
    }
    
    // EmailJSë¡œ ì´ë©”ì¼ ë°œì†¡
    emailjs.init(EMAILJS_CONFIG.publicKey);
    
    await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, {
      to_email: ADMIN_EMAIL,
      verification_code: verificationCode,
      message: `ëª¨ì—¬ë¼ë”œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¸ì¦ë²ˆí˜¸: ${verificationCode}`
    });
    
    // step2ë¡œ ì´ë™
    document.getElementById('pw-change-step1').style.display = 'none';
    document.getElementById('pw-change-step2').style.display = 'block';
    
  } catch (e) {
    console.error('ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:', e);
    if (errorEl) {
      errorEl.style.display = 'block';
    }
    if (sendBtn) {
      sendBtn.disabled = false;
      sendBtn.innerHTML = 'ğŸ“§ ì¸ì¦ë²ˆí˜¸ ë°œì†¡';
    }
  }
}

// ì¸ì¦ë²ˆí˜¸ í™•ì¸
function verifyCode() {
  const inputCode = document.getElementById('verify-code-input').value.trim();
  const errorEl = document.getElementById('verify-error');
  
  if (inputCode === verificationCode) {
    // ì¸ì¦ ì„±ê³µ
    document.getElementById('pw-change-step2').style.display = 'none';
    document.getElementById('pw-change-step3').style.display = 'block';
  } else {
    // ì¸ì¦ ì‹¤íŒ¨
    errorEl.style.display = 'block';
  }
}

async function changePassword() {
  const newPw = document.getElementById('new-password').value;
  const confirmPw = document.getElementById('new-password-confirm').value;
  const errorEl = document.getElementById('pw-match-error');
  
  if (newPw !== confirmPw) {
    errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }
  
  if (newPw.length < 4) {
    errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }
  
  try {
    // Firebaseì— ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì €ì¥
    await db.collection('settings').doc('admin').set({
      password: newPw,
      updatedAt: new Date().toISOString()
    }, { merge: true });
    
    adminPassword = newPw;
    verificationCode = '';
    
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
    closeChangePasswordModal();
    
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    sessionStorage.removeItem('moyeora_admin_logged_in');
    showLogin();
  } catch (e) {
    alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error(e);
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
document.addEventListener('DOMContentLoaded', () => {
  loadAdminPassword();
  checkLoginStatus();

  // ì¹´í˜24 ìë™ ë™ê¸°í™” ì´ˆê¸°í™” (ë¡œê·¸ì¸ í›„ ì‹¤í–‰)
  setTimeout(() => {
    if (state.isLoggedIn) {
      initCafe24AutoSync();
    }
  }, 2000); // 2ì´ˆ í›„ ì‹¤í–‰ (Firebase ë¡œë“œ ëŒ€ê¸°)
});

// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
  authDomain: "moyeora-deal-manager.firebaseapp.com",
  projectId: "moyeora-deal-manager",
  storageBucket: "moyeora-deal-manager.firebasestorage.app",
  messagingSenderId: "527148187832",
  appId: "1:527148187832:web:dc35b0413a7157db34744d",
  measurementId: "G-XEGLCEG93R"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ìƒíƒœ ê´€ë¦¬
let state = {
  currentTab: 'calendar',
  currentDate: new Date(),
  deals: [],
  suppliers: [],
  sellers: [],
  sellerList: [],
  productList: [],
  products: [],
  viewFilter: 'all',
  selectedSupplier: '',
  selectedSeller: '',
  loading: true,
  // ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œìš© ë°ì´í„°
  sellerSettlements: [],
  supplierSettlements: [],
  settlementBrands: [],
  supplierProducts: [],
  // íŒŒíŠ¸ë„ˆ ê´€ë¦¬ ë°ì´í„°
  partnerMessages: [],
  partnerNotices: [],
  dealSuggestions: [],
  adminProposals: [],
  sellerProposals: [],
  // íŒ€ì› ê´€ë¦¬
  teamMembers: [],
  // ê¸´ê¸‰íŒë§¤ìš”ì²­
  urgentSales: [],
  // ì˜ì—… ëª©í‘œ
  salesGoals: {},
  memberGoals: {},
  // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì
  currentAdmin: null,
  currentUser: null
};

// ìƒìˆ˜
const STATUS = {
  negotiating: { label: 'í˜‘ì˜ì¤‘', class: 'status-negotiating' },
  confirmed: { label: 'í˜‘ì˜ì™„ë£Œ', class: 'status-confirmed' },
  ongoing: { label: 'ì§„í–‰ì¤‘', class: 'status-ongoing' },
  completed: { label: 'ì§„í–‰ì™„ë£Œ', class: 'status-completed' }
};

// ë‚ ì§œ ê¸°ë°˜ ìë™ ìƒíƒœ ê³„ì‚° í•¨ìˆ˜
function getAutoStatus(deal) {
  // í˜‘ì˜ì¤‘ì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€
  if (deal.status === 'negotiating') return 'negotiating';
  
  // í˜‘ì˜ì™„ë£Œ ì´í›„ëŠ” ë‚ ì§œ ê¸°ë°˜ìœ¼ë¡œ ìë™ ê²°ì •
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const start = new Date(deal.startDate);
  start.setHours(0, 0, 0, 0);
  const end = new Date(deal.endDate);
  end.setHours(0, 0, 0, 0);
  
  if (today < start) {
    return 'confirmed'; // ì§„í–‰ì˜ˆì • (í˜‘ì˜ì™„ë£Œ ìƒíƒœë¡œ í‘œì‹œ, ì‹¤ì œ ë¼ë²¨ì€ ì§„í–‰ì˜ˆì •)
  } else if (today >= start && today <= end) {
    return 'ongoing'; // ì§„í–‰ì¤‘
  } else {
    return 'completed'; // ì§„í–‰ì™„ë£Œ
  }
}

// í‘œì‹œìš© ìƒíƒœ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
function getDisplayStatus(deal) {
  if (deal.status === 'negotiating') {
    return { label: 'í˜‘ì˜ì¤‘', class: 'status-negotiating' };
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const start = new Date(deal.startDate);
  start.setHours(0, 0, 0, 0);
  const end = new Date(deal.endDate);
  end.setHours(0, 0, 0, 0);
  
  if (today < start) {
    return { label: 'ì§„í–‰ì˜ˆì •', class: 'status-confirmed' };
  } else if (today >= start && today <= end) {
    return { label: 'ì§„í–‰ì¤‘', class: 'status-ongoing' };
  } else {
    return { label: 'ì§„í–‰ì™„ë£Œ', class: 'status-completed' };
  }
}

const MONTHS = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
const WEEKDAYS = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
const formatDate = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

const formatDateKR = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
};

const parseDate = (str) => str ? new Date(str + 'T00:00:00') : null;
const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

const showToast = (msg) => {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 2500);
};

// Firebase ë¦¬ìŠ¤ë„ˆ
function setupListeners() {
  db.collection('deals').orderBy('startDate', 'desc').onSnapshot(snapshot => {
    state.deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('suppliers').orderBy('name').onSnapshot(snapshot => {
    state.suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('sellers').orderBy('name').onSnapshot(snapshot => {
    state.sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('sellerList').orderBy('accountName').onSnapshot(snapshot => {
    state.sellerList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('productList').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.productList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('products').orderBy('order').onSnapshot(snapshot => {
    state.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    state.loading = false;
    render();
  });
  
  // ì…€ëŸ¬ ì •ì‚°ì„œ
  db.collection('sellerSettlements').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.sellerSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ê³µê¸‰ì‚¬ ì •ì‚°ì„œ
  db.collection('supplierSettlements').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.supplierSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ë¸Œëœë“œ(ê³µê¸‰ì‚¬) ëª©ë¡
  db.collection('settlementBrands').orderBy('name').onSnapshot(snapshot => {
    state.settlementBrands = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ê³µê¸‰ì‚¬ ìƒí’ˆ ëª©ë¡
  db.collection('supplierProducts').orderBy('brandName').onSnapshot(snapshot => {
    state.supplierProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // íŒŒíŠ¸ë„ˆ ë©”ì‹œì§€
  db.collection('partnerMessages').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.partnerMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    updateUnreadBadge();
    render();
  });
  
  // íŒŒíŠ¸ë„ˆ ê³µì§€ì‚¬í•­
  db.collection('partnerNotices').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.partnerNotices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ê³µêµ¬ ì œì•ˆ
  db.collection('dealSuggestions').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.dealSuggestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ì–´ë“œë¯¼ì´ ì…€ëŸ¬ì—ê²Œ ë³´ë‚¸ ì œì•ˆ
  db.collection('adminProposals').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.adminProposals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // íŒ€ì› ê´€ë¦¬
  db.collection('teamMembers').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ê¸´ê¸‰íŒë§¤ìš”ì²­
  db.collection('urgentSales').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.urgentSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ì…€ëŸ¬ ì œì•ˆ (sellerProposals)
  db.collection('sellerProposals').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.sellerProposals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ì˜ì—… ëª©í‘œ ì„¤ì •
  db.collection('settings').doc('salesGoals').onSnapshot(doc => {
    if (doc.exists) {
      state.salesGoals = doc.data();
    }
    render();
  });
  
  // íŒ€ì›ë³„ ëª©í‘œ ì„¤ì •
  db.collection('settings').doc('memberGoals').onSnapshot(doc => {
    if (doc.exists) {
      state.memberGoals = doc.data().goals || {};
    }
    render();
  });
}

// ì•ˆì½ì€ ë©”ì‹œì§€ ë±ƒì§€ ì—…ë°ì´íŠ¸
function updateUnreadBadge() {
  const unreadCount = state.partnerMessages.filter(m => !m.isAdmin && !m.isRead).length;
  const badge = document.getElementById('unread-badge');
  if (badge) {
    badge.textContent = unreadCount;
    badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
  }
}

// CRUD
async function saveDeal(data) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  try {
    if (data.id) {
      await db.collection('deals').doc(data.id).update(data);
    } else {
      delete data.id;
      await db.collection('deals').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteDeal(id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('deals').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function saveSupplier(data) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  try {
    if (data.id) {
      await db.collection('suppliers').doc(data.id).update(data);
    } else {
      delete data.id;
      await db.collection('suppliers').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteSupplier(id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('suppliers').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function saveSeller(data) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  try {
    if (data.id) {
      await db.collection('sellers').doc(data.id).update(data);
    } else {
      delete data.id;
      await db.collection('sellers').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteSeller(id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('sellers').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function updateSettlement(dealId, field, value) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  try {
    await db.collection('deals').doc(dealId).update({ [field]: value });
    showToast('ì •ì‚° ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch(e) {
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ ì„¤ì •
let ADMIN_PASSWORD = localStorage.getItem('moyeora_admin_password') || 'elf124!';
const adminTabs = ['salesReport'];  // ê´€ë¦¬ì ë©”ë‰´ë§Œ ë¹„ë°€ë²ˆí˜¸ í•„ìš”
let isAdminUnlocked = sessionStorage.getItem('adminUnlocked') === 'true';
let adminMenuOpen = false;
let dealMenuOpen = true;  // ì´ˆê¸° ì—´ë¦° ìƒíƒœ
let partnerMenuOpen = true;  // ì´ˆê¸° ì—´ë¦° ìƒíƒœ
let supplierMenuOpen = true;  // ì´ˆê¸° ì—´ë¦° ìƒíƒœ
let sellerMenuOpen = true;  // ì´ˆê¸° ì—´ë¦° ìƒíƒœ

// ê³µêµ¬ê´€ë¦¬ ë©”ë‰´ í† ê¸€
function toggleDealMenu() {
  dealMenuOpen = !dealMenuOpen;
  const submenu = document.getElementById('deal-submenu');
  const arrow = document.getElementById('deal-menu-arrow');
  
  if (submenu) {
    submenu.style.display = dealMenuOpen ? 'block' : 'none';
    arrow.style.transform = dealMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

// íŒŒíŠ¸ë„ˆ ê´€ë¦¬ ë©”ë‰´ í† ê¸€
function togglePartnerMenu() {
  partnerMenuOpen = !partnerMenuOpen;
  const submenu = document.getElementById('partner-submenu');
  const arrow = document.getElementById('partner-menu-arrow');
  
  if (submenu) {
    submenu.style.display = partnerMenuOpen ? 'block' : 'none';
    arrow.style.transform = partnerMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

// ê³µê¸‰ì‚¬ ê´€ë¦¬ ë©”ë‰´ í† ê¸€ (3ì¤‘ í•˜ìœ„)
function toggleSupplierMenu(event) {
  if (event) event.stopPropagation();
  supplierMenuOpen = !supplierMenuOpen;
  const submenu = document.getElementById('supplier-submenu');
  const arrow = document.getElementById('supplier-menu-arrow');
  
  if (submenu) {
    submenu.style.display = supplierMenuOpen ? 'block' : 'none';
    arrow.style.transform = supplierMenuOpen ? 'rotate(90deg)' : 'rotate(0deg)';
  }
}

// ì…€ëŸ¬ ê´€ë¦¬ ë©”ë‰´ í† ê¸€ (3ì¤‘ í•˜ìœ„)
function toggleSellerMenu(event) {
  if (event) event.stopPropagation();
  sellerMenuOpen = !sellerMenuOpen;
  const submenu = document.getElementById('seller-submenu');
  const arrow = document.getElementById('seller-menu-arrow');
  
  if (submenu) {
    submenu.style.display = sellerMenuOpen ? 'block' : 'none';
    arrow.style.transform = sellerMenuOpen ? 'rotate(90deg)' : 'rotate(0deg)';
  }
}

// ê´€ë¦¬ì ë©”ë‰´ í† ê¸€ (ê´€ë¦¬ì ê¶Œí•œ í•„ìš”)
function toggleAdminMenu() {
  const currentUser = state.currentAdmin || state.currentUser || {};

  // ê´€ë¦¬ì ì—­í• ë§Œ ì ‘ê·¼ ê°€ëŠ¥
  if (currentUser.role !== 'admin') {
    showToast('ğŸ”’ ê´€ë¦¬ì ê³„ì •ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }

  if (!isAdminUnlocked) {
    showAdminPasswordModal();
    return;
  }

  adminMenuOpen = !adminMenuOpen;
  const submenu = document.getElementById('admin-submenu');
  const arrow = document.getElementById('admin-menu-arrow');

  if (submenu) {
    submenu.style.display = adminMenuOpen ? 'block' : 'none';
    arrow.style.transform = adminMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

// ê³ ê¸‰ ì„¤ì • í† ê¸€
function toggleAdvancedAdminMenu() {
  const submenu = document.getElementById('advanced-admin-submenu');
  if (submenu) {
    const isHidden = submenu.style.display === 'none';
    submenu.style.display = isHidden ? 'block' : 'none';
  }
}

// ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬
function showAdminPasswordModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ” ê´€ë¦¬ì ì¸ì¦</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="background: var(--gray-100); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
        <p style="color: var(--gray-600); font-size: 13px; margin: 0;">ê´€ë¦¬ì ë©”ë‰´ì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      </div>
      <form onsubmit="checkAdminPassword(event)">
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" class="form-input" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required autofocus>
        </div>
        <div id="admin-password-error" style="color: var(--danger); font-size: 14px; margin-bottom: 12px; display: none;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">í™•ì¸</button>
        </div>
      </form>
    </div>
  `;
  
  setTimeout(() => document.getElementById('admin-password').focus(), 100);
}

// ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
function checkAdminPassword(e) {
  e.preventDefault();
  const password = document.getElementById('admin-password').value;
  
  if (password === ADMIN_PASSWORD) {
    isAdminUnlocked = true;
    sessionStorage.setItem('adminUnlocked', 'true');
    closeModal();
    showToast('âœ… ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ');
    
    // ë©”ë‰´ ì—´ê¸°
    adminMenuOpen = true;
    const submenu = document.getElementById('admin-submenu');
    const arrow = document.getElementById('admin-menu-arrow');
    if (submenu) {
      submenu.style.display = 'block';
      arrow.style.transform = 'rotate(180deg)';
    }
  } else {
    document.getElementById('admin-password-error').style.display = 'block';
    document.getElementById('admin-password').value = '';
    document.getElementById('admin-password').focus();
  }
}

// ê´€ë¦¬ì ì„¤ì • ëª¨ë‹¬ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¬í•¨)
function openAdminSettings() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="padding: 16px; background: var(--gray-50); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ“Š ì‹œìŠ¤í…œ í˜„í™©</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
            <div>ê³µê¸‰ì‚¬: <strong>${state.suppliers.length}</strong>ê°œ</div>
            <div>ì…€ëŸ¬: <strong>${state.sellers.length}</strong>ëª…</div>
            <div>ê³µêµ¬: <strong>${state.deals.length}</strong>ê±´</div>
            <div>ìƒí’ˆ DB: <strong>${state.productDB.length}</strong>ê°œ</div>
          </div>
        </div>
        
        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„¹ì…˜ -->
        <div style="padding: 16px; background: var(--white); border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="form-group" style="margin-bottom: 12px;">
            <label class="form-label" style="font-size: 13px;">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="current-password" class="form-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          </div>
          <div class="form-group" style="margin-bottom: 12px;">
            <label class="form-label" style="font-size: 13px;">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="new-password" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          </div>
          <div class="form-group" style="margin-bottom: 12px;">
            <label class="form-label" style="font-size: 13px;">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="confirm-password" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥">
          </div>
          <div id="password-error" style="display: none; color: var(--danger); font-size: 13px; margin-bottom: 12px;"></div>
          <button class="btn btn-primary" style="width: 100%;" onclick="changeAdminPassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>
        
        <div style="padding: 16px; background: var(--info-light); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--info);">ğŸ’¡ ë„ì›€ë§</div>
          <ul style="font-size: 13px; color: var(--gray-600); margin-left: 16px;">
            <li>ë°ì´í„°ëŠ” Firebaseì— ìë™ ì €ì¥ë©ë‹ˆë‹¤</li>
            <li>ë°±ì—…ì€ ì •ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ì„¸ìš”</li>
            <li>ë¹„ë°€ë²ˆí˜¸ëŠ” ì•ˆì „í•œ ê³³ì— ë³´ê´€í•˜ì„¸ìš”</li>
          </ul>
        </div>
        
        <button class="btn btn-secondary" style="width: 100%;" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•¨ìˆ˜
function changeAdminPassword() {
  const currentPw = document.getElementById('current-password').value;
  const newPw = document.getElementById('new-password').value;
  const confirmPw = document.getElementById('confirm-password').value;
  const errorDiv = document.getElementById('password-error');
  
  // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  if (currentPw !== ADMIN_PASSWORD) {
    errorDiv.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorDiv.style.display = 'block';
    return;
  }
  
  // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
  if (newPw.length < 4) {
    errorDiv.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    errorDiv.style.display = 'block';
    return;
  }
  
  if (newPw !== confirmPw) {
    errorDiv.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorDiv.style.display = 'block';
    return;
  }
  
  // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (localStorageì— ì €ì¥)
  localStorage.setItem('moyeora_admin_password', newPw);
  ADMIN_PASSWORD = newPw;
  
  closeModal();
  showToast('âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ë°ì´í„° ë°±ì—… (ë‚´ë³´ë‚´ê¸°)
function exportAllData() {
  const exportData = {
    exportDate: new Date().toISOString(),
    suppliers: state.suppliers,
    sellers: state.sellers,
    sellerList: state.sellerList,
    deals: state.deals,
    productDB: state.productDB,
    dealSuggestions: state.dealSuggestions
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `moyeoradeal_backup_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… ë°ì´í„° ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ë°ì´í„° ë³µì› ëª¨ë‹¬
function openRestoreModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‚ ë°ì´í„° ë³µì›</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="padding: 16px; background: var(--danger-light); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; color: var(--danger); margin-bottom: 8px;">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
          <ul style="font-size: 13px; color: var(--gray-700); margin-left: 16px;">
            <li>ë³µì› ì‹œ í˜„ì¬ ë°ì´í„°ê°€ <strong>ëª¨ë‘ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤</strong></li>
            <li>ë³µì› ì „ ë°˜ë“œì‹œ <strong>í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…</strong>í•˜ì„¸ìš”</li>
            <li>JSON í˜•ì‹ì˜ ë°±ì—… íŒŒì¼ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
          </ul>
        </div>
        
        <div class="form-group">
          <label class="form-label">ë°±ì—… íŒŒì¼ ì„ íƒ</label>
          <input type="file" id="restore-file" accept=".json" class="form-input" style="padding: 10px;">
        </div>
        
        <div id="restore-preview" style="display: none; padding: 16px; background: var(--gray-50); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ“‹ ë³µì›í•  ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</div>
          <div id="restore-preview-content" style="font-size: 13px;"></div>
        </div>
        
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" style="flex: 1;" id="restore-btn" onclick="restoreData()" disabled>ë³µì›í•˜ê¸°</button>
        </div>
      </div>
    </div>
  `;
  
  // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
  document.getElementById('restore-file').addEventListener('change', previewRestoreFile);
}

// ë³µì› íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
function previewRestoreFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const data = JSON.parse(event.target.result);
      window.restoreData = data;
      
      const preview = document.getElementById('restore-preview');
      const content = document.getElementById('restore-preview-content');
      
      content.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div>ë°±ì—…ì¼ì‹œ: <strong>${new Date(data.exportDate).toLocaleString('ko-KR')}</strong></div>
          <div>ê³µê¸‰ì‚¬: <strong>${data.suppliers?.length || 0}</strong>ê°œ</div>
          <div>ì…€ëŸ¬: <strong>${data.sellers?.length || 0}</strong>ëª…</div>
          <div>ê³µêµ¬: <strong>${data.deals?.length || 0}</strong>ê±´</div>
          <div>ìƒí’ˆ DB: <strong>${data.productDB?.length || 0}</strong>ê°œ</div>
          <div>ì œì•ˆ: <strong>${data.dealSuggestions?.length || 0}</strong>ê±´</div>
        </div>
      `;
      
      preview.style.display = 'block';
      document.getElementById('restore-btn').disabled = false;
    } catch (err) {
      showToast('âŒ ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
      document.getElementById('restore-btn').disabled = true;
    }
  };
  reader.readAsText(file);
}

// ë°ì´í„° ë³µì› ì‹¤í–‰
async function restoreData() {
  if (!window.restoreData) {
    showToast('âŒ ë³µì›í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!confirm('ì •ë§ ë°ì´í„°ë¥¼ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\ní˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return;
  
  const data = window.restoreData;
  
  try {
    // Firebaseì— ë°ì´í„° ë³µì›
    const batch = db.batch();
    
    // ê³µê¸‰ì‚¬ ë³µì›
    if (data.suppliers) {
      for (const item of data.suppliers) {
        const ref = db.collection('suppliers').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    // ì…€ëŸ¬ ë³µì›
    if (data.sellers) {
      for (const item of data.sellers) {
        const ref = db.collection('sellers').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    // ê³µêµ¬ ë³µì›
    if (data.deals) {
      for (const item of data.deals) {
        const ref = db.collection('deals').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    // ìƒí’ˆ DB ë³µì›
    if (data.productDB) {
      for (const item of data.productDB) {
        const ref = db.collection('productDB').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    // ì œì•ˆ ë³µì›
    if (data.dealSuggestions) {
      for (const item of data.dealSuggestions) {
        const ref = db.collection('dealSuggestions').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    await batch.commit();
    
    closeModal();
    showToast('âœ… ë°ì´í„°ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
    setTimeout(() => location.reload(), 1500);
    
  } catch (err) {
    console.error('ë³µì› ì‹¤íŒ¨:', err);
    showToast('âŒ ë³µì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
  }
}

// íƒ­ ì „í™˜
function switchTab(tab) {
  // ê´€ë¦¬ì íƒ­ì¸ì§€ í™•ì¸
  if (adminTabs.includes(tab) && !isAdminUnlocked) {
    showAdminPasswordModal();
    return;
  }
  
  state.currentTab = tab;
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.tab === tab);
  });
  render();
}

// ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜
function prevMonth() {
  state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1, 1);
  render();
}

function nextMonth() {
  state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1, 1);
  render();
}

function goToday() {
  state.currentDate = new Date();
  render();
}

// í•„í„°
function changeViewFilter(filter) {
  state.viewFilter = filter;
  render();
}

function changeSupplierFilter(supplierId) {
  state.selectedSupplier = supplierId;
  render();
}

function changeSellerFilter(sellerId) {
  state.selectedSeller = sellerId;
  render();
}

// ëª¨ë‹¬
function closeModal() {
  document.getElementById('modal').className = 'modal';
  // ì…€ëŸ¬ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
  document.removeEventListener('click', closeSellerDropdownOnOutsideClick);
}

function openDealModal(deal = null) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';

  const isEdit = deal !== null;
  const d = deal || {
    title: '', supplierId: '', sellerId: '', startDate: formatDate(new Date()),
    endDate: formatDate(new Date()), status: 'negotiating', notes: '',
    supplierSettled: false, sellerSettled: false,
    selectedProducts: [] // ì„ íƒëœ ìƒí’ˆ ë°°ì—´: [{productId, productName, marginRate}]
  };

  // ê¸°ì¡´ ì„ íƒëœ ìƒí’ˆ ë°ì´í„° (ê¸°ì¡´ ë°°ì—´ ë˜ëŠ” ìƒˆ ê°ì²´ ë°°ì—´ í˜•ì‹ ëª¨ë‘ ì§€ì›)
  const selectedProductsData = d.selectedProducts || [];
  const selectedProductIds = selectedProductsData.map(item =>
    typeof item === 'string' ? item : item.productId
  );

  // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ íƒëœ ìƒí’ˆ ì •ë³´ ìœ ì§€ (ê²€ìƒ‰ í•„í„°ë§ ì‹œì—ë„ ì„ íƒ ì •ë³´ ìœ ì§€)
  window.selectedDealProducts = selectedProductsData.map(item => {
    if (typeof item === 'string') {
      const product = (state.supplierProducts || []).find(p => p.id === item);
      return { productId: item, productName: product?.productName || '', marginRate: 0 };
    }
    return { ...item };
  });
  
  // ê³µêµ¬ ê¸°ê°„ ê³„ì‚°
  const getDealDuration = (start, end) => {
    if (!start || !end) return '';
    const startDate = new Date(start);
    const endDate = new Date(end);
    const diff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    return diff > 0 ? `(${diff}ì¼)` : '';
  };
  
  const initialDuration = getDealDuration(d.startDate, d.endDate);
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ê³µêµ¬ ìˆ˜ì •' : 'ìƒˆ ê³µêµ¬ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitDealForm(event, '${d.id || ''}')">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ê³µê¸‰ì‚¬</label>
            <select class="form-select" id="deal-supplier" required onchange="updateProductList(); updateDealTitle();">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${state.suppliers.map(s => `<option value="${s.id}" ${d.supplierId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ì…€ëŸ¬</label>
            <select class="form-select" id="deal-seller" required onchange="updateDealTitle()">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${state.sellers.map(s => `<option value="${s.id}" ${d.sellerId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ê³µêµ¬ëª… <span id="deal-duration" style="color: var(--primary); font-weight: 600;">${initialDuration}</span></label>
          <input type="text" class="form-input" id="deal-title" value="${d.title}" required placeholder="ì…€ëŸ¬ ì„ íƒ ì‹œ ìë™ ìƒì„±ë©ë‹ˆë‹¤">
        </div>
        
        <!-- ë‚ ì§œ ì„ íƒ ì˜ì—­ -->
        <div class="form-group">
          <label class="form-label">ğŸ“… ê³µêµ¬ ê¸°ê°„</label>
          <button type="button" class="btn btn-secondary" id="date-range-btn" onclick="openDateRangePicker()" style="width: 100%; justify-content: space-between; padding: 14px 16px;">
            <span id="date-range-display">${d.startDate} ~ ${d.endDate}</span>
            <span style="color: var(--gray-500);">ğŸ“… ë‚ ì§œ ì„ íƒ</span>
          </button>
          <input type="hidden" id="deal-start" value="${d.startDate}">
          <input type="hidden" id="deal-end" value="${d.endDate}">
          <div id="date-range-picker" style="display: none; margin-top: 12px; border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <button type="button" class="btn btn-ghost btn-sm" onclick="changePickerMonth(-1)">â—€</button>
              <span id="picker-month-label" style="font-weight: 600;"></span>
              <button type="button" class="btn btn-ghost btn-sm" onclick="changePickerMonth(1)">â–¶</button>
            </div>
            <div id="picker-calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center;"></div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
              <div id="picker-status" style="font-size: 13px; color: var(--gray-500);">1. ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
              <button type="button" class="btn btn-primary btn-sm" onclick="closeDateRangePicker()">ì™„ë£Œ</button>
            </div>
          </div>
        </div>
        
        <!-- ìƒí’ˆ ì„ íƒ ì˜ì—­ -->
        <div class="form-group">
          <label class="form-label">ğŸ“¦ ê³µêµ¬ ìƒí’ˆ ì„ íƒ <span id="selected-product-count" style="color: var(--primary);">(${selectedProductIds.length}ê°œ ì„ íƒ)</span></label>
          
          <!-- ì„ íƒëœ ìƒí’ˆ í‘œì‹œ ì˜ì—­ -->
          <div id="selected-products-display" style="margin-bottom: 8px; ${selectedProductIds.length === 0 ? 'display:none;' : ''}">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${selectedProductIds.map(pid => {
                const product = (state.supplierProducts || []).find(p => p.id === pid);
                const productData = selectedProductsData.find(item => (typeof item === 'string' ? item : item.productId) === pid);
                const marginRate = productData && typeof productData === 'object' ? productData.marginRate : '';
                return product ? `
                  <div class="selected-product-tag" data-id="${pid}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); border: 1px solid var(--primary); border-radius: 20px; font-size: 13px;">
                    <span style="color: var(--primary); font-weight: 500;">${product.productName}</span>
                    ${marginRate ? `<span style="color: var(--gray-600); font-size: 11px;">(${marginRate}%)</span>` : ''}
                    <button type="button" onclick="removeSelectedProduct('${pid}')" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">Ã—</button>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
          
          <input type="text" class="form-input" id="product-search" placeholder="ğŸ” ìƒí’ˆëª… ê²€ìƒ‰..." style="margin-bottom: 8px;" oninput="filterProductList()">
          <div id="deal-product-list" style="border: 1px solid var(--gray-200); border-radius: 12px; padding: 12px; background: var(--gray-50); max-height: 200px; overflow-y: auto;">
            ${d.supplierId ? renderDealProductOptions(d.supplierId, selectedProductsData, '') : '<p style="color: var(--gray-500); text-align: center; padding: 20px;">ê³µê¸‰ì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>'}
          </div>
          <p style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">ğŸ’¡ ê³µê¸‰ì‚¬ ìƒí’ˆ DBì— ë“±ë¡ëœ ìƒí’ˆ ì¤‘ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        
        <!-- ìƒíƒœ ì„ íƒ - í˜‘ì˜ì¤‘/í˜‘ì˜ì™„ë£Œë§Œ ì„ íƒ ê°€ëŠ¥ -->
        <div class="form-group">
          <label class="form-label">ìƒíƒœ</label>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 20px; cursor: pointer; border: 2px solid ${d.status === 'negotiating' ? 'var(--primary)' : 'var(--gray-200)'}; background: ${d.status === 'negotiating' ? 'var(--primary-light)' : 'white'}; transition: all 0.15s;">
              <input type="radio" name="deal-status" value="negotiating" ${d.status === 'negotiating' ? 'checked' : ''} style="display: none;" onchange="updateStatusStyle()">
              <span style="font-size: 14px; font-weight: ${d.status === 'negotiating' ? '600' : '500'}; color: ${d.status === 'negotiating' ? 'var(--primary)' : 'var(--gray-700)'};">í˜‘ì˜ì¤‘</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 20px; cursor: pointer; border: 2px solid ${d.status !== 'negotiating' ? 'var(--primary)' : 'var(--gray-200)'}; background: ${d.status !== 'negotiating' ? 'var(--primary-light)' : 'white'}; transition: all 0.15s;">
              <input type="radio" name="deal-status" value="confirmed" ${d.status !== 'negotiating' ? 'checked' : ''} style="display: none;" onchange="updateStatusStyle()">
              <span style="font-size: 14px; font-weight: ${d.status !== 'negotiating' ? '600' : '500'}; color: ${d.status !== 'negotiating' ? 'var(--primary)' : 'var(--gray-700)'};">í˜‘ì˜ì™„ë£Œ</span>
            </label>
          </div>
          <p style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">ğŸ’¡ í˜‘ì˜ì™„ë£Œ í›„ì—ëŠ” ê³µêµ¬ ê¸°ê°„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì§„í–‰ì˜ˆì •/ì§„í–‰ì¤‘/ì§„í–‰ì™„ë£Œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        
        <!-- í˜‘ì˜ì™„ë£Œ ì‹œ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        ${d.status !== 'negotiating' ? `
          <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <label class="form-label" style="margin: 0;">ğŸ“‹ ê³µêµ¬ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸</label>
              <div id="deal-journey-progress" style="font-size: 12px; color: var(--primary); font-weight: 600;">0/0 ì™„ë£Œ</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
              
              <div style="font-size: 11px; color: var(--gray-500); font-weight: 600; margin-bottom: 4px;">ğŸ“¦ ì¤€ë¹„ ë‹¨ê³„</div>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-sample" ${d.journeySample ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeySample', 'ìƒ˜í”Œ ì „ë‹¬', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ“¦ ìƒ˜í”Œ ì „ë‹¬</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-payment-link" ${d.journeyPaymentLink ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeyPaymentLink', 'ê²°ì œë§í¬ ì „ë‹¬', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ’³ ê²°ì œë§í¬ ì „ë‹¬</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-content" ${d.journeyContent ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeyContent', 'ì½˜í…ì¸  ì „ë‹¬', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ¬ ì½˜í…ì¸  ì „ë‹¬</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-ad-setup" ${d.journeyAdSetup ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeyAdSetup', 'ê´‘ê³  ì„¸íŒ…', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ“¢ ê´‘ê³  ì„¸íŒ…</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-seller-guide" ${d.journeySellerGuide ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeySellerGuide', 'ì…€ëŸ¬ ê°€ì´ë“œ ì „ë‹¬', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ“˜ ì…€ëŸ¬ ê°€ì´ë“œ ì „ë‹¬</span>
              </label>
              
              <div style="font-size: 11px; color: var(--gray-500); font-weight: 600; margin: 8px 0 4px 0;">ğŸ”¥ ì§„í–‰ ë‹¨ê³„</div>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-monitoring" ${d.journeyMonitoring ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeyMonitoring', 'ì£¼ë¬¸ í˜„í™© ëª¨ë‹ˆí„°ë§', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ“Š ì£¼ë¬¸ í˜„í™© ëª¨ë‹ˆí„°ë§</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-cs" ${d.journeyCs ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeyCs', 'ê³ ê° ë¬¸ì˜ ëŒ€ì‘', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ’¬ ê³ ê° ë¬¸ì˜ ëŒ€ì‘</span>
              </label>
              
              <div style="font-size: 11px; color: var(--gray-500); font-weight: 600; margin: 8px 0 4px 0;">âœ… ì •ì‚° ë‹¨ê³„</div>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-order-send" ${d.journeyOrderSend ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeyOrderSend', 'ë°œì£¼ì„œ ì „ë‹¬ (ê·¸ë¡œí™ˆ)', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ“‹ ë°œì£¼ì„œ ì „ë‹¬ (ê·¸ë¡œí™ˆ)</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-seller-settle" ${d.journeySellerSettle ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeySellerSettle', 'ì…€ëŸ¬ ì •ì‚°ì„œ ì œì‘', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ’° ì…€ëŸ¬ ì •ì‚°ì„œ ì œì‘</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-supplier-settle" ${d.journeySupplierSettle ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeySupplierSettle', 'ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì œì‘', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">ğŸ’° ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì œì‘</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);" class="journey-checklist-item">
                <input type="checkbox" id="journey-complete" ${d.journeyComplete ? 'checked' : ''} onchange="updateDealJourneyProgress(); syncJourneyToTask('${d.id || ''}', 'journeyComplete', 'ì •ì‚° ì™„ë£Œ', this.checked)" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <span style="flex: 1;">âœ… ì •ì‚° ì™„ë£Œ</span>
              </label>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button type="button" onclick="generateDealTasksFromJourney('${d.id || ''}')" style="flex: 1; background: var(--info-light); color: var(--info); border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                ğŸ“‹ ë¯¸ì™„ë£Œ í•­ëª© â†’ ì—…ë¬´ë¡œ ìƒì„±
              </button>
              <button type="button" onclick="openDealTasksModal('${d.id || ''}')" style="flex: 1; background: var(--primary-light); color: var(--primary); border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                ğŸ“ ì—°ê²°ëœ ì—…ë¬´ ë³´ê¸°
              </button>
            </div>
          </div>
        ` : ''}
        
        <!-- ğŸ“Š ë¶„ì„ìš© ì •ë³´ -->
        <div class="form-group">
          <label class="form-label">ğŸ“Š ë¶„ì„ ì •ë³´ (ë³´ê³ ìš©)</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: 12px;">
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ì»¨í…ì¸  ê°€ì´ë“œ ì§€ì›</label>
              <select class="form-input" id="deal-content-guide" style="font-size: 13px;">
                <option value="" ${!d.contentGuide ? 'selected' : ''}>ì„ íƒ</option>
                <option value="full" ${d.contentGuide === 'full' ? 'selected' : ''}>âœ… ì „ì²´ ì§€ì›</option>
                <option value="partial" ${d.contentGuide === 'partial' ? 'selected' : ''}>âš ï¸ ì¼ë¶€ ì§€ì›</option>
                <option value="none" ${d.contentGuide === 'none' ? 'selected' : ''}>âŒ ë¯¸ì§€ì›</option>
              </select>
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ì†Œë¹„ì ë§Œì¡±ë„</label>
              <select class="form-input" id="deal-satisfaction" style="font-size: 13px;">
                <option value="" ${!d.satisfaction ? 'selected' : ''}>ì„ íƒ</option>
                <option value="excellent" ${d.satisfaction === 'excellent' ? 'selected' : ''}>â­â­â­ ë§¤ìš°ì¢‹ìŒ</option>
                <option value="good" ${d.satisfaction === 'good' ? 'selected' : ''}>â­â­ ì¢‹ìŒ</option>
                <option value="normal" ${d.satisfaction === 'normal' ? 'selected' : ''}>â­ ë³´í†µ</option>
                <option value="bad" ${d.satisfaction === 'bad' ? 'selected' : ''}>ğŸ‘ ë¶ˆë§Œ</option>
              </select>
            </div>
          </div>
          <p style="font-size: 11px; color: var(--gray-500); margin-top: 6px;">ğŸ’¡ ê³µêµ¬ ì™„ë£Œ í›„ ë¶„ì„ ë³´ê³ ì— í™œìš©ë©ë‹ˆë‹¤.</p>
        </div>
        
        <!-- ğŸ¯ ì´ë²¤íŠ¸ë¹„ìš© ì¶”ê°€ -->
        <div class="form-group">
          <label class="form-label">ì´ë²¤íŠ¸ë¹„ìš© <span style="font-weight: 400; color: var(--gray-500);">(ì›)</span></label>
          <input type="number" class="form-input" id="deal-eventCost" value="${d.eventCost || 0}" placeholder="0" min="0" step="1000">
          <p style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ğŸ’¡ ì²´í—˜ë‹¨, ê´‘ê³ ë¹„, ìƒ˜í”Œë¹„ìš© ë“± ê³µêµ¬ ì§„í–‰ì— ì‚¬ìš©ëœ ë¹„ìš©</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">ë©”ëª¨</label>
          <textarea class="form-textarea" id="deal-notes" rows="2" placeholder="ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">${d.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteDeal('${d.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  // ë‚ ì§œ í”¼ì»¤ ì´ˆê¸°í™”
  window.pickerMonth = new Date(d.startDate || new Date());
  window.pickerStartDate = d.startDate || null;
  window.pickerEndDate = d.endDate || null;
  window.pickerStep = 1; // 1: ì‹œì‘ì¼ ì„ íƒ, 2: ì¢…ë£Œì¼ ì„ íƒ
  
  // ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  ì´ˆê¸°í™”
  setTimeout(function() {
    updateDealJourneyProgress();
  }, 100);
}

// ê³µêµ¬ëª… ìë™ ì—…ë°ì´íŠ¸
function updateDealTitle() {
  const sellerSelect = document.getElementById('deal-seller');
  const titleInput = document.getElementById('deal-title');
  
  if (sellerSelect.value) {
    const selectedOption = sellerSelect.options[sellerSelect.selectedIndex];
    const sellerName = selectedOption.text;
    titleInput.value = sellerName;
  }
  
  updateDealDuration();
}

// ê³µêµ¬ ê¸°ê°„(ì¼ìˆ˜) ì—…ë°ì´íŠ¸
function updateDealDuration() {
  const start = document.getElementById('deal-start').value;
  const end = document.getElementById('deal-end').value;
  const durationSpan = document.getElementById('deal-duration');
  
  if (start && end) {
    const startDate = new Date(start);
    const endDate = new Date(end);
    const diff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    durationSpan.textContent = diff > 0 ? `(${diff}ì¼)` : '';
  } else {
    durationSpan.textContent = '';
  }
}

// ë‚ ì§œ ë²”ìœ„ í”¼ì»¤ ì—´ê¸°
function openDateRangePicker() {
  const picker = document.getElementById('date-range-picker');
  picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
  if (picker.style.display === 'block') {
    window.pickerStep = 1;
    renderPickerCalendar();
  }
}

function closeDateRangePicker() {
  document.getElementById('date-range-picker').style.display = 'none';
}

// í”¼ì»¤ ì›” ë³€ê²½
function changePickerMonth(delta) {
  window.pickerMonth = new Date(window.pickerMonth.getFullYear(), window.pickerMonth.getMonth() + delta, 1);
  renderPickerCalendar();
}

// í”¼ì»¤ ìº˜ë¦°ë” ë Œë”ë§
function renderPickerCalendar() {
  const year = window.pickerMonth.getFullYear();
  const month = window.pickerMonth.getMonth();
  
  document.getElementById('picker-month-label').textContent = `${year}ë…„ ${month + 1}ì›”`;
  
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  let html = weekdays.map(w => `<div style="font-size: 12px; color: var(--gray-500); padding: 8px;">${w}</div>`).join('');
  
  // ë¹ˆ ì¹¸
  for (let i = 0; i < firstDay; i++) {
    html += '<div></div>';
  }
  
  // ë‚ ì§œ
  const today = formatDate(new Date());
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = formatDate(new Date(year, month, day));
    const isToday = dateStr === today;
    const isStart = dateStr === window.pickerStartDate;
    const isEnd = dateStr === window.pickerEndDate;
    const isInRange = window.pickerStartDate && window.pickerEndDate && 
                      dateStr > window.pickerStartDate && dateStr < window.pickerEndDate;
    
    let style = 'padding: 10px; border-radius: 8px; cursor: pointer; font-size: 14px;';
    if (isStart || isEnd) {
      style += 'background: var(--primary); color: white; font-weight: 600;';
    } else if (isInRange) {
      style += 'background: var(--primary-light); color: var(--primary);';
    } else if (isToday) {
      style += 'border: 2px solid var(--primary); font-weight: 600;';
    }
    
    html += `<div style="${style}" onclick="selectPickerDate('${dateStr}')" onmouseover="this.style.background=this.style.background||'var(--gray-100)'" onmouseout="this.style.background='${isStart || isEnd ? 'var(--primary)' : isInRange ? 'var(--primary-light)' : ''}'">${day}</div>`;
  }
  
  document.getElementById('picker-calendar').innerHTML = html;
  
  // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
  const statusEl = document.getElementById('picker-status');
  if (window.pickerStep === 1) {
    statusEl.innerHTML = '1ï¸âƒ£ <strong>ì‹œì‘ì¼</strong>ì„ ì„ íƒí•˜ì„¸ìš”';
  } else {
    statusEl.innerHTML = '2ï¸âƒ£ <strong>ì¢…ë£Œì¼</strong>ì„ ì„ íƒí•˜ì„¸ìš”';
  }
}

// ë‚ ì§œ ì„ íƒ
function selectPickerDate(dateStr) {
  if (window.pickerStep === 1) {
    // ì‹œì‘ì¼ ì„ íƒ
    window.pickerStartDate = dateStr;
    window.pickerEndDate = null;
    window.pickerStep = 2;
    document.getElementById('deal-start').value = dateStr;
  } else {
    // ì¢…ë£Œì¼ ì„ íƒ
    if (dateStr < window.pickerStartDate) {
      // ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì´ë©´ ì‹œì‘ì¼ë¡œ ì„¤ì •
      window.pickerEndDate = window.pickerStartDate;
      window.pickerStartDate = dateStr;
      document.getElementById('deal-start').value = dateStr;
      document.getElementById('deal-end').value = window.pickerEndDate;
    } else {
      window.pickerEndDate = dateStr;
      document.getElementById('deal-end').value = dateStr;
    }
    window.pickerStep = 1;
    
    // ë‚ ì§œ ë²”ìœ„ í‘œì‹œ ì—…ë°ì´íŠ¸
    document.getElementById('date-range-display').textContent = 
      `${window.pickerStartDate} ~ ${window.pickerEndDate}`;
    
    // ê¸°ê°„ ì—…ë°ì´íŠ¸
    updateDealDuration();
    
    // í”¼ì»¤ ë‹«ê¸°
    setTimeout(() => closeDateRangePicker(), 300);
  }
  
  renderPickerCalendar();
}

// ìƒíƒœ ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
function updateStatusStyle() {
  const radios = document.querySelectorAll('input[name="deal-status"]');
  radios.forEach(radio => {
    const label = radio.closest('label');
    const span = label.querySelector('span');
    if (radio.checked) {
      label.style.borderColor = 'var(--primary)';
      label.style.background = 'var(--primary-light)';
      span.style.fontWeight = '600';
      span.style.color = 'var(--primary)';
    } else {
      label.style.borderColor = 'var(--gray-200)';
      label.style.background = 'white';
      span.style.fontWeight = '500';
      span.style.color = 'var(--gray-700)';
    }
  });
}

// ê³µê¸‰ì‚¬ ì„ íƒ ì‹œ ìƒí’ˆ ëª©ë¡ ì—…ë°ì´íŠ¸
function updateProductList() {
  const supplierId = document.getElementById('deal-supplier').value;
  const container = document.getElementById('deal-product-list');
  const searchInput = document.getElementById('product-search');
  
  if (searchInput) searchInput.value = '';
  
  if (!supplierId) {
    container.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">ê³µê¸‰ì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>';
    return;
  }
  
  container.innerHTML = renderDealProductOptions(supplierId, [], '');
}

// ìƒí’ˆ ê²€ìƒ‰ í•„í„°
function filterProductList() {
  const supplierId = document.getElementById('deal-supplier').value;
  const searchQuery = document.getElementById('product-search').value;
  const container = document.getElementById('deal-product-list');

  // í˜„ì¬ DOMì— ì²´í¬ëœ ìƒí’ˆì˜ ìµœì‹  ë§ˆì§„ìœ¨ ì •ë³´ë¡œ ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
  const currentCheckedBoxes = document.querySelectorAll('input[name="deal-products"]:checked');
  currentCheckedBoxes.forEach(cb => {
    const marginInput = document.querySelector(`.product-margin-rate[data-product-id="${cb.value}"]`);
    const existingIdx = (window.selectedDealProducts || []).findIndex(p => p.productId === cb.value);
    const productData = {
      productId: cb.value,
      productName: cb.dataset.name,
      marginRate: marginInput ? Number(marginInput.value) || 0 : 0
    };
    if (existingIdx >= 0) {
      window.selectedDealProducts[existingIdx] = productData;
    } else {
      window.selectedDealProducts = window.selectedDealProducts || [];
      window.selectedDealProducts.push(productData);
    }
  });

  if (!supplierId) {
    container.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">ê³µê¸‰ì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>';
    return;
  }

  // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ëœ ì„ íƒ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë Œë”ë§
  container.innerHTML = renderDealProductOptions(supplierId, window.selectedDealProducts || [], searchQuery);
}

// ê³µê¸‰ì‚¬ë³„ ìƒí’ˆ ì˜µì…˜ ë Œë”ë§ (ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€)
function renderDealProductOptions(supplierId, selectedIds, searchQuery = '') {
  // ê³µê¸‰ì‚¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const supplier = state.suppliers.find(s => s.id === supplierId);
  const supplierName = supplier?.name || '';
  
  // selectedIdsê°€ ê°ì²´ ë°°ì—´ì¸ì§€ í™•ì¸ (ìƒˆ í˜•ì‹: [{productId, marginRate}])
  const selectedProductsData = Array.isArray(selectedIds) ? selectedIds : [];
  const selectedProductIds = selectedProductsData.map(item => 
    typeof item === 'string' ? item : item.productId
  );
  
  // supplierIdë¡œ ë§¤ì¹­í•˜ê±°ë‚˜, brandNameìœ¼ë¡œ ë§¤ì¹­
  let products = (state.supplierProducts || []).filter(p => 
    p.supplierId === supplierId || p.brandName === supplierName
  );
  
  // ê²€ìƒ‰ í•„í„° ì ìš©
  if (searchQuery) {
    const query = searchQuery.toLowerCase();
    products = products.filter(p => 
      (p.productName || '').toLowerCase().includes(query)
    );
  }
  
  if (products.length === 0) {
    if (searchQuery) {
      return `<p style="color: var(--gray-500); text-align: center; padding: 20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    }
    return `
      <p style="color: var(--gray-500); text-align: center; padding: 20px;">
        ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>
        <a href="#" onclick="closeModal(); switchTab('productDB');" style="color: var(--primary); font-weight: 600;">ê³µê¸‰ì‚¬ ìƒí’ˆ DB</a>ì—ì„œ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
      </p>
    `;
  }
  
  return products.map(p => {
    const isChecked = selectedProductIds.includes(p.id);
    // ê¸°ì¡´ ë§ˆì§„ìœ¨ ì°¾ê¸°
    const existingData = selectedProductsData.find(item =>
      (typeof item === 'string' ? item : item.productId) === p.id
    );
    const marginRate = existingData && typeof existingData === 'object' ? existingData.marginRate || '' : '';
    const supplyPrice = Number(p.supplyPrice) || 0;

    return `
      <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 2px solid ${isChecked ? 'var(--primary)' : 'var(--gray-200)'};" onclick="this.style.borderColor = this.querySelector('input[type=checkbox]').checked ? 'var(--gray-200)' : 'var(--primary)'">
        <input type="checkbox" name="deal-products" value="${p.id}" data-name="${p.productName}" data-supply-price="${supplyPrice}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px;" onchange="updateSelectedProductsDisplay()">
        <div style="flex: 1;">
          <div style="font-weight: 600;">${p.productName}</div>
          <div style="font-size: 12px; color: var(--gray-500); margin-top: 2px;">
            ê³µê¸‰ë‹¨ê°€: <span style="color: ${supplyPrice > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${supplyPrice > 0 ? supplyPrice.toLocaleString() + 'ì›' : 'ë¯¸ì„¤ì •'}</span>
          </div>
        </div>
        <div style="display: ${isChecked ? 'flex' : 'none'}; align-items: center; gap: 6px;" class="margin-rate-input">
          <span style="font-size: 12px; color: var(--gray-500);">ë§ˆì§„ìœ¨</span>
          <input type="number" class="form-input product-margin-rate" data-product-id="${p.id}" value="${marginRate}" placeholder="0" step="0.1" min="0" max="100" style="width: 60px; padding: 4px 8px; text-align: center; font-size: 13px;" onclick="event.stopPropagation()">
          <span style="font-size: 12px; color: var(--gray-500);">%</span>
        </div>
      </label>
    `;
  }).join('');
}

// ì„ íƒëœ ìƒí’ˆ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSelectedProductsDisplay() {
  const checkedBoxes = document.querySelectorAll('input[name="deal-products"]:checked');
  const displayContainer = document.getElementById('selected-products-display');
  const countSpan = document.getElementById('selected-product-count');

  // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
  window.selectedDealProducts = window.selectedDealProducts || [];

  // í˜„ì¬ DOMì— ì²´í¬ëœ ìƒí’ˆë“¤ë¡œ ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
  const currentCheckedIds = [];
  checkedBoxes.forEach(cb => {
    currentCheckedIds.push(cb.value);
    const marginInput = document.querySelector(`.product-margin-rate[data-product-id="${cb.value}"]`);
    const existingIdx = window.selectedDealProducts.findIndex(p => p.productId === cb.value);
    const productData = {
      productId: cb.value,
      productName: cb.dataset.name,
      marginRate: marginInput ? Number(marginInput.value) || 0 : 0
    };
    if (existingIdx >= 0) {
      window.selectedDealProducts[existingIdx] = productData;
    } else {
      window.selectedDealProducts.push(productData);
    }
  });

  // DOMì— í‘œì‹œëœ ì²´í¬ í•´ì œëœ ìƒí’ˆë“¤ì„ ì „ì—­ ë³€ìˆ˜ì—ì„œ ì œê±°
  document.querySelectorAll('input[name="deal-products"]:not(:checked)').forEach(cb => {
    const idx = window.selectedDealProducts.findIndex(p => p.productId === cb.value);
    if (idx >= 0) {
      window.selectedDealProducts.splice(idx, 1);
    }
  });

  // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ (ì „ì—­ ë³€ìˆ˜ ê¸°ì¤€)
  countSpan.textContent = `(${window.selectedDealProducts.length}ê°œ ì„ íƒ)`;

  // ë§ˆì§„ìœ¨ ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
  document.querySelectorAll('input[name="deal-products"]').forEach(cb => {
    const marginInput = cb.closest('label').querySelector('.margin-rate-input');
    if (marginInput) {
      marginInput.style.display = cb.checked ? 'flex' : 'none';
    }
    // ì²´í¬ë°•ìŠ¤ border ì—…ë°ì´íŠ¸
    cb.closest('label').style.borderColor = cb.checked ? 'var(--primary)' : 'var(--gray-200)';
  });

  // íƒœê·¸ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì „ì—­ ë³€ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  ì„ íƒ ìƒí’ˆ í‘œì‹œ)
  if (window.selectedDealProducts.length === 0) {
    displayContainer.style.display = 'none';
  } else {
    displayContainer.style.display = 'block';
    displayContainer.innerHTML = `
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${window.selectedDealProducts.map(p => {
          const marginInput = document.querySelector(`.product-margin-rate[data-product-id="${p.productId}"]`);
          const marginRate = marginInput ? marginInput.value : (p.marginRate || '');
          return `
          <div class="selected-product-tag" data-id="${p.productId}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); border: 1px solid var(--primary); border-radius: 20px; font-size: 13px;">
            <span style="color: var(--primary); font-weight: 500;">${p.productName}</span>
            ${marginRate ? `<span style="color: var(--gray-600); font-size: 11px;">(${marginRate}%)</span>` : ''}
            <button type="button" onclick="removeSelectedProduct('${p.productId}')" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">Ã—</button>
          </div>
        `}).join('')}
      </div>
    `;
  }
}

// ì„ íƒëœ ìƒí’ˆ íƒœê·¸ì—ì„œ ì œê±°
function removeSelectedProduct(productId) {
  // ì „ì—­ ë³€ìˆ˜ì—ì„œ ë¨¼ì € ì œê±° (DOMì— ì—†ëŠ” ìƒí’ˆë„ ì œê±° ê°€ëŠ¥)
  window.selectedDealProducts = (window.selectedDealProducts || []).filter(p => p.productId !== productId);

  // DOMì— ì²´í¬ë°•ìŠ¤ê°€ ìˆìœ¼ë©´ ì²´í¬ í•´ì œ
  const checkbox = document.querySelector(`input[name="deal-products"][value="${productId}"]`);
  if (checkbox) {
    checkbox.checked = false;
    // ì²´í¬ë°•ìŠ¤ì˜ ë¶€ëª¨ label ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    const label = checkbox.closest('label');
    if (label) {
      label.style.borderColor = 'var(--gray-200)';
      const marginInput = label.querySelector('.margin-rate-input');
      if (marginInput) {
        marginInput.style.display = 'none';
      }
    }
  }

  // íƒœê·¸ í‘œì‹œ ì—…ë°ì´íŠ¸
  const displayContainer = document.getElementById('selected-products-display');
  const countSpan = document.getElementById('selected-product-count');

  countSpan.textContent = `(${window.selectedDealProducts.length}ê°œ ì„ íƒ)`;

  if (window.selectedDealProducts.length === 0) {
    displayContainer.style.display = 'none';
  } else {
    displayContainer.innerHTML = `
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${window.selectedDealProducts.map(p => {
          const marginInput = document.querySelector(`.product-margin-rate[data-product-id="${p.productId}"]`);
          const marginRate = marginInput ? marginInput.value : (p.marginRate || '');
          return `
          <div class="selected-product-tag" data-id="${p.productId}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); border: 1px solid var(--primary); border-radius: 20px; font-size: 13px;">
            <span style="color: var(--primary); font-weight: 500;">${p.productName}</span>
            ${marginRate ? `<span style="color: var(--gray-600); font-size: 11px;">(${marginRate}%)</span>` : ''}
            <button type="button" onclick="removeSelectedProduct('${p.productId}')" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">Ã—</button>
          </div>
        `}).join('')}
      </div>
    `;
  }
}

function submitDealForm(e, id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();

  // ì „ì—­ ë³€ìˆ˜ì—ì„œ ì„ íƒëœ ìƒí’ˆ ê°€ì ¸ì˜¤ê¸° (DOMì— ì—†ëŠ” ìƒí’ˆë„ í¬í•¨)
  // ë¨¼ì € í˜„ì¬ DOMì— í‘œì‹œëœ ì²´í¬ë°•ìŠ¤ì˜ ìµœì‹  ë§ˆì§„ìœ¨ ì •ë³´ë¡œ ì—…ë°ì´íŠ¸
  const checkedBoxes = document.querySelectorAll('input[name="deal-products"]:checked');
  checkedBoxes.forEach(cb => {
    const marginInput = document.querySelector(`.product-margin-rate[data-product-id="${cb.value}"]`);
    const existingIdx = (window.selectedDealProducts || []).findIndex(p => p.productId === cb.value);
    if (existingIdx >= 0) {
      window.selectedDealProducts[existingIdx].marginRate = marginInput ? Number(marginInput.value) || 0 : 0;
    }
  });

  // ì „ì—­ ë³€ìˆ˜ì—ì„œ ì„ íƒëœ ìƒí’ˆ ìˆ˜ì§‘ (ê³µê¸‰ë‹¨ê°€ ì¶”ê°€)
  const selectedProducts = (window.selectedDealProducts || []).map(p => {
    const product = (state.supplierProducts || []).find(sp => sp.id === p.productId);
    return {
      productId: p.productId,
      productName: p.productName,
      marginRate: p.marginRate || 0,
      supplyPrice: product ? Number(product.supplyPrice) || 0 : 0
    };
  });
  
  // ë¼ë””ì˜¤ ë²„íŠ¼ì—ì„œ ìƒíƒœ ê°’ ê°€ì ¸ì˜¤ê¸°
  const statusRadio = document.querySelector('input[name="deal-status"]:checked');
  
  const data = {
    title: document.getElementById('deal-title').value,
    supplierId: document.getElementById('deal-supplier').value,
    sellerId: document.getElementById('deal-seller').value,
    startDate: document.getElementById('deal-start').value,
    endDate: document.getElementById('deal-end').value,
    status: statusRadio ? statusRadio.value : 'negotiating',
    notes: document.getElementById('deal-notes').value,
    eventCost: Number(document.getElementById('deal-eventCost')?.value) || 0, // ğŸ¯ ì´ë²¤íŠ¸ë¹„ìš©
    selectedProducts: selectedProducts,  // ì´ì œ ê°ì²´ ë°°ì—´: [{productId, productName, marginRate}]
    // ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ (í™•ì¥)
    journeySample: document.getElementById('journey-sample')?.checked || false,
    journeyPaymentLink: document.getElementById('journey-payment-link')?.checked || false,
    journeyContent: document.getElementById('journey-content')?.checked || false,
    journeyAdSetup: document.getElementById('journey-ad-setup')?.checked || false,
    journeySellerGuide: document.getElementById('journey-seller-guide')?.checked || false,
    journeyMonitoring: document.getElementById('journey-monitoring')?.checked || false,
    journeyCs: document.getElementById('journey-cs')?.checked || false,
    journeyOrderSend: document.getElementById('journey-order-send')?.checked || false,
    journeySellerSettle: document.getElementById('journey-seller-settle')?.checked || false,
    journeySupplierSettle: document.getElementById('journey-supplier-settle')?.checked || false,
    journeyComplete: document.getElementById('journey-complete')?.checked || false,
    // ë¶„ì„ìš© ì •ë³´
    contentGuide: document.getElementById('deal-content-guide')?.value || '',
    satisfaction: document.getElementById('deal-satisfaction')?.value || '',
    updatedAt: new Date().toISOString()
  };
  if (id) data.id = id;
  else data.createdAt = new Date().toISOString();
  saveDeal(data);
}

function openSupplierModal(supplier = null, bulk = false) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  if (bulk) {
    // ì¼ê´„ ë“±ë¡ì€ ì œê±°í•˜ê³  ë‹¨ìˆœ ì•ˆë‚´ë¡œ ë³€ê²½
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ê³µê¸‰ì‚¬ ë“±ë¡ ì•ˆë‚´</h2>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div style="padding: 20px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ­</div>
          <p>ê³µê¸‰ì‚¬ëŠ” ê°œë³„ ë“±ë¡ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
          <p style="color: var(--gray-500); font-size: 14px;">ì‚¬ì—…ìë“±ë¡ì¦, í†µì¥ì‚¬ë³¸ ë“± ì²¨ë¶€íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary" onclick="closeModal(); openSupplierModal()">ê°œë³„ ë“±ë¡í•˜ê¸°</button>
        </div>
      </div>
    `;
    return;
  }
  
  const isEdit = supplier !== null;
  const s = supplier || { 
    name: '', supplierType: 'external', website: '', 
    managerName: '', managerTitle: '', managerPhone: '', managerEmail: '',
    inquiryMethod: '', contractStatus: 'pending',
    businessLicenseUrl: '', bankBookUrl: '', bankAccount: '',
    notes: '', products: []
  };
  
  // í•´ë‹¹ ê³µê¸‰ì‚¬ì˜ ìƒí’ˆ ëª©ë¡ (ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ, ìƒˆ ë“±ë¡ ì‹œì—ëŠ” ë¹ˆ ë°°ì—´)
  const supplierProducts = isEdit ? (state.supplierProducts || []).filter(p => p.supplierId === s.id) : [];
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ­ ${isEdit ? 'ê³µê¸‰ì‚¬ ìˆ˜ì •' : 'ìƒˆ ê³µê¸‰ì‚¬ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitSupplierForm(event, '${s.id || ''}')" style="max-height: 75vh; overflow-y: auto; padding-right: 8px;">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="form-label">ê³µê¸‰ì‚¬ëª… <span style="color: var(--danger);">*</span></label>
              <input type="text" class="form-input" id="supplier-name" value="${s.name}" required placeholder="ì˜ˆ: ABC ì‹í’ˆ">
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">ìœ í˜• <span style="color: var(--danger);">*</span></label>
              <select class="form-input" id="supplier-type" required onchange="updateSupplierProductSection()">
                <option value="inhouse" ${s.supplierType === 'inhouse' ? 'selected' : ''}>ìì‚¬</option>
                <option value="external" ${s.supplierType === 'external' ? 'selected' : ''}>íƒ€ì‚¬</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ê¸°ì—…ê·œëª¨</label>
              <select class="form-input" id="supplier-company-size">
                <option value="" ${!s.companySize ? 'selected' : ''}>ì„ íƒ</option>
                <option value="large" ${s.companySize === 'large' ? 'selected' : ''}>ğŸ¢ ëŒ€ê¸°ì—…</option>
                <option value="medium" ${s.companySize === 'medium' ? 'selected' : ''}>ğŸ¬ ì¤‘ê²¬ê¸°ì—…</option>
                <option value="small" ${s.companySize === 'small' ? 'selected' : ''}>ğŸ  ì¤‘ì†Œê¸°ì—…</option>
                <option value="startup" ${s.companySize === 'startup' ? 'selected' : ''}>ğŸš€ ìŠ¤íƒ€íŠ¸ì—…</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">í™ˆí˜ì´ì§€</label>
              <input type="text" class="form-input" id="supplier-website" value="${s.website || ''}" placeholder="https://example.com">
            </div>
          </div>
        </div>
        
        <!-- ë‹´ë‹¹ì ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ‘¤ ë‹´ë‹¹ì ì •ë³´</h3>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ë‹´ë‹¹ìëª…</label>
              <input type="text" class="form-input" id="supplier-manager-name" value="${s.managerName || ''}" placeholder="í™ê¸¸ë™">
            </div>
            <div class="form-group">
              <label class="form-label">ì§ê¸‰ (ì„ íƒ)</label>
              <input type="text" class="form-input" id="supplier-manager-title" value="${s.managerTitle || ''}" placeholder="ê³¼ì¥, ëŒ€ë¦¬ ë“±">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì—°ë½ì²˜</label>
              <input type="text" class="form-input" id="supplier-manager-phone" value="${s.managerPhone || s.contact || ''}" placeholder="010-1234-5678">
            </div>
            <div class="form-group">
              <label class="form-label">ì´ë©”ì¼</label>
              <input type="email" class="form-input" id="supplier-manager-email" value="${s.managerEmail || ''}" placeholder="manager@example.com">
            </div>
          </div>
        </div>
        
        <!-- ğŸ†• ìƒí’ˆ ë“±ë¡ ì„¹ì…˜ - ê³µê¸‰ì‚¬ ìƒí’ˆ DB ì—°ë™ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-300);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="font-size: 13px; color: var(--gray-700); margin: 0; font-weight: 600;">ğŸ“¦ ìƒí’ˆ ê´€ë¦¬</h3>
          </div>
          <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 16px;">ì´ ê³µê¸‰ì‚¬ì˜ ìƒí’ˆì€ ê³µê¸‰ì‚¬ ìƒí’ˆ DBì—ì„œ í†µí•© ê´€ë¦¬ë©ë‹ˆë‹¤.</p>
          
          <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; border: 1px dashed var(--gray-300);">
            <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“¦</div>
            <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">
              ìƒí’ˆ ë“±ë¡, ìˆ˜ì •, ì‚­ì œëŠ”<br><strong>ê³µê¸‰ì‚¬ ìƒí’ˆ DB</strong>ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”.
            </p>
            <button type="button" class="btn btn-primary" onclick="closeModal(); switchTab('productDB');">
              ğŸ“¦ ê³µê¸‰ì‚¬ ìƒí’ˆ DBë¡œ ì´ë™
            </button>
          </div>
        </div>
        
        <!-- ìƒí’ˆ ë¬¸ì˜ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ’¬ ìƒí’ˆ ë¬¸ì˜ ë°©ì•ˆ</h3>
          <div class="form-group" style="margin: 0;">
            <textarea class="form-textarea" id="supplier-inquiry" rows="2" placeholder="ì¹´ì¹´ì˜¤í†¡ ì±„ë„, ì „í™” ë“± ë³„ë„ ë¬¸ì˜ ë°©ë²•">${s.inquiryMethod || ''}</textarea>
          </div>
        </div>
        
        <!-- ê³„ì•½ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">âœ… ê³„ì•½ ì •ë³´</h3>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ê³„ì•½ ìƒíƒœ</label>
              <select class="form-input" id="supplier-contract-status">
                <option value="pending" ${s.contractStatus === 'pending' ? 'selected' : ''}>â³ í˜‘ì˜ì¤‘</option>
                <option value="completed" ${s.contractStatus === 'completed' ? 'selected' : ''}>âœ… ê³„ì•½ì™„ë£Œ</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">í†µì¥ë²ˆí˜¸</label>
              <input type="text" class="form-input" id="supplier-bank-account" value="${s.bankAccount || ''}" placeholder="ì€í–‰ëª… / ê³„ì¢Œë²ˆí˜¸">
            </div>
          </div>
          
          <!-- ì„œë¥˜ ìˆ˜ë ¹ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
          <div style="background: white; border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <label class="form-label" style="margin: 0;">ğŸ“‹ ì„œë¥˜ ìˆ˜ë ¹ ì²´í¬ë¦¬ìŠ¤íŠ¸</label>
              <div id="supplier-checklist-progress" style="font-size: 12px; color: var(--gray-500);">0/4 ì™„ë£Œ</div>
            </div>
            
            <!-- ì§„í–‰ë¥  ë°” -->
            <div style="height: 6px; background: var(--gray-200); border-radius: 3px; margin-bottom: 16px; overflow: hidden;">
              <div id="supplier-progress-bar" style="height: 100%; background: var(--success); border-radius: 3px; transition: width 0.3s ease; width: 0%;"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="supplier-has-product-info" ${s.hasProductInfo ? 'checked' : ''} onchange="updateSupplierProgress()" style="width: 20px; height: 20px; accent-color: var(--success);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ“¦ ìƒí’ˆë“±ë¡</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="supplier-has-business-license" ${s.hasBusinessLicense ? 'checked' : ''} onchange="updateSupplierProgress()" style="width: 20px; height: 20px; accent-color: var(--success);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ¢ ì‚¬ì—…ì</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="supplier-has-bank-account" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSupplierProgress()" style="width: 20px; height: 20px; accent-color: var(--success);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ¦ í†µì¥</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="supplier-has-contract" ${s.hasContract ? 'checked' : ''} onchange="updateSupplierProgress()" style="width: 20px; height: 20px; accent-color: var(--success);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ“ ê³„ì•½</span>
              </label>
            </div>
            
            <!-- êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°”ë¡œê°€ê¸° ë²„íŠ¼ -->
            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--gray-300);">
              <a href="#" id="supplier-gdrive-link" onclick="openSupplierGDrive('${s.id || ''}')" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(66,133,244,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                  <path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/>
                </svg>
                ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ì„œë¥˜ ê´€ë¦¬
              </a>
            </div>
          </div>
        </div>
        
        <!-- ğŸ“‹ ë°œì£¼ì–‘ì‹ ì—…ë¡œë“œ -->
        <div style="background: #fffbeb; border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid #fcd34d;">
          <h3 style="font-size: 13px; color: #92400e; margin-bottom: 8px; font-weight: 600;">ğŸ“‹ ë°œì£¼ì–‘ì‹ (ì—‘ì…€)</h3>
          <p style="font-size: 11px; color: #b45309; margin-bottom: 12px;">ê³µê¸‰ì‚¬ ë°œì£¼ì„œ ì–‘ì‹ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. íŒŒíŠ¸ë„ˆí¬í„¸ì— ë³´ë‚¼ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
          
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <div id="supplier-order-form-upload" style="flex: 1;">
              <input type="file" id="supplier-order-form-file" accept=".xlsx,.xls" style="display: none;" onchange="handleOrderFormUpload(this, '${s.id || ''}')">
              <button type="button" class="btn btn-secondary" onclick="document.getElementById('supplier-order-form-file').click()" style="width: 100%;">
                ğŸ“¤ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
              </button>
            </div>
            ${s.orderFormUrl ? `
              <a href="${s.orderFormUrl}" target="_blank" class="btn btn-primary" style="flex: 1;">
                ğŸ“¥ í˜„ì¬ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
              </a>
              <button type="button" class="btn" style="background: #fee2e2; color: #dc2626; padding: 8px 12px;" onclick="removeOrderForm('${s.id}')">
                ì‚­ì œ
              </button>
            ` : ''}
          </div>
          ${s.orderFormName ? `<p style="font-size: 11px; color: #92400e; margin-top: 8px;">ğŸ“„ í˜„ì¬ íŒŒì¼: ${s.orderFormName}</p>` : ''}
        </div>
        
        <!-- ğŸ” ë¡œê·¸ì¸ ì •ë³´ (ì¼ì •í‘œ ê³µìœ ìš©) -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--gray-300);">
          <h3 style="font-size: 14px; color: #6d28d9; margin-bottom: 8px;">ğŸ” ì¼ì •í‘œ ë¡œê·¸ì¸ ì •ë³´</h3>
          <p style="font-size: 12px; color: #7c3aed; margin-bottom: 12px;">ê³µê¸‰ì‚¬ê°€ ì¼ì •í‘œì— ì ‘ì†í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê³„ì •ì…ë‹ˆë‹¤.</p>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì•„ì´ë””</label>
              <input type="text" class="form-input" id="supplier-login-id" value="${s.loginId || ''}" placeholder="ì˜ˆ: grohome" style="background: white;">
            </div>
            <div class="form-group">
              <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="text" class="form-input" id="supplier-login-pw" value="${s.loginPw || ''}" placeholder="ì˜ˆ: 1234" style="background: white;">
            </div>
          </div>
        </div>
        
        <!-- ê¸°íƒ€ ì‚¬í•­ -->
        <div class="form-group">
          <label class="form-label">ê¸°íƒ€ì‚¬í•­</label>
          <textarea class="form-textarea" id="supplier-notes" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨">${s.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSupplier('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  // ëª¨ë‹¬ ì—´ë¦° í›„ ì§„í–‰ë¥  ì´ˆê¸°í™”
  setTimeout(() => updateSupplierProgress(), 50);
}

// ========== ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  í•¨ìˆ˜ ==========

// ê³µê¸‰ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (4ê°œ í•­ëª©)
function updateSupplierProgress() {
  const checkboxes = [
    'supplier-has-product-info',
    'supplier-has-business-license',
    'supplier-has-bank-account',
    'supplier-has-contract'
  ];
  
  let checked = 0;
  const total = checkboxes.length;
  
  checkboxes.forEach(id => {
    const cb = document.getElementById(id);
    if (cb && cb.checked) checked++;
    
    // ì²´í¬ëœ í•­ëª© ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    const label = cb?.closest('.checklist-item');
    if (label) {
      if (cb.checked) {
        label.style.background = 'var(--success-light)';
        label.style.borderColor = 'var(--success)';
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.borderColor = 'var(--gray-200)';
      }
    }
  });
  
  const progress = document.getElementById('supplier-checklist-progress');
  const progressBar = document.getElementById('supplier-progress-bar');
  
  if (progress) {
    progress.textContent = `${checked}/${total} ì™„ë£Œ`;
    progress.style.color = checked === total ? 'var(--success)' : 'var(--gray-500)';
  }
  if (progressBar) {
    progressBar.style.width = `${(checked / total) * 100}%`;
    progressBar.style.background = checked === total ? 'var(--success)' : 'var(--primary)';
  }
}

// ì…€ëŸ¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (4ê°œ í•­ëª©)
function updateSellerProgress() {
  const checkboxes = [
    'seller-has-id-card',
    'seller-has-bank-account'
  ];
  
  let checked = 0;
  const total = checkboxes.length;
  
  checkboxes.forEach(id => {
    const cb = document.getElementById(id);
    if (cb && cb.checked) checked++;
    
    // ì²´í¬ëœ í•­ëª© ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    const label = cb?.closest('.checklist-item');
    if (label) {
      if (cb.checked) {
        label.style.background = 'var(--success-light)';
        label.style.borderColor = 'var(--success)';
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.borderColor = 'var(--gray-200)';
      }
    }
  });
  
  const progress = document.getElementById('seller-checklist-progress');
  const progressBar = document.getElementById('seller-progress-bar');
  
  if (progress) {
    progress.textContent = `${checked}/${total} ì™„ë£Œ`;
    progress.style.color = checked === total ? 'var(--success)' : 'var(--gray-500)';
  }
  if (progressBar) {
    progressBar.style.width = `${(checked / total) * 100}%`;
    progressBar.style.background = checked === total ? 'var(--success)' : 'var(--primary)';
  }
}

// ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ í•¨ìˆ˜ ==========

// êµ¬ê¸€ ë“œë¼ì´ë¸Œ ê¸°ë³¸ ë§í¬ (ë‚˜ì¤‘ì— ì‹¤ì œ ë§í¬ë¡œ êµì²´)
const GDRIVE_BASE_URL = 'https://drive.google.com/drive/folders/';
const GDRIVE_SUPPLIER_FOLDER = ''; // ê³µê¸‰ì‚¬ í´ë” ID (ë‚˜ì¤‘ì— ì„¤ì •)
const GDRIVE_SELLER_FOLDER = ''; // ì…€ëŸ¬ í´ë” ID (ë‚˜ì¤‘ì— ì„¤ì •)

// ê³µê¸‰ì‚¬ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°
function openSupplierGDrive(supplierId) {
  // ê³µê¸‰ì‚¬ë³„ í´ë”ê°€ ìˆìœ¼ë©´ í•´ë‹¹ í´ë”ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ í´ë”ë¡œ
  const supplier = state.suppliers.find(s => s.id === supplierId);
  const folderUrl = supplier?.gdriveFolder || (GDRIVE_SUPPLIER_FOLDER ? GDRIVE_BASE_URL + GDRIVE_SUPPLIER_FOLDER : '');
  
  if (folderUrl) {
    window.open(folderUrl, '_blank');
  } else {
    // í´ë” ë§í¬ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
  }
}

// ì…€ëŸ¬ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°
function openSellerGDrive(sellerId) {
  // ì…€ëŸ¬ë³„ í´ë”ê°€ ìˆìœ¼ë©´ í•´ë‹¹ í´ë”ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ í´ë”ë¡œ
  const seller = state.sellers.find(s => s.id === sellerId);
  const folderUrl = seller?.gdriveFolder || (GDRIVE_SELLER_FOLDER ? GDRIVE_BASE_URL + GDRIVE_SELLER_FOLDER : '');
  
  if (folderUrl) {
    window.open(folderUrl, '_blank');
  } else {
    // í´ë” ë§í¬ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
  }
}

// ========== ì…€ëŸ¬ ê³„ì•½ ê±´ìˆ˜ ì¡°ì • í•¨ìˆ˜ ==========

// ê³„ì•½ ê±´ìˆ˜ ì¡°ì • (â–¼â–² ë²„íŠ¼)
function adjustContractCount(delta) {
  const input = document.getElementById('seller-contract-count');
  if (!input) return;
  
  let value = parseInt(input.value) || 1;
  value = Math.max(1, Math.min(99, value + delta));
  input.value = value;
  
  updateContractCountDisplay();
}

// ê³„ì•½ ê±´ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateContractCountDisplay() {
  const input = document.getElementById('seller-contract-count');
  const display = document.getElementById('contract-count-display');
  const totalNum = document.getElementById('contract-total-num');
  
  if (!input || !display || !totalNum) return;
  
  const count = parseInt(input.value) || 1;
  totalNum.textContent = count;
  
  // ê±´ìˆ˜ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
  if (count >= 1) {
    display.style.background = 'var(--success-light)';
    display.style.color = 'var(--success)';
  }
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ í–‰ ì¶”ê°€
function addSupplierProductRow() {
  const container = document.getElementById('supplier-products-list');
  const emptyMsg = document.getElementById('supplier-products-empty');
  if (emptyMsg) emptyMsg.remove();
  
  // í˜„ì¬ ì„ íƒëœ ê³µê¸‰ì‚¬ ìœ í˜• í™•ì¸
  const supplierType = document.getElementById('supplier-type')?.value || 'external';
  const isInhouse = supplierType === 'inhouse';
  
  if (isInhouse) {
    // ìì‚¬: ìƒí’ˆëª…, ì†Œë¹„ìì •ê°€, ê³µêµ¬íŒë§¤ê°€, ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ
    container.insertAdjacentHTML('beforeend', `
      <div class="supplier-product-row" style="display: grid; grid-template-columns: 2fr 90px 90px 90px 36px; gap: 8px; align-items: center; padding: 8px; background: #fff; margin-bottom: 1px; border-bottom: 1px solid var(--gray-100);">
        <input type="text" class="form-input sp-name" placeholder="ìƒí’ˆëª…" style="font-size: 12px;">
        <input type="number" class="form-input sp-retail-price" placeholder="ì†Œë¹„ìì •ê°€" style="font-size: 12px; text-align: right;">
        <input type="number" class="form-input sp-sale-price" placeholder="ê³µêµ¬íŒë§¤ê°€" style="font-size: 12px; text-align: right;">
        <input type="number" class="form-input sp-margin-fee" placeholder="ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ" style="font-size: 12px; text-align: right; background: var(--gray-50);">
        <button type="button" onclick="removeSupplierProductRow(this)" style="background: none; border: none; color: var(--gray-400); font-size: 16px; cursor: pointer;">Ã—</button>
      </div>
    `);
  } else {
    // íƒ€ì‚¬: ìƒí’ˆëª…, ê³µêµ¬íŒë§¤ê°€, ê³µê¸‰ë‹¨ê°€, ìˆ˜ìˆ˜ë£Œ% (ìë™ê³„ì‚°)
    container.insertAdjacentHTML('beforeend', `
      <div class="supplier-product-row" style="display: grid; grid-template-columns: 2fr 90px 90px 70px 36px; gap: 8px; align-items: center; padding: 8px; background: #fff; margin-bottom: 1px; border-bottom: 1px solid var(--gray-100);">
        <input type="text" class="form-input sp-name" placeholder="ìƒí’ˆëª…" style="font-size: 12px;">
        <input type="number" class="form-input sp-sale-price" placeholder="ê³µêµ¬íŒë§¤ê°€" style="font-size: 12px; text-align: right;" onchange="calcSupplyOrFee(this, 'sale')">
        <input type="number" class="form-input sp-supply-price" placeholder="ê³µê¸‰ë‹¨ê°€" style="font-size: 12px; text-align: right;" onchange="calcSupplyOrFee(this, 'supply')">
        <input type="number" class="form-input sp-fee-percent" placeholder="%" step="0.1" style="font-size: 12px; text-align: right; background: var(--gray-50);" onchange="calcSupplyOrFee(this, 'percent')">
        <button type="button" onclick="removeSupplierProductRow(this)" style="background: none; border: none; color: var(--gray-400); font-size: 16px; cursor: pointer;">Ã—</button>
      </div>
    `);
  }
}

// ê³µê¸‰ë‹¨ê°€/ìˆ˜ìˆ˜ë£Œ% ìë™ ê³„ì‚°
function calcSupplyOrFee(input, changedField) {
  const row = input.closest('.supplier-product-row');
  const salePrice = Number(row.querySelector('.sp-sale-price')?.value) || 0;
  const supplyPrice = row.querySelector('.sp-supply-price');
  const feePercent = row.querySelector('.sp-fee-percent');
  
  if (!supplyPrice || !feePercent || salePrice === 0) return;
  
  if (changedField === 'sale') {
    // íŒë§¤ê°€ ë³€ê²½ ì‹œ: ê³µê¸‰ë‹¨ê°€ê°€ ìˆìœ¼ë©´ ìˆ˜ìˆ˜ë£Œ% ê³„ì‚°, ìˆ˜ìˆ˜ë£Œ%ê°€ ìˆìœ¼ë©´ ê³µê¸‰ë‹¨ê°€ ê³„ì‚°
    const supply = Number(supplyPrice.value) || 0;
    const percent = Number(feePercent.value) || 0;
    
    if (supply > 0) {
      // ìˆ˜ìˆ˜ë£Œ% = (íŒë§¤ê°€ - ê³µê¸‰ë‹¨ê°€) / íŒë§¤ê°€ * 100
      feePercent.value = Math.round((salePrice - supply) / salePrice * 100 * 10) / 10;
    } else if (percent > 0) {
      // ê³µê¸‰ë‹¨ê°€ = íŒë§¤ê°€ * (1 - ìˆ˜ìˆ˜ë£Œ%/100)
      supplyPrice.value = Math.round(salePrice * (1 - percent / 100));
    }
  } else if (changedField === 'supply') {
    // ê³µê¸‰ë‹¨ê°€ ì…ë ¥ ì‹œ â†’ ìˆ˜ìˆ˜ë£Œ% ìë™ ê³„ì‚°
    const supply = Number(supplyPrice.value) || 0;
    if (salePrice > 0 && supply > 0) {
      feePercent.value = Math.round((salePrice - supply) / salePrice * 100 * 10) / 10;
    }
  } else if (changedField === 'percent') {
    // ìˆ˜ìˆ˜ë£Œ% ì…ë ¥ ì‹œ â†’ ê³µê¸‰ë‹¨ê°€ ìë™ ê³„ì‚°
    const percent = Number(feePercent.value) || 0;
    if (salePrice > 0 && percent > 0) {
      supplyPrice.value = Math.round(salePrice * (1 - percent / 100));
    }
  }
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ í–‰ ì‚­ì œ
function removeSupplierProductRow(btn) {
  const row = btn.closest('.supplier-product-row');
  row.remove();
}

// ê³µê¸‰ì‚¬ ìœ í˜• ë³€ê²½ ì‹œ ìƒí’ˆ ì„¹ì…˜ ì—…ë°ì´íŠ¸
function updateSupplierProductSection() {
  const supplierType = document.getElementById('supplier-type')?.value || 'external';
  const isInhouse = supplierType === 'inhouse';
  
  // ë¼ë²¨ ì—…ë°ì´íŠ¸
  const typeLabel = document.getElementById('supplier-product-type-label');
  if (typeLabel) {
    typeLabel.textContent = `(${isInhouse ? 'ìì‚¬' : 'íƒ€ì‚¬'} ìƒí’ˆ)`;
  }
  
  // í—¤ë” ì—…ë°ì´íŠ¸
  const header = document.getElementById('supplier-product-header');
  if (header) {
    if (isInhouse) {
      header.style.gridTemplateColumns = '2fr 90px 90px 90px 36px';
      header.innerHTML = `
        <div>ìƒí’ˆëª…</div>
        <div style="text-align: right;">ì†Œë¹„ìì •ê°€</div>
        <div style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</div>
        <div style="text-align: right;">ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ</div>
        <div></div>
      `;
    } else {
      header.style.gridTemplateColumns = '2fr 90px 90px 70px 36px';
      header.innerHTML = `
        <div>ìƒí’ˆëª…</div>
        <div style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</div>
        <div style="text-align: right;">ê³µê¸‰ë‹¨ê°€</div>
        <div style="text-align: right;">ìˆ˜ìˆ˜ë£Œ%</div>
        <div></div>
      `;
    }
  }
  
  // ê¸°ì¡´ ìƒí’ˆ ëª©ë¡ì´ ìˆìœ¼ë©´ ê²½ê³ 
  const productRows = document.querySelectorAll('.supplier-product-row');
  if (productRows.length > 0) {
    const confirmChange = confirm(`ìœ í˜•ì„ ë³€ê²½í•˜ë©´ ê¸°ì¡´ ì…ë ¥í•œ ìƒí’ˆ ${productRows.length}ê°œê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if (confirmChange) {
      // ê¸°ì¡´ ìƒí’ˆ ì‚­ì œ
      const container = document.getElementById('supplier-products-list');
      container.innerHTML = `
        <div id="supplier-products-empty" style="text-align: center; padding: 20px; color: var(--gray-600); font-size: 13px;">
          + ìƒí’ˆ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒí’ˆì„ ë“±ë¡í•˜ì„¸ìš”
        </div>
      `;
    } else {
      // ì·¨ì†Œ ì‹œ ì›ë˜ ìœ í˜•ìœ¼ë¡œ ë³µì›
      document.getElementById('supplier-type').value = isInhouse ? 'external' : 'inhouse';
      updateSupplierProductSection();
    }
  }
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
function downloadSupplierProductTemplate() {
  const supplierType = document.getElementById('supplier-type')?.value || 'external';
  const isInhouse = supplierType === 'inhouse';
  
  let ws, filename;
  
  if (isInhouse) {
    // ìì‚¬ ì–‘ì‹: ìƒí’ˆëª…, ì†Œë¹„ìì •ê°€, ê³µêµ¬íŒë§¤ê°€, ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ
    ws = XLSX.utils.aoa_to_sheet([
      ['ìƒí’ˆëª…', 'ì†Œë¹„ìì •ê°€', 'ê³µêµ¬íŒë§¤ê°€', 'ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ'],
      ['ì˜ˆì‹œ: í”„ë¦¬ë¯¸ì—„ ì´ìœ ì‹ 10íŒ©', '50000', '45000', '5000'],
      ['ì˜ˆì‹œ: ìœ ê¸°ë† ìŒ€ê³¼ì ì„¸íŠ¸', '30000', '27000', '3000']
    ]);
    filename = 'ìì‚¬ìƒí’ˆ_ì–‘ì‹.xlsx';
  } else {
    // íƒ€ì‚¬ ì–‘ì‹: ìƒí’ˆëª…, ê³µêµ¬íŒë§¤ê°€, ê³µê¸‰ë‹¨ê°€(V+)
    ws = XLSX.utils.aoa_to_sheet([
      ['ìƒí’ˆëª…', 'ê³µêµ¬íŒë§¤ê°€', 'ê³µê¸‰ë‹¨ê°€(V+)'],
      ['ì˜ˆì‹œ: ìœ ê¸°ë† ìŒ€ê³¼ì 10ë´‰', '17100', '12000'],
      ['ì˜ˆì‹œ: ABCì£¼ìŠ¤ 2ë°•ìŠ¤', '56700', '45000']
    ]);
    filename = 'íƒ€ì‚¬ìƒí’ˆ_ì–‘ì‹.xlsx';
  }
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ìƒí’ˆëª©ë¡');
  XLSX.writeFile(wb, filename);
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ ì—‘ì…€ ì—…ë¡œë“œ
function handleSupplierProductExcel(file) {
  if (!file) return;
  
  const supplierType = document.getElementById('supplier-type')?.value || 'external';
  const isInhouse = supplierType === 'inhouse';
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      const container = document.getElementById('supplier-products-list');
      const emptyMsg = document.getElementById('supplier-products-empty');
      if (emptyMsg) emptyMsg.remove();
      
      // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° í–‰ ì²˜ë¦¬
      let count = 0;
      jsonData.slice(1).forEach(row => {
        if (!row[0]) return; // ìƒí’ˆëª… ì—†ìœ¼ë©´ ìŠ¤í‚µ
        
        if (isInhouse) {
          // ìì‚¬: ìƒí’ˆëª…, ì†Œë¹„ìì •ê°€, ê³µêµ¬íŒë§¤ê°€, ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ
          container.insertAdjacentHTML('beforeend', `
            <div class="supplier-product-row" style="display: grid; grid-template-columns: 2fr 90px 90px 90px 36px; gap: 8px; align-items: center; padding: 8px; background: #fff; margin-bottom: 1px; border-bottom: 1px solid var(--gray-100);">
              <input type="text" class="form-input sp-name" value="${row[0] || ''}" placeholder="ìƒí’ˆëª…" style="font-size: 13px;">
              <input type="number" class="form-input sp-retail-price" value="${row[1] || ''}" placeholder="ì†Œë¹„ìì •ê°€" style="font-size: 13px; text-align: right;">
              <input type="number" class="form-input sp-sale-price" value="${row[2] || ''}" placeholder="ê³µêµ¬íŒë§¤ê°€" style="font-size: 13px; text-align: right;">
              <input type="number" class="form-input sp-margin-fee" value="${row[3] || ''}" placeholder="ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ" style="font-size: 13px; text-align: right; background: var(--gray-50);">
              <button type="button" onclick="removeSupplierProductRow(this)" style="background: none; border: none; color: var(--danger); font-size: 18px; cursor: pointer;">Ã—</button>
            </div>
          `);
        } else {
          // íƒ€ì‚¬: ìƒí’ˆëª…, ê³µêµ¬íŒë§¤ê°€, ê³µê¸‰ë‹¨ê°€(V+)
          container.insertAdjacentHTML('beforeend', `
            <div class="supplier-product-row" style="display: grid; grid-template-columns: 2fr 100px 100px 36px; gap: 8px; align-items: center; padding: 8px; background: #fff; margin-bottom: 1px; border-bottom: 1px solid var(--gray-100);">
              <input type="text" class="form-input sp-name" value="${row[0] || ''}" placeholder="ìƒí’ˆëª…" style="font-size: 13px;">
              <input type="number" class="form-input sp-sale-price" value="${row[1] || ''}" placeholder="ê³µêµ¬íŒë§¤ê°€" style="font-size: 13px; text-align: right;">
              <input type="number" class="form-input sp-supply-price" value="${row[2] || ''}" placeholder="ê³µê¸‰ë‹¨ê°€(V+)" style="font-size: 13px; text-align: right; background: var(--gray-50);">
              <button type="button" onclick="removeSupplierProductRow(this)" style="background: none; border: none; color: var(--danger); font-size: 18px; cursor: pointer;">Ã—</button>
            </div>
          `);
        }
        count++;
      });
      
      showToast(`${count}ê°œ ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
    } catch (err) {
      showToast('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
}

// ê³µê¸‰ì‚¬ ì…ë ¥ ë°©ì‹ ì „í™˜
function showSupplierTextInput() {
  document.getElementById('supplier-excel-upload').style.display = 'none';
  document.getElementById('supplier-text-input').style.display = 'block';
  window.supplierBulkMode = 'text';
}

function showSupplierExcelUpload() {
  document.getElementById('supplier-excel-upload').style.display = 'block';
  document.getElementById('supplier-text-input').style.display = 'none';
  window.supplierBulkMode = 'excel';
}

// ê³µê¸‰ì‚¬ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
let supplierExcelData = [];

function handleSupplierExcelDrop(e) {
  e.preventDefault();
  e.target.style.borderColor = 'var(--gray-300)';
  e.target.style.background = 'transparent';
  const file = e.dataTransfer.files[0];
  if (file) handleSupplierExcelFile(file);
}

function handleSupplierExcelFile(file) {
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      const headers = jsonData[0].map(h => String(h).trim());
      const rows = jsonData.slice(1).filter(row => row.some(cell => cell));
      
      const colMap = {
        name: headers.findIndex(h => h.includes('ê³µê¸‰ì‚¬') || h.includes('ì´ë¦„') || h.toLowerCase().includes('name')),
        contact: headers.findIndex(h => h.includes('ì—°ë½') || h.includes('ì „í™”') || h.toLowerCase().includes('contact')),
        notes: headers.findIndex(h => h.includes('ë©”ëª¨') || h.includes('ë¹„ê³ ') || h.toLowerCase().includes('note'))
      };
      
      supplierExcelData = rows.map(row => ({
        name: colMap.name >= 0 ? String(row[colMap.name] || '').trim() : '',
        contact: colMap.contact >= 0 ? String(row[colMap.contact] || '').trim() : '',
        notes: colMap.notes >= 0 ? String(row[colMap.notes] || '').trim() : ''
      })).filter(item => item.name);
      
      const previewDiv = document.getElementById('supplier-excel-preview');
      const countSpan = document.getElementById('supplier-preview-count');
      const thead = document.querySelector('#supplier-preview-table thead');
      const tbody = document.querySelector('#supplier-preview-table tbody');
      
      countSpan.textContent = `(${supplierExcelData.length}ê°œ)`;
      thead.innerHTML = '<tr><th>ê³µê¸‰ì‚¬ëª…</th><th>ì—°ë½ì²˜</th><th>ë©”ëª¨</th></tr>';
      tbody.innerHTML = supplierExcelData.slice(0, 10).map(s => `
        <tr><td>${s.name}</td><td>${s.contact}</td><td>${s.notes}</td></tr>
      `).join('') + (supplierExcelData.length > 10 ? `<tr><td colspan="3" style="text-align:center;color:var(--gray-500)">... ì™¸ ${supplierExcelData.length - 10}ê°œ</td></tr>` : '');
      
      previewDiv.style.display = 'block';
      showToast(`${supplierExcelData.length}ê°œì˜ ê³µê¸‰ì‚¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
      
    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };
  reader.readAsArrayBuffer(file);
}

function downloadSupplierTemplate() {
  const ws = XLSX.utils.aoa_to_sheet([
    ['ê³µê¸‰ì‚¬ëª…', 'ì—°ë½ì²˜', 'ë©”ëª¨'],
    ['ABC ì‹í’ˆ', '010-1234-5678', 'ê³¼ì¼ ì „ë¬¸'],
    ['XYZ ìœ í†µ', '02-555-1234', ''],
  ]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ê³µê¸‰ì‚¬ëª©ë¡');
  XLSX.writeFile(wb, 'ê³µê¸‰ì‚¬_ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx');
}

async function submitBulkSuppliers() {
  let dataToSubmit = [];
  
  if (window.supplierBulkMode !== 'text' && supplierExcelData.length > 0) {
    dataToSubmit = supplierExcelData;
  } else {
    const text = document.getElementById('bulk-suppliers')?.value?.trim();
    if (!text) {
      showToast('ê³µê¸‰ì‚¬ ëª©ë¡ì„ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    dataToSubmit = lines.map(line => {
      const parts = line.split(',').map(p => p.trim());
      return {
        name: parts[0] || '',
        contact: parts[1] || '',
        notes: parts[2] || ''
      };
    }).filter(item => item.name);
  }
  
  if (dataToSubmit.length === 0) {
    showToast('ë“±ë¡í•  ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  let successCount = 0;
  for (const data of dataToSubmit) {
    try {
      await db.collection('suppliers').add(data);
      successCount++;
    } catch(e) {
      console.error(e);
    }
  }
  
  supplierExcelData = [];
  showToast(`${successCount}ê°œì˜ ê³µê¸‰ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
  closeModal();
}

// ë°œì£¼ì–‘ì‹ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
async function handleOrderFormUpload(input, supplierId) {
  const file = input.files[0];
  if (!file) return;
  
  // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì´í•˜)
  if (file.size > 5 * 1024 * 1024) {
    showToast('âš ï¸ íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤');
    return;
  }
  
  // íŒŒì¼ í™•ì¥ì ì²´í¬
  const ext = file.name.split('.').pop().toLowerCase();
  if (!['xlsx', 'xls'].includes(ext)) {
    showToast('âš ï¸ .xlsx ë˜ëŠ” .xls íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
    return;
  }
  
  showToast('ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
  
  try {
    // Firebase Storageì— ì—…ë¡œë“œ
    const storageRef = firebase.storage().ref();
    const fileRef = storageRef.child(`order-forms/${supplierId || 'new'}/${Date.now()}_${file.name}`);
    
    await fileRef.put(file);
    const downloadUrl = await fileRef.getDownloadURL();
    
    // ê³µê¸‰ì‚¬ê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë°”ë¡œ ì—…ë°ì´íŠ¸
    if (supplierId) {
      await db.collection('suppliers').doc(supplierId).update({
        orderFormUrl: downloadUrl,
        orderFormName: file.name,
        updatedAt: new Date().toISOString()
      });
      
      // state ì—…ë°ì´íŠ¸
      const supplierIdx = state.suppliers.findIndex(s => s.id === supplierId);
      if (supplierIdx !== -1) {
        state.suppliers[supplierIdx].orderFormUrl = downloadUrl;
        state.suppliers[supplierIdx].orderFormName = file.name;
      }
      
      showToast('âœ… ë°œì£¼ì–‘ì‹ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
      
      // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
      const supplier = state.suppliers.find(s => s.id === supplierId);
      if (supplier) {
        closeModal();
        setTimeout(() => openSupplierModal(supplier), 100);
      }
    } else {
      // ìƒˆ ë“±ë¡ ì‹œ ì„ì‹œ ì €ì¥
      window.tempOrderFormUrl = downloadUrl;
      window.tempOrderFormName = file.name;
      showToast('âœ… ë°œì£¼ì–‘ì‹ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤ (ì €ì¥ ì‹œ í•¨ê»˜ ë“±ë¡ë©ë‹ˆë‹¤)');
    }
  } catch (error) {
    console.error('ë°œì£¼ì–‘ì‹ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    showToast('âš ï¸ íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ë°œì£¼ì–‘ì‹ ì‚­ì œ
async function removeOrderForm(supplierId) {
  if (!confirm('ë°œì£¼ì–‘ì‹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('suppliers').doc(supplierId).update({
      orderFormUrl: firebase.firestore.FieldValue.delete(),
      orderFormName: firebase.firestore.FieldValue.delete(),
      updatedAt: new Date().toISOString()
    });
    
    // state ì—…ë°ì´íŠ¸
    const supplierIdx = state.suppliers.findIndex(s => s.id === supplierId);
    if (supplierIdx !== -1) {
      delete state.suppliers[supplierIdx].orderFormUrl;
      delete state.suppliers[supplierIdx].orderFormName;
    }
    
    showToast('âœ… ë°œì£¼ì–‘ì‹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    
    // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (supplier) {
      closeModal();
      setTimeout(() => openSupplierModal(supplier), 100);
    }
  } catch (error) {
    console.error('ë°œì£¼ì–‘ì‹ ì‚­ì œ ì˜¤ë¥˜:', error);
    showToast('âš ï¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function submitSupplierForm(e, id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();
  
  const supplierType = document.getElementById('supplier-type').value;
  const isInhouse = supplierType === 'inhouse';
  
  // ìƒí’ˆ ëª©ë¡ ìˆ˜ì§‘ - ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ í•„ë“œ ìˆ˜ì§‘
  const productRows = document.querySelectorAll('.supplier-product-row');
  const products = [];
  productRows.forEach(row => {
    const name = row.querySelector('.sp-name')?.value.trim();
    const salePrice = row.querySelector('.sp-sale-price')?.value;
    
    if (name) {
      if (isInhouse) {
        // ìì‚¬: ì†Œë¹„ìì •ê°€, ê³µêµ¬íŒë§¤ê°€, ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ
        const retailPrice = row.querySelector('.sp-retail-price')?.value;
        const marginFee = row.querySelector('.sp-margin-fee')?.value;
        products.push({
          productName: name,
          retailPrice: Number(retailPrice) || 0,
          salePrice: Number(salePrice) || 0,
          marginFee: Number(marginFee) || 0,
          supplyPrice: 0, // ìì‚¬ëŠ” ê³µê¸‰ë‹¨ê°€ ì—†ìŒ
          fee: 0,
          existingId: row.dataset.productId || null
        });
      } else {
        // íƒ€ì‚¬: ê³µêµ¬íŒë§¤ê°€, ê³µê¸‰ë‹¨ê°€, ìˆ˜ìˆ˜ë£Œ%
        const supplyPrice = row.querySelector('.sp-supply-price')?.value;
        const feePercent = row.querySelector('.sp-fee-percent')?.value;
        products.push({
          productName: name,
          retailPrice: 0,
          salePrice: Number(salePrice) || 0,
          supplyPrice: Number(supplyPrice) || 0,
          feePercent: Number(feePercent) || 0,
          marginFee: 0, // íƒ€ì‚¬ëŠ” ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ ì—†ìŒ
          existingId: row.dataset.productId || null
        });
      }
    }
  });
  
  const data = {
    name: document.getElementById('supplier-name').value,
    supplierType: supplierType,
    companySize: document.getElementById('supplier-company-size')?.value || '',
    website: document.getElementById('supplier-website').value,
    managerName: document.getElementById('supplier-manager-name').value,
    managerTitle: document.getElementById('supplier-manager-title').value,
    managerPhone: document.getElementById('supplier-manager-phone').value,
    managerEmail: document.getElementById('supplier-manager-email').value,
    inquiryMethod: document.getElementById('supplier-inquiry').value,
    contractStatus: document.getElementById('supplier-contract-status').value,
    bankAccount: document.getElementById('supplier-bank-account').value,
    // ì„œë¥˜ ìˆ˜ë ¹ ì²´í¬ë°•ìŠ¤ (4ê°œ í•­ëª©)
    hasProductInfo: document.getElementById('supplier-has-product-info')?.checked || false,
    hasBusinessLicense: document.getElementById('supplier-has-business-license')?.checked || false,
    hasBankAccount: document.getElementById('supplier-has-bank-account')?.checked || false,
    hasContract: document.getElementById('supplier-has-contract')?.checked || false,
    // ë¡œê·¸ì¸ ì •ë³´
    loginId: document.getElementById('supplier-login-id')?.value || '',
    loginPw: document.getElementById('supplier-login-pw')?.value || '',
    notes: document.getElementById('supplier-notes').value,
    contact: document.getElementById('supplier-manager-phone').value, // í˜¸í™˜ì„±
    _products: products // ìƒí’ˆ ëª©ë¡ (saveSupplierì—ì„œ ì²˜ë¦¬)
  };
  
  if (id) data.id = id;
  saveSupplierWithProducts(data);
}

// ê³µê¸‰ì‚¬ì™€ ìƒí’ˆì„ í•¨ê»˜ ì €ì¥
async function saveSupplierWithProducts(data) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  const products = data._products || [];
  delete data._products;
  
  const supplierName = data.name;
  const supplierType = data.supplierType;
  
  try {
    let supplierId = data.id;
    
    // ê³µê¸‰ì‚¬ ì €ì¥
    if (data.id) {
      data.updatedAt = new Date().toISOString();
      await db.collection('suppliers').doc(data.id).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      const docRef = await db.collection('suppliers').add(data);
      supplierId = docRef.id;
    }
    
    // ê¸°ì¡´ ìƒí’ˆ ì¤‘ ì‚­ì œëœ ê²ƒ ì²˜ë¦¬
    const existingProducts = (state.supplierProducts || []).filter(p => p.supplierId === supplierId);
    const existingIds = products.filter(p => p.existingId).map(p => p.existingId);
    
    for (const existingProduct of existingProducts) {
      if (!existingIds.includes(existingProduct.id)) {
        // ì‚­ì œëœ ìƒí’ˆ
        await db.collection('supplierProducts').doc(existingProduct.id).delete();
      }
    }
    
    // ìƒí’ˆ ì €ì¥/ì—…ë°ì´íŠ¸
    for (const product of products) {
      const productData = {
        supplierId: supplierId,
        brandName: supplierName,
        supplierType: supplierType,
        productName: product.productName,
        retailPrice: product.retailPrice || 0,  // ì†Œë¹„ìì •ê°€ (ìì‚¬ìš©)
        salePrice: product.salePrice || 0,       // ê³µêµ¬íŒë§¤ê°€
        supplyPrice: product.supplyPrice || 0,   // ê³µê¸‰ë‹¨ê°€(V+) (íƒ€ì‚¬ìš©)
        marginFee: product.marginFee || 0,       // ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ (ìì‚¬ìš©)
        updatedAt: new Date().toISOString()
      };
      
      if (product.existingId) {
        // ê¸°ì¡´ ìƒí’ˆ ì—…ë°ì´íŠ¸
        await db.collection('supplierProducts').doc(product.existingId).update(productData);
      } else {
        // ìƒˆ ìƒí’ˆ ì¶”ê°€
        productData.createdAt = new Date().toISOString();
        await db.collection('supplierProducts').add(productData);
      }
    }
    
    showToast(data.id ? 'ê³µê¸‰ì‚¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ê³µê¸‰ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function openSellerModal(seller = null, bulk = false) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  if (bulk) {
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ì…€ëŸ¬ ì¼ê´„ ë“±ë¡</h2>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
          <button class="btn btn-secondary" style="flex:1" onclick="showSellerTextInput()">ğŸ“ í…ìŠ¤íŠ¸ ì…ë ¥</button>
          <button class="btn btn-primary" style="flex:1" onclick="showSellerExcelUpload()">ğŸ“Š ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        
        <div id="seller-bulk-content">
          <div id="seller-excel-upload">
            <div class="form-group">
              <label class="form-label">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">
                ì—‘ì…€ íŒŒì¼ì˜ ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.<br>
                <strong>í•„ìˆ˜ ì—´:</strong> ì…€ëŸ¬ëª…, ì—°ë½ì²˜, ì±„ë„ë§í¬, íŒ”ë¡œì›Œìˆ˜, ì¹´í…Œê³ ë¦¬, ë©”ëª¨
              </p>
              <div style="border: 2px dashed var(--gray-300); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.15s ease;" 
                   onclick="document.getElementById('excel-file-seller').click()"
                   ondragover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'; event.preventDefault()"
                   ondragleave="this.style.borderColor='var(--gray-300)'; this.style.background='transparent'"
                   ondrop="handleSellerExcelDrop(event)">
                <div style="font-size: 36px; margin-bottom: 8px;">ğŸ“</div>
                <div style="color: var(--gray-700); font-weight: 500;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                <div style="color: var(--gray-500); font-size: 13px; margin-top: 4px;">.xlsx, .xls íŒŒì¼ ì§€ì›</div>
              </div>
              <input type="file" id="excel-file-seller" accept=".xlsx,.xls" style="display:none" onchange="handleSellerExcelFile(this.files[0])">
            </div>
            
            <div id="seller-excel-preview" style="display:none; margin-top: 16px;">
              <div class="form-label">ë¯¸ë¦¬ë³´ê¸° <span id="seller-preview-count" style="color: var(--primary);"></span></div>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 8px;">
                <table class="data-table" id="seller-preview-table">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            
            <div style="margin-top: 16px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px;">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì˜ˆì‹œ</div>
              <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">
                ì¹´í…Œê³ ë¦¬: ìœ¡ì•„, ì‹í’ˆ, ë¯¸ìš©, ìƒí™œ, ì·¨ë¯¸, ê±´ê°• ì¤‘ ì„ íƒ
              </p>
              <div style="overflow-x: auto;">
                <table style="font-size: 12px; border-collapse: collapse; width: 100%;">
                  <tr style="background: var(--primary-light);">
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì…€ëŸ¬ëª…/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì—°ë½ì²˜</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì£¼ì†Œ</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ê³„ì •ë§í¬</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì¹´í…Œê³ ë¦¬</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ë©”ëª¨</th>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ë·°í‹°ë§ˆì¼“(5ë§Œ)</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">010-1234-5678</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ì„œìš¸ì‹œ ê°•ë‚¨êµ¬</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">instagram.com/beauty</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ë¯¸ìš©</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">VIP ì…€ëŸ¬</td>
                  </tr>
                </table>
              </div>
              <button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="downloadSellerTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
          
          <div id="seller-text-input" style="display: none;">
            <div class="form-group">
              <label class="form-label">ì…€ëŸ¬ ëª©ë¡</label>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">
                í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”. (ì‰¼í‘œë¡œ êµ¬ë¶„)<br>
                í˜•ì‹: ì…€ëŸ¬ëª…(íŒ”ë¡œì›Œìˆ˜), ì—°ë½ì²˜, ì£¼ì†Œ, ê³„ì •ë§í¬, ì¹´í…Œê³ ë¦¬, ë©”ëª¨
              </p>
              <textarea class="form-textarea" id="bulk-sellers" rows="10" placeholder="ì˜ˆì‹œ:
ë·°í‹°ë§ˆì¼“(5ë§Œ), 010-1234-5678, ì„œìš¸ì‹œ ê°•ë‚¨êµ¬, instagram.com/beauty, ë¯¸ìš©, VIP ì…€ëŸ¬
í—¬ìŠ¤ìŠ¤í† ì–´(12ë§Œ), 010-2222-3333, ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬, youtube.com/health, ê±´ê°•
ë§˜ìŠ¤í† ì–´(3ë§Œ), 010-4444-5555, ê²½ê¸°ë„ ì„±ë‚¨ì‹œ, blog.naver.com/mom, ìœ¡ì•„, ì‹ ê·œ"></textarea>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="seller-bulk-submit" onclick="submitBulkSellers()">ì¼ê´„ ë“±ë¡</button>
        </div>
      </div>
    `;
    return;
  }
  
  const isEdit = seller !== null;
  const s = seller || { name: '', contact: '', address: '', channelLink: '', followers: '', category: '', notes: '' };
  
  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  const categories = ['ìœ¡ì•„', 'ì‹í’ˆ', 'ë¯¸ìš©', 'ìƒí™œ', 'ì·¨ë¯¸', 'ê±´ê°•'];
  
  // ìˆ˜ì • ì‹œ í•´ë‹¹ ì…€ëŸ¬ì˜ í†µê³„ ê³„ì‚°
  let sellerStatsHtml = '';
  if (isEdit) {
    const sellerSettlements = (state.sellerSettlements || []).filter(ss => ss.sellerName === s.name);
    let totalSalesCount = 0;
    let totalSalesAmount = 0;
    let totalMarginAmount = 0;
    
    sellerSettlements.forEach(ss => {
      const items = ss.salesItems || [];
      totalSalesCount += items.length;
      totalSalesAmount += items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      totalMarginAmount += items.reduce((sum, item) => sum + (Number(item.marginAmount) || 0), 0);
    });
    
    if (totalSalesCount > 0) {
      sellerStatsHtml = `
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <h3 style="font-size: 14px; color: var(--info); margin-bottom: 12px;">ğŸ“Š ì •ì‚° í˜„í™©</h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--gray-600);">ì´ íŒë§¤ê±´</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${totalSalesCount}ê±´</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--gray-600);">ì´ íŒë§¤ì•¡</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--primary);">${totalSalesAmount.toLocaleString()}ì›</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--gray-600);">ì´ ë§ˆì§„ê¸ˆ</div>
              <div style="font-size: 18px; font-weight: 700; color: #d97706;">${totalMarginAmount.toLocaleString()}ì›</div>
            </div>
          </div>
        </div>
      `;
    }
  }
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ‘¤ ${isEdit ? 'ì…€ëŸ¬ ìˆ˜ì •' : 'ìƒˆ ì…€ëŸ¬ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitSellerForm(event, '${s.id || ''}')" style="max-height: 75vh; overflow-y: auto; padding-right: 8px;">
        ${sellerStatsHtml}
        
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="form-label">ì…€ëŸ¬ëª…/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜) *</label>
              <input type="text" class="form-input" id="seller-name" value="${s.name}" required placeholder="ì˜ˆ: ë·°í‹°ë§ˆì¼“(5ë§Œ) ë˜ëŠ” í—¬ìŠ¤ìŠ¤í† ì–´(12ë§Œ)">
              <p style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">íŒ”ë¡œì›Œìˆ˜ëŠ” ê´„í˜¸ ì•ˆì— ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
              <select class="form-input" id="seller-category">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${categories.map(cat => `<option value="${cat}" ${s.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì—°ë½ì²˜</label>
              <input type="text" class="form-input" id="seller-contact" value="${s.contact || ''}" placeholder="010-0000-0000">
            </div>
            <div class="form-group">
              <label class="form-label">ì£¼ì†Œ</label>
              <input type="text" class="form-input" id="seller-address" value="${s.address || ''}" placeholder="ë°°ì†¡ì§€ ì£¼ì†Œ">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì„±ê³¼ ë“±ê¸‰ (ë¶„ì„ìš©)</label>
              <select class="form-input" id="seller-performance-grade">
                <option value="" ${!s.performanceGrade ? 'selected' : ''}>ì„ íƒ</option>
                <option value="S" ${s.performanceGrade === 'S' ? 'selected' : ''}>â­ Së“±ê¸‰ (íŒë§¤ìœ¨ 30%+)</option>
                <option value="A" ${s.performanceGrade === 'A' ? 'selected' : ''}>ğŸ¥‡ Aë“±ê¸‰ (íŒë§¤ìœ¨ 20%+)</option>
                <option value="B" ${s.performanceGrade === 'B' ? 'selected' : ''}>ğŸ¥ˆ Bë“±ê¸‰ (íŒë§¤ìœ¨ 10%+)</option>
                <option value="C" ${s.performanceGrade === 'C' ? 'selected' : ''}>ğŸ¥‰ Cë“±ê¸‰ (íŒë§¤ìœ¨ 10%-)</option>
                <option value="NEW" ${s.performanceGrade === 'NEW' ? 'selected' : ''}>ğŸ†• ì‹ ê·œ (ë°ì´í„° ì—†ìŒ)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">í˜‘ë ¥ ìƒíƒœ</label>
              <select class="form-input" id="seller-status">
                <option value="active" ${s.sellerStatus === 'active' ? 'selected' : ''}>ğŸŸ¢ í™œì„±</option>
                <option value="inactive" ${s.sellerStatus === 'inactive' ? 'selected' : ''}>ğŸ”´ ë¹„í™œì„±</option>
                <option value="pending" ${s.sellerStatus === 'pending' ? 'selected' : ''}>ğŸŸ¡ í˜‘ì˜ì¤‘</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- ì±„ë„ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ“± ì±„ë„ ì •ë³´</h3>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">ê³„ì •ë§í¬</label>
            <input type="text" class="form-input" id="seller-channelLink" value="${s.channelLink || s.accountLink || ''}" placeholder="ì˜ˆ: https://www.instagram.com/username">
          </div>
        </div>
        
        <!-- ğŸ†• ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (íŒŒì¼ ì²¨ë¶€ ì‚­ì œ) -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ“„ ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
          
          <!-- ì„œë¥˜ ìˆ˜ë ¹ ì²´í¬ -->
          <div style="background: white; border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <label class="form-label" style="margin: 0;">ğŸ“‹ ì„œë¥˜ ìˆ˜ë ¹ í˜„í™©</label>
              <div id="seller-checklist-progress" style="font-size: 12px; color: var(--gray-500);">0/4 ì™„ë£Œ</div>
            </div>
            
            <!-- ì§„í–‰ë¥  ë°” -->
            <div style="height: 6px; background: var(--gray-200); border-radius: 3px; margin-bottom: 16px; overflow: hidden;">
              <div id="seller-progress-bar" style="height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s ease; width: 0%;"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <!-- ë¯¼ì¦ -->
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="seller-has-id-card" ${s.hasIdCard ? 'checked' : ''} onchange="updateSellerProgress()" style="width: 20px; height: 20px; accent-color: var(--primary);">
                <span style="font-size: 13px; font-weight: 500;">ğŸªª ë¯¼ì¦</span>
              </label>
              
              <!-- í†µì¥ -->
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="seller-has-bank-account" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSellerProgress()" style="width: 20px; height: 20px; accent-color: var(--primary);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ¦ í†µì¥</span>
              </label>
            </div>
            
            <!-- êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°”ë¡œê°€ê¸° ë²„íŠ¼ -->
            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--gray-300);">
              <a href="#" id="seller-gdrive-link" onclick="openSellerGDrive('${s.id || ''}')" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(66,133,244,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                  <path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/>
                </svg>
                ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ì„œë¥˜ ê´€ë¦¬
              </a>
            </div>
          </div>
        </div>
        
        <!-- ğŸ” ë¡œê·¸ì¸ ì •ë³´ (ì¼ì •í‘œ ê³µìœ ìš©) -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--gray-300);">
          <h3 style="font-size: 14px; color: #be185d; margin-bottom: 8px;">ğŸ” ì¼ì •í‘œ ë¡œê·¸ì¸ ì •ë³´</h3>
          <p style="font-size: 12px; color: #db2777; margin-bottom: 12px;">ì…€ëŸ¬ê°€ ì¼ì •í‘œì— ì ‘ì†í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê³„ì •ì…ë‹ˆë‹¤.</p>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì•„ì´ë””</label>
              <input type="text" class="form-input" id="seller-login-id" value="${s.loginId || ''}" placeholder="ì˜ˆ: jinhama" style="background: white;">
            </div>
            <div class="form-group">
              <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="text" class="form-input" id="seller-login-pw" value="${s.loginPw || ''}" placeholder="ì˜ˆ: 1234" style="background: white;">
            </div>
          </div>
        </div>
        
        <!-- ğŸ†• ì…€ëŸ¬ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        ${isEdit ? `
        <div style="background: var(--primary-light); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--primary);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="font-size: 13px; color: var(--primary); font-weight: 600; margin: 0;">ğŸ¯ ì…€ëŸ¬ ê´€ë¦¬ ì—¬ì •</h3>
            <div id="seller-journey-progress" style="font-size: 12px; color: var(--primary); font-weight: 600;">0/5 ì™„ë£Œ</div>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid var(--gray-200);" class="seller-journey-item">
              <input type="checkbox" id="seller-journey-contact" ${s.journeyFirstContact ? 'checked' : ''} onchange="updateSellerJourneyProgress()" style="width: 16px; height: 16px; accent-color: var(--primary);">
              <span style="font-size: 13px;">ğŸ“ ì²« ë¯¸íŒ…/ì—°ë½</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid var(--gray-200);" class="seller-journey-item">
              <input type="checkbox" id="seller-journey-onboard" ${s.journeyOnboarding ? 'checked' : ''} onchange="updateSellerJourneyProgress()" style="width: 16px; height: 16px; accent-color: var(--primary);">
              <span style="font-size: 13px;">ğŸ“˜ ì˜¨ë³´ë”© ê°€ì´ë“œ ì „ë‹¬</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid var(--gray-200);" class="seller-journey-item">
              <input type="checkbox" id="seller-journey-docs" ${s.journeyDocuments ? 'checked' : ''} onchange="updateSellerJourneyProgress()" style="width: 16px; height: 16px; accent-color: var(--primary);">
              <span style="font-size: 13px;">ğŸ“„ ì„œë¥˜ ìˆ˜ë ¹ ì™„ë£Œ</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid var(--gray-200);" class="seller-journey-item">
              <input type="checkbox" id="seller-journey-first-deal" ${s.journeyFirstDeal ? 'checked' : ''} onchange="updateSellerJourneyProgress()" style="width: 16px; height: 16px; accent-color: var(--primary);">
              <span style="font-size: 13px;">ğŸ›’ ì²« ê³µêµ¬ ì§„í–‰</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid var(--gray-200);" class="seller-journey-item">
              <input type="checkbox" id="seller-journey-feedback" ${s.journeyFeedback ? 'checked' : ''} onchange="updateSellerJourneyProgress()" style="width: 16px; height: 16px; accent-color: var(--primary);">
              <span style="font-size: 13px;">ğŸ“Š ì„±ê³¼ í”¼ë“œë°±</span>
            </label>
          </div>
          
          <button type="button" onclick="generateSellerTasksFromJourney('${s.id}', '${s.name.replace(/'/g, "\\'")}')" style="width: 100%; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
            ğŸ“‹ ë¯¸ì™„ë£Œ í•­ëª© â†’ ì—…ë¬´ë¡œ ìƒì„±
          </button>
        </div>
        ` : ''}
        
        <!-- ë©”ëª¨ -->
        <div class="form-group">
          <label class="form-label">ë©”ëª¨</label>
          <textarea class="form-textarea" id="seller-notes" rows="3" placeholder="ì¶”ê°€ ì •ë³´">${s.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSeller('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  // ëª¨ë‹¬ ì—´ë¦° í›„ ì§„í–‰ë¥  ë° ê³„ì•½ ê±´ìˆ˜ ì´ˆê¸°í™”
  setTimeout(() => {
    updateSellerProgress();
    updateContractCountDisplay();
    if (isEdit) updateSellerJourneyProgress();
  }, 50);
}

// ì…€ëŸ¬ ëª¨ë‹¬ ë‚´ íŒŒì¼ ì—…ë¡œë“œ
// ì…€ëŸ¬ íŒŒì¼ ê´€ë ¨ í•¨ìˆ˜ - ì œê±°ë¨ (êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ê´€ë¦¬)
// ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•´ placeholder í•¨ìˆ˜ ìœ ì§€
function uploadSellerDocInModal() { console.log('íŒŒì¼ ì²¨ë¶€ ê¸°ëŠ¥ì´ êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
function removeSellerDoc() { console.log('íŒŒì¼ ì‚­ì œ ê¸°ëŠ¥ì´ êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
function viewSellerDocument() { showToast('ì„œë¥˜ëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ í™•ì¸í•˜ì„¸ìš”.'); }
function viewSellerContracts() { showToast('ê³„ì•½ì„œëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ í™•ì¸í•˜ì„¸ìš”.'); }
function viewSingleContract() { showToast('ê³„ì•½ì„œëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ í™•ì¸í•˜ì„¸ìš”.'); }
function deleteSellerContract() { showToast('ê³„ì•½ì„œ ê´€ë¦¬ëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ì§„í–‰í•˜ì„¸ìš”.'); }
function uploadSellerDocDirect() { showToast('íŒŒì¼ ì—…ë¡œë“œëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
function openDocumentViewer() { showToast('ì„œë¥˜ í™•ì¸ì€ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ì§„í–‰í•˜ì„¸ìš”.'); }


// ì…€ëŸ¬ ì„œë¥˜ ì§ì ‘ ì—…ë¡œë“œ (í…Œì´ë¸”ì—ì„œ)
// ì…€ëŸ¬ ì…ë ¥ ë°©ì‹ ì „í™˜
function showSellerTextInput() {
  document.getElementById('seller-excel-upload').style.display = 'none';
  document.getElementById('seller-text-input').style.display = 'block';
  window.sellerBulkMode = 'text';
}

function showSellerExcelUpload() {
  document.getElementById('seller-excel-upload').style.display = 'block';
  document.getElementById('seller-text-input').style.display = 'none';
  window.sellerBulkMode = 'excel';
}

// ì…€ëŸ¬ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
let sellerExcelData = [];

function handleSellerExcelDrop(e) {
  e.preventDefault();
  e.target.style.borderColor = 'var(--gray-300)';
  e.target.style.background = 'transparent';
  const file = e.dataTransfer.files[0];
  if (file) handleSellerExcelFile(file);
}

function handleSellerExcelFile(file) {
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      const headers = jsonData[0].map(h => String(h).trim());
      const rows = jsonData.slice(1).filter(row => row.some(cell => cell));
      
      // ì—´ ë§¤í•‘ (ìˆœì„œ: ì…€ëŸ¬ëª…(íŒ”ë¡œì›Œìˆ˜), ì—°ë½ì²˜, ì£¼ì†Œ, ê³„ì •ë§í¬, ì¹´í…Œê³ ë¦¬, ë©”ëª¨)
      const colMap = {
        name: headers.findIndex(h => h.includes('ì…€ëŸ¬') || h.includes('ì´ë¦„') || h.includes('ë‹‰ë„¤ì„') || h.toLowerCase().includes('name')),
        contact: headers.findIndex(h => h.includes('ì—°ë½') || h.includes('ì „í™”') || h.toLowerCase().includes('contact') || h.toLowerCase().includes('phone')),
        address: headers.findIndex(h => h.includes('ì£¼ì†Œ') || h.toLowerCase().includes('address')),
        channelLink: headers.findIndex(h => h.includes('ê³„ì •') || h.includes('ì±„ë„') || h.includes('ë§í¬') || h.toLowerCase().includes('channel') || h.toLowerCase().includes('link')),
        category: headers.findIndex(h => h.includes('ì¹´í…Œê³ ë¦¬') || h.includes('ë¶„ë¥˜') || h.toLowerCase().includes('category')),
        notes: headers.findIndex(h => h.includes('ë©”ëª¨') || h.includes('ë¹„ê³ ') || h.toLowerCase().includes('note') || h.toLowerCase().includes('memo'))
      };
      
      sellerExcelData = rows.map(row => ({
        name: colMap.name >= 0 ? String(row[colMap.name] || '').trim() : '',
        contact: colMap.contact >= 0 ? String(row[colMap.contact] || '').trim() : '',
        address: colMap.address >= 0 ? String(row[colMap.address] || '').trim() : '',
        channelLink: colMap.channelLink >= 0 ? String(row[colMap.channelLink] || '').trim() : '',
        category: colMap.category >= 0 ? String(row[colMap.category] || '').trim() : '',
        notes: colMap.notes >= 0 ? String(row[colMap.notes] || '').trim() : ''
      })).filter(item => item.name);
      
      // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
      const previewDiv = document.getElementById('seller-excel-preview');
      const countSpan = document.getElementById('seller-preview-count');
      const thead = document.querySelector('#seller-preview-table thead');
      const tbody = document.querySelector('#seller-preview-table tbody');
      
      countSpan.textContent = `(${sellerExcelData.length}ëª…)`;
      thead.innerHTML = '<tr><th>ì…€ëŸ¬ëª…(íŒ”ë¡œì›Œ)</th><th>ì—°ë½ì²˜</th><th>ì£¼ì†Œ</th><th>ê³„ì •ë§í¬</th><th>ì¹´í…Œê³ ë¦¬</th><th>ë©”ëª¨</th></tr>';
      tbody.innerHTML = sellerExcelData.slice(0, 10).map(s => `
        <tr>
          <td>${s.name}</td>
          <td>${s.contact}</td>
          <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${s.address}</td>
          <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${s.channelLink}</td>
          <td>${s.category}</td>
          <td>${s.notes}</td>
        </tr>
      `).join('') + (sellerExcelData.length > 10 ? `<tr><td colspan="6" style="text-align:center;color:var(--gray-500)">... ì™¸ ${sellerExcelData.length - 10}ëª…</td></tr>` : '');
      
      previewDiv.style.display = 'block';
      showToast(`${sellerExcelData.length}ëª…ì˜ ì…€ëŸ¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
      
    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ì…€ëŸ¬ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
function downloadSellerTemplate() {
  const ws = XLSX.utils.aoa_to_sheet([
    ['ì…€ëŸ¬ëª…/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)', 'ì—°ë½ì²˜', 'ì£¼ì†Œ', 'ê³„ì •ë§í¬', 'ì¹´í…Œê³ ë¦¬', 'ë©”ëª¨'],
    ['ë·°í‹°ë§ˆì¼“(5ë§Œ)', '010-1234-5678', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬', 'instagram.com/beauty', 'ë¯¸ìš©', 'VIP ì…€ëŸ¬'],
    ['í—¬ìŠ¤ìŠ¤í† ì–´(12ë§Œ)', '010-2222-3333', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬', 'youtube.com/health', 'ê±´ê°•', ''],
    ['ë§˜ìŠ¤í† ì–´(3ë§Œ)', '010-4444-5555', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ', 'blog.naver.com/mom', 'ìœ¡ì•„', 'ì‹ ê·œ'],
  ]);
  
  // ì—´ ë„ˆë¹„ ì„¤ì •
  ws['!cols'] = [
    { wch: 20 }, // ì…€ëŸ¬ëª…
    { wch: 15 }, // ì—°ë½ì²˜
    { wch: 25 }, // ì£¼ì†Œ
    { wch: 30 }, // ê³„ì •ë§í¬
    { wch: 10 }, // ì¹´í…Œê³ ë¦¬
    { wch: 15 }, // ë©”ëª¨
  ];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì…€ëŸ¬ëª©ë¡');
  XLSX.writeFile(wb, 'ì…€ëŸ¬_ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx');
}

async function submitBulkSellers() {
  let dataToSubmit = [];
  
  // ì—‘ì…€ ëª¨ë“œì¸ ê²½ìš°
  if (window.sellerBulkMode !== 'text' && sellerExcelData.length > 0) {
    dataToSubmit = sellerExcelData;
  } else {
    // í…ìŠ¤íŠ¸ ëª¨ë“œ
    const text = document.getElementById('bulk-sellers')?.value?.trim();
    if (!text) {
      showToast('ì…€ëŸ¬ ëª©ë¡ì„ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }
    
    // ìˆœì„œ: ì…€ëŸ¬ëª…(íŒ”ë¡œì›Œìˆ˜), ì—°ë½ì²˜, ì£¼ì†Œ, ê³„ì •ë§í¬, ì¹´í…Œê³ ë¦¬, ë©”ëª¨
    const lines = text.split('\n').filter(line => line.trim());
    dataToSubmit = lines.map(line => {
      const parts = line.split(',').map(p => p.trim());
      return {
        name: parts[0] || '',
        contact: parts[1] || '',
        address: parts[2] || '',
        channelLink: parts[3] || '',
        category: parts[4] || '',
        notes: parts[5] || ''
      };
    }).filter(item => item.name);
  }
  
  if (dataToSubmit.length === 0) {
    showToast('ë“±ë¡í•  ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  let successCount = 0;
  for (const data of dataToSubmit) {
    try {
      await db.collection('sellers').add(data);
      successCount++;
    } catch(e) {
      console.error(e);
    }
  }
  
  sellerExcelData = [];
  showToast(`${successCount}ëª…ì˜ ì…€ëŸ¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
  closeModal();
}

function submitSellerForm(e, id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();
  const data = {
    name: document.getElementById('seller-name').value,
    contact: document.getElementById('seller-contact').value,
    phone: document.getElementById('seller-contact').value, // í˜¸í™˜ì„±
    address: document.getElementById('seller-address').value,
    channelLink: document.getElementById('seller-channelLink').value,
    accountLink: document.getElementById('seller-channelLink').value, // í˜¸í™˜ì„±
    category: document.getElementById('seller-category').value,
    notes: document.getElementById('seller-notes').value,
    // ë¶„ì„ìš© ì •ë³´
    performanceGrade: document.getElementById('seller-performance-grade')?.value || '',
    sellerStatus: document.getElementById('seller-status')?.value || 'active',
    // ë¡œê·¸ì¸ ì •ë³´
    loginId: document.getElementById('seller-login-id')?.value || '',
    loginPw: document.getElementById('seller-login-pw')?.value || '',
    // ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ë¯¼ì¦, í†µì¥ë§Œ)
    hasIdCard: document.getElementById('seller-has-id-card')?.checked || false,
    hasBankAccount: document.getElementById('seller-has-bank-account')?.checked || false,
    // ì…€ëŸ¬ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸
    journeyFirstContact: document.getElementById('seller-journey-contact')?.checked || false,
    journeyOnboarding: document.getElementById('seller-journey-onboard')?.checked || false,
    journeyDocuments: document.getElementById('seller-journey-docs')?.checked || false,
    journeyFirstDeal: document.getElementById('seller-journey-first-deal')?.checked || false,
    journeyFeedback: document.getElementById('seller-journey-feedback')?.checked || false,
  };
  
  if (id) data.id = id;
  saveSeller(data);
}

// í—¬í¼ í•¨ìˆ˜
function getSupplierName(id) {
  const s = state.suppliers.find(s => s.id === id);
  return s ? s.name : 'ë¯¸ì§€ì •';
}

function getSellerName(id) {
  const s = state.sellers.find(s => s.id === id);
  return s ? s.name : 'ë¯¸ì§€ì •';
}

function getFilteredDeals() {
  let deals = state.deals;
  if (state.viewFilter === 'supplier' && state.selectedSupplier) {
    deals = deals.filter(d => d.supplierId === state.selectedSupplier);
  } else if (state.viewFilter === 'seller' && state.selectedSeller) {
    deals = deals.filter(d => d.sellerId === state.selectedSeller);
  }
  return deals;
}

function getDealsNeedingSettlement() {
  const today = new Date();
  return state.deals.filter(d => {
    if (d.status !== 'completed') return false;
    if (d.supplierSettled && d.sellerSettled) return false;
    const endDate = parseDate(d.endDate);
    const daysSinceEnd = Math.floor((today - endDate) / (1000 * 60 * 60 * 24));
    return daysSinceEnd >= 0 && daysSinceEnd <= 7;
  });
}

// ë Œë”ë§
function render() {
  const app = document.getElementById('app');
  
  if (state.loading) {
    app.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
    return;
  }
  
  switch (state.currentTab) {
    case 'calendar': renderCalendar(); break;
    case 'deals': renderDeals(); break;
    case 'suppliers': renderSuppliers(); break;
    case 'sellers': renderSellers(); break;
    case 'sellerList': renderSellerList(); break;
    case 'products': renderProducts(); break;
    case 'productDB': renderProductDB(); break;
    case 'productList': renderProductList(); break;
    case 'dealManagement': renderDealManagement(); break;
    case 'settlement': renderSettlement(); break;
    case 'salesReport': renderSalesReport(); break;
    case 'shareLinks': renderShareLinks(); break;
    case 'partnerMessages': renderPartnerMessages(); break;
    case 'partnerNotices': renderPartnerNotices(); break;
    case 'proposalManagement': renderProposalManagement(); break;
    case 'teamMembers': renderTeamMembers(); break;
    case 'salesDashboard': renderSalesDashboard(); break;
    case 'dataUsage': renderDataUsage(); break;
    case 'inquiries': renderInquiries(); break;
    case 'urgentSales': renderUrgentSales(); break;
    case 'dealCenter': renderDealCenter(); break;
    case 'cafe24Dashboard': renderCafe24Dashboard(); break;
    case 'cafe24Orders': renderCafe24Orders(); break;
    case 'cafe24Stats': renderCafe24Stats(); break;
    case 'cafe24Settings': renderCafe24Settings(); break;
    case 'productDataManager': renderProductDataManager(); break;
    case 'guide': renderGuide(); break;
    case 'growthDashboard': renderGrowthDashboard(); break;
    case 'growthGuide': renderGrowthGuide(); break;
    case 'workLog': renderWorkLog(); break;
    case 'taskManagement': renderTaskManagement(); break;
    case 'okrManagement': renderOKRManagement(); break;
    case 'okrReview': renderOKRReviewDashboard(); break;
    case 'referenceLibrary': renderReferenceLibrary(); break;
  }
}

// ìƒíƒœë³„ ê³µêµ¬ ëª©ë¡ ëª¨ë‹¬
function openStatusModal(statusType) {
  const today = formatDate(new Date());
  const statusLabels = {
    negotiating: 'í˜‘ì˜ì¤‘',
    confirmed: 'ì§„í–‰ì˜ˆì •',
    ongoing: 'ì§„í–‰ì¤‘',
    completed: 'ì§„í–‰ì™„ë£Œ'
  };
  
  // ìƒíƒœë³„ë¡œ ê³µêµ¬ í•„í„°ë§
  const filteredDeals = state.deals.filter(d => {
    const displayStatus = getDisplayStatus(d);
    if (statusType === 'negotiating') return displayStatus.label === 'í˜‘ì˜ì¤‘';
    if (statusType === 'confirmed') return displayStatus.label === 'ì§„í–‰ì˜ˆì •';
    if (statusType === 'ongoing') return displayStatus.label === 'ì§„í–‰ì¤‘';
    if (statusType === 'completed') return displayStatus.label === 'ì§„í–‰ì™„ë£Œ';
    return false;
  });
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">${statusLabels[statusType]} ê³µêµ¬ ëª©ë¡ (${filteredDeals.length}ê±´)</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px; overflow-y: auto; flex: 1;">
        ${filteredDeals.length === 0 ? `
          <div style="text-align: center; padding: 40px; color: var(--gray-500);">
            ${statusLabels[statusType]} ìƒíƒœì˜ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        ` : `
          <table class="data-table">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ì…€ëŸ¬</th>
                <th>ìƒí’ˆ</th>
                <th>ê³µêµ¬ ê¸°ê°„</th>
                <th>ìƒ˜í”Œì „ë‹¬</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${filteredDeals.map(d => {
                const supplier = state.suppliers.find(s => s.id === d.supplierId);
                const seller = state.sellers.find(s => s.id === d.sellerId);
                return `
                  <tr>
                    <td><strong>${supplier?.name || '-'}</strong></td>
                    <td>${seller?.name || '-'}</td>
                    <td>${d.productName || '-'}</td>
                    <td style="font-size: 13px;">
                      ${d.startDate ? formatDateKR(d.startDate) : '-'} ~ ${d.endDate ? formatDateKR(d.endDate) : '-'}
                    </td>
                    <td>
                      ${d.sampleDelivered ? 
                        '<span style="color: var(--success);">âœ“ ì™„ë£Œ</span>' : 
                        '<span style="color: var(--gray-400);">-</span>'}
                    </td>
                    <td>
                      <button class="btn btn-ghost btn-sm" onclick="closeModal(); openDealModal(state.deals.find(deal=>deal.id==='${d.id}'))">ìƒì„¸</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `}
      </div>
    </div>
  `;
}

function renderCalendar() {
  const app = document.getElementById('app');
  const year = state.currentDate.getFullYear();
  const month = state.currentDate.getMonth();
  const today = formatDate(new Date());
  
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);
  const prevMonthDays = getDaysInMonth(year, month - 1);
  
  const filteredDeals = getFilteredDeals();
  const settlementNeeded = getDealsNeedingSettlement();
  
  // ë‚ ì§œ ê¸°ë°˜ ìë™ ìƒíƒœ ê³„ì‚°
  const todayDate = new Date();
  todayDate.setHours(0, 0, 0, 0);
  
  const stats = {
    negotiating: state.deals.filter(d => d.status === 'negotiating').length,
    confirmed: state.deals.filter(d => {
      if (d.status === 'negotiating') return false;
      const start = new Date(d.startDate);
      start.setHours(0, 0, 0, 0);
      return todayDate < start;
    }).length,
    ongoing: state.deals.filter(d => {
      if (d.status === 'negotiating') return false;
      const start = new Date(d.startDate);
      start.setHours(0, 0, 0, 0);
      const end = new Date(d.endDate);
      end.setHours(0, 0, 0, 0);
      return todayDate >= start && todayDate <= end;
    }).length,
    completed: state.deals.filter(d => {
      if (d.status === 'negotiating') return false;
      const end = new Date(d.endDate);
      end.setHours(0, 0, 0, 0);
      return todayDate > end;
    }).length
  };
  
  let alerts = '';
  if (settlementNeeded.length > 0) {
    alerts += `<div class="alert alert-warning">âš ï¸ ì •ì‚° ëŒ€ê¸° ì¤‘ì¸ ê³µêµ¬ê°€ ${settlementNeeded.length}ê±´ ìˆìŠµë‹ˆë‹¤</div>`;
  }
  
  let calendarDays = '';
  
  for (let i = firstDay - 1; i >= 0; i--) {
    const day = prevMonthDays - i;
    calendarDays += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = formatDate(new Date(year, month, day));
    const dayOfWeek = new Date(year, month, day).getDay();
    const isToday = dateStr === today;
    const isSunday = dayOfWeek === 0;
    const isSaturday = dayOfWeek === 6;
    
    const dayDeals = filteredDeals.filter(d => dateStr >= d.startDate && dateStr <= d.endDate);
    
    let dealBadges = '';
    dayDeals.slice(0, 3).forEach(deal => {
      const isStart = dateStr === deal.startDate;
      const isSingle = deal.startDate === deal.endDate;
      
      // ê³µêµ¬ ê¸°ê°„ ê³„ì‚°
      const startDate = new Date(deal.startDate);
      const endDate = new Date(deal.endDate);
      const dealDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const daysText = dealDays > 1 ? `(${dealDays}ì¼)` : '';
      
      let badgeClass = 'deal-badge';
      if (state.viewFilter === 'supplier') badgeClass += ' supplier';
      else if (state.viewFilter === 'seller') badgeClass += ' seller';
      else badgeClass += ' both';
      
      const displayText = isStart || isSingle ? `${deal.title}${daysText}` : 'Â·';
      dealBadges += `<div class="${badgeClass}" onclick="event.stopPropagation(); openDealModal(state.deals.find(d=>d.id==='${deal.id}'))" title="${deal.title} ${daysText}">${displayText}</div>`;
    });
    
    if (dayDeals.length > 3) {
      dealBadges += `<div style="font-size:11px;color:var(--gray-500);text-align:center">+${dayDeals.length - 3}</div>`;
    }
    
    calendarDays += `
      <div class="calendar-day ${isToday ? 'today' : ''} ${isSunday ? 'sunday' : ''} ${isSaturday ? 'saturday' : ''}" onclick="openDealModal()">
        <div class="day-number">${day}</div>
        ${dealBadges}
      </div>
    `;
  }
  
  const totalCells = firstDay + daysInMonth;
  const remainingCells = 7 - (totalCells % 7);
  if (remainingCells < 7) {
    for (let i = 1; i <= remainingCells; i++) {
      calendarDays += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
    }
  }
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ìº˜ë¦°ë”</h1>
      <p class="page-desc">ê³µêµ¬ ì¼ì •ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openDealModal()">+ ìƒˆ ê³µêµ¬</button>
      </div>
    </div>
    
    ${alerts}
    
    <div class="stats-row">
      <div class="stat-card" style="cursor: pointer;" onclick="openStatusModal('negotiating')">
        <div class="stat-label">í˜‘ì˜ì¤‘</div>
        <div class="stat-value">${stats.negotiating}</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="openStatusModal('confirmed')">
        <div class="stat-label">ì§„í–‰ì˜ˆì •</div>
        <div class="stat-value">${stats.confirmed}</div>
      </div>
      <div class="stat-card highlight" style="cursor: pointer;" onclick="openStatusModal('ongoing')">
        <div class="stat-label">ì§„í–‰ì¤‘</div>
        <div class="stat-value">${stats.ongoing}</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="openStatusModal('completed')">
        <div class="stat-label">ì§„í–‰ì™„ë£Œ</div>
        <div class="stat-value">${stats.completed}</div>
      </div>
    </div>
    
    <div class="card">
      <div class="filter-bar">
        <div class="filter-group">
          <button class="filter-btn ${state.viewFilter === 'all' ? 'active' : ''}" onclick="changeViewFilter('all')">ì „ì²´</button>
          <button class="filter-btn ${state.viewFilter === 'supplier' ? 'active' : ''}" onclick="changeViewFilter('supplier')">ê³µê¸‰ì‚¬ë³„</button>
          <button class="filter-btn ${state.viewFilter === 'seller' ? 'active' : ''}" onclick="changeViewFilter('seller')">ì…€ëŸ¬ë³„</button>
        </div>
        
        ${state.viewFilter === 'supplier' ? `
          <select class="form-select" style="width:auto" onchange="changeSupplierFilter(this.value)">
            <option value="">ê³µê¸‰ì‚¬ ì„ íƒ</option>
            ${state.suppliers.map(s => `<option value="${s.id}" ${state.selectedSupplier === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
          </select>
        ` : ''}
        
        ${state.viewFilter === 'seller' ? `
          <select class="form-select" style="width:auto" onchange="changeSellerFilter(this.value)">
            <option value="">ì…€ëŸ¬ ì„ íƒ</option>
            ${state.sellers.map(s => `<option value="${s.id}" ${state.selectedSeller === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
          </select>
        ` : ''}
      </div>
      
      <div class="legend">
        <div class="legend-item"><div class="legend-dot supplier"></div> ê³µê¸‰ì‚¬ ë·°</div>
        <div class="legend-item"><div class="legend-dot seller"></div> ì…€ëŸ¬ ë·°</div>
        <div class="legend-item"><div class="legend-dot both"></div> ì „ì²´ ë·°</div>
      </div>
      
      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="prevMonth()">â€¹</button>
          <span class="calendar-title">${year}ë…„ ${MONTHS[month]}</span>
          <button onclick="nextMonth()">â€º</button>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="goToday()">ì˜¤ëŠ˜</button>
      </div>
      
      <div class="calendar-grid">
        ${WEEKDAYS.map(d => `<div class="calendar-weekday">${d}</div>`).join('')}
      </div>
      <div class="calendar-grid">
        ${calendarDays}
      </div>
    </div>
  `;
}

function renderDeals() {
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ê³µêµ¬ ëª©ë¡</h1>
      <p class="page-desc">ì „ì²´ ${state.deals.length}ê°œì˜ ê³µêµ¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openDealModal()">+ ìƒˆ ê³µêµ¬</button>
      </div>
    </div>
    
    <div class="card">
      <div class="deal-list">
        ${state.deals.length === 0 ? `
          <div class="empty-state">
            <div class="icon">ğŸ“¦</div>
            <div class="text">ë“±ë¡ëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        ` : ''}
        ${state.deals.map(d => {
          const displayStatus = getDisplayStatus(d);
          return `
          <div class="deal-item" onclick="openDealModal(state.deals.find(deal=>deal.id==='${d.id}'))">
            <div class="deal-color ${d.status === 'negotiating' ? 'negotiating' : getAutoStatus(d)}"></div>
            <div class="deal-info">
              <div class="deal-title">${d.title}</div>
              <div class="deal-meta">
                <span>ğŸ­ ${getSupplierName(d.supplierId)}</span>
                <span>ğŸ‘¤ ${getSellerName(d.sellerId)}</span>
                <span>${formatDateKR(d.startDate)} ~ ${formatDateKR(d.endDate)}</span>
              </div>
              ${displayStatus.label === 'ì§„í–‰ì™„ë£Œ' ? `
                <div class="settlement-badges">
                  <span class="settlement-badge ${d.supplierSettled ? 'done' : 'pending'}">${d.supplierSettled ? 'âœ“' : 'â—‹'} ê³µê¸‰ì‚¬</span>
                  <span class="settlement-badge ${d.sellerSettled ? 'done' : 'pending'}">${d.sellerSettled ? 'âœ“' : 'â—‹'} ì…€ëŸ¬</span>
                </div>
              ` : ''}
            </div>
            <div class="deal-status">
              <span class="status-badge ${displayStatus.class}">${displayStatus.label}</span>
            </div>
          </div>
        `}).join('')}
      </div>
    </div>
  `;
}

function renderSuppliers() {
  const app = document.getElementById('app');
  
  // ê³„ì•½ ì™„ë£Œëœ ê³µê¸‰ì‚¬ / ë¯¸ì™„ë£Œ ê³µê¸‰ì‚¬ ë¶„ë¦¬
  const contractedSuppliers = state.suppliers.filter(s => s.contractStatus === 'completed');
  const pendingSuppliers = state.suppliers.filter(s => s.contractStatus !== 'completed');
  
  // ì´ ìƒí’ˆ ìˆ˜
  const totalProducts = (state.supplierProducts || []).length;
  
  // ê³µê¸‰ì‚¬ë³„ ë§¤ì¶œ ë°ì´í„° ì§‘ê³„
  const supplierSalesStats = {};
  state.suppliers.forEach(supplier => {
    const settlements = (state.sellerSettlements || []).filter(ss => ss.brandName === supplier.name);
    let totalSalesAmount = 0;
    let totalSalesCount = 0;
    
    settlements.forEach(ss => {
      const items = ss.salesItems || [];
      totalSalesCount += items.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);
      totalSalesAmount += items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
    });
    
    supplierSalesStats[supplier.id] = { totalSalesAmount, totalSalesCount };
  });
  
  // ì „ì²´ ë§¤ì¶œ í•©ê³„
  const grandTotalSales = Object.values(supplierSalesStats).reduce((sum, s) => sum + s.totalSalesAmount, 0);
  const grandTotalCount = Object.values(supplierSalesStats).reduce((sum, s) => sum + s.totalSalesCount, 0);
  
  // ì„œë¥˜ ì™„ë£Œ ì—¬ë¶€ ì²´í¬ (4ê°œ í•­ëª©: ìƒí’ˆë“±ë¡, ì‚¬ì—…ì, í†µì¥, ê³„ì•½)
  const fullyDocumented = contractedSuppliers.filter(s => {
    return s.hasProductInfo && s.hasBusinessLicense && s.hasBankAccount && s.hasContract;
  });
  
  const missingDocs = contractedSuppliers.filter(s => {
    return !(s.hasProductInfo && s.hasBusinessLicense && s.hasBankAccount && s.hasContract);
  });
  
  // íŒë§¤ëŸ‰ TOP 5 / ì €ì¡° ë¸Œëœë“œ
  const suppliersWithSales = state.suppliers
    .map(s => ({ ...s, sales: supplierSalesStats[s.id]?.totalSalesAmount || 0, count: supplierSalesStats[s.id]?.totalSalesCount || 0 }))
    .filter(s => s.sales > 0);
  
  const topSellers = [...suppliersWithSales].sort((a, b) => b.sales - a.sales).slice(0, 5);
  const lowSellers = [...suppliersWithSales].sort((a, b) => a.sales - b.sales).slice(0, 3);
  
  // ê³µêµ¬ ì§„í–‰ TOP 5 (ìº˜ë¦°ë” ë“±ë¡ ê¸°ì¤€)
  const products = state.supplierProducts || [];
  const dealProgressStats = products.map(p => {
    // selectedProductsê°€ ê°ì²´ ë°°ì—´ [{productId, ...}] ë˜ëŠ” ë¬¸ìì—´ ë°°ì—´ [id]ì¼ ìˆ˜ ìˆìŒ
    const linkedDeals = state.deals.filter(d => {
      if (!d.selectedProducts) return false;
      return d.selectedProducts.some(item => {
        const pid = typeof item === 'string' ? item : item.productId;
        return pid === p.id;
      });
    });
    return {
      ...p,
      dealCount: linkedDeals.length
    };
  }).filter(p => p.dealCount > 0)
    .sort((a, b) => b.dealCount - a.dealCount)
    .slice(0, 5);
  
  // íŒë§¤ ë² ìŠ¤íŠ¸ TOP 5 (ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œ ì •ì‚° ê¸°ì¤€)
  const salesByProduct = {};
  (state.sellerSettlements || []).forEach(ss => {
    const items = ss.salesItems || ss.items || [];
    items.forEach(item => {
      const productName = item.productName || item.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
      const brandName = ss.brandName || '-';
      const key = `${brandName}__${productName}`;
      if (!salesByProduct[key]) {
        salesByProduct[key] = { productName, brandName, totalQty: 0, totalAmount: 0 };
      }
      salesByProduct[key].totalQty += Number(item.quantity) || 0;
      salesByProduct[key].totalAmount += Number(item.amount) || 0;
    });
  });
  
  const salesBestStats = Object.values(salesByProduct)
    .filter(p => p.totalAmount > 0)
    .sort((a, b) => b.totalAmount - a.totalAmount)
    .slice(0, 5);
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ê³µê¸‰ì‚¬ ê´€ë¦¬</h1>
      <p class="page-desc">ì´ ${state.suppliers.length}ê°œì˜ ê³µê¸‰ì‚¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openSupplierModal()">+ ìƒˆ ê³µê¸‰ì‚¬</button>
      </div>
    </div>
    
    <!-- ê³µê¸‰ì‚¬ ì‘ëŒ€ íŒ -->
    <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #C7D2FE;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">ğŸ’¡</span>
        <div style="flex: 1;">
          <div style="font-size: 13px; font-weight: 600; color: #4338CA; margin-bottom: 4px;">ê³µê¸‰ì‚¬ ì‘ëŒ€ í•µì‹¬ ë©”ì‹œì§€</div>
          <div style="font-size: 12px; color: #4B5563;">"ëª¨ì—¬ë¼ë”œì€ ë‹¨ìˆœ ë²¤ë”ì‚¬ê°€ ì•„ë‹ˆë¼, <strong>ì œí’ˆì´ ì‹œì¥ì— ë¹ ë¥´ê²Œ ë…¸ì¶œë˜ê³  ì‹¤êµ¬ë§¤ë¡œ ì´ì–´ì§€ëŠ” êµ¬ì¡°</strong>ë¥¼ ë§Œë“œëŠ” ê³³ì…ë‹ˆë‹¤."</div>
        </div>
        <button onclick="switchTab('guide'); guideTab='partner'; renderGuide();" style="background: #4338CA; color: white; border: none; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">ì‘ëŒ€ ê°€ì´ë“œ â†’</button>
      </div>
    </div>
    
    <!-- 1í–‰: ê¸°ë³¸ í†µê³„ -->
    <div class="stats-row" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 16px;">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ê³µê¸‰ì‚¬</div>
        <div class="stat-value">${state.suppliers.length}ê°œ</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-label">ì´ íŒë§¤ì•¡</div>
        <div class="stat-value">${grandTotalSales.toLocaleString()}ì›</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: var(--gray-600);">ì´ íŒë§¤ê±´</div>
        <div class="stat-value" style="color: #d97706;">${grandTotalCount.toLocaleString()}ê±´</div>
      </div>
    </div>
    
    <!-- 2í–‰: ê³„ì•½ ë° ì„œë¥˜ í˜„í™© -->
    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #065f46;">âœ… ê³„ì•½ì™„ë£Œ</div>
        <div class="stat-value" style="color: #059669;">${contractedSuppliers.length}ê°œ</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #9a3412;">â³ í˜‘ì˜ì¤‘</div>
        <div class="stat-value" style="color: #ea580c;">${pendingSuppliers.length}ê°œ</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #1e40af;">ğŸ“‹ ì„œë¥˜ì™„ë£Œ</div>
        <div class="stat-value" style="color: #2563eb;">${fullyDocumented.length}ê°œ</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #991b1b;">âš ï¸ ì„œë¥˜ë¯¸ë¹„</div>
        <div class="stat-value" style="color: #dc2626;">${missingDocs.length}ê°œ</div>
      </div>
    </div>
    
    <!-- 3í–‰: íŒë§¤ ìˆœìœ„ (4ì—´) -->
    <div class="card" style="margin-bottom: 16px; padding: 16px;">
      <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ“Š íŒë§¤ ìˆœìœ„</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">
        <!-- íŒë§¤ëŸ‰ TOP 5 (ë¸Œëœë“œ) -->
        <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px;">
          <div style="font-size: 12px; font-weight: 600; color: #065f46; margin-bottom: 10px;">ğŸ† ë¸Œëœë“œ íŒë§¤ëŸ‰</div>
          ${topSellers.length === 0 ? '<div style="color: var(--gray-500); font-size: 11px;">ë°ì´í„° ì—†ìŒ</div>' : 
            topSellers.map((s, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; ${i < 3 ? 'border-left: 2px solid ' + (i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : '#CD7F32') : ''}">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 12px;">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1)}</span>
                  <span style="font-weight: 600; font-size: 12px;">${s.name}</span>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: 700; color: #059669; font-size: 11px;">${s.sales.toLocaleString()}ì›</div>
                </div>
              </div>
            `).join('')}
        </div>
        <!-- ê³µêµ¬ ì§„í–‰ TOP 5 (ìƒí’ˆ) -->
        <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px;">
          <div style="font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 10px;">ğŸ“¦ ê³µêµ¬ ì§„í–‰ ê±´ìˆ˜ TOP5</div>
          ${dealProgressStats.length === 0 ? '<div style="color: var(--gray-500); font-size: 11px;">ê³µêµ¬ ë“±ë¡ëœ ìƒí’ˆ ì—†ìŒ</div>' : 
            dealProgressStats.map((p, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; ${i < 3 ? 'border-left: 2px solid ' + (i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : '#CD7F32') : ''}">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div>
                  <div style="font-size: 10px; color: var(--gray-500);">${p.brandName || '-'}</div>
                </div>
                <div style="font-weight: 700; color: #2563eb; font-size: 11px; flex-shrink: 0;">${p.dealCount}ê±´</div>
              </div>
            `).join('')}
        </div>
        <!-- íŒë§¤ ë² ìŠ¤íŠ¸ TOP 5 (ìƒí’ˆ) -->
        <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px;">
          <div style="font-size: 12px; font-weight: 600; color: #dc2626; margin-bottom: 10px;">ğŸ”¥ íŒë§¤ ë² ìŠ¤íŠ¸ ìƒí’ˆ TOP5</div>
          ${salesBestStats.length === 0 ? '<div style="color: var(--gray-500); font-size: 11px;">ì •ì‚° ë°ì´í„° ì—†ìŒ</div>' : 
            salesBestStats.map((p, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; ${i < 3 ? 'border-left: 2px solid ' + (i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : '#CD7F32') : ''}">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div>
                  <div style="font-size: 10px; color: var(--gray-500);">${p.brandName} Â· ${p.totalQty}ê°œ</div>
                </div>
                <div style="font-weight: 700; color: #dc2626; font-size: 11px; flex-shrink: 0;">${p.totalAmount.toLocaleString()}ì›</div>
              </div>
            `).join('')}
        </div>
        <!-- íŒë§¤ ì €ì¡° ë¸Œëœë“œ -->
        <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px;">
          <div style="font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 10px;">ğŸ“‰ íŒë§¤ ì €ì¡° ë¸Œëœë“œ</div>
          ${lowSellers.length === 0 ? '<div style="color: var(--gray-500); font-size: 11px;">ë°ì´í„° ì—†ìŒ</div>' : 
            lowSellers.map((s, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 11px; color: var(--gray-600);">${i + 1}ìœ„</span>
                  <span style="font-weight: 600; font-size: 12px;">${s.name}</span>
                </div>
                <div style="font-weight: 700; color: #d97706; font-size: 11px;">${s.sales.toLocaleString()}ì›</div>
              </div>
            `).join('')}
        </div>
      </div>
    </div>
    
    <!-- ì„œë¥˜ ë¯¸ë¹„ ê³µê¸‰ì‚¬ (ê³„ì•½ì™„ë£Œ but ì„œë¥˜ ë¶€ì¡±) -->
    ${missingDocs.length > 0 ? `
    <div class="card" style="margin-bottom: 16px; border: 2px solid #fca5a5;">
      <h2 class="card-title" style="color: #dc2626;">âš ï¸ ì„œë¥˜ ë¯¸ë¹„ ê³µê¸‰ì‚¬ (ê³„ì•½ì™„ë£Œ)</h2>
      <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 12px;">ìƒí’ˆë“±ë¡, ì‚¬ì—…ì, í†µì¥, ê³„ì•½ ì¤‘ ë¯¸ë¹„ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤</p>
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ê³µê¸‰ì‚¬ëª…</th>
              <th>ìœ í˜•</th>
              <th>ê³„ì•½ìƒíƒœ</th>
              <th style="text-align: center;">ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</th>
              <th style="text-align: center;">ë“œë¼ì´ë¸Œ</th>
              <th>ë‹´ë‹¹ì</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${missingDocs.map(s => {
              return `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td><span class="status-badge ${s.supplierType === 'inhouse' ? 'status-confirmed' : 'status-negotiating'}">${s.supplierType === 'inhouse' ? 'ìì‚¬' : 'íƒ€ì‚¬'}</span></td>
                  <td>
                    <select class="form-input" style="padding: 4px 8px; font-size: 12px; min-width: 90px;" onchange="updateSupplierField('${s.id}', 'contractStatus', this.value)">
                      <option value="pending" ${s.contractStatus === 'pending' ? 'selected' : ''}>â³ í˜‘ì˜ì¤‘</option>
                      <option value="completed" ${s.contractStatus === 'completed' ? 'selected' : ''}>âœ… ê³„ì•½ì™„ë£Œ</option>
                    </select>
                  </td>
                  <td style="text-align: center;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasProductInfo ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ìƒí’ˆë“±ë¡">
                        <input type="checkbox" ${s.hasProductInfo ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasProductInfo', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasProductInfo ? '#166534' : '#991b1b'};">ìƒí’ˆë“±ë¡</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasBusinessLicense ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ì‚¬ì—…ìë“±ë¡ì¦">
                        <input type="checkbox" ${s.hasBusinessLicense ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasBusinessLicense', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasBusinessLicense ? '#166534' : '#991b1b'};">ì‚¬ì—…ì</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasBankAccount ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="í†µì¥ì‚¬ë³¸">
                        <input type="checkbox" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasBankAccount', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasBankAccount ? '#166534' : '#991b1b'};">í†µì¥</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasContract ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ê³„ì•½ì„œ">
                        <input type="checkbox" ${s.hasContract ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasContract', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasContract ? '#166534' : '#991b1b'};">ê³„ì•½</span>
                      </label>
                    </div>
                  </td>
                  <td style="text-align: center;">
                    <button onclick="openSupplierGDrive('${s.id}')" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, #4285f4, #34a853); border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" title="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/></svg>
                    </button>
                  </td>
                  <td>${s.managerName || '-'}${s.managerPhone ? ` (${s.managerPhone})` : ''}</td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openSupplierModal(state.suppliers.find(sup=>sup.id==='${s.id}'))">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
    ` : ''}
    
    <!-- ì„œë¥˜ ì™„ë£Œ ê³µê¸‰ì‚¬ -->
    ${fullyDocumented.length > 0 ? `
    <div class="card" style="margin-bottom: 16px; border: 2px solid #a7f3d0;">
      <h2 class="card-title" style="color: #059669;">âœ… ì„œë¥˜ ì™„ë£Œ ê³µê¸‰ì‚¬</h2>
      <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 12px;">ìƒí’ˆë“±ë¡, ì‚¬ì—…ì, í†µì¥, ê³„ì•½ ëª¨ë‘ ì™„ë£Œ</p>
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ê³µê¸‰ì‚¬ëª…</th>
              <th>ìœ í˜•</th>
              <th>ê³„ì•½ìƒíƒœ</th>
              <th style="text-align: center;">ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</th>
              <th style="text-align: center;">ë“œë¼ì´ë¸Œ</th>
              <th style="text-align: right;">ì´ íŒë§¤ì•¡</th>
              <th style="text-align: right;">ì´ íŒë§¤ê±´</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${fullyDocumented.map(s => {
              const productCount = (state.supplierProducts || []).filter(p => p.supplierId === s.id).length;
              const stats = supplierSalesStats[s.id] || { totalSalesAmount: 0, totalSalesCount: 0 };
              return `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td><span class="status-badge ${s.supplierType === 'inhouse' ? 'status-confirmed' : 'status-negotiating'}">${s.supplierType === 'inhouse' ? 'ìì‚¬' : 'íƒ€ì‚¬'}</span></td>
                  <td>
                    <select class="form-input" style="padding: 4px 8px; font-size: 12px; min-width: 90px;" onchange="updateSupplierField('${s.id}', 'contractStatus', this.value)">
                      <option value="pending" ${s.contractStatus === 'pending' ? 'selected' : ''}>â³ í˜‘ì˜ì¤‘</option>
                      <option value="completed" ${s.contractStatus === 'completed' ? 'selected' : ''}>âœ… ê³„ì•½ì™„ë£Œ</option>
                    </select>
                  </td>
                  <td style="text-align: center;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasProductInfo ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ìƒí’ˆë“±ë¡">
                        <input type="checkbox" ${s.hasProductInfo ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasProductInfo', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasProductInfo ? '#166534' : '#991b1b'};">ìƒí’ˆë“±ë¡</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasBusinessLicense ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ì‚¬ì—…ìë“±ë¡ì¦">
                        <input type="checkbox" ${s.hasBusinessLicense ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasBusinessLicense', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasBusinessLicense ? '#166534' : '#991b1b'};">ì‚¬ì—…ì</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasBankAccount ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="í†µì¥ì‚¬ë³¸">
                        <input type="checkbox" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasBankAccount', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasBankAccount ? '#166534' : '#991b1b'};">í†µì¥</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasContract ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ê³„ì•½ì„œ">
                        <input type="checkbox" ${s.hasContract ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasContract', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasContract ? '#166534' : '#991b1b'};">ê³„ì•½</span>
                      </label>
                    </div>
                  </td>
                  <td style="text-align: center;">
                    <button onclick="openSupplierGDrive('${s.id}')" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, #4285f4, #34a853); border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" title="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/></svg>
                    </button>
                  </td>
                  <td style="text-align: right; font-weight: 600; color: var(--primary);">${stats.totalSalesAmount.toLocaleString()}ì›</td>
                  <td style="text-align: right;">${stats.totalSalesCount}ê±´</td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openSupplierModal(state.suppliers.find(sup=>sup.id==='${s.id}'))">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
    ` : ''}
    
    <!-- í˜‘ì˜ì¤‘ ê³µê¸‰ì‚¬ -->
    <div class="card">
      <h2 class="card-title" style="color: var(--gray-600);">â³ í˜‘ì˜ì¤‘ ê³µê¸‰ì‚¬</h2>
      ${pendingSuppliers.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ­</div>
          <div class="text">í˜‘ì˜ì¤‘ì¸ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬ëª…</th>
                <th>ìœ í˜•</th>
                <th>ë“±ë¡ìƒí’ˆ</th>
                <th>ë‹´ë‹¹ì</th>
                <th>ì—°ë½ì²˜</th>
                <th>ìƒí’ˆë¬¸ì˜</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${pendingSuppliers.map(s => {
                const productCount = (state.supplierProducts || []).filter(p => p.supplierId === s.id).length;
                return `
                  <tr>
                    <td><strong>${s.name}</strong></td>
                    <td><span class="status-badge ${s.supplierType === 'inhouse' ? 'status-confirmed' : 'status-negotiating'}">${s.supplierType === 'inhouse' ? 'ìì‚¬' : 'íƒ€ì‚¬'}</span></td>
                    <td><span class="status-badge" style="background: var(--gray-100); color: var(--gray-600);">${productCount}ê°œ</span></td>
                    <td>${s.managerName || '-'}${s.managerTitle ? ` (${s.managerTitle})` : ''}</td>
                    <td>${s.managerPhone || s.contact || '-'}</td>
                    <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.inquiryMethod || '-'}</td>
                    <td class="actions">
                      <button class="btn btn-secondary btn-sm" onclick="openSupplierModal(state.suppliers.find(sup=>sup.id==='${s.id}'))">ìˆ˜ì •</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

function renderSellers() {
  const app = document.getElementById('app');
  
  // ì…€ëŸ¬ë³„ ì •ì‚° í†µê³„ ê³„ì‚°
  const sellerStats = {};
  state.sellers.forEach(seller => {
    // ì…€ëŸ¬ ì •ì‚° ë‚´ì—­ì—ì„œ í•´ë‹¹ ì…€ëŸ¬ì˜ ë°ì´í„° ì§‘ê³„
    const sellerSettlements = (state.sellerSettlements || []).filter(ss => ss.sellerName === seller.name);
    
    let totalSalesCount = 0;  // ì´ íŒë§¤ê±´
    let totalSalesAmount = 0;  // ì´ íŒë§¤ì•¡
    let totalMarginAmount = 0;  // ì´ ë§ˆì§„ê¸ˆ
    let ongoingCount = 0;  // ì§„í–‰ì¤‘
    let completedCount = 0;  // ì™„ë£Œ
    
    sellerSettlements.forEach(ss => {
      const items = ss.salesItems || [];
      totalSalesCount += items.length;
      totalSalesAmount += items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      totalMarginAmount += items.reduce((sum, item) => sum + (Number(item.marginAmount) || 0), 0);
      
      // ì •ì‚°ì¼ ê¸°ì¤€ìœ¼ë¡œ ì§„í–‰ì¤‘/ì™„ë£Œ íŒë‹¨ (ì •ì‚°ì¼ì´ ìˆìœ¼ë©´ ì™„ë£Œ)
      if (ss.settlementDate) {
        completedCount++;
      } else {
        ongoingCount++;
      }
    });
    
    // ê³µêµ¬ ëª©ë¡ì—ì„œë„ ì§„í–‰ì¤‘ ì²´í¬
    const ongoingDeals = state.deals.filter(d => d.sellerId === seller.id && d.status !== 'completed').length;
    
    sellerStats[seller.id] = {
      totalSalesCount,
      totalSalesAmount,
      totalMarginAmount,
      ongoingCount: ongoingCount + ongoingDeals,
      completedCount
    };
  });
  
  // ì „ì²´ í†µê³„
  const totalSellers = state.sellers.length;
  const totalSalesAmount = Object.values(sellerStats).reduce((sum, s) => sum + s.totalSalesAmount, 0);
  const totalMarginAmount = Object.values(sellerStats).reduce((sum, s) => sum + s.totalMarginAmount, 0);
  
  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  const categories = ['ìœ¡ì•„', 'ì‹í’ˆ', 'ë¯¸ìš©', 'ìƒí™œ', 'ì·¨ë¯¸', 'ê±´ê°•'];
  
  // ê³µêµ¬ ìƒíƒœë³„ ì¹´ìš´íŠ¸
  const completedDealsCount = state.deals.filter(d => d.status === 'completed').length;
  const ongoingDealsCount = state.deals.filter(d => d.status === 'ongoing' || d.status === 'negotiating').length;
  const scheduledDealsCount = state.deals.filter(d => d.status === 'scheduled' || d.status === 'confirmed').length;
  
  // íŒë§¤ì•¡ ê¸°ì¤€ ì…€ëŸ¬ ë¶„ë¥˜
  const sellers100M = state.sellers.filter(s => (sellerStats[s.id]?.totalSalesAmount || 0) >= 1000000);
  const sellers500M = state.sellers.filter(s => (sellerStats[s.id]?.totalSalesAmount || 0) >= 5000000);
  const sellers1000M = state.sellers.filter(s => (sellerStats[s.id]?.totalSalesAmount || 0) >= 10000000);
  
  // ì´ íŒë§¤ê±´ìˆ˜
  const totalSalesCount = Object.values(sellerStats).reduce((sum, s) => sum + s.totalSalesCount, 0);
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ì…€ëŸ¬ ê´€ë¦¬</h1>
      <p class="page-desc">ì´ ${totalSellers}ëª…ì˜ ì…€ëŸ¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="openSellerModal(null, true)">ğŸ“‹ ì¼ê´„ ë“±ë¡</button>
        <button class="btn btn-primary" onclick="openSellerModal()">+ ìƒˆ ì…€ëŸ¬</button>
      </div>
    </div>
    
    <!-- ì…€ëŸ¬ ì‘ëŒ€ íŒ -->
    <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #FCD34D;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">ğŸ’¡</span>
        <div style="flex: 1;">
          <div style="font-size: 13px; font-weight: 600; color: #B45309; margin-bottom: 4px;">ì…€ëŸ¬ ì‘ëŒ€ í•µì‹¬ ë©”ì‹œì§€</div>
          <div style="font-size: 12px; color: #4B5563;">"ëª¨ì—¬ë¼ë”œì€ ì…€ëŸ¬ê°€ <strong>'ì§€ì†ì ìœ¼ë¡œ ì˜ íŒ” ìˆ˜ ìˆëŠ” êµ¬ì¡°'</strong>ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ì„±ì¥ í”Œë«í¼ì…ë‹ˆë‹¤. ì½˜í…ì¸ ëŠ” ì…€ëŸ¬ê°€, êµ¬ì¡°ëŠ” ëª¨ì—¬ë¼ë”œì´!"</div>
        </div>
        <button onclick="switchTab('guide'); guideTab='partner'; renderGuide();" style="background: #B45309; color: white; border: none; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">ì‘ëŒ€ ê°€ì´ë“œ â†’</button>
      </div>
    </div>
      </div>
    </div>
    
    <!-- 1í–‰: ê¸°ë³¸ í†µê³„ -->
    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
      <div class="stat-card">
        <div class="stat-label">ì´ ì…€ëŸ¬</div>
        <div class="stat-value">${totalSellers}ëª…</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: var(--gray-600);">ì´ ë§ˆì§„ê¸ˆ</div>
        <div class="stat-value" style="color: #d97706;">${totalMarginAmount.toLocaleString()}ì›</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-label">ì´ íŒë§¤ì•¡</div>
        <div class="stat-value">${totalSalesAmount.toLocaleString()}ì›</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì´ íŒë§¤ê±´</div>
        <div class="stat-value">${totalSalesCount}ê±´</div>
      </div>
    </div>
    
    <!-- 2í–‰: ê³µêµ¬ í˜„í™© -->
    <div class="stats-row" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 16px;">
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #065f46;">ì§„í–‰ì™„ë£Œ ê³µêµ¬</div>
        <div class="stat-value" style="color: #059669;">${completedDealsCount}ê±´</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #9a3412;">ì§„í–‰ì¤‘ ê³µêµ¬</div>
        <div class="stat-value" style="color: #ea580c;">${ongoingDealsCount}ê±´</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #3730a3;">ì§„í–‰ì˜ˆì • ê³µêµ¬</div>
        <div class="stat-value" style="color: #4f46e5;">${scheduledDealsCount}ê±´</div>
      </div>
    </div>
    
    <!-- 3í–‰: íŒë§¤ì•¡ ê¸°ì¤€ ì…€ëŸ¬ ë¶„ë¥˜ -->
    <div class="card" style="margin-bottom: 16px; padding: 16px;">
      <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ† íŒë§¤ì•¡ ê¸°ì¤€ ì…€ëŸ¬ ë¶„ë¥˜</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
        <div style="background: var(--gray-50); border-radius: 12px; padding: 12px; cursor: pointer;" onclick="toggleSellerTierList('100m')">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: var(--gray-600);">ğŸ’° 100ë§Œì› ì´ìƒ</div>
              <div style="font-size: 24px; font-weight: 700; color: #d97706;">${sellers100M.length}ëª…</div>
            </div>
            <span style="color: var(--gray-600); font-size: 12px;">ìƒì„¸ë³´ê¸° â–¼</span>
          </div>
          <div id="seller-tier-100m" style="display: none; margin-top: 12px; max-height: 150px; overflow-y: auto;">
            ${sellers100M.length === 0 ? '<div style="color: var(--gray-600); font-size: 12px;">í•´ë‹¹ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
              sellers100M.map(s => `<div style="padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 12px; display: flex; justify-content: space-between;">
                <span>${s.name}</span>
                <span style="color: #d97706; font-weight: 600;">${(sellerStats[s.id]?.totalSalesAmount || 0).toLocaleString()}ì›</span>
              </div>`).join('')}
          </div>
        </div>
        <div style="background: #dbeafe; border-radius: 12px; padding: 12px; cursor: pointer;" onclick="toggleSellerTierList('500m')">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: #1e40af;">ğŸ’ 500ë§Œì› ì´ìƒ</div>
              <div style="font-size: 24px; font-weight: 700; color: #2563eb;">${sellers500M.length}ëª…</div>
            </div>
            <span style="color: #1e40af; font-size: 12px;">ìƒì„¸ë³´ê¸° â–¼</span>
          </div>
          <div id="seller-tier-500m" style="display: none; margin-top: 12px; max-height: 150px; overflow-y: auto;">
            ${sellers500M.length === 0 ? '<div style="color: #1e40af; font-size: 12px;">í•´ë‹¹ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
              sellers500M.map(s => `<div style="padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 12px; display: flex; justify-content: space-between;">
                <span>${s.name}</span>
                <span style="color: #2563eb; font-weight: 600;">${(sellerStats[s.id]?.totalSalesAmount || 0).toLocaleString()}ì›</span>
              </div>`).join('')}
          </div>
        </div>
        <div style="background: #fce7f3; border-radius: 12px; padding: 12px; cursor: pointer;" onclick="toggleSellerTierList('1000m')">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: #9d174d;">ğŸ‘‘ 1000ë§Œì› ì´ìƒ</div>
              <div style="font-size: 24px; font-weight: 700; color: #db2777;">${sellers1000M.length}ëª…</div>
            </div>
            <span style="color: #9d174d; font-size: 12px;">ìƒì„¸ë³´ê¸° â–¼</span>
          </div>
          <div id="seller-tier-1000m" style="display: none; margin-top: 12px; max-height: 150px; overflow-y: auto;">
            ${sellers1000M.length === 0 ? '<div style="color: #9d174d; font-size: 12px;">í•´ë‹¹ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
              sellers1000M.map(s => `<div style="padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 12px; display: flex; justify-content: space-between;">
                <span>${s.name}</span>
                <span style="color: #db2777; font-weight: 600;">${(sellerStats[s.id]?.totalSalesAmount || 0).toLocaleString()}ì›</span>
              </div>`).join('')}
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      ${state.sellers.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ‘¤</div>
          <div class="text">ë“±ë¡ëœ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      ` : `
        <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th style="min-width: 180px;">ì…€ëŸ¬ëª…/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)</th>
              <th>ì—°ë½ì²˜</th>
              <th style="min-width: 120px;">ì£¼ì†Œ</th>
              <th>ê³„ì •ë§í¬</th>
              <th>ì¹´í…Œê³ ë¦¬</th>
              <th style="text-align: center;">ì„œë¥˜í˜„í™©</th>
              <th style="text-align: center;">ë“œë¼ì´ë¸Œ</th>
              <th style="text-align: center;">ì§„í–‰í˜„í™©</th>
              <th style="text-align: right;">ì´ íŒë§¤ê±´</th>
              <th style="text-align: right;">ì´ íŒë§¤ì•¡</th>
              <th style="text-align: right;">ì´ ë§ˆì§„ê¸ˆ</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${state.sellers.map(s => {
              const stats = sellerStats[s.id] || { totalSalesCount: 0, totalSalesAmount: 0, totalMarginAmount: 0, ongoingCount: 0, completedCount: 0 };
              const categoryBadge = s.category ? `<span class="status-badge status-confirmed">${s.category}</span>` : '-';
              
              // ì„œë¥˜ í˜„í™© - ë¯¼ì¦, í†µì¥ë§Œ ì²´í¬
              const docStatus = `
                <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 2px; cursor: pointer; font-size: 11px; padding: 3px 6px; background: ${s.hasIdCard ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ì‹ ë¶„ì¦">
                    <input type="checkbox" ${s.hasIdCard ? 'checked' : ''} onchange="updateSellerField('${s.id}', 'hasIdCard', this.checked)" style="width: 14px; height: 14px;">
                    <span style="color: ${s.hasIdCard ? '#166534' : '#991b1b'};">ë¯¼ì¦</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 2px; cursor: pointer; font-size: 11px; padding: 3px 6px; background: ${s.hasBankAccount ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="í†µì¥ì‚¬ë³¸">
                    <input type="checkbox" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSellerField('${s.id}', 'hasBankAccount', this.checked)" style="width: 14px; height: 14px;">
                    <span style="color: ${s.hasBankAccount ? '#166534' : '#991b1b'};">í†µì¥</span>
                  </label>
                </div>
              `;
              
              return `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td>${s.contact || '-'}</td>
                  <td style="font-size: 12px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${s.address || ''}">${s.address || '-'}</td>
                  <td>
                    ${s.channelLink ? `<a href="${s.channelLink.startsWith('http') ? s.channelLink : 'https://' + s.channelLink}" target="_blank" style="color: var(--primary); text-decoration: none; font-size: 12px;">
                      ${getChannelIcon(s.channelLink)} ë°”ë¡œê°€ê¸°
                    </a>` : '-'}
                  </td>
                  <td>${categoryBadge}</td>
                  <td>${docStatus}</td>
                  <td style="text-align: center;">
                    <button onclick="openSellerGDrive('${s.id}')" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, #4285f4, #34a853); border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" title="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/></svg>
                    </button>
                  </td>
                  <td style="text-align: center;">
                    ${stats.completedCount > 0 ? `<span class="status-badge status-confirmed" style="font-size: 11px;">ì™„ë£Œ ${stats.completedCount}</span>` : ''}
                    ${stats.ongoingCount > 0 ? `<span class="status-badge status-ongoing" style="font-size: 11px;">ì§„í–‰ ${stats.ongoingCount}</span>` : ''}
                    ${stats.completedCount === 0 && stats.ongoingCount === 0 ? '-' : ''}
                  </td>
                  <td style="text-align: right;"><strong>${stats.totalSalesCount}</strong>ê±´</td>
                  <td style="text-align: right; color: var(--primary); font-weight: 600;">${stats.totalSalesAmount.toLocaleString()}ì›</td>
                  <td style="text-align: right; color: #d97706; font-weight: 600;">${stats.totalMarginAmount.toLocaleString()}ì›</td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openSellerModal(state.sellers.find(sel=>sel.id==='${s.id}'))">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        </div>
      `}
    </div>
  `;
}

// íŒ”ë¡œì›Œ ìˆ˜ í¬ë§·
function formatFollowers(num) {
  const n = Number(num);
  if (isNaN(n)) return num;
  if (n >= 10000) return (n / 10000).toFixed(1) + 'ë§Œ';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
  return n.toLocaleString();
}

// ì±„ë„ ì•„ì´ì½˜ ë°˜í™˜
function getChannelIcon(link) {
  if (!link) return 'ğŸ”—';
  const lower = link.toLowerCase();
  if (lower.includes('instagram')) return 'ğŸ“·';
  if (lower.includes('youtube')) return 'ğŸ¬';
  if (lower.includes('naver') || lower.includes('blog')) return 'ğŸ“';
  if (lower.includes('kakao')) return 'ğŸ’¬';
  if (lower.includes('tiktok')) return 'ğŸµ';
  return 'ğŸ”—';
}

async function renderSettlement() {
  const app = document.getElementById('app');

  // ğŸ”¥ cafe24_orders ë°ì´í„° ë¡œë“œ (ì—†ìœ¼ë©´ ë¡œë“œ)
  if (!state.cafe24Orders || state.cafe24Orders.length === 0) {
    app.innerHTML = '<div style="text-align: center; padding: 60px;"><div class="loading"></div><p style="margin-top: 16px; color: var(--gray-500);">ë§¤ì¶œ ë°ì´í„° ë¡œë”© ì¤‘...</p></div>';
    try {
      const ordersSnapshot = await db.collection('cafe24_orders').orderBy('order_date', 'desc').limit(1000).get();
      state.cafe24Orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (err) {
      console.error('cafe24 orders ë¡œë“œ ì‹¤íŒ¨:', err);
      state.cafe24Orders = [];
    }
  }

  const today = new Date();

  // ì •ì‚° ëŒ€ìƒ: statusê°€ completed/settledì´ê±°ë‚˜ endDateê°€ ì§€ë‚œ ëª¨ë“  ê³µêµ¬
  const completedDeals = (state.deals || []).filter(d => {
    const status = d.status;
    const endDate = d.endDate ? new Date(d.endDate) : null;
    return status === 'completed' || status === 'settled' || (endDate && endDate < today);
  });

  // ìì‚¬/íƒ€ì‚¬ êµ¬ë¶„ í•¨ìˆ˜
  const isExternalDeal = (d) => {
    const supplier = state.suppliers?.find(s => s.id === d.supplierId);
    return supplier?.supplierType === 'external' || d.productType === 'external';
  };

  // ì •ì‚° ì™„ë£Œ ì—¬ë¶€ ì²´í¬
  const isFullySettled = (d) => {
    if (isExternalDeal(d)) {
      return d.supplierSettled && d.sellerSettled;
    }
    return d.sellerSettled;
  };

  const pendingSettlement = completedDeals.filter(d => !isFullySettled(d));
  const fullySettled = completedDeals.filter(d => isFullySettled(d));

  // ========== ë§¤ì¶œ KPI ê³„ì‚° (sellerSettlements ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½) ==========
  const allSellerSettlements = state.sellerSettlements || [];
  const allSupplierSettlements = state.supplierSettlements || [];
  const cafe24Orders = state.cafe24Orders || [];

  // ìì‚¬ ìƒí’ˆ ì •ì‚°
  const inhouseSettlements = allSellerSettlements.filter(s => s.productType === 'inhouse');
  const inhouseSalesAmount = inhouseSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  const inhouseMarginAmount = inhouseSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
  const inhouseActualPayment = inhouseSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
  const inhousePendingCount = inhouseSettlements.filter(s => !s.isCompleted).length;

  // íƒ€ì‚¬ ìƒí’ˆ ì •ì‚°
  const externalSettlements = allSellerSettlements.filter(s => s.productType === 'external');
  const externalSalesAmount = externalSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  const externalMarginAmount = externalSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
  const externalActualPayment = externalSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
  const externalPendingCount = externalSettlements.filter(s => !s.isCompleted).length;

  // ê³µê¸‰ì‚¬ ì •ì‚°
  const supplierTotalAmount = allSupplierSettlements.reduce((sum, s) => sum + (Number(s.totalAmount) || 0), 0);

  // ì´ ë§¤ì¶œ (cafe24 ë˜ëŠ” sellerSettlements ì¤‘ í° ê°’ ì‚¬ìš©)
  const cafe24TotalSales = cafe24Orders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);
  const settlementTotalSales = inhouseSalesAmount + externalSalesAmount;
  const totalSalesAmount = Math.max(cafe24TotalSales, settlementTotalSales);

  const totalPgFee = Math.round(totalSalesAmount * 0.04);

  // ì •ì‚°ëŒ€ê¸° ê¸ˆì•¡ (pendingSettlement ê¸°ì¤€)
  const totalPendingAmount = pendingSettlement.reduce((sum, d) => sum + (Number(d.totalSales) || 0), 0);

  // ìˆœì´ìµ ê³„ì‚°
  const totalSellerPayout = inhouseActualPayment + externalActualPayment;
  const totalSupplierPayout = supplierTotalAmount;
  const netProfit = totalSalesAmount - totalPgFee - totalSellerPayout - totalSupplierPayout;

  // ìì‚¬ ìˆœì´ìµ
  const inhousePgFee = Math.round(inhouseSalesAmount * 0.04);
  const inhouseProfit = inhouseSalesAmount - inhouseActualPayment - inhousePgFee;

  // íƒ€ì‚¬ ìˆœì´ìµ (ë§¤ì¶œ - ê³µê¸‰ì‚¬ì •ì‚° - ì…€ëŸ¬ì •ì‚° - PGìˆ˜ìˆ˜ë£Œ)
  const externalPgFee = Math.round(externalSalesAmount * 0.04);
  const externalProfit = externalSalesAmount - supplierTotalAmount - externalActualPayment - externalPgFee;

  // ë§ˆê°ì¼ ê¸°ì¤€ D+ ê³„ì‚°
  const getDaysOverdue = (endDate) => {
    if (!endDate) return 0;
    return Math.floor((today - new Date(endDate)) / (1000 * 60 * 60 * 24));
  };

  app.innerHTML = `
    <div class="page-header" style="margin-bottom: 24px;">
      <h1 class="page-title" style="font-size: 24px; font-weight: 700;">ì •ì‚° ê´€ë¦¬</h1>
      <p style="color: var(--gray-500); font-size: 14px; margin-top: 4px;">ê³µêµ¬ ë§ˆê° í›„ 3~7ì¼ ì´ë‚´ ì •ì‚° ê¶Œì¥</p>
    </div>

    <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px;">
      <button onclick="openCafe24MappingModal()" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: white; border: 2px solid var(--gray-200); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='var(--gray-200)'">
        <span style="font-size: 24px;">ğŸ“Š</span>
        <div style="text-align: left;">
          <div style="font-weight: 600; color: var(--gray-800);">ì¹´í˜24 ë§¤ì¶œ ì—°ë™</div>
          <div style="font-size: 12px; color: var(--gray-500);">ì—‘ì…€ ì—…ë¡œë“œ â†’ ìë™ ë§¤í•‘</div>
        </div>
      </button>
      <button onclick="generateSettlementFromProductData()" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid #22c55e; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
        <span style="font-size: 24px;">âœ¨</span>
        <div style="text-align: left;">
          <div style="font-weight: 600; color: #166534;">ì •ì‚°ì„œ ìƒì„±</div>
          <div style="font-size: 12px; color: #15803d;">ìƒí’ˆë°ì´í„° â†’ ì •ì‚°ì„œ</div>
        </div>
      </button>
      <button onclick="generateManagementReport()" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: white; border: 2px solid var(--gray-200); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#22c55e'" onmouseout="this.style.borderColor='var(--gray-200)'">
        <span style="font-size: 24px;">ğŸ“‹</span>
        <div style="text-align: left;">
          <div style="font-weight: 600; color: var(--gray-800);">ê²½ì˜íŒ€ ì •ì‚°ì„œ</div>
          <div style="font-size: 12px; color: var(--gray-500);">ì „ì²´ ë‚´ì—­ ë‹¤ìš´ë¡œë“œ</div>
        </div>
      </button>
      <button onclick="clearManualSettlementData()" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: white; border: 2px solid #fca5a5; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#ef4444'" onmouseout="this.style.borderColor='#fca5a5'">
        <span style="font-size: 24px;">ğŸ—‘ï¸</span>
        <div style="text-align: left;">
          <div style="font-weight: 600; color: #dc2626;">ìˆ˜ë™ ë°ì´í„° ì •ë¦¬</div>
          <div style="font-size: 12px; color: var(--gray-500);">ê¸°ì¡´ ìˆ˜ë™ ì…ë ¥ ì‚­ì œ</div>
        </div>
      </button>
    </div>

    <!-- ê°„ê²°í•œ KPI -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
      <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid var(--gray-200);">
        <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì´ ë§¤ì¶œ</div>
        <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${formatNumber(totalSalesAmount)}ì›</div>
      </div>
      <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid var(--gray-200);">
        <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì •ì‚°ëŒ€ê¸°</div>
        <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${formatNumber(totalPendingAmount)}ì›</div>
      </div>
      <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid var(--gray-200);">
        <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìˆœì´ìµ</div>
        <div style="font-size: 18px; font-weight: 700; color: ${netProfit >= 0 ? '#10b981' : '#ef4444'};">${formatNumber(netProfit)}ì›</div>
      </div>
      <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid var(--gray-200);">
        <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì§„í–‰ë¥ </div>
        <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${fullySettled.length}/${completedDeals.length}</div>
      </div>
    </div>

    <!-- ìì‚¬/íƒ€ì‚¬ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
      <!-- ìì‚¬ ìƒí’ˆ ëŒ€ì‹œë³´ë“œ -->
      <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 20px; border: 1px solid #bfdbfe;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
          <h3 style="font-size: 15px; font-weight: 700; color: #1e40af; margin: 0; display: flex; align-items: center; gap: 8px;">
            ğŸ  ìì‚¬ ìƒí’ˆ
            <span style="background: #1e40af; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${inhouseSettlements.length}ê±´</span>
          </h3>
          ${inhousePendingCount > 0 ? `<span style="background: #fef3c7; color: #92400e; padding: 3px 10px; border-radius: 8px; font-size: 11px; font-weight: 600;">ëŒ€ê¸° ${inhousePendingCount}ê±´</span>` : ''}
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div style="background: white; border-radius: 10px; padding: 12px; text-align: center;">
            <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">íŒë§¤ê¸ˆì•¡</div>
            <div style="font-size: 16px; font-weight: 700; color: #1e40af;">${formatNumber(inhouseSalesAmount)}ì›</div>
          </div>
          <div style="background: white; border-radius: 10px; padding: 12px; text-align: center;">
            <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ì…€ëŸ¬ì§€ê¸‰ì•¡</div>
            <div style="font-size: 16px; font-weight: 700; color: #6b7280;">${formatNumber(inhouseActualPayment)}ì›</div>
          </div>
          <div style="background: white; border-radius: 10px; padding: 12px; text-align: center;">
            <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ìˆœì´ìµ</div>
            <div style="font-size: 16px; font-weight: 700; color: ${inhouseProfit >= 0 ? '#10b981' : '#ef4444'};">${formatNumber(inhouseProfit)}ì›</div>
          </div>
        </div>
      </div>

      <!-- íƒ€ì‚¬ ìƒí’ˆ ëŒ€ì‹œë³´ë“œ -->
      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; padding: 20px; border: 1px solid #fcd34d;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
          <h3 style="font-size: 15px; font-weight: 700; color: #92400e; margin: 0; display: flex; align-items: center; gap: 8px;">
            ğŸ­ íƒ€ì‚¬ ìƒí’ˆ
            <span style="background: #92400e; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${externalSettlements.length}ê±´</span>
          </h3>
          ${externalPendingCount > 0 ? `<span style="background: #fee2e2; color: #dc2626; padding: 3px 10px; border-radius: 8px; font-size: 11px; font-weight: 600;">ëŒ€ê¸° ${externalPendingCount}ê±´</span>` : ''}
        </div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
          <div style="background: white; border-radius: 10px; padding: 10px; text-align: center;">
            <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">íŒë§¤ê¸ˆì•¡</div>
            <div style="font-size: 14px; font-weight: 700; color: #92400e;">${formatNumber(externalSalesAmount)}ì›</div>
          </div>
          <div style="background: white; border-radius: 10px; padding: 10px; text-align: center;">
            <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">ê³µê¸‰ì‚¬ì •ì‚°</div>
            <div style="font-size: 14px; font-weight: 700; color: #dc2626;">${formatNumber(supplierTotalAmount)}ì›</div>
          </div>
          <div style="background: white; border-radius: 10px; padding: 10px; text-align: center;">
            <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">ì…€ëŸ¬ì§€ê¸‰ì•¡</div>
            <div style="font-size: 14px; font-weight: 700; color: #6b7280;">${formatNumber(externalActualPayment)}ì›</div>
          </div>
          <div style="background: white; border-radius: 10px; padding: 10px; text-align: center;">
            <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">ìˆœì´ìµ</div>
            <div style="font-size: 14px; font-weight: 700; color: ${externalProfit >= 0 ? '#10b981' : '#ef4444'};">${formatNumber(externalProfit)}ì›</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì •ì‚° ëŒ€ê¸° -->
    <div style="margin-bottom: 24px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
        <h2 style="font-size: 16px; font-weight: 600; color: var(--gray-800); display: flex; align-items: center; gap: 8px;">
          <span style="color: #f59e0b;">â³</span> ì •ì‚° ëŒ€ê¸°
          <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${pendingSettlement.length}</span>
        </h2>
      </div>

      ${pendingSettlement.length === 0 ? `
        <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; border: 1px solid var(--gray-200);">
          <div style="font-size: 32px; margin-bottom: 8px;">ğŸ‰</div>
          <div style="color: var(--gray-500);">ì •ì‚° ëŒ€ê¸° ì¤‘ì¸ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      ` : `
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${pendingSettlement.sort((a,b) => new Date(a.endDate) - new Date(b.endDate)).map(d => {
            const isExternal = isExternalDeal(d);
            const sellerName = getSellerName(d.sellerId);
            const supplierName = getSupplierName(d.supplierId);
            const daysOverdue = getDaysOverdue(d.endDate);
            const isUrgent = daysOverdue >= 7;
            const isWarning = daysOverdue >= 3 && daysOverdue < 7;

            return `
              <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid ${isUrgent ? '#fecaca' : isWarning ? '#fed7aa' : 'var(--gray-200)'}; ${isUrgent ? 'border-left: 4px solid #ef4444;' : isWarning ? 'border-left: 4px solid #f59e0b;' : ''}">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                    <!-- íƒ€ì‚¬/ìì‚¬ ë±ƒì§€ -->
                    <span style="background: ${isExternal ? '#fef3c7' : '#dbeafe'}; color: ${isExternal ? '#92400e' : '#1d4ed8'}; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap;">
                      ${isExternal ? 'íƒ€ì‚¬' : 'ìì‚¬'}
                    </span>
                    <!-- ê³µêµ¬ ì •ë³´ -->
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-weight: 600; color: var(--gray-800); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${d.title || d.brandName || '-'}</div>
                      <div style="font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                        ${isExternal ? supplierName + ' Â· ' : ''}${sellerName} Â· ${formatDateKR(d.endDate)} ë§ˆê°
                      </div>
                    </div>
                  </div>
                  <!-- D+ í‘œì‹œ -->
                  <div style="display: flex; align-items: center; gap: 8px;">
                    ${daysOverdue > 0 ? `
                      <span style="background: ${isUrgent ? '#fee2e2' : isWarning ? '#ffedd5' : '#f3f4f6'}; color: ${isUrgent ? '#dc2626' : isWarning ? '#ea580c' : '#6b7280'}; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">
                        D+${daysOverdue}
                      </span>
                    ` : ''}
                    <button onclick="deleteSettlementData('${d.id}')" style="padding: 8px 10px; background: white; border: 1px solid #fca5a5; border-radius: 8px; cursor: pointer; font-size: 12px; color: #dc2626;" title="ì •ì‚° ë°ì´í„° ì‚­ì œ">
                      ğŸ—‘
                    </button>
                    <button onclick="viewSettlementReport('${d.id}')" style="padding: 8px 12px; background: var(--gray-100); border: none; border-radius: 8px; cursor: pointer; font-size: 12px; color: var(--gray-600);">
                      ì •ì‚°ì„œ
                    </button>
                    <button onclick="completeSettlement('${d.id}', ${isExternal})" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">
                      ì™„ë£Œ
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `}
    </div>

    <!-- ì •ì‚° ì™„ë£Œ -->
    ${fullySettled.length > 0 ? `
      <div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
          <h2 style="font-size: 16px; font-weight: 600; color: var(--gray-800); display: flex; align-items: center; gap: 8px;">
            <span style="color: #10b981;">âœ“</span> ì •ì‚° ì™„ë£Œ
            <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${fullySettled.length}</span>
          </h2>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${fullySettled.slice(0, 5).map(d => {
            const isExternal = isExternalDeal(d);
            const sellerName = getSellerName(d.sellerId);
            const supplierName = getSupplierName(d.supplierId);

            return `
              <div style="background: var(--gray-50); border-radius: 12px; padding: 12px 16px; border: 1px solid var(--gray-200);">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                    <span style="background: ${isExternal ? '#fef3c7' : '#dbeafe'}; color: ${isExternal ? '#92400e' : '#1d4ed8'}; padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                      ${isExternal ? 'íƒ€ì‚¬' : 'ìì‚¬'}
                    </span>
                    <div style="flex: 1;">
                      <span style="font-size: 13px; color: var(--gray-700);">${d.title || d.brandName || '-'}</span>
                      <span style="font-size: 11px; color: var(--gray-400); margin-left: 8px;">${isExternal ? supplierName + ' Â· ' : ''}${sellerName}</span>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <button onclick="viewSettlementReport('${d.id}')" style="padding: 6px 10px; background: white; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer; font-size: 11px; color: var(--gray-600);">
                      ë³´ê¸°
                    </button>
                    <button onclick="revertSettlementToPending('${d.id}')" style="padding: 6px 10px; background: white; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer; font-size: 11px; color: var(--gray-500);">
                      â†©
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
          ${fullySettled.length > 5 ? `
            <div style="text-align: center; padding: 8px; color: var(--gray-500); font-size: 12px;">
              +${fullySettled.length - 5}ê°œ ë”ë³´ê¸°
            </div>
          ` : ''}
        </div>
      </div>
    ` : ''}
  `;
}

// ========== ì •ì‚° ê´€ë¦¬ í•¨ìˆ˜ ==========

// ì •ì‚° ì™„ë£Œ ì²˜ë¦¬ (ë²„íŠ¼ í´ë¦­)
async function completeSettlement(dealId, isExternal) {
  if (!canEdit()) { showNoPermission(); return; }

  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;

  // í˜„ì¬ ìƒíƒœ í™•ì¸
  const currentlySettled = isExternal
    ? (deal.supplierSettled && deal.sellerSettled)
    : deal.sellerSettled;

  const newStatus = !currentlySettled;
  const confirmMsg = newStatus
    ? 'ì´ ê³µêµ¬ë¥¼ ì •ì‚° ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
    : 'ì •ì‚°ì„ ëŒ€ê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?';

  if (!confirm(confirmMsg)) return;

  try {
    const updateData = isExternal
      ? { supplierSettled: newStatus, sellerSettled: newStatus }
      : { sellerSettled: newStatus };

    if (newStatus) {
      updateData.status = 'settled';
    }

    await db.collection('deals').doc(dealId).update(updateData);

    // state ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë¦¬ë Œë” ì—†ì´)
    Object.assign(deal, updateData);

    showToast(newStatus ? 'âœ… ì •ì‚° ì™„ë£Œ ì²˜ë¦¬ë¨' : 'â³ ì •ì‚° ëŒ€ê¸°ë¡œ ë³€ê²½ë¨');
    renderSettlement();
  } catch (err) {
    console.error('ì •ì‚° ì²˜ë¦¬ ì‹¤íŒ¨:', err);
    showToast('âŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì •ì‚°ì™„ë£Œ â†’ ëŒ€ê¸°ë¡œ ë˜ëŒë¦¬ê¸°
async function revertSettlementToPending(dealId) {
  if (!canEdit()) { showNoPermission(); return; }

  if (!confirm('ì´ ê³µêµ¬ì˜ ì •ì‚°ì„ ëŒ€ê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  try {
    await db.collection('deals').doc(dealId).update({
      supplierSettled: false,
      sellerSettled: false,
      status: 'completed'
    });
    showToast('âœ… ì •ì‚° ëŒ€ê¸° ìƒíƒœë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤');
    renderSettlement();
  } catch (err) {
    console.error('ë˜ëŒë¦¬ê¸° ì‹¤íŒ¨:', err);
    showToast('âŒ ë˜ëŒë¦¬ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ==================== ì •ì‚° ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ====================
// ì‚­ì œ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ (ì‚­ì œ ì…ë ¥ í•„ìš”)
function showDeleteConfirmModal(options) {
  const { title, message, deleteType, onConfirm } = options;

  document.getElementById('modal').innerHTML = `
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-bottom: 2px solid #fca5a5;">
        <h2 style="color: #dc2626; display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 24px;">âš ï¸</span> ${title}
        </h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <p style="color: #991b1b; font-size: 14px; margin: 0; line-height: 1.6;">
            ${message}
          </p>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
            ì‚­ì œ ë°©ë²• ì„ íƒ
          </label>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
              <input type="radio" name="deleteMethod" value="soft" checked style="accent-color: #f59e0b;">
              <div>
                <strong style="color: #374151;">ğŸ”„ ì†Œí”„íŠ¸ ì‚­ì œ (ê¶Œì¥)</strong>
                <p style="margin: 4px 0 0; font-size: 12px; color: #6b7280;">ë°ì´í„° ì´ˆê¸°í™”ë§Œ ì§„í–‰, ë³µêµ¬ ê°€ëŠ¥</p>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; cursor: pointer;">
              <input type="radio" name="deleteMethod" value="hard" style="accent-color: #dc2626;">
              <div>
                <strong style="color: #dc2626;">ğŸ—‘ï¸ ì™„ì „ ì‚­ì œ</strong>
                <p style="margin: 4px 0 0; font-size: 12px; color: #991b1b;">ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì˜êµ¬ ì‚­ì œ, ë³µêµ¬ ë¶ˆê°€</p>
              </div>
            </label>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
            ğŸ”’ ì‚­ì œ í™•ì¸ (ì•„ë˜ì— <span style="color: #dc2626; font-weight: 700;">ì‚­ì œ</span>ë¥¼ ì…ë ¥í•˜ì„¸ìš”)
          </label>
          <input type="text" id="deleteConfirmInput" class="form-input" placeholder="ì‚­ì œ"
            style="border: 2px solid #fca5a5; font-size: 16px; text-align: center;"
            oninput="checkDeleteInput()">
          <p style="font-size: 11px; color: #9ca3af; margin-top: 6px; text-align: center;">
            ì‹¤ìˆ˜ë¡œ ì‚­ì œí•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ "ì‚­ì œ"ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤
          </p>
        </div>

        <div class="modal-footer" style="padding: 0; border: none; gap: 12px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
            ì·¨ì†Œ
          </button>
          <button type="button" id="confirmDeleteBtn" class="btn" disabled
            style="flex: 1; background: #d1d5db; color: #6b7280; cursor: not-allowed;"
            onclick="executeDelete('${deleteType}')">
            ğŸ”’ ì‚­ì œ ì ê¸ˆ
          </button>
        </div>
      </div>
    </div>
  `;

  // ì‚­ì œ ì½œë°± ì €ì¥
  window._pendingDeleteCallback = onConfirm;

  document.getElementById('modal').classList.add('active');
}

// ì‚­ì œ ì…ë ¥ í™•ì¸
function checkDeleteInput() {
  const input = document.getElementById('deleteConfirmInput');
  const btn = document.getElementById('confirmDeleteBtn');

  if (input.value === 'ì‚­ì œ') {
    btn.disabled = false;
    btn.style.background = '#dc2626';
    btn.style.color = '#fff';
    btn.style.cursor = 'pointer';
    btn.innerHTML = 'ğŸ—‘ï¸ ì‚­ì œ ì‹¤í–‰';
  } else {
    btn.disabled = true;
    btn.style.background = '#d1d5db';
    btn.style.color = '#6b7280';
    btn.style.cursor = 'not-allowed';
    btn.innerHTML = 'ğŸ”’ ì‚­ì œ ì ê¸ˆ';
  }
}

// ì‚­ì œ ì‹¤í–‰
async function executeDelete(deleteType) {
  const method = document.querySelector('input[name="deleteMethod"]:checked')?.value || 'soft';

  if (window._pendingDeleteCallback) {
    await window._pendingDeleteCallback(method);
    window._pendingDeleteCallback = null;
  }

  closeModal();
}

// ì •ì‚° ë°ì´í„° ì‚­ì œ (ëŒ€ê¸° ìƒíƒœì—ì„œ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ë“±ë¡ ê°€ëŠ¥í•˜ê²Œ)
async function deleteSettlementData(dealId) {
  if (!canEdit()) { showNoPermission(); return; }

  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) {
    showToast('âŒ ê³µêµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  showDeleteConfirmModal({
    title: 'ì •ì‚° ë°ì´í„° ì‚­ì œ',
    message: `<strong>${deal.brandName || 'ì•Œ ìˆ˜ ì—†ëŠ” ë¸Œëœë“œ'}</strong>ì˜ ì •ì‚° ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.<br><br>
      â€¢ ì¹´í˜24 ë§¤í•‘ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤<br>
      â€¢ ì •ì‚° ìƒíƒœê°€ ë¦¬ì…‹ë©ë‹ˆë‹¤<br>
      â€¢ ì´ ì‘ì—…ì€ ì‹ ì¤‘í•˜ê²Œ ì§„í–‰í•´ì£¼ì„¸ìš”`,
    deleteType: 'settlementData',
    onConfirm: async (method) => {
      try {
        if (method === 'hard') {
          // ì™„ì „ ì‚­ì œ: ê´€ë ¨ ì •ì‚°ì„œë„ ì‚­ì œ
          const sellerSettlements = (state.sellerSettlements || []).filter(s =>
            s.brandName === deal.brandName && s.dealPeriod === (deal.startDate + '~' + deal.endDate)
          );
          const supplierSettlements = (state.supplierSettlements || []).filter(s =>
            s.brandName === deal.brandName && s.dealPeriod === (deal.startDate + '~' + deal.endDate)
          );

          for (const s of sellerSettlements) {
            await db.collection('sellerSettlements').doc(s.id).delete();
          }
          for (const s of supplierSettlements) {
            await db.collection('supplierSettlements').doc(s.id).delete();
          }
        }

        // ì¹´í˜24 ë§¤í•‘ ë°ì´í„° ì´ˆê¸°í™”
        await db.collection('deals').doc(dealId).update({
          cafe24Mapped: false,
          totalSales: 0,
          totalQty: 0,
          supplierSettled: false,
          sellerSettled: false,
          status: 'completed'
        });

        // state ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        Object.assign(deal, {
          cafe24Mapped: false,
          totalSales: 0,
          totalQty: 0,
          supplierSettled: false,
          sellerSettled: false,
          status: 'completed'
        });

        showToast(`âœ… ì •ì‚° ë°ì´í„°ê°€ ${method === 'hard' ? 'ì™„ì „' : ''} ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
        renderSettlement();
      } catch (err) {
        console.error('ì •ì‚° ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', err);
        showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }
  });
}

// ìˆ˜ë™ ì…ë ¥ ì •ì‚° ë°ì´í„° ì¼ê´„ ì‚­ì œ (ì¹´í˜24 ë°ì´í„°ë§Œ ìœ ì§€)
async function clearManualSettlementData() {
  if (!canEdit()) { showNoPermission(); return; }

  // ìˆ˜ë™ ì…ë ¥ ë°ì´í„° ê°œìˆ˜ í™•ì¸
  const manualSellerSettlements = (state.sellerSettlements || []).filter(s => s.source !== 'cafe24');
  const manualSupplierSettlements = (state.supplierSettlements || []).filter(s => s.source !== 'cafe24');
  const cafe24SellerSettlements = (state.sellerSettlements || []).filter(s => s.source === 'cafe24');
  const cafe24SupplierSettlements = (state.supplierSettlements || []).filter(s => s.source === 'cafe24');

  if (manualSellerSettlements.length === 0 && manualSupplierSettlements.length === 0) {
    showToast('â„¹ï¸ ì‚­ì œí•  ìˆ˜ë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  const confirmMsg = `âš ï¸ ìˆ˜ë™ ì…ë ¥ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
    `ì‚­ì œ ëŒ€ìƒ:\n` +
    `- ì…€ëŸ¬ ì •ì‚°: ${manualSellerSettlements.length}ê±´\n` +
    `- ê³µê¸‰ì‚¬ ì •ì‚°: ${manualSupplierSettlements.length}ê±´\n\n` +
    `ìœ ì§€ ëŒ€ìƒ (ì¹´í˜24):\n` +
    `- ì…€ëŸ¬ ì •ì‚°: ${cafe24SellerSettlements.length}ê±´\n` +
    `- ê³µê¸‰ì‚¬ ì •ì‚°: ${cafe24SupplierSettlements.length}ê±´\n\n` +
    `ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`;

  if (!confirm(confirmMsg)) return;

  try {
    showToast('ğŸ”„ ìˆ˜ë™ ë°ì´í„° ì‚­ì œ ì¤‘...');

    // ì…€ëŸ¬ ì •ì‚° ì‚­ì œ
    for (const s of manualSellerSettlements) {
      await db.collection('sellerSettlements').doc(s.id).delete();
    }

    // ê³µê¸‰ì‚¬ ì •ì‚° ì‚­ì œ
    for (const s of manualSupplierSettlements) {
      await db.collection('supplierSettlements').doc(s.id).delete();
    }

    // state ì—…ë°ì´íŠ¸
    state.sellerSettlements = cafe24SellerSettlements;
    state.supplierSettlements = cafe24SupplierSettlements;

    showToast(`âœ… ìˆ˜ë™ ë°ì´í„° ì‚­ì œ ì™„ë£Œ!\nì…€ëŸ¬: ${manualSellerSettlements.length}ê±´, ê³µê¸‰ì‚¬: ${manualSupplierSettlements.length}ê±´`);
    renderSettlement();
  } catch (err) {
    console.error('ìˆ˜ë™ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', err);
    showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì •ì‚°ì„œ ë³´ê¸°
function viewSettlementReport(dealId) {
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) {
    showToast('ê³µêµ¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  const seller = state.sellers?.find(s => s.id === deal.sellerId);
  const supplier = state.suppliers?.find(s => s.id === deal.supplierId);
  const isExternal = supplier?.supplierType === 'external' || deal.productType === 'external';
  const selectedProducts = deal.selectedProducts || [];

  // ì¹´í˜24 ì£¼ë¬¸ì—ì„œ í•´ë‹¹ ê³µêµ¬ ê´€ë ¨ ì£¼ë¬¸ ì°¾ê¸°
  const cafe24Orders = state.cafe24Orders || [];
  const sellerNickname = seller?.nickname || seller?.name || '';

  // ì…€ëŸ¬ëª…ìœ¼ë¡œ ì¹´í˜24 ì£¼ë¬¸ í•„í„°ë§ (ê³µêµ¬ ê¸°ê°„ ë‚´)
  const dealOrders = cafe24Orders.filter(o => {
    const orderSellerName = (o.seller_name || '').toLowerCase();
    const matchSeller = sellerNickname && orderSellerName.includes(sellerNickname.toLowerCase());

    // ë‚ ì§œ í•„í„° (ê³µêµ¬ ê¸°ê°„ Â±3ì¼)
    if (deal.startDate && deal.endDate) {
      const orderDate = new Date(o.order_date);
      const startDate = new Date(deal.startDate);
      const endDate = new Date(deal.endDate);
      startDate.setDate(startDate.getDate() - 3);
      endDate.setDate(endDate.getDate() + 3);

      if (orderDate < startDate || orderDate > endDate) return false;
    }

    return matchSeller;
  });

  // ìƒí’ˆë³„ë¡œ ê·¸ë£¹í™” (ì¹´í˜24 ì£¼ë¬¸ìƒí’ˆëª… ê¸°ì¤€)
  const productGroups = {};
  dealOrders.forEach(order => {
    const productKey = order.product_option || order.product_name || '-';
    if (!productGroups[productKey]) {
      productGroups[productKey] = {
        productName: productKey,
        quantity: 0,
        totalAmount: 0,
        orders: []
      };
    }
    productGroups[productKey].quantity += (order.quantity || 1);
    productGroups[productKey].totalAmount += (order.total_amount || 0);
    productGroups[productKey].orders.push(order);
  });

  // cafe24 ì£¼ë¬¸ì˜ supply_price, margin_rate ë˜ëŠ” selectedProductsì—ì„œ ë§¤ì¹­
  const productsList = Object.values(productGroups).map(group => {
    // 1. ë¨¼ì € cafe24 ì£¼ë¬¸ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¨ ë°ì´í„° í™•ì¸
    const firstOrder = group.orders[0] || {};
    let marginRate = Number(firstOrder.margin_rate) || 0;
    let supplyPrice = Number(firstOrder.supply_price) || 0;

    // 2. cafe24 ë°ì´í„°ê°€ ì—†ìœ¼ë©´ selectedProductsì—ì„œ ë§¤ì¹­
    if (!marginRate || !supplyPrice) {
      for (const sp of selectedProducts) {
        const spName = (sp.productName || '').toLowerCase();
        const groupName = (group.productName || '').toLowerCase();
        if (groupName.includes(spName) || spName.includes(groupName) ||
            groupName.replace(/[^ê°€-í£a-z0-9]/gi, '').includes(spName.replace(/[^ê°€-í£a-z0-9]/gi, ''))) {
          if (!marginRate) marginRate = sp.marginRate || 0;
          if (!supplyPrice) supplyPrice = sp.supplyPrice || 0;
          break;
        }
      }
    }

    // 3. ê¸°ë³¸ê°’ ì ìš©
    marginRate = marginRate || deal.sellerMarginRate || 10;
    supplyPrice = supplyPrice || deal.supplyPrice || 0;

    // ğŸ¯ íƒ€ì‚¬ ìƒí’ˆ: supplyPriceê°€ 0ì´ë©´ íŒë§¤ë‹¨ê°€ì—ì„œ ë§ˆì§„ìœ¨ ë¹¼ì„œ ìë™ ê³„ì‚°
    // ê³µê¸‰ë‹¨ê°€ = íŒë§¤ë‹¨ê°€ * (100 - ë§ˆì§„ìœ¨) / 100
    const unitPrice = group.orders.length > 0
      ? Math.round(group.totalAmount / group.quantity)
      : 0;

    if (isExternal && supplyPrice === 0 && unitPrice > 0 && marginRate > 0) {
      supplyPrice = Math.round(unitPrice * (100 - marginRate) / 100);
    }

    const marginAmount = Math.round(group.totalAmount * marginRate / 100);
    const supplyTotal = supplyPrice * group.quantity;

    return {
      productName: group.productName,
      quantity: group.quantity,
      amount: group.totalAmount,
      unitPrice: unitPrice,
      marginRate: marginRate,
      supplyPrice: supplyPrice,
      supplyTotal: supplyTotal,
      marginAmount: marginAmount
    };
  });

  // ì´ê³„ ê³„ì‚°
  const totalSales = productsList.length > 0
    ? productsList.reduce((sum, p) => sum + p.amount, 0)
    : (deal.totalSales || 0);
  const totalQty = productsList.length > 0
    ? productsList.reduce((sum, p) => sum + p.quantity, 0)
    : (deal.totalQty || 0);
  const totalMarginAmount = productsList.reduce((sum, p) => sum + p.marginAmount, 0);
  const totalSupplyAmount = productsList.reduce((sum, p) => sum + p.supplyTotal, 0);

  const pgFee = Math.round(totalSales * 0.04);
  const sellerTax = Math.round(totalMarginAmount * 0.033);
  const sellerPayout = totalMarginAmount - sellerTax;

  // íƒ€ì‚¬: ê³µê¸‰ì‚¬ ì •ì‚°
  const supplierVat = isExternal ? Math.round(totalSupplyAmount * 0.1) : 0;
  const supplierPayout = isExternal ? totalSupplyAmount + supplierVat : 0;

  // ìˆœì´ìµ ê³„ì‚°
  const netProfit = isExternal
    ? totalSales - supplierPayout - sellerPayout - pgFee
    : totalSales - sellerPayout - pgFee;

  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow: auto;">
      <div class="modal-header" style="position: sticky; top: 0; background: white; z-index: 10;">
        <h2>ğŸ“‹ ì •ì‚°ì„œ - ${deal.title || deal.brandName}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>

      <div style="padding: 20px;">
        <!-- ê³µêµ¬ ê¸°ë³¸ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
            <div><span style="color: var(--gray-500);">ê³µêµ¬ëª…:</span> <strong>${deal.title || deal.brandName}</strong></div>
            <div><span style="color: var(--gray-500);">êµ¬ë¶„:</span> <span style="background: ${isExternal ? '#fef3c7' : '#dbeafe'}; color: ${isExternal ? '#92400e' : '#1d4ed8'}; padding: 2px 8px; border-radius: 4px;">${isExternal ? 'íƒ€ì‚¬' : 'ìì‚¬'}</span></div>
            <div><span style="color: var(--gray-500);">ê³µêµ¬ê¸°ê°„:</span> ${formatDateKR(deal.startDate)} ~ ${formatDateKR(deal.endDate)}</div>
            <div><span style="color: var(--gray-500);">ì…€ëŸ¬:</span> ${seller?.name || '-'}</div>
            ${isExternal ? `<div><span style="color: var(--gray-500);">ê³µê¸‰ì‚¬:</span> ${supplier?.name || '-'}</div>` : ''}
          </div>
        </div>

        <!-- íŒë§¤ ìƒí’ˆ ëª©ë¡ (ìƒí’ˆë³„ ë§ˆì§„ ê³„ì‚°) -->
        ${productsList.length > 0 ? `
          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">ğŸ“¦ íŒë§¤ ìƒí’ˆ</h3>
            <div style="overflow-x: auto;">
              <table style="width: 100%; font-size: 12px; border-collapse: collapse; min-width: 700px;">
                <thead>
                  <tr style="background: var(--gray-50); border-bottom: 2px solid var(--gray-200);">
                    <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--gray-600);">ìƒí’ˆëª…</th>
                    <th style="padding: 10px 6px; text-align: right; font-weight: 600; color: var(--gray-600);">ë‹¨ê°€</th>
                    <th style="padding: 10px 6px; text-align: right; font-weight: 600; color: var(--gray-600);">ìˆ˜ëŸ‰</th>
                    <th style="padding: 10px 6px; text-align: right; font-weight: 600; color: var(--gray-600);">íŒë§¤ê¸ˆì•¡</th>
                    ${isExternal ? `<th style="padding: 10px 6px; text-align: right; font-weight: 600; color: var(--gray-600);">ê³µê¸‰ê°€</th>` : ''}
                    <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: var(--gray-600);">ë§ˆì§„ìœ¨</th>
                    <th style="padding: 10px 6px; text-align: right; font-weight: 600; color: var(--gray-600);">ë§ˆì§„ê¸ˆì•¡</th>
                  </tr>
                </thead>
                <tbody>
                  ${productsList.map(p => `
                    <tr style="border-bottom: 1px solid var(--gray-100);">
                      <td style="padding: 10px 6px; color: var(--gray-700); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${p.productName}">${p.productName}</td>
                      <td style="padding: 10px 6px; text-align: right;">${formatNumber(p.unitPrice)}ì›</td>
                      <td style="padding: 10px 6px; text-align: right;">${p.quantity}ê°œ</td>
                      <td style="padding: 10px 6px; text-align: right; font-weight: 500;">${formatNumber(p.amount)}ì›</td>
                      ${isExternal ? `<td style="padding: 10px 6px; text-align: right; color: #92400e;">${formatNumber(p.supplyTotal)}ì›</td>` : ''}
                      <td style="padding: 10px 6px; text-align: center; color: var(--primary);">${p.marginRate}%</td>
                      <td style="padding: 10px 6px; text-align: right; color: #1d4ed8; font-weight: 500;">${formatNumber(p.marginAmount)}ì›</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot>
                  <tr style="background: var(--gray-100); font-weight: 600;">
                    <td style="padding: 12px 6px;">í•©ê³„</td>
                    <td style="padding: 12px 6px; text-align: right;"></td>
                    <td style="padding: 12px 6px; text-align: right;">${totalQty}ê°œ</td>
                    <td style="padding: 12px 6px; text-align: right;">${formatNumber(totalSales)}ì›</td>
                    ${isExternal ? `<td style="padding: 12px 6px; text-align: right; color: #92400e;">${formatNumber(totalSupplyAmount)}ì›</td>` : ''}
                    <td style="padding: 12px 6px; text-align: center;">-</td>
                    <td style="padding: 12px 6px; text-align: right; color: #1d4ed8;">${formatNumber(totalMarginAmount)}ì›</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        ` : `
          <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center; color: var(--gray-500);">
            íŒë§¤ ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í˜24 ë§¤ì¶œ ì—°ë™ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.
          </div>
        `}

        ${isExternal ? `
          <!-- íƒ€ì‚¬: ì…€ëŸ¬ ì •ì‚° -->
          <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #1d4ed8;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚° (${seller?.name || '-'})</h3>
            <table style="width: 100%; font-size: 13px;">
              <tr style="border-bottom: 1px solid #bfdbfe;">
                <td style="padding: 8px 0; color: #1d4ed8;">ì´ íŒë§¤ê¸ˆì•¡</td>
                <td style="padding: 8px 0; text-align: right; font-weight: 600;">${formatNumber(totalSales)}ì›</td>
              </tr>
              <tr style="border-bottom: 1px solid #bfdbfe;">
                <td style="padding: 8px 0; color: #1d4ed8;">ìƒí’ˆë³„ ë§ˆì§„ê¸ˆì•¡ í•©ê³„</td>
                <td style="padding: 8px 0; text-align: right;">${formatNumber(totalMarginAmount)}ì›</td>
              </tr>
              <tr style="border-bottom: 1px solid #bfdbfe;">
                <td style="padding: 8px 0; color: #dc2626;">ì›ì²œì„¸ (3.3%)</td>
                <td style="padding: 8px 0; text-align: right; color: #dc2626;">-${formatNumber(sellerTax)}ì›</td>
              </tr>
              <tr style="background: #dbeafe;">
                <td style="padding: 10px 0; font-weight: 700; color: #1d4ed8;">ì…€ëŸ¬ ì‹¤ì§€ê¸‰ì•¡</td>
                <td style="padding: 10px 0; text-align: right; font-weight: 700; font-size: 16px; color: #1d4ed8;">${formatNumber(sellerPayout)}ì›</td>
              </tr>
            </table>
          </div>

          <!-- íƒ€ì‚¬: ê³µê¸‰ì‚¬ ì •ì‚° -->
          <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #92400e;">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚° (${supplier?.name || '-'})</h3>
            <table style="width: 100%; font-size: 13px;">
              <tr style="border-bottom: 1px solid #fcd34d;">
                <td style="padding: 8px 0; color: #92400e;">ê³µê¸‰ê°€ì•¡ í•©ê³„</td>
                <td style="padding: 8px 0; text-align: right;">${formatNumber(totalSupplyAmount)}ì›</td>
              </tr>
              <tr style="border-bottom: 1px solid #fcd34d;">
                <td style="padding: 8px 0; color: #92400e;">ë¶€ê°€ì„¸ (10%)</td>
                <td style="padding: 8px 0; text-align: right;">+${formatNumber(supplierVat)}ì›</td>
              </tr>
              <tr style="background: #fef3c7;">
                <td style="padding: 10px 0; font-weight: 700; color: #92400e;">ê³µê¸‰ì‚¬ ì‹¤ì§€ê¸‰ì•¡</td>
                <td style="padding: 10px 0; text-align: right; font-weight: 700; font-size: 16px; color: #92400e;">${formatNumber(supplierPayout)}ì›</td>
              </tr>
            </table>
          </div>
        ` : `
          <!-- ìì‚¬: ì…€ëŸ¬ ì •ì‚°ë§Œ -->
          <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #1d4ed8;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚° (${seller?.name || '-'})</h3>
            <table style="width: 100%; font-size: 13px;">
              <tr style="border-bottom: 1px solid #bfdbfe;">
                <td style="padding: 8px 0; color: #1d4ed8;">ì´ íŒë§¤ê¸ˆì•¡</td>
                <td style="padding: 8px 0; text-align: right; font-weight: 600;">${formatNumber(totalSales)}ì›</td>
              </tr>
              <tr style="border-bottom: 1px solid #bfdbfe;">
                <td style="padding: 8px 0; color: #1d4ed8;">ìƒí’ˆë³„ ë§ˆì§„ê¸ˆì•¡ í•©ê³„</td>
                <td style="padding: 8px 0; text-align: right;">${formatNumber(totalMarginAmount)}ì›</td>
              </tr>
              <tr style="border-bottom: 1px solid #bfdbfe;">
                <td style="padding: 8px 0; color: #dc2626;">ì›ì²œì„¸ (3.3%)</td>
                <td style="padding: 8px 0; text-align: right; color: #dc2626;">-${formatNumber(sellerTax)}ì›</td>
              </tr>
              <tr style="background: #dbeafe;">
                <td style="padding: 10px 0; font-weight: 700; color: #1d4ed8;">ì…€ëŸ¬ ì‹¤ì§€ê¸‰ì•¡</td>
                <td style="padding: 10px 0; text-align: right; font-weight: 700; font-size: 16px; color: #1d4ed8;">${formatNumber(sellerPayout)}ì›</td>
              </tr>
            </table>
          </div>
        `}

        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button onclick="closeModal()" class="btn btn-secondary" style="padding: 10px 20px; cursor: pointer;">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  `;
}

// ========== ì¹´í˜24 ë§¤ì¶œ ì—°ë™ ==========

function openCafe24MappingModal() {
  // ì™„ë£Œ/ì§„í–‰ì™„ë£Œ ê³µêµ¬ ëª©ë¡ (ë§¤í•‘ ëŒ€ìƒ)
  const completedDeals = (state.deals || []).filter(d => {
    const status = d.status;
    return status === 'completed' || status === 'settled' || d.endDate && new Date(d.endDate) < new Date();
  }).sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
  
  const m = document.getElementById('modal');
  m.style.display = 'flex';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; margin: -24px -24px 0 -24px; padding: 16px 24px; border-radius: 12px 12px 0 0;">
        <h2 class="modal-title" style="color: white;">ğŸ“Š ì¹´í˜24 ë§¤ì¶œ ìë™ ë¶„ë¥˜ & ë§¤í•‘</h2>
        <button onclick="document.getElementById('modal').style.display='none'" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
      </div>
      
      <div style="flex: 1; overflow: auto; padding: 20px 0;">
        <!-- STEP 1: ì—‘ì…€ ì—…ë¡œë“œ -->
        <div style="margin-bottom: 24px;">
          <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">1</span>
            ì¹´í˜24 ì£¼ë¬¸ ì—‘ì…€ ì—…ë¡œë“œ
          </div>
          <div style="background: var(--gray-50); border: 2px dashed var(--gray-300); border-radius: 12px; padding: 24px; text-align: center;">
            <input type="file" id="cafe24ExcelFile" accept=".xlsx,.xls,.csv" onchange="parseCafe24Excel(this)" style="display: none;">
            <button onclick="document.getElementById('cafe24ExcelFile').click()" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ğŸ“¥ ì—‘ì…€ íŒŒì¼ ì„ íƒ
            </button>
            <p style="margin-top: 12px; font-size: 12px; color: var(--gray-500);">
              ì¹´í˜24 ê´€ë¦¬ì â†’ ì£¼ë¬¸ê´€ë¦¬ â†’ ì „ì²´ì£¼ë¬¸ì¡°íšŒ â†’ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ<br>
              <strong>"ìƒí’ˆëª…(ê´€ë¦¬ìš©)"</strong> ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ìë™ ë¶„ë¥˜ë©ë‹ˆë‹¤
            </p>
            <div id="cafe24UploadStatus" style="margin-top: 12px;"></div>
          </div>
        </div>
        
        <!-- STEP 2: ìë™ ë¶„ë¥˜ ê²°ê³¼ & ê³µêµ¬ ë§¤í•‘ -->
        <div id="cafe24GroupSection" style="display: none; margin-bottom: 24px;">
          <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">2</span>
            ìë™ ë¶„ë¥˜ ê²°ê³¼ â†’ ê³µêµ¬ ë§¤í•‘
          </div>
          <div id="cafe24GroupList" style="display: grid; gap: 12px;"></div>
        </div>
        
        <!-- STEP 3: ì •ì‚° ë¯¸ë¦¬ë³´ê¸° -->
        <div id="cafe24SettlementPreview" style="display: none; margin-bottom: 24px;">
          <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">3</span>
            ì •ì‚° ë¯¸ë¦¬ë³´ê¸°
          </div>
          <div id="cafe24SettlementContent"></div>
        </div>
      </div>
      
      <div style="border-top: 1px solid var(--gray-200); padding: 16px 0 0 0; display: flex; justify-content: space-between; align-items: center;">
        <div id="cafe24MappingStatus" style="font-size: 13px; color: var(--gray-500);"></div>
        <div style="display: flex; gap: 12px;">
          <button onclick="document.getElementById('modal').style.display='none'" style="padding: 10px 20px; background: var(--gray-100); color: var(--gray-700); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            ì·¨ì†Œ
          </button>
          <button id="cafe24MappingBtn" onclick="applyCafe24Mapping()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;" disabled>
            ì¼ê´„ ë§¤í•‘ ì ìš©
          </button>
        </div>
      </div>
    </div>
  `;
}

// ì¹´í˜24 ë°ì´í„° ì €ì¥ìš©
let cafe24UploadedData = [];
let cafe24GroupedData = {};

// ì¹´í˜24 ì—‘ì…€ íŒŒì‹± (ìë™ ë¶„ë¥˜) - ìƒí’ˆDB ë§¤ì¹­ + Firebase ì €ì¥
async function parseCafe24Excel(input) {
  const file = input.files[0];
  if (!file) return;

  const statusEl = document.getElementById('cafe24UploadStatus');
  statusEl.innerHTML = '<span style="color: var(--primary);">ğŸ“‚ íŒŒì¼ ë¶„ì„ ì¤‘...</span>';

  try {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    if (rows.length === 0) {
      statusEl.innerHTML = '<span style="color: var(--danger);">âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</span>';
      return;
    }

    console.log('ì²« í–‰:', rows[0]);

    // ê³µê¸‰ì‚¬ íƒ€ì… ë§¤í•‘ ìƒì„±
    const supplierTypeMap = {};
    (state.suppliers || []).forEach(s => {
      supplierTypeMap[s.name.trim().toLowerCase()] = s.supplierType || 'external';
    });

    // ë°ì´í„° íŒŒì‹± & ê·¸ë£¹í™” & Firebase ì €ì¥
    cafe24UploadedData = [];
    cafe24GroupedData = {};
    const orderMap = new Map();
    let uploadedCount = 0;

    statusEl.innerHTML = '<span style="color: var(--primary);">ğŸ’¾ Firebaseì— ì €ì¥ ì¤‘...</span>';

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];

      const orderId = row['ì£¼ë¬¸ë²ˆí˜¸'] || '';
      const productNo = row['ìƒí’ˆë²ˆí˜¸'] || (i + 1);
      if (!orderId) continue;

      const docId = `${orderId}_${productNo}`;
      if (orderMap.has(docId)) continue;

      // ë°ì´í„° ì¶”ì¶œ (ì—¬ëŸ¬ ê°€ëŠ¥í•œ ì»¬ëŸ¼ëª… ì§€ì›)
      const productCode = (row['ìì²´ìƒí’ˆì½”ë“œ'] || row['ìƒí’ˆì½”ë“œ'] || '').trim(); // ê³µêµ¬ìƒí’ˆDB ë§¤ì¹­ìš©
      const supplierName = (row['ê³µê¸‰ì‚¬'] || row['ê³µê¸‰ì‚¬ëª…'] || row['ê³µê¸‰ì—…ì²´'] || row['ê³µê¸‰ì²˜'] || row['ì—…ì²´ëª…'] || row['ê±°ë˜ì²˜'] || row['ë²¤ë”'] || '').trim();
      const rawSellerName = (row['ìƒí’ˆëª…(ê´€ë¦¬ìš©)'] || row['ê´€ë¦¬ìš© ìƒí’ˆëª…'] || '').trim();
      const sellerName = extractSellerName(rawSellerName);
      const productNameBasic = (row['ì£¼ë¬¸ìƒí’ˆëª…(ê¸°ë³¸)'] || row['ìƒí’ˆëª…(ê¸°ë³¸)'] || row['ìƒí’ˆëª…'] || '').trim();
      const productOption = (row['ì£¼ë¬¸ìƒí’ˆëª…(ì˜µì…˜í¬í•¨)'] || row['ìƒí’ˆëª…(ì˜µì…˜í¬í•¨)'] || row['ì˜µì…˜ì •ë³´'] || '').trim();
      const quantity = parseInt(row['ìˆ˜ëŸ‰'] || row['ì£¼ë¬¸ìˆ˜ëŸ‰'] || row['ìƒí’ˆìˆ˜ëŸ‰']) || 1;
      const unitPrice = parseCafe24Amount(row['íŒë§¤ê°€'] || row['ìƒí’ˆê°€ê²©'] || row['ìƒí’ˆê¸ˆì•¡'] || 0);
      // ì´ì£¼ë¬¸ê¸ˆì•¡: ì¹´í˜24 ì‹¤ì œ ì»¬ëŸ¼ëª… í¬í•¨ (KRW í‘œê¸° ë“±)
      const totalAmount = parseCafe24Amount(
        row['ì´ ì£¼ë¬¸ê¸ˆì•¡(KRW)'] || row['ì´ ê²°ì œê¸ˆì•¡(KRW)'] ||  // ì¹´í˜24 ì‹¤ì œ ì»¬ëŸ¼ëª…
        row['ì´ì£¼ë¬¸ê¸ˆì•¡'] || row['ì´ ê²°ì œê¸ˆì•¡'] || row['ê²°ì œê¸ˆì•¡'] ||
        row['ìƒí’ˆí•©ê³„'] || row['ìƒí’ˆë³„ ì£¼ë¬¸ê¸ˆì•¡'] || row['ì£¼ë¬¸ê¸ˆì•¡'] ||
        row['ì‹¤ê²°ì œê¸ˆì•¡'] || row['ì´ê¸ˆì•¡'] || 0
      );
      const paymentMethod = row['ê²°ì œìˆ˜ë‹¨'] || row['ê²°ì œë°©ë²•'] || '';

      // ğŸ¯ ìì²´ìƒí’ˆì½”ë“œë¡œ ìƒí’ˆDBì—ì„œ ê³µê¸‰ë‹¨ê°€/ë§ˆì§„ìœ¨ ë§¤ì¹­
      let matchedProduct = null;
      if (productCode) {
        matchedProduct = (state.products || []).find(p =>
          (p.productName || '').includes(productCode) ||
          productCode.includes(p.productName || '') ||
          (p.productCode || '') === productCode
        );
      }
      // ìƒí’ˆëª…ìœ¼ë¡œë„ ë§¤ì¹­ ì‹œë„
      if (!matchedProduct && productOption) {
        matchedProduct = (state.products || []).find(p =>
          productOption.toLowerCase().includes((p.productName || '').toLowerCase()) ||
          (p.productName || '').toLowerCase().includes(productOption.toLowerCase())
        );
      }

      const matchedSupplyPrice = matchedProduct?.supplyPrice || 0;
      const matchedMarginRate = matchedProduct?.marginRate || 0;

      // ë””ë²„ê¹…: ì²« ë²ˆì§¸ í–‰ì—ì„œ ê¸ˆì•¡ ê´€ë ¨ ì»¬ëŸ¼ í™•ì¸
      if (i === 0) {
        console.log('ê¸ˆì•¡ ì»¬ëŸ¼ í™•ì¸:', {
          totalAmount,
          quantity,
          unitPrice,
          productCode,
          matchedProduct: matchedProduct?.productName,
          'ê°€ëŠ¥í•œ ê¸ˆì•¡ ì»¬ëŸ¼ë“¤': Object.keys(row).filter(k => k.includes('ê¸ˆì•¡') || k.includes('ê²°ì œ') || k.includes('í•©ê³„'))
        });
      }

      // ìì‚¬/íƒ€ì‚¬ êµ¬ë¶„
      const supplierKey = supplierName.toLowerCase();
      const productType = supplierTypeMap[supplierKey] === 'inhouse' ? 'inhouse' : 'external';

      // PGìˆ˜ìˆ˜ë£Œ
      const isCard = paymentMethod.includes('ì¹´ë“œ') || paymentMethod.includes('ì‹ ìš©');
      const pgFee = isCard ? Math.round(totalAmount * 0.04) : 0;

      // ì£¼ë¬¸ ë‚ ì§œ ì¶”ì¶œ
      let orderDate = '';
      if (orderId.length >= 8) {
        const dateStr = orderId.substring(0, 8);
        if (/^\d{8}$/.test(dateStr)) {
          orderDate = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}T00:00:00`;
        }
      }

      // Firebase ì €ì¥ìš© ë°ì´í„°
      const orderData = {
        order_id: orderId,
        product_no: String(productNo),
        order_date: orderDate,
        product_code: productCode, // ìì²´ìƒí’ˆì½”ë“œ
        supplier_name: supplierName,
        seller_name: sellerName,
        seller_full_name: rawSellerName,
        product_type: productType,
        product_name: productNameBasic,
        product_option: productOption,
        quantity: quantity,
        unit_price: unitPrice,
        total_amount: totalAmount,
        supply_price: matchedSupplyPrice, // ìƒí’ˆDBì—ì„œ ë§¤ì¹­ëœ ê³µê¸‰ë‹¨ê°€
        margin_rate: matchedMarginRate, // ìƒí’ˆDBì—ì„œ ë§¤ì¹­ëœ ë§ˆì§„ìœ¨
        payment_status: totalAmount > 0 ? 'F' : 'T',
        payment_method: paymentMethod,
        pg_fee: pgFee,
        buyer_name: row['ìˆ˜ë ¹ì¸'] || '',
        buyer_phone: row['ìˆ˜ë ¹ì¸ íœ´ëŒ€ì „í™”'] || '',
        shipping_address: row['ìˆ˜ë ¹ì¸ ì£¼ì†Œ(ì „ì²´)'] || '',
        synced_at: new Date().toISOString()
      };

      // Firebaseì— ì €ì¥
      try {
        await db.collection('cafe24_orders').doc(docId).set(orderData, { merge: true });
        uploadedCount++;
      } catch (err) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', docId, err);
      }

      // ğŸ¯ ì…€ëŸ¬ëª…ê³¼ ìƒí’ˆëª…ìœ¼ë¡œ ì¢…ë£Œëœ ê³µêµ¬ ì°¾ê¸°
      let matchedDeal = null;

      if (sellerName && productOption) {
        // ì¢…ë£Œëœ ê³µêµ¬ë§Œ í•„í„°ë§
        const completedDeals = (state.deals || []).filter(d => {
          const isCompleted = d.status === 'completed' ||
                            d.status === 'settled' ||
                            (d.endDate && new Date(d.endDate) < new Date());
          return isCompleted;
        });

        // ì…€ëŸ¬ëª…ìœ¼ë¡œ ë¨¼ì € í•„í„°ë§
        const sellerDeals = completedDeals.filter(d => {
          const dealSeller = state.sellers.find(s => s.id === d.sellerId);
          const dealSellerName = dealSeller?.nickname || dealSeller?.name || '';
          return dealSellerName.toLowerCase().includes(sellerName.toLowerCase()) ||
                 sellerName.toLowerCase().includes(dealSellerName.toLowerCase());
        });

        // ìƒí’ˆëª… ìœ ì‚¬ë„ë¡œ ë§¤ì¹­
        for (const deal of sellerDeals) {
          const dealName = (deal.name || '').toLowerCase();
          const optionLower = productOption.toLowerCase();

          // "ìµœì €ê°€" ë“± ì œê±°í•˜ê³  ë¹„êµ
          const cleanOption = optionLower.replace(/ìµœì €ê°€|íŠ¹ê°€|í• ì¸/g, '').trim();
          const cleanDealName = dealName.replace(/ìµœì €ê°€|íŠ¹ê°€|í• ì¸/g, '').trim();

          if (cleanOption.includes(cleanDealName) || cleanDealName.includes(cleanOption)) {
            matchedDeal = deal;
            console.log(`âœ… ê³µêµ¬ ë§¤ì¹­ ì„±ê³µ: ${sellerName} / ${productOption} â†’ ${deal.name}`);
            break;
          }
        }

        // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ê°€ì¥ ìµœê·¼ ì¢…ë£Œëœ ê³µêµ¬ ìë™ ì„ íƒ (ê°™ì€ ì…€ëŸ¬)
        if (!matchedDeal && sellerDeals.length > 0) {
          sellerDeals.sort((a, b) => new Date(b.endDate || 0) - new Date(a.endDate || 0));
          matchedDeal = sellerDeals[0];
          console.log(`âš ï¸ ìë™ ë§¤ì¹­ (ìµœê·¼ ê³µêµ¬): ${sellerName} â†’ ${matchedDeal.name}`);
        }
      }

      // ê·¸ë£¹í™” (ìì²´ìƒí’ˆì½”ë“œ ë˜ëŠ” ì£¼ë¬¸ìƒí’ˆëª… ê¸°ì¤€)
      const groupKey = productCode || productOption || productNameBasic;
      if (!cafe24GroupedData[groupKey]) {
        cafe24GroupedData[groupKey] = {
          productCode: productCode, // ìì²´ìƒí’ˆì½”ë“œ
          productName: groupKey,
          productBasicName: productNameBasic,
          productOption: productOption,
          supplier: supplierName,
          sellerName: sellerName,
          supplyPrice: matchedSupplyPrice, // ìƒí’ˆDB ë§¤ì¹­ ê³µê¸‰ë‹¨ê°€
          marginRate: matchedMarginRate, // ìƒí’ˆDB ë§¤ì¹­ ë§ˆì§„ìœ¨
          orders: [],
          totalQty: 0,
          totalSales: 0,
          mappedDealId: matchedDeal?.id || null,
          matchedDealName: matchedDeal?.name || null,
          autoMatched: !!matchedDeal,
          confirmed: false  // í™•ì • ì—¬ë¶€
        };
      }

      cafe24GroupedData[groupKey].orders.push({ orderId, qty: quantity, price: totalAmount, unitPrice });
      cafe24GroupedData[groupKey].totalQty += quantity;
      cafe24GroupedData[groupKey].totalSales += totalAmount;
      // ê³µê¸‰ë‹¨ê°€/ë§ˆì§„ìœ¨ì´ ì•„ì§ ì—†ìœ¼ë©´ ì—…ë°ì´íŠ¸
      if (!cafe24GroupedData[groupKey].supplyPrice && matchedSupplyPrice) {
        cafe24GroupedData[groupKey].supplyPrice = matchedSupplyPrice;
      }
      if (!cafe24GroupedData[groupKey].marginRate && matchedMarginRate) {
        cafe24GroupedData[groupKey].marginRate = matchedMarginRate;
      }

      orderMap.set(docId, orderData);
    }

    const groupCount = Object.keys(cafe24GroupedData).length;
    const autoMatchedCount = Object.values(cafe24GroupedData).filter(g => g.autoMatched).length;
    const totalOrders = Object.values(cafe24GroupedData).reduce((sum, g) => sum + g.orders.length, 0);
    const totalSales = Object.values(cafe24GroupedData).reduce((sum, g) => sum + g.totalSales, 0);

    statusEl.innerHTML = `
      <div style="background: #dcfce7; padding: 12px; border-radius: 8px; text-align: left;">
        <div style="font-weight: 600; color: var(--success); margin-bottom: 8px;">âœ… ì—…ë¡œë“œ ë° ìë™ ë§¤ì¹­ ì™„ë£Œ</div>
        <div style="font-size: 12px; color: var(--gray-600);">
          â€¢ Firebase ì €ì¥: <strong>${uploadedCount}ê±´</strong><br>
          â€¢ ê·¸ë£¹ ë¶„ë¥˜: <strong>${groupCount}ê°œ</strong><br>
          â€¢ ìë™ ë§¤ì¹­: <strong style="color: #059669;">${autoMatchedCount}ê°œ</strong> / ${groupCount}ê°œ<br>
          â€¢ ì´ ë§¤ì¶œ: <strong>${formatNumber(totalSales)}ì›</strong>
        </div>
      </div>
    `;

    // ê·¸ë£¹ ëª©ë¡ í‘œì‹œ
    renderCafe24Groups();

  } catch (e) {
    console.error('Excel parse error:', e);
    statusEl.innerHTML = '<span style="color: var(--danger);">âŒ íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message + '</span>';
  }
}

// ê·¸ë£¹ ëª©ë¡ ë Œë”ë§
function renderCafe24Groups() {
  const groupSection = document.getElementById('cafe24GroupSection');
  const groupList = document.getElementById('cafe24GroupList');

  if (Object.keys(cafe24GroupedData).length === 0) {
    groupSection.style.display = 'none';
    return;
  }

  groupSection.style.display = 'block';

  // ì™„ë£Œëœ ê³µêµ¬ ëª©ë¡
  const completedDeals = (state.deals || []).filter(d => {
    const status = d.status;
    return status === 'completed' || status === 'settled' || d.endDate && new Date(d.endDate) < new Date();
  }).sort((a, b) => new Date(b.endDate) - new Date(a.endDate));

  const groups = Object.entries(cafe24GroupedData);

  groupList.innerHTML = groups.map(([key, group], idx) => {
    const autoMatched = group.autoMatched;
    const confirmed = group.confirmed || false;
    const borderColor = confirmed ? '#3b82f6' : (autoMatched ? '#059669' : '#e5e7eb');
    const bgColor = confirmed ? '#eff6ff' : (autoMatched ? '#f0fdf4' : 'white');

    // ì„ íƒëœ ê³µêµ¬ì˜ ìƒí’ˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    let dealProductOptions = '';
    if (group.mappedDealId) {
      const selectedDeal = state.deals.find(d => d.id === group.mappedDealId);
      const dealProducts = selectedDeal?.selectedProducts || [];

      if (dealProducts.length > 0) {
        // ìƒí’ˆëª… ìœ ì‚¬ë„ ìë™ ë§¤ì¹­
        const getSimilarity = (str1, str2) => {
          const s1 = (str1 || '').toLowerCase().replace(/[^ê°€-í£a-z0-9]/g, '');
          const s2 = (str2 || '').toLowerCase().replace(/[^ê°€-í£a-z0-9]/g, '');
          if (s1 === s2) return 1;
          if (s1.includes(s2) || s2.includes(s1)) return 0.8;
          const words1 = s1.split(/\s+/);
          let matches = 0;
          words1.forEach(w => { if (s2.includes(w) && w.length > 1) matches++; });
          return matches / Math.max(words1.length, 1);
        };

        // ìë™ ë§¤ì¹­ (ì•„ì§ ì„ íƒ ì•ˆëœ ê²½ìš°)
        if (!group.matchedProductSku) {
          let bestMatch = null;
          let bestScore = 0;
          dealProducts.forEach(dp => {
            const score = getSimilarity(group.productName, dp.productName || dp.sku);
            if (score > bestScore && score >= 0.3) {
              bestScore = score;
              bestMatch = dp;
            }
          });
          if (bestMatch) {
            group.matchedProductSku = bestMatch.sku;
            group.matchedProductName = bestMatch.productName;
            group.supplyPrice = bestMatch.supplyPrice || 0;
            group.marginRate = bestMatch.marginRate || 0;
          }
        }

        dealProductOptions = dealProducts.map(dp => {
          const isSelected = dp.sku === group.matchedProductSku;
          return `<option value="${dp.sku}" data-supply="${dp.supplyPrice || 0}" data-margin="${dp.marginRate || 0}" ${isSelected ? 'selected' : ''}>
            ${dp.productName || dp.sku} (${(dp.supplyPrice || 0).toLocaleString()}ì›)
          </option>`;
        }).join('');
      }
    }

    return `
      <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 12px; padding: 16px;" data-group-key="${key}">
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                ${confirmed ? '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">âœ“ í™•ì •</span>' : ''}
                ${autoMatched && !confirmed ? '<span style="background: #059669; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">âœ“ ìë™ë§¤ì¹­</span>' : ''}
                ${!autoMatched && !confirmed ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">âš  ìˆ˜ë™ì„ íƒ</span>' : ''}
                <span style="font-weight: 600; color: var(--gray-800); max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${group.productName}">${group.productName}</span>
              </div>
              <div style="font-size: 12px; color: var(--gray-500);">
                ì…€ëŸ¬: <strong>${group.sellerName || '-'}</strong> |
                ê³µê¸‰ì‚¬: ${group.supplier || '-'} |
                <span style="color: var(--primary); font-weight: 600;">${group.orders.length}ê±´</span> /
                <span style="color: var(--success); font-weight: 600;">${formatNumber(group.totalSales)}ì›</span>
              </div>
            </div>
            <div>
              ${!confirmed && group.mappedDealId && group.matchedProductSku ? `
                <button onclick="confirmGroupMapping('${key}')" class="btn btn-sm btn-primary" style="padding: 8px 16px;">
                  âœ“ í™•ì •
                </button>
              ` : ''}
              ${confirmed ? `
                <button onclick="unconfirmGroupMapping('${key}')" class="btn btn-sm btn-secondary" style="padding: 8px 16px;">
                  â†© ì·¨ì†Œ
                </button>
              ` : ''}
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
            <span style="font-size: 12px; color: var(--gray-500); min-width: 60px;">â†’ ê³µêµ¬:</span>
            <select onchange="updateGroupMapping('${key}', this.value)" style="padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 12px; min-width: 200px; ${autoMatched ? 'border-color: #059669;' : ''}" ${confirmed ? 'disabled' : ''}>
              <option value="">-- ê³µêµ¬ ì„ íƒ --</option>
              ${completedDeals.map(d => {
                const seller = state.sellers.find(s => s.id === d.sellerId);
                const isSelected = d.id === group.mappedDealId;
                const isMapped = d.cafe24Mapped;
                const shouldDisable = isMapped && !isSelected;
                return `<option value="${d.id}" ${isSelected ? 'selected' : ''} ${shouldDisable ? 'disabled' : ''}>
                  ${d.name || d.title || d.brandName || '-'} (${seller?.name || '-'}) ${isMapped ? 'âœ…' : ''}
                </option>`;
              }).join('')}
            </select>
            ${group.mappedDealId && dealProductOptions ? `
              <span style="font-size: 12px; color: var(--gray-500);">â†’ ìƒí’ˆ:</span>
              <select onchange="updateProductMapping('${key}', this)" style="padding: 6px 10px; border: 2px solid ${group.matchedProductSku ? '#22c55e' : '#f59e0b'}; border-radius: 6px; font-size: 12px; min-width: 280px; background: ${group.matchedProductSku ? '#f0fdf4' : '#fefce8'};" ${confirmed ? 'disabled' : ''}>
                <option value="">-- ìƒí’ˆ ì„ íƒ --</option>
                ${dealProductOptions}
              </select>
              ${group.matchedProductSku ? '<span style="color: #16a34a; font-size: 11px;">âœ“</span>' : '<span style="color: #f59e0b; font-size: 11px;">ì„ íƒí•„ìš”</span>'}
            ` : ''}
            ${group.mappedDealId && !dealProductOptions ? '<span style="font-size: 11px; color: #dc2626;">âš  ê³µêµ¬ì— ë“±ë¡ëœ ìƒí’ˆ ì—†ìŒ</span>' : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');

  updateMappingStatus();
  updateSettlementPreview();
}

// ê·¸ë£¹ ë§¤í•‘ ì—…ë°ì´íŠ¸ (ê³µêµ¬ ì„ íƒ)
function updateGroupMapping(groupKey, dealId) {
  if (cafe24GroupedData[groupKey]) {
    cafe24GroupedData[groupKey].mappedDealId = dealId || null;

    // ê³µêµ¬ ë³€ê²½ ì‹œ ìƒí’ˆ ë§¤ì¹­ ì´ˆê¸°í™”
    cafe24GroupedData[groupKey].matchedProductSku = null;
    cafe24GroupedData[groupKey].matchedProductName = null;

    // ë§¤ì¹­ëœ ê³µêµ¬ëª…ë„ ì €ì¥
    if (dealId) {
      const deal = state.deals.find(d => d.id === dealId);
      cafe24GroupedData[groupKey].matchedDealName = deal?.name || null;
    } else {
      cafe24GroupedData[groupKey].matchedDealName = null;
      cafe24GroupedData[groupKey].supplyPrice = 0;
      cafe24GroupedData[groupKey].marginRate = 0;
    }
  }
  // UI ë‹¤ì‹œ ë Œë”ë§
  renderCafe24Groups();
}

// ìƒí’ˆ ë§¤í•‘ ì—…ë°ì´íŠ¸
function updateProductMapping(groupKey, selectEl) {
  if (!cafe24GroupedData[groupKey]) return;

  const selectedOption = selectEl.options[selectEl.selectedIndex];
  const sku = selectedOption?.value || '';

  cafe24GroupedData[groupKey].matchedProductSku = sku || null;

  if (sku && selectedOption) {
    cafe24GroupedData[groupKey].matchedProductName = selectedOption.textContent.trim();
    cafe24GroupedData[groupKey].supplyPrice = Number(selectedOption.dataset.supply) || 0;
    cafe24GroupedData[groupKey].marginRate = Number(selectedOption.dataset.margin) || 0;
  } else {
    cafe24GroupedData[groupKey].matchedProductName = null;
    cafe24GroupedData[groupKey].supplyPrice = 0;
    cafe24GroupedData[groupKey].marginRate = 0;
  }

  // UI ë‹¤ì‹œ ë Œë”ë§
  renderCafe24Groups();
}

// ê·¸ë£¹ ë§¤í•‘ í™•ì •
function confirmGroupMapping(groupKey) {
  if (!cafe24GroupedData[groupKey]) return;

  const group = cafe24GroupedData[groupKey];
  if (!group.mappedDealId) {
    alert('ë¨¼ì € ê³µêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  if (!group.matchedProductSku) {
    alert('ë¨¼ì € ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  // í™•ì • í‘œì‹œ
  group.confirmed = true;

  showToast('âœ… ë§¤ì¹­ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
  renderCafe24Groups();
}

// ê·¸ë£¹ ë§¤í•‘ í™•ì • ì·¨ì†Œ
function unconfirmGroupMapping(groupKey) {
  if (!cafe24GroupedData[groupKey]) return;

  cafe24GroupedData[groupKey].confirmed = false;

  showToast('â†© í™•ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
  renderCafe24Groups();
}

// ë§¤í•‘ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateMappingStatus() {
  const statusEl = document.getElementById('cafe24MappingStatus');
  const btn = document.getElementById('cafe24MappingBtn');

  const groups = Object.values(cafe24GroupedData);
  const totalCount = groups.length;
  const mappedCount = groups.filter(g => g.mappedDealId).length;
  const confirmedCount = groups.filter(g => g.confirmed).length;

  statusEl.innerHTML = `
    <span>ë§¤í•‘: <strong>${mappedCount}</strong> / ${totalCount}</span>
    <span style="margin-left: 12px; color: #3b82f6;">í™•ì •: <strong>${confirmedCount}</strong> / ${mappedCount}</span>
  `;
  btn.disabled = confirmedCount === 0;
  btn.textContent = confirmedCount > 0 ? `âœ“ ${confirmedCount}ê°œ ì •ì‚°ì„œ ìƒì„±` : 'ì •ì‚°ì„œ ìƒì„±';
}

// ì •ì‚° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updateSettlementPreview() {
  const previewSection = document.getElementById('cafe24SettlementPreview');
  const previewContent = document.getElementById('cafe24SettlementContent');
  
  const mappedGroups = Object.values(cafe24GroupedData).filter(g => g.mappedDealId);
  
  if (mappedGroups.length === 0) {
    previewSection.style.display = 'none';
    return;
  }
  
  previewSection.style.display = 'block';
  
  // ê³µêµ¬ë³„ë¡œ ê·¸ë£¹í™”
  const dealSettlements = {};
  
  mappedGroups.forEach(group => {
    const dealId = group.mappedDealId;
    if (!dealSettlements[dealId]) {
      dealSettlements[dealId] = {
        deal: state.deals.find(d => d.id === dealId),
        totalSales: 0,
        totalQty: 0,
        orderCount: 0
      };
    }
    dealSettlements[dealId].totalSales += group.totalSales;
    dealSettlements[dealId].totalQty += group.totalQty;
    dealSettlements[dealId].orderCount += group.orders.length;
  });
  
  previewContent.innerHTML = `
    <div style="display: grid; gap: 12px;">
      ${Object.values(dealSettlements).map(ds => {
        const deal = ds.deal;
        if (!deal) return '';
        
        const seller = state.sellers.find(s => s.id === deal.sellerId);
        const sellerMarginRate = deal.sellerMarginRate || 10;
        const dealProducts = deal.selectedProducts || [];
        const supplyPrice = dealProducts.length > 0
          ? (dealProducts[0].supplyPrice || deal.supplyPrice || 0)
          : (deal.supplyPrice || 0);

        const pgFee = Math.round(ds.totalSales * 0.04);
        const sellerMargin = Math.round(ds.totalSales * sellerMarginRate / 100);
        const sellerTax = Math.round(sellerMargin * 0.033);
        const sellerNet = sellerMargin - sellerTax;
        const supplierTotal = supplyPrice * ds.totalQty;
        const moyeoraProfit = ds.totalSales - pgFee - sellerNet - supplierTotal;
        
        return `
          <div style="background: var(--gray-50); border-radius: 12px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div>
                <div style="font-weight: 600; color: var(--gray-800);">${deal.title || deal.brandName}</div>
                <div style="font-size: 12px; color: var(--gray-500);">ì…€ëŸ¬: ${seller?.name || '-'} | ${ds.orderCount}ê±´ / ${ds.totalQty}ê°œ</div>
              </div>
              <div style="font-size: 18px; font-weight: 700; color: var(--success);">${formatNumber(ds.totalSales)}ì›</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 11px;">
              <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                <div style="color: var(--gray-500);">PGìˆ˜ìˆ˜ë£Œ(4%)</div>
                <div style="font-weight: 600; color: var(--danger);">-${formatNumber(pgFee)}ì›</div>
              </div>
              <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                <div style="color: var(--gray-500);">ì…€ëŸ¬ì •ì‚°(${sellerMarginRate}%)</div>
                <div style="font-weight: 600; color: #8b5cf6;">${formatNumber(sellerNet)}ì›</div>
              </div>
              <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                <div style="color: var(--gray-500);">ê³µê¸‰ì‚¬ì •ì‚°</div>
                <div style="font-weight: 600; color: #f59e0b;">${formatNumber(supplierTotal)}ì›</div>
              </div>
              <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                <div style="color: var(--gray-500);">ëª¨ì—¬ë¼ë”œ ìˆ˜ìµ</div>
                <div style="font-weight: 600; color: ${moyeoraProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatNumber(moyeoraProfit)}ì›</div>
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// ì¹´í˜24 ë§¤í•‘ ì¼ê´„ ì ìš© + ì •ì‚°ì„œ ìë™ ìƒì„±
async function applyCafe24Mapping() {
  // í™•ì •ëœ ê·¸ë£¹ë§Œ í•„í„°ë§
  const confirmedGroups = Object.values(cafe24GroupedData).filter(g => g.confirmed && g.mappedDealId);
  const unconfirmedGroups = Object.values(cafe24GroupedData).filter(g => !g.confirmed && g.mappedDealId);

  if (confirmedGroups.length === 0) {
    if (unconfirmedGroups.length > 0) {
      showToast(`âš ï¸ ë¨¼ì € ë§¤ì¹­ì„ í™•ì •í•´ì£¼ì„¸ìš” (${unconfirmedGroups.length}ê°œ ë¯¸í™•ì •)`);
    } else {
      showToast('í™•ì •ëœ ë§¤ì¹­ì´ ì—†ìŠµë‹ˆë‹¤');
    }
    return;
  }

  if (!confirm(`âœ… í™•ì •ëœ ${confirmedGroups.length}ê°œ ê·¸ë£¹ì˜ ì •ì‚°ì„œë¥¼ ìë™ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?${unconfirmedGroups.length > 0 ? `\n\nâš ï¸ ${unconfirmedGroups.length}ê°œ ë¯¸í™•ì • ê·¸ë£¹ì€ ì œì™¸ë©ë‹ˆë‹¤.` : ''}`)) return;

  const mappedGroups = confirmedGroups;

  // ê³µêµ¬ë³„ë¡œ ì§‘ê³„ (ìƒí’ˆì •ë³´ í¬í•¨)
  const dealUpdates = {};

  mappedGroups.forEach(group => {
    const dealId = group.mappedDealId;
    if (!dealUpdates[dealId]) {
      dealUpdates[dealId] = {
        totalSales: 0,
        totalQty: 0,
        orderCount: 0,
        sellerName: group.sellerName,
        supplier: group.supplier,
        products: []  // ìƒí’ˆë³„ ì •ë³´ ì €ì¥
      };
    }
    dealUpdates[dealId].totalSales += group.totalSales;
    dealUpdates[dealId].totalQty += group.totalQty;
    dealUpdates[dealId].orderCount += group.orders.length;

    // ìƒí’ˆë³„ ì •ë³´ ì¶”ê°€
    dealUpdates[dealId].products.push({
      productName: group.productName,
      quantity: group.totalQty,
      amount: group.totalSales
    });
  });

  try {
    showToast('ğŸ“‹ ì •ì‚°ì„œ ìë™ ìƒì„± ì¤‘...');

    // ê° ê³µêµ¬ë³„ë¡œ Firebase ì—…ë°ì´íŠ¸ + ì •ì‚°ì„œ ìƒì„±
    for (const [dealId, data] of Object.entries(dealUpdates)) {
      const deal = state.deals.find(d => d.id === dealId);
      if (!deal) continue;

      const seller = state.sellers.find(s => s.id === deal.sellerId);
      const supplier = state.suppliers.find(s => s.id === deal.supplierId);

      // ê³µê¸‰ë‹¨ê°€: selectedProductsì—ì„œ ë¨¼ì € ì°¾ê³ , ì—†ìœ¼ë©´ deal.supplyPrice ì‚¬ìš©
      const dealProducts = deal.selectedProducts || [];
      const supplyPrice = dealProducts.length > 0
        ? (dealProducts[0].supplyPrice || deal.supplyPrice || 0)
        : (deal.supplyPrice || 0);

      const sellerMarginRate = deal.sellerMarginRate || seller?.defaultMarginRate || 10;

      const pgFee = Math.round(data.totalSales * 0.04);
      const sellerMargin = Math.round(data.totalSales * sellerMarginRate / 100);
      const sellerTax = Math.round(sellerMargin * 0.033);
      const sellerNet = sellerMargin - sellerTax;
      const supplierTotal = supplyPrice * data.totalQty;
      const moyeoraProfit = data.totalSales - pgFee - sellerNet - supplierTotal;

      // ê³µêµ¬ ì—…ë°ì´íŠ¸
      await db.collection('deals').doc(dealId).update({
        cafe24Mapped: true,
        cafe24MappedAt: new Date().toISOString(),
        totalSales: data.totalSales,
        totalQty: data.totalQty,
        orderCount: data.orderCount,
        pgFee: pgFee,
        sellerSettlementAmount: sellerNet,
        supplierSettlementAmount: supplierTotal,
        moyeoraProfit: moyeoraProfit,
        status: 'completed'
      });

      // ğŸ¯ ì •ì‚°ì„œ ìë™ ìƒì„±
      const today = new Date().toISOString().split('T')[0];
      const productType = supplier?.supplierType || 'external';

      // 1. ì…€ëŸ¬ ì •ì‚°ì„œ ìƒì„± (ìƒí’ˆë³„ ì •ë³´ í¬í•¨)
      const sellerSettlementId = `${dealId}_seller`;

      // ìƒí’ˆë³„ ë§ˆì§„ ê³„ì‚° (ê³µê¸‰ë‹¨ê°€ í¬í•¨)
      const salesItems = (data.products || []).map(p => {
        const itemMargin = Math.round((p.amount || 0) * sellerMarginRate / 100);
        const itemTax = Math.round(itemMargin * 0.033);
        const itemUnitPrice = p.quantity > 0 ? Math.round((p.amount || 0) / p.quantity) : 0;
        return {
          productName: p.productName || '-',
          quantity: p.quantity || 0,
          unitPrice: itemUnitPrice,
          supplyPrice: supplyPrice,  // ê³µê¸‰ë‹¨ê°€ ì¶”ê°€
          amount: p.amount || 0,
          marginRate: sellerMarginRate,
          marginAmount: itemMargin,
          withholdingTax: itemTax,
          actualPayment: itemMargin - itemTax
        };
      });

      const sellerSettlementData = {
        id: sellerSettlementId,
        dealId: dealId,
        dealPeriod: `${deal.startDate || ''} ~ ${deal.endDate || ''}`,
        sellerName: seller?.name || data.sellerName || '-',
        brandName: deal.brandName || supplier?.name || data.supplier || '-',
        productType: productType,
        totalQuantity: data.totalQty,
        salesAmount: data.totalSales,
        supplyPrice: supplyPrice,  // ê³µê¸‰ë‹¨ê°€ ì¶”ê°€ (ì •ì‚°ì„œ ë ˆë²¨)
        marginRate: sellerMarginRate,
        marginAmount: sellerMargin,
        withholdingTax: sellerTax,
        actualPayment: sellerNet,
        salesItems: salesItems,  // ìƒí’ˆë³„ ì •ë³´ ì¶”ê°€
        settlementDate: today,
        isCompleted: false,
        isSellerCompleted: false,
        createdAt: new Date().toISOString(),
        createdBy: 'auto_cafe24_mapping'
      };

      await db.collection('sellerSettlements').doc(sellerSettlementId).set(sellerSettlementData, { merge: true });

      // 2. íƒ€ì‚¬ ìƒí’ˆì¸ ê²½ìš° ê³µê¸‰ì‚¬ ì •ì‚°ì„œë„ ìƒì„±
      if (productType === 'external' && supplier) {
        const supplierSettlementId = `${dealId}_supplier`;
        const totalSupplyAmount = Math.round(supplierTotal / 1.1); // ë¶€ê°€ì„¸ ì œì™¸
        const totalVatAmount = supplierTotal - totalSupplyAmount; // ë¶€ê°€ì„¸

        // ìƒí’ˆë³„ ê³µê¸‰ê°€ ì •ë³´
        const supplyItems = (data.products || []).map(p => {
          const itemSupply = supplyPrice * (p.quantity || 0);
          const itemVat = Math.round(itemSupply * 0.1);
          return {
            productName: p.productName || '-',
            quantity: p.quantity || 0,
            supplyPrice: supplyPrice,
            supplyAmount: itemSupply,
            vatAmount: itemVat,
            totalAmount: itemSupply + itemVat
          };
        });

        const supplierSettlementData = {
          id: supplierSettlementId,
          dealId: dealId,
          dealPeriod: `${deal.startDate || ''} ~ ${deal.endDate || ''}`,
          sellerName: seller?.name || data.sellerName || '-',
          brandName: supplier?.name || data.supplier || '-',
          supplierName: supplier?.name || data.supplier || '-',
          totalQuantity: data.totalQty,
          supplyPrice: supplyPrice,
          totalSupplyAmount: totalSupplyAmount,
          totalVatAmount: totalVatAmount,
          totalAmount: supplierTotal,
          supplyItems: supplyItems,  // ìƒí’ˆë³„ ì •ë³´ ì¶”ê°€
          settlementDate: today,
          isCompleted: false,
          createdAt: new Date().toISOString(),
          createdBy: 'auto_cafe24_mapping'
        };

        await db.collection('supplierSettlements').doc(supplierSettlementId).set(supplierSettlementData, { merge: true });
      }
    }

    const updateCount = Object.keys(dealUpdates).length;
    showToast(`âœ… ${updateCount}ê°œ ê³µêµ¬ ë§¤í•‘ ë° ì •ì‚°ì„œ ìƒì„± ì™„ë£Œ!`);
    document.getElementById('modal').style.display = 'none';
    cafe24UploadedData = [];
    cafe24GroupedData = {};

    // ì •ì‚°ê´€ë¦¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    renderSettlement();

  } catch (e) {
    console.error('Mapping error:', e);
    showToast('âŒ ë§¤í•‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
  }
}

// ========== ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ í•¨ìˆ˜ ==========

async function saveSellerListItem(data) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  try {
    if (data.id) {
      await db.collection('sellerList').doc(data.id).update(data);
    } else {
      delete data.id;
      await db.collection('sellerList').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteSellerListItem(id) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('sellerList').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function toggleSellerListField(id, field, value) {
  // ì œì•ˆ ì²´í¬ ì‹œ ì œì•ˆë‚´ìš© ì…ë ¥ ëª¨ë‹¬ ë„ìš°ê¸°
  if (field === 'proposed' && value === true) {
    showSellerProposalModal(id);
    return;
  }
  
  try {
    await db.collection('sellerList').doc(id).update({ 
      [field]: value,
      updatedAt: new Date().toISOString(),
      updatedBy: getCurrentUserId()
    });
    
    // ê³„ì•½ ì™„ë£Œ ì‹œ ì…€ëŸ¬ DB ë“±ë¡ í™•ì¸
    if (field === 'contracted' && value === true) {
      const seller = state.sellerList.find(s => s.id === id);
      if (seller) {
        showSellerContractConfirmModal(seller);
      }
    }
  } catch(e) {
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì…€ëŸ¬ ì œì•ˆ ë‚´ìš© ì…ë ¥ ëª¨ë‹¬
function showSellerProposalModal(sellerId) {
  const seller = state.sellerList.find(s => s.id === sellerId);
  if (!seller) return;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“ ì œì•ˆ ë‚´ìš© ì…ë ¥</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 20px;">
        <div style="background: #dcfce7; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <div style="font-weight: 600; color: #16a34a; margin-bottom: 4px;">${seller.accountName}</div>
          <div style="font-size: 13px; color: #15803d;">${seller.category || '-'} Â· ${seller.channel || '-'}</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œì•ˆ ë‚´ìš© <span style="color: var(--danger);">*</span></label>
          <textarea class="form-textarea" id="seller-proposal-content" rows="4" placeholder="ì˜ˆ: ì‹ ì œí’ˆ ì¶œì‹œ ê¸°ë… ê³µêµ¬ ì œì•ˆ, ìˆ˜ìˆ˜ë£Œ 20% ì¡°ê±´...">${seller.proposalContent || ''}</textarea>
          <small style="color: var(--gray-500); font-size: 11px;">ì–´ë–¤ ì œì•ˆì„ í–ˆëŠ”ì§€ ê¸°ë¡í•˜ì„¸ìš”</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œì•ˆ ì¼ì</label>
          <input type="date" class="form-input" id="seller-proposal-date" value="${seller.proposalDate || new Date().toISOString().split('T')[0]}">
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" style="background: #22c55e;" onclick="submitSellerProposal('${sellerId}')">âœ… ì œì•ˆ ì™„ë£Œ</button>
      </div>
    </div>
  `;
}

// ì…€ëŸ¬ ì œì•ˆ ì €ì¥
async function submitSellerProposal(sellerId) {
  const content = document.getElementById('seller-proposal-content').value.trim();
  const date = document.getElementById('seller-proposal-date').value;
  
  if (!content) {
    showToast('ì œì•ˆ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  try {
    await db.collection('sellerList').doc(sellerId).update({
      proposed: true,
      proposalContent: content,
      proposalDate: date,
      updatedAt: new Date().toISOString(),
      updatedBy: getCurrentUserId()
    });
    
    showToast('âœ… ì œì•ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì…€ëŸ¬ ê³„ì•½ ì™„ë£Œ ì‹œ ì…€ëŸ¬ DB ë“±ë¡ í™•ì¸ ëª¨ë‹¬
function showSellerContractConfirmModal(seller) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>ğŸ‰ ì…ì  ê³„ì•½ ì™„ë£Œ!</h3>
        <button class="close-btn" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 30px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸŠ</div>
        <h4 style="color: #7c3aed; margin-bottom: 8px;">${seller.accountName}</h4>
        <p style="color: var(--gray-600); margin-bottom: 24px;">ì…€ëŸ¬ì™€ ì…ì  ê³„ì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        
        <div style="background: #f5f3ff; border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: left;">
          <div style="font-weight: 600; color: #5b21b6; margin-bottom: 8px;">ğŸ“‹ ì…€ëŸ¬ ì •ë³´</div>
          <div style="font-size: 13px; color: var(--gray-600); line-height: 1.8;">
            <div>â€¢ ì¹´í…Œê³ ë¦¬: ${seller.category || '-'}</div>
            <div>â€¢ ì±„ë„: ${seller.channel || '-'}</div>
            <div>â€¢ íŒ”ë¡œì›Œ: ${seller.followers ? seller.followers + 'ë§Œ' : '-'}</div>
          </div>
        </div>
        
        <p style="font-size: 14px; color: var(--gray-700); margin-bottom: 20px;">
          <strong>ì…€ëŸ¬ DB</strong>ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
          <span style="font-size: 12px; color: var(--gray-500);">ë“±ë¡í•˜ë©´ íŒ€ì› ì‹¤ì ì˜ "ì…€ëŸ¬" ìˆ˜ì— ë°˜ì˜ë©ë‹ˆë‹¤.</span>
        </p>
        
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button class="btn btn-secondary" onclick="closeModal()">ë‚˜ì¤‘ì—</button>
          <button class="btn btn-primary" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);" onclick="registerSellerFromList('${seller.id}')">
            ì…€ëŸ¬ DBì— ë“±ë¡
          </button>
        </div>
      </div>
    </div>
  `;
}

// ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì…€ëŸ¬ DBë¡œ ë“±ë¡
async function registerSellerFromList(sellerListId) {
  const seller = state.sellerList.find(s => s.id === sellerListId);
  if (!seller) {
    showToast('ì…€ëŸ¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  try {
    // ì…€ëŸ¬ DBì— ì¶”ê°€
    const newSeller = {
      name: seller.accountName,
      category: seller.category || '',
      channel: seller.channel || '',
      channelId: seller.accountLink || '',
      followers: seller.followers ? (seller.followers * 10000) : 0, // ë§Œ ë‹¨ìœ„ë¥¼ ì‹¤ì œ ìˆ«ìë¡œ
      registeredBy: state.currentUser?.id || '',
      createdAt: new Date().toISOString(),
      createdBy: getCurrentUserId(),
      sourceSellerListId: sellerListId, // ì›ë³¸ ì…€ëŸ¬ë¦¬ìŠ¤íŠ¸ ID ì—°ê²°
      status: 'ì…ì ì™„ë£Œ'
    };
    
    await db.collection('sellers').add(newSeller);
    
    // ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ ì™„ë£Œ í‘œì‹œ
    await db.collection('sellerList').doc(sellerListId).update({
      registeredToSellerDB: true,
      registeredToSellerDBAt: new Date().toISOString()
    });
    
    showToast('ğŸ‰ ì…€ëŸ¬ DBì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function openSellerListModal(item = null, bulk = false) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  const categoryOptions = ['í™”ì¥í’ˆ/ë¯¸ìš©', 'ìƒí™œ/ê±´ê°•', 'ì¶œì‚°/ìœ¡ì•„', 'ìŠ¤í¬ì¸ /ë ˆì €', 'ê°€êµ¬/ì¸í…Œë¦¬ì–´', 'ë””ì§€í„¸/ê°€ì „', 'ì—¬í–‰/ë¬¸í™”', 'íŒ¨ì…˜ì˜ë¥˜', 'ì‹í’ˆ'];
  
  if (bulk) {
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ ë“±ë¡</h2>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
          <button class="btn btn-secondary" style="flex:1" onclick="showSellerListTextInput()">ğŸ“ í…ìŠ¤íŠ¸ ì…ë ¥</button>
          <button class="btn btn-primary" style="flex:1" onclick="showSellerListExcelUpload()">ğŸ“Š ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        
        <div id="sellerList-bulk-content">
          <div id="sellerList-excel-upload">
            <div class="form-group">
              <label class="form-label">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">
                ì—‘ì…€ íŒŒì¼ì˜ ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.<br>
                <strong>ì—´:</strong> ì¹´í…Œê³ ë¦¬, ê³„ì •ëª…, ì±„ë„, ê³„ì •ë§í¬, íŒ”ë¡œì›Œ(ë§Œ), ë¹„ê³ 
              </p>
              <div style="border: 2px dashed var(--gray-300); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.15s ease;" 
                   onclick="document.getElementById('excel-file-sellerList').click()"
                   ondragover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'; event.preventDefault()"
                   ondragleave="this.style.borderColor='var(--gray-300)'; this.style.background='transparent'"
                   ondrop="handleSellerListExcelDrop(event)">
                <div style="font-size: 36px; margin-bottom: 8px;">ğŸ“</div>
                <div style="color: var(--gray-700); font-weight: 500;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                <div style="color: var(--gray-500); font-size: 13px; margin-top: 4px;">.xlsx, .xls íŒŒì¼ ì§€ì›</div>
              </div>
              <input type="file" id="excel-file-sellerList" accept=".xlsx,.xls" style="display:none" onchange="handleSellerListExcelFile(this.files[0])">
            </div>
            
            <div id="sellerList-excel-preview" style="display:none; margin-top: 16px;">
              <div class="form-label">ë¯¸ë¦¬ë³´ê¸° <span id="sellerList-preview-count" style="color: var(--primary);"></span></div>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 8px;">
                <table class="data-table" id="sellerList-preview-table">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            
            <div style="margin-top: 16px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px;">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì˜ˆì‹œ</div>
              <div style="overflow-x: auto;">
                <table style="font-size: 12px; border-collapse: collapse; width: 100%;">
                  <tr style="background: var(--primary-light);">
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì¹´í…Œê³ ë¦¬</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ê³„ì •ëª…</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì±„ë„</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ê³„ì •ë§í¬</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">íŒ”ë¡œì›Œ(ë§Œ)</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ë¹„ê³ </th>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">í™”ì¥í’ˆ/ë¯¸ìš©</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ë·°í‹°ì¸í”Œë£¨ì–¸ì„œ</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ì¸ìŠ¤íƒ€ê·¸ë¨</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">instagram.com/beauty</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">5.2</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">VIP</td>
                  </tr>
                </table>
              </div>
              <p style="font-size: 11px; color: var(--gray-500); margin-top: 8px;">
                ğŸ’¡ íŒ”ë¡œì›Œ(ë§Œ): 1ë§Œëª…=1, 5ì²œëª…=0.5, 52000ëª…=5.2
              </p>
              <button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="downloadSellerListTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
          
          <div id="sellerList-text-input" style="display: none;">
            <div class="form-group">
              <label class="form-label">ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</label>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">
                í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”. (ì‰¼í‘œë¡œ êµ¬ë¶„)<br>
                í˜•ì‹: ì¹´í…Œê³ ë¦¬, ê³„ì •ëª…, ì±„ë„, ê³„ì •ë§í¬, íŒ”ë¡œì›Œ(ë§Œ), ë¹„ê³ 
              </p>
              <textarea class="form-textarea" id="bulk-sellerList" rows="10" placeholder="ì˜ˆì‹œ:
í™”ì¥í’ˆ/ë¯¸ìš©, ë·°í‹°ì¸í”Œë£¨ì–¸ì„œ, ì¸ìŠ¤íƒ€ê·¸ë¨, instagram.com/beauty, 5.2, VIP
íŒ¨ì…˜ì˜ë¥˜, íŒ¨ì…˜ìŠ¤íƒ€, ìœ íŠœë¸Œ, youtube.com/fashion, 10, ì‹ ê·œ
ìƒí™œ/ê±´ê°•, í—¬ìŠ¤ë§ˆë‹ˆì•„, ë„¤ì´ë²„ë¸”ë¡œê·¸, blog.naver.com/health, 3.5, "></textarea>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="submitBulkSellerList()">ì¼ê´„ ë“±ë¡</button>
        </div>
      </div>
    `;
    return;
  }
  
  const isEdit = item !== null;
  const s = item || { category: '', accountName: '', accountLink: '', channel: '', followers: '', marginRate: '', eventSupport: [], contacted: false, proposed: false, contracted: false, proposedProducts: [], notes: '' };
  const eventSupportOptions = ['ìƒ˜í”Œ ì œê³µ', 'ê´‘ê³  ì§€ì›', 'ë¬´ë£Œ ë°°ì†¡', 'ë†’ì€ ìˆ˜ìˆ˜ë£Œ', 'ì½˜í…ì¸  ì œì‘', 'ì „ìš© ê²°ì œì°½', 'ì‚¬ì€í’ˆ ì¶”ê°€', 'íŠ¹ë³„ í”„ë¡œëª¨ì…˜'];
  
  // ê¸°ì¡´ proposedProduct(ë‹¨ì¼) -> proposedProducts(ë°°ì—´)ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
  const selectedProductIds = s.proposedProducts || (s.proposedProduct ? [s.proposedProduct] : []);
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ì…€ëŸ¬ ìˆ˜ì •' : 'ìƒˆ ì…€ëŸ¬ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitSellerListForm(event, '${s.id || ''}')">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
          <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">ğŸ“Œ ê¸°ë³¸ ì •ë³´</h4>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì¹´í…Œê³ ë¦¬ *</label>
              <select class="form-select" id="sl-category" required>
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${categoryOptions.map(cat => `<option value="${cat}" ${s.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">ê³„ì •ëª… *</label>
              <input type="text" class="form-input" id="sl-accountName" value="${s.accountName || ''}" required placeholder="ì…€ëŸ¬ ê³„ì •ëª…">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì±„ë„</label>
              <select class="form-select" id="sl-channel">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì¸ìŠ¤íƒ€ê·¸ë¨" ${s.channel === 'ì¸ìŠ¤íƒ€ê·¸ë¨' ? 'selected' : ''}>ì¸ìŠ¤íƒ€ê·¸ë¨</option>
                <option value="ìœ íŠœë¸Œ" ${s.channel === 'ìœ íŠœë¸Œ' ? 'selected' : ''}>ìœ íŠœë¸Œ</option>
                <option value="ë„¤ì´ë²„ë¸”ë¡œê·¸" ${s.channel === 'ë„¤ì´ë²„ë¸”ë¡œê·¸' ? 'selected' : ''}>ë„¤ì´ë²„ ë¸”ë¡œê·¸</option>
                <option value="ë„¤ì´ë²„ì¹´í˜" ${s.channel === 'ë„¤ì´ë²„ì¹´í˜' ? 'selected' : ''}>ë„¤ì´ë²„ ì¹´í˜</option>
                <option value="í‹±í†¡" ${s.channel === 'í‹±í†¡' ? 'selected' : ''}>í‹±í†¡</option>
                <option value="ì¹´ì¹´ì˜¤" ${s.channel === 'ì¹´ì¹´ì˜¤' ? 'selected' : ''}>ì¹´ì¹´ì˜¤</option>
                <option value="ê¸°íƒ€" ${s.channel === 'ê¸°íƒ€' ? 'selected' : ''}>ê¸°íƒ€</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">íŒ”ë¡œì›Œ ìˆ˜ (ë§Œ)</label>
              <input type="number" class="form-input" id="sl-followers" value="${s.followers || ''}" placeholder="ì˜ˆ: 5.2 (=52,000ëª…)" step="0.1" min="0">
              <small style="color: var(--gray-500); font-size: 11px;">1ë§Œëª…=1, 5ì²œëª…=0.5, 52000ëª…=5.2</small>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ê³„ì • ë§í¬</label>
            <input type="text" class="form-input" id="sl-accountLink" value="${s.accountLink || ''}" placeholder="https://...">
          </div>
        </div>
        
        <!-- í˜‘ìƒ ì •ë³´ -->
        <div style="margin-bottom: 20px; padding: 16px; background: var(--success-light); border-radius: 12px;">
          <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--success);">ğŸ’° í˜‘ìƒ ì •ë³´</h4>
          <div class="form-group">
            <label class="form-label">í˜‘ìƒ ë§ˆì§„ìœ¨ (%)</label>
            <input type="number" class="form-input" id="sl-marginRate" value="${s.marginRate || ''}" placeholder="ì˜ˆ: 15" step="0.1" min="0" max="100" style="max-width: 200px;">
            <small style="color: var(--gray-500); font-size: 11px;">ì…€ëŸ¬ì™€ í˜‘ìƒí•œ ë§ˆì§„ìœ¨</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì œì•ˆ ìƒí’ˆ (ìƒí’ˆDB ì—°ë™)</label>
            <div style="position: relative;">
              <input type="text" class="form-input" id="sl-product-search" placeholder="ğŸ” ìƒí’ˆëª… ê²€ìƒ‰..." oninput="searchSellerProducts(this.value)">
              <div id="sl-product-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--gray-200); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
            </div>
            <div id="sl-selected-products" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
              ${selectedProductIds.map(pid => {
                const prod = (state.supplierProducts || []).find(p => p.id === pid);
                return prod ? `
                  <span class="status-badge status-confirmed" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;">
                    ${prod.representativeProduct || prod.productName}
                    <button type="button" onclick="removeSellerProduct('${pid}')" style="background: none; border: none; cursor: pointer; color: var(--danger); font-size: 14px;">Ã—</button>
                    <input type="hidden" name="sl-proposedProducts" value="${pid}">
                  </span>
                ` : '';
              }).join('')}
            </div>
            <small style="color: var(--gray-500); font-size: 11px;">ìƒí’ˆDBì— ë“±ë¡ëœ ìƒí’ˆ ì¤‘ ì„ íƒ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì´ë²¤íŠ¸ ì§€ì› ë‚´ì—­</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
              ${eventSupportOptions.map(opt => `
                <label class="checkbox-wrapper" style="padding: 6px 12px; background: white; border-radius: 6px; border: 1px solid var(--gray-200);">
                  <input type="checkbox" name="sl-eventSupport" value="${opt}" ${(s.eventSupport || []).includes(opt) ? 'checked' : ''}>
                  <span style="font-size: 13px;">${opt}</span>
                </label>
              `).join('')}
            </div>
          </div>
        </div>
        
        <!-- ì§„í–‰ ìƒíƒœ (ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½ ìˆœì„œ) -->
        <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
          <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">ì§„í–‰ ìƒíƒœ <span style="font-weight: 400; font-size: 12px; color: var(--gray-500);">(ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½)</span></h4>
          <div style="display: flex; gap: 16px; flex-wrap: wrap;">
            <label class="checkbox-wrapper" style="padding: 10px 16px; background: white; border-radius: 8px; border: 2px solid ${s.proposed ? '#22c55e' : '#e5e7eb'};">
              <input type="checkbox" id="sl-proposed" ${s.proposed ? 'checked' : ''}>
              <span style="font-weight: 500; color: ${s.proposed ? '#16a34a' : 'inherit'};">â‘  ì œì•ˆì™„ë£Œ</span>
            </label>
            <label class="checkbox-wrapper" style="padding: 10px 16px; background: white; border-radius: 8px; border: 2px solid ${s.contacted ? '#3b82f6' : '#e5e7eb'};">
              <input type="checkbox" id="sl-contacted" ${s.contacted ? 'checked' : ''}>
              <span style="font-weight: 500; color: ${s.contacted ? '#1d4ed8' : 'inherit'};">â‘¡ ì»¨íƒì™„ë£Œ</span>
            </label>
            <label class="checkbox-wrapper" style="padding: 10px 16px; background: ${s.contracted ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'white'}; border-radius: 8px; border: 2px solid ${s.contracted ? '#8b5cf6' : '#e5e7eb'};">
              <input type="checkbox" id="sl-contracted" ${s.contracted ? 'checked' : ''}>
              <span style="font-weight: 500; color: ${s.contracted ? 'white' : 'inherit'};">â‘¢ ì…ì ê³„ì•½</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ë¹„ê³ </label>
          <textarea class="form-textarea" id="sl-notes" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨ (í˜‘ìƒ ì§„í–‰ìƒí™©, íŠ¹ì´ì‚¬í•­ ë“±)">${s.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSellerListItem('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
}

// ì…€ëŸ¬ ì œì•ˆìƒí’ˆ ê²€ìƒ‰
function searchSellerProducts(keyword) {
  const dropdown = document.getElementById('sl-product-dropdown');
  if (!keyword || keyword.length < 1) {
    dropdown.style.display = 'none';
    return;
  }
  
  const products = (state.supplierProducts || []).filter(p => 
    (p.productName || '').toLowerCase().includes(keyword.toLowerCase()) ||
    (p.representativeProduct || '').toLowerCase().includes(keyword.toLowerCase()) ||
    (p.brandName || '').toLowerCase().includes(keyword.toLowerCase())
  ).slice(0, 10);
  
  if (products.length === 0) {
    dropdown.innerHTML = '<div style="padding: 12px; color: var(--gray-500); text-align: center;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
  } else {
    dropdown.innerHTML = products.map(p => `
      <div onclick="addSellerProduct('${p.id}')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--gray-100); transition: background 0.1s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
        <div style="font-weight: 500;">${p.representativeProduct || p.productName}</div>
        <div style="font-size: 12px; color: var(--gray-500);">${p.brandName} Â· ${p.productName}</div>
      </div>
    `).join('');
  }
  dropdown.style.display = 'block';
}

// ì…€ëŸ¬ ì œì•ˆìƒí’ˆ ì¶”ê°€
function addSellerProduct(productId) {
  const container = document.getElementById('sl-selected-products');
  const product = (state.supplierProducts || []).find(p => p.id === productId);
  if (!product) return;
  
  // ì´ë¯¸ ì¶”ê°€ëœ ê²½ìš° ë¬´ì‹œ
  if (container.querySelector(`input[value="${productId}"]`)) {
    document.getElementById('sl-product-dropdown').style.display = 'none';
    document.getElementById('sl-product-search').value = '';
    return;
  }
  
  const badge = document.createElement('span');
  badge.className = 'status-badge status-confirmed';
  badge.style.cssText = 'display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;';
  badge.innerHTML = `
    ${product.representativeProduct || product.productName}
    <button type="button" onclick="removeSellerProduct('${productId}')" style="background: none; border: none; cursor: pointer; color: var(--danger); font-size: 14px;">Ã—</button>
    <input type="hidden" name="sl-proposedProducts" value="${productId}">
  `;
  container.appendChild(badge);
  
  document.getElementById('sl-product-dropdown').style.display = 'none';
  document.getElementById('sl-product-search').value = '';
}

// ì…€ëŸ¬ ì œì•ˆìƒí’ˆ ì œê±°
function removeSellerProduct(productId) {
  const container = document.getElementById('sl-selected-products');
  const input = container.querySelector(`input[value="${productId}"]`);
  if (input) {
    input.closest('span').remove();
  }
}

function submitSellerListForm(e, id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();
  
  // ì´ë²¤íŠ¸ ì§€ì› ë‚´ì—­ ìˆ˜ì§‘
  const eventSupportCheckboxes = document.querySelectorAll('input[name="sl-eventSupport"]:checked');
  const eventSupport = Array.from(eventSupportCheckboxes).map(cb => cb.value);
  
  // ì œì•ˆìƒí’ˆ ìˆ˜ì§‘
  const productInputs = document.querySelectorAll('input[name="sl-proposedProducts"]');
  const proposedProducts = Array.from(productInputs).map(input => input.value);
  
  const data = {
    category: document.getElementById('sl-category').value,
    accountName: document.getElementById('sl-accountName').value,
    channel: document.getElementById('sl-channel').value,
    followers: Number(document.getElementById('sl-followers').value) || 0,
    accountLink: document.getElementById('sl-accountLink').value,
    marginRate: Number(document.getElementById('sl-marginRate').value) || 0,
    eventSupport: eventSupport,
    contacted: document.getElementById('sl-contacted').checked,
    proposed: document.getElementById('sl-proposed').checked,
    contracted: document.getElementById('sl-contracted').checked,
    proposedProducts: proposedProducts,
    notes: document.getElementById('sl-notes').value,
    updatedAt: new Date().toISOString(),
    updatedBy: getCurrentUserId()
  };
  
  // ì‹ ê·œ ë“±ë¡ ì‹œ createdBy ì¶”ê°€
  if (!id) {
    data.createdBy = getCurrentUserId();
    data.createdAt = new Date().toISOString();
  }
  
  if (id) data.id = id;
  saveSellerListItem(data);
}

// ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì…ë ¥ ë°©ì‹ ì „í™˜
function showSellerListTextInput() {
  document.getElementById('sellerList-excel-upload').style.display = 'none';
  document.getElementById('sellerList-text-input').style.display = 'block';
  window.sellerListBulkMode = 'text';
}

function showSellerListExcelUpload() {
  document.getElementById('sellerList-excel-upload').style.display = 'block';
  document.getElementById('sellerList-text-input').style.display = 'none';
  window.sellerListBulkMode = 'excel';
}

// ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
let sellerListExcelData = [];

function handleSellerListExcelDrop(e) {
  e.preventDefault();
  e.target.style.borderColor = 'var(--gray-300)';
  e.target.style.background = 'transparent';
  const file = e.dataTransfer.files[0];
  if (file) handleSellerListExcelFile(file);
}

function handleSellerListExcelFile(file) {
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      const headers = jsonData[0].map(h => String(h).trim());
      const rows = jsonData.slice(1).filter(row => row.some(cell => cell));
      
      // ìƒˆ ì–‘ì‹: ì¹´í…Œê³ ë¦¬, ê³„ì •ëª…, ì±„ë„, ê³„ì •ë§í¬, íŒ”ë¡œì›Œ(ë§Œ), ì œì•ˆ, ì»¨íƒ, ê³„ì•½, ë¹„ê³ 
      const colMap = {
        category: headers.findIndex(h => h.includes('ì¹´í…Œê³ ë¦¬') || h.toLowerCase().includes('category')),
        accountName: headers.findIndex(h => h.includes('ê³„ì •ëª…') || h.includes('ì´ë¦„') || h.toLowerCase().includes('name') || h.toLowerCase().includes('account')),
        channel: headers.findIndex(h => h.includes('ì±„ë„') || h.toLowerCase().includes('channel')),
        accountLink: headers.findIndex(h => h.includes('ê³„ì •ë§í¬') || h.includes('ë§í¬') || h.toLowerCase().includes('link')),
        followers: headers.findIndex(h => h.includes('íŒ”ë¡œì›Œ') || h.toLowerCase().includes('follower')),
        proposed: headers.findIndex(h => h.includes('ì œì•ˆ') || h.toLowerCase().includes('proposed')),
        contacted: headers.findIndex(h => h.includes('ì»¨íƒ') || h.toLowerCase().includes('contact')),
        contracted: headers.findIndex(h => h.includes('ê³„ì•½') || h.toLowerCase().includes('contract')),
        notes: headers.findIndex(h => h.includes('ë¹„ê³ ') || h.includes('ë©”ëª¨') || h.toLowerCase().includes('note'))
      };

      // O ë˜ëŠ” oë¥¼ trueë¡œ ë³€í™˜
      const isChecked = (val) => val && String(val).toUpperCase().trim() === 'O';

      sellerListExcelData = rows.map(row => ({
        category: colMap.category >= 0 ? String(row[colMap.category] || '').trim() : '',
        accountName: colMap.accountName >= 0 ? String(row[colMap.accountName] || '').trim() : '',
        channel: colMap.channel >= 0 ? String(row[colMap.channel] || '').trim() : '',
        accountLink: colMap.accountLink >= 0 ? String(row[colMap.accountLink] || '').trim() : '',
        followers: colMap.followers >= 0 ? Number(row[colMap.followers]) || 0 : 0,
        proposed: colMap.proposed >= 0 ? isChecked(row[colMap.proposed]) : false,
        contacted: colMap.contacted >= 0 ? isChecked(row[colMap.contacted]) : false,
        contracted: colMap.contracted >= 0 ? isChecked(row[colMap.contracted]) : false,
        notes: colMap.notes >= 0 ? String(row[colMap.notes] || '').trim() : ''
      })).filter(item => item.accountName);

      const previewDiv = document.getElementById('sellerList-excel-preview');
      const countSpan = document.getElementById('sellerList-preview-count');
      const thead = document.querySelector('#sellerList-preview-table thead');
      const tbody = document.querySelector('#sellerList-preview-table tbody');

      countSpan.textContent = `(${sellerListExcelData.length}ê±´)`;
      thead.innerHTML = '<tr><th>ì¹´í…Œê³ ë¦¬</th><th>ê³„ì •ëª…</th><th>ì±„ë„</th><th>ê³„ì •ë§í¬</th><th>íŒ”ë¡œì›Œ</th><th>ì œì•ˆ</th><th>ì»¨íƒ</th><th>ê³„ì•½</th><th>ë¹„ê³ </th></tr>';
      tbody.innerHTML = sellerListExcelData.slice(0, 10).map(s => `
        <tr>
          <td>${s.category}</td>
          <td>${s.accountName}</td>
          <td>${s.channel}</td>
          <td>${s.accountLink}</td>
          <td>${s.followers || '-'}</td>
          <td style="text-align:center;color:${s.proposed ? '#16a34a' : '#ccc'}">${s.proposed ? 'âœ“' : '-'}</td>
          <td style="text-align:center;color:${s.contacted ? '#2563eb' : '#ccc'}">${s.contacted ? 'âœ“' : '-'}</td>
          <td style="text-align:center;color:${s.contracted ? '#7c3aed' : '#ccc'}">${s.contracted ? 'âœ“' : '-'}</td>
          <td>${s.notes}</td>
        </tr>
      `).join('') + (sellerListExcelData.length > 10 ? `<tr><td colspan="9" style="text-align:center;color:var(--gray-500)">... ì™¸ ${sellerListExcelData.length - 10}ê±´</td></tr>` : '');
      
      previewDiv.style.display = 'block';
      showToast(`${sellerListExcelData.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
      
    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };
  reader.readAsArrayBuffer(file);
}

async function submitBulkSellerList() {
  let dataToSubmit = [];
  
  if (window.sellerListBulkMode !== 'text' && sellerListExcelData.length > 0) {
    dataToSubmit = sellerListExcelData;
  } else {
    const text = document.getElementById('bulk-sellerList')?.value?.trim();
    if (!text) {
      showToast('ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    dataToSubmit = lines.map(line => {
      const parts = line.split(',').map(p => p.trim());
      return {
        category: parts[0] || '',
        accountName: parts[1] || '',
        channel: parts[2] || '',
        accountLink: parts[3] || '',
        followers: Number(parts[4]) || 0,
        notes: parts[5] || ''
      };
    }).filter(item => item.accountName);
  }
  
  if (dataToSubmit.length === 0) {
    showToast('ë“±ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´
  const currentUserEmail = getCurrentUserId();
  const now = new Date().toISOString();
  
  let successCount = 0;
  for (const data of dataToSubmit) {
    try {
      // createdBy, createdAt ìë™ ì¶”ê°€
      data.createdBy = currentUserEmail;
      data.createdAt = now;
      // ì—‘ì…€ì—ì„œ ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ false
      data.proposed = data.proposed || false;
      data.contacted = data.contacted || false;
      data.contracted = data.contracted || false;
      await db.collection('sellerList').add(data);
      successCount++;
    } catch(e) {
      console.error(e);
    }
  }
  
  sellerListExcelData = [];
  showToast(`${successCount}ê±´ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
  closeModal();
}

function renderSellerList() {
  const app = document.getElementById('app');
  
  // ê²€ìƒ‰ í•„í„°
  const searchKeyword = state.sellerListSearchKeyword || '';
  const allSellers = state.sellerList || [];
  const filteredSellers = searchKeyword 
    ? allSellers.filter(s => (s.accountName || '').toLowerCase().includes(searchKeyword.toLowerCase()) || 
                             (s.category || '').toLowerCase().includes(searchKeyword.toLowerCase()) ||
                             (s.channel || '').toLowerCase().includes(searchKeyword.toLowerCase()))
    : allSellers;
  
  // í†µê³„ ê³„ì‚° (ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½ ìˆœì„œ)
  const totalCount = allSellers.length;
  const notProposedCount = allSellers.filter(s => !s.proposed).length;
  const proposedCount = allSellers.filter(s => s.proposed).length;
  const contactedCount = allSellers.filter(s => s.contacted).length;
  const contractedCount = allSellers.filter(s => s.contracted).length;
  
  // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¶”ì¶œ
  const categories = [...new Set(allSellers.map(s => s.category).filter(c => c))];
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</h1>
      <p class="page-desc">ì´ ${totalCount}ëª…ì˜ íƒìƒ‰ ì…€ëŸ¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="downloadSellerListTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-secondary" onclick="openSellerListModal(null, true)">ğŸ“‹ ì¼ê´„ ë“±ë¡</button>
        <button class="btn btn-primary" onclick="openSellerListModal()">+ ìƒˆ ì…€ëŸ¬</button>
      </div>
    </div>
    
    <!-- í†µê³„ ì¹´ë“œ (ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½ ìˆœì„œ) -->
    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ì…€ëŸ¬</div>
        <div class="stat-value">${totalCount}ëª…</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #16a34a;">âœ… ì œì•ˆì™„ë£Œ</div>
        <div class="stat-value" style="color: #22c55e;">${proposedCount}ëª…</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #1e40af;">ğŸ“ ì»¨íƒì™„ë£Œ</div>
        <div class="stat-value" style="color: #3b82f6;">${contactedCount}ëª…</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-label">ğŸ‰ ì…ì ê³„ì•½</div>
        <div class="stat-value">${contractedCount}ëª…</div>
      </div>
    </div>
    
    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="card" style="margin-bottom: 16px; padding: 16px;">
      <div style="position: relative; max-width: 600px;">
        <input type="text" class="form-input" id="sellerlist-search" 
          placeholder="ê³„ì •ëª…, ì¹´í…Œê³ ë¦¬, ì±„ë„ ê²€ìƒ‰ í›„ Enter" 
          value="${searchKeyword}"
          onkeydown="if(event.key==='Enter') handleSellerListSearch(this.value)"
          style="padding-left: 16px; padding-right: 40px;">
        ${searchKeyword ? `
          <button onclick="clearSellerListSearch()" 
            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-400); cursor: pointer; font-size: 18px;">Ã—</button>
        ` : ''}
      </div>
      ${searchKeyword ? `<p style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">"${searchKeyword}" ê²€ìƒ‰ ê²°ê³¼: ${filteredSellers.length}ê±´</p>` : ''}
    </div>
    
    <!-- ìƒíƒœ í•„í„° (ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½ ìˆœì„œ) -->
    <div class="card" style="margin-bottom: 16px;">
      <div class="filter-bar">
        <div class="filter-group">
          <button class="filter-btn ${!window.sellerListStatusFilter ? 'active' : ''}" onclick="filterSellerListByStatus('')">ì „ì²´</button>
          <button class="filter-btn ${window.sellerListStatusFilter === 'notProposed' ? 'active' : ''}" onclick="filterSellerListByStatus('notProposed')" style="color: #d97706;">ë¯¸ì œì•ˆ</button>
          <button class="filter-btn ${window.sellerListStatusFilter === 'proposed' ? 'active' : ''}" onclick="filterSellerListByStatus('proposed')" style="color: #16a34a;">ì œì•ˆì™„ë£Œ</button>
          <button class="filter-btn ${window.sellerListStatusFilter === 'contacted' ? 'active' : ''}" onclick="filterSellerListByStatus('contacted')" style="color: #1d4ed8;">ì»¨íƒì™„ë£Œ</button>
          <button class="filter-btn ${window.sellerListStatusFilter === 'contracted' ? 'active' : ''}" onclick="filterSellerListByStatus('contracted')" style="color: #7c3aed;">ì…ì ê³„ì•½</button>
        </div>
      </div>
    </div>
    
    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
    ${categories.length > 0 ? `
      <div class="card" style="margin-bottom: 16px;">
        <div class="filter-bar">
          <div class="filter-group">
            <span style="font-size: 13px; color: var(--gray-500); margin-right: 8px;">ì¹´í…Œê³ ë¦¬:</span>
            <button class="filter-btn ${!window.slCategoryFilter ? 'active' : ''}" onclick="filterSellerListByCategory('')">ì „ì²´</button>
            ${categories.map(cat => `
              <button class="filter-btn ${window.slCategoryFilter === cat ? 'active' : ''}" onclick="filterSellerListByCategory('${cat}')">${cat}</button>
            `).join('')}
          </div>
        </div>
      </div>
    ` : ''}
    
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 class="card-title" style="margin-bottom: 0;">íƒìƒ‰ ì…€ëŸ¬ ëª©ë¡</h3>
        <div id="sellerlist-delete-actions" style="display: none; align-items: center;">
          <span id="sellerlist-selected-count" style="font-size: 13px; color: var(--gray-600); margin-right: 12px;">0ê°œ ì„ íƒ</span>
          <button class="btn btn-secondary btn-sm" onclick="clearSellerListSelection()" style="margin-right: 8px;">ì„ íƒ í•´ì œ</button>
          <button class="btn btn-sm" style="background: #10b981; color: white; margin-right: 8px;" onclick="downloadSelectedSellerList()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn btn-sm" style="background: #ef4444; color: white;" onclick="deleteSelectedSellerList()">ğŸ—‘ ì„ íƒ ì‚­ì œ</button>
        </div>
      </div>
      ${filteredSellers.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ‘¤</div>
          <div class="text">${searchKeyword ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ë“±ë¡ëœ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤'}</div>
          <p style="color: var(--gray-500); margin: 8px 0;">ê³µêµ¬ ì œì•ˆì„ ìœ„í•œ ì…€ëŸ¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
          ${!searchKeyword ? `<button class="btn btn-primary" style="margin-top: 16px;" onclick="openSellerListModal()">+ ì²« ì…€ëŸ¬ ì¶”ê°€í•˜ê¸°</button>` : ''}
        </div>
      ` : `
        <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 40px; text-align: center;">
                <input type="checkbox" id="sellerlist-select-all" onchange="toggleSelectAllSellerList(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
              </th>
              <th>ì¹´í…Œê³ ë¦¬</th>
              <th>ê³„ì •ëª…</th>
              <th>ì±„ë„</th>
              <th>íŒ”ë¡œì›Œ</th>
              <th style="text-align: center;">ì œì•ˆ</th>
              <th style="text-align: center;">ì»¨íƒ</th>
              <th style="text-align: center;">ê³„ì•½</th>
              <th>ì œì•ˆìƒí’ˆ</th>
              <th style="text-align: right;">ë§ˆì§„ìœ¨</th>
              <th>ë‹´ë‹¹ì</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${filteredSellers
              .filter(s => {
                if (window.slCategoryFilter && s.category !== window.slCategoryFilter) return false;
                if (window.sellerListStatusFilter === 'notProposed' && s.proposed) return false;
                if (window.sellerListStatusFilter === 'proposed' && (!s.proposed || s.contacted)) return false;
                if (window.sellerListStatusFilter === 'contacted' && (!s.contacted || s.contracted)) return false;
                if (window.sellerListStatusFilter === 'contracted' && !s.contracted) return false;
                return true;
              })
              .map(s => {
                // í–‰ ë°°ê²½ìƒ‰ ê²°ì • (ê³„ì•½ > ì»¨íƒ > ì œì•ˆ > ë¯¸ì œì•ˆ)
                let rowBg = '';
                if (s.contracted) {
                  rowBg = 'background: #f5f3ff;'; // ì—°í•œ ë³´ë¼
                } else if (s.contacted) {
                  rowBg = 'background: #eff6ff;'; // ì—°í•œ íŒŒë‘
                } else if (s.proposed) {
                  rowBg = 'background: #f0fdf4;'; // ì—°í•œ ì´ˆë¡
                } else {
                  rowBg = 'background: #fffbeb;'; // ì—°í•œ ë…¸ë‘
                }
                
                // ì œì•ˆìƒí’ˆ í‘œì‹œ (ë‹¤ì¤‘)
                const proposedProducts = s.proposedProducts || (s.proposedProduct ? [s.proposedProduct] : []);
                const productNames = proposedProducts.map(pid => {
                  const prod = (state.supplierProducts || []).find(p => p.id === pid);
                  return prod ? (prod.representativeProduct || prod.productName) : pid;
                });
                
                // ë‹´ë‹¹ì í‘œì‹œ
                const createdByName = s.createdBy ? s.createdBy.split('@')[0] : '-';
                
                return `
              <tr style="${rowBg}">
                <td style="text-align: center;">
                  <input type="checkbox" class="sellerlist-checkbox" data-id="${s.id}" onchange="toggleSelectSellerList('${s.id}')" style="width: 18px; height: 18px; cursor: pointer;">
                </td>
                <td>${s.category ? `<span class="status-badge status-confirmed" style="font-size: 11px;">${s.category}</span>` : '-'}</td>
                <td>
                  <div>
                    <strong>${s.accountName}</strong>
                    ${s.notes ? `<div style="font-size: 11px; color: var(--gray-500); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${s.notes}">${s.notes}</div>` : ''}
                  </div>
                </td>
                <td>
                  ${s.channel ? `<span style="font-size: 12px; color: var(--gray-600);">${s.channel}</span>` : '-'}
                  ${s.accountLink ? `<a href="${s.accountLink.startsWith('http') ? s.accountLink : 'https://' + s.accountLink}" target="_blank" style="color: var(--primary); margin-left: 4px;">ë§í¬</a>` : ''}
                </td>
                <td>${s.followers ? formatFollowersMan(s.followers) : '-'}</td>
                <td style="text-align: center;">
                  <label class="checkbox-wrapper" style="padding: 6px 10px; display: inline-flex; background: white; border-radius: 6px; border: 2px solid ${s.proposed ? '#22c55e' : '#e5e7eb'}; cursor: pointer;" onclick="event.stopPropagation(); toggleSellerListField('${s.id}', 'proposed', ${!s.proposed})">
                    <input type="checkbox" ${s.proposed ? 'checked' : ''} style="pointer-events: none;">
                  </label>
                </td>
                <td style="text-align: center;">
                  <label class="checkbox-wrapper" style="padding: 6px 10px; display: inline-flex; background: white; border-radius: 6px; border: 2px solid ${s.contacted ? '#3b82f6' : '#e5e7eb'}; cursor: pointer;" onclick="event.stopPropagation(); toggleSellerListField('${s.id}', 'contacted', ${!s.contacted})">
                    <input type="checkbox" ${s.contacted ? 'checked' : ''} style="pointer-events: none;">
                  </label>
                </td>
                <td style="text-align: center;">
                  <label class="checkbox-wrapper" style="padding: 6px 10px; display: inline-flex; background: ${s.contracted ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'white'}; border-radius: 6px; border: 2px solid ${s.contracted ? '#8b5cf6' : '#e5e7eb'}; cursor: pointer;" onclick="event.stopPropagation(); toggleSellerListField('${s.id}', 'contracted', ${!s.contracted})">
                    <input type="checkbox" ${s.contracted ? 'checked' : ''} style="pointer-events: none; ${s.contracted ? 'filter: brightness(10);' : ''}">
                  </label>
                </td>
                <td>
                  ${productNames.length > 0 ? `
                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                      ${productNames.slice(0, 2).map(n => `<span class="status-badge status-negotiating" style="font-size: 10px;">${n}</span>`).join('')}
                      ${productNames.length > 2 ? `<span style="font-size: 10px; color: var(--gray-400);">+${productNames.length - 2}</span>` : ''}
                    </div>
                  ` : '-'}
                </td>
                <td style="text-align: right;">
                  ${s.marginRate ? `<span style="font-weight: 600; color: var(--success);">${s.marginRate}%</span>` : '-'}
                </td>
                <td>
                  <span style="font-size: 11px; color: var(--gray-500);">${createdByName}</span>
                </td>
                <td class="actions">
                  <button class="btn btn-secondary btn-sm" onclick="openSellerListModal(state.sellerList.find(item=>item.id==='${s.id}'))">ìˆ˜ì •</button>
                </td>
              </tr>
            `;}).join('')}
          </tbody>
        </table>
        </div>
      `}
    </div>
  `;
}

// ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ê²€ìƒ‰
function handleSellerListSearch(keyword) {
  state.sellerListSearchKeyword = keyword.trim();
  renderSellerList();
}

function clearSellerListSearch() {
  state.sellerListSearchKeyword = '';
  renderSellerList();
}

// ìƒíƒœ í•„í„°
function filterSellerListByStatus(status) {
  window.sellerListStatusFilter = status;
  renderSellerList();
}

// ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì„ íƒ ì‚­ì œ ê¸°ëŠ¥
window.selectedSellerListIds = new Set();

function toggleSelectAllSellerList(checked) {
  const checkboxes = document.querySelectorAll('.sellerlist-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = checked;
    const id = cb.dataset.id;
    if (checked) {
      window.selectedSellerListIds.add(id);
    } else {
      window.selectedSellerListIds.delete(id);
    }
  });
  updateSellerListSelectionUI();
}

function toggleSelectSellerList(id) {
  if (window.selectedSellerListIds.has(id)) {
    window.selectedSellerListIds.delete(id);
  } else {
    window.selectedSellerListIds.add(id);
  }
  updateSellerListSelectionUI();
}

function updateSellerListSelectionUI() {
  const count = window.selectedSellerListIds.size;
  const actionsDiv = document.getElementById('sellerlist-delete-actions');
  const countSpan = document.getElementById('sellerlist-selected-count');
  const selectAllCheckbox = document.getElementById('sellerlist-select-all');

  if (actionsDiv) {
    actionsDiv.style.display = count > 0 ? 'flex' : 'none';
  }
  if (countSpan) {
    countSpan.textContent = `${count}ê°œ ì„ íƒ`;
  }

  // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
  const allCheckboxes = document.querySelectorAll('.sellerlist-checkbox');
  if (selectAllCheckbox && allCheckboxes.length > 0) {
    selectAllCheckbox.checked = count === allCheckboxes.length;
    selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
  }
}

function clearSellerListSelection() {
  window.selectedSellerListIds.clear();
  const checkboxes = document.querySelectorAll('.sellerlist-checkbox');
  checkboxes.forEach(cb => cb.checked = false);
  const selectAllCheckbox = document.getElementById('sellerlist-select-all');
  if (selectAllCheckbox) selectAllCheckbox.checked = false;
  updateSellerListSelectionUI();
}

// ì„ íƒí•œ ì…€ëŸ¬ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function downloadSelectedSellerList() {
  const ids = Array.from(window.selectedSellerListIds);
  if (ids.length === 0) {
    showToast('ë‹¤ìš´ë¡œë“œí•  ì…€ëŸ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
    return;
  }

  const selectedSellers = (state.sellerList || []).filter(s => ids.includes(s.id));

  if (selectedSellers.length === 0) {
    showToast('ì„ íƒëœ ì…€ëŸ¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  // ì—‘ì…€ ë°ì´í„° ìƒì„±
  const headers = ['ì¹´í…Œê³ ë¦¬', 'ê³„ì •ëª…', 'ì±„ë„', 'ê³„ì •ë§í¬', 'íŒ”ë¡œì›Œ(ë§Œ)', 'ì œì•ˆì—¬ë¶€', 'ì»¨íƒì—¬ë¶€', 'ê³„ì•½ì—¬ë¶€', 'ì œì•ˆìƒí’ˆ', 'ë§ˆì§„ìœ¨', 'ë‹´ë‹¹ì', 'ë¹„ê³ '];

  const data = selectedSellers.map(s => {
    // ì œì•ˆìƒí’ˆ ëª©ë¡
    const proposedProducts = s.proposedProducts || (s.proposedProduct ? [s.proposedProduct] : []);
    const productNames = proposedProducts.map(pid => {
      const prod = (state.supplierProducts || []).find(p => p.id === pid);
      return prod ? (prod.representativeProduct || prod.productName) : '';
    }).filter(Boolean).join(', ');

    return [
      s.category || '',
      s.accountName || '',
      s.channel || '',
      s.accountLink || '',
      s.followers || '',
      s.proposed ? 'O' : '',
      s.contacted ? 'O' : '',
      s.contracted ? 'O' : '',
      productNames,
      s.marginRate ? s.marginRate + '%' : '',
      s.createdBy ? s.createdBy.split('@')[0] : '',
      s.notes || ''
    ];
  });

  // XLSX ìƒì„±
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  ws['!cols'] = [
    { wch: 12 }, // ì¹´í…Œê³ ë¦¬
    { wch: 20 }, // ê³„ì •ëª…
    { wch: 10 }, // ì±„ë„
    { wch: 35 }, // ê³„ì •ë§í¬
    { wch: 10 }, // íŒ”ë¡œì›Œ
    { wch: 8 },  // ì œì•ˆ
    { wch: 8 },  // ì»¨íƒ
    { wch: 8 },  // ê³„ì•½
    { wch: 25 }, // ì œì•ˆìƒí’ˆ
    { wch: 8 },  // ë§ˆì§„ìœ¨
    { wch: 10 }, // ë‹´ë‹¹ì
    { wch: 30 }  // ë¹„ê³ 
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì…€ëŸ¬ëª©ë¡');

  const today = new Date().toISOString().slice(0, 10);
  XLSX.writeFile(wb, `ì…€ëŸ¬ëª©ë¡_${selectedSellers.length}ê±´_${today}.xlsx`);

  showToast(`${selectedSellers.length}ê±´ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
}

async function deleteSelectedSellerList() {
  const ids = Array.from(window.selectedSellerListIds);
  if (ids.length === 0) {
    showToast('ì‚­ì œí•  ì…€ëŸ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
    return;
  }

  const confirmMsg = ids.length === 1
    ? 'ì„ íƒí•œ ì…€ëŸ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
    : `ì„ íƒí•œ ${ids.length}ëª…ì˜ ì…€ëŸ¬ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

  if (!confirm(confirmMsg)) return;

  try {
    const batch = db.batch();
    ids.forEach(id => {
      const ref = db.collection('sellerList').doc(id);
      batch.delete(ref);
    });
    await batch.commit();

    window.selectedSellerListIds.clear();
    showToast(`${ids.length}ëª…ì˜ ì…€ëŸ¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
  } catch (e) {
    console.error('ì…€ëŸ¬ ì‚­ì œ ì˜¤ë¥˜:', e);
    showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// íŒ”ë¡œì›Œ ìˆ˜ í¬ë§· (ë§Œ ë‹¨ìœ„ ì €ì¥ ê¸°ì¤€)
function formatFollowersMan(num) {
  if (!num) return '-';
  if (num >= 1) return num.toFixed(1).replace(/\.0$/, '') + 'ë§Œ';
  return (num * 10000).toLocaleString();
}

// ê¸°ì¡´ formatFollowers ìœ ì§€ (í˜¸í™˜ì„±)
function formatFollowers(num) {
  if (!num) return '-';
  if (num >= 10000) return (num / 10000).toFixed(1) + 'ë§Œ';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
}

// ì…€ëŸ¬ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
function downloadSellerListTemplate() {
  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  const categoryOptions = ['í™”ì¥í’ˆ/ë¯¸ìš©', 'ìƒí™œ/ê±´ê°•', 'ì¶œì‚°/ìœ¡ì•„', 'ìŠ¤í¬ì¸ /ë ˆì €', 'ê°€êµ¬/ì¸í…Œë¦¬ì–´', 'ë””ì§€í„¸/ê°€ì „', 'ì—¬í–‰/ë¬¸í™”', 'íŒ¨ì…˜ì˜ë¥˜', 'ì‹í’ˆ'];

  // ì–‘ì‹ ì‹œíŠ¸
  const headers = ['ì¹´í…Œê³ ë¦¬', 'ê³„ì •ëª…', 'ì±„ë„', 'ê³„ì •ë§í¬', 'íŒ”ë¡œì›Œ(ë§Œ)', 'ì œì•ˆ', 'ì»¨íƒ', 'ê³„ì•½', 'ë¹„ê³ '];
  const example = ['í™”ì¥í’ˆ/ë¯¸ìš©', 'ë·°í‹°ì¸í”Œë£¨ì–¸ì„œ', 'ì¸ìŠ¤íƒ€ê·¸ë¨', 'https://instagram.com/beauty', '5.2', 'O', '', '', 'VIP ì…€ëŸ¬'];
  const example2 = ['ì‹í’ˆ', 'ë§›ì§‘íƒë°©', 'ìœ íŠœë¸Œ', 'https://youtube.com/@matjip', '12', 'O', 'O', '', 'êµ¬ë…ì 12ë§Œ'];
  const example3 = ['ìƒí™œ/ê±´ê°•', 'ê±´ê°•ì§€í‚´ì´', 'ë„¤ì´ë²„ë¸”ë¡œê·¸', 'https://blog.naver.com/health', '3.5', 'O', 'O', 'O', 'ê³„ì•½ì™„ë£Œ'];
  const wsData = [headers, example, example2, example3];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 30 }, { wch: 12 }, { wch: 6 }, { wch: 6 }, { wch: 6 }, { wch: 20 }];

  // ì•ˆë‚´ ì‹œíŠ¸
  const guideData = [
    ['ğŸ“‹ ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ë“±ë¡ ì–‘ì‹ ì•ˆë‚´'],
    [''],
    ['â–¶ ì—´ ì„¤ëª…'],
    ['A. ì¹´í…Œê³ ë¦¬ *', 'ì„ íƒ: ' + categoryOptions.join(', ')],
    ['B. ê³„ì •ëª… *', 'ì…€ëŸ¬ì˜ ê³„ì •ëª… ë˜ëŠ” ìƒí˜¸ëª…'],
    ['C. ì±„ë„', 'ì¸ìŠ¤íƒ€ê·¸ë¨, ìœ íŠœë¸Œ, ë„¤ì´ë²„ë¸”ë¡œê·¸, ë„¤ì´ë²„ì¹´í˜, í‹±í†¡, ì¹´ì¹´ì˜¤, ê¸°íƒ€'],
    ['D. ê³„ì •ë§í¬', 'ì…€ëŸ¬ì˜ SNS ë˜ëŠ” ë¸”ë¡œê·¸ URL'],
    ['E. íŒ”ë¡œì›Œ(ë§Œ) *', 'ë§Œ ë‹¨ìœ„ë¡œ ì…ë ¥ (1ë§Œëª…=1, 5ì²œëª…=0.5, 52000ëª…=5.2)'],
    ['F. ì œì•ˆ', 'ì œì•ˆ ì™„ë£Œì‹œ O ì…ë ¥ (ë¹ˆì¹¸ = ë¯¸ì œì•ˆ)'],
    ['G. ì»¨íƒ', 'ì»¨íƒ ì™„ë£Œì‹œ O ì…ë ¥ (ë¹ˆì¹¸ = ë¯¸ì»¨íƒ)'],
    ['H. ê³„ì•½', 'ê³„ì•½ ì™„ë£Œì‹œ O ì…ë ¥ (ë¹ˆì¹¸ = ë¯¸ê³„ì•½)'],
    ['I. ë¹„ê³ ', 'ì¶”ê°€ ë©”ëª¨'],
    [''],
    ['â–¶ ì œì•ˆ/ì»¨íƒ/ê³„ì•½ ì…ë ¥ ë°©ë²•'],
    ['ì™„ë£Œëœ ê²½ìš°', 'â†’ O (ëŒ€ë¬¸ì O)'],
    ['ë¯¸ì™„ë£Œì¸ ê²½ìš°', 'â†’ ë¹ˆì¹¸ìœ¼ë¡œ ë‘ê¸°'],
    [''],
    ['â–¶ íŒ”ë¡œì›Œ ì…ë ¥ ì˜ˆì‹œ'],
    ['1ë§Œëª…', 'â†’ 1'],
    ['5ì²œëª…', 'â†’ 0.5'],
    ['52,000ëª…', 'â†’ 5.2'],
    ['120,000ëª…', 'â†’ 12'],
    [''],
    ['â–¶ ì¹´í…Œê³ ë¦¬ ëª©ë¡'],
    ...categoryOptions.map(c => [c, ''])
  ];
  const wsGuide = XLSX.utils.aoa_to_sheet(guideData);
  wsGuide['!cols'] = [{ wch: 20 }, { wch: 60 }];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì…€ëŸ¬ë¦¬ìŠ¤íŠ¸ì–‘ì‹');
  XLSX.utils.book_append_sheet(wb, wsGuide, 'ğŸ“– ì‘ì„±ì•ˆë‚´');
  XLSX.writeFile(wb, 'ì…€ëŸ¬ë¦¬ìŠ¤íŠ¸_ë“±ë¡ì–‘ì‹.xlsx');
  showToast('âœ… ì–‘ì‹ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ì…€ëŸ¬ ì‚­ì œ
async function deleteSellerListItem(id) {
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!confirm('ì´ ì…€ëŸ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('sellerList').doc(id).delete();
    showToast('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (err) {
    showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ìƒí’ˆë³„ ìƒ˜í”Œ ì „ë‹¬ í† ê¸€
async function toggleProductSample(sellerListId, productId, sampleSent) {
  try {
    const item = state.sellerList.find(s => s.id === sellerListId);
    let productDetails = item.productDetails || {};
    
    productDetails[productId] = {
      ...productDetails[productId],
      sampleSent: sampleSent,
      notes: productDetails[productId]?.notes || ''
    };
    
    await db.collection('sellerList').doc(sellerListId).update({ productDetails });
  } catch(e) {
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ìƒí’ˆë³„ í˜‘ì˜ ë‚´ì—­ ëª¨ë‹¬
function openProductNoteModal(sellerListId, productId) {
  const seller = state.sellerList.find(s => s.id === sellerListId);
  const product = state.products.find(p => p.id === productId);
  const detail = (seller.productDetails && seller.productDetails[productId]) || { sampleSent: false, notes: '' };
  const sellerBenefits = seller.benefits || { prelaunch: [], launch: [], support: [] };
  const hasSellerBenefits = (sellerBenefits.prelaunch && sellerBenefits.prelaunch.length > 0) ||
                            (sellerBenefits.launch && sellerBenefits.launch.length > 0) ||
                            (sellerBenefits.support && sellerBenefits.support.length > 0);
  
  const supportLabels = {
    ad: 'ì½˜í…ì¸  ê´‘ê³ ', payment: 'ì „ìš© ê²°ì œì°½', sample: 'ìƒ˜í”Œ ì œê³µ',
    feed: 'í”¼ë“œ ì œì‘', shipping: 'ë¬´ë£Œ ë°°ì†¡', commission: 'ë†’ì€ ìˆ˜ìˆ˜ë£Œ'
  };
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">${product.name} - í˜‘ì˜ ë‚´ì—­</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 16px; background: var(--gray-50); border-radius: 12px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 13px; color: var(--gray-500);">ì…€ëŸ¬</div>
            <div style="font-weight: 600; margin-top: 4px;">${seller.accountName}</div>
          </div>
          ${hasSellerBenefits ? `
            <button class="btn btn-secondary btn-sm" onclick="closeModal(); openSellerBenefitsModal('${sellerListId}')" style="font-size: 12px;">ğŸ í˜œíƒ ë³´ê¸°</button>
          ` : ''}
        </div>
      </div>
      
      <form onsubmit="submitProductNote(event, '${sellerListId}', '${productId}')">
        <div class="form-group">
          <label class="checkbox-wrapper">
            <input type="checkbox" id="pn-sampleSent" ${detail.sampleSent ? 'checked' : ''}>
            <span>ìƒ˜í”Œ ì „ë‹¬ ì™„ë£Œ</span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">í˜‘ì˜ ë‚´ì—­</label>
          <textarea class="form-textarea" id="pn-notes" rows="5" placeholder="ì´ ìƒí’ˆì— ëŒ€í•œ í˜‘ì˜ ë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”.&#10;ì˜ˆ: 12/15 í†µí™” - ìƒ˜í”Œ ìˆ˜ë ¹ í›„ ë¦¬ë·° ì§„í–‰ ì˜ˆì •&#10;    12/20 í˜‘ì˜ - 1ì›” ì²«ì§¸ì£¼ ê³µêµ¬ ì§„í–‰ í™•ì •">${detail.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
        </div>
      </form>
    </div>
  `;
}

async function submitProductNote(e, sellerListId, productId) {
  e.preventDefault();
  
  try {
    const item = state.sellerList.find(s => s.id === sellerListId);
    let productDetails = item.productDetails || {};
    
    productDetails[productId] = {
      sampleSent: document.getElementById('pn-sampleSent').checked,
      notes: document.getElementById('pn-notes').value
    };
    
    await db.collection('sellerList').doc(sellerListId).update({ productDetails });
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function filterSellerListByCategory(category) {
  window.slCategoryFilter = category;
  render();
}

// ========== ìƒí’ˆ ê´€ë¦¬ ê´€ë ¨ í•¨ìˆ˜ ==========

async function saveProduct(data) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  try {
    if (data.id) {
      await db.collection('products').doc(data.id).update(data);
    } else {
      delete data.id;
      // ìƒˆ ìƒí’ˆì€ ë§ˆì§€ë§‰ ìˆœì„œë¡œ ì¶”ê°€
      data.order = state.products.length;
      await db.collection('products').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteProduct(id) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ìƒí’ˆì˜ ìƒ˜í”Œ ì „ë‹¬ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;
  try {
    await db.collection('products').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function reorderProducts(productId, direction) {
  const currentIndex = state.products.findIndex(p => p.id === productId);
  if (currentIndex === -1) return;
  
  const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
  if (newIndex < 0 || newIndex >= state.products.length) return;
  
  try {
    const batch = db.batch();
    const currentProduct = state.products[currentIndex];
    const swapProduct = state.products[newIndex];
    
    batch.update(db.collection('products').doc(currentProduct.id), { order: newIndex });
    batch.update(db.collection('products').doc(swapProduct.id), { order: currentIndex });
    
    await batch.commit();
  } catch(e) {
    showToast('ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function openProductModal(product = null) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  const isEdit = product !== null;
  const p = product || { name: '', description: '' };
  
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ìƒí’ˆ ìˆ˜ì •' : 'ìƒˆ ìƒí’ˆ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitProductForm(event, '${p.id || ''}')">
        <div class="form-group">
          <label class="form-label">ìƒí’ˆëª… *</label>
          <input type="text" class="form-input" id="product-name" value="${p.name || ''}" required placeholder="ì˜ˆ: ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸">
        </div>
        <div class="form-group">
          <label class="form-label">ì„¤ëª…</label>
          <textarea class="form-textarea" id="product-description" rows="3" placeholder="ìƒí’ˆì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…">${p.description || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteProduct('${p.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
}

function addBenefitRow(type) {
  const container = document.getElementById(type + '-benefits');
  const row = document.createElement('div');
  row.className = 'benefit-row';
  row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
  row.innerHTML = `
    <input type="text" class="form-input" name="${type}-name" placeholder="ì´ë²¤íŠ¸ëª…" style="flex: 2;">
    <input type="text" class="form-input" name="${type}-count" placeholder="ì¸ì›" style="flex: 0.5;">
    <input type="text" class="form-input" name="${type}-reward" placeholder="í˜œíƒ" style="flex: 1.5;">
    <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
  `;
  container.appendChild(row);
}

function submitProductForm(e, id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();
  const data = {
    name: document.getElementById('product-name').value,
    description: document.getElementById('product-description').value,
  };
  if (id) data.id = id;
  saveProduct(data);
}

function renderProducts() {
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ìƒí’ˆ ê´€ë¦¬</h1>
      <p class="page-desc">ìƒ˜í”Œ ì „ë‹¬ ì²´í¬ì— ì‚¬ìš©í•  ìƒí’ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openProductModal()">+ ìƒˆ ìƒí’ˆ</button>
      </div>
    </div>
    
    <div class="card">
      <div style="margin-bottom: 16px; padding: 16px; background: var(--info-light); border-radius: 12px; color: var(--info);">
        <strong>ğŸ’¡ íŒ:</strong> ì—¬ê¸°ì„œ ë“±ë¡í•œ ìƒí’ˆë“¤ì´ ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì˜ 'ìƒ˜í”Œ ì „ë‹¬' ì²´í¬ í•­ëª©ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
      </div>
      
      ${state.products.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ“¦</div>
          <div class="text">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="openProductModal()">+ ì²« ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 60px;">ìˆœì„œ</th>
              <th>ìƒí’ˆëª…</th>
              <th>ì„¤ëª…</th>
              <th>ìƒ˜í”Œ ì „ë‹¬</th>
              <th>í˜‘ì˜ ì§„í–‰</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${state.products.map((p, idx) => {
              const sampleCount = state.sellerList.filter(s => s.productDetails && s.productDetails[p.id] && s.productDetails[p.id].sampleSent).length;
              const noteCount = state.sellerList.filter(s => s.productDetails && s.productDetails[p.id] && s.productDetails[p.id].notes && s.productDetails[p.id].notes.trim()).length;
              return `
                <tr>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button class="btn btn-secondary btn-sm" style="padding: 4px 8px;" onclick="reorderProducts('${p.id}', 'up')" ${idx === 0 ? 'disabled style="opacity:0.3;padding:4px 8px;"' : ''}>â†‘</button>
                      <button class="btn btn-secondary btn-sm" style="padding: 4px 8px;" onclick="reorderProducts('${p.id}', 'down')" ${idx === state.products.length - 1 ? 'disabled style="opacity:0.3;padding:4px 8px;"' : ''}>â†“</button>
                    </div>
                  </td>
                  <td><strong>${p.name}</strong></td>
                  <td style="color: var(--gray-500);">${p.description || '-'}</td>
                  <td>
                    <span class="status-badge status-ongoing">${sampleCount}ëª…</span>
                  </td>
                  <td>
                    <span class="status-badge status-confirmed">${noteCount}ê±´</span>
                  </td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openProductModal(state.products.find(prod=>prod.id==='${p.id}'))">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `}
    </div>
    
    ${state.products.length > 0 ? `
      <div class="card">
        <h3 class="card-title">ğŸ“Š ìƒí’ˆë³„ í˜„í™©</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
          ${state.products.map(p => {
            const sampleCount = state.sellerList.filter(s => s.productDetails && s.productDetails[p.id] && s.productDetails[p.id].sampleSent).length;
            const noteCount = state.sellerList.filter(s => s.productDetails && s.productDetails[p.id] && s.productDetails[p.id].notes && s.productDetails[p.id].notes.trim()).length;
            const totalCount = state.sellerList.length;
            const samplePercentage = totalCount > 0 ? Math.round((sampleCount / totalCount) * 100) : 0;
            return `
              <div style="padding: 16px; background: var(--gray-50); border-radius: 12px;">
                <div style="font-weight: 600; margin-bottom: 12px;">${p.name}</div>
                <div style="margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                    <span style="color: var(--gray-500);">ìƒ˜í”Œ ì „ë‹¬</span>
                    <span style="font-weight: 600; color: var(--primary);">${sampleCount}/${totalCount}</span>
                  </div>
                  <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                    <div style="height: 100%; width: ${samplePercentage}%; background: var(--primary); border-radius: 3px;"></div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                  <span style="color: var(--gray-500);">í˜‘ì˜ ì§„í–‰</span>
                  <span style="font-weight: 600; color: var(--success);">${noteCount}ê±´</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    ` : ''}
  `;
}

// ========== ê³µê¸‰ì‚¬ ìƒí’ˆ DB ë Œë”ë§ ==========
function renderProductDB() {
  const app = document.getElementById('app');
  const allProducts = state.supplierProducts || [];
  
  // ê²€ìƒ‰ í•„í„° ì ìš©
  const searchKeyword = state.productDBSearchKeyword || '';
  const products = searchKeyword 
    ? allProducts.filter(p => (p.productName || '').toLowerCase().includes(searchKeyword.toLowerCase()) || 
                              (p.brandName || '').toLowerCase().includes(searchKeyword.toLowerCase()) ||
                              (p.representativeProduct || '').toLowerCase().includes(searchKeyword.toLowerCase()))
    : allProducts;
  
  // ê³µê¸‰ì‚¬ë³„ë¡œ ê·¸ë£¹í™”
  const productsBySupplier = {};
  allProducts.forEach(p => {
    const key = p.supplierId || 'unknown';
    if (!productsBySupplier[key]) {
      productsBySupplier[key] = [];
    }
    productsBySupplier[key].push(p);
  });
  
  // í†µê³„
  const totalProducts = allProducts.length;
  const supplierCount = Object.keys(productsBySupplier).length;
  const inhouseCount = allProducts.filter(p => p.supplierType === 'inhouse').length;
  const externalCount = allProducts.filter(p => p.supplierType !== 'inhouse').length;
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ê³µê¸‰ì‚¬ ìƒí’ˆ DB</h1>
      <p class="page-desc">ê³µê¸‰ì‚¬ì—ì„œ ë°›ì€ ìƒí’ˆ ì •ë³´ë¥¼ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤. ê³µêµ¬ ë“±ë¡ ë° ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œì™€ ì—°ë™ë©ë‹ˆë‹¤.</p>
      <div class="header-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="downloadProductDBTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-secondary" onclick="openProductDBBulkModal()">ğŸ“‹ ì—‘ì…€ ì¼ê´„ë“±ë¡</button>
        <button class="btn btn-primary" onclick="openProductDBModal()">+ ìƒí’ˆ ë“±ë¡</button>
      </div>
    </div>
    
    <!-- í†µê³„ ì¹´ë“œ -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
      <div class="card" style="text-align: center; padding: 20px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${totalProducts}</div>
        <div style="font-size: 14px; color: var(--gray-500);">ì „ì²´ ìƒí’ˆ</div>
      </div>
      <div class="card" style="text-align: center; padding: 20px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--info);">${supplierCount}</div>
        <div style="font-size: 14px; color: var(--gray-500);">ê³µê¸‰ì‚¬ ìˆ˜</div>
      </div>
      <div class="card" style="text-align: center; padding: 20px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--success);">${inhouseCount}</div>
        <div style="font-size: 14px; color: var(--gray-500);">ìì‚¬ ìƒí’ˆ</div>
      </div>
      <div class="card" style="text-align: center; padding: 20px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--warning);">${externalCount}</div>
        <div style="font-size: 14px; color: var(--gray-500);">íƒ€ì‚¬ ìƒí’ˆ</div>
      </div>
    </div>
    
    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="card" style="margin-bottom: 24px; padding: 20px;">
      <div style="position: relative; max-width: 600px;">
        <input type="text" class="form-input" id="productdb-search" 
          placeholder="ğŸ” ìƒí’ˆëª…, ëŒ€í‘œìƒí’ˆ, ê³µê¸‰ì‚¬ëª… ê²€ìƒ‰ í›„ Enter" 
          value="${searchKeyword}"
          onkeydown="if(event.key==='Enter') handleProductDBSearch(this.value)"
          style="padding-left: 16px; padding-right: 40px;">
        ${searchKeyword ? `
          <button onclick="clearProductDBSearch()" 
            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-400); cursor: pointer; font-size: 18px;">Ã—</button>
        ` : ''}
      </div>
      ${searchKeyword ? `<p style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">"${searchKeyword}" ê²€ìƒ‰ ê²°ê³¼: ${products.length}ê±´</p>` : ''}
    </div>
    
    <!-- ì—°ë™ ì•ˆë‚´ -->
    <div class="card" style="margin-bottom: 24px;">
      <div style="padding: 16px; background: var(--info-light); border-radius: 12px; color: var(--info);">
        <strong>ğŸ’¡ ì´ ë°ì´í„°ëŠ” ë‹¤ìŒê³¼ ì—°ë™ë©ë‹ˆë‹¤:</strong>
        <ul style="margin: 8px 0 0 20px; font-size: 14px;">
          <li><strong>ìº˜ë¦°ë” ê³µêµ¬ ë“±ë¡</strong> - ê³µê¸‰ì‚¬ ì„ íƒ ì‹œ í•´ë‹¹ ìƒí’ˆ ëª©ë¡ì—ì„œ ì„ íƒ</li>
          <li><strong>ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œ</strong> - ì •ì‚° ê¸ˆì•¡ ì‚°ì¶œì— í™œìš©</li>
          <li><strong>ê³µêµ¬ ì§„í–‰ ê´€ë¦¬</strong> - ìƒ˜í”Œ ì „ë‹¬ ë° í˜‘ì˜ì‚¬í•­ ê´€ë¦¬</li>
        </ul>
      </div>
    </div>
    
    <!-- ìƒí’ˆ ëª©ë¡ -->
    <div class="card">
      <h3 class="card-title">ğŸ“¦ ìƒí’ˆ ëª©ë¡</h3>
      
      ${products.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ“¦</div>
          <div class="text">${searchKeyword ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤'}</div>
          <p style="color: var(--gray-500); margin: 8px 0;">${searchKeyword ? 'ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.' : 'ê³µê¸‰ì‚¬ ë©”ë‰´ì—ì„œ ìƒí’ˆì„ ë“±ë¡í•˜ê±°ë‚˜, ì—¬ê¸°ì„œ ì§ì ‘ ì¶”ê°€í•˜ì„¸ìš”.'}</p>
          ${!searchKeyword ? `<button class="btn btn-primary" style="margin-top: 16px;" onclick="openProductDBModal()">+ ì²« ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>` : ''}
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ëŒ€í‘œìƒí’ˆ</th>
                <th>ìƒí’ˆëª…(SKU)</th>
                <th style="text-align: right;">ì •ê°€(V+)</th>
                <th style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                <th style="text-align: right;">ê³µê¸‰ê°€(V+)</th>
                <th style="text-align: right;">ìˆ˜ìˆ˜ë£Œìœ¨</th>
                <th>ê³µêµ¬ ì—°ê²°</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${products.map(p => {
                const supplier = state.suppliers.find(s => s.id === p.supplierId);
                const isInhouse = p.supplierType === 'inhouse';
                // ì´ ìƒí’ˆì´ ì—°ê²°ëœ ê³µêµ¬ ìˆ˜ (selectedProductsê°€ ê°ì²´ ë°°ì—´ ë˜ëŠ” ë¬¸ìì—´ ë°°ì—´)
                const linkedDeals = state.deals.filter(d => {
                  if (!d.selectedProducts) return false;
                  return d.selectedProducts.some(item => {
                    const pid = typeof item === 'string' ? item : item.productId;
                    return pid === p.id;
                  });
                }).length;
                
                return `
                  <tr>
                    <td>
                      <span style="font-weight: 600;">${p.brandName || supplier?.name || '-'}</span>
                    </td>
                    <td>
                      <span style="color: var(--info); font-size: 13px;">${p.representativeProduct || '-'}</span>
                    </td>
                    <td><strong>${p.productName || '-'}</strong></td>
                    <td style="text-align: right;">${Number(p.originalPrice || p.retailPrice || 0).toLocaleString()}ì›</td>
                    <td style="text-align: right;">${Number(p.salePrice || 0).toLocaleString()}ì›</td>
                    <td style="text-align: right;">${Number(p.supplyPrice || 0) > 0 ? Number(p.supplyPrice).toLocaleString() + 'ì›' : '-'}</td>
                    <td style="text-align: right;">${p.commission ? p.commission + '%' : '-'}</td>
                    <td>
                      ${linkedDeals > 0 ? `<span class="status-badge status-negotiating">${linkedDeals}ê±´</span>` : '<span style="color: var(--gray-400);">-</span>'}
                    </td>
                    <td class="actions">
                      <button class="btn btn-secondary btn-sm" onclick="openProductDBModal('${p.id}')">ìˆ˜ì •</button>
                      <button class="btn btn-sm" style="background: #fee2e2; color: #dc2626;" onclick="deleteProductDB('${p.id}')">ì‚­ì œ</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ DB ê²€ìƒ‰
function handleProductDBSearch(keyword) {
  state.productDBSearchKeyword = keyword.trim();
  renderProductDB();
}

function clearProductDBSearch() {
  state.productDBSearchKeyword = '';
  renderProductDB();
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ DB ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
function downloadProductDBTemplate() {
  // ì–‘ì‹ ì‹œíŠ¸
  const headers = ['ê³µê¸‰ì‚¬ëª…', 'ëŒ€í‘œìƒí’ˆ', 'ìƒí’ˆëª…(SKU)', 'ì •ê°€(V+)', 'ê³µêµ¬íŒë§¤ê°€', 'ê³µê¸‰ê°€(V+)', 'ìˆ˜ìˆ˜ë£Œìœ¨(%)'];
  const notice = ['', '', '', '', '', 'â€» ê³µê¸‰ê°€ ë˜ëŠ” ìˆ˜ìˆ˜ë£Œìœ¨ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•˜ë©´ OK', ''];
  const example = ['ì˜ˆì‹œê³µê¸‰ì‚¬', 'ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸', 'ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸ 100ml SKU-001', '50000', '40000', '35000', ''];
  const example2 = ['ì˜ˆì‹œê³µê¸‰ì‚¬', 'ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸', 'ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸ 200ml SKU-002', '70000', '55000', '', '15'];
  const wsData = [headers, notice, example, example2];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{ wch: 15 }, { wch: 18 }, { wch: 28 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 12 }];
  
  // ì•ˆë‚´ ì‹œíŠ¸
  const guideData = [
    ['ğŸ“‹ ê³µê¸‰ì‚¬ ìƒí’ˆ DB ë“±ë¡ ì–‘ì‹ ì•ˆë‚´'],
    [''],
    ['â–¶ ì—´ ì„¤ëª…'],
    ['A. ê³µê¸‰ì‚¬ëª… *', 'ë“±ë¡ëœ ê³µê¸‰ì‚¬ëª…ê³¼ ë™ì¼í•˜ê²Œ ì…ë ¥í•´ì•¼ ìë™ ë§¤ì¹­ë©ë‹ˆë‹¤.'],
    ['B. ëŒ€í‘œìƒí’ˆ *', 'ì •ì‚° ì‹œ ê°™ì€ ëŒ€í‘œìƒí’ˆìœ¼ë¡œ ë¬¶ì–´ì„œ ì§‘ê³„ë©ë‹ˆë‹¤. (ì˜ˆ: "ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸")'],
    ['C. ìƒí’ˆëª…(SKU) *', 'ì˜µì…˜/ìš©ëŸ‰ ë“± êµ¬ì²´ì ì¸ ìƒí’ˆëª… ë˜ëŠ” SKU (ì˜ˆ: "ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸ 100ml SKU-001")'],
    ['D. ì •ê°€(V+)', 'ì†Œë¹„ì ì •ê°€ (VAT í¬í•¨)'],
    ['E. ê³µêµ¬íŒë§¤ê°€', 'ê³µë™êµ¬ë§¤ íŒë§¤ ê°€ê²©'],
    ['F. ê³µê¸‰ê°€(V+)', 'ê³µê¸‰ì‚¬ë¡œë¶€í„° ë°›ëŠ” ê³µê¸‰ ë‹¨ê°€ (VAT í¬í•¨) â­ ê³µê¸‰ê°€ ë˜ëŠ” ìˆ˜ìˆ˜ë£Œìœ¨ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•˜ë©´ OK'],
    ['G. ìˆ˜ìˆ˜ë£Œìœ¨(%)', 'íŒë§¤ ìˆ˜ìˆ˜ë£Œìœ¨ â­ ê³µê¸‰ê°€ ë˜ëŠ” ìˆ˜ìˆ˜ë£Œìœ¨ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•˜ë©´ OK'],
    [''],
    ['â–¶ ìë™ ê³„ì‚° ì•ˆë‚´'],
    ['âœ… ê³µê¸‰ê°€ ì…ë ¥ ì‹œ', 'â†’ ìˆ˜ìˆ˜ë£Œìœ¨ ìë™ ê³„ì‚°: (íŒë§¤ê°€ - ê³µê¸‰ê°€) Ã· íŒë§¤ê°€ Ã— 100'],
    ['âœ… ìˆ˜ìˆ˜ë£Œìœ¨ ì…ë ¥ ì‹œ', 'â†’ ê³µê¸‰ê°€ ìë™ ê³„ì‚°: íŒë§¤ê°€ Ã— (1 - ìˆ˜ìˆ˜ë£Œìœ¨/100)'],
    ['ğŸ’¡ ë‘˜ ë‹¤ ì…ë ¥ ì‹œ ê³µê¸‰ê°€ ìš°ì„  ì ìš©'],
    [''],
    ['â–¶ ëŒ€í‘œìƒí’ˆ í™œìš© ì˜ˆì‹œ'],
    ['ê³µê¸‰ì‚¬ëª…', 'ëŒ€í‘œìƒí’ˆ', 'ìƒí’ˆëª…(SKU)'],
    ['ë·°í‹°ìƒµ', 'ìˆ˜ë¶„í¬ë¦¼', 'ìˆ˜ë¶„í¬ë¦¼ 50ml SKU-001'],
    ['ë·°í‹°ìƒµ', 'ìˆ˜ë¶„í¬ë¦¼', 'ìˆ˜ë¶„í¬ë¦¼ 100ml SKU-002'],
    ['ë·°í‹°ìƒµ', 'ì„ í¬ë¦¼', 'ì„ í¬ë¦¼ SPF50 SKU-003'],
    ['â†’ ì •ì‚° ì‹œ "ìˆ˜ë¶„í¬ë¦¼"ìœ¼ë¡œ 2ê±´, "ì„ í¬ë¦¼"ìœ¼ë¡œ 1ê±´ ì§‘ê³„ë¨']
  ];
  const wsGuide = XLSX.utils.aoa_to_sheet(guideData);
  wsGuide['!cols'] = [{ wch: 20 }, { wch: 60 }];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ìƒí’ˆë“±ë¡ì–‘ì‹');
  XLSX.utils.book_append_sheet(wb, wsGuide, 'ğŸ“– ì‘ì„±ì•ˆë‚´');
  XLSX.writeFile(wb, 'ê³µê¸‰ì‚¬ìƒí’ˆ_ë“±ë¡ì–‘ì‹.xlsx');
  showToast('âœ… ì–‘ì‹ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ DB ì¼ê´„ë“±ë¡ ëª¨ë‹¬
function openProductDBBulkModal() {
  if (!canEdit()) { showNoPermission(); return; }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ ê³µê¸‰ì‚¬ ìƒí’ˆ ì¼ê´„ë“±ë¡</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 20px;">
        <div style="background: var(--info-light); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="color: var(--info); margin-bottom: 8px;">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì•ˆë‚´</h4>
          <p style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px;">
            ì•„ë˜ ì—´ ìˆœì„œëŒ€ë¡œ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
            <strong>ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ë¡œ ì¸ì‹ë˜ì–´ ì œì™¸ë©ë‹ˆë‹¤.</strong>
          </p>
          <table style="width: 100%; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
              <tr style="background: var(--gray-100);">
                <th style="padding: 8px; text-align: left;">A</th>
                <th style="padding: 8px; text-align: left;">B</th>
                <th style="padding: 8px; text-align: left;">C</th>
                <th style="padding: 8px; text-align: left;">D</th>
                <th style="padding: 8px; text-align: left;">E</th>
                <th style="padding: 8px; text-align: left;">F</th>
                <th style="padding: 8px; text-align: left;">G</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 8px;">ê³µê¸‰ì‚¬ëª…*</td>
                <td style="padding: 8px;">ëŒ€í‘œìƒí’ˆ*</td>
                <td style="padding: 8px;">ìƒí’ˆëª…*</td>
                <td style="padding: 8px;">ì •ê°€(V+)</td>
                <td style="padding: 8px;">ê³µêµ¬íŒë§¤ê°€</td>
                <td style="padding: 8px;">ê³µê¸‰ê°€(V+)</td>
                <td style="padding: 8px;">ìˆ˜ìˆ˜ë£Œ(%)</td>
              </tr>
            </tbody>
          </table>
          
          <!-- ìë™ê³„ì‚° ì•ˆë‚´ -->
          <div style="margin-top: 12px; padding: 12px; background: #ecfdf5; border-radius: 8px; border-left: 3px solid #10b981;">
            <p style="font-size: 12px; color: #065f46; margin: 0 0 4px 0;"><strong>ğŸ’¡ ìë™ ê³„ì‚° ê¸°ëŠ¥</strong></p>
            <p style="font-size: 11px; color: #047857; margin: 0;">
              ê³µê¸‰ê°€ ë˜ëŠ” ìˆ˜ìˆ˜ë£Œìœ¨ <strong>ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ</strong> ì…ë ¥í•˜ë©´ ë‚˜ë¨¸ì§€ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
              â€¢ ê³µê¸‰ê°€ ì…ë ¥ â†’ ìˆ˜ìˆ˜ë£Œìœ¨ = (íŒë§¤ê°€ - ê³µê¸‰ê°€) Ã· íŒë§¤ê°€ Ã— 100<br>
              â€¢ ìˆ˜ìˆ˜ë£Œìœ¨ ì…ë ¥ â†’ ê³µê¸‰ê°€ = íŒë§¤ê°€ Ã— (1 - ìˆ˜ìˆ˜ë£Œìœ¨/100)
            </p>
          </div>
          
          <!-- ëŒ€í‘œìƒí’ˆ ì•ˆë‚´ -->
          <div style="margin-top: 8px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b;">
            <p style="font-size: 12px; color: #92400e; margin: 0 0 4px 0;"><strong>ğŸ“¦ ëŒ€í‘œìƒí’ˆì´ë€?</strong></p>
            <p style="font-size: 11px; color: #a16207; margin: 0;">
              ì •ì‚° ì‹œ ê°™ì€ ëŒ€í‘œìƒí’ˆë¼ë¦¬ ë¬¶ì–´ì„œ ì§‘ê³„ë©ë‹ˆë‹¤.<br>
              ì˜ˆ: "ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸ 50ml", "ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸ 100ml" â†’ ëŒ€í‘œìƒí’ˆ: "ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸"
            </p>
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <button class="btn btn-secondary" style="width: 100%;" onclick="downloadProductDBTemplate()">
            ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì—‘ì…€ íŒŒì¼ ì„ íƒ</label>
          <input type="file" class="form-input" id="productdb-excel-file" accept=".xlsx,.xls,.csv" style="padding: 12px;">
        </div>
        
        <div id="productdb-excel-preview" style="display: none; margin-top: 16px;">
          <h4 style="margin-bottom: 12px;">ë¯¸ë¦¬ë³´ê¸°</h4>
          <div id="productdb-excel-preview-content" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" onclick="uploadProductDBExcel()">ì¼ê´„ ë“±ë¡</button>
      </div>
    </div>
  `;
  
  document.getElementById('productdb-excel-file').addEventListener('change', previewProductDBExcel);
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ DB ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸°
async function previewProductDBExcel(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const preview = document.getElementById('productdb-excel-preview');
  const content = document.getElementById('productdb-excel-preview-content');
  
  try {
    const data = await parseProductDBExcelFile(file);
    if (data.length === 0) {
      content.innerHTML = '<p style="color: var(--danger);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      preview.style.display = 'block';
      return;
    }
    
    const rows = data.slice(1);
    window.productDBExcelData = rows;
    
    content.innerHTML = `
      <p style="margin-bottom: 8px; color: var(--success);">âœ“ ${rows.length}ê°œ ìƒí’ˆ í™•ì¸ë¨</p>
      <table class="data-table" style="font-size: 12px;">
        <thead>
          <tr>
            <th>ê³µê¸‰ì‚¬</th>
            <th>ìƒí’ˆëª…(SKU)</th>
            <th>ì •ê°€</th>
            <th>íŒë§¤ê°€</th>
            <th>ê³µê¸‰ê°€</th>
            <th>ìˆ˜ìˆ˜ë£Œ</th>
          </tr>
        </thead>
        <tbody>
          ${rows.slice(0, 5).map(row => `
            <tr>
              <td>${row[0] || '-'}</td>
              <td>${row[1] || '-'}</td>
              <td>${row[2] ? Number(row[2]).toLocaleString() + 'ì›' : '-'}</td>
              <td>${row[3] ? Number(row[3]).toLocaleString() + 'ì›' : '-'}</td>
              <td>${row[4] ? Number(row[4]).toLocaleString() + 'ì›' : '-'}</td>
              <td>${row[5] ? row[5] + '%' : '-'}</td>
            </tr>
          `).join('')}
          ${rows.length > 5 ? `<tr><td colspan="6" style="text-align:center; color: var(--gray-500);">... ì™¸ ${rows.length - 5}ê°œ</td></tr>` : ''}
        </tbody>
      </table>
    `;
    preview.style.display = 'block';
  } catch (err) {
    content.innerHTML = `<p style="color: var(--danger);">íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${err.message}</p>`;
    preview.style.display = 'block';
  }
}

// ì—‘ì…€ íŒŒì¼ íŒŒì‹±
function parseProductDBExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = e.target.result;
        if (file.name.endsWith('.csv')) {
          const rows = data.split('\n').map(row => row.split(',').map(cell => cell.trim().replace(/^"|"$/g, '')));
          resolve(rows.filter(row => row.some(cell => cell)));
        } else {
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          resolve(rows);
        }
      } catch (err) {
        reject(err);
      }
    };
    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsBinaryString(file);
    }
  });
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ DB ì¼ê´„ ì—…ë¡œë“œ
async function uploadProductDBExcel() {
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!window.productDBExcelData || window.productDBExcelData.length === 0) {
    showToast('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  try {
    const batch = db.batch();
    let count = 0;
    
    for (const row of window.productDBExcelData) {
      const brandName = row[0];
      const representativeProduct = row[1];  // ëŒ€í‘œìƒí’ˆ
      const productName = row[2];
      if (!brandName || !productName) continue;

      const originalPrice = Number(row[3]) || 0;
      const salePrice = Number(row[4]) || 0;
      const supplyPrice = Number(row[5]) || 0;
      let commission = Number(row[6]) || 0;
      
      // ìë™ ê³„ì‚°
      if (supplyPrice && !commission && salePrice) {
        commission = parseFloat(((salePrice - supplyPrice) / salePrice * 100).toFixed(1));
      }
      let finalSupplyPrice = supplyPrice;
      if (!supplyPrice && commission && salePrice) {
        finalSupplyPrice = Math.round(salePrice * (1 - commission / 100));
      }
      
      // ê³µê¸‰ì‚¬ ë§¤ì¹­ (ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°)
      const matchedSupplier = state.suppliers.find(s => s.name === brandName);
      
      const docRef = db.collection('supplierProducts').doc();
      batch.set(docRef, {
        supplierId: matchedSupplier?.id || '',
        brandName,
        representativeProduct: representativeProduct || productName,  // ëŒ€í‘œìƒí’ˆ (ì—†ìœ¼ë©´ ìƒí’ˆëª…ìœ¼ë¡œ)
        productName,
        originalPrice,
        supplyPrice: finalSupplyPrice,
        salePrice,
        commission,
        supplierType: matchedSupplier?.supplierType || 'external',
        createdAt: new Date().toISOString()
      });
      count++;
    }
    
    await batch.commit();
    showToast(`âœ… ${count}ê°œ ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    closeModal();
    window.productDBExcelData = null;
  } catch (err) {
    showToast('âŒ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  }
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ ì‚­ì œ
async function deleteProductDB(productId) {
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('supplierProducts').doc(productId).delete();
    showToast('âœ… ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (err) {
    showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ========== ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (íƒìƒ‰ ìƒí’ˆ) ==========
function renderProductList() {
  const app = document.getElementById('app');
  const allItems = state.productList || [];
  
  // ê²€ìƒ‰ í•„í„°
  const searchKeyword = state.productListSearchKeyword || '';
  const items = searchKeyword 
    ? allItems.filter(p => (p.productName || '').toLowerCase().includes(searchKeyword.toLowerCase()) || 
                          (p.brandName || '').toLowerCase().includes(searchKeyword.toLowerCase()) ||
                          (p.category || '').toLowerCase().includes(searchKeyword.toLowerCase()))
    : allItems;
  
  // í†µê³„ (ìˆœì„œ: ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½)
  const totalCount = allItems.length;
  const proposedCount = allItems.filter(p => p.proposed).length;
  const contactedCount = allItems.filter(p => p.contacted).length;
  const contractedCount = allItems.filter(p => p.contracted).length;
  const notProposedCount = allItems.filter(p => !p.proposed).length;
  
  // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¶”ì¶œ
  const categories = [...new Set(allItems.map(p => p.category).filter(c => c))];
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ìƒí’ˆ ë¦¬ìŠ¤íŠ¸</h1>
      <p class="page-desc">ì´ ${totalCount}ê°œì˜ íƒìƒ‰ ìƒí’ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="downloadProductListTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-secondary" onclick="openProductListBulkModal()">ğŸ“‹ ì¼ê´„ë“±ë¡</button>
        <button class="btn btn-primary" onclick="openProductListModal()">+ ìƒí’ˆ ì¶”ê°€</button>
      </div>
    </div>
    
    <!-- í†µê³„ ì¹´ë“œ (ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½ ìˆœì„œ) -->
    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ìƒí’ˆ</div>
        <div class="stat-value">${totalCount}ê°œ</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #16a34a;">âœ… ì œì•ˆì™„ë£Œ</div>
        <div class="stat-value" style="color: #22c55e;">${proposedCount}ê°œ</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #1e40af;">ğŸ“ ì»¨íƒì™„ë£Œ</div>
        <div class="stat-value" style="color: #3b82f6;">${contactedCount}ê°œ</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-label">ğŸ‰ ê³„ì•½ì™„ë£Œ</div>
        <div class="stat-value">${contractedCount}ê°œ</div>
      </div>
    </div>
    
    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="card" style="margin-bottom: 16px; padding: 16px;">
      <div style="position: relative; max-width: 600px;">
        <input type="text" class="form-input" id="productlist-search" 
          placeholder="ìƒí’ˆëª…, ë¸Œëœë“œëª…, ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ í›„ Enter" 
          value="${searchKeyword}"
          onkeydown="if(event.key==='Enter') handleProductListSearch(this.value)"
          style="padding-left: 16px; padding-right: 40px;">
        ${searchKeyword ? `
          <button onclick="clearProductListSearch()" 
            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-400); cursor: pointer; font-size: 18px;">Ã—</button>
        ` : ''}
      </div>
      ${searchKeyword ? `<p style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">"${searchKeyword}" ê²€ìƒ‰ ê²°ê³¼: ${items.length}ê±´</p>` : ''}
    </div>
    
    <!-- ìƒíƒœ í•„í„° (ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½ ìˆœì„œ) -->
    <div class="card" style="margin-bottom: 16px;">
      <div class="filter-bar">
        <div class="filter-group">
          <button class="filter-btn ${!window.productListStatusFilter ? 'active' : ''}" onclick="filterProductListByStatus('')">ì „ì²´</button>
          <button class="filter-btn ${window.productListStatusFilter === 'notProposed' ? 'active' : ''}" onclick="filterProductListByStatus('notProposed')" style="color: #d97706;">ë¯¸ì œì•ˆ</button>
          <button class="filter-btn ${window.productListStatusFilter === 'proposed' ? 'active' : ''}" onclick="filterProductListByStatus('proposed')" style="color: #16a34a;">ì œì•ˆì™„ë£Œ</button>
          <button class="filter-btn ${window.productListStatusFilter === 'contacted' ? 'active' : ''}" onclick="filterProductListByStatus('contacted')" style="color: #1d4ed8;">ì»¨íƒì™„ë£Œ</button>
          <button class="filter-btn ${window.productListStatusFilter === 'contracted' ? 'active' : ''}" onclick="filterProductListByStatus('contracted')" style="color: #7c3aed;">ê³„ì•½ì™„ë£Œ</button>
        </div>
      </div>
    </div>
    
    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
    ${categories.length > 0 ? `
      <div class="card" style="margin-bottom: 16px;">
        <div class="filter-bar">
          <div class="filter-group">
            <span style="font-size: 13px; color: var(--gray-500); margin-right: 8px;">ì¹´í…Œê³ ë¦¬:</span>
            <button class="filter-btn ${!window.productListCategoryFilter ? 'active' : ''}" onclick="filterProductListByCategory('')">ì „ì²´</button>
            ${categories.map(cat => `
              <button class="filter-btn ${window.productListCategoryFilter === cat ? 'active' : ''}" onclick="filterProductListByCategory('${cat}')">${cat}</button>
            `).join('')}
          </div>
        </div>
      </div>
    ` : ''}
    
    <!-- ìƒí’ˆ ëª©ë¡ -->
    <div class="card">
      <h3 class="card-title">íƒìƒ‰ ìƒí’ˆ ëª©ë¡</h3>
      
      ${items.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ“¦</div>
          <div class="text">${searchKeyword ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ë“±ë¡ëœ íƒìƒ‰ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤'}</div>
          <p style="color: var(--gray-500); margin: 8px 0;">${searchKeyword ? 'ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.' : 'ê³µêµ¬ ì œì•ˆì„ ìœ„í•œ ìƒí’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”.'}</p>
          ${!searchKeyword ? `<button class="btn btn-primary" style="margin-top: 16px;" onclick="openProductListModal()">+ ì²« ìƒí’ˆ ì¶”ê°€í•˜ê¸°</button>` : ''}
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ë¸Œëœë“œ/ê³µê¸‰ì‚¬</th>
                <th>ìƒí’ˆëª…(SKU)</th>
                <th style="text-align: right;">ì˜ˆìƒ íŒë§¤ê°€</th>
                <th>ì¶œì²˜/ë§í¬</th>
                <th style="text-align: center;">ì œì•ˆ</th>
                <th style="text-align: center;">ì»¨íƒ</th>
                <th style="text-align: center;">ê³„ì•½</th>
                <th>ë‹´ë‹¹ì</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${items
                .filter(p => {
                  if (window.productListCategoryFilter && p.category !== window.productListCategoryFilter) return false;
                  if (window.productListStatusFilter === 'notProposed' && p.proposed) return false;
                  if (window.productListStatusFilter === 'proposed' && (!p.proposed || p.contacted)) return false;
                  if (window.productListStatusFilter === 'contacted' && (!p.contacted || p.contracted)) return false;
                  if (window.productListStatusFilter === 'contracted' && !p.contracted) return false;
                  return true;
                })
                .map(p => {
                  // í–‰ ë°°ê²½ìƒ‰ ê²°ì • (ê³„ì•½ > ì»¨íƒ > ì œì•ˆ > ë¯¸ì œì•ˆ)
                  let rowBg = '';
                  if (p.contracted) {
                    rowBg = 'background: #f5f3ff;'; // ì—°í•œ ë³´ë¼
                  } else if (p.contacted) {
                    rowBg = 'background: #eff6ff;'; // ì—°í•œ íŒŒë‘
                  } else if (p.proposed) {
                    rowBg = 'background: #f0fdf4;'; // ì—°í•œ ì´ˆë¡
                  } else {
                    rowBg = 'background: #fffbeb;'; // ì—°í•œ ë…¸ë‘
                  }
                  const createdByName = p.createdBy ? p.createdBy.split('@')[0] : '-';
                  return `
                <tr style="${rowBg}">
                  <td>${p.category ? `<span class="status-badge status-confirmed" style="font-size: 11px;">${p.category}</span>` : '-'}</td>
                  <td><strong>${p.brandName || '-'}</strong></td>
                  <td>
                    <div>${p.productName || '-'}</div>
                    ${p.notes ? `<div style="font-size: 11px; color: var(--gray-500); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${p.notes}">${p.notes}</div>` : ''}
                  </td>
                  <td style="text-align: right;">${p.expectedPrice ? Number(p.expectedPrice).toLocaleString() + 'ì›' : '-'}</td>
                  <td>${p.sourceLink ? `<a href="${p.sourceLink.startsWith('http') ? p.sourceLink : 'https://' + p.sourceLink}" target="_blank" style="color: var(--primary);">ë§í¬</a>` : (p.source || '-')}</td>
                  <td style="text-align: center;">
                    <label class="checkbox-wrapper" style="padding: 6px 10px; display: inline-flex; background: white; border-radius: 6px; border: 2px solid ${p.proposed ? '#22c55e' : '#e5e7eb'}; cursor: pointer;" onclick="event.stopPropagation(); toggleProductListField('${p.id}', 'proposed', ${!p.proposed})">
                      <input type="checkbox" ${p.proposed ? 'checked' : ''} style="pointer-events: none;">
                    </label>
                  </td>
                  <td style="text-align: center;">
                    <label class="checkbox-wrapper" style="padding: 6px 10px; display: inline-flex; background: white; border-radius: 6px; border: 2px solid ${p.contacted ? '#3b82f6' : '#e5e7eb'}; cursor: pointer;" onclick="event.stopPropagation(); toggleProductListField('${p.id}', 'contacted', ${!p.contacted})">
                      <input type="checkbox" ${p.contacted ? 'checked' : ''} style="pointer-events: none;">
                    </label>
                  </td>
                  <td style="text-align: center;">
                    <label class="checkbox-wrapper" style="padding: 6px 10px; display: inline-flex; background: ${p.contracted ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'white'}; border-radius: 6px; border: 2px solid ${p.contracted ? '#8b5cf6' : '#e5e7eb'}; cursor: pointer;" onclick="event.stopPropagation(); toggleProductListField('${p.id}', 'contracted', ${!p.contracted})">
                      <input type="checkbox" ${p.contracted ? 'checked' : ''} style="pointer-events: none; ${p.contracted ? 'filter: brightness(10);' : ''}">
                    </label>
                  </td>
                  <td><span style="font-size: 11px; color: var(--gray-500);">${createdByName}</span></td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openProductListModal('${p.id}')">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;}).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

// ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ê²€ìƒ‰
function handleProductListSearch(keyword) {
  state.productListSearchKeyword = keyword.trim();
  renderProductList();
}

function clearProductListSearch() {
  state.productListSearchKeyword = '';
  renderProductList();
}

function filterProductListByCategory(category) {
  window.productListCategoryFilter = category;
  renderProductList();
}

function filterProductListByStatus(status) {
  window.productListStatusFilter = status;
  renderProductList();
}

// ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ í•„ë“œ í† ê¸€
async function toggleProductListField(id, field, value) {
  // ì œì•ˆ ì²´í¬ ì‹œ ì œì•ˆë‚´ìš© ì…ë ¥ ëª¨ë‹¬ ë„ìš°ê¸°
  if (field === 'proposed' && value === true) {
    showProductProposalModal(id);
    return;
  }
  
  try {
    await db.collection('productList').doc(id).update({ 
      [field]: value,
      updatedAt: new Date().toISOString(),
      updatedBy: getCurrentUserId()
    });
    
    // ê³„ì•½ ì™„ë£Œ ì‹œ ê³µê¸‰ì‚¬ DB ë“±ë¡ í™•ì¸
    if (field === 'contracted' && value === true) {
      const product = state.productList.find(p => p.id === id);
      if (product) {
        showSupplierContractConfirmModal(product);
      }
    }
  } catch(e) {
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ìƒí’ˆ ì œì•ˆ ë‚´ìš© ì…ë ¥ ëª¨ë‹¬
function showProductProposalModal(productId) {
  const product = state.productList.find(p => p.id === productId);
  if (!product) return;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“ ì œì•ˆ ë‚´ìš© ì…ë ¥</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 20px;">
        <div style="background: #dcfce7; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <div style="font-weight: 600; color: #16a34a; margin-bottom: 4px;">${product.productName || '-'}</div>
          <div style="font-size: 13px; color: #15803d;">${product.brandName || '-'} Â· ${product.category || '-'}</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œì•ˆ ë‚´ìš© <span style="color: var(--danger);">*</span></label>
          <textarea class="form-textarea" id="product-proposal-content" rows="4" placeholder="ì˜ˆ: ê³µë™êµ¬ë§¤ ì§„í–‰ ì œì•ˆ, ìˆ˜ìˆ˜ë£Œìœ¨ í˜‘ì˜, ìƒ˜í”Œ ìš”ì²­...">${product.proposalContent || ''}</textarea>
          <small style="color: var(--gray-500); font-size: 11px;">ê³µê¸‰ì‚¬ì— ì–´ë–¤ ì œì•ˆì„ í–ˆëŠ”ì§€ ê¸°ë¡í•˜ì„¸ìš”</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œì•ˆ ì¼ì</label>
          <input type="date" class="form-input" id="product-proposal-date" value="${product.proposalDate || new Date().toISOString().split('T')[0]}">
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" style="background: #22c55e;" onclick="submitProductProposal('${productId}')">âœ… ì œì•ˆ ì™„ë£Œ</button>
      </div>
    </div>
  `;
}

// ìƒí’ˆ ì œì•ˆ ì €ì¥
async function submitProductProposal(productId) {
  const content = document.getElementById('product-proposal-content').value.trim();
  const date = document.getElementById('product-proposal-date').value;
  
  if (!content) {
    showToast('ì œì•ˆ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  try {
    await db.collection('productList').doc(productId).update({
      proposed: true,
      proposalContent: content,
      proposalDate: date,
      updatedAt: new Date().toISOString(),
      updatedBy: getCurrentUserId()
    });
    
    showToast('âœ… ì œì•ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ìƒí’ˆ ê³„ì•½ ì™„ë£Œ ì‹œ ê³µê¸‰ì‚¬ DB ë“±ë¡ í™•ì¸ ëª¨ë‹¬
function showSupplierContractConfirmModal(product) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>ğŸ‰ ê³µê¸‰ ê³„ì•½ ì™„ë£Œ!</h3>
        <button class="close-btn" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 30px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div>
        <h4 style="color: #16a34a; margin-bottom: 8px;">${product.brandName || product.productName}</h4>
        <p style="color: var(--gray-600); margin-bottom: 24px;">ê³µê¸‰ì‚¬ì™€ ê³„ì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        
        <div style="background: #f0fdf4; border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: left;">
          <div style="font-weight: 600; color: #15803d; margin-bottom: 8px;">ğŸ“‹ ìƒí’ˆ ì •ë³´</div>
          <div style="font-size: 13px; color: var(--gray-600); line-height: 1.8;">
            <div>â€¢ ì¹´í…Œê³ ë¦¬: ${product.category || '-'}</div>
            <div>â€¢ ë¸Œëœë“œ/ê³µê¸‰ì‚¬: ${product.brandName || '-'}</div>
            <div>â€¢ ìƒí’ˆëª…: ${product.productName || '-'}</div>
            <div>â€¢ ì˜ˆìƒ íŒë§¤ê°€: ${product.expectedPrice ? Number(product.expectedPrice).toLocaleString() + 'ì›' : '-'}</div>
          </div>
        </div>
        
        <p style="font-size: 14px; color: var(--gray-700); margin-bottom: 20px;">
          <strong>ê³µê¸‰ì‚¬ DB</strong>ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
          <span style="font-size: 12px; color: var(--gray-500);">ë“±ë¡í•˜ë©´ íŒ€ì› ì‹¤ì ì˜ "ê³µê¸‰ì‚¬" ìˆ˜ì— ë°˜ì˜ë©ë‹ˆë‹¤.</span>
        </p>
        
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button class="btn btn-secondary" onclick="closeModal()">ë‚˜ì¤‘ì—</button>
          <button class="btn btn-primary" style="background: linear-gradient(135deg, #22c55e, #16a34a);" onclick="registerSupplierFromList('${product.id}')">
            ê³µê¸‰ì‚¬ DBì— ë“±ë¡
          </button>
        </div>
      </div>
    </div>
  `;
}

// ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê³µê¸‰ì‚¬ DBë¡œ ë“±ë¡
async function registerSupplierFromList(productListId) {
  const product = state.productList.find(p => p.id === productListId);
  if (!product) {
    showToast('ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  try {
    // ê³µê¸‰ì‚¬ DBì— ì¶”ê°€
    const newSupplier = {
      name: product.brandName || product.productName,
      category: product.category || '',
      contactName: '',
      contactPhone: '',
      contactEmail: '',
      registeredBy: state.currentUser?.id || '',
      createdAt: new Date().toISOString(),
      createdBy: getCurrentUserId(),
      sourceProductListId: productListId, // ì›ë³¸ ìƒí’ˆë¦¬ìŠ¤íŠ¸ ID ì—°ê²°
      status: 'ê³„ì•½ì™„ë£Œ',
      mainProducts: product.productName || ''
    };
    
    await db.collection('suppliers').add(newSupplier);
    
    // ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ ì™„ë£Œ í‘œì‹œ
    await db.collection('productList').doc(productListId).update({
      registeredToSupplierDB: true,
      registeredToSupplierDBAt: new Date().toISOString()
    });
    
    showToast('ğŸ‰ ê³µê¸‰ì‚¬ DBì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì œì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateProductListProposalStatus(id, status) {
  try {
    await db.collection('productList').doc(id).update({ proposalStatus: status });
    showToast('âœ… ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch(e) {
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
function downloadProductListTemplate() {
  const headers = ['ì¹´í…Œê³ ë¦¬', 'ë¸Œëœë“œ/ê³µê¸‰ì‚¬ëª…', 'ìƒí’ˆëª…(SKU)', 'ì˜ˆìƒíŒë§¤ê°€', 'ì¶œì²˜', 'ë§í¬', 'ë¹„ê³ '];
  const example = ['ë·°í‹°', 'ì˜ˆì‹œë¸Œëœë“œ', 'ì˜ˆì‹œìƒí’ˆ SKU-001', '50000', 'ì¸ìŠ¤íƒ€ê·¸ë¨', 'https://example.com', 'ë©”ëª¨'];
  const wsData = [headers, example];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 25 }, { wch: 20 }];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ìƒí’ˆë“±ë¡ì–‘ì‹');
  XLSX.writeFile(wb, 'íƒìƒ‰ìƒí’ˆ_ë“±ë¡ì–‘ì‹.xlsx');
  showToast('âœ… ì–‘ì‹ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ë“±ë¡ ëª¨ë‹¬
function openProductListBulkModal() {
  if (!canEdit()) { showNoPermission(); return; }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ íƒìƒ‰ ìƒí’ˆ ì¼ê´„ë“±ë¡</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 20px;">
        <div style="background: var(--info-light); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="color: var(--info); margin-bottom: 8px;">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì•ˆë‚´</h4>
          <p style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px;">
            ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ë¡œ ì¸ì‹ë˜ì–´ ì œì™¸ë©ë‹ˆë‹¤.
          </p>
          <table style="width: 100%; font-size: 11px; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
              <tr style="background: var(--gray-100);">
                <th style="padding: 6px;">A</th>
                <th style="padding: 6px;">B</th>
                <th style="padding: 6px;">C</th>
                <th style="padding: 6px;">D</th>
                <th style="padding: 6px;">E</th>
                <th style="padding: 6px;">F</th>
                <th style="padding: 6px;">G</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 6px;">ì¹´í…Œê³ ë¦¬</td>
                <td style="padding: 6px;">ë¸Œëœë“œëª…</td>
                <td style="padding: 6px;">ìƒí’ˆëª…(SKU)*</td>
                <td style="padding: 6px;">ì˜ˆìƒê°€</td>
                <td style="padding: 6px;">ì¶œì²˜</td>
                <td style="padding: 6px;">ë§í¬</td>
                <td style="padding: 6px;">ë¹„ê³ </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div style="margin-bottom: 16px;">
          <button class="btn btn-secondary" style="width: 100%;" onclick="downloadProductListTemplate()">
            ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì—‘ì…€ íŒŒì¼ ì„ íƒ</label>
          <input type="file" class="form-input" id="productlist-excel-file" accept=".xlsx,.xls,.csv" style="padding: 12px;">
        </div>
        
        <div id="productlist-excel-preview" style="display: none; margin-top: 16px;"></div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" onclick="uploadProductListExcel()">ì¼ê´„ ë“±ë¡</button>
      </div>
    </div>
  `;
  
  document.getElementById('productlist-excel-file').addEventListener('change', previewProductListExcel);
}

// ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸°
async function previewProductListExcel(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const preview = document.getElementById('productlist-excel-preview');
  
  try {
    const data = await parseProductDBExcelFile(file);
    if (data.length === 0) {
      preview.innerHTML = '<p style="color: var(--danger);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      preview.style.display = 'block';
      return;
    }
    
    const rows = data.slice(1);
    window.productListExcelData = rows;
    
    preview.innerHTML = `
      <p style="margin-bottom: 8px; color: var(--success);">âœ“ ${rows.length}ê°œ ìƒí’ˆ í™•ì¸ë¨</p>
      <div style="max-height: 200px; overflow-y: auto;">
        <table class="data-table" style="font-size: 11px;">
          <thead>
            <tr><th>ì¹´í…Œê³ ë¦¬</th><th>ë¸Œëœë“œ</th><th>ìƒí’ˆëª…</th><th>ì˜ˆìƒê°€</th><th>ì¶œì²˜</th></tr>
          </thead>
          <tbody>
            ${rows.slice(0, 5).map(row => `
              <tr>
                <td>${row[0] || '-'}</td>
                <td>${row[1] || '-'}</td>
                <td>${row[2] || '-'}</td>
                <td>${row[3] ? Number(row[3]).toLocaleString() : '-'}</td>
                <td>${row[4] || '-'}</td>
              </tr>
            `).join('')}
            ${rows.length > 5 ? `<tr><td colspan="5" style="text-align:center; color: var(--gray-500);">... ì™¸ ${rows.length - 5}ê°œ</td></tr>` : ''}
          </tbody>
        </table>
      </div>
    `;
    preview.style.display = 'block';
  } catch (err) {
    preview.innerHTML = `<p style="color: var(--danger);">íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${err.message}</p>`;
    preview.style.display = 'block';
  }
}

// ì¼ê´„ ì—…ë¡œë“œ
async function uploadProductListExcel() {
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!window.productListExcelData || window.productListExcelData.length === 0) {
    showToast('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  try {
    const batch = db.batch();
    let count = 0;
    
    for (const row of window.productListExcelData) {
      const productName = row[2];
      if (!productName) continue;
      
      const docRef = db.collection('productList').doc();
      batch.set(docRef, {
        category: row[0] || '',
        brandName: row[1] || '',
        productName,
        expectedPrice: Number(row[3]) || 0,
        source: row[4] || '',
        sourceLink: row[5] || '',
        notes: row[6] || '',
        contacted: false,
        proposalStatus: '',
        createdAt: new Date().toISOString()
      });
      count++;
    }
    
    await batch.commit();
    showToast(`âœ… ${count}ê°œ ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    closeModal();
    window.productListExcelData = null;
  } catch (err) {
    showToast('âŒ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  }
}

// ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬
function openProductListModal(itemId = null) {
  if (!canEdit()) { showNoPermission(); return; }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  const isEdit = itemId !== null;
  const p = isEdit ? state.productList.find(item => item.id === itemId) : {};
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ìƒí’ˆ ìˆ˜ì •' : 'íƒìƒ‰ ìƒí’ˆ ì¶”ê°€'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="saveProductListItem(event, '${itemId || ''}')">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <input type="text" class="form-input" id="pl-category" value="${p.category || ''}" placeholder="ì˜ˆ: ë·°í‹°, ì‹í’ˆ, ê°€ì „">
          </div>
          <div class="form-group">
            <label class="form-label">ë¸Œëœë“œ/ê³µê¸‰ì‚¬ëª…</label>
            <input type="text" class="form-input" id="pl-brand" value="${p.brandName || ''}" placeholder="ë¸Œëœë“œ ë˜ëŠ” ê³µê¸‰ì‚¬ëª…">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ìƒí’ˆëª…(SKU) *</label>
          <input type="text" class="form-input" id="pl-name" value="${p.productName || ''}" required placeholder="ìƒí’ˆëª… ë˜ëŠ” SKUë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì˜ˆìƒ íŒë§¤ê°€ (ì›)</label>
            <input type="number" class="form-input" id="pl-price" value="${p.expectedPrice || ''}" placeholder="ì˜ˆìƒ íŒë§¤ ê°€ê²©">
          </div>
          <div class="form-group">
            <label class="form-label">ì¶œì²˜</label>
            <input type="text" class="form-input" id="pl-source" value="${p.source || ''}" placeholder="ì˜ˆ: ì¸ìŠ¤íƒ€ê·¸ë¨, ë„¤ì´ë²„">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ë§í¬</label>
          <input type="url" class="form-input" id="pl-link" value="${p.sourceLink || ''}" placeholder="ìƒí’ˆ í˜ì´ì§€ URL">
        </div>
        
        <!-- ì§„í–‰ ìƒíƒœ (ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½ ìˆœì„œ) -->
        <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
          <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">ì§„í–‰ ìƒíƒœ <span style="font-weight: 400; font-size: 12px; color: var(--gray-500);">(ì œì•ˆ â†’ ì»¨íƒ â†’ ê³„ì•½)</span></h4>
          <div style="display: flex; gap: 16px; flex-wrap: wrap;">
            <label class="checkbox-wrapper" style="padding: 10px 16px; background: white; border-radius: 8px; border: 2px solid ${p.proposed ? '#22c55e' : '#e5e7eb'};">
              <input type="checkbox" id="pl-proposed" ${p.proposed ? 'checked' : ''}>
              <span style="font-weight: 500; color: ${p.proposed ? '#16a34a' : 'inherit'};">â‘  ì œì•ˆì™„ë£Œ</span>
            </label>
            <label class="checkbox-wrapper" style="padding: 10px 16px; background: white; border-radius: 8px; border: 2px solid ${p.contacted ? '#3b82f6' : '#e5e7eb'};">
              <input type="checkbox" id="pl-contacted" ${p.contacted ? 'checked' : ''}>
              <span style="font-weight: 500; color: ${p.contacted ? '#1d4ed8' : 'inherit'};">â‘¡ ì»¨íƒì™„ë£Œ</span>
            </label>
            <label class="checkbox-wrapper" style="padding: 10px 16px; background: ${p.contracted ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'white'}; border-radius: 8px; border: 2px solid ${p.contracted ? '#8b5cf6' : '#e5e7eb'};">
              <input type="checkbox" id="pl-contracted" ${p.contracted ? 'checked' : ''}>
              <span style="font-weight: 500; color: ${p.contracted ? 'white' : 'inherit'};">â‘¢ ê³„ì•½ì™„ë£Œ</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ë¹„ê³ </label>
          <textarea class="form-textarea" id="pl-notes" rows="3" placeholder="ë©”ëª¨ (ê³µêµ¬ ì œì•ˆ ì‹œ ì°¸ê³ ì‚¬í•­ ë“±)">${p.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn" style="background: #fee2e2; color: #dc2626;" onclick="deleteProductListItem('${itemId}')">ì‚­ì œ</button>` : ''}
          <div style="margin-left: auto; display: flex; gap: 8px;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ì¶”ê°€í•˜ê¸°'}</button>
          </div>
        </div>
      </form>
    </div>
  `;
}

// ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì €ì¥
async function saveProductListItem(e, itemId) {
  e.preventDefault();
  if (!canEdit()) { showNoPermission(); return; }
  
  const data = {
    category: document.getElementById('pl-category').value,
    brandName: document.getElementById('pl-brand').value,
    productName: document.getElementById('pl-name').value,
    expectedPrice: Number(document.getElementById('pl-price').value) || 0,
    source: document.getElementById('pl-source').value,
    sourceLink: document.getElementById('pl-link').value,
    proposed: document.getElementById('pl-proposed').checked,
    contacted: document.getElementById('pl-contacted').checked,
    contracted: document.getElementById('pl-contracted').checked,
    notes: document.getElementById('pl-notes').value,
    updatedAt: new Date().toISOString(),
    updatedBy: getCurrentUserId()
  };
  
  try {
    if (itemId) {
      await db.collection('productList').doc(itemId).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      data.createdBy = getCurrentUserId();
      await db.collection('productList').add(data);
    }
    showToast('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (err) {
    showToast('âŒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì‚­ì œ
async function deleteProductListItem(itemId) {
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('productList').doc(itemId).delete();
    showToast('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (err) {
    showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ DB ëª¨ë‹¬
function openProductDBModal(productId = null) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  const isEdit = productId !== null;
  const p = isEdit ? state.supplierProducts.find(prod => prod.id === productId) : {
    supplierId: '', brandName: '', productName: '', representativeProduct: '', supplierType: 'external',
    retailPrice: '', salePrice: '', supplyPrice: '', marginFee: ''
  };
  
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ìƒí’ˆ ìˆ˜ì •' : 'ìƒˆ ìƒí’ˆ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitProductDBForm(event, '${productId || ''}')">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ê³µê¸‰ì‚¬ ì„ íƒ *</label>
            <select class="form-select" id="pdb-supplier" required onchange="updateProductDBSupplierInfo()">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${state.suppliers.map(s => `<option value="${s.id}" data-type="${s.supplierType || 'external'}" ${p.supplierId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ìœ í˜•</label>
            <select class="form-select" id="pdb-type" disabled style="background: var(--gray-100);">
              <option value="external" ${p.supplierType !== 'inhouse' ? 'selected' : ''}>íƒ€ì‚¬ (ê³µê¸‰ë‹¨ê°€ ë°©ì‹)</option>
              <option value="inhouse" ${p.supplierType === 'inhouse' ? 'selected' : ''}>ìì‚¬ (ë§ˆì§„ ë°©ì‹)</option>
            </select>
            <small style="color: var(--gray-500); font-size: 11px;">ê³µê¸‰ì‚¬ ì„ íƒ ì‹œ ìë™ ì„¤ì •</small>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ëŒ€í‘œìƒí’ˆ *</label>
          <input type="text" class="form-input" id="pdb-representative" value="${p.representativeProduct || ''}" required placeholder="ì˜ˆ: ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸ (ì •ì‚° ì‹œ ë¬¶ìŒ ê¸°ì¤€)">
          <small style="color: var(--gray-500); font-size: 11px;">ì •ì‚° ì‹œ ê°™ì€ ëŒ€í‘œìƒí’ˆìœ¼ë¡œ ë¬¶ì–´ì„œ ì§‘ê³„ë©ë‹ˆë‹¤.</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">ìƒí’ˆëª…(SKU) *</label>
          <input type="text" class="form-input" id="pdb-name" value="${p.productName || ''}" required placeholder="ì˜ˆ: ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸ 100ml SKU-001">
        </div>

        <div class="form-group">
          <label class="form-label">ì •ê°€ (V+, ì›)</label>
          <input type="number" class="form-input" id="pdb-original" value="${p.originalPrice || p.retailPrice || ''}" placeholder="ì†Œë¹„ì ì •ê°€">
        </div>
        
        <div class="form-group">
          <label class="form-label">ê³µêµ¬ íŒë§¤ê°€ (V+, ì›) *</label>
          <input type="number" class="form-input" id="pdb-sale" value="${p.salePrice || ''}" required placeholder="ê³µë™êµ¬ë§¤ íŒë§¤ê°€" oninput="calcProductDBCommission()">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ê³µê¸‰ë‹¨ê°€ (V+, ì›)</label>
            <input type="number" class="form-input" id="pdb-supply" value="${p.supplyPrice || ''}" placeholder="VAT í¬í•¨ ê³µê¸‰ê°€" oninput="calcProductDBCommission()">
            <small style="color: var(--gray-500); font-size: 11px;">ìˆ˜ìˆ˜ë£Œì™€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥</small>
          </div>
          <div class="form-group">
            <label class="form-label">ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
            <input type="number" class="form-input" id="pdb-commission" value="${p.commission || ''}" step="any" min="0" max="100" placeholder="ìˆ˜ìˆ˜ë£Œ" oninput="calcProductDBSupply()">
            <small style="color: var(--gray-500); font-size: 11px;">ê³µê¸‰ë‹¨ê°€ì™€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥</small>
          </div>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteProductDB('${productId}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
}

// ê³µê¸‰ë‹¨ê°€ â†’ ìˆ˜ìˆ˜ë£Œ ìë™ê³„ì‚°
function calcProductDBCommission() {
  const supply = Number(document.getElementById('pdb-supply').value);
  const sale = Number(document.getElementById('pdb-sale').value);
  if (supply && sale && sale > 0) {
    const commission = ((sale - supply) / sale * 100).toFixed(1);
    document.getElementById('pdb-commission').value = commission;
  }
}

// ìˆ˜ìˆ˜ë£Œ â†’ ê³µê¸‰ë‹¨ê°€ ìë™ê³„ì‚°
function calcProductDBSupply() {
  const commission = Number(document.getElementById('pdb-commission').value);
  const sale = Number(document.getElementById('pdb-sale').value);
  if (commission && sale && sale > 0) {
    const supply = Math.round(sale * (1 - commission / 100));
    document.getElementById('pdb-supply').value = supply;
  }
}

function updateProductDBSupplierInfo() {
  const select = document.getElementById('pdb-supplier');
  const option = select.options[select.selectedIndex];
  if (option && option.dataset.type) {
    document.getElementById('pdb-type').value = option.dataset.type === 'inhouse' ? 'inhouse' : 'external';
  }
}

async function submitProductDBForm(e, id) {
  e.preventDefault();
  
  const supplierId = document.getElementById('pdb-supplier').value;
  const supplier = state.suppliers.find(s => s.id === supplierId);
  
  const data = {
    supplierId: supplierId,
    brandName: supplier?.name || '',
    supplierType: document.getElementById('pdb-type').value,
    representativeProduct: document.getElementById('pdb-representative').value,
    productName: document.getElementById('pdb-name').value,
    originalPrice: Number(document.getElementById('pdb-original').value) || 0,
    salePrice: Number(document.getElementById('pdb-sale').value) || 0,
    supplyPrice: Number(document.getElementById('pdb-supply').value) || 0,
    commission: Number(document.getElementById('pdb-commission').value) || 0,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (id) {
      await db.collection('supplierProducts').doc(id).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('supplierProducts').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteProductDB(id) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ìƒí’ˆê³¼ ì—°ê²°ëœ ê³µêµ¬ ë°ì´í„°ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
  try {
    await db.collection('supplierProducts').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ========== ê³µêµ¬ ì§„í–‰ ê´€ë¦¬ ë Œë”ë§ ==========
function renderDealManagement() {
  const app = document.getElementById('app');
  
  // D-Day ê³„ì‚° í•¨ìˆ˜ (Xì¼ ì¤‘ Yì¼ì°¨ í˜•ì‹)
  const calcDday = (startDate, endDate) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(0, 0, 0, 0);
    
    // ì´ ì¼ìˆ˜ ê³„ì‚° (ì‹œì‘ì¼~ì¢…ë£Œì¼ í¬í•¨)
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    
    if (today < start) {
      const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
      return { text: `D-${diff}`, color: 'var(--info)', status: 'upcoming' };
    } else if (today >= start && today <= end) {
      // í˜„ì¬ ëª‡ ì¼ì°¨ì¸ì§€ ê³„ì‚°
      const currentDay = Math.ceil((today - start) / (1000 * 60 * 60 * 24)) + 1;
      return { text: `${totalDays}ì¼ ì¤‘ ${currentDay}ì¼ì°¨`, color: 'var(--danger)', status: 'ongoing' };
    } else {
      return { text: 'ì¢…ë£Œ', color: 'var(--gray-400)', status: 'ended' };
    }
  };
  
  // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ íŒë‹¨
  const isOngoingDeal = (deal) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = new Date(deal.startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(deal.endDate);
    end.setHours(0, 0, 0, 0);
    return today >= start && today <= end;
  };
  
  const isUpcomingDeal = (deal) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = new Date(deal.startDate);
    start.setHours(0, 0, 0, 0);
    return today < start;
  };
  
  // í˜‘ì˜ì¤‘ ê³µêµ¬
  const negotiatingDeals = state.deals.filter(d => d.status === 'negotiating')
    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
  
  // ì „ì²´ í™œì„± ê³µêµ¬ (í˜‘ì˜ì¤‘ ì œì™¸í•œ ëª¨ë“  ê³µêµ¬)
  const activeDeals = state.deals.filter(d => d.status !== 'negotiating');
  
  // ì§„í–‰ì¤‘ (ì‹œì‘ì¼ <= ì˜¤ëŠ˜ <= ì¢…ë£Œì¼)
  const ongoingDeals = activeDeals.filter(d => isOngoingDeal(d))
    .sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
  
  // ì§„í–‰ ì˜ˆì • (ì˜¤ëŠ˜ < ì‹œì‘ì¼)
  const upcomingDeals = activeDeals.filter(d => isUpcomingDeal(d))
    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
  
  // ì™„ë£Œëœ ê³µêµ¬ (ì˜¤ëŠ˜ > ì¢…ë£Œì¼) - ë‚ ì§œ ê¸°ë°˜
  const completedDeals = activeDeals.filter(d => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const end = new Date(d.endDate);
    end.setHours(0, 0, 0, 0);
    return today > end;
  }).sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
  
  // í…Œì´ë¸” í–‰ ìƒì„± í•¨ìˆ˜
  const renderDealRow = (deal, isOngoing) => {
    const supplier = state.suppliers.find(s => s.id === deal.supplierId);
    const seller = state.sellers.find(s => s.id === deal.sellerId);
    // selectedProductsê°€ ê°ì²´ ë°°ì—´ì¸ì§€ ë¬¸ìì—´ ë°°ì—´ì¸ì§€ í™•ì¸
    const selectedProductsData = deal.selectedProducts || [];
    const products = selectedProductsData.map(item => {
      const pid = typeof item === 'string' ? item : item.productId;
      return state.supplierProducts.find(p => p.id === pid);
    }).filter(Boolean);
    const statusInfo = getDisplayStatus(deal);
    const dday = deal.startDate && deal.endDate ? calcDday(deal.startDate, deal.endDate) : { text: '-', color: 'var(--gray-400)', status: 'none' };
    
    // ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ (ê³µêµ¬ ëª¨ë‹¬ê³¼ ì—°ë™)
    const journeySample = deal.journeySample === true;
    const journeyPaymentLink = deal.journeyPaymentLink === true;
    const journeyContent = deal.journeyContent === true;
    const journeyAdSetup = deal.journeyAdSetup === true;
    const journeySellerGuide = deal.journeySellerGuide === true;
    
    return `
      <tr>
        <td style="text-align:center;">
          <span style="display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700;background:${dday.status === 'ongoing' ? 'var(--danger-light)' : dday.status === 'completed' ? 'var(--gray-100)' : 'var(--info-light)'};color:${dday.color};white-space:nowrap;">
            ${dday.text}
          </span>
        </td>
        <td>
          <strong>${deal.title}</strong>
          <div style="font-size:11px;color:var(--gray-500);margin-top:2px;">${deal.startDate || '-'} ~ ${deal.endDate || '-'}</div>
        </td>
        <td>${supplier?.name || '-'}</td>
        <td>${seller?.name || '-'}</td>
        <td style="text-align:center;">
          <button onclick="event.stopPropagation();quickToggleJourney('${deal.id}','journeySample',${!journeySample})" style="width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;background:${journeySample ? '#0064FF' : '#E5E8EB'};color:${journeySample ? 'white' : '#8B95A1'};font-size:14px;" title="ìƒ˜í”Œ ì „ë‹¬">
            ${journeySample ? 'âœ“' : ''}
          </button>
        </td>
        <td style="text-align:center;">
          <button onclick="event.stopPropagation();quickToggleJourney('${deal.id}','journeyPaymentLink',${!journeyPaymentLink})" style="width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;background:${journeyPaymentLink ? '#0064FF' : '#E5E8EB'};color:${journeyPaymentLink ? 'white' : '#8B95A1'};font-size:14px;" title="ê²°ì œë§í¬ ì „ë‹¬">
            ${journeyPaymentLink ? 'âœ“' : ''}
          </button>
        </td>
        <td style="text-align:center;">
          <button onclick="event.stopPropagation();quickToggleJourney('${deal.id}','journeyContent',${!journeyContent})" style="width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;background:${journeyContent ? '#0064FF' : '#E5E8EB'};color:${journeyContent ? 'white' : '#8B95A1'};font-size:14px;" title="ì½˜í…ì¸  ì „ë‹¬">
            ${journeyContent ? 'âœ“' : ''}
          </button>
        </td>
        <td style="text-align:center;">
          <button onclick="event.stopPropagation();quickToggleJourney('${deal.id}','journeyAdSetup',${!journeyAdSetup})" style="width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;background:${journeyAdSetup ? '#0064FF' : '#E5E8EB'};color:${journeyAdSetup ? 'white' : '#8B95A1'};font-size:14px;" title="ê´‘ê³  ì„¸íŒ…">
            ${journeyAdSetup ? 'âœ“' : ''}
          </button>
        </td>
        <td style="text-align:center;">
          <button onclick="event.stopPropagation();quickToggleJourney('${deal.id}','journeySellerGuide',${!journeySellerGuide})" style="width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;background:${journeySellerGuide ? '#0064FF' : '#E5E8EB'};color:${journeySellerGuide ? 'white' : '#8B95A1'};font-size:14px;" title="ì…€ëŸ¬ ê°€ì´ë“œ">
            ${journeySellerGuide ? 'âœ“' : ''}
          </button>
        </td>
        <td style="text-align:center;"><span class="status-badge ${statusInfo.class}">${statusInfo.label}</span></td>
        <td style="text-align:center;">
          <button type="button" class="btn btn-secondary btn-sm" style="padding:6px 12px;font-size:12px;cursor:pointer;position:relative;z-index:10;" onclick="event.stopPropagation();openDealProgressModal('${deal.id}')">ì „ì²´</button>
        </td>
      </tr>
    `;
  };
  
  // í…Œì´ë¸” í—¤ë” ê³µí†µ
  const tableHeader = `
    <thead>
      <tr>
        <th style="width:110px;text-align:center;white-space:nowrap;">D-Day</th>
        <th>ê³µêµ¬ëª…</th>
        <th>ê³µê¸‰ì‚¬</th>
        <th>ì…€ëŸ¬</th>
        <th style="text-align:center;width:50px;">ìƒ˜í”Œ</th>
        <th style="text-align:center;width:50px;">ê²°ì œ</th>
        <th style="text-align:center;width:50px;">ì½˜í…ì¸ </th>
        <th style="text-align:center;width:50px;">ê´‘ê³ </th>
        <th style="text-align:center;width:50px;">ê°€ì´ë“œ</th>
        <th style="text-align:center;">ìƒíƒœ</th>
        <th style="text-align:center;">ê´€ë¦¬</th>
      </tr>
    </thead>
  `;
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ê³µêµ¬ í˜„í™©/ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>
      <p class="page-desc">ê³µêµ¬ë³„ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë°”ë¡œ ê´€ë¦¬í•˜ì„¸ìš”. í´ë¦­í•˜ë©´ ì²´í¬ë©ë‹ˆë‹¤! (íŒŒíŠ¸ë„ˆ í˜ì´ì§€ì— ì—°ë™)</p>
    </div>
    
    <!-- í˜‘ì˜ì¤‘ ê³µêµ¬ (ë‹«íŒ ìƒíƒœ) -->
    <div class="card" style="margin-bottom: 24px;">
      <h3 class="card-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleDealSection('negotiating')">
        <span>â³ í˜‘ì˜ì¤‘ (${negotiatingDeals.length}ê±´)</span>
        <span id="negotiating-arrow" style="font-size: 12px; transition: transform 0.2s;">â–¼</span>
      </h3>
      <div id="negotiating-section" style="display: none;">
        ${negotiatingDeals.length === 0 ? `
          <div style="padding: 24px; text-align: center; color: var(--gray-500);">í˜‘ì˜ì¤‘ì¸ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        ` : `
          <div style="overflow-x: auto;">
            <table class="data-table">
              ${tableHeader}
              <tbody>
                ${negotiatingDeals.map(deal => renderDealRow(deal, false)).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
    
    <!-- ì§„í–‰ì¤‘ ê³µêµ¬ (ì—´ë¦° ìƒíƒœ) -->
    <div class="card" style="margin-bottom: 24px;">
      <h3 class="card-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleDealSection('ongoing')">
        <span>ğŸ”¥ ì§„í–‰ì¤‘ (${ongoingDeals.length}ê±´)</span>
        <span id="ongoing-arrow" style="font-size: 12px; transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
      </h3>
      <div id="ongoing-section" style="display: block;">
        ${ongoingDeals.length === 0 ? `
          <div style="padding: 24px; text-align: center; color: var(--gray-500);">í˜„ì¬ ì§„í–‰ì¤‘ì¸ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        ` : `
          <div style="overflow-x: auto;">
            <table class="data-table">
              ${tableHeader}
              <tbody>
                ${ongoingDeals.map(deal => renderDealRow(deal, true)).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
    
    <!-- ì§„í–‰ ì˜ˆì • ê³µêµ¬ (ì—´ë¦° ìƒíƒœ) -->
    <div class="card" style="margin-bottom: 24px;">
      <h3 class="card-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleDealSection('upcoming')">
        <span>ğŸ“… ì§„í–‰ ì˜ˆì • (${upcomingDeals.length}ê±´)</span>
        <span id="upcoming-arrow" style="font-size: 12px; transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
      </h3>
      <div id="upcoming-section" style="display: block;">
        ${upcomingDeals.length === 0 ? `
          <div style="padding: 24px; text-align: center; color: var(--gray-500);">ì˜ˆì •ëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        ` : `
          <div style="overflow-x: auto;">
            <table class="data-table">
              ${tableHeader}
              <tbody>
                ${upcomingDeals.map(deal => renderDealRow(deal, true)).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
    
    <div style="margin-bottom: 24px; padding: 12px 16px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
      ğŸ’¡ í–‰ì„ í´ë¦­í•˜ê±°ë‚˜ ìƒì„¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒ˜í”Œì „ë‹¬, ê²°ì œë§í¬ì „ë‹¬, ì»¨í…ì¸ ì „ë‹¬ì„ ê´€ë¦¬í•˜ì„¸ìš”.
    </div>
    
    <!-- ì™„ë£Œëœ ê³µêµ¬ (ì—´ë¦° ìƒíƒœ) -->
    <div class="card">
      <h3 class="card-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleDealSection('completed')">
        <span>âœ… ì™„ë£Œëœ ê³µêµ¬ (${completedDeals.length}ê±´)</span>
        <span id="completed-arrow" style="font-size: 12px; transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
      </h3>
      <div id="completed-section" style="display: block;">
        ${completedDeals.length === 0 ? `
          <div style="padding: 24px; text-align: center; color: var(--gray-500);">ì™„ë£Œëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        ` : `
          <div style="overflow-x: auto;">
            <table class="data-table">
              ${tableHeader}
              <tbody>
                ${completedDeals.map(deal => renderDealRow(deal, false)).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
  `;
}

// ê³µêµ¬ ì„¹ì…˜ í† ê¸€
function toggleDealSection(sectionId) {
  const section = document.getElementById(sectionId + '-section');
  const arrow = document.getElementById(sectionId + '-arrow');
  
  if (section) {
    const isHidden = section.style.display === 'none';
    section.style.display = isHidden ? 'block' : 'none';
    arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

// ìƒ˜í”Œ ì „ë‹¬ ìƒíƒœ í† ê¸€
async function toggleSampleDelivery(dealId, productId, isChecked) {
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const sampleDelivery = deal.sampleDelivery || {};
    sampleDelivery[productId] = isChecked;
    
    await db.collection('deals').doc(dealId).update({ sampleDelivery });
    showToast(isChecked ? 'ìƒ˜í”Œ ì „ë‹¬ ì™„ë£Œ!' : 'ìƒ˜í”Œ ì „ë‹¬ ì·¨ì†Œ');
  } catch(e) {
    console.error(e);
    showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
  }
}

// í˜‘ì˜ì‚¬í•­ ê´€ë¦¬ ëª¨ë‹¬
function openDealNegotiationModal(dealId) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;
  
  const supplier = state.suppliers.find(s => s.id === deal.supplierId);
  const seller = state.sellers.find(s => s.id === deal.sellerId);
  const negotiation = deal.negotiation || {};
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“ í˜‘ì˜ì‚¬í•­ ê´€ë¦¬</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">${deal.title}</div>
        <div style="display: flex; gap: 16px; font-size: 13px; color: var(--gray-500);">
          <span>ğŸ­ ${supplier?.name || '-'}</span>
          <span>ğŸ‘¤ ${seller?.name || '-'}</span>
          <span>ğŸ“… ${deal.startDate} ~ ${deal.endDate}</span>
        </div>
      </div>
      
      <form onsubmit="submitNegotiationForm(event, '${dealId}')">
        <div class="form-group">
          <label class="form-label">ğŸ’° ìˆ˜ìˆ˜ë£Œ í˜‘ì˜</label>
          <textarea class="form-textarea" id="nego-commission" rows="3" placeholder="ì˜ˆ: íŒë§¤ ìˆ˜ìˆ˜ë£Œ 15%, 1000ê°œ ì´ìƒ ì‹œ ì¶”ê°€ 3% ì¸ì„¼í‹°ë¸Œ">${negotiation.commission || ''}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">ğŸ ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜</label>
          <textarea class="form-textarea" id="nego-event" rows="3" placeholder="ì˜ˆ: êµ¬ë§¤ì ëŒ€ìƒ ì‚¬ì€í’ˆ ì¦ì •, ë¦¬ë·° ì´ë²¤íŠ¸ ì§„í–‰">${negotiation.event || ''}</textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ğŸ’¸ ì´ë²¤íŠ¸ë¹„ìš© (ì›)</label>
            <input type="number" class="form-input" id="nego-event-cost" value="${negotiation.eventCost || ''}" placeholder="ì˜ˆ: 50000">
            <small style="color: var(--gray-500); font-size: 11px;">ì •ì‚° ì‹œ ì°¨ê°ë˜ëŠ” ë¹„ìš©</small>
          </div>
          <div class="form-group">
            <label class="form-label">ğŸ’³ ì˜ˆìƒ PGìˆ˜ìˆ˜ë£Œ (%)</label>
            <input type="number" class="form-input" id="nego-pg-fee" value="${negotiation.pgFeeRate || '4'}" step="0.1" placeholder="ê¸°ë³¸ 4%">
            <small style="color: var(--gray-500); font-size: 11px;">ì¹´ë“œê²°ì œ ì‹œ ìë™ 4% ì ìš©</small>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ğŸ¯ ì„œë¹„ìŠ¤ ì§€ì› í˜œíƒ</label>
          <textarea class="form-textarea" id="nego-support" rows="3" placeholder="ì˜ˆ: ìƒì„¸í˜ì´ì§€ ì œì‘ ì§€ì›, ê´‘ê³ ë¹„ 50% ì§€ì›">${negotiation.support || ''}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">ğŸ“‹ ê¸°íƒ€ í˜‘ì˜ì‚¬í•­</label>
          <textarea class="form-textarea" id="nego-etc" rows="3" placeholder="ì¶”ê°€ í˜‘ì˜ ë‚´ìš©">${negotiation.etc || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
        </div>
      </form>
    </div>
  `;
}

async function submitNegotiationForm(e, dealId) {
  e.preventDefault();
  
  const negotiation = {
    commission: document.getElementById('nego-commission').value,
    event: document.getElementById('nego-event').value,
    eventCost: Number(document.getElementById('nego-event-cost').value) || 0,
    pgFeeRate: Number(document.getElementById('nego-pg-fee').value) || 4,
    support: document.getElementById('nego-support').value,
    etc: document.getElementById('nego-etc').value,
    updatedAt: new Date().toISOString()
  };
  
  try {
    await db.collection('deals').doc(dealId).update({ negotiation });
    showToast('í˜‘ì˜ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ê³µêµ¬ ì§„í–‰ ìƒì„¸ ëª¨ë‹¬
function openDealProgressModal(dealId) {
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;
  
  const modalEl = document.getElementById('modal');
  const supplier = state.suppliers.find(s => s.id === deal.supplierId);
  const seller = state.sellers.find(s => s.id === deal.sellerId);
  
  // selectedProductsê°€ ê°ì²´ ë°°ì—´ì¸ì§€ ë¬¸ìì—´ ë°°ì—´ì¸ì§€ í™•ì¸
  const selectedProductsData = deal.selectedProducts || [];
  const products = selectedProductsData.map(item => {
    const pid = typeof item === 'string' ? item : item.productId;
    const product = state.supplierProducts.find(p => p.id === pid);
    if (product) {
      return {
        ...product,
        marginRate: typeof item === 'object' ? item.marginRate : 0
      };
    }
    return null;
  }).filter(Boolean);
  
  const negotiation = deal.negotiation || {};
  const statusInfo = getDisplayStatus(deal);
  
  // ì „ì²´ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ì •ì˜ (ìº˜ë¦°ë” ê³µêµ¬ ëª¨ë‹¬ê³¼ ë™ì¼)
  const journeyItems = [
    { key: 'journeySample', icon: 'ğŸ“¦', label: 'ìƒ˜í”Œ ì „ë‹¬', desc: 'ê³µê¸‰ì‚¬ë¡œë¶€í„° ìƒ˜í”Œ ì „ë‹¬ë°›ìŒ', phase: 'ì¤€ë¹„' },
    { key: 'journeyPaymentLink', icon: 'ğŸ’³', label: 'ê²°ì œë§í¬ ì „ë‹¬', desc: 'ì…€ëŸ¬ì—ê²Œ ê²°ì œ ë§í¬ ì „ë‹¬', phase: 'ì¤€ë¹„' },
    { key: 'journeyContent', icon: 'ğŸ¬', label: 'ì½˜í…ì¸  ì „ë‹¬', desc: 'ìƒí’ˆ ì‚¬ì§„, ìƒì„¸í˜ì´ì§€ ì´ë¯¸ì§€', phase: 'ì¤€ë¹„' },
    { key: 'journeyAdSetup', icon: 'ğŸ“º', label: 'ê´‘ê³  ì„¸íŒ…', desc: 'ë©”íƒ€ ê´‘ê³  ìº í˜ì¸ ì„¤ì •', phase: 'ë§ˆì¼€íŒ…' },
    { key: 'journeySellerGuide', icon: 'ğŸ“–', label: 'ì…€ëŸ¬ ê°€ì´ë“œ ì „ë‹¬', desc: 'íŒë§¤ ê°€ì´ë“œ ë¬¸ì„œ ì „ë‹¬', phase: 'ì…€ëŸ¬ê´€ë¦¬' },
    { key: 'journeyMonitoring', icon: 'ğŸ“Š', label: 'ì£¼ë¬¸ í˜„í™© ëª¨ë‹ˆí„°ë§', desc: 'ì¼ì¼ ì£¼ë¬¸ëŸ‰ í™•ì¸', phase: 'ìš´ì˜' },
    { key: 'journeyCs', icon: 'ğŸ’¬', label: 'ê³ ê° ë¬¸ì˜ ëŒ€ì‘', desc: 'CS ìš”ì²­ ì²˜ë¦¬', phase: 'ìš´ì˜' },
    { key: 'journeyOrderSend', icon: 'ğŸ“‹', label: 'ë°œì£¼ì„œ ì „ë‹¬ (ê·¸ë¡œí™ˆ)', desc: 'ê³µê¸‰ì‚¬ì— ë°œì£¼ì„œ ì „ë‹¬', phase: 'ì •ì‚°' },
    { key: 'journeySellerSettle', icon: 'ğŸ“„', label: 'ì…€ëŸ¬ ì •ì‚°ì„œ ì œì‘', desc: 'ì…€ëŸ¬ìš© ì •ì‚°ì„œ ì‘ì„±', phase: 'ì •ì‚°' },
    { key: 'journeySupplierSettle', icon: 'ğŸ“‘', label: 'ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì œì‘', desc: 'ê³µê¸‰ì‚¬ìš© ì •ì‚°ì„œ ì‘ì„±', phase: 'ì •ì‚°' },
    { key: 'journeyComplete', icon: 'âœ…', label: 'ì •ì‚° ì™„ë£Œ', desc: 'ëª¨ë“  ì •ì‚° ì™„ë£Œ', phase: 'ì •ì‚°' }
  ];
  
  const completedCount = journeyItems.filter(item => deal[item.key] === true).length;
  
  // D-Day ê³„ì‚° (Xì¼ ì¤‘ Yì¼ì°¨ í˜•ì‹)
  const calcDday = (startDate, endDate) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(0, 0, 0, 0);
    
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    
    if (today < start) {
      const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
      return { text: `D-${diff}`, isOngoing: false };
    } else if (today >= start && today <= end) {
      const currentDay = Math.ceil((today - start) / (1000 * 60 * 60 * 24)) + 1;
      return { text: `${totalDays}ì¼ ì¤‘ ${currentDay}ì¼ì°¨`, isOngoing: true };
    } else {
      return { text: 'ì¢…ë£Œ', isOngoing: false };
    }
  };
  const dday = calcDday(deal.startDate, deal.endDate);
  
  // ë‹¨ê³„ë³„ë¡œ ê·¸ë£¹í™”
  const phases = ['ì¤€ë¹„', 'ë§ˆì¼€íŒ…', 'ì…€ëŸ¬ê´€ë¦¬', 'ìš´ì˜', 'ì •ì‚°'];
  const phaseColors = {
    'ì¤€ë¹„': { bg: '#dbeafe', color: '#2563eb' },
    'ë§ˆì¼€íŒ…': { bg: '#fef3c7', color: '#d97706' },
    'ì…€ëŸ¬ê´€ë¦¬': { bg: '#ede9fe', color: '#7c3aed' },
    'ìš´ì˜': { bg: '#dcfce7', color: '#16a34a' },
    'ì •ì‚°': { bg: '#fce7f3', color: '#db2777' }
  };
  
  modalEl.innerHTML = `
    <div class="modal-content" style="max-width: 750px; max-height: 95vh; overflow-y: auto;">
      <div class="modal-header">
        <div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <h3 style="margin: 0;">${deal.title}</h3>
            <span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; background: ${dday.isOngoing ? 'var(--danger-light)' : 'var(--info-light)'}; color: ${dday.isOngoing ? 'var(--danger)' : 'var(--info)'};">${dday.text}</span>
            <span class="status-badge ${statusInfo.class}">${statusInfo.label}</span>
          </div>
          <div style="font-size: 13px; color: var(--gray-500); margin-top: 4px;">${deal.startDate} ~ ${deal.endDate}</div>
        </div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
          <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
            <div style="font-size: 11px; color: var(--gray-500);">ğŸ­ ê³µê¸‰ì‚¬</div>
            <div style="font-weight: 600; margin-top: 4px;">${supplier?.name || '-'}</div>
          </div>
          <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
            <div style="font-size: 11px; color: var(--gray-500);">ğŸ‘¤ ì…€ëŸ¬</div>
            <div style="font-weight: 600; margin-top: 4px;">${seller?.name || '-'}</div>
          </div>
        </div>
        
        <!-- ê³µêµ¬ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì „ì²´) -->
        <div style="margin-bottom: 20px; border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
          <div style="background: linear-gradient(135deg, var(--primary), #7c3aed); padding: 16px 20px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 16px; font-weight: 700;">ğŸš€ ê³µêµ¬ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
                <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">ìº˜ë¦°ë” ê³µêµ¬ ìˆ˜ì •ê³¼ ë™ì¼í•˜ê²Œ ì—°ë™ë©ë‹ˆë‹¤</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 28px; font-weight: 700;">${completedCount}/${journeyItems.length}</div>
                <div style="font-size: 11px; opacity: 0.8;">ì™„ë£Œ</div>
              </div>
            </div>
            <div style="margin-top: 12px; background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; width: ${(completedCount / journeyItems.length) * 100}%; background: white; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
          </div>
          
          <div style="padding: 16px;">
            ${phases.map(phase => {
              const phaseItems = journeyItems.filter(item => item.phase === phase);
              const phaseColor = phaseColors[phase];
              return `
                <div style="margin-bottom: 16px;">
                  <div style="font-size: 13px; font-weight: 700; color: ${phaseColor.color}; background: ${phaseColor.bg}; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px;">
                    ${phase === 'ì¤€ë¹„' ? 'ğŸ“¦' : phase === 'ë§ˆì¼€íŒ…' ? 'ğŸ“º' : phase === 'ì…€ëŸ¬ê´€ë¦¬' ? 'ğŸ‘¥' : phase === 'ìš´ì˜' ? 'ğŸ”„' : 'ğŸ’°'} ${phase} ë‹¨ê³„
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${phaseItems.map(item => {
                      const isChecked = deal[item.key] === true;
                      return `
                        <label style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: ${isChecked ? '#d1fae5' : 'var(--gray-50)'}; border-radius: 8px; cursor: pointer; border: 1px solid ${isChecked ? '#10b981' : 'var(--gray-200)'}; transition: all 0.15s;">
                          <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleJourneyItem('${deal.id}', '${item.key}', this.checked)" style="width: 18px; height: 18px; accent-color: #10b981;">
                          <span style="font-size: 18px;">${item.icon}</span>
                          <div style="flex: 1;">
                            <div style="font-size: 13px; font-weight: 600; color: ${isChecked ? '#059669' : 'var(--gray-700)'};">${item.label}</div>
                            <div style="font-size: 11px; color: var(--gray-500);">${item.desc}</div>
                          </div>
                          ${isChecked ? '<span style="font-size: 16px; color: #10b981;">âœ“</span>' : ''}
                        </label>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        
        <!-- ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ë° ê³µê¸‰ë‹¨ê°€ -->
        ${products.length > 0 ? `
          <div style="margin-bottom: 20px; border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
            <div style="background: var(--gray-50); padding: 12px 16px; font-weight: 600;">
              <span>ğŸ“¦ ìƒí’ˆë³„ ì •ì‚° ì •ë³´</span>
            </div>
            <div style="padding: 0; overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px; min-width: 500px;">
                <thead>
                  <tr style="background: var(--gray-100);">
                    <th style="padding: 10px 12px; text-align: left; font-weight: 600;">ìƒí’ˆëª…</th>
                    <th style="padding: 10px 12px; text-align: right; width: 100px; font-weight: 600;">ê³µêµ¬íŒë§¤ê°€</th>
                    <th style="padding: 10px 12px; text-align: right; width: 100px; font-weight: 600; background: #fef3c7; color: #92400e;">ê³µê¸‰ê°€(V+)</th>
                    <th style="padding: 10px 12px; text-align: center; width: 80px; font-weight: 600;">ìˆ˜ìˆ˜ë£Œìœ¨</th>
                    <th style="padding: 10px 12px; text-align: center; width: 80px; font-weight: 600; background: #dbeafe; color: #1d4ed8;">ë§ˆì§„ìœ¨</th>
                  </tr>
                </thead>
                <tbody>
                  ${products.map(p => {
                    const salePrice = Number(p.salePrice) || 0;
                    const supplyPrice = Number(p.supplyPrice) || 0;
                    const feePercent = Number(p.feePercent) || 0;
                    const marginRate = Number(p.marginRate) || 0;
                    return `
                    <tr style="border-top: 1px solid var(--gray-200);">
                      <td style="padding: 10px 12px;">${p.productName}</td>
                      <td style="padding: 10px 12px; text-align: right;">${salePrice > 0 ? salePrice.toLocaleString() + 'ì›' : '-'}</td>
                      <td style="padding: 10px 12px; text-align: right; background: #fffbeb; color: ${supplyPrice > 0 ? '#92400e' : 'var(--danger)'}; font-weight: 500;">${supplyPrice > 0 ? supplyPrice.toLocaleString() + 'ì›' : 'ë¯¸ì„¤ì •'}</td>
                      <td style="padding: 10px 12px; text-align: center;">${feePercent > 0 ? feePercent + '%' : '-'}</td>
                      <td style="padding: 10px 12px; text-align: center; background: #eff6ff; font-weight: 600; color: #1d4ed8;">${marginRate}%</td>
                    </tr>
                  `;}).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : ''}
        
        <!-- í˜‘ì˜ì‚¬í•­ -->
        <div style="border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
          <div style="background: var(--gray-50); padding: 12px 16px; font-weight: 600;">
            <span>ğŸ“ í˜‘ì˜ì‚¬í•­</span>
          </div>
          <div style="padding: 16px;">
            <div style="display: grid; gap: 12px; font-size: 13px;">
              <div>
                <label style="font-size: 11px; color: var(--gray-500); display: block; margin-bottom: 4px;">ğŸ ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜</label>
                <input type="text" id="nego-event-input" class="form-input" value="${negotiation.event || ''}" placeholder="ì˜ˆ: êµ¬ë§¤ì ì‚¬ì€í’ˆ ì¦ì •">
              </div>
              <div>
                <label style="font-size: 11px; color: var(--gray-500); display: block; margin-bottom: 4px;">ğŸ¯ ì„œë¹„ìŠ¤ ì§€ì›</label>
                <input type="text" id="nego-support-input" class="form-input" value="${negotiation.support || ''}" placeholder="ì˜ˆ: ìƒì„¸í˜ì´ì§€ ì œì‘ ì§€ì›">
              </div>
              <div>
                <label style="font-size: 11px; color: var(--gray-500); display: block; margin-bottom: 4px;">ğŸ“‹ ê¸°íƒ€</label>
                <input type="text" id="nego-etc-input" class="form-input" value="${negotiation.etc || ''}" placeholder="ê¸°íƒ€ í˜‘ì˜ ë‚´ìš©">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button class="btn btn-secondary" onclick="closeModal(); openDealModal(state.deals.find(d=>d.id==='${deal.id}'))">ê³µêµ¬ ìˆ˜ì •</button>
        <button class="btn btn-primary" onclick="saveDealProgress('${deal.id}')">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  `;
  
  modalEl.className = 'modal show';
}

// ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ í† ê¸€
async function toggleJourneyItem(dealId, field, checked) {
  try {
    const updateData = { 
      [field]: checked,
      updatedAt: new Date().toISOString()
    };
    
    await db.collection('deals').doc(dealId).update(updateData);
    
    // ë¡œì»¬ ìƒíƒœë„ ì—…ë°ì´íŠ¸
    const deal = state.deals.find(d => d.id === dealId);
    if (deal) {
      deal[field] = checked;
    }
    
    // ì „ì²´ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¼ë²¨
    const labels = {
      journeySample: 'ìƒ˜í”Œ ì „ë‹¬',
      journeyPaymentLink: 'ê²°ì œë§í¬ ì „ë‹¬',
      journeyContent: 'ì½˜í…ì¸  ì „ë‹¬',
      journeyAdSetup: 'ê´‘ê³  ì„¸íŒ…',
      journeySellerGuide: 'ì…€ëŸ¬ ê°€ì´ë“œ ì „ë‹¬',
      journeyMonitoring: 'ì£¼ë¬¸ í˜„í™© ëª¨ë‹ˆí„°ë§',
      journeyCs: 'ê³ ê° ë¬¸ì˜ ëŒ€ì‘',
      journeyOrderSend: 'ë°œì£¼ì„œ ì „ë‹¬ (ê·¸ë¡œí™ˆ)',
      journeySellerSettle: 'ì…€ëŸ¬ ì •ì‚°ì„œ ì œì‘',
      journeySupplierSettle: 'ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì œì‘',
      journeyComplete: 'ì •ì‚° ì™„ë£Œ'
    };
    
    const taskTitle = labels[field] || field;
    showToast(checked ? `âœ… ${taskTitle} ì™„ë£Œ!` : `${taskTitle} ì·¨ì†Œ`);
    
    // âœ… ì²´í¬ ì‹œ ìë™ìœ¼ë¡œ í™œë™ ë¡œê·¸ì— ê¸°ë¡ & ì—…ë¬´ ì—°ë™
    if (checked) {
      const dealTitle = deal?.title || 'ê³µêµ¬';
      
      // syncJourneyToTask í˜¸ì¶œ (ìº˜ë¦°ë” ê³µêµ¬ ìˆ˜ì •ê³¼ ë™ì¼í•œ ì—°ë™)
      if (typeof syncJourneyToTask === 'function') {
        syncJourneyToTask(dealId, field, taskTitle, true);
      }
      
      // í™œë™ ë¡œê·¸ ê¸°ë¡
      try {
        const currentMember = typeof getCurrentMember === 'function' ? getCurrentMember() : { id: 'unknown', name: state.currentUser?.name || 'ë¯¸ì§€ì •' };
        const today = new Date();
        
        await db.collection('activityLogs').add({
          action: taskTitle + ' ì™„ë£Œ',
          dealId: dealId,
          dealTitle: dealTitle,
          journeyKey: field,
          memberId: currentMember.id,
          memberName: currentMember.name,
          date: today.toISOString().split('T')[0],
          time: today.toTimeString().substring(0, 5),
          type: 'journey_check',
          source: 'checklist_modal',
          createdAt: today.toISOString()
        });
      } catch (logError) {
        console.error('í™œë™ ë¡œê·¸ ê¸°ë¡ ì˜¤ë¥˜:', logError);
      }
    }
    
    // ëª¨ë‹¬ ë‹¤ì‹œ ë Œë”ë§
    openDealProgressModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ê³µêµ¬í˜„í™©ì—ì„œ ë°”ë¡œ ì²´í¬ë¦¬ìŠ¤íŠ¸ í† ê¸€ (ë¹ ë¥¸ í† ê¸€)
async function quickToggleJourney(dealId, field, newValue) {
  try {
    const updateData = { 
      [field]: newValue,
      updatedAt: new Date().toISOString()
    };
    
    await db.collection('deals').doc(dealId).update(updateData);
    
    // ë¡œì»¬ ìƒíƒœë„ ì—…ë°ì´íŠ¸
    const deal = state.deals.find(d => d.id === dealId);
    if (deal) {
      deal[field] = newValue;
    }
    
    // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¼ë²¨
    const labels = {
      journeySample: 'ìƒ˜í”Œ ì „ë‹¬',
      journeyPaymentLink: 'ê²°ì œë§í¬ ì „ë‹¬',
      journeyContent: 'ì½˜í…ì¸  ì „ë‹¬',
      journeyAdSetup: 'ê´‘ê³  ì„¸íŒ…',
      journeySellerGuide: 'ì…€ëŸ¬ ê°€ì´ë“œ ì „ë‹¬',
      journeyMonitoring: 'ì£¼ë¬¸ í˜„í™© ëª¨ë‹ˆí„°ë§',
      journeyCs: 'ê³ ê° ë¬¸ì˜ ëŒ€ì‘',
      journeyOrderSend: 'ë°œì£¼ì„œ ì „ë‹¬ (ê·¸ë¡œí™ˆ)',
      journeySellerSettle: 'ì…€ëŸ¬ ì •ì‚°ì„œ ì œì‘',
      journeySupplierSettle: 'ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì œì‘',
      journeyComplete: 'ì •ì‚° ì™„ë£Œ'
    };
    
    const taskTitle = labels[field] || field;
    showToast(newValue ? `âœ… ${taskTitle} ì™„ë£Œ!` : `${taskTitle} ì·¨ì†Œ`);
    
    // ì²´í¬ ì‹œ í™œë™ ë¡œê·¸ ê¸°ë¡
    if (newValue) {
      const dealTitle = deal?.title || 'ê³µêµ¬';
      
      try {
        const currentMember = typeof getCurrentMember === 'function' ? getCurrentMember() : { id: 'unknown', name: state.currentUser?.name || 'ë¯¸ì§€ì •' };
        const today = new Date();
        
        await db.collection('activityLogs').add({
          action: taskTitle + ' ì™„ë£Œ',
          dealId: dealId,
          dealTitle: dealTitle,
          journeyKey: field,
          memberId: currentMember.id,
          memberName: currentMember.name,
          date: today.toISOString().split('T')[0],
          time: today.toTimeString().substring(0, 5),
          type: 'journey_check',
          source: 'deal_list_quick',
          createdAt: today.toISOString()
        });
      } catch (logError) {
        console.error('í™œë™ ë¡œê·¸ ê¸°ë¡ ì˜¤ë¥˜:', logError);
      }
    }
    
    // ê³µêµ¬í˜„í™© ë‹¤ì‹œ ë Œë”ë§
    renderDealManagement();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì»¨í…ì¸  ì „ë‹¬ í† ê¸€ (ê¸°ì¡´ í˜¸í™˜ìš©)
async function toggleContentDelivered(dealId, delivered) {
  await toggleJourneyItem(dealId, 'journeyContent', delivered);
}

// ê³µêµ¬ ì§„í–‰ ì •ë³´ ì €ì¥ (í˜‘ì˜ì‚¬í•­)
async function saveDealProgress(dealId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const negotiation = {
    event: document.getElementById('nego-event-input').value,
    support: document.getElementById('nego-support-input').value,
    etc: document.getElementById('nego-etc-input').value,
    updatedAt: new Date().toISOString()
  };
  
  try {
    await db.collection('deals').doc(dealId).update({ 
      negotiation,
      updatedAt: new Date().toISOString()
    });
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ========== ê³µìœ  ë§í¬ ê´€ë¦¬ ==========
function renderShareLinks() {
  const app = document.getElementById('app');
  
  // íŒŒíŠ¸ë„ˆ í¬í„¸ ë¡œê·¸ì¸ í˜ì´ì§€ URL (ê³ ì •)
  const loginUrl = 'https://partner-moyeoradeal.kr/login/';
  // ê³µìœ  í˜ì´ì§€ ê¸°ë³¸ URL (ê°™ì€ í´ë”ì— ìˆë‹¤ê³  ê°€ì •)
  const baseUrl = window.location.href.replace(/[^/]*$/, '') + 'moyeora-calendar-public.html';
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ”‘ íŒŒíŠ¸ë„ˆ ê³„ì •ê´€ë¦¬</h1>
      <p class="page-desc">ê³µê¸‰ì‚¬ ë° ì…€ëŸ¬ì˜ ë¡œê·¸ì¸ ê³„ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>
    
    <!-- ğŸ” ë¡œê·¸ì¸ í˜ì´ì§€ (ë©”ì¸) -->
    <div class="card" style="margin-bottom: 24px; border: 2px solid var(--primary);">
      <h3 class="card-title">ğŸ” íŒŒíŠ¸ë„ˆ ë¡œê·¸ì¸ í˜ì´ì§€</h3>
      <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">ê³µê¸‰ì‚¬/ì…€ëŸ¬ì—ê²Œ ì´ ë§í¬ë¥¼ ê³µìœ í•˜ì„¸ìš”. ID/PWë¡œ ë¡œê·¸ì¸í•˜ë©´ ê°ìì˜ ì¼ì •í‘œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div style="display: flex; gap: 12px; align-items: center; padding: 16px; background: var(--primary-light); border-radius: 12px;">
        <input type="text" class="form-input" value="${loginUrl}" readonly style="flex: 1; background: white; font-weight: 600;">
        <button class="btn btn-primary" onclick="copyShareLink('${loginUrl}')">ğŸ“‹ ë³µì‚¬</button>
        <a href="${loginUrl}" target="_blank" class="btn btn-secondary">ğŸ”— ì—´ê¸°</a>
      </div>
    </div>
    
    <!-- ì•ˆë‚´ ì¹´ë“œ -->
    <div class="card" style="margin-bottom: 24px;">
      <div style="padding: 16px; background: var(--info-light); border-radius: 12px; color: var(--info);">
        <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•</strong>
        <ol style="margin: 8px 0 0 20px; font-size: 14px;">
          <li>ì•„ë˜ì—ì„œ ê³µê¸‰ì‚¬/ì…€ëŸ¬ì—ê²Œ <strong>ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸</strong>ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</li>
          <li>ìœ„ <strong>ë¡œê·¸ì¸ í˜ì´ì§€ ë§í¬</strong>ë¥¼ ê³µê¸‰ì‚¬/ì…€ëŸ¬ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.</li>
          <li>ê³µê¸‰ì‚¬/ì…€ëŸ¬ê°€ ë¡œê·¸ì¸í•˜ë©´ ë³¸ì¸ ê´€ë ¨ ê³µêµ¬ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ol>
      </div>
    </div>
    
    <!-- ê³µê¸‰ì‚¬ë³„ ê³„ì • -->
    <div class="card" style="margin-bottom: 24px;">
      <h3 class="card-title">ğŸ­ ê³µê¸‰ì‚¬ ê³„ì • ê´€ë¦¬</h3>
      <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">ê³µê¸‰ì‚¬ë³„ ë¡œê·¸ì¸ ì •ë³´ì…ë‹ˆë‹¤. ìˆ˜ì •ì€ ê³µê¸‰ì‚¬ ê´€ë¦¬ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      
      ${state.suppliers.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          ë“±ë¡ëœ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      ` : `
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬ëª…</th>
                <th>ì•„ì´ë””</th>
                <th>ë¹„ë°€ë²ˆí˜¸</th>
                <th>ì§„í–‰ ê³µêµ¬</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${state.suppliers.map(s => {
                const dealCount = state.deals.filter(d => d.supplierId === s.id).length;
                return `
                  <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.loginId ? `<code style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">${s.loginId}</code>` : '<span style="color: var(--gray-400);">ë¯¸ì„¤ì •</span>'}</td>
                    <td>${s.loginPw ? `<code style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">${s.loginPw}</code>` : '<span style="color: var(--gray-400);">ë¯¸ì„¤ì •</span>'}</td>
                    <td><span class="status-badge status-ongoing">${dealCount}ê±´</span></td>
                    <td>
                      <button class="btn btn-secondary btn-sm" onclick="openSupplierModal(state.suppliers.find(s=>s.id==='${s.id}'))">âœï¸ ìˆ˜ì •</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
    
    <!-- ì…€ëŸ¬ë³„ ê³„ì • -->
    <div class="card">
      <h3 class="card-title">ğŸ‘¤ ì…€ëŸ¬ ê³„ì • ê´€ë¦¬</h3>
      <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">ì…€ëŸ¬ë³„ ë¡œê·¸ì¸ ì •ë³´ì…ë‹ˆë‹¤. ìˆ˜ì •ì€ ì…€ëŸ¬ ê´€ë¦¬ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      
      ${state.sellers.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          ë“±ë¡ëœ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      ` : `
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ì…€ëŸ¬ëª…</th>
                <th>ì•„ì´ë””</th>
                <th>ë¹„ë°€ë²ˆí˜¸</th>
                <th>ì§„í–‰ ê³µêµ¬</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${state.sellers.map(s => {
                const dealCount = state.deals.filter(d => d.sellerId === s.id).length;
                return `
                  <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.loginId ? `<code style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">${s.loginId}</code>` : '<span style="color: var(--gray-400);">ë¯¸ì„¤ì •</span>'}</td>
                    <td>${s.loginPw ? `<code style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">${s.loginPw}</code>` : '<span style="color: var(--gray-400);">ë¯¸ì„¤ì •</span>'}</td>
                    <td><span class="status-badge status-confirmed">${dealCount}ê±´</span></td>
                    <td>
                      <button class="btn btn-secondary btn-sm" onclick="openSellerModal(state.sellers.find(s=>s.id==='${s.id}'))">âœï¸ ìˆ˜ì •</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

// ê³µìœ  ë§í¬ ë³µì‚¬
function copyShareLink(url) {
  navigator.clipboard.writeText(url).then(() => {
    showToast('âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }).catch(() => {
    // êµ¬í˜• ë¸Œë¼ìš°ì € ëŒ€ì‘
    const input = document.createElement('input');
    input.value = url;
    document.body.appendChild(input);
    input.select();
    document.execCommand('copy');
    document.body.removeChild(input);
    showToast('âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });
}

// ì´ˆê¸°í™”
setupListeners();

// ì…€ëŸ¬ë³„ í˜œíƒ ëª¨ë‹¬
function openSellerBenefitsModal(sellerListId, editMode = false) {
  const seller = state.sellerList.find(s => s.id === sellerListId);
  if (!seller) return;
  
  const benefits = seller.benefits || { prelaunch: [], launch: [], support: [] };
  const hasSellerBenefits = (benefits.prelaunch && benefits.prelaunch.length > 0) ||
                            (benefits.launch && benefits.launch.length > 0) ||
                            (benefits.support && benefits.support.length > 0);
  
  // í˜œíƒì´ ìˆê³  í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ë³´ê¸° ëª¨ë“œë¡œ í‘œì‹œ
  if (hasSellerBenefits && !editMode) {
    openSellerBenefitsViewModal(sellerListId);
    return;
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ ì…€ëŸ¬ í˜œíƒ ì„¤ì •</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 16px; background: var(--gray-50); border-radius: 12px; margin-bottom: 20px;">
        <div style="font-size: 13px; color: var(--gray-500);">ì…€ëŸ¬</div>
        <div style="font-weight: 600; margin-top: 4px;">${seller.accountName}</div>
        ${seller.accountLink ? `<div style="font-size: 13px; color: var(--primary); margin-top: 2px;">${seller.accountLink}</div>` : ''}
      </div>
      
      <form onsubmit="submitSellerBenefits(event, '${sellerListId}')">
        <!-- ê³µêµ¬ì˜ˆê³  í˜œíƒ -->
        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
            <span style="background: var(--gray-700); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">1</span>
            ê³µêµ¬ì˜ˆê³  í˜œíƒ (ë¦´ìŠ¤)
          </label>
          <div id="seller-prelaunch-benefits">
            ${(benefits.prelaunch && benefits.prelaunch.length > 0) ? benefits.prelaunch.map((b, i) => `
              <div class="benefit-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="form-input" name="seller-prelaunch-name" value="${b.name || ''}" placeholder="ì´ë²¤íŠ¸ëª… (ì˜ˆ: ì‚¬ì „ì•Œë¦¼ ì´ë²¤íŠ¸)" style="flex: 2;">
                <input type="text" class="form-input" name="seller-prelaunch-count" value="${b.count || ''}" placeholder="ì¸ì›" style="flex: 0.5;">
                <input type="text" class="form-input" name="seller-prelaunch-reward" value="${b.reward || ''}" placeholder="í˜œíƒ (ì˜ˆ: ì ¤ë¦¬ 1ë°•ìŠ¤)" style="flex: 1.5;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
              </div>
            `).join('') : `
              <div class="benefit-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="form-input" name="seller-prelaunch-name" placeholder="ì´ë²¤íŠ¸ëª… (ì˜ˆ: ì‚¬ì „ì•Œë¦¼ ì´ë²¤íŠ¸)" style="flex: 2;">
                <input type="text" class="form-input" name="seller-prelaunch-count" placeholder="ì¸ì›" style="flex: 0.5;">
                <input type="text" class="form-input" name="seller-prelaunch-reward" placeholder="í˜œíƒ (ì˜ˆ: ì ¤ë¦¬ 1ë°•ìŠ¤)" style="flex: 1.5;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
              </div>
            `}
          </div>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addSellerBenefitRow('seller-prelaunch')">+ í•­ëª© ì¶”ê°€</button>
        </div>
        
        <!-- ê³µêµ¬ì˜¤í”ˆ í˜œíƒ -->
        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
            <span style="background: var(--gray-700); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">2</span>
            ê³µêµ¬ì˜¤í”ˆ í˜œíƒ (í”¼ë“œ)
          </label>
          <div id="seller-launch-benefits">
            ${(benefits.launch && benefits.launch.length > 0) ? benefits.launch.map((b, i) => `
              <div class="benefit-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="form-input" name="seller-launch-name" value="${b.name || ''}" placeholder="ì´ë²¤íŠ¸ëª… (ì˜ˆ: ì„ ì°©ìˆœ êµ¬ë§¤ ì´ë²¤íŠ¸)" style="flex: 2;">
                <input type="text" class="form-input" name="seller-launch-count" value="${b.count || ''}" placeholder="ì¸ì›" style="flex: 0.5;">
                <input type="text" class="form-input" name="seller-launch-reward" value="${b.reward || ''}" placeholder="í˜œíƒ (ì˜ˆ: ë„¤ì´ë²„í˜ì´ 1ë§Œì›)" style="flex: 1.5;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
              </div>
            `).join('') : `
              <div class="benefit-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="form-input" name="seller-launch-name" placeholder="ì´ë²¤íŠ¸ëª… (ì˜ˆ: ì„ ì°©ìˆœ êµ¬ë§¤ ì´ë²¤íŠ¸)" style="flex: 2;">
                <input type="text" class="form-input" name="seller-launch-count" placeholder="ì¸ì›" style="flex: 0.5;">
                <input type="text" class="form-input" name="seller-launch-reward" placeholder="í˜œíƒ (ì˜ˆ: ë„¤ì´ë²„í˜ì´ 1ë§Œì›)" style="flex: 1.5;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
              </div>
            `}
          </div>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addSellerBenefitRow('seller-launch')">+ í•­ëª© ì¶”ê°€</button>
        </div>
        
        <!-- ì¶”ê°€ ì§€ì› -->
        <div class="form-group">
          <label class="form-label">âœ¨ ì¶”ê°€ ì§€ì›</label>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-ad" ${benefits.support && benefits.support.includes('ad') ? 'checked' : ''}>
              <span>ì½˜í…ì¸  ê´‘ê³  ë¬´ìƒ ë“±ë¡</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-payment" ${benefits.support && benefits.support.includes('payment') ? 'checked' : ''}>
              <span>ì…€ëŸ¬ ì „ìš© ê²°ì œì°½ ì œê³µ</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-sample" ${benefits.support && benefits.support.includes('sample') ? 'checked' : ''}>
              <span>ìƒ˜í”Œ ë¬´ë£Œ ì œê³µ</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-feed" ${benefits.support && benefits.support.includes('feed') ? 'checked' : ''}>
              <span>í”¼ë“œ ì œì‘ ì§€ì›</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-shipping" ${benefits.support && benefits.support.includes('shipping') ? 'checked' : ''}>
              <span>ë¬´ë£Œ ë°°ì†¡ ì§€ì›</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-commission" ${benefits.support && benefits.support.includes('commission') ? 'checked' : ''}>
              <span>ë†’ì€ íŒë§¤ ìˆ˜ìˆ˜ë£Œ</span>
            </label>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
        </div>
      </form>
    </div>
  `;
}

// ì…€ëŸ¬ í˜œíƒ ë³´ê¸° ëª¨ë‹¬ (ì˜ˆìœ ì¹´ë“œ í˜•íƒœ)
function openSellerBenefitsViewModal(sellerListId) {
  const seller = state.sellerList.find(s => s.id === sellerListId);
  if (!seller) return;
  
  const benefits = seller.benefits || { prelaunch: [], launch: [], support: [] };
  const supportLabels = {
    ad: { icon: 'ğŸ“¢', label: 'ì½˜í…ì¸  ê´‘ê³  ë¬´ìƒ ë“±ë¡' },
    payment: { icon: 'ğŸ’³', label: 'ì…€ëŸ¬ ì „ìš© ê²°ì œì°½ ì œê³µ' },
    sample: { icon: 'ğŸ', label: 'ìƒ˜í”Œ ë¬´ë£Œ ì œê³µ' },
    feed: { icon: 'ğŸ“¸', label: 'í”¼ë“œ ì œì‘ ì§€ì›' },
    shipping: { icon: 'ğŸšš', label: 'ë¬´ë£Œ ë°°ì†¡ ì§€ì›' },
    commission: { icon: 'ğŸ’°', label: 'ë†’ì€ íŒë§¤ ìˆ˜ìˆ˜ë£Œ' }
  };
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header" style="background: var(--gray-900); color: white; margin: -24px -24px 20px -24px; padding: 24px; border-radius: 20px 20px 0 0;">
        <div style="text-align: center; width: 100%;">
          <div style="background: rgba(255,255,255,0.2); display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 14px; margin-bottom: 12px;">
            ëª¨ì—¬ë¼ë”œ Ã— ì…€ëŸ¬
          </div>
          <h2 style="font-size: 20px; font-weight: 700; margin: 0;">${seller.accountName}</h2>
          <div style="margin-top: 12px;">
            <span style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 6px; font-size: 14px; font-weight: 600;">100%</span>
            <span style="font-size: 18px; font-weight: 700; margin-left: 8px;">ë¬´ìƒì§€ì›</span>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal()" style="position: absolute; right: 16px; top: 16px; color: white;">Ã—</button>
      </div>
      
      ${benefits.prelaunch && benefits.prelaunch.length > 0 ? `
        <div style="background: var(--gray-50); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--gray-700); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">1</span>
              <span style="font-weight: 600;">ê³µêµ¬ì˜ˆê³ </span>
            </div>
            <span style="background: var(--gray-200); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: var(--gray-600);">ë¦´ìŠ¤</span>
          </div>
          ${benefits.prelaunch.map(b => `
            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: white; border-radius: 12px; margin-bottom: 8px;">
              <span style="font-size: 20px;">ğŸŸï¸</span>
              <div>
                <div style="font-weight: 600; color: var(--primary);">${b.name} ${b.count ? `<span style="color: var(--primary);">${b.count}ëª…</span>` : ''}</div>
                <div style="font-size: 13px; color: var(--gray-600); margin-top: 2px;">${b.reward}</div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
      
      ${benefits.launch && benefits.launch.length > 0 ? `
        <div style="background: var(--gray-50); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--gray-700); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">2</span>
              <span style="font-weight: 600;">ê³µêµ¬ì˜¤í”ˆ</span>
            </div>
            <span style="background: var(--gray-200); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: var(--gray-600);">í”¼ë“œ</span>
          </div>
          ${benefits.launch.map(b => `
            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: white; border-radius: 12px; margin-bottom: 8px;">
              <span style="font-size: 20px;">${b.name.includes('í›„ê¸°') ? 'ğŸ’¬' : 'ğŸ›’'}</span>
              <div>
                <div style="font-weight: 600; color: var(--primary);">${b.name} ${b.count ? `<span style="color: var(--primary);">${b.count}ëª…</span>` : ''}</div>
                <div style="font-size: 13px; color: var(--gray-600); margin-top: 2px;">${b.reward}</div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
      
      ${benefits.support && benefits.support.length > 0 ? `
        <div style="background: var(--gray-800); border-radius: 16px; padding: 20px; color: white;">
          <div style="font-size: 13px; margin-bottom: 12px;">âœ¨ ì¶”ê°€ ì§€ì›</div>
          <div style="display: grid; grid-template-columns: repeat(${Math.min(benefits.support.length, 4)}, 1fr); gap: 12px;">
            ${benefits.support.map(s => {
              const info = supportLabels[s] || { icon: 'âœ“', label: s };
              return `
                <div style="text-align: center;">
                  <div style="background: var(--gray-700); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 20px;">${info.icon}</div>
                  <div style="font-size: 11px; line-height: 1.3;">${info.label}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      ` : ''}
      
      <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gray-200); font-size: 12px; color: var(--gray-500); text-align: center;">
        ğŸ“£ ê³µêµ¬ì˜ˆê³  ë¦´ìŠ¤ ì—…ë¡œë“œ í›„ ì•Œë ¤ì£¼ì‹œë©´<br>ëª¨ì—¬ë¼ë”œ ê³„ì •ì—ì„œ <strong style="color: var(--primary);">ê´‘ê³  ë“±ë¡</strong>í•´ë“œë ¤ìš”!
      </div>
      
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button class="btn btn-primary" onclick="closeModal(); openSellerBenefitsModal('${sellerListId}', true)">ìˆ˜ì •í•˜ê¸°</button>
      </div>
    </div>
  `;
}

function addSellerBenefitRow(type) {
  const container = document.getElementById(type + '-benefits');
  const row = document.createElement('div');
  row.className = 'benefit-row';
  row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
  row.innerHTML = `
    <input type="text" class="form-input" name="${type}-name" placeholder="ì´ë²¤íŠ¸ëª…" style="flex: 2;">
    <input type="text" class="form-input" name="${type}-count" placeholder="ì¸ì›" style="flex: 0.5;">
    <input type="text" class="form-input" name="${type}-reward" placeholder="í˜œíƒ" style="flex: 1.5;">
    <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
  `;
  container.appendChild(row);
}

async function submitSellerBenefits(e, sellerListId) {
  e.preventDefault();
  
  // í˜œíƒ ì •ë³´ ìˆ˜ì§‘
  const prelaunchNames = document.querySelectorAll('input[name="seller-prelaunch-name"]');
  const prelaunchCounts = document.querySelectorAll('input[name="seller-prelaunch-count"]');
  const prelaunchRewards = document.querySelectorAll('input[name="seller-prelaunch-reward"]');
  const prelaunch = [];
  prelaunchNames.forEach((el, i) => {
    if (el.value.trim() || prelaunchRewards[i].value.trim()) {
      prelaunch.push({
        name: el.value.trim(),
        count: prelaunchCounts[i].value.trim(),
        reward: prelaunchRewards[i].value.trim()
      });
    }
  });
  
  const launchNames = document.querySelectorAll('input[name="seller-launch-name"]');
  const launchCounts = document.querySelectorAll('input[name="seller-launch-count"]');
  const launchRewards = document.querySelectorAll('input[name="seller-launch-reward"]');
  const launch = [];
  launchNames.forEach((el, i) => {
    if (el.value.trim() || launchRewards[i].value.trim()) {
      launch.push({
        name: el.value.trim(),
        count: launchCounts[i].value.trim(),
        reward: launchRewards[i].value.trim()
      });
    }
  });
  
  const support = [];
  if (document.querySelector('input[name="seller-support-ad"]').checked) support.push('ad');
  if (document.querySelector('input[name="seller-support-payment"]').checked) support.push('payment');
  if (document.querySelector('input[name="seller-support-sample"]').checked) support.push('sample');
  if (document.querySelector('input[name="seller-support-feed"]').checked) support.push('feed');
  if (document.querySelector('input[name="seller-support-shipping"]').checked) support.push('shipping');
  if (document.querySelector('input[name="seller-support-commission"]').checked) support.push('commission');
  
  try {
    await db.collection('sellerList').doc(sellerListId).update({
      benefits: { prelaunch, launch, support }
    });
    showToast('í˜œíƒ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(err) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ========== ê²½ì˜íŒ€ ì •ì‚°ì„œ ìƒì„± ==========

function generateManagementReport() {
  // ë°ì´í„° ë¶„ë¥˜ - ì •ì‚°ëŒ€ê¸°(ë¯¸ì™„ë£Œ)ë§Œ í‘œì‹œ
  const sellerInhouse = state.sellerSettlements.filter(s => s.productType === 'inhouse' && !s.isCompleted);
  const sellerExternal = state.sellerSettlements.filter(s => s.productType === 'external' && !s.isCompleted);
  const supplierSettlements = (state.supplierSettlements || []).filter(s => !s.isCompleted);
  
  // ìì‚¬ ìƒí’ˆ í•©ê³„
  const inhouseTotals = sellerInhouse.reduce((acc, s) => {
    acc.salesAmount += Number(s.salesAmount) || 0;
    acc.marginAmount += Number(s.marginAmount) || 0;
    acc.actualPayment += Number(s.actualPayment) || 0;
    return acc;
  }, { salesAmount: 0, marginAmount: 0, actualPayment: 0 });
  
  // íƒ€ì‚¬ ìƒí’ˆ í•©ê³„
  const externalTotals = sellerExternal.reduce((acc, s) => {
    acc.salesAmount += Number(s.salesAmount) || 0;
    acc.supplyAmount += Number(s.supplyAmount) || 0;
    acc.marginAmount += Number(s.marginAmount) || 0;
    acc.actualPayment += Number(s.actualPayment) || 0;
    return acc;
  }, { salesAmount: 0, supplyAmount: 0, marginAmount: 0, actualPayment: 0 });
  
  // ê³µê¸‰ì‚¬ ì •ì‚° í•©ê³„
  const supplierTotals = supplierSettlements.reduce((acc, s) => {
    acc.supplyAmount += Number(s.totalAmount) || 0;
    acc.shippingFee += Number(s.totalShippingFee) || 0;
    return acc;
  }, { supplyAmount: 0, shippingFee: 0 });
  
  const today = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
  const totalPendingCount = sellerInhouse.length + sellerExternal.length + supplierSettlements.length;
  
  // ëª¨ë‹¬ë¡œ ì •ì‚°ì„œ í‘œì‹œ
  const modal = document.getElementById('modal');
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 1400px; width: 95%; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>ğŸ“‹ ê²½ì˜íŒ€ ì œì¶œìš© ì •ì‚°ì„œ</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <div id="management-report-content" style="padding: 24px; background: white;">
        <!-- í—¤ë” -->
        <div style="text-align: center; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid #f97316;">
          <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #1f2937;">ğŸ“Š ì •ì‚° ë‚´ì—­ì„œ</h1>
          <p style="color: #6b7280; font-size: 14px;">${today}</p>
          <div style="margin-top: 12px; display: inline-block; background: var(--gray-100); color: var(--gray-600); padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">
            â³ ì •ì‚°ëŒ€ê¸° ${totalPendingCount}ê±´
          </div>
        </div>
        
        <!-- 1 ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚° -->
        <div style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #3b82f6;">
            <span style="background: #3b82f6; color: white; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">1</span>
            <h3 style="font-size: 14px; font-weight: 700; color: #1e40af; margin: 0;">ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚°</h3>
            <span style="font-size: 11px; color: #6b7280;">(${sellerInhouse.length}ê±´)</span>
          </div>
          
          ${sellerInhouse.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">ì •ì‚°ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : `
          <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 9%; white-space: nowrap;">ì…€ëŸ¬ëª…</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 5%; white-space: nowrap;">ë¸Œëœë“œ</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 10%; white-space: nowrap;">ê³µêµ¬ê¸°ê°„</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; min-width: 180px;">íŒë§¤ìƒí’ˆ</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 6%; white-space: nowrap;">ë‹¨ê°€</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 4%; white-space: nowrap;">ìˆ˜ëŸ‰</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 7%; white-space: nowrap;">íŒë§¤ê¸ˆì•¡</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 4%; white-space: nowrap; background: #fef3c7;">ë§ˆì§„ìœ¨</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 7%; white-space: nowrap;">ë§ˆì§„ê¸ˆì•¡</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 5%; white-space: nowrap;">ì›ì²œì„¸</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 6%; white-space: nowrap;">ì†Œê³„</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 7%; white-space: nowrap; background: #dbeafe; font-weight: 700;">ì´ì‹¤ì§€ê¸‰ì•¡</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 7%; white-space: nowrap;">ì •ì‚°ì¼</th>
              </tr>
            </thead>
            <tbody>
              ${sellerInhouse.map(s => {
                // 1. ì…€ëŸ¬ ì •ì‚°ì˜ salesItems ë¨¼ì € í™•ì¸
                let items = s.salesItems || s.items || [];

                // 2. salesItemsê°€ ì—†ìœ¼ë©´ ê³µêµ¬ ê´€ë¦¬(deals)ì—ì„œ ìƒí’ˆ ì •ë³´ ì—°ë™
                let matchingDeal = null;
                if (items.length === 0 && s.dealPeriod) {
                  matchingDeal = state.deals.find(d => {
                    const dealPeriod = d.startDate + '~' + d.endDate;
                    return dealPeriod === s.dealPeriod ||
                           (d.brandName === s.brandName) ||
                           (d.sellerName && d.sellerName.includes(s.sellerName));
                  });
                  // selectedProducts ìš°ì„  ì‚¬ìš© (ê³µêµ¬ ìˆ˜ì •ì—ì„œ ì…ë ¥í•œ ë§ˆì§„ìœ¨ í¬í•¨)
                  const dealProducts = matchingDeal?.selectedProducts || matchingDeal?.products || [];
                  if (matchingDeal && dealProducts.length > 0) {
                    items = dealProducts.map(p => ({
                      productName: p.productName || p.name,
                      unitPrice: Number(p.salePrice) || Number(p.price) || 0,
                      quantity: 0,
                      amount: 0,
                      marginRate: Number(p.marginRate) || 0,
                      marginAmount: 0,
                      actualPayment: 0
                    }));
                  }
                }

                // ê¸°ë³¸ ë§ˆì§„ìœ¨: ê³µêµ¬ì˜ selectedProducts ë§ˆì§„ìœ¨ > ì •ì‚°ì„œ ë§ˆì§„ìœ¨ > ê³„ì‚°ê°’ > 10%
                let defaultMarginRate = 10;
                // 1) ê³µêµ¬ì˜ selectedProductsì—ì„œ ë§ˆì§„ìœ¨ ê°€ì ¸ì˜¤ê¸°
                if (matchingDeal?.selectedProducts?.length > 0) {
                  const productsWithMargin = matchingDeal.selectedProducts.filter(p => p.marginRate && Number(p.marginRate) > 0);
                  if (productsWithMargin.length > 0) {
                    defaultMarginRate = Math.round(productsWithMargin.reduce((sum, p) => sum + Number(p.marginRate), 0) / productsWithMargin.length * 10) / 10;
                  }
                }
                // 2) ì •ì‚°ì„œì— ë§ˆì§„ìœ¨ì´ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©
                if (defaultMarginRate === 10 && Number(s.marginRate) > 0) {
                  defaultMarginRate = Number(s.marginRate);
                }
                // 3) íŒë§¤ê¸ˆì•¡ê³¼ ë§ˆì§„ê¸ˆì•¡ìœ¼ë¡œ ì—­ì‚°
                if (defaultMarginRate === 10 && Number(s.salesAmount) > 0 && Number(s.marginAmount) > 0) {
                  defaultMarginRate = Math.round(Number(s.marginAmount) / Number(s.salesAmount) * 100);
                }

                if (items.length === 0) {
                  return '<tr>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;"><strong>' + (s.sellerName || '-') + '</strong></td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + (s.brandName || '-') + '</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px;">' + (s.dealPeriod || '-') + '</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; color: #9ca3af;">(í’ˆëª©ì •ë³´ì—†ìŒ)</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">-</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + (s.totalQuantity || 0) + '</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + Number(s.salesAmount || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; background: #fef3c7; color: #92400e; font-weight: 600;">' + defaultMarginRate + '%</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + Number(s.marginAmount || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + Number(s.withholdingTax || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + Number(s.actualPayment || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; background: #dbeafe; font-weight: 700; color: #1e40af;">' + Number(s.actualPayment || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px;">' + (s.settlementDate || '-') + '</td>' +
                    '</tr>';
                } else {
                  let rows = '';
                  const totalActual = Number(s.actualPayment) || 0;

                  items.forEach((item, idx) => {
                    const isFirst = idx === 0;
                    const rowspan = items.length;
                    const qty = Number(item.quantity) || 0;
                    const unitPrice = Number(item.unitPrice) || 0;
                    const itemSalesAmount = Number(item.amount) || (unitPrice * qty);
                    const itemMarginRate = Number(item.marginRate) || defaultMarginRate;
                    const itemMargin = Number(item.marginAmount) || Math.round(itemSalesAmount * itemMarginRate / 100);
                    const itemTax = Math.round(itemMargin * 0.033);
                    const itemSubtotal = Number(item.actualPayment) || (itemMargin - itemTax);

                    rows += '<tr>' +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; vertical-align: middle;" rowspan="' + rowspan + '"><strong>' + (s.sellerName || '-') + '</strong></td>' : '') +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.brandName || '-') + '</td>' : '') +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.dealPeriod || '-') + '</td>' : '') +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: left; font-size: 9px; word-break: break-all;">' + (item.productName || '-') + '</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + unitPrice.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + qty + '</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + itemSalesAmount.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; background: #fef3c7; color: #92400e; font-weight: 600;">' + itemMarginRate + '%</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + itemMargin.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + itemTax.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + itemSubtotal.toLocaleString() + 'ì›</td>' +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; vertical-align: middle; background: #dbeafe; font-weight: 700; color: #1e40af;" rowspan="' + rowspan + '">' + totalActual.toLocaleString() + 'ì›</td>' : '') +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.settlementDate || '-') + '</td>' : '') +
                      '</tr>';
                  });
                  return rows;
                }
              }).join('')}
              <tr style="background: #f3f4f6; font-weight: 700;">
                <td colspan="6" style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">í•©ê³„</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">${sellerInhouse.reduce((sum,s)=>sum+(Number(s.totalQuantity)||0),0)}</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">${inhouseTotals.salesAmount.toLocaleString()}ì›</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; background: #fef3c7;">-</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">${inhouseTotals.marginAmount.toLocaleString()}ì›</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">${sellerInhouse.reduce((sum,s)=>sum+(Number(s.withholdingTax)||0),0).toLocaleString()}ì›</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;"></td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; background: #bfdbfe; font-weight: 700; color: #1e40af;">${inhouseTotals.actualPayment.toLocaleString()}ì›</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;"></td>
              </tr>
            </tbody>
          </table>
          `}
        </div>
        
        <!-- 2 íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (í†µí•© í…Œì´ë¸”) -->
        <div style="margin-bottom: 32px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #059669;">
            <span style="background: #059669; color: white; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">2</span>
            <h3 style="font-size: 14px; font-weight: 700; color: #065f46; margin: 0;">íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚°</h3>
            <span style="font-size: 11px; color: #6b7280;">(${sellerExternal.length}ê±´)</span>
          </div>

          ${sellerExternal.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">íƒ€ì‚¬ ìƒí’ˆ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : `
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 9px; min-width: 1300px;">
              <thead>
                <tr style="background: linear-gradient(90deg, #ecfdf5 0%, var(--gray-100) 100%);">
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 7%; white-space: nowrap;">ì…€ëŸ¬ëª…</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap;">ë¸Œëœë“œ(ê³µê¸‰ì‚¬)</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 8%; white-space: nowrap;">ê³µêµ¬ê¸°ê°„</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; min-width: 160px;">íŒë§¤ìƒí’ˆ</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap;">ë‹¨ê°€</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 3%; white-space: nowrap;">ìˆ˜ëŸ‰</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap;">íŒë§¤ê¸ˆì•¡</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 3%; white-space: nowrap; background: #fef3c7;">ë§ˆì§„ìœ¨</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap; background: #d1fae5;">ë§ˆì§„ê¸ˆì•¡</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 4%; white-space: nowrap; background: #d1fae5;">ì›ì²œì„¸</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap; background: #d1fae5;">ì†Œê³„</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap; background: #a7f3d0; font-weight: 700;">ì´ì‹¤ì§€ê¸‰ì•¡</th>
                  <th style="padding: 4px 2px; border: 1px solid #fde68a; text-align: center; width: 5%; white-space: nowrap; background: #fde68a;">ê³µê¸‰ë‹¨ê°€</th>
                  <th style="padding: 4px 2px; border: 1px solid #fde68a; text-align: center; width: 5%; white-space: nowrap; background: #fde68a;">ê³µê¸‰ê°€ì•¡</th>
                  <th style="padding: 4px 2px; border: 1px solid #fde68a; text-align: center; width: 4%; white-space: nowrap; background: #fde68a;">ë¶€ê°€ì„¸</th>
                  <th style="padding: 4px 2px; border: 1px solid #fde68a; text-align: center; width: 5%; white-space: nowrap; background: var(--gray-300); font-weight: 700;">ì •ì‚°ê¸ˆì•¡(V+)</th>
                  <th style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; width: 5%; white-space: nowrap;">ì •ì‚°ì¼</th>
                </tr>
                <tr style="background: #f9fafb; font-size: 8px; color: #6b7280;">
                  <th colspan="7" style="border: 1px solid #e5e7eb;"></th>
                  <th colspan="5" style="border: 1px solid #d1fae5; background: #ecfdf5; color: #065f46;">â† ì…€ëŸ¬ ì •ì‚° â†’</th>
                  <th colspan="4" style="border: 1px solid #fde68a; background: var(--gray-50); color: var(--gray-600);">â† ê³µê¸‰ì‚¬ ì •ì‚° â†’</th>
                  <th style="border: 1px solid #e5e7eb;"></th>
                </tr>
              </thead>
              <tbody>
                ${(() => {
                  let totalSupplyAmountSum = 0;
                  let totalVatAmountSum = 0;
                  let totalSupplierPaymentSum = 0;

                  return sellerExternal.map(s => {
                    // ì…€ëŸ¬ ì •ì‚° ë°ì´í„°
                    let sellerItems = s.salesItems || s.items || [];

                    // ğŸ”¥ ê³µêµ¬ ê´€ë¦¬(deals)ì—ì„œ ìƒí’ˆ ì •ë³´ + ê³µê¸‰ë‹¨ê°€ ê°€ì ¸ì˜¤ê¸°
                    let matchingDeal = null;
                    if (s.dealPeriod || s.brandName) {
                      matchingDeal = state.deals.find(d => {
                        const dealPeriod = d.startDate + '~' + d.endDate;
                        return dealPeriod === s.dealPeriod || (d.brandName === s.brandName);
                      });
                    }

                    // dealsì—ì„œ selectedProducts ê°€ì ¸ì˜¤ê¸° (ê³µê¸‰ë‹¨ê°€ ì •ë³´ í¬í•¨)
                    const dealProducts = matchingDeal?.selectedProducts || matchingDeal?.products || [];

                    // sellerItemsê°€ ì—†ìœ¼ë©´ dealProducts ì‚¬ìš©
                    if (sellerItems.length === 0 && dealProducts.length > 0) {
                      sellerItems = dealProducts.map(p => ({
                        productName: p.productName || p.name,
                        unitPrice: Number(p.salePrice) || Number(p.price) || 0,
                        supplyPrice: Number(p.supplyPrice) || 0,
                        marginRate: Number(p.marginRate) || 0,
                        quantity: 0,
                        amount: 0
                      }));
                    }

                    const totalActualPayment = Number(s.actualPayment) || 0;
                    const totalQty = Number(s.totalQuantity) || 0;

                    // ê¸°ë³¸ ë§ˆì§„ìœ¨: ê³µêµ¬ì˜ selectedProducts ë§ˆì§„ìœ¨ > ì •ì‚°ì„œ ë§ˆì§„ìœ¨ > ê³„ì‚°ê°’ > 10%
                    let defaultMarginRate = 10;
                    // 1) ê³µêµ¬ì˜ selectedProductsì—ì„œ ë§ˆì§„ìœ¨ ê°€ì ¸ì˜¤ê¸°
                    if (matchingDeal?.selectedProducts?.length > 0) {
                      const productsWithMargin = matchingDeal.selectedProducts.filter(p => p.marginRate && Number(p.marginRate) > 0);
                      if (productsWithMargin.length > 0) {
                        defaultMarginRate = Math.round(productsWithMargin.reduce((sum, p) => sum + Number(p.marginRate), 0) / productsWithMargin.length * 10) / 10;
                      }
                    }
                    // 2) ì •ì‚°ì„œì— ë§ˆì§„ìœ¨ì´ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©
                    if (defaultMarginRate === 10 && Number(s.marginRate) > 0) {
                      defaultMarginRate = Number(s.marginRate);
                    }
                    // 3) íŒë§¤ê¸ˆì•¡ê³¼ ë§ˆì§„ê¸ˆì•¡ìœ¼ë¡œ ì—­ì‚°
                    if (defaultMarginRate === 10 && Number(s.salesAmount) > 0 && Number(s.marginAmount) > 0) {
                      defaultMarginRate = Math.round(Number(s.marginAmount) / Number(s.salesAmount) * 100);
                    }

                    // ğŸ”¥ ê³µê¸‰ë‹¨ê°€ ì°¾ê¸° - deals.selectedProductsì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    const getSupplyPriceForItem = (itemName) => {
                      // 1. dealProductsì—ì„œ ë§¤ì¹­
                      for (const dp of dealProducts) {
                        const dpName = (dp.productName || dp.name || '').toLowerCase();
                        const iName = (itemName || '').toLowerCase();
                        if (dpName && iName && (dpName.includes(iName) || iName.includes(dpName))) {
                          return Number(dp.supplyPrice) || 0;
                        }
                      }
                      // 2. state.productsì—ì„œ ë§¤ì¹­
                      for (const p of (state.products || [])) {
                        const pName = (p.productName || '').toLowerCase();
                        const iName = (itemName || '').toLowerCase();
                        if (pName && iName && (pName.includes(iName) || iName.includes(pName))) {
                          return Number(p.supplyPrice) || 0;
                        }
                      }
                      return 0;
                    };

                    if (sellerItems.length === 0) {
                      // í’ˆëª© ì •ë³´ ì—†ëŠ” ê²½ìš° - ì „ì²´ ê³µê¸‰ê°€ ê³„ì‚°
                      const avgSupplyPrice = Number(s.supplyPrice) || (dealProducts.length > 0 ? dealProducts.reduce((sum, p) => sum + (Number(p.supplyPrice) || 0), 0) / dealProducts.length : 0);
                      const totalSupplyAmount = Math.round(avgSupplyPrice * totalQty);
                      const totalVat = Math.round(totalSupplyAmount * 0.1);
                      const totalSupplierPayment = totalSupplyAmount + totalVat;

                      totalSupplyAmountSum += totalSupplyAmount;
                      totalVatAmountSum += totalVat;
                      totalSupplierPaymentSum += totalSupplierPayment;

                      return '<tr>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;"><strong>' + (s.sellerName || '-') + '</strong></td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + (s.brandName || '-') + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px;">' + (s.dealPeriod || '-') + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; color: #9ca3af;">(í’ˆëª©ì •ë³´ì—†ìŒ)</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">-</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + totalQty + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + Number(s.salesAmount || 0).toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fef3c7; color: #92400e; font-weight: 600;">' + defaultMarginRate + '%</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + Number(s.marginAmount || 0).toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + Number(s.withholdingTax || 0).toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + totalActualPayment.toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #d1fae5; font-weight: 700; color: #065f46;">' + totalActualPayment.toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + (avgSupplyPrice > 0 ? avgSupplyPrice.toLocaleString() + 'ì›' : '-') + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + (totalSupplyAmount > 0 ? totalSupplyAmount.toLocaleString() + 'ì›' : '-') + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + (totalVat > 0 ? totalVat.toLocaleString() + 'ì›' : '-') + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-100); font-weight: 700; color: var(--gray-600);">' + (totalSupplierPayment > 0 ? totalSupplierPayment.toLocaleString() + 'ì›' : '-') + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px;">' + (s.settlementDate || '-') + '</td>' +
                        '</tr>';
                    } else {
                      // í’ˆëª©ë³„ ìƒì„¸ í‘œì‹œ
                      let rows = '';
                      const rowspan = sellerItems.length;
                      let rowTotalSupply = 0;
                      let rowTotalVat = 0;

                      sellerItems.forEach((item, idx) => {
                        const isFirst = idx === 0;
                        const qty = Number(item.quantity) || 0;
                        const unitPrice = Number(item.unitPrice) || Number(item.salePrice) || 0;
                        const itemSalesAmount = Number(item.amount) || (unitPrice * qty);

                        // ë§ˆì§„ìœ¨ ê³„ì‚°
                        const itemMarginRate = Number(item.marginRate) || defaultMarginRate;

                        // ì…€ëŸ¬ ì •ì‚° ê³„ì‚°
                        const totalSalesAmt = Number(s.salesAmount) || 0;
                        const totalMarginAmt = Number(s.marginAmount) || 0;
                        const ratio = totalSalesAmt > 0 ? itemSalesAmount / totalSalesAmt : (1 / sellerItems.length);
                        const itemMargin = Number(item.marginAmount) || Math.round(itemSalesAmount * itemMarginRate / 100);
                        const itemTax = Math.round(itemMargin * 0.033);
                        const itemSubtotal = Number(item.actualPayment) || (itemMargin - itemTax);

                        // ğŸ”¥ ê³µê¸‰ì‚¬ ì •ì‚° ê³„ì‚° - ê³µê¸‰ë‹¨ê°€ ì°¾ê¸°
                        let supplyPrice = Number(item.supplyPrice) || 0;
                        if (!supplyPrice) {
                          supplyPrice = getSupplyPriceForItem(item.productName);
                        }
                        if (!supplyPrice) {
                          supplyPrice = Number(s.supplyPrice) || 0;
                        }

                        const supplyAmount = supplyPrice > 0 ? Math.round(supplyPrice * qty) : 0;
                        const vatAmount = Math.round(supplyAmount * 0.1);
                        const itemSupplierTotal = supplyAmount + vatAmount;

                        rowTotalSupply += supplyAmount;
                        rowTotalVat += vatAmount;

                        rows += '<tr>' +
                          (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle;" rowspan="' + rowspan + '"><strong>' + (s.sellerName || '-') + '</strong></td>' : '') +
                          (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.brandName || '-') + '</td>' : '') +
                          (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.dealPeriod || '-') + '</td>' : '') +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: left; font-size: 8px; word-break: break-all;">' + (item.productName || '-') + '</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + unitPrice.toLocaleString() + 'ì›</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + qty + '</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + itemSalesAmount.toLocaleString() + 'ì›</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fef3c7; color: #92400e; font-weight: 600;">' + itemMarginRate + '%</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + itemMargin.toLocaleString() + 'ì›</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + itemTax.toLocaleString() + 'ì›</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + itemSubtotal.toLocaleString() + 'ì›</td>' +
                          (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle; background: #d1fae5; font-weight: 700; color: #065f46;" rowspan="' + rowspan + '">' + totalActualPayment.toLocaleString() + 'ì›</td>' : '') +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + (supplyPrice > 0 ? supplyPrice.toLocaleString() + 'ì›' : '-') + '</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + (supplyAmount > 0 ? supplyAmount.toLocaleString() + 'ì›' : '-') + '</td>' +
                          '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + (vatAmount > 0 ? vatAmount.toLocaleString() + 'ì›' : '-') + '</td>' +
                          (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle; background: var(--gray-100); font-weight: 700; color: var(--gray-600);" rowspan="' + rowspan + '">' + (rowTotalSupply + rowTotalVat > 0 ? (rowTotalSupply + rowTotalVat).toLocaleString() + 'ì›' : '-') + '</td>' : '') +
                          (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.settlementDate || '-') + '</td>' : '') +
                          '</tr>';
                      });

                      totalSupplyAmountSum += rowTotalSupply;
                      totalVatAmountSum += rowTotalVat;
                      totalSupplierPaymentSum += rowTotalSupply + rowTotalVat;

                      return rows;
                    }
                  }).join('') + '<tr style="background: #f3f4f6; font-weight: 700;">' +
                    '<td colspan="6" style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">í•©ê³„</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + sellerExternal.reduce((sum,s)=>sum+(Number(s.totalQuantity)||0),0) + '</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + externalTotals.salesAmount.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fef3c7;">-</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #d1fae5;">' + externalTotals.marginAmount.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #d1fae5;">' + sellerExternal.reduce((sum,s)=>sum+(Number(s.withholdingTax)||0),0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #d1fae5;"></td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #a7f3d0; color: #065f46;">' + externalTotals.actualPayment.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-100);">-</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-100);">' + totalSupplyAmountSum.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-100);">' + totalVatAmountSum.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-300); color: var(--gray-600);">' + totalSupplierPaymentSum.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;"></td>' +
                    '</tr>';
                })()}
              </tbody>
            </table>
          </div>
          <p style="font-size: 10px; color: #6b7280; margin-top: 8px;">
            ğŸ’¡ <span style="background: #d1fae5; padding: 1px 4px; border-radius: 2px;">ë…¹ìƒ‰ ì»¬ëŸ¼</span>: ì…€ëŸ¬ ì •ì‚° í•­ëª© | <span style="background: #fffbeb; padding: 1px 4px; border-radius: 2px;">ë…¸ë€ìƒ‰ ì»¬ëŸ¼</span>: ê³µê¸‰ì‚¬ ì •ì‚° í•­ëª©
          </p>
          `}
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: center;">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button class="btn btn-primary" style="background: #217346;" onclick="downloadManagementReportExcel()">ğŸ“Š ì—‘ì…€ íŒŒì¼ ì €ì¥</button>
        <button class="btn btn-primary" style="background: #059669;" onclick="downloadManagementReportHTML()">ğŸ’¾ HTML ì €ì¥</button>
      </div>
    </div>
  `;
  modal.className = 'modal show';
}

// ê²½ì˜íŒ€ ì •ì‚°ì„œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
async function downloadManagementReportExcel() {
  // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    await new Promise(resolve => script.onload = resolve);
  }
  
  const today = new Date().toISOString().split('T')[0];
  const wb = XLSX.utils.book_new();
  
  // ë°ì´í„° ë¶„ë¥˜
  const sellerInhouse = state.sellerSettlements.filter(s => s.productType === 'inhouse' && !s.isCompleted);
  const sellerExternal = state.sellerSettlements.filter(s => s.productType === 'external' && !s.isCompleted);
  const supplierSettlements = (state.supplierSettlements || []).filter(s => !s.isCompleted);
  
  // ===== ì‹œíŠ¸1: ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚° =====
  const sheet1Data = [
    ['ğŸ“Š ì •ì‚° ë‚´ì—­ì„œ | ' + today],
    [],
    ['1. ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚° (' + sellerInhouse.length + 'ê±´)'],
    ['ì…€ëŸ¬ëª…', 'ë¸Œëœë“œ', 'ê³µêµ¬ê¸°ê°„', 'íŒë§¤ìƒí’ˆ', 'ë‹¨ê°€', 'ìˆ˜ëŸ‰', 'íŒë§¤ê¸ˆì•¡', 'ë§ˆì§„ê¸ˆì•¡', 'ì›ì²œì„¸', 'ì†Œê³„', 'ì´ì‹¤ì§€ê¸‰ì•¡', 'ì •ì‚°ì¼']
  ];
  
  let inhouseTotalQty = 0, inhouseTotalSales = 0, inhouseTotalMargin = 0, inhouseTotalTax = 0, inhouseTotalPayment = 0;
  
  sellerInhouse.forEach(s => {
    const items = s.salesItems || s.items || [];
    if (items.length === 0) {
      const qty = Number(s.totalQuantity) || 0;
      const sales = Number(s.salesAmount) || 0;
      const margin = Number(s.marginAmount) || 0;
      const tax = Number(s.withholdingTax) || 0;
      const payment = Number(s.actualPayment) || 0;
      inhouseTotalQty += qty;
      inhouseTotalSales += sales;
      inhouseTotalMargin += margin;
      inhouseTotalTax += tax;
      inhouseTotalPayment += payment;
      sheet1Data.push([s.sellerName || '-', s.brandName || '-', s.dealPeriod || '-', '(í’ˆëª©ì •ë³´ì—†ìŒ)', '-', qty, sales, margin, tax, payment, payment, s.settlementDate || '-']);
    } else {
      items.forEach((item, idx) => {
        const qty = Number(item.quantity) || 0;
        const unitPrice = Number(item.unitPrice) || 0;
        const itemSales = Number(item.amount) || (unitPrice * qty);
        const itemMargin = Number(item.marginAmount) || 0;
        const itemTax = Math.round(itemMargin * 0.033);
        const itemSubtotal = Number(item.actualPayment) || (itemMargin - itemTax);
        inhouseTotalQty += qty;
        inhouseTotalSales += itemSales;
        inhouseTotalMargin += itemMargin;
        inhouseTotalTax += itemTax;
        if (idx === 0) inhouseTotalPayment += Number(s.actualPayment) || 0;
        sheet1Data.push([
          idx === 0 ? (s.sellerName || '-') : '',
          idx === 0 ? (s.brandName || '-') : '',
          idx === 0 ? (s.dealPeriod || '-') : '',
          item.productName || '-',
          unitPrice,
          qty,
          itemSales,
          itemMargin,
          itemTax,
          itemSubtotal,
          idx === 0 ? (Number(s.actualPayment) || 0) : '',
          idx === 0 ? (s.settlementDate || '-') : ''
        ]);
      });
    }
  });
  
  sheet1Data.push(['í•©ê³„', '', '', '', '', inhouseTotalQty, inhouseTotalSales, inhouseTotalMargin, inhouseTotalTax, '', inhouseTotalPayment, '']);
  
  const ws1 = XLSX.utils.aoa_to_sheet(sheet1Data);
  ws1['!cols'] = [{wch:18},{wch:10},{wch:22},{wch:30},{wch:10},{wch:6},{wch:12},{wch:12},{wch:10},{wch:10},{wch:12},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws1, '1.ìì‚¬ìƒí’ˆ-ì…€ëŸ¬ì •ì‚°');
  
  // ===== ì‹œíŠ¸2: íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (í†µí•©) =====
  const sheet2Data = [
    ['2. íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (' + (sellerExternal.length + supplierSettlements.length) + 'ê±´)'],
    [],
    ['', '', '', '', '', '', '', 'â† ì…€ëŸ¬ ì •ì‚° â†’', '', '', '', 'â† ê³µê¸‰ì‚¬ ì •ì‚° â†’', '', '', '', ''],
    ['ì…€ëŸ¬ëª…', 'ë¸Œëœë“œ(ê³µê¸‰ì‚¬)', 'ê³µêµ¬ê¸°ê°„', 'íŒë§¤ìƒí’ˆ', 'ë‹¨ê°€', 'ìˆ˜ëŸ‰', 'íŒë§¤ê¸ˆì•¡', 'ë§ˆì§„ê¸ˆì•¡', 'ì›ì²œì„¸', 'ì†Œê³„', 'ì´ì‹¤ì§€ê¸‰ì•¡', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸(10%)', 'ì´í•©ê³„', 'ì •ì‚°ê¸ˆì•¡(V+)', 'ì •ì‚°ì¼']
  ];
  
  let extTotalQty = 0, extTotalSales = 0, extTotalMargin = 0, extTotalTax = 0, extTotalPayment = 0;
  let supTotalSupply = 0, supTotalVat = 0, supTotalAmount = 0;
  
  sellerExternal.forEach(s => {
    let sellerItems = s.salesItems || s.items || [];
    
    // ë§¤ì¹­ë˜ëŠ” ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸°
    const matchingSupplier = supplierSettlements.find(sup => 
      ((sup.sellerName || '').includes(s.sellerName || '') || (s.sellerName || '').includes(sup.sellerName || '')) &&
      ((sup.brandName || '').includes(s.brandName || '') || (s.brandName || '').includes(sup.brandName || ''))
    );
    
    const supplierItems = matchingSupplier ? (matchingSupplier.items || []) : [];
    if (sellerItems.length === 0 && supplierItems.length > 0) {
      sellerItems = supplierItems;
    }
    
    const totalActualPayment = Number(s.actualPayment) || 0;
    const supplierTotalAmount = matchingSupplier ? Number(matchingSupplier.totalAmount) || 0 : 0;
    const supplierTotalSupply = matchingSupplier ? Number(matchingSupplier.totalSupplyAmount) || 0 : 0;
    const supplierTotalVat = matchingSupplier ? Number(matchingSupplier.totalVatAmount) || 0 : 0;
    
    if (sellerItems.length === 0) {
      const qty = Number(s.totalQuantity) || 0;
      const sales = Number(s.salesAmount) || 0;
      const margin = Number(s.marginAmount) || 0;
      const tax = Number(s.withholdingTax) || 0;
      extTotalQty += qty;
      extTotalSales += sales;
      extTotalMargin += margin;
      extTotalTax += tax;
      extTotalPayment += totalActualPayment;
      supTotalSupply += supplierTotalSupply;
      supTotalVat += supplierTotalVat;
      supTotalAmount += supplierTotalAmount;
      
      sheet2Data.push([
        s.sellerName || '-', s.brandName || '-', s.dealPeriod || '-', '(í’ˆëª©ì •ë³´ì—†ìŒ)', '-', qty, sales,
        margin, tax, totalActualPayment, totalActualPayment,
        supplierTotalSupply, supplierTotalVat, supplierTotalAmount, supplierTotalAmount, s.settlementDate || '-'
      ]);
    } else {
      sellerItems.forEach((item, idx) => {
        const qty = Number(item.quantity) || 0;
        const unitPrice = Number(item.unitPrice) || Number(item.salePrice) || Number(item.supplyPrice) || 0;
        const itemSales = Number(item.amount) || (unitPrice * qty);
        const totalSalesAmt = Number(s.salesAmount) || 0;
        const totalMarginAmt = Number(s.marginAmount) || 0;
        const ratio = totalSalesAmt > 0 ? itemSales / totalSalesAmt : (1 / sellerItems.length);
        const itemMargin = Number(item.marginAmount) || Math.round(totalMarginAmt * ratio);
        const itemTax = Math.round(itemMargin * 0.033);
        const itemSubtotal = Number(item.actualPayment) || (itemMargin - itemTax);
        
        // ê³µê¸‰ì‚¬ ê³„ì‚°
        const supplyPrice = Number(item.supplyPrice) || unitPrice;
        const supplyAmount = Math.round(supplyPrice * qty / 1.1);
        const vatAmount = Math.round(supplyAmount * 0.1);
        const itemSupplierTotal = supplyAmount + vatAmount;
        
        extTotalQty += qty;
        extTotalSales += itemSales;
        extTotalMargin += itemMargin;
        extTotalTax += itemTax;
        if (idx === 0) {
          extTotalPayment += totalActualPayment;
          supTotalSupply += supplierTotalSupply;
          supTotalVat += supplierTotalVat;
          supTotalAmount += supplierTotalAmount;
        }
        
        sheet2Data.push([
          idx === 0 ? (s.sellerName || '-') : '',
          idx === 0 ? (s.brandName || '-') : '',
          idx === 0 ? (s.dealPeriod || '-') : '',
          item.productName || '-',
          unitPrice,
          qty,
          itemSales,
          itemMargin,
          itemTax,
          itemSubtotal,
          idx === 0 ? totalActualPayment : '',
          supplyAmount,
          vatAmount,
          itemSupplierTotal,
          idx === 0 ? supplierTotalAmount : '',
          idx === 0 ? (s.settlementDate || '-') : ''
        ]);
      });
    }
  });
  
  sheet2Data.push(['í•©ê³„', '', '', '', '', extTotalQty, extTotalSales, extTotalMargin, extTotalTax, '', extTotalPayment, supTotalSupply, supTotalVat, supTotalAmount, supTotalAmount, '']);
  
  const ws2 = XLSX.utils.aoa_to_sheet(sheet2Data);
  ws2['!cols'] = [{wch:18},{wch:12},{wch:22},{wch:28},{wch:10},{wch:6},{wch:12},{wch:10},{wch:8},{wch:10},{wch:12},{wch:10},{wch:10},{wch:10},{wch:12},{wch:12}];
  
  // ì…€ ë³‘í•© ì„¤ì • (â† ì…€ëŸ¬ ì •ì‚° â†’ ì™€ â† ê³µê¸‰ì‚¬ ì •ì‚° â†’ ë¶€ë¶„)
  ws2['!merges'] = [
    { s: { r: 2, c: 7 }, e: { r: 2, c: 10 } },   // H3:K3 (â† ì…€ëŸ¬ ì •ì‚° â†’)
    { s: { r: 2, c: 11 }, e: { r: 2, c: 14 } }   // L3:O3 (â† ê³µê¸‰ì‚¬ ì •ì‚° â†’)
  ];
  
  XLSX.utils.book_append_sheet(wb, ws2, '2.íƒ€ì‚¬ìƒí’ˆ-í†µí•©ì •ì‚°');
  
  // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
  XLSX.writeFile(wb, 'ëª¨ì—¬ë¼ë”œ_ì •ì‚°ì„œ_' + today + '.xlsx');
  showToast('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ê²½ì˜íŒ€ ì •ì‚°ì„œ HTML ë‹¤ìš´ë¡œë“œ
function downloadManagementReportHTML() {
  const content = document.getElementById('management-report-content');
  const today = new Date().toISOString().split('T')[0];
  
  const htmlContent = `
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì—¬ë¼ë”œ ì •ì‚°ì„œ - ${today}</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Malgun Gothic', sans-serif; 
      padding: 20px; 
      max-width: 1400px; 
      margin: 0 auto; 
      background: #f9fafb;
    }
    .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    th, td { padding: 6px 4px; border: 1px solid #e5e7eb; }
    @media print { 
      body { padding: 0; background: white; } 
      .container { box-shadow: none; }
      @page { size: A4 landscape; margin: 0.5cm; }
    }
  </style>
</head>
<body>
  <div class="container">
    ${content.innerHTML}
  </div>
</body>
</html>
  `;
  
  const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ëª¨ì—¬ë¼ë”œ_ì •ì‚°ì„œ_${today}.html`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('ì •ì‚°ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ========== ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œ ê´€ë ¨ í•¨ìˆ˜ ==========

// ì •ì‚°ì™„ë£Œ ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸° ìƒíƒœ
let completedSectionCollapsed = true;

function renderSalesReport() {
  const app = document.getElementById('app');
  
  // íƒ€ì‚¬ ìƒí’ˆ ì™„ë£Œ íŒë‹¨: ì…€ëŸ¬ì™„ë£Œ + ê³µê¸‰ì‚¬ì™„ë£Œ ë‘˜ ë‹¤ ì²´í¬ë˜ì–´ì•¼ ì™„ë£Œ
  const isExternalComplete = (seller) => {
    if (!seller.isSellerCompleted) return false;
    // ì—°ê²°ëœ ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸°
    const matchingSupplier = state.supplierSettlements.find(sup => 
      sup.sellerName === seller.sellerName && 
      sup.brandName === seller.brandName && 
      sup.dealPeriod === seller.dealPeriod
    );
    // ê³µê¸‰ì‚¬ ì •ì‚°ì´ ì—†ê±°ë‚˜ ì™„ë£Œ ì•ˆëìœ¼ë©´ ë¯¸ì™„ë£Œ
    return matchingSupplier?.isCompleted === true;
  };
  
  // ì •ì‚°ëŒ€ê¸° (ë¯¸ì™„ë£Œ)
  const sellerInhousePending = state.sellerSettlements.filter(s => s.productType === 'inhouse' && !s.isCompleted);
  const sellerExternalPending = state.sellerSettlements.filter(s => s.productType === 'external' && !isExternalComplete(s));
  const supplierPending = state.supplierSettlements.filter(s => !s.isCompleted);
  
  // ì •ì‚°ì™„ë£Œ
  const sellerInhouseCompleted = state.sellerSettlements.filter(s => s.productType === 'inhouse' && s.isCompleted);
  const sellerExternalCompleted = state.sellerSettlements.filter(s => s.productType === 'external' && isExternalComplete(s));
  const supplierCompleted = state.supplierSettlements.filter(s => s.isCompleted);
  
  // ì „ì²´ (ê¸°ì¡´ í˜¸í™˜)
  const sellerInhouse = state.sellerSettlements.filter(s => s.productType === 'inhouse');
  const sellerExternal = state.sellerSettlements.filter(s => s.productType === 'external');
  
  const inhouseTotals = sellerInhouse.reduce((acc, s) => {
    acc.salesAmount += Number(s.salesAmount) || 0;
    acc.marginAmount += Number(s.marginAmount) || 0;
    acc.eventCost += Number(s.eventCost) || 0;
    return acc;
  }, { salesAmount: 0, marginAmount: 0, eventCost: 0 });
  
  // íƒ€ì‚¬ ìƒí’ˆ - sellerSettlementsì—ì„œ ê³„ì‚°
  const externalSellerTotals = sellerExternal.reduce((acc, s) => {
    acc.salesAmount += Number(s.salesAmount) || 0;
    acc.supplyAmount += Number(s.supplyAmount) || 0;
    acc.marginAmount += Number(s.marginAmount) || 0;
    acc.eventCost += Number(s.eventCost) || 0;
    
    // ê³µê¸‰ì‚¬ ì •ì‚°ê¸ˆì•¡: sellerSettlementsì— ì €ì¥ëœ ê°’ ë˜ëŠ” ì—°ê²°ëœ supplierSettlementsì—ì„œ ì°¾ê¸°
    let supplierAmount = Number(s.supplierTotalAmount) || 0;
    if (supplierAmount === 0) {
      // ê¸°ì¡´ ë°©ì‹: supplierSettlementsì—ì„œ ë§¤ì¹­ë˜ëŠ” ë°ì´í„° ì°¾ê¸°
      const matchedSupplier = state.supplierSettlements.find(sup => 
        sup.sellerName === s.sellerName && 
        sup.brandName === s.brandName && 
        sup.dealPeriod === s.dealPeriod
      );
      if (matchedSupplier) {
        supplierAmount = Number(matchedSupplier.totalAmount) || 0;
      }
    }
    acc.supplierTotalAmount += supplierAmount;
    
    return acc;
  }, { salesAmount: 0, supplyAmount: 0, supplierTotalAmount: 0, marginAmount: 0, eventCost: 0 });
  
  // ì¶”ê°€: supplierSettlementsì—ë§Œ ìˆëŠ” ë°ì´í„°ë„ í•©ì‚° (sellerSettlementsì™€ ë§¤ì¹­ ì•ˆ ëœ ê²ƒ)
  const unmatchedSupplierTotal = state.supplierSettlements.reduce((sum, sup) => {
    const hasMatch = sellerExternal.some(s => 
      s.sellerName === sup.sellerName && 
      s.brandName === sup.brandName && 
      s.dealPeriod === sup.dealPeriod
    );
    if (!hasMatch) {
      return sum + (Number(sup.totalAmount) || 0);
    }
    return sum;
  }, 0);
  
  // ê³µê¸‰ì‚¬ ì •ì‚° ì´ì•¡
  const supplierTotals = {
    totalAmount: externalSellerTotals.supplierTotalAmount + unmatchedSupplierTotal,
    totalSupplyAmount: externalSellerTotals.supplyAmount,
    totalVatAmount: Math.round(externalSellerTotals.supplyAmount * 0.1)
  };
  
  // ì´ íŒë§¤ê¸ˆì•¡ (PGìˆ˜ìˆ˜ë£Œ ê³„ì‚° ê¸°ì¤€)
  const totalSalesAmount = inhouseTotals.salesAmount + externalSellerTotals.salesAmount;
  // PGìˆ˜ìˆ˜ë£Œ 4%
  const pgFee = Math.round(totalSalesAmount * 0.04);
  // ì´ë²¤íŠ¸ë¹„ìš© (ì…€ëŸ¬ë³„ í•©ê³„)
  const totalEventCost = inhouseTotals.eventCost + externalSellerTotals.eventCost;
  
  // ìì‚¬ ìƒí’ˆ ìˆœì´ìµ ê³„ì‚° (ë§¤ì¶œ - ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ - PGìˆ˜ìˆ˜ë£Œ - ì´ë²¤íŠ¸ë¹„ìš©)
  const inhousePgFee = Math.round(inhouseTotals.salesAmount * 0.04);
  const inhouseProfit = inhouseTotals.salesAmount - inhouseTotals.marginAmount - inhousePgFee - inhouseTotals.eventCost;
  
  // íƒ€ì‚¬ ìƒí’ˆ ìˆœì´ìµ ê³„ì‚° (íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ì‚¬ì •ì‚° - ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ - PGìˆ˜ìˆ˜ë£Œ - ì´ë²¤íŠ¸ë¹„ìš©)
  const externalPgFee = Math.round(externalSellerTotals.salesAmount * 0.04);
  const externalProfit = externalSellerTotals.salesAmount - supplierTotals.totalAmount - externalSellerTotals.marginAmount - externalPgFee - externalSellerTotals.eventCost;
  
  // íƒ€ì‚¬ ìƒí’ˆ ë§¤ì¶œê¸ˆì•¡ (ìˆœìˆ˜ìµ) = íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ì‚¬ì •ì‚°ê¸ˆì•¡
  const externalRevenueAmount = externalSellerTotals.salesAmount - supplierTotals.totalAmount;
  
  // ì´ í•©ê³„
  const totalRevenue = inhouseTotals.salesAmount + externalRevenueAmount;
  const totalSellerCost = inhouseTotals.marginAmount + externalSellerTotals.marginAmount;
  const totalSupplierCost = supplierTotals.totalAmount;
  const totalProfit = totalRevenue - totalSellerCost - pgFee - totalEventCost;
  
  // ===== ìƒˆ ëŒ€ì‹œë³´ë“œ ì§€í‘œ =====
  // ì´ ë¶€ê°€ë¹„ìš© (ì…€ëŸ¬ + ê³µê¸‰ì‚¬ + PG + ì´ë²¤íŠ¸)
  const totalCost = totalSellerCost + totalSupplierCost + pgFee + totalEventCost;
  
  // ì´ìµë¥  (%)
  const profitRate = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(1) : 0;
  
  // ì •ì‚°ëŒ€ê¸° ê¸ˆì•¡ (íƒ€ì‚¬ ìƒí’ˆì€ ê³µê¸‰ì‚¬ì •ì‚°ê¸ˆì•¡ë„ í¬í•¨)
  const pendingSellerAmount = [...sellerInhousePending, ...sellerExternalPending].reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
  const pendingSupplierAmount = sellerExternalPending.reduce((sum, s) => sum + (Number(s.supplierTotalAmount) || 0), 0);
  const pendingTotalAmount = pendingSellerAmount + pendingSupplierAmount;
  
  // ê³µêµ¬ ê±´ìˆ˜ (sellerSettlements ê¸°ì¤€)
  const totalDealCount = state.sellerSettlements.length;
  
  // í‰ê·  ê°ë‹¨ê°€ (ì´ íŒë§¤ê¸ˆì•¡ / ì´ ìˆ˜ëŸ‰)
  const totalQuantity = state.sellerSettlements.reduce((sum, s) => sum + (Number(s.totalQuantity) || 0), 0);
  const avgOrderValue = totalQuantity > 0 ? Math.round(totalSalesAmount / totalQuantity) : 0;
  
  // ì´ë²ˆë‹¬/ì§€ë‚œë‹¬ ê³„ì‚°
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
  const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;
  
  const getMonthFromSettlement = (s) => {
    if (!s.settlementDate) return null;
    const d = new Date(s.settlementDate);
    return { month: d.getMonth(), year: d.getFullYear() };
  };
  
  const thisMonthRevenue = state.sellerSettlements.filter(s => {
    const md = getMonthFromSettlement(s);
    return md && md.month === thisMonth && md.year === thisYear;
  }).reduce((sum, s) => {
    if (s.productType === 'inhouse') return sum + (Number(s.salesAmount) || 0);
    return sum + (Number(s.revenueAmount) || 0);
  }, 0);
  
  const lastMonthRevenue = state.sellerSettlements.filter(s => {
    const md = getMonthFromSettlement(s);
    return md && md.month === lastMonth && md.year === lastMonthYear;
  }).reduce((sum, s) => {
    if (s.productType === 'inhouse') return sum + (Number(s.salesAmount) || 0);
    return sum + (Number(s.revenueAmount) || 0);
  }, 0);
  
  const monthGrowth = lastMonthRevenue > 0 ? (((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100).toFixed(1) : (thisMonthRevenue > 0 ? 100 : 0);
  
  // ì •ì‚°ëŒ€ê¸° ê±´ìˆ˜ (supplierPendingì€ sellerExternalPendingê³¼ ì¤‘ë³µë˜ë¯€ë¡œ ì œì™¸)
  const pendingCount = sellerInhousePending.length + sellerExternalPending.length;
  const completedCount = sellerInhouseCompleted.length + sellerExternalCompleted.length;

  // í˜„ì¬ ë‚ ì§œ
  const today = new Date();
  const todayStr = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;

  app.innerHTML = `
    <div style="text-align: center; padding: 40px 20px 24px; background: var(--white); border-bottom: 1px solid var(--gray-200); margin: -24px -24px 24px;">
      <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin: 0 0 8px; display: flex; align-items: center; justify-content: center; gap: 12px;">
        <span style="font-size: 32px;">ğŸ“Š</span> ì •ì‚° ë‚´ì—­ì„œ
      </h1>
      <p style="color: var(--gray-500); font-size: 14px; margin: 0 0 20px;">${todayStr}</p>
      <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
        <button class="btn" style="background: #fef3c7; color: #92400e; border: 2px solid #f59e0b; font-weight: 700; padding: 10px 24px;" onclick="scrollToSection('pending-section')">
          â³ ì •ì‚°ëŒ€ê¸° ${pendingCount}ê±´
        </button>
        <button class="btn btn-primary" onclick="openUnifiedSettlementModal()">â• ì •ì‚° ì¶”ê°€</button>
      </div>
    </div>
    
    <!-- ===== ë©”ì¸ ì§€í‘œ (4ê°œ) ===== -->
    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
      <div class="stat-card">
        <div class="stat-label">ì´ íŒë§¤ê¸ˆì•¡</div>
        <div class="stat-value" style="font-size: 24px;">${totalSalesAmount.toLocaleString()}ì›</div>
        <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ì‹¤ì œ ê±°ë˜ì•¡</div>
      </div>
      <div class="stat-card highlight" style="position: relative;">
        <div class="stat-label" style="display: flex; align-items: center; gap: 6px;">
          ì´ ë§¤ì¶œê¸ˆì•¡
          <div class="help-tooltip-wrapper" style="position: relative; display: inline-block;">
            <span style="width: 16px; height: 16px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.2); color: #fff; font-size: 10px; font-weight: 600; cursor: help; display: inline-flex; align-items: center; justify-content: center;">?</span>
            <div class="help-tooltip-content" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; width: 220px; background: var(--gray-900); border-radius: 8px; padding: 12px; z-index: 100; font-size: 12px; color: #fff; line-height: 1.5;">
              <strong>íƒ€ì‚¬ ìƒí’ˆì˜ ê³µê¸‰ê°€ì•¡ì´ ì œì™¸</strong>ëœ ê¸ˆì•¡ì…ë‹ˆë‹¤.<br><br>
              ìì‚¬: íŒë§¤ê¸ˆì•¡ ê·¸ëŒ€ë¡œ<br>
              íƒ€ì‚¬: íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ê°€ì•¡
            </div>
          </div>
        </div>
        <div class="stat-value" style="font-size: 24px;">${totalRevenue.toLocaleString()}ì›</div>
        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">íšŒê³„ìƒ ë§¤ì¶œ</div>
      </div>
      <div class="stat-card" style="background: #fff8f0; position: relative;">
        <div class="stat-label" style="color: var(--gray-700); display: flex; align-items: center; gap: 6px;">
          ì´ ë¶€ê°€ë¹„ìš©
          <div class="help-tooltip-wrapper" style="position: relative; display: inline-block;">
            <span style="width: 16px; height: 16px; border-radius: 50%; border: 1px solid var(--gray-400); background: transparent; color: var(--gray-500); font-size: 10px; font-weight: 600; cursor: help; display: inline-flex; align-items: center; justify-content: center;">?</span>
            <div class="help-tooltip-content" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; width: 260px; background: var(--gray-900); border-radius: 8px; padding: 12px; z-index: 100; font-size: 12px; color: #fff; line-height: 1.8;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>ğŸ‘¤ ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ</span><span>${totalSellerCost.toLocaleString()}ì›</span></div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>ğŸ­ ê³µê¸‰ì‚¬ ì§€ê¸‰</span><span>${totalSupplierCost.toLocaleString()}ì›</span></div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>ğŸ’³ PGìˆ˜ìˆ˜ë£Œ(4%)</span><span>${pgFee.toLocaleString()}ì›</span></div>
              <div style="display: flex; justify-content: space-between;"><span>ğŸ ì´ë²¤íŠ¸ë¹„ìš©</span><span>${totalEventCost.toLocaleString()}ì›</span></div>
              <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 8px; padding-top: 8px; font-weight: 600; display: flex; justify-content: space-between;"><span>í•©ê³„</span><span>${totalCost.toLocaleString()}ì›</span></div>
            </div>
          </div>
        </div>
        <div class="stat-value" style="font-size: 24px; color: var(--gray-900);">${totalCost.toLocaleString()}ì›</div>
        <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬+ê³µê¸‰ì‚¬+PG+ì´ë²¤íŠ¸</div>
      </div>
      <div class="stat-card" style="background: #fff8f0;">
        <div class="stat-label" style="color: var(--gray-700);">ìˆœì´ìµ</div>
        <div class="stat-value" style="font-size: 24px; color: var(--gray-900);">${totalProfit.toLocaleString()}ì›</div>
        <div style="font-size: 13px; color: var(--primary); margin-top: 4px; font-weight: 700;">ì´ìµë¥  ${profitRate}%</div>
      </div>
    </div>
    
    <!-- ===== ì„œë¸Œ ì§€í‘œ (5ê°œ) - ê¹”ë”í•œ í°ìƒ‰ ===== -->
    <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
        <div style="text-align: center; padding: 12px 8px; border-right: 1px solid var(--gray-200);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">â³ ì •ì‚°ëŒ€ê¸° ê¸ˆì•¡</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${pendingTotalAmount.toLocaleString()}ì›</div>
          <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">${pendingCount}ê±´ ëŒ€ê¸°ì¤‘</div>
        </div>
        <div style="text-align: center; padding: 12px 8px; border-right: 1px solid var(--gray-200);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ğŸ“… ì´ë²ˆë‹¬ ë§¤ì¶œ</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${thisMonthRevenue.toLocaleString()}ì›</div>
          <div style="font-size: 11px; color: ${Number(monthGrowth) >= 0 ? 'var(--success)' : 'var(--danger)'}; margin-top: 4px; font-weight: 600;">
            ${Number(monthGrowth) >= 0 ? 'â–²' : 'â–¼'} ì „ì›”ëŒ€ë¹„ ${Math.abs(monthGrowth)}%
          </div>
        </div>
        <div style="text-align: center; padding: 12px 8px; border-right: 1px solid var(--gray-200);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ğŸ“… ì§€ë‚œë‹¬ ë§¤ì¶œ</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${lastMonthRevenue.toLocaleString()}ì›</div>
          <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">${lastMonth + 1}ì›” ì‹¤ì </div>
        </div>
        <div style="text-align: center; padding: 12px 8px; border-right: 1px solid var(--gray-200);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ğŸ“¦ ê³µêµ¬ ê±´ìˆ˜</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${totalDealCount}ê±´</div>
          <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬+ê³µê¸‰ì‚¬ ì •ì‚°</div>
        </div>
        <div style="text-align: center; padding: 12px 8px;">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ğŸ’° í‰ê·  ê°ë‹¨ê°€</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${avgOrderValue.toLocaleString()}ì›</div>
          <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ì´ ${totalQuantity}ê°œ íŒë§¤</div>
        </div>
      </div>
    </div>
    
    <!-- ========== ì •ì‚°ëŒ€ê¸° ì„¹ì…˜ ========== -->
    <div id="pending-section" style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px;">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 24px;">â³</span>
          <div>
            <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--gray-600);">ì •ì‚°ëŒ€ê¸°</h2>
            <p style="margin: 4px 0 0; font-size: 13px; color: #b45309;">ì„ íƒí•œ í•­ëª©ì„ ì •ì‚°ì„œ ë³´ê¸° ë˜ëŠ” ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
          </div>
          <span style="background: #dc2626; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 14px;">${pendingCount}ê±´</span>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
          <button class="btn btn-sm" style="background: #f3f4f6; color: #374151;" onclick="toggleAllSettlements(true)">â˜‘ï¸ ì „ì²´ì„ íƒ</button>
          <button class="btn btn-sm" style="background: #f3f4f6; color: #6b7280;" onclick="toggleAllSettlements(false)">â˜ ì „ì²´í•´ì œ</button>
          <span style="color: #d1d5db;">|</span>
          <button class="btn btn-secondary btn-sm" onclick="viewSelectedSellerStatements()">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚°ì„œ</button>
          <button class="btn btn-secondary btn-sm" onclick="viewSelectedSupplierStatements()">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ</button>
          <button class="btn btn-sm" style="background: #dc2626; color: white;" onclick="deleteSelectedSettlements()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
        </div>
      </div>
    </div>

    <!-- 1 ìì‚¬ ìƒí’ˆ ì…€ëŸ¬ ì •ì‚° (ëŒ€ê¸°) -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
        <h2 class="card-title" style="color: var(--info); margin: 0; display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--info); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">1</span>
          ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚°
          <span style="background: var(--gray-100); color: var(--gray-600); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${sellerInhousePending.length}ê±´</span>
        </h2>
      </div>
      ${sellerInhousePending.length === 0 ? '<div style="text-align: center; padding: 20px; color: var(--gray-500);">âœ… ì •ì‚°ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>' : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th style="width:40px;"><input type="checkbox" onchange="toggleAllInhouseCheck(this.checked)" style="width:18px;height:18px;cursor:pointer;"></th>
                <th>ì…€ëŸ¬ëª…</th>
                <th>ë¸Œëœë“œ</th>
                <th>ê³µêµ¬ê¸°ê°„</th>
                <th>íŒë§¤ìƒí’ˆ</th>
                <th style="text-align:right;">ë‹¨ê°€</th>
                <th style="text-align:center;">ìˆ˜ëŸ‰</th>
                <th style="text-align:right;">íŒë§¤ê¸ˆì•¡</th>
                <th style="text-align:right;">ë§ˆì§„ê¸ˆì•¡</th>
                <th style="text-align:right;">ì›ì²œì„¸</th>
                <th style="text-align:right;">ì†Œê³„</th>
                <th style="text-align:right;background:#dcfce7;color:#166534;">ì´ì‹¤ì§€ê¸‰ì•¡</th>
                <th>ì •ì‚°ì¼</th>
                <th style="text-align:center;">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${sellerInhousePending.map(s => {
                const items = s.salesItems || [{productName: s.productName || '-', quantity: s.totalQuantity || 1, unitPrice: s.salePrice || 0, amount: s.salesAmount || 0}];
                const rowspan = items.length;
                return items.map((item, idx) => `<tr>
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:center;"><input type="checkbox" class="inhouse-check" data-id="${s.id}" style="width:18px;height:18px;cursor:pointer;"></td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}"><strong>${s.sellerName||'-'}</strong></td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}"><span class="status-badge status-confirmed">${s.brandName||'-'}</span></td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="font-size:12px;">${s.dealPeriod||'-'}</td>` : ''}
                  <td style="font-size:12px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${item.productName||'-'}">${item.productName||'-'}</td>
                  <td style="text-align:right;font-size:12px;">${Number(item.unitPrice||0).toLocaleString()}ì›</td>
                  <td style="text-align:center;">${item.quantity||1}</td>
                  <td style="text-align:right;">${Number(item.amount||0).toLocaleString()}ì›</td>
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;">${Number(s.marginAmount||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;font-size:12px;">${Number(s.withholdingTax||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;">${Number((s.marginAmount||0)-(s.withholdingTax||0)).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#dcfce7;font-weight:700;color:#166534;">${Number(s.actualPayment||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}">${s.settlementDate||'-'}</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" class="actions" style="white-space:nowrap;">
                    <div style="display:flex;flex-direction:column;gap:4px;align-items:center;">
                      <div style="display:flex;gap:4px;">
                        <button class="btn btn-secondary btn-sm" onclick="openUnifiedSettlementModal(state.sellerSettlements.find(x=>x.id==='${s.id}'))" title="ìˆ˜ì •">âœï¸</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateSellerStatement('${s.id}')" title="ì…€ëŸ¬ ì •ì‚°ì„œ">ğŸ“„</button>
                        <button class="btn btn-sm" style="background:#fee2e2;color:#dc2626;" onclick="confirmDeleteSettlement('seller','${s.id}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                      </div>
                      <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--gray-600);cursor:pointer;">
                        <input type="checkbox" onchange="toggleSettlementComplete('seller','${s.id}',true)" style="width:14px;height:14px;cursor:pointer;">
                        <span>ì™„ë£Œì²˜ë¦¬</span>
                      </label>
                    </div>
                  </td>` : ''}
                </tr>`).join('');
              }).join('')}
            </tbody>
            <tfoot>
              <tr style="background:#f3f4f6;font-weight:600;">
                <td colspan="7" style="text-align:center;">í•©ê³„</td>
                <td style="text-align:right;">${sellerInhousePending.reduce((sum,s) => sum + Number(s.salesAmount||0), 0).toLocaleString()}ì›</td>
                <td style="text-align:right;">${sellerInhousePending.reduce((sum,s) => sum + Number(s.marginAmount||0), 0).toLocaleString()}ì›</td>
                <td style="text-align:right;">${sellerInhousePending.reduce((sum,s) => sum + Number(s.withholdingTax||0), 0).toLocaleString()}ì›</td>
                <td></td>
                <td style="text-align:right;background:#dcfce7;font-weight:700;color:#166534;">${sellerInhousePending.reduce((sum,s) => sum + Number(s.actualPayment||0), 0).toLocaleString()}ì›</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      `}
    </div>
    
    <!-- 2 íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (ëŒ€ê¸°) - í†µí•© -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
        <h2 class="card-title" style="color: var(--success); margin: 0; display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--success); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">2</span>
          íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚°
          <span style="background: var(--gray-100); color: var(--gray-600); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${sellerExternalPending.length}ê±´</span>
        </h2>
        <button class="btn btn-secondary btn-sm" onclick="openSupplierProductModal()">ğŸ“¦ ìƒí’ˆê´€ë¦¬</button>
      </div>
      ${sellerExternalPending.length === 0 ? '<div style="text-align: center; padding: 20px; color: var(--gray-500);">âœ… ì •ì‚°ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>' : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th rowspan="2" style="width:40px;vertical-align:middle;"><input type="checkbox" onchange="toggleAllExternalCheck(this.checked)" style="width:18px;height:18px;cursor:pointer;"></th>
                <th rowspan="2" style="vertical-align:middle;">ì…€ëŸ¬ëª…</th>
                <th rowspan="2" style="vertical-align:middle;">ë¸Œëœë“œ(ê³µê¸‰ì‚¬)</th>
                <th rowspan="2" style="vertical-align:middle;">ê³µêµ¬ê¸°ê°„</th>
                <th rowspan="2" style="vertical-align:middle;">íŒë§¤ìƒí’ˆ</th>
                <th rowspan="2" style="text-align:right;vertical-align:middle;">ë‹¨ê°€</th>
                <th rowspan="2" style="text-align:center;vertical-align:middle;">ìˆ˜ëŸ‰</th>
                <th rowspan="2" style="text-align:right;vertical-align:middle;">íŒë§¤ê¸ˆì•¡</th>
                <th colspan="4" style="text-align:center;background:#dcfce7;border-bottom:1px solid var(--gray-300);">- ì…€ëŸ¬ ì •ì‚° -</th>
                <th colspan="4" style="text-align:center;background:#fef9c3;border-bottom:1px solid var(--gray-300);">- ê³µê¸‰ì‚¬ ì •ì‚° -</th>
                <th rowspan="2" style="vertical-align:middle;">ì •ì‚°ì¼</th>
                <th rowspan="2" style="text-align:center;vertical-align:middle;">ê´€ë¦¬</th>
              </tr>
              <tr>
                <th style="text-align:right;background:#dcfce7;font-size:11px;">ë§ˆì§„ê¸ˆì•¡</th>
                <th style="text-align:right;background:#dcfce7;font-size:11px;">ì›ì²œì„¸</th>
                <th style="text-align:right;background:#dcfce7;font-size:11px;">ì†Œê³„</th>
                <th style="text-align:right;background:#dcfce7;font-size:11px;">ì´ì‹¤ì§€ê¸‰ì•¡</th>
                <th style="text-align:right;background:#fef9c3;font-size:11px;">ê³µê¸‰ê°€ì•¡</th>
                <th style="text-align:right;background:#fef9c3;font-size:11px;">ë¶€ê°€ì„¸(10%)</th>
                <th style="text-align:right;background:#fef9c3;font-size:11px;">ì´í•©ê³„</th>
                <th style="text-align:right;background:#fef9c3;font-size:11px;">ì •ì‚°ê¸ˆì•¡(V+)</th>
              </tr>
            </thead>
            <tbody>
              ${sellerExternalPending.map(s => {
                // ì—°ê²°ëœ ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸°
                const supplierData = state.supplierSettlements.find(sup =>
                  sup.sellerName === s.sellerName &&
                  sup.brandName === s.brandName &&
                  sup.dealPeriod === s.dealPeriod
                ) || {};
                const supplierId = supplierData.id || '';
                // ìƒí’ˆ ì •ë³´
                const items = s.salesItems || [{productName: s.productName || '-', quantity: s.totalQuantity || 1, unitPrice: s.salePrice || 0, amount: s.salesAmount || 0}];
                const rowspan = items.length;
                // ì†Œê³„ ê³„ì‚°
                const sellerSubtotal = Number(s.marginAmount||0) - Number(s.withholdingTax||0);
                const supplierSubtotal = Number(supplierData.totalSupplyAmount||s.supplyAmount||0) + Number(supplierData.totalVatAmount||s.vatAmount||0);
                return items.map((item, idx) => `<tr>
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:center;"><input type="checkbox" class="external-check" data-id="${s.id}" data-supplier-id="${supplierId}" style="width:18px;height:18px;cursor:pointer;"></td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}"><strong>${s.sellerName||'-'}</strong></td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}"><span class="status-badge status-negotiating">${s.brandName||'-'}</span></td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="font-size:12px;">${s.dealPeriod||'-'}</td>` : ''}
                  <td style="font-size:12px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${item.productName||'-'}">${item.productName||'-'}</td>
                  <td style="text-align:right;font-size:12px;">${Number(item.unitPrice||0).toLocaleString()}ì›</td>
                  <td style="text-align:center;">${item.quantity||1}</td>
                  <td style="text-align:right;">${Number(item.amount||0).toLocaleString()}ì›</td>
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#f0fdf4;">${Number(s.marginAmount||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#f0fdf4;font-size:12px;">${Number(s.withholdingTax||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#f0fdf4;">${sellerSubtotal.toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#dcfce7;font-weight:700;color:#166534;">${Number(s.actualPayment||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#fefce8;">${Number(supplierData.totalSupplyAmount||s.supplyAmount||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#fefce8;font-size:12px;">${Number(supplierData.totalVatAmount||s.vatAmount||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#fefce8;">${supplierSubtotal.toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" style="text-align:right;background:#fde68a;font-weight:700;color:#92400e;">${Number(supplierData.totalAmount||s.supplierTotalAmount||0).toLocaleString()}ì›</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}">${s.settlementDate||'-'}</td>` : ''}
                  ${idx === 0 ? `<td rowspan="${rowspan}" class="actions" style="white-space:nowrap;">
                    <div style="display:flex;flex-direction:column;gap:4px;align-items:center;">
                      <div style="display:flex;gap:3px;">
                        <button class="btn btn-secondary btn-sm" onclick="openUnifiedSettlementModal(state.sellerSettlements.find(x=>x.id==='${s.id}'))" title="ìˆ˜ì •">âœï¸</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateSellerStatement('${s.id}')" title="ì…€ëŸ¬ ì •ì‚°ì„œ">ğŸ‘¤</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateSupplierStatement('${s.id}')" title="ê³µê¸‰ì‚¬ ì •ì‚°ì„œ">ğŸ­</button>
                        <button class="btn btn-sm" style="background:#fee2e2;color:#dc2626;" onclick="confirmDeleteSettlement('seller','${s.id}','${supplierId}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                      </div>
                      <div style="display:flex;gap:6px;font-size:10px;">
                        <label style="display:flex;align-items:center;gap:2px;color:#16a34a;cursor:pointer;">
                          <input type="checkbox" ${s.isSellerCompleted ? 'checked' : ''} onchange="toggleExternalSettlement('seller','${s.id}',this.checked)" style="width:12px;height:12px;cursor:pointer;accent-color:#16a34a;">
                          <span>ì…€ëŸ¬</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:2px;color:#ca8a04;cursor:pointer;">
                          <input type="checkbox" ${supplierData.isCompleted ? 'checked' : ''} onchange="toggleExternalSettlement('supplier','${supplierId}',this.checked)" style="width:12px;height:12px;cursor:pointer;accent-color:#ca8a04;" ${!supplierId ? 'disabled' : ''}>
                          <span>ê³µê¸‰ì‚¬</span>
                        </label>
                      </div>
                    </div>
                  </td>` : ''}
                </tr>`).join('');
              }).join('')}
            </tbody>
            <tfoot>
              <tr style="background:#f3f4f6;font-weight:600;">
                <td colspan="7" style="text-align:center;">í•©ê³„</td>
                <td style="text-align:right;">${sellerExternalPending.reduce((sum,s) => sum + Number(s.salesAmount||0), 0).toLocaleString()}ì›</td>
                <td style="text-align:right;background:#f0fdf4;">${sellerExternalPending.reduce((sum,s) => sum + Number(s.marginAmount||0), 0).toLocaleString()}ì›</td>
                <td style="text-align:right;background:#f0fdf4;">${sellerExternalPending.reduce((sum,s) => sum + Number(s.withholdingTax||0), 0).toLocaleString()}ì›</td>
                <td style="background:#f0fdf4;"></td>
                <td style="text-align:right;background:#dcfce7;font-weight:700;color:#166534;">${sellerExternalPending.reduce((sum,s) => sum + Number(s.actualPayment||0), 0).toLocaleString()}ì›</td>
                <td style="text-align:right;background:#fefce8;">${sellerExternalPending.reduce((sum,s) => {
                  const supplierData = state.supplierSettlements.find(sup => sup.sellerName === s.sellerName && sup.brandName === s.brandName && sup.dealPeriod === s.dealPeriod) || {};
                  return sum + Number(supplierData.totalSupplyAmount||s.supplyAmount||0);
                }, 0).toLocaleString()}ì›</td>
                <td style="text-align:right;background:#fefce8;">${sellerExternalPending.reduce((sum,s) => {
                  const supplierData = state.supplierSettlements.find(sup => sup.sellerName === s.sellerName && sup.brandName === s.brandName && sup.dealPeriod === s.dealPeriod) || {};
                  return sum + Number(supplierData.totalVatAmount||s.vatAmount||0);
                }, 0).toLocaleString()}ì›</td>
                <td style="background:#fefce8;"></td>
                <td style="text-align:right;background:#fde68a;font-weight:700;color:#92400e;">${sellerExternalPending.reduce((sum,s) => {
                  const supplierData = state.supplierSettlements.find(sup => sup.sellerName === s.sellerName && sup.brandName === s.brandName && sup.dealPeriod === s.dealPeriod) || {};
                  return sum + Number(supplierData.totalAmount||s.supplierTotalAmount||0);
                }, 0).toLocaleString()}ì›</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
          ğŸ’¡ <span style="color: #16a34a;">ë…¹ìƒ‰ ì˜ì—­</span>: ì…€ëŸ¬ ì •ì‚° í•­ëª© | <span style="color: #ca8a04;">ë…¸ë€ìƒ‰ ì˜ì—­</span>: ê³µê¸‰ì‚¬ ì •ì‚° í•­ëª©
        </div>
      `}
    </div>
    
    <!-- ========== ì •ì‚°ì™„ë£Œ ì„¹ì…˜ (ì ‘ê¸°/í¼ì¹˜ê¸°) ========== -->
    ${completedCount > 0 ? `
    <div style="margin-top: 32px;">
      <div onclick="toggleCompletedSection()" style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px 20px; margin-bottom: ${completedSectionCollapsed ? '0' : '24px'}; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s;">
        <span style="font-size: 24px;">âœ…</span>
        <div>
          <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: #065f46;">ì •ì‚°ì™„ë£Œ</h2>
          <p style="margin: 4px 0 0; font-size: 13px; color: #047857;">í´ë¦­í•˜ì—¬ ${completedSectionCollapsed ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}</p>
        </div>
        <span style="margin-left: auto; background: #059669; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 14px;">${completedCount}ê±´</span>
        <span style="font-size: 20px; color: #065f46;">${completedSectionCollapsed ? 'â–¼' : 'â–²'}</span>
      </div>
      
      <div id="completed-section" style="display: ${completedSectionCollapsed ? 'none' : 'block'};">
        <!-- 1 ìì‚¬ ìƒí’ˆ ì…€ëŸ¬ ì •ì‚° (ì™„ë£Œ) -->
        ${sellerInhouseCompleted.length > 0 ? `
        <div class="card" style="border-left: 4px solid #059669;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="card-title" style="color: var(--info); margin: 0; display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--info); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">1</span>
              ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚°
            </h2>
            <span class="status-badge" style="background: #d1fae5; color: #065f46;">${sellerInhouseCompleted.length}ê±´ ì™„ë£Œ</span>
          </div>
          <div style="overflow-x: auto;">
            <table class="data-table">
              <thead><tr><th>ì…€ëŸ¬ëª…</th><th>ë¸Œëœë“œ</th><th>ê³µêµ¬ê¸°ê°„</th><th style="text-align:center;">ìˆ˜ëŸ‰</th><th style="text-align:right;">íŒë§¤ê¸ˆì•¡</th><th style="text-align:right;">ë§ˆì§„ê¸ˆì•¡</th><th style="text-align:right;">ì›ì²œì„¸</th><th style="text-align:right;">ì‹¤ì§€ê¸‰ì•¡</th><th>ì •ì‚°ì¼</th><th style="text-align:center;">ê´€ë¦¬</th></tr></thead>
              <tbody>
                ${sellerInhouseCompleted.map(s => `<tr style="opacity:0.7;"><td><strong>${s.sellerName||'-'}</strong></td><td><span class="status-badge status-confirmed">${s.brandName||'-'}</span></td><td style="font-size:13px;">${s.dealPeriod||'-'}</td><td style="text-align:center;">${s.totalQuantity||'-'}</td><td style="text-align:right;">${Number(s.salesAmount||0).toLocaleString()}ì›</td><td style="text-align:right;">${Number(s.marginAmount||0).toLocaleString()}ì›</td><td style="text-align:right;">${Number(s.withholdingTax||0).toLocaleString()}ì›</td><td style="text-align:right;">${Number(s.actualPayment||0).toLocaleString()}ì›</td><td>${s.settlementDate||'-'}</td><td class="actions" style="white-space:nowrap;"><div style="display:flex;flex-direction:column;gap:6px;align-items:center;"><div style="display:flex;gap:4px;"><button class="btn btn-secondary btn-sm" onclick="openUnifiedSettlementModal(state.sellerSettlements.find(x=>x.id==='${s.id}'))">ìˆ˜ì •</button><button class="btn btn-secondary btn-sm" onclick="generateSellerStatement('${s.id}')">ğŸ“„</button></div><label style="display:flex;align-items:center;gap:4px;font-size:11px;color:#065f46;cursor:pointer;"><input type="checkbox" checked onchange="toggleSettlementComplete('seller','${s.id}',false)" style="width:16px;height:16px;cursor:pointer;"><span>ì™„ë£Œ</span></label></div></td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>
        ` : ''}
        
        <!-- 2 íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (ì™„ë£Œ) - í†µí•© -->
        ${sellerExternalCompleted.length > 0 ? `
        <div class="card" style="border-left: 4px solid #059669;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="card-title" style="color: var(--success); margin: 0; display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--success); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">2</span>
              íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚°
            </h2>
            <span class="status-badge" style="background: #d1fae5; color: #065f46;">${sellerExternalCompleted.length}ê±´ ì™„ë£Œ</span>
          </div>
          <div style="overflow-x: auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th rowspan="2" style="vertical-align:middle;">ì…€ëŸ¬ëª…</th>
                  <th rowspan="2" style="vertical-align:middle;">ë¸Œëœë“œ(ê³µê¸‰ì‚¬)</th>
                  <th rowspan="2" style="vertical-align:middle;">ê³µêµ¬ê¸°ê°„</th>
                  <th rowspan="2" style="text-align:center;vertical-align:middle;">ìˆ˜ëŸ‰</th>
                  <th rowspan="2" style="text-align:right;vertical-align:middle;">íŒë§¤ê¸ˆì•¡</th>
                  <th colspan="3" style="text-align:center;background:#dcfce7;border-bottom:1px solid var(--gray-300);">ì…€ëŸ¬ ì •ì‚°</th>
                  <th colspan="3" style="text-align:center;background:#fef9c3;border-bottom:1px solid var(--gray-300);">ê³µê¸‰ì‚¬ ì •ì‚°</th>
                  <th rowspan="2" style="vertical-align:middle;">ì •ì‚°ì¼</th>
                  <th rowspan="2" style="text-align:center;vertical-align:middle;">ê´€ë¦¬</th>
                </tr>
                <tr>
                  <th style="text-align:right;background:#dcfce7;font-size:11px;">ë§ˆì§„ê¸ˆì•¡</th>
                  <th style="text-align:right;background:#dcfce7;font-size:11px;">ì›ì²œì„¸</th>
                  <th style="text-align:right;background:#dcfce7;font-size:11px;">ì‹¤ì§€ê¸‰ì•¡</th>
                  <th style="text-align:right;background:#fef9c3;font-size:11px;">ê³µê¸‰ê°€ì•¡</th>
                  <th style="text-align:right;background:#fef9c3;font-size:11px;">ë¶€ê°€ì„¸</th>
                  <th style="text-align:right;background:#fef9c3;font-size:11px;">ì •ì‚°ê¸ˆì•¡(V+)</th>
                </tr>
              </thead>
              <tbody>
                ${sellerExternalCompleted.map(s => {
                  const supplierData = state.supplierSettlements.find(sup => 
                    sup.sellerName === s.sellerName && 
                    sup.brandName === s.brandName && 
                    sup.dealPeriod === s.dealPeriod
                  ) || {};
                  return `<tr style="opacity:0.7;">
                    <td><strong>${s.sellerName||'-'}</strong></td>
                    <td><span class="status-badge status-negotiating">${s.brandName||'-'}</span></td>
                    <td style="font-size:13px;">${s.dealPeriod||'-'}</td>
                    <td style="text-align:center;">${s.totalQuantity||'-'}</td>
                    <td style="text-align:right;">${Number(s.salesAmount||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#f0fdf4;">${Number(s.marginAmount||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#f0fdf4;font-size:12px;">${Number(s.withholdingTax||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#f0fdf4;">${Number(s.actualPayment||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#fefce8;">${Number(supplierData.totalSupplyAmount||s.supplyAmount||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#fefce8;font-size:12px;">${Number(supplierData.totalVatAmount||s.vatAmount||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#fefce8;">${Number(supplierData.totalAmount||s.supplierTotalAmount||0).toLocaleString()}ì›</td>
                    <td>${s.settlementDate||'-'}</td>
                    <td class="actions" style="white-space:nowrap;">
                      <div style="display:flex;flex-direction:column;gap:6px;align-items:center;">
                        <div style="display:flex;gap:4px;">
                          <button class="btn btn-secondary btn-sm" onclick="openUnifiedSettlementModal(state.sellerSettlements.find(x=>x.id==='${s.id}'))">ìˆ˜ì •</button>
                          <button class="btn btn-secondary btn-sm" onclick="generateSellerStatement('${s.id}')" title="ì…€ëŸ¬ ì •ì‚°ì„œ">ğŸ‘¤</button>
                          <button class="btn btn-secondary btn-sm" onclick="generateSupplierStatement('${s.id}')" title="ê³µê¸‰ì‚¬ ì •ì‚°ì„œ">ğŸ­</button>
                        </div>
                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--gray-600);cursor:pointer;">
                          <input type="checkbox" checked onchange="toggleSettlementComplete('seller','${s.id}',false)" style="width:16px;height:16px;cursor:pointer;">
                          <span>ì™„ë£Œ</span>
                        </label>
                      </div>
                    </td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
        ` : ''}
      </div>
    </div>
    ` : ''}
    
    <!-- ì „ì²´ í•©ê³„ -->
    <div class="card" style="background: linear-gradient(135deg, var(--gray-900) 0%, #374151 100%); color: #fff;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="card-title" style="color: #fff; margin: 0;">ğŸ“ˆ ì „ì²´ ë§¤ì¶œ ìš”ì•½</h2>
        <span style="font-size: 12px; opacity: 0.7;">ì´ë²¤íŠ¸ë¹„ìš©ì€ ê° ì…€ëŸ¬ ì •ì‚°ì—ì„œ ì…ë ¥</span>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        <!-- ìì‚¬ ìƒí’ˆ -->
        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;">
          <div style="font-size: 13px; opacity: 0.8; margin-bottom: 12px;"><span style="background: var(--info); padding: 2px 8px; border-radius: 4px; font-size: 11px;">1</span> ìì‚¬ ìƒí’ˆ</div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ë§¤ì¶œ(=íŒë§¤ê¸ˆì•¡)</span><span style="font-weight: 600;">${inhouseTotals.salesAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ</span><span style="color: #fca5a5;">-${inhouseTotals.marginAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">PGìˆ˜ìˆ˜ë£Œ(4%)</span><span style="color: #fca5a5;">-${inhousePgFee.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ì´ë²¤íŠ¸ë¹„ìš©</span><span style="color: #fca5a5;">-${inhouseTotals.eventCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);"><span>ìˆœì´ìµ</span><span style="font-weight: 700; color: ${inhouseProfit >= 0 ? '#86efac' : '#fca5a5'};">${inhouseProfit.toLocaleString()}ì›</span></div>
        </div>
        <!-- íƒ€ì‚¬ ìƒí’ˆ -->
        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;">
          <div style="font-size: 13px; opacity: 0.8; margin-bottom: 12px;"><span style="background: var(--success); padding: 2px 8px; border-radius: 4px; font-size: 11px;">2</span> íƒ€ì‚¬ ìƒí’ˆ</div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">íŒë§¤ê¸ˆì•¡</span><span style="font-weight: 600;">${externalSellerTotals.salesAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ê³µê¸‰ì‚¬ì •ì‚°</span><span style="color: #fca5a5;">-${supplierTotals.totalAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ</span><span style="color: #fca5a5;">-${externalSellerTotals.marginAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">PGìˆ˜ìˆ˜ë£Œ(4%)</span><span style="color: #fca5a5;">-${externalPgFee.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ì´ë²¤íŠ¸ë¹„ìš©</span><span style="color: #fca5a5;">-${externalSellerTotals.eventCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);"><span>ìˆœìˆ˜ìµ</span><span style="font-weight: 700; color: ${externalProfit >= 0 ? '#86efac' : '#fca5a5'};">${externalProfit.toLocaleString()}ì›</span></div>
        </div>
        <!-- ì´ í•©ê³„ -->
        <div style="background: linear-gradient(135deg, var(--primary) 0%, #e08600 100%); border-radius: 12px; padding: 20px;">
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">ğŸ† ì´ í•©ê³„</div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">ì´ íŒë§¤ê¸ˆì•¡</span><span style="font-weight: 600;">${totalSalesAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed rgba(255,255,255,0.3);"><span style="opacity: 0.8;">ì´ ë§¤ì¶œê¸ˆì•¡ <small style="font-size:10px;">(ê³µê¸‰ê°€ ì œì™¸)</small></span><span style="font-weight: 700; font-size: 16px;">${totalRevenue.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ</span><span>-${totalSellerCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">ê³µê¸‰ì‚¬ì •ì‚°</span><span>-${totalSupplierCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">PGìˆ˜ìˆ˜ë£Œ(4%)</span><span>-${pgFee.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">ì´ë²¤íŠ¸ë¹„ìš©</span><span>-${totalEventCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);"><span style="font-weight: 600;">ì´ ìˆœì´ìµ</span><span style="font-size: 20px; font-weight: 800; color: ${totalProfit >= 0 ? '#fff' : '#fca5a5'};">${totalProfit.toLocaleString()}ì›</span></div>
        </div>
      </div>
    </div>
  `;
}

// ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
function scrollToSection(sectionId) {
  const el = document.getElementById(sectionId);
  if (el) {
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// ìì‚¬ìƒí’ˆ ì²´í¬ë°•ìŠ¤ ì „ì²´ ì„ íƒ/í•´ì œ
function toggleAllInhouseCheck(checked) {
  document.querySelectorAll('.inhouse-check').forEach(cb => cb.checked = checked);
}

// íƒ€ì‚¬ìƒí’ˆ ì²´í¬ë°•ìŠ¤ ì „ì²´ ì„ íƒ/í•´ì œ
function toggleAllExternalCheck(checked) {
  document.querySelectorAll('.external-check').forEach(cb => cb.checked = checked);
}

// ğŸ¯ ì „ì²´ ì •ì‚° ì²´í¬ë°•ìŠ¤ ì„ íƒ/í•´ì œ (ìì‚¬ + íƒ€ì‚¬ ëª¨ë‘)
function toggleAllSettlements(checked) {
  document.querySelectorAll('.inhouse-check').forEach(cb => cb.checked = checked);
  document.querySelectorAll('.external-check').forEach(cb => cb.checked = checked);
  // í…Œì´ë¸” í—¤ë”ì˜ ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤ë„ ë™ê¸°í™”
  document.querySelectorAll('th input[type="checkbox"]').forEach(cb => cb.checked = checked);

  const count = document.querySelectorAll('.inhouse-check:checked, .external-check:checked').length;
  if (checked && count > 0) {
    showToast(`${count}ê±´ ì„ íƒë¨`, 'info');
  }
}

// ì„ íƒëœ ì…€ëŸ¬ ì •ì‚°ì„œ ë³´ê¸°
function viewSelectedSellerStatements() {
  const inhouseIds = Array.from(document.querySelectorAll('.inhouse-check:checked')).map(cb => cb.dataset.id);
  const externalIds = Array.from(document.querySelectorAll('.external-check:checked')).map(cb => cb.dataset.id);
  const allIds = [...inhouseIds, ...externalIds];

  if (allIds.length === 0) {
    showToast('ì •ì‚°ì„œë¥¼ ë³¼ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
    return;
  }

  // ì²« ë²ˆì§¸ ì„ íƒ í•­ëª©ì˜ ì…€ëŸ¬ ì •ì‚°ì„œ í‘œì‹œ
  generateSellerStatement(allIds[0]);

  if (allIds.length > 1) {
    showToast(`${allIds.length}ê±´ ì¤‘ ì²« ë²ˆì§¸ ì…€ëŸ¬ ì •ì‚°ì„œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ê°œë³„ì ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.`, 'info');
  }
}

// ì„ íƒëœ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ë³´ê¸°
function viewSelectedSupplierStatements() {
  const externalIds = Array.from(document.querySelectorAll('.external-check:checked')).map(cb => cb.dataset.id);

  if (externalIds.length === 0) {
    showToast('ê³µê¸‰ì‚¬ ì •ì‚°ì„œë¥¼ ë³¼ íƒ€ì‚¬ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
    return;
  }

  // ì²« ë²ˆì§¸ ì„ íƒ í•­ëª©ì˜ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ í‘œì‹œ
  generateSupplierStatement(externalIds[0]);

  if (externalIds.length > 1) {
    showToast(`${externalIds.length}ê±´ ì¤‘ ì²« ë²ˆì§¸ ê³µê¸‰ì‚¬ ì •ì‚°ì„œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ê°œë³„ì ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.`, 'info');
  }
}

// ì„ íƒëœ ì •ì‚° ì‚­ì œ
function deleteSelectedSettlements() {
  const inhouseChecks = Array.from(document.querySelectorAll('.inhouse-check:checked'));
  const externalChecks = Array.from(document.querySelectorAll('.external-check:checked'));

  const totalCount = inhouseChecks.length + externalChecks.length;

  if (totalCount === 0) {
    showToast('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
    return;
  }

  showDeleteConfirmModal({
    title: 'ì„ íƒ í•­ëª© ì‚­ì œ',
    message: `<strong>${totalCount}ê±´</strong>ì˜ ì •ì‚° ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.<br><br>
      â€¢ ìì‚¬ìƒí’ˆ: ${inhouseChecks.length}ê±´<br>
      â€¢ íƒ€ì‚¬ìƒí’ˆ: ${externalChecks.length}ê±´<br><br>
      âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
    deleteType: 'bulk',
    onConfirm: async (method) => {
      try {
        // ìì‚¬ìƒí’ˆ ì‚­ì œ
        for (const cb of inhouseChecks) {
          const id = cb.dataset.id;
          if (method === 'hard') {
            await db.collection('sellerSettlements').doc(id).delete();
          } else {
            await db.collection('sellerSettlements').doc(id).update({
              isDeleted: true,
              deletedAt: new Date().toISOString()
            });
          }
        }

        // íƒ€ì‚¬ìƒí’ˆ ì‚­ì œ (ì…€ëŸ¬ + ê³µê¸‰ì‚¬)
        for (const cb of externalChecks) {
          const sellerId = cb.dataset.id;
          const supplierId = cb.dataset.supplierId;

          if (method === 'hard') {
            await db.collection('sellerSettlements').doc(sellerId).delete();
            if (supplierId) {
              await db.collection('supplierSettlements').doc(supplierId).delete();
            }
          } else {
            await db.collection('sellerSettlements').doc(sellerId).update({
              isDeleted: true,
              deletedAt: new Date().toISOString()
            });
            if (supplierId) {
              await db.collection('supplierSettlements').doc(supplierId).update({
                isDeleted: true,
                deletedAt: new Date().toISOString()
              });
            }
          }
        }

        showToast(`âœ… ${totalCount}ê±´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
        renderSettlement();
      } catch (err) {
        console.error(err);
        showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }
  });
}

// ê°œë³„ ì •ì‚° ì‚­ì œ í™•ì¸
function confirmDeleteSettlement(type, sellerId, supplierId = '') {
  const settlement = state.sellerSettlements.find(s => s.id === sellerId);
  const name = settlement ? `${settlement.sellerName} - ${settlement.brandName}` : 'ì •ì‚°';

  showDeleteConfirmModal({
    title: 'ì •ì‚° ë°ì´í„° ì‚­ì œ',
    message: `<strong>${name}</strong> ì •ì‚° ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.<br><br>
      ${supplierId ? 'â€¢ ì…€ëŸ¬ ì •ì‚° + ê³µê¸‰ì‚¬ ì •ì‚°ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤<br>' : ''}
      âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
    deleteType: 'single',
    onConfirm: async (method) => {
      try {
        if (method === 'hard') {
          await db.collection('sellerSettlements').doc(sellerId).delete();
          if (supplierId) {
            await db.collection('supplierSettlements').doc(supplierId).delete();
          }
        } else {
          await db.collection('sellerSettlements').doc(sellerId).update({
            isDeleted: true,
            deletedAt: new Date().toISOString()
          });
          if (supplierId) {
            await db.collection('supplierSettlements').doc(supplierId).update({
              isDeleted: true,
              deletedAt: new Date().toISOString()
            });
          }
        }

        showToast('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        renderSettlement();
      } catch (err) {
        console.error(err);
        showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }
  });
}

// ì •ì‚°ì™„ë£Œ ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸°
function toggleCompletedSection() {
  completedSectionCollapsed = !completedSectionCollapsed;
  renderSalesReport();
}

// ì •ì‚°ì™„ë£Œ ìƒíƒœ í† ê¸€
async function toggleSettlementComplete(type, id, setComplete, target) {
  // target: undefined (ê¸°ë³¸), 'seller' (ì…€ëŸ¬ë§Œ), 'supplier' (ê³µê¸‰ì‚¬ë§Œ)
  try {
    const collection = type === 'seller' ? 'sellerSettlements' : 'supplierSettlements';
    const doc = await db.collection(collection).doc(id).get();
    const data = doc.data();
    
    // targetì´ ì—†ê±°ë‚˜ ìì‚¬ ìƒí’ˆì¸ ê²½ìš°: ë‘˜ ë‹¤ ì™„ë£Œ ì²˜ë¦¬
    if (!target || data?.productType === 'inhouse') {
      await db.collection(collection).doc(id).update({
        isCompleted: setComplete,
        isSellerCompleted: setComplete,
        isSupplierCompleted: setComplete,
        completedAt: setComplete ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ì •ì‚°ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤' : 'â³ ì •ì‚°ëŒ€ê¸°ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
    } 
    // íƒ€ì‚¬ ìƒí’ˆ: ì…€ëŸ¬ë§Œ ì²˜ë¦¬
    else if (target === 'seller') {
      const isSupplierDone = data?.isSupplierCompleted || false;
      const bothDone = setComplete && isSupplierDone;
      await db.collection(collection).doc(id).update({
        isSellerCompleted: setComplete,
        isCompleted: bothDone,
        completedAt: bothDone ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ì…€ëŸ¬ ì •ì‚°ì™„ë£Œ' : 'â³ ì…€ëŸ¬ ì •ì‚°ëŒ€ê¸°');
    } 
    // íƒ€ì‚¬ ìƒí’ˆ: ê³µê¸‰ì‚¬ë§Œ ì²˜ë¦¬
    else if (target === 'supplier') {
      const isSellerDone = data?.isSellerCompleted || false;
      const bothDone = setComplete && isSellerDone;
      await db.collection(collection).doc(id).update({
        isSupplierCompleted: setComplete,
        isCompleted: bothDone,
        completedAt: bothDone ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ê³µê¸‰ì‚¬ ì •ì‚°ì™„ë£Œ' : 'â³ ê³µê¸‰ì‚¬ ì •ì‚°ëŒ€ê¸°');
    }
  } catch (err) {
    console.error(err);
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ğŸ†• íƒ€ì‚¬ ìƒí’ˆ ì „ìš© ì •ì‚° ì™„ë£Œ í† ê¸€ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ê°ê° ë³„ë„ ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸
async function toggleExternalSettlement(type, id, setComplete) {
  if (!id) {
    showToast('ì •ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  try {
    if (type === 'seller') {
      // sellerSettlements ì—…ë°ì´íŠ¸
      await db.collection('sellerSettlements').doc(id).update({
        isSellerCompleted: setComplete,
        isCompleted: setComplete,
        completedAt: setComplete ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ì…€ëŸ¬ ì •ì‚°ì™„ë£Œ' : 'â³ ì…€ëŸ¬ ì •ì‚°ëŒ€ê¸°');
    } 
    else if (type === 'supplier') {
      // supplierSettlements ì—…ë°ì´íŠ¸ (ë³„ë„ ì»¬ë ‰ì…˜!)
      await db.collection('supplierSettlements').doc(id).update({
        isCompleted: setComplete,
        completedAt: setComplete ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ê³µê¸‰ì‚¬ ì •ì‚°ì™„ë£Œ' : 'â³ ê³µê¸‰ì‚¬ ì •ì‚°ëŒ€ê¸°');
    }
  } catch (err) {
    console.error(err);
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}


function openSellerSettlementTypeModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header"><h2 class="modal-title">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚° ì¶”ê°€</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      <div style="padding: 20px 0;">
        <p style="text-align: center; color: var(--gray-600); margin-bottom: 24px;">ì •ì‚°í•  ìƒí’ˆ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div onclick="closeModal(); openSellerSettlementModal('inhouse')" style="background: var(--info-light); border: 2px solid var(--info); border-radius: 16px; padding: 24px; cursor: pointer; text-align: center; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
            <div style="font-size: 36px; margin-bottom: 12px;">ğŸ </div>
            <div style="font-size: 18px; font-weight: 700; color: var(--info); margin-bottom: 8px;">1-1. ìì‚¬ ìƒí’ˆ</div>
            <div style="font-size: 13px; color: var(--gray-600);">íŒë§¤ê¸ˆì•¡ = ë§¤ì¶œê¸ˆì•¡<br>ì…€ëŸ¬ ë§ˆì§„% ì ìš©</div>
          </div>
          <div onclick="closeModal(); openSellerSettlementModal('external')" style="background: var(--success-light); border: 2px solid var(--success); border-radius: 16px; padding: 24px; cursor: pointer; text-align: center; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
            <div style="font-size: 36px; margin-bottom: 12px;">ğŸ­</div>
            <div style="font-size: 18px; font-weight: 700; color: var(--success); margin-bottom: 8px;">1-2. íƒ€ì‚¬ ìƒí’ˆ</div>
            <div style="font-size: 13px; color: var(--gray-600);">ë§¤ì¶œ = íŒë§¤ - ê³µê¸‰ê°€<br>ì…€ëŸ¬ ë§ˆì§„% ì ìš©</div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: center;"><button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button></div>
    </div>
  `;
}

function openSellerSettlementModal(productType, item = null) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const isEdit = item !== null;
  const isInhouse = productType === 'inhouse';
  const s = item || { productType, sellerName: '', brandName: '', dealPeriod: '', salesItems: [], salesAmount: '', supplyAmount: '', revenueAmount: '', marginAmount: '', withholdingTax: '', actualPayment: '', settlementDate: formatDate(new Date()), notes: '' };
  
  // ê³µê¸‰ì‚¬ ë°ì´í„° ì‚¬ìš©
  const suppliers = state.suppliers || [];
  
  // ë””ë²„ê¹…: ì½˜ì†”ì— ê³µê¸‰ì‚¬ ì •ë³´ ì¶œë ¥
  console.log('=== ì…€ëŸ¬ ì •ì‚° ëª¨ë‹¬ ===');
  console.log('productType:', productType, '(isInhouse:', isInhouse, ')');
  console.log('ì „ì²´ ê³µê¸‰ì‚¬:', suppliers.map(s => ({ name: s.name, supplierType: s.supplierType })));
  
  const filteredSuppliers = isInhouse 
    ? suppliers.filter(sup => sup.supplierType === 'inhouse')
    : suppliers.filter(sup => sup.supplierType !== 'inhouse' && sup.supplierType !== undefined);
  
  console.log('í•„í„°ë§ëœ ê³µê¸‰ì‚¬:', filteredSuppliers.map(s => s.name));
  
  const salesItems = s.salesItems || [];
  const totalQty = salesItems.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
  const totalAmount = salesItems.reduce((sum, i) => sum + (Number(i.amount) || 0), 0);
  const totalMargin = salesItems.reduce((sum, i) => sum + (Number(i.marginAmount) || 0), 0);
  const totalActualPayment = salesItems.reduce((sum, i) => sum + (Number(i.actualPayment) || 0), 0);
  
  // ê³µê¸‰ì‚¬ê°€ ì—†ì„ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€
  const noSuppliersMsg = filteredSuppliers.length === 0 ? `
    <div style="background: var(--gray-100); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
      <div style="font-size: 13px; color: var(--gray-600);">
        âš ï¸ ${isInhouse ? 'ìì‚¬' : 'íƒ€ì‚¬'} ìœ í˜•ì˜ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
        <a href="#" onclick="closeModal(); setTab('suppliers');" style="color: #d97706; text-decoration: underline;">ê³µê¸‰ì‚¬ ë©”ë‰´</a>ì—ì„œ ê³µê¸‰ì‚¬ë¥¼ ë“±ë¡í•˜ê³  ìœ í˜•ì„ '${isInhouse ? 'ìì‚¬' : 'íƒ€ì‚¬'}'ë¡œ ì„¤ì •í•˜ì„¸ìš”.
      </div>
    </div>
  ` : '';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 750px;">
      <div class="modal-header"><h2 class="modal-title">${isEdit ? 'ì…€ëŸ¬ ì •ì‚° ìˆ˜ì •' : 'ìƒˆ ì…€ëŸ¬ ì •ì‚° ë“±ë¡'}</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      <div style="background: ${isInhouse ? 'var(--info-light)' : 'var(--success-light)'}; border-radius: 12px; padding: 16px; margin-bottom: 20px; border-left: 4px solid ${isInhouse ? 'var(--info)' : 'var(--success)'};">
        <div style="font-weight: 600; color: ${isInhouse ? 'var(--info)' : 'var(--success)'};">${isInhouse ? '1-1. ìì‚¬ ìƒí’ˆ ì •ì‚°' : '1-2. íƒ€ì‚¬ ìƒí’ˆ ì •ì‚°'}</div>
        <div style="font-size: 13px; color: var(--gray-600);">${isInhouse ? 'íŒë§¤ê¸ˆì•¡ = ë§¤ì¶œê¸ˆì•¡, ë¹„ìš© = ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ (ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ì ìš©)' : 'ë§¤ì¶œê¸ˆì•¡ = íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ê°€ì•¡ (ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ì ìš©)'}</div>
      </div>
      ${noSuppliersMsg}
      <form onsubmit="submitSellerSettlement(event, '${s.id || ''}', '${productType}')">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì…€ëŸ¬ëª… * <span style="font-size: 11px; color: var(--gray-500);">(${state.sellers.length}ëª…)</span></label>
            <select class="form-input" id="ss-sellerName" required onchange="handleSellerNameChange(this)">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${state.sellers.map(sel => `<option value="${sel.name}" ${s.sellerName === sel.name ? 'selected' : ''}>${sel.name}</option>`).join('')}
              <option value="_other" ${s.sellerName && !state.sellers.find(sel => sel.name === s.sellerName) ? 'selected' : ''}>ì§ì ‘ ì…ë ¥...</option>
            </select>
            <input type="text" class="form-input" id="ss-sellerNameCustom" value="${s.sellerName && !state.sellers.find(sel => sel.name === s.sellerName) ? s.sellerName : ''}" placeholder="ì§ì ‘ ì…ë ¥" style="display: ${s.sellerName && !state.sellers.find(sel => sel.name === s.sellerName) ? 'block' : 'none'}; margin-top: 8px;">
          </div>
          <div class="form-group">
            <label class="form-label">ë¸Œëœë“œ(ê³µê¸‰ì‚¬) * <span style="font-size: 11px; color: var(--gray-500);">(${filteredSuppliers.length}ê°œ)</span></label>
            <select class="form-input" id="ss-brandName" required onchange="handleBrandChange(this)">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${filteredSuppliers.map(sup => `<option value="${sup.name}" ${s.brandName === sup.name ? 'selected' : ''}>${sup.name}</option>`).join('')}
              <option value="_other" ${s.brandName && !filteredSuppliers.find(sup => sup.name === s.brandName) ? 'selected' : ''}>ì§ì ‘ ì…ë ¥...</option>
            </select>
            <input type="text" class="form-input" id="ss-brandNameCustom" value="${s.brandName && !filteredSuppliers.find(sup => sup.name === s.brandName) ? s.brandName : ''}" placeholder="ì§ì ‘ ì…ë ¥" style="display: ${s.brandName && !filteredSuppliers.find(sup => sup.name === s.brandName) ? 'block' : 'none'}; margin-top: 8px;">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê³µêµ¬ ê¸°ê°„</label><input type="text" class="form-input" id="ss-dealPeriod" value="${s.dealPeriod}" placeholder="2025-11-27~2025-11-30"></div>
          <div class="form-group"><label class="form-label">ì •ì‚°ì¼</label><input type="date" class="form-input" id="ss-settlementDate" value="${s.settlementDate}"></div>
        </div>
        
        <!-- íŒë§¤ ê±´ ëª©ë¡ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <label class="form-label" style="margin: 0; font-weight: 600;">ğŸ“¦ íŒë§¤ ê±´ ëª©ë¡ (ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ì„¤ì •)</label>
            <button type="button" class="btn btn-primary btn-sm" onclick="openSalesItemsEditor('${productType}')">+ íŒë§¤ê±´ ì¶”ê°€/í¸ì§‘</button>
          </div>
          <div id="ss-salesItemsList" style="max-height: 250px; overflow-y: auto;">
            ${salesItems.length === 0 ? '<div style="color: var(--gray-500); font-size: 13px; text-align: center; padding: 20px;">íŒë§¤ê±´ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>' : `
              <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                <thead><tr style="background: var(--gray-200);"><th style="padding: 6px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 6px; text-align: right;">íŒë§¤ë‹¨ê°€</th><th style="padding: 6px; text-align: right; background: var(--gray-50);">ê³µê¸‰ë‹¨ê°€</th><th style="padding: 6px; text-align: center;">ìˆ˜ëŸ‰</th><th style="padding: 6px; text-align: right;">íŒë§¤ê¸ˆì•¡</th><th style="padding: 6px; text-align: center;">ë§ˆì§„ìœ¨</th><th style="padding: 6px; text-align: right;">ë§ˆì§„ê¸ˆì•¡</th><th style="padding: 6px; text-align: right;">ì‹¤ì§€ê¸‰ì•¡</th></tr></thead>
                <tbody>${salesItems.map((item, i) => `<tr style="border-bottom: 1px solid var(--gray-200);"><td style="padding: 6px;">${item.productName || '-'}</td><td style="padding: 6px; text-align: right;">${Number(item.unitPrice || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; background: #fefce8;">${Number(item.supplyPrice || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: center;">${item.quantity || 0}</td><td style="padding: 6px; text-align: right;">${Number(item.amount || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: center; color: var(--primary);">${item.marginRate || 0}%</td><td style="padding: 6px; text-align: right; color: var(--danger);">${Number(item.marginAmount || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; color: var(--success);">${Number(item.actualPayment || 0).toLocaleString()}ì›</td></tr>`).join('')}</tbody>
                <tfoot><tr style="background: var(--gray-100); font-weight: 700;"><td style="padding: 6px;">í•©ê³„</td><td style="padding: 6px;"></td><td style="padding: 6px; background: var(--gray-50);"></td><td style="padding: 6px; text-align: center;">${totalQty}</td><td style="padding: 6px; text-align: right;">${totalAmount.toLocaleString()}ì›</td><td style="padding: 6px;"></td><td style="padding: 6px; text-align: right; color: var(--danger);">${totalMargin.toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; color: var(--success);">${totalActualPayment.toLocaleString()}ì›</td></tr></tfoot>
              </table>
            `}
          </div>
          <input type="hidden" id="ss-salesItems" value='${JSON.stringify(salesItems)}'>
        </div>
        
        <div class="form-row">
          <div class="form-group"><label class="form-label">ì´ íŒë§¤ê¸ˆì•¡</label><input type="number" class="form-input" id="ss-salesAmount" value="${s.salesAmount || totalAmount}" placeholder="íŒë§¤ê±´ í•©ê³„" style="background: var(--gray-50); font-weight: 600;" readonly></div>
          ${!isInhouse ? `<div class="form-group"><label class="form-label">ê³µê¸‰ê°€ì•¡ (VAT+)</label><input type="number" class="form-input" id="ss-supplyAmount" value="${s.supplyAmount || salesItems.reduce((sum, i) => sum + (Number(i.supplyPrice || 0) * Number(i.quantity || 0)), 0)}" placeholder="ìë™ ê³„ì‚°" style="background: var(--gray-50);" readonly></div>` : ''}
        </div>
        ${!isInhouse ? `<div class="form-group"><label class="form-label">ë§¤ì¶œê¸ˆì•¡ (íŒë§¤ - ê³µê¸‰)</label><input type="number" class="form-input" id="ss-revenueAmount" value="${s.revenueAmount}" placeholder="ìë™ ê³„ì‚°" style="background: var(--gray-50); font-weight: 600;" readonly></div>` : ''}
        <div class="form-row">
          <div class="form-group"><label class="form-label">ì´ ë§ˆì§„ê¸ˆì•¡ (ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ)</label><input type="number" class="form-input" id="ss-marginAmount" value="${s.marginAmount || totalMargin}" placeholder="íŒë§¤ê±´ í•©ê³„" style="background: var(--danger-light);" readonly></div>
          <div class="form-group"><label class="form-label">ì›ì²œì„¸ (3.3%)</label><input type="number" class="form-input" id="ss-withholdingTax" value="${s.withholdingTax || Math.round(totalMargin * 0.033)}" placeholder="ìë™ ê³„ì‚°" readonly></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ì…€ëŸ¬ ì‹¤ì§€ê¸‰ì•¡</label><input type="number" class="form-input" id="ss-actualPayment" value="${s.actualPayment || totalActualPayment}" placeholder="íŒë§¤ê±´ í•©ê³„" style="background: var(--success-light); font-weight: 600;" readonly></div>
          <div class="form-group">
            <label class="form-label">ğŸ ì´ë²¤íŠ¸ë¹„ìš© <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">(ì…€ëŸ¬ ë¬´ë£Œì§€ì›)</span></label>
            <input type="number" class="form-input" id="ss-eventCost" value="${s.eventCost || 0}" placeholder="0" style="background: #fce7f3; border-color: #ec4899;">
          </div>
        </div>
        <div class="form-group"><label class="form-label">ë¹„ê³ </label><textarea class="form-textarea" id="ss-notes" rows="2" placeholder="ì¶”ê°€ ë©”ëª¨">${s.notes || ''}</textarea></div>
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSellerSettlement('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
}

// íŒë§¤ê±´ í¸ì§‘ê¸° (ë³„ë„ ëª¨ë‹¬) - ìƒí’ˆ ê²€ìƒ‰ í¬í•¨
function openSalesItemsEditor(productType) {
  const currentItems = JSON.parse(document.getElementById('ss-salesItems')?.value || '[]');
  const brandName = document.getElementById('ss-brandName')?.value || '';
  const isInhouse = productType === 'inhouse';
  
  // productTypeì— ë§ëŠ” ìƒí’ˆë§Œ í•„í„°ë§
  const filteredProducts = (state.supplierProducts || []).filter(p => {
    if (isInhouse) {
      return p.supplierType === 'inhouse';
    } else {
      return p.supplierType !== 'inhouse';
    }
  });
  const brands = [...new Set(filteredProducts.map(p => p.brandName))];
  
  // í˜„ì¬ ì„ íƒëœ ë¸Œëœë“œê°€ í•„í„°ë§ëœ ë¸Œëœë“œì— ì—†ìœ¼ë©´ ì´ˆê¸°í™”
  const selectedBrand = brands.includes(brandName) ? brandName : '';
  
  const editorModal = document.createElement('div');
  editorModal.id = 'salesItemsEditor';
  editorModal.dataset.productType = productType; // productType ì €ì¥
  editorModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  editorModal.innerHTML = `
    <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">ğŸ“¦ íŒë§¤ê±´ í¸ì§‘ <span style="font-size: 13px; color: ${isInhouse ? 'var(--info)' : 'var(--success)'}; font-weight: normal;">(${isInhouse ? 'ìì‚¬ ìƒí’ˆ' : 'íƒ€ì‚¬ ìƒí’ˆ'})</span></h3>
        <button onclick="closeSalesItemsEditor()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
      </div>
      <div style="padding: 16px 20px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200);">
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
          <span style="font-size: 13px; color: var(--gray-600);">ğŸ” ìƒí’ˆ ê²€ìƒ‰:</span>
          <input type="text" id="salesProductSearch" class="form-input" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." style="width: 200px;" oninput="filterSalesProducts()">
          <select id="salesBrandFilter" class="form-input" style="width: 150px;" onchange="filterSalesProducts()">
            <option value="">ì „ì²´ ë¸Œëœë“œ</option>
            ${brands.map(b => `<option value="${b}" ${b === selectedBrand ? 'selected' : ''}>${b}</option>`).join('')}
          </select>
          <button type="button" class="btn btn-primary btn-sm" onclick="addSelectedSalesProducts('${productType}')">ì„ íƒ ìƒí’ˆ ì¶”ê°€</button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addSalesItemRow()">+ ì§ì ‘ ì…ë ¥</button>
        </div>
        <div id="salesProductResults" style="margin-top: 12px; max-height: 150px; overflow-y: auto; display: none;">
        </div>
      </div>
      <div style="padding: 20px; flex: 1; overflow-y: auto;">
        <!-- í—¤ë” ë¼ë²¨ -->
        <div style="display: grid; grid-template-columns: 2fr 90px 90px 60px 90px 70px 90px 90px 36px; gap: 6px; padding: 8px 12px; background: var(--gray-100); border-radius: 8px; margin-bottom: 8px; font-size: 11px; font-weight: 600; color: var(--gray-600);">
          <div>ìƒí’ˆëª…</div>
          <div style="text-align: center;">íŒë§¤ë‹¨ê°€</div>
          <div style="text-align: center; background: var(--gray-50); border-radius: 4px;">ê³µê¸‰ë‹¨ê°€</div>
          <div style="text-align: center;">ìˆ˜ëŸ‰</div>
          <div style="text-align: center; color: var(--info);">íŒë§¤ê¸ˆì•¡</div>
          <div style="text-align: center; color: var(--gray-600);">ë§ˆì§„ìœ¨</div>
          <div style="text-align: center; color: var(--danger);">ë§ˆì§„ê¸ˆì•¡</div>
          <div style="text-align: center; color: var(--success);">ì‹¤ì§€ê¸‰ì•¡</div>
          <div></div>
        </div>
        
        <div id="salesItemsRows">
          ${currentItems.length === 0 ? getSalesItemRow(0, {}, productType) : currentItems.map((item, i) => getSalesItemRow(i, item, productType)).join('')}
        </div>
      </div>
      <div style="padding: 16px 20px; border-top: 1px solid var(--gray-200); background: var(--gray-50); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <div style="font-size: 14px;">
          <span style="color: var(--gray-600);">ì´ ìˆ˜ëŸ‰:</span> <strong id="editorTotalQty">0</strong>ê°œ &nbsp;|&nbsp;
          <span style="color: var(--gray-600);">ì´ íŒë§¤ê¸ˆì•¡:</span> <strong id="editorTotalAmount" style="color: var(--primary);">0</strong>ì› &nbsp;|&nbsp;
          <span style="color: var(--danger);">ì´ ë§ˆì§„ê¸ˆì•¡:</span> <strong id="editorTotalMargin" style="color: var(--danger);">0</strong>ì›
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="closeSalesItemsEditor()" class="btn btn-secondary">ì·¨ì†Œ</button>
          <button onclick="saveSalesItems('${productType}')" class="btn btn-primary">ì ìš©í•˜ê¸°</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(editorModal);
  filterSalesProducts(); // ì´ˆê¸° ìƒí’ˆ ëª©ë¡ í‘œì‹œ
  updateEditorTotals();
}

// ìƒí’ˆ ê²€ìƒ‰ í•„í„°
function filterSalesProducts() {
  const searchText = document.getElementById('salesProductSearch')?.value.toLowerCase() || '';
  const brandFilter = document.getElementById('salesBrandFilter')?.value || '';
  const editorModal = document.getElementById('salesItemsEditor');
  const productType = editorModal?.dataset?.productType || '';
  const isInhouse = productType === 'inhouse';
  
  const products = state.supplierProducts || [];
  
  // productTypeì— ë§ëŠ” ìƒí’ˆë§Œ í•„í„°ë§
  const filtered = products.filter(p => {
    // ìì‚¬/íƒ€ì‚¬ í•„í„°
    const matchType = isInhouse ? (p.supplierType === 'inhouse') : (p.supplierType !== 'inhouse');
    const matchBrand = !brandFilter || p.brandName === brandFilter;
    const matchText = !searchText || p.productName.toLowerCase().includes(searchText) || p.brandName.toLowerCase().includes(searchText);
    return matchType && matchBrand && matchText;
  });
  
  const container = document.getElementById('salesProductResults');
  if (filtered.length === 0) {
    container.style.display = 'block';
    container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">
      ${isInhouse ? 'ğŸ  ìì‚¬ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ê³µê¸‰ì‚¬ ë©”ë‰´ì—ì„œ ìì‚¬ ê³µê¸‰ì‚¬ì˜ ìƒí’ˆì„ ë“±ë¡í•˜ì„¸ìš”.' : 'ğŸ­ íƒ€ì‚¬ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ê³µê¸‰ì‚¬ ë©”ë‰´ì—ì„œ íƒ€ì‚¬ ê³µê¸‰ì‚¬ì˜ ìƒí’ˆì„ ë“±ë¡í•˜ì„¸ìš”.'}
    </div>`;
    return;
  }
  
  container.style.display = 'block';
  
  // ìì‚¬ì™€ íƒ€ì‚¬ì— ë”°ë¼ ë‹¤ë¥¸ ì»¬ëŸ¼ í‘œì‹œ
  const lastColHeader = isInhouse ? 'ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ' : 'ê³µê¸‰ë‹¨ê°€(V+)';
  const lastColValue = (p) => isInhouse ? Number(p.marginFee || 0).toLocaleString() : Number(p.supplyPrice || 0).toLocaleString();
  
  container.innerHTML = `
    <table style="width: 100%; font-size: 12px; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden;">
      <thead><tr style="background: var(--gray-200);"><th style="padding: 6px; width: 30px;"></th><th style="padding: 6px; text-align: left;">ë¸Œëœë“œ</th><th style="padding: 6px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 6px; text-align: right;">ì†Œë¹„ìì •ê°€</th><th style="padding: 6px; text-align: right;">ê³µêµ¬íŒë§¤ê°€</th><th style="padding: 6px; text-align: right; background: var(--gray-50);">${lastColHeader}</th></tr></thead>
      <tbody>
        ${filtered.slice(0, 10).map(p => `
          <tr style="border-bottom: 1px solid var(--gray-100);" data-product='${JSON.stringify(p).replace(/'/g, "&#39;")}'>
            <td style="padding: 6px; text-align: center;"><input type="checkbox" class="sales-product-checkbox" style="width: 16px; height: 16px;"></td>
            <td style="padding: 6px;"><span class="status-badge ${p.supplierType === 'inhouse' ? 'status-confirmed' : 'status-negotiating'}" style="font-size: 10px;">${p.brandName}</span></td>
            <td style="padding: 6px;">${p.productName}</td>
            <td style="padding: 6px; text-align: right; color: var(--gray-500); text-decoration: line-through;">${Number(p.retailPrice || 0).toLocaleString()}ì›</td>
            <td style="padding: 6px; text-align: right; font-weight: 600;">${Number(p.salePrice || 0).toLocaleString()}ì›</td>
            <td style="padding: 6px; text-align: right; background: #fefce8; font-weight: 600;">${lastColValue(p)}ì›</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    ${filtered.length > 10 ? `<div style="text-align: center; padding: 8px; font-size: 12px; color: var(--gray-500);">ê²€ìƒ‰ ê²°ê³¼ ${filtered.length}ê°œ ì¤‘ 10ê°œ í‘œì‹œ</div>` : ''}
  `;
}

// ì„ íƒí•œ ìƒí’ˆ ì¶”ê°€
function addSelectedSalesProducts(productType) {
  const checkboxes = document.querySelectorAll('.sales-product-checkbox:checked');
  if (checkboxes.length === 0) {
    showToast('ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  const isInhouse = productType === 'inhouse';
  
  checkboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    const product = JSON.parse(row.dataset.product);
    
    const container = document.getElementById('salesItemsRows');
    const newIndex = container.children.length;
    
    // ê³µê¸‰ì‚¬ ìƒí’ˆ ì •ë³´ ìë™ ì…ë ¥
    let item;
    if (isInhouse) {
      // ìì‚¬: marginFeeë¡œ ë§ˆì§„ìœ¨ ê³„ì‚°
      const salePrice = product.salePrice || 0;
      const marginFee = product.marginFee || 0;
      const calculatedMarginRate = salePrice > 0 ? Math.round((marginFee / salePrice) * 100) : 0;
      
      item = {
        productName: product.productName,
        unitPrice: salePrice,  // ê³µêµ¬íŒë§¤ê°€
        supplyPrice: 0,  // ìì‚¬ëŠ” ê³µê¸‰ë‹¨ê°€ ì—†ìŒ
        quantity: 1,
        marginRate: calculatedMarginRate  // marginFee ê¸°ë°˜ ë§ˆì§„ìœ¨
      };
    } else {
      // íƒ€ì‚¬: supplyPrice ì‚¬ìš©
      item = {
        productName: product.productName,
        unitPrice: product.salePrice || 0,  // ê³µêµ¬íŒë§¤ê°€
        supplyPrice: product.supplyPrice || 0,  // ê³µê¸‰ë‹¨ê°€
        quantity: 1,
        marginRate: 20  // ê¸°ë³¸ ë§ˆì§„ìœ¨
      };
    }
    
    container.insertAdjacentHTML('beforeend', getSalesItemRow(newIndex, item, productType));
  });
  
  // ì²´í¬ë°•ìŠ¤ í•´ì œ
  checkboxes.forEach(cb => cb.checked = false);
  
  // ê¸ˆì•¡ ê³„ì‚°
  document.querySelectorAll('.sales-item-row').forEach(row => {
    const input = row.querySelector('.si-unitPrice');
    if (input) updateSalesItemAmount(input);
  });
  
  showToast(`${checkboxes.length}ê°œ ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
}

function getSalesItemRow(index, item = {}, productType = '') {
  return `
    <div class="sales-item-row" style="display: grid; grid-template-columns: 2fr 90px 90px 60px 90px 70px 90px 90px 36px; gap: 6px; align-items: center; padding: 10px; background: #fff; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 8px;">
      <input type="text" class="form-input si-productName" value="${item.productName || ''}" placeholder="ìƒí’ˆëª…" style="font-size: 12px;">
      <input type="number" class="form-input si-unitPrice" value="${item.unitPrice || ''}" placeholder="íŒë§¤ë‹¨ê°€" style="font-size: 12px;" oninput="updateSalesItemAmount(this)">
      <input type="number" class="form-input si-supplyPrice" value="${item.supplyPrice || ''}" placeholder="ê³µê¸‰ë‹¨ê°€" style="font-size: 12px; background: var(--gray-50);">
      <input type="number" class="form-input si-quantity" value="${item.quantity || ''}" placeholder="ìˆ˜ëŸ‰" style="font-size: 12px; text-align: center;" oninput="updateSalesItemAmount(this)">
      <input type="number" class="form-input si-amount" value="${item.amount || ''}" placeholder="íŒë§¤ê¸ˆì•¡" style="font-size: 12px; background: var(--gray-50); font-weight: 600;" readonly>
      <input type="number" class="form-input si-marginRate" value="${item.marginRate || '20'}" placeholder="%" style="font-size: 12px; text-align: center; background: var(--gray-50);" oninput="updateSalesItemAmount(this)">
      <input type="number" class="form-input si-marginAmount" value="${item.marginAmount || ''}" placeholder="ë§ˆì§„ê¸ˆì•¡" style="font-size: 12px; background: var(--danger-light); color: var(--danger);" readonly>
      <input type="number" class="form-input si-actualPayment" value="${item.actualPayment || ''}" placeholder="ì‹¤ì§€ê¸‰ì•¡" style="font-size: 12px; background: var(--success-light); color: var(--success);" readonly>
      <button type="button" onclick="removeSalesItemRow(this)" style="background: none; border: none; color: var(--danger); font-size: 18px; cursor: pointer;">Ã—</button>
    </div>
  `;
}

function addSalesItemRow() {
  const container = document.getElementById('salesItemsRows');
  const newIndex = container.children.length;
  container.insertAdjacentHTML('beforeend', getSalesItemRow(newIndex, {}, ''));
}

function removeSalesItemRow(btn) {
  const row = btn.closest('.sales-item-row');
  if (document.querySelectorAll('.sales-item-row').length > 1) {
    row.remove();
    updateEditorTotals();
  }
}

function updateSalesItemAmount(input) {
  const row = input.closest('.sales-item-row');
  const unitPrice = Number(row.querySelector('.si-unitPrice').value) || 0;
  const quantity = Number(row.querySelector('.si-quantity').value) || 0;
  const marginRate = Number(row.querySelector('.si-marginRate').value) || 0;
  
  const amount = unitPrice * quantity;
  const marginAmount = Math.round(amount * (marginRate / 100));
  const withholdingTax = Math.round(marginAmount * 0.033);
  const actualPayment = marginAmount - withholdingTax;
  
  row.querySelector('.si-amount').value = amount;
  row.querySelector('.si-marginAmount').value = marginAmount;
  row.querySelector('.si-actualPayment').value = actualPayment;
  updateEditorTotals();
}

function updateEditorTotals() {
  const rows = document.querySelectorAll('.sales-item-row');
  let totalQty = 0, totalAmount = 0, totalMargin = 0;
  rows.forEach(row => {
    totalQty += Number(row.querySelector('.si-quantity')?.value) || 0;
    totalAmount += Number(row.querySelector('.si-amount')?.value) || 0;
    totalMargin += Number(row.querySelector('.si-marginAmount')?.value) || 0;
  });
  if (document.getElementById('editorTotalQty')) document.getElementById('editorTotalQty').textContent = totalQty;
  if (document.getElementById('editorTotalAmount')) document.getElementById('editorTotalAmount').textContent = totalAmount.toLocaleString();
  if (document.getElementById('editorTotalMargin')) document.getElementById('editorTotalMargin').textContent = totalMargin.toLocaleString();
}

function closeSalesItemsEditor() {
  const editor = document.getElementById('salesItemsEditor');
  if (editor) editor.remove();
}

function saveSalesItems(productType) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const rows = document.querySelectorAll('.sales-item-row');
  const items = [];
  let totalAmount = 0, totalMarginAmount = 0, totalActualPayment = 0, totalSupplyAmount = 0;
  
  rows.forEach(row => {
    const productName = row.querySelector('.si-productName').value.trim();
    const unitPrice = Number(row.querySelector('.si-unitPrice').value) || 0;
    const supplyPrice = Number(row.querySelector('.si-supplyPrice')?.value) || 0;
    const quantity = Number(row.querySelector('.si-quantity').value) || 0;
    const amount = Number(row.querySelector('.si-amount').value) || 0;
    const marginRate = Number(row.querySelector('.si-marginRate').value) || 0;
    const marginAmount = Number(row.querySelector('.si-marginAmount').value) || 0;
    const withholdingTax = Math.round(marginAmount * 0.033);
    const actualPayment = Number(row.querySelector('.si-actualPayment').value) || 0;
    
    if (productName || unitPrice || quantity) {
      items.push({ productName, unitPrice, supplyPrice, quantity, amount, marginRate, marginAmount, withholdingTax, actualPayment });
      totalAmount += amount;
      totalMarginAmount += marginAmount;
      totalActualPayment += actualPayment;
      totalSupplyAmount += supplyPrice * quantity;
    }
  });
  
  const totalWithholdingTax = Math.round(totalMarginAmount * 0.033);
  
  // ë©”ì¸ ëª¨ë‹¬ì— ë°˜ì˜
  document.getElementById('ss-salesItems').value = JSON.stringify(items);
  document.getElementById('ss-salesAmount').value = totalAmount;
  if (document.getElementById('ss-supplyAmount')) document.getElementById('ss-supplyAmount').value = totalSupplyAmount;
  if (document.getElementById('ss-marginAmount')) document.getElementById('ss-marginAmount').value = totalMarginAmount;
  if (document.getElementById('ss-withholdingTax')) document.getElementById('ss-withholdingTax').value = totalWithholdingTax;
  if (document.getElementById('ss-actualPayment')) document.getElementById('ss-actualPayment').value = totalMarginAmount - totalWithholdingTax;
  
  // íƒ€ì‚¬ ìƒí’ˆì¼ ê²½ìš° ë§¤ì¶œê¸ˆì•¡ ê³„ì‚°
  if (productType === 'external') {
    calculateSellerMargin(productType);
  }
  
  // ë©”ì¸ ëª¨ë‹¬ì— ë°˜ì˜
  document.getElementById('ss-salesItems').value = JSON.stringify(items);
  document.getElementById('ss-salesAmount').value = totalAmount;
  if (document.getElementById('ss-marginAmount')) document.getElementById('ss-marginAmount').value = totalMarginAmount;
  if (document.getElementById('ss-withholdingTax')) document.getElementById('ss-withholdingTax').value = totalWithholdingTax;
  if (document.getElementById('ss-actualPayment')) document.getElementById('ss-actualPayment').value = totalMarginAmount - totalWithholdingTax;
  
  // íŒë§¤ê±´ ëª©ë¡ UI ì—…ë°ì´íŠ¸
  const listContainer = document.getElementById('ss-salesItemsList');
  if (items.length === 0) {
    listContainer.innerHTML = '<div style="color: var(--gray-500); font-size: 13px; text-align: center; padding: 20px;">íŒë§¤ê±´ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>';
  } else {
    listContainer.innerHTML = `
      <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
        <thead><tr style="background: var(--gray-200);"><th style="padding: 6px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 6px; text-align: right;">íŒë§¤ë‹¨ê°€</th><th style="padding: 6px; text-align: center;">ìˆ˜ëŸ‰</th><th style="padding: 6px; text-align: right;">íŒë§¤ê¸ˆì•¡</th><th style="padding: 6px; text-align: center;">ë§ˆì§„ìœ¨</th><th style="padding: 6px; text-align: right;">ë§ˆì§„ê¸ˆì•¡</th><th style="padding: 6px; text-align: right;">ì‹¤ì§€ê¸‰ì•¡</th></tr></thead>
        <tbody>${items.map(item => `<tr style="border-bottom: 1px solid var(--gray-200);"><td style="padding: 6px;">${item.productName || '-'}</td><td style="padding: 6px; text-align: right;">${Number(item.unitPrice || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: center;">${item.quantity || 0}</td><td style="padding: 6px; text-align: right;">${Number(item.amount || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: center; color: var(--primary);">${item.marginRate}%</td><td style="padding: 6px; text-align: right; color: var(--danger);">${Number(item.marginAmount || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; color: var(--success);">${Number(item.actualPayment || 0).toLocaleString()}ì›</td></tr>`).join('')}</tbody>
        <tfoot><tr style="background: var(--gray-100); font-weight: 700;"><td style="padding: 6px;">í•©ê³„</td><td style="padding: 6px;"></td><td style="padding: 6px; text-align: center;">${items.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0)}</td><td style="padding: 6px; text-align: right;">${totalAmount.toLocaleString()}ì›</td><td style="padding: 6px;"></td><td style="padding: 6px; text-align: right; color: var(--danger);">${totalMarginAmount.toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; color: var(--success);">${totalActualPayment.toLocaleString()}ì›</td></tr></tfoot>
      </table>
    `;
  }
  
  closeSalesItemsEditor();
}

function calculateSellerMargin(productType) {
  const salesAmount = Number(document.getElementById('ss-salesAmount')?.value) || 0;
  if (productType === 'external') {
    const supplyAmount = Number(document.getElementById('ss-supplyAmount')?.value) || 0;
    const revenueAmount = salesAmount - supplyAmount;
    if (document.getElementById('ss-revenueAmount')) document.getElementById('ss-revenueAmount').value = revenueAmount;
  }
}

async function submitSellerSettlement(e, id, productType) {
  e.preventDefault();
  const salesItems = JSON.parse(document.getElementById('ss-salesItems')?.value || '[]');
  const salesAmount = Number(document.getElementById('ss-salesAmount').value) || 0;
  const supplyAmount = Number(document.getElementById('ss-supplyAmount')?.value) || 0;
  const revenueAmount = productType === 'external' ? salesAmount - supplyAmount : salesAmount;
  const totalQuantity = salesItems.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
  const baseMarginAmount = salesItems.reduce((sum, i) => sum + (Number(i.marginAmount) || 0), 0);
  
  // ğŸ 500ê°œ ë‹¨ìœ„ ë³´ë„ˆìŠ¤ ë§ˆì§„ ê³„ì‚° (500ê°œë‹¹ 1%)
  const bonusRate = Math.floor(totalQuantity / 500);
  const bonusMarginAmount = bonusRate > 0 ? Math.round(salesAmount * bonusRate / 100) : 0;
  const marginAmount = baseMarginAmount + bonusMarginAmount; // ë³´ë„ˆìŠ¤ í¬í•¨ ì´ ì…€ëŸ¬ ë§ˆì§„
  
  const withholdingTax = Math.round(marginAmount * 0.033);
  const actualPayment = marginAmount - withholdingTax;
  const eventCost = Number(document.getElementById('ss-eventCost')?.value) || 0;
  
  // ë¸Œëœë“œëª… ì²˜ë¦¬ (ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì„ íƒ)
  const brandSelect = document.getElementById('ss-brandName').value;
  const brandName = brandSelect === '_other' 
    ? document.getElementById('ss-brandNameCustom').value 
    : brandSelect;
  
  // ì…€ëŸ¬ëª… ì²˜ë¦¬ (ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì„ íƒ)
  const sellerSelect = document.getElementById('ss-sellerName').value;
  const sellerName = sellerSelect === '_other' 
    ? document.getElementById('ss-sellerNameCustom').value 
    : sellerSelect;
  
  // sellerId ì°¾ê¸° (ì…€ëŸ¬ëª…ìœ¼ë¡œ ë§¤ì¹­)
  const matchedSeller = state.sellers.find(s => s.name === sellerName);
  const sellerId = matchedSeller?.id || '';
  
  // supplierId ì°¾ê¸° (ë¸Œëœë“œëª…ìœ¼ë¡œ ë§¤ì¹­)
  const matchedSupplier = state.suppliers.find(s => s.name === brandName);
  const supplierId = matchedSupplier?.id || '';
  
  const data = {
    productType, sellerName: sellerName, brandName: brandName,
    sellerId: sellerId, supplierId: supplierId,
    dealPeriod: document.getElementById('ss-dealPeriod').value, salesItems, totalQuantity, salesAmount, supplyAmount, revenueAmount,
    baseMarginAmount, bonusRate, bonusMarginAmount, // ë³´ë„ˆìŠ¤ ê´€ë ¨ í•„ë“œ ì¶”ê°€
    marginAmount, withholdingTax, actualPayment, eventCost,
    settlementDate: document.getElementById('ss-settlementDate').value, notes: document.getElementById('ss-notes').value, updatedAt: new Date().toISOString()
  };
  try {
    if (id) { await db.collection('sellerSettlements').doc(id).update(data); }
    else { data.createdAt = new Date().toISOString(); await db.collection('sellerSettlements').add(data); }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤' + (bonusRate > 0 ? ` (ì…€ëŸ¬ ë³´ë„ˆìŠ¤ +${bonusRate}% ì ìš©)` : '')); closeModal();
  } catch(err) { showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

async function deleteSellerSettlement(id) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try { await db.collection('sellerSettlements').doc(id).delete(); showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); closeModal(); } catch(err) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

// ========================================
// 1. ê³µê¸‰ì‚¬ ìƒí’ˆ ë“±ë¡ (ê¸°ë³¸ ì •ë³´ë§Œ)
// ========================================
function openSupplierProductModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const products = state.supplierProducts || [];
  const brands = state.settlementBrands || [];
  
  // ë¸Œëœë“œë³„ ê·¸ë£¹í•‘
  const groupedProducts = products.reduce((acc, p) => {
    if (!acc[p.brandName]) acc[p.brandName] = [];
    acc[p.brandName].push(p);
    return acc;
  }, {});
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 950px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“¦ ê³µê¸‰ì‚¬ ìƒí’ˆ ë“±ë¡</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="display: flex; gap: 8px; padding: 0 0 16px 0; border-bottom: 1px solid var(--gray-200); margin-bottom: 16px;">
        <button class="btn btn-primary btn-sm" onclick="openProductAddModal()">â• ìƒí’ˆ ë“±ë¡</button>
        <button class="btn btn-secondary btn-sm" onclick="openProductBulkImportModal()">ğŸ“¥ ì—‘ì…€ ì¼ê´„ë“±ë¡</button>
        <button class="btn btn-secondary btn-sm" onclick="downloadProductTemplate()">ğŸ“„ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-secondary btn-sm" onclick="exportProductsToExcel()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
      </div>
      
      <div style="flex: 1; overflow-y: auto;">
        ${Object.keys(groupedProducts).length === 0 ? '<div class="empty-state"><div class="icon">ğŸ“¦</div><div class="text">ë“±ë¡ëœ ê³µê¸‰ì‚¬ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤<br><small>ìƒí’ˆì„ ë“±ë¡í•˜ê±°ë‚˜ ì—‘ì…€ë¡œ ì¼ê´„ë“±ë¡í•˜ì„¸ìš”</small></div></div>' : `
          ${Object.entries(groupedProducts).map(([brand, prods]) => `
            <div style="margin-bottom: 24px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <span class="status-badge status-negotiating" style="font-size: 14px;">${brand}</span>
                <span style="color: var(--gray-500); font-size: 13px;">${prods.length}ê°œ ìƒí’ˆ</span>
              </div>
              <div style="overflow-x: auto;">
                <table class="data-table" style="font-size: 12px;">
                  <thead>
                    <tr style="background: var(--gray-100);">
                      <th style="min-width: 200px;">ìƒí’ˆëª…</th>
                      <th style="text-align: right;">ì†Œë¹„ìì •ê°€</th>
                      <th style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                      <th style="text-align: right; background: var(--gray-50);">ê³µê¸‰ë‹¨ê°€(V+)</th>
                      <th style="text-align: right; background: var(--gray-50);">ë°°ì†¡ë£Œ</th>
                      <th style="text-align: right;">ì •ê°€í• ì¸ìœ¨</th>
                      <th style="text-align: right;">ì´ë§ˆì§„ìœ¨</th>
                      <th style="text-align: right;">ì´ë§ˆì§„ê¸ˆ</th>
                      <th style="width: 80px;"></th>
                    </tr>
                  </thead>
                  <tbody>
                    ${prods.map(p => {
                      const retailPrice = Number(p.retailPrice) || 0;
                      const salePrice = Number(p.salePrice) || 0;
                      const supplyPrice = Number(p.supplyPrice) || 0;
                      const shippingFee = Number(p.shippingFee) || 0;
                      const discountRate = retailPrice > 0 ? ((retailPrice - salePrice) / retailPrice * 100).toFixed(1) : 0;
                      const totalMargin = salePrice - supplyPrice;
                      const totalMarginRate = salePrice > 0 ? (totalMargin / salePrice * 100).toFixed(1) : 0;
                      return `<tr>
                        <td>${p.productName}</td>
                        <td style="text-align: right;">${retailPrice.toLocaleString()}ì›</td>
                        <td style="text-align: right;">${salePrice.toLocaleString()}ì›</td>
                        <td style="text-align: right; background: #fefce8; font-weight: 600;">${supplyPrice.toLocaleString()}ì›</td>
                        <td style="text-align: right; background: #f0f9ff;">${shippingFee.toLocaleString()}ì›</td>
                        <td style="text-align: right; color: var(--danger);">${discountRate}%</td>
                        <td style="text-align: right;">${totalMarginRate}%</td>
                        <td style="text-align: right; font-weight: 600;">${totalMargin.toLocaleString()}ì›</td>
                        <td class="actions">
                          <button class="btn btn-secondary btn-sm" onclick="editSupplierProduct('${p.id}')" style="padding: 4px 8px;">ìˆ˜ì •</button>
                          <!-- ì‚­ì œ ë²„íŠ¼ ë¹„í™œì„±í™” (ë°ì´í„° ë³´í˜¸) -->
                        </td>
                      </tr>`;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `).join('')}
        `}
      </div>
      
      <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button></div>
    </div>
  `;
}

// ìƒí’ˆ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ (ê¸°ë³¸ ì •ë³´ë§Œ)
function openProductAddModal(item = null) {
  const isEdit = item !== null;
  const p = item || { brandName: '', productName: '', retailPrice: '', salePrice: '', supplyPrice: '', shippingFee: '' };
  const brands = state.settlementBrands || [];
  
  const editorModal = document.createElement('div');
  editorModal.id = 'productAddModal';
  editorModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  editorModal.innerHTML = `
    <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden;">
      <div style="padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">${isEdit ? 'ğŸ“ ìƒí’ˆ ìˆ˜ì •' : 'â• ìƒˆ ìƒí’ˆ ë“±ë¡'}</h3>
        <button onclick="document.getElementById('productAddModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
      </div>
      <form onsubmit="submitSupplierProductForm(event, '${p.id || ''}')" style="padding: 20px;">
        <div class="form-group"><label class="form-label">ê³µê¸‰ì‚¬(ë¸Œëœë“œ) *</label><input type="text" class="form-input" id="pf-brandName" value="${p.brandName}" required placeholder="ì˜ˆ: ë¡œì§€ì˜¤ê°€ë‹‰" list="pf-brand-list"><datalist id="pf-brand-list">${brands.map(b => `<option value="${b.name}">`).join('')}</datalist></div>
        <div class="form-group"><label class="form-label">ìƒí’ˆëª… *</label><input type="text" class="form-input" id="pf-productName" value="${p.productName}" required placeholder="ì˜ˆ: ì§œë¨¹ëŠ” ì•„ë„¬ë¼HOP ì‹œì‘ê³¼ì¼ 14íŒ©"></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ì†Œë¹„ì ì •ê°€</label><input type="number" class="form-input" id="pf-retailPrice" value="${p.retailPrice}" placeholder="64400"></div>
          <div class="form-group"><label class="form-label">ê³µë™êµ¬ë§¤ íŒë§¤ê°€ *</label><input type="number" class="form-input" id="pf-salePrice" value="${p.salePrice}" required placeholder="34000"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê³µê¸‰ë‹¨ê°€ (V+) *</label><input type="number" class="form-input" id="pf-supplyPrice" value="${p.supplyPrice}" required placeholder="27200" style="background: var(--gray-50);"></div>
          <div class="form-group"><label class="form-label">ë°°ì†¡ë£Œ (ê±´ë‹¹)</label><input type="number" class="form-input" id="pf-shippingFee" value="${p.shippingFee || ''}" placeholder="3000" style="background: var(--gray-50);"></div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('productAddModal').remove()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(editorModal);
}

async function submitSupplierProductForm(e, id) {
  e.preventDefault();
  const data = {
    brandName: document.getElementById('pf-brandName').value.trim(),
    productName: document.getElementById('pf-productName').value.trim(),
    retailPrice: Number(document.getElementById('pf-retailPrice').value) || 0,
    salePrice: Number(document.getElementById('pf-salePrice').value) || 0,
    supplyPrice: Number(document.getElementById('pf-supplyPrice').value) || 0,
    shippingFee: Number(document.getElementById('pf-shippingFee').value) || 0,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (id) {
      await db.collection('supplierProducts').doc(id).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('supplierProducts').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    document.getElementById('productAddModal')?.remove();
    setTimeout(() => openSupplierProductModal(), 300);
  } catch(err) { showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

function editSupplierProduct(id) {
  const product = state.supplierProducts.find(p => p.id === id);
  if (product) {
    closeModal();
    setTimeout(() => openProductAddModal(product), 100);
  }
}

async function deleteSupplierProduct(id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  // âš ï¸ ì‚­ì œ ê¸°ëŠ¥ ë¹„í™œì„±í™” - ë°ì´í„° ë³´í˜¸
  showToast('âš ï¸ ìƒí’ˆ ì‚­ì œ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
  return;
  
  /* ì‚­ì œ ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨
  const password = prompt('âš ï¸ ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
  if (password !== 'moyeora2025!') {
    showToast('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
    return;
  }
  if (!confirm('ì •ë§ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  try { 
    await db.collection('supplierProducts').doc(id).delete(); 
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); 
    setTimeout(() => openSupplierProductModal(), 300); 
  } catch(err) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
  */
}

// ì—‘ì…€ ì¼ê´„ë“±ë¡ ëª¨ë‹¬
function openProductBulkImportModal() {
  const editorModal = document.createElement('div');
  editorModal.id = 'bulkImportModal';
  editorModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  editorModal.innerHTML = `
    <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow: hidden;">
      <div style="padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">ğŸ“¥ ì—‘ì…€ ì¼ê´„ë“±ë¡</h3>
        <button onclick="document.getElementById('bulkImportModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="background: var(--info-light); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--info);">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì•ˆë‚´</h4>
          <p style="margin: 0; font-size: 13px; color: var(--gray-600);">ì•„ë˜ ì—´ ìˆœì„œëŒ€ë¡œ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:</p>
          <ol style="margin: 8px 0 0 0; padding-left: 20px; font-size: 12px; color: var(--gray-600);">
            <li>ê³µê¸‰ì‚¬(ë¸Œëœë“œ)</li>
            <li>ìƒí’ˆëª…</li>
            <li>ì†Œë¹„ìì •ê°€</li>
            <li>ê³µë™êµ¬ë§¤íŒë§¤ê°€</li>
            <li>ê³µê¸‰ë‹¨ê°€(V+)</li>
          </ol>
        </div>
        
        <div style="border: 2px dashed var(--gray-300); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 16px;" id="dropZone">
          <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“‚</div>
          <p style="margin: 0 0 12px 0; color: var(--gray-600);">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
          <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleExcelUpload(this)">
          <button type="button" class="btn btn-primary" onclick="document.getElementById('excelFileInput').click()">íŒŒì¼ ì„ íƒ</button>
        </div>
        
        <div id="importPreview" style="display: none; max-height: 300px; overflow: auto;"></div>
        
        <div style="display: flex; justify-content: flex-end; gap: 8px;">
          <button type="button" class="btn btn-secondary" onclick="downloadProductTemplate()">ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('bulkImportModal').remove()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="importBtn" style="display: none;" onclick="executeImport()">ì¼ê´„ ë“±ë¡</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(editorModal);
  
  const dropZone = editorModal.querySelector('#dropZone');
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; });
  dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = 'var(--gray-300)'; });
  dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--gray-300)'; if (e.dataTransfer.files.length) handleExcelUpload({ files: e.dataTransfer.files }); });
}

let importData = [];

async function handleExcelUpload(input) {
  const file = input.files[0];
  if (!file) return;
  
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    await new Promise(resolve => script.onload = resolve);
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      
      importData = [];
      for (let i = 1; i < json.length; i++) {
        const row = json[i];
        if (row[0] && row[1]) {
          importData.push({
            brandName: String(row[0] || '').trim(),
            productName: String(row[1] || '').trim(),
            retailPrice: Number(row[2]) || 0,
            salePrice: Number(row[3]) || 0,
            supplyPrice: Number(row[4]) || 0
          });
        }
      }
      
      const preview = document.getElementById('importPreview');
      preview.style.display = 'block';
      preview.innerHTML = `
        <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ“‹ ${importData.length}ê°œ ìƒí’ˆ ë¯¸ë¦¬ë³´ê¸°</p>
        <div style="overflow-x: auto;">
        <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
          <thead><tr style="background: var(--gray-200);"><th style="padding: 4px;">ë¸Œëœë“œ</th><th style="padding: 4px;">ìƒí’ˆëª…</th><th style="padding: 4px;">ì •ê°€</th><th style="padding: 4px;">íŒë§¤ê°€</th><th style="padding: 4px; background: var(--gray-50);">ê³µê¸‰ê°€</th><th style="padding: 4px; color: var(--danger);">ì •ê°€í• ì¸ìœ¨</th><th style="padding: 4px;">ì´ë§ˆì§„ìœ¨</th><th style="padding: 4px;">ì´ë§ˆì§„ê¸ˆ</th></tr></thead>
          <tbody>${importData.slice(0, 10).map(d => {
            const discountRate = d.retailPrice > 0 ? ((d.retailPrice - d.salePrice) / d.retailPrice * 100).toFixed(1) : 0;
            const totalMargin = d.salePrice - d.supplyPrice;
            const totalMarginRate = d.salePrice > 0 ? (totalMargin / d.salePrice * 100).toFixed(1) : 0;
            return `<tr><td style="padding: 4px;">${d.brandName}</td><td style="padding: 4px;">${d.productName}</td><td style="padding: 4px; text-align: right;">${d.retailPrice.toLocaleString()}</td><td style="padding: 4px; text-align: right;">${d.salePrice.toLocaleString()}</td><td style="padding: 4px; text-align: right; background: #fefce8;">${d.supplyPrice.toLocaleString()}</td><td style="padding: 4px; text-align: right; color: var(--danger);">${discountRate}%</td><td style="padding: 4px; text-align: right;">${totalMarginRate}%</td><td style="padding: 4px; text-align: right; font-weight: 600;">${totalMargin.toLocaleString()}ì›</td></tr>`;
          }).join('')}</tbody>
        </table>
        </div>
        ${importData.length > 10 ? `<p style="text-align: center; color: var(--gray-500); font-size: 12px; margin-top: 8px;">... ì™¸ ${importData.length - 10}ê°œ</p>` : ''}
      `;
      
      document.getElementById('importBtn').style.display = 'inline-flex';
    } catch(err) { showToast('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ' + err.message); }
  };
  reader.readAsArrayBuffer(file);
}

async function executeImport() {
  if (importData.length === 0) { showToast('ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
  try {
    const batch = db.batch();
    importData.forEach(item => {
      const ref = db.collection('supplierProducts').doc();
      batch.set(ref, { ...item, createdAt: new Date().toISOString() });
    });
    await batch.commit();
    showToast(`${importData.length}ê°œ ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
    document.getElementById('bulkImportModal')?.remove();
    importData = [];
    setTimeout(() => openSupplierProductModal(), 300);
  } catch(err) { showToast('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message); }
}

function downloadProductTemplate() {
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    script.onload = () => createAndDownloadTemplate();
    return;
  }
  createAndDownloadTemplate();
}

function createAndDownloadTemplate() {
  // ì…ë ¥ í•­ëª©ë§Œ (ì •ê°€í• ì¸ìœ¨, ì´ë§ˆì§„ìœ¨, ì´ë§ˆì§„ê¸ˆì€ ë“±ë¡ í›„ ìë™ê³„ì‚°)
  const headers = ['ê³µê¸‰ì‚¬(ë¸Œëœë“œ)', 'ìƒí’ˆëª…', 'ì†Œë¹„ìì •ê°€', 'ê³µë™êµ¬ë§¤íŒë§¤ê°€', 'ê³µê¸‰ë‹¨ê°€(V+)'];
  const sampleData = [
    ['ë¡œì§€ì˜¤ê°€ë‹‰', 'ì§œë¨¹ëŠ” ì•„ë„¬ë¼HOP ì‹œì‘ê³¼ì¼ 14íŒ©', 64400, 34000, 27200],
    ['ë¡œì§€ì˜¤ê°€ë‹‰', 'ì§œë¨¹ëŠ” ì•„ë„¬ë¼HOP ì‹œì‘ê³¼ì¼ 28íŒ©', 138000, 65000, 52000],
    ['ê·¸ë¡œí™ˆ', 'ë¯¸ë„ëŸ¼ ë°©ì§€ ë¡¤ëŸ¬í˜ì¸íŠ¸ 1ê°œ', 29900, 24900, 19900]
  ];
  
  const ws = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
  ws['!cols'] = [{ wch: 15 }, { wch: 35 }, { wch: 12 }, { wch: 16 }, { wch: 14 }];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ìƒí’ˆë“±ë¡');
  XLSX.writeFile(wb, 'ê³µê¸‰ì‚¬ìƒí’ˆë“±ë¡_ì–‘ì‹.xlsx');
  showToast('ì–‘ì‹ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤');
}

function exportProductsToExcel() {
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    script.onload = () => doExportProducts();
    return;
  }
  doExportProducts();
}

function doExportProducts() {
  const products = state.supplierProducts || [];
  if (products.length === 0) { showToast('ë‚´ë³´ë‚¼ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤'); return; }
  
  const headers = ['ê³µê¸‰ì‚¬(ë¸Œëœë“œ)', 'ìƒí’ˆëª…', 'ì†Œë¹„ìì •ê°€', 'ê³µë™êµ¬ë§¤íŒë§¤ê°€', 'ê³µê¸‰ë‹¨ê°€(V+)', 'ì •ê°€í• ì¸ìœ¨', 'ì´ë§ˆì§„ìœ¨', 'ì´ë§ˆì§„ê¸ˆ'];
  const data = products.map(p => {
    const retailPrice = Number(p.retailPrice) || 0;
    const salePrice = Number(p.salePrice) || 0;
    const supplyPrice = Number(p.supplyPrice) || 0;
    const discountRate = retailPrice > 0 ? ((retailPrice - salePrice) / retailPrice * 100).toFixed(1) : 0;
    const totalMargin = salePrice - supplyPrice;
    const totalMarginRate = salePrice > 0 ? (totalMargin / salePrice * 100).toFixed(1) : 0;
    return [p.brandName, p.productName, retailPrice, salePrice, supplyPrice, discountRate + '%', totalMarginRate + '%', totalMargin];
  });
  
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  ws['!cols'] = [{ wch: 15 }, { wch: 35 }, { wch: 12 }, { wch: 16 }, { wch: 14 }, { wch: 10 }, { wch: 10 }, { wch: 12 }];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ê³µê¸‰ì‚¬ìƒí’ˆëª©ë¡');
  XLSX.writeFile(wb, `ê³µê¸‰ì‚¬ìƒí’ˆëª©ë¡_${formatDate(new Date())}.xlsx`);
  showToast('ìƒí’ˆ ëª©ë¡ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤');
}

// ========================================
// 2. ë§ˆì§„ ê³„ì‚°ê¸° (ë³„ë„ ë„êµ¬ - ì €ì¥ ì•ˆí•¨)
// ========================================
function openMarginCalculator() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const products = state.supplierProducts || [];
  const suppliers = state.suppliers || []; // ê³µê¸‰ì‚¬ DBì—ì„œ ê°€ì ¸ì˜´
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ§® ë§ˆì§„ ê³„ì‚°ê¸°</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <!-- ğŸ“– ì‚¬ìš©ì„¤ëª…ì„œ (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
      <div style="margin-bottom: 12px;">
        <button onclick="toggleCalcGuide()" id="calcGuideToggle" style="display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: #1e40af; width: 100%;">
          <span>ğŸ“–</span>
          <span>ì‚¬ìš©ì„¤ëª…ì„œ</span>
          <span id="calcGuideArrow" style="margin-left: auto; transition: transform 0.2s;">â–¼</span>
        </button>
        <div id="calcGuideContent" style="display: none; background: white; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; padding: 16px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <!-- ì…€ëŸ¬ í˜‘ìƒìš© ê°€ì´ë“œ -->
            <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 10px; padding: 14px; border: 1px solid #e9d5ff;">
              <div style="font-weight: 700; color: #7c3aed; margin-bottom: 10px; font-size: 13px;">ğŸ‘¤ ì…€ëŸ¬ í˜‘ìƒìš©</div>
              <div style="font-size: 11px; color: #4c1d95; line-height: 1.7;">
                <p style="margin: 0 0 8px 0;"><strong>ëª©ì :</strong> ì…€ëŸ¬ì™€ ë§ˆì§„ìœ¨ì„ í˜‘ì˜í•  ë•Œ ì‚¬ìš©</p>
                <p style="margin: 0 0 8px 0;"><strong>ì‚¬ìš©ë²•:</strong></p>
                <ol style="margin: 0; padding-left: 16px;">
                  <li>ìƒí’ˆ DBì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ë˜ëŠ” ì§ì ‘ ì…ë ¥</li>
                  <li>ì…€ëŸ¬ ë§ˆì§„ìœ¨(%) ì¡°ì •í•˜ë©° ì‹œë®¬ë ˆì´ì…˜</li>
                  <li>ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰, ì´ë²¤íŠ¸ë¹„ìš© ì…ë ¥</li>
                  <li>ëª¨ì—¬ë¼ë”œ ìˆœë§ˆì§„ í™•ì¸ í›„ í˜‘ìƒ</li>
                  <li>"ì…€ëŸ¬ ì œì•ˆì„œì— ì¶”ê°€" â†’ PDF ë‹¤ìš´ë¡œë“œ</li>
                </ol>
                <p style="margin: 8px 0 0 0; padding: 6px 8px; background: white; border-radius: 4px; border-left: 3px solid #8b5cf6;">
                  ğŸ’¡ 500ê°œ ì´ìƒ íŒë§¤ ì‹œ ë³´ë„ˆìŠ¤ ë§ˆì§„ ìë™ ì ìš©!
                </p>
              </div>
            </div>
            <!-- ê³µê¸‰ì‚¬ í˜‘ìƒìš© ê°€ì´ë“œ -->
            <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 10px; padding: 14px; border: 1px solid #86efac;">
              <div style="font-weight: 700; color: #059669; margin-bottom: 10px; font-size: 13px;">ğŸ­ ê³µê¸‰ì‚¬ í˜‘ìƒìš©</div>
              <div style="font-size: 11px; color: #14532d; line-height: 1.7;">
                <p style="margin: 0 0 8px 0;"><strong>ëª©ì :</strong> ê³µê¸‰ì‚¬ì™€ ê³µê¸‰ë‹¨ê°€ë¥¼ í˜‘ì˜í•  ë•Œ ì‚¬ìš©</p>
                <p style="margin: 0 0 8px 0;"><strong>ì‚¬ìš©ë²•:</strong></p>
                <ol style="margin: 0; padding-left: 16px;">
                  <li>ê³µê¸‰ì‚¬/ìƒí’ˆëª…/ê³µê¸‰ë‹¨ê°€/íŒë§¤ê°€ ì…ë ¥</li>
                  <li>ì…€ëŸ¬ ë§ˆì§„ìœ¨ ì„¤ì • (ì „ì—­ ì ìš© ê°€ëŠ¥)</li>
                  <li>ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰, ì´ë²¤íŠ¸ë¹„ìš© ì…ë ¥</li>
                  <li>"ê³„ì‚°" í´ë¦­ â†’ ìˆ˜ìµì„± íŒì • í™•ì¸</li>
                  <li>PDF ë‹¤ìš´ë¡œë“œ í›„ ê³µê¸‰ì‚¬ì— ê³µìœ </li>
                </ol>
                <p style="margin: 8px 0 0 0; padding: 6px 8px; background: white; border-radius: 4px; border-left: 3px solid #10b981;">
                  ğŸ’¡ ê±´ë‹¹ ìˆœë§ˆì§„ 2,000ì›â†‘ ëª©í‘œ (500ê°œâ†‘ ì‹œ 1,000ì›â†‘)
                </p>
              </div>
            </div>
          </div>
          <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-radius: 6px; display: flex; gap: 16px; flex-wrap: wrap; font-size: 10px; color: #92400e;">
            <span>ğŸ“¦ <strong>ë³´ë„ˆìŠ¤ ë§ˆì§„:</strong> 500ê°œë‹¹ +1%</span>
            <span>ğŸ’³ <strong>PGìˆ˜ìˆ˜ë£Œ:</strong> íŒë§¤ê°€ì˜ 4%</span>
            <span>ğŸ’° <strong>ì •ì‚°:</strong> ê³µêµ¬ ì¢…ë£Œ í›„ 3~7ì¼</span>
            <span>ğŸ“‹ <strong>ì›ì²œì§•ìˆ˜:</strong> ì…€ëŸ¬ ë§ˆì§„ì˜ 3.3%</span>
          </div>
        </div>
      </div>
      
      <!-- íƒ­ ë©”ë‰´ -->
      <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid var(--gray-200); padding-bottom: 12px;">
        <button id="calcTabSeller" onclick="switchCalcTab('seller')" style="padding: 10px 20px; font-size: 14px; font-weight: 600; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
          ğŸ‘¤ ì…€ëŸ¬ í˜‘ìƒìš©
        </button>
        <button id="calcTabSupplier" onclick="switchCalcTab('supplier')" style="padding: 10px 20px; font-size: 14px; font-weight: 600; background: var(--gray-100); color: var(--gray-600); border: none; border-radius: 8px; cursor: pointer;">
          ğŸ­ ê³µê¸‰ì‚¬ í˜‘ìƒìš©
        </button>
      </div>
      
      <!-- ì…€ëŸ¬ í˜‘ìƒìš© íƒ­ -->
      <div id="calcSellerTab" style="flex: 1; overflow: auto; display: flex; flex-direction: column;">
        <p style="color: var(--gray-600); font-size: 13px; margin-bottom: 16px;">
          <strong>ğŸ“Œ ì…€ëŸ¬ í˜‘ìƒìš©</strong> | ìƒí’ˆ ì„ íƒ í›„ <strong>ì…€ëŸ¬ ë§ˆì§„ìœ¨</strong>ì„ ì¡°ì •í•˜ë©° í˜‘ìƒí•˜ì„¸ìš”.
        </p>
        
        <!-- ğŸ¯ ëª©í‘œ ì•ˆë‚´ í†µí•© -->
        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #fcd34d;">
          <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
            <div style="font-weight: 700; color: #92400e; font-size: 14px;">ğŸ¯ ëª©í‘œ ê¸°ì¤€</div>
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 14px; border-radius: 8px; border: 2px solid #f59e0b;">
                <span style="font-size: 13px; color: #92400e;">ğŸ“¦ ê±´ë‹¹ íŒë§¤ìˆ˜ëŸ‰</span>
                <span style="font-weight: 700; color: #d97706; font-size: 15px;">200~300ê°œ</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 14px; border-radius: 8px; border: 2px solid #dc2626;">
                <span style="font-size: 13px; color: #92400e;">ğŸ’° ê±´ë‹¹ ë§ˆì§„</span>
                <span style="font-weight: 700; color: #dc2626; font-size: 15px;">2,000ì› ì´ìƒ</span>
              </div>
            </div>
            <div style="font-size: 11px; color: #b45309;">âš ï¸ ë§ˆì§„ 2,000ì› ë¯¸ë§Œ ì‹œ ë¹¨ê°„ìƒ‰ ê²½ê³ </div>
          </div>
        </div>
        
        <!-- ìƒí’ˆ ê²€ìƒ‰ ì˜ì—­ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ” ìƒí’ˆ ê²€ìƒ‰</div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
            <select id="calcBrandFilter" class="form-input" style="width: 180px;" onchange="filterCalcProducts()">
              <option value="">ì „ì²´ ê³µê¸‰ì‚¬(ë¸Œëœë“œ)</option>
              ${suppliers.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
            </select>
            <input type="text" id="calcProductSearch" class="form-input" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." style="width: 200px;" oninput="filterCalcProducts()">
            <button class="btn btn-primary btn-sm" onclick="addSelectedCalcProducts()">âœ… ì„ íƒ ìƒí’ˆ ì¶”ê°€</button>
            <span style="margin-left: auto; font-size: 12px; color: var(--gray-500);">ì„ íƒë¨: <strong id="calcSelectedCount">0</strong>ê°œ</span>
          </div>
          <div style="max-height: 150px; overflow-y: auto; margin-top: 12px; border: 1px solid var(--gray-200); border-radius: 8px;" id="calcProductList">
            <table class="data-table" style="font-size: 12px; margin: 0;">
              <thead style="position: sticky; top: 0; background: var(--gray-100);">
                <tr>
                  <th style="width: 30px;"><input type="checkbox" id="calcSelectAll" onchange="toggleCalcSelectAll(this)"></th>
                  <th>ê³µê¸‰ì‚¬(ë¸Œëœë“œ)</th>
                  <th>ìƒí’ˆëª…</th>
                  <th style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                  <th style="text-align: right;">ê³µê¸‰ë‹¨ê°€</th>
                  <th style="text-align: right;">ì´ë§ˆì§„</th>
                </tr>
              </thead>
              <tbody id="calcProductBody">
                ${products.map(p => {
                  const totalMargin = (Number(p.salePrice)||0) - (Number(p.supplyPrice)||0);
                  return `
                  <tr data-brand="${p.brandName}" data-name="${p.productName}">
                    <td><input type="checkbox" class="calc-product-check" data-id="${p.id}"></td>
                    <td><span class="status-badge status-confirmed" style="font-size:11px;">${p.brandName||'-'}</span></td>
                    <td style="font-weight:500;">${p.productName||'-'}</td>
                    <td style="text-align:right;">${Number(p.salePrice||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;">${Number(p.supplyPrice||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;font-weight:600;color:${totalMargin>=0?'var(--success)':'var(--danger)'};">${totalMargin.toLocaleString()}ì›</td>
                  </tr>
                `}).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- ì˜ˆìƒ ê³µêµ¬ ë§¤ì¶œì•¡ -->
        <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 2px solid #10b981;">
          <div style="font-weight: 700; color: #047857; margin-bottom: 16px; font-size: 15px;">ğŸ“Š ì˜ˆìƒ ê³µêµ¬ ë§¤ì¶œì•¡</div>
          
          <!-- ì…ë ¥ ì˜ì—­ -->
          <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 13px; color: #065f46;">ğŸ“¦ ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰</span>
              <input type="number" id="calcExpectedQty" class="form-input" value="250" min="1" style="width: 100px; text-align: right;" oninput="updateCalcTotals()">
              <span style="color: #065f46;">ê°œ</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; background: #dbeafe; padding: 8px 12px; border-radius: 8px; border: 2px solid #3b82f6;">
              <span style="font-size: 13px; color: #1d4ed8; font-weight: 600;">ğŸ‘¤ ì…€ëŸ¬ ë§ˆì§„ìœ¨</span>
              <input type="number" id="calcSellerRateGlobal" class="form-input" value="20" min="0" max="50" step="1" style="width: 70px; text-align: right; border-color: #3b82f6;" oninput="applyGlobalSellerRate()">
              <span style="color: #1d4ed8; font-weight: 600;">%</span>
              <button type="button" class="btn btn-sm" style="background: #3b82f6; color: white; padding: 4px 8px; font-size: 11px;" onclick="applyGlobalSellerRate()">ì¼ê´„ì ìš©</button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 13px; color: #065f46;">ğŸ ì´ë²¤íŠ¸ë¹„ìš©</span>
              <input type="number" id="calcEventCost" class="form-input" value="0" min="0" style="width: 120px; text-align: right;" oninput="updateCalcTotals()">
              <span style="color: #065f46;">ì›</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 13px; color: #065f46;">ğŸ’³ PGìˆ˜ìˆ˜ë£Œ</span>
              <input type="number" id="calcPgFeeRate" class="form-input" value="4" min="0" max="10" step="0.1" style="width: 70px; text-align: right;" oninput="updateCalcTotals()">
              <span style="color: #065f46;">%</span>
            </div>
          </div>
          
          <!-- ê²°ê³¼ í‘œì‹œ -->
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: var(--gray-500);">ì˜ˆìƒ ë§¤ì¶œì•¡</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--primary);" id="calcExpectedSales">0ì›</div>
            </div>
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #3b82f6;">ì…€ëŸ¬ ë§ˆì§„</div>
              <div style="font-size: 18px; font-weight: 700; color: #3b82f6;" id="calcExpectedSellerMargin">0ì›</div>
            </div>
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #f59e0b;">PGìˆ˜ìˆ˜ë£Œ</div>
              <div style="font-size: 18px; font-weight: 700; color: #f59e0b;" id="calcExpectedPgFee">0ì›</div>
            </div>
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #8b5cf6;">ì´ë²¤íŠ¸ë¹„ìš©</div>
              <div style="font-size: 18px; font-weight: 700; color: #8b5cf6;" id="calcExpectedEventCost">0ì›</div>
            </div>
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: var(--gray-500);">ì´ ë¹„ìš©</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--danger);" id="calcExpectedTotalCost">0ì›</div>
            </div>
            <div style="text-align: center; background: linear-gradient(135deg, #22c55e, #16a34a); padding: 12px; border-radius: 10px; box-shadow: 0 2px 6px rgba(34,197,94,0.3);">
              <div style="font-size: 11px; color: rgba(255,255,255,0.9);">ğŸ¯ ìµœì¢… ìˆœë§ˆì§„</div>
              <div style="font-size: 20px; font-weight: 800; color: white;" id="calcExpectedProfit">0ì›</div>
            </div>
          </div>
          
          <!-- ìˆœë§ˆì§„ íŒì • -->
          <div id="calcProfitVerdict" style="margin-top: 12px; padding: 12px; border-radius: 8px; display: none;"></div>
        </div>
        
        <!-- ê³„ì‚° í…Œì´ë¸” -->
        <div style="flex: 1; overflow: auto;">
          <table class="data-table" style="font-size: 12px; min-width: 900px;" id="calcTable">
            <thead>
              <tr style="background: var(--gray-100);">
                <th style="width: 30px;">No</th>
                <th style="min-width: 100px;">ê³µê¸‰ì‚¬</th>
                <th style="min-width: 150px;">ìƒí’ˆëª…</th>
                <th style="width: 90px; text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                <th style="width: 90px; text-align: right;">ê³µê¸‰ë‹¨ê°€</th>
                <th style="width: 80px; text-align: right;">ì´ë§ˆì§„</th>
                <th style="width: 80px; text-align: center; background: #dbeafe;">ì…€ëŸ¬ë§ˆì§„ìœ¨</th>
                <th style="width: 90px; text-align: right; background: #dbeafe;">ì…€ëŸ¬ë§ˆì§„ê¸ˆ</th>
                <th style="width: 80px; text-align: center; background: #dcfce7;">ëª¨ì—¬ë¼ë”œ%</th>
                <th style="width: 90px; text-align: right; background: #dcfce7;">ëª¨ì—¬ë¼ë”œë§ˆì§„</th>
                <th style="width: 40px;"></th>
              </tr>
            </thead>
            <tbody id="calcBody">
            </tbody>
          </table>
          <div id="calcEmptyState" style="text-align: center; padding: 40px; color: var(--gray-500);">
            <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“¦</div>
            <div>ìœ„ì—ì„œ ìƒí’ˆì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</div>
          </div>
        </div>
        
        <!-- í•©ê³„ ì˜ì—­ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-top: 16px;">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
            <div><div style="font-size: 11px; color: var(--gray-500);">ì´ íŒë§¤ê¸ˆì•¡ (1ê°œë‹¹)</div><div style="font-size: 18px; font-weight: 700;" id="calcTotalSales">0ì›</div></div>
            <div><div style="font-size: 11px; color: var(--gray-500);">ì´ ë§ˆì§„ê¸ˆ (1ê°œë‹¹)</div><div style="font-size: 18px; font-weight: 700;" id="calcTotalMargin">0ì›</div></div>
            <div style="background: #dbeafe; border-radius: 8px; padding: 8px;"><div style="font-size: 11px; color: var(--info);">ì…€ëŸ¬ ë§ˆì§„ í•©ê³„ (1ê°œë‹¹)</div><div style="font-size: 18px; font-weight: 700; color: var(--info);" id="calcTotalSeller">0ì›</div></div>
            <div style="background: #dcfce7; border-radius: 8px; padding: 8px;"><div style="font-size: 11px; color: var(--success);">ëª¨ì—¬ë¼ë”œ ë§ˆì§„ í•©ê³„ (1ê°œë‹¹)</div><div style="font-size: 18px; font-weight: 700; color: var(--success);" id="calcTotalMoyeora">0ì›</div></div>
          </div>
        </div>
        
        <!-- ì…€ëŸ¬ ì œì•ˆì„œì— ì¶”ê°€ ë²„íŠ¼ -->
        <div style="margin-top: 16px; text-align: center;">
          <button type="button" class="btn btn-primary" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); padding: 12px 32px; font-size: 15px;" onclick="addToSellerProposal()">
            ğŸ“‹ ì…€ëŸ¬ ì œì•ˆì„œì— ì¶”ê°€
          </button>
        </div>
        
        <!-- ì…€ëŸ¬ ì œì•ˆì„œ ëˆ„ì  í…Œì´ë¸” -->
        <div id="sellerProposalSection" style="margin-top: 24px; display: none;">
          <div style="background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 12px 12px 0 0; padding: 16px 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="color: white; font-weight: 700; font-size: 16px;">ğŸ“‹ ì…€ëŸ¬ ì œì•ˆì„œ</div>
              <button class="btn btn-sm" style="background: white; color: #6366f1; font-weight: 600;" onclick="exportSellerProposalToPdf()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
          <div style="background: white; border: 2px solid #8b5cf6; border-top: none; border-radius: 0 0 12px 12px; overflow: hidden;">
            <table class="data-table" style="font-size: 12px; margin: 0;" id="sellerProposalTable">
              <thead>
                <tr style="background: #f5f3ff;">
                  <th style="padding: 10px;">ê³µê¸‰ì‚¬</th>
                  <th style="padding: 10px;">ìƒí’ˆëª…</th>
                  <th style="padding: 10px; text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                  <th style="padding: 10px; text-align: center; background: #dbeafe;">ê°œë‹¹ ë§ˆì§„ê¸ˆ</th>
                  <th style="padding: 10px; text-align: center; background: #dcfce7;">ë³´ë„ˆìŠ¤</th>
                  <th style="padding: 10px; text-align: right;">ì˜ˆìƒìˆ˜ëŸ‰</th>
                  <th style="padding: 10px; text-align: right; background: #dbeafe;">ì…€ëŸ¬ë§ˆì§„(ì´)</th>
                  <th style="padding: 10px; text-align: right; background: #dcfce7;">ëª¨ì—¬ë¼ë”œìˆœë§ˆì§„</th>
                  <th style="padding: 10px; text-align: center;">íŒì •</th>
                  <th style="padding: 10px; width: 40px;"></th>
                </tr>
              </thead>
              <tbody id="sellerProposalBody">
              </tbody>
            </table>
            <div id="sellerProposalEmpty" style="text-align: center; padding: 30px; color: var(--gray-500); display: none;">
              <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“‹</div>
              <div>ìœ„ì—ì„œ ìƒí’ˆì„ ì¶”ê°€í•˜ê³  "ì…€ëŸ¬ ì œì•ˆì„œì— ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ê³µê¸‰ì‚¬ í˜‘ìƒìš© íƒ­ -->
      <div id="calcSupplierTab" style="flex: 1; overflow: auto; display: none; flex-direction: column;">
        <p style="color: var(--gray-600); font-size: 13px; margin-bottom: 16px;">
          <strong>ğŸ“Œ ê³µê¸‰ì‚¬ í˜‘ìƒìš©</strong> | ê³µê¸‰ì‚¬ê°€ ì œì•ˆí•œ ì¡°ê±´ìœ¼ë¡œ ìˆ˜ìµì„±ì„ ê²€í† í•˜ì„¸ìš”.
        </p>
        
        <!-- ğŸ¯ ëª©í‘œ ì•ˆë‚´ í†µí•© -->
        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #fcd34d;">
          <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
            <div style="font-weight: 700; color: #92400e; font-size: 14px;">ğŸ¯ ëª©í‘œ ê¸°ì¤€</div>
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 14px; border-radius: 8px; border: 2px solid #f59e0b;">
                <span style="font-size: 13px; color: #92400e;">ğŸ“¦ ê±´ë‹¹ íŒë§¤ìˆ˜ëŸ‰</span>
                <span style="font-weight: 700; color: #d97706; font-size: 15px;">200~300ê°œ</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 14px; border-radius: 8px; border: 2px solid #dc2626;">
                <span style="font-size: 13px; color: #92400e;">ğŸ’° ê±´ë‹¹ ë§ˆì§„</span>
                <span style="font-weight: 700; color: #dc2626; font-size: 15px;">2,000ì› ì´ìƒ</span>
              </div>
            </div>
            <div style="font-size: 11px; color: #b45309;">âš ï¸ ë§ˆì§„ ë¯¸ë‹¬ ì‹œ ê³µê¸‰ë‹¨ê°€ ì¸í•˜ ë˜ëŠ” ì…€ëŸ¬ë§ˆì§„ ì¡°ì • ìš”ì²­</div>
          </div>
        </div>
        
        <!-- ì§ì ‘ ì…ë ¥ ê³„ì‚°ê¸° -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 16px;">ğŸ“ ê³µê¸‰ì‚¬ ì œì•ˆ ì¡°ê±´ ì…ë ¥</div>
          
          <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ê³µê¸‰ì‚¬ ì„ íƒ</label>
              <select id="supCalcSupplier" class="form-input" style="width: 100%;">
                <option value="">ì§ì ‘ ì…ë ¥</option>
                ${suppliers.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
              </select>
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ìƒí’ˆëª…</label>
              <input type="text" id="supCalcProductName" class="form-input" placeholder="ìƒí’ˆëª… ì…ë ¥" style="width: 100%;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ì†Œë¹„ìê°€ (ì›)</label>
              <input type="number" id="supCalcRetailPrice" class="form-input" placeholder="ì˜ˆ: 50000" style="width: 100%;" oninput="calcSupplierMargin()">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ê³µêµ¬íŒë§¤ê°€ (ì›)</label>
              <input type="number" id="supCalcSalePrice" class="form-input" placeholder="ì˜ˆ: 39000" style="width: 100%;" oninput="calcSupplierMargin()">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ê³µê¸‰ë‹¨ê°€ (ì›)</label>
              <input type="number" id="supCalcSupplyPrice" class="form-input" placeholder="ê³µê¸‰ì‚¬ ì œì•ˆ ë‹¨ê°€" style="width: 100%;" oninput="calcSupplierMargin()">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ê³µê¸‰ì‚¬ ìš”ì²­ ì…€ëŸ¬ë§ˆì§„ìœ¨ (%)</label>
              <input type="number" id="supCalcSellerRate" class="form-input" placeholder="ì˜ˆ: 20" style="width: 100%;" value="20" oninput="calcSupplierMargin()">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px; display: block;">ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰</label>
              <input type="number" id="supCalcQty" class="form-input" placeholder="ì˜ˆ: 250" style="width: 100%;" value="250" oninput="calcSupplierMargin()">
            </div>
          </div>
          
          <button class="btn btn-primary" style="margin-top: 16px; width: 100%;" onclick="addSupplierCalcRow()">â• ê³„ì‚° ê²°ê³¼ì— ì¶”ê°€</button>
        </div>
        
        <!-- ì˜ˆìƒ ê³µêµ¬ ë§¤ì¶œì•¡ (ì…€ëŸ¬ìš©ê³¼ ë™ì¼í•œ êµ¬ì¡°) -->
        <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 2px solid #10b981;">
          <div style="font-weight: 700; color: #047857; margin-bottom: 16px; font-size: 15px;">ğŸ“Š ì˜ˆìƒ ê³µêµ¬ ë§¤ì¶œì•¡</div>
          
          <!-- ì…ë ¥ ì˜ì—­ -->
          <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 13px; color: #065f46;">ğŸ“¦ ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰</span>
              <input type="number" id="supCalcQtyDisplay" class="form-input" value="250" min="1" style="width: 100px; text-align: right;" oninput="document.getElementById('supCalcQty').value=this.value; calcSupplierMargin()">
              <span style="color: #065f46;">ê°œ</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 13px; color: #065f46;">ğŸ ì´ë²¤íŠ¸ë¹„ìš©</span>
              <input type="number" id="supCalcEventCost" class="form-input" value="0" min="0" style="width: 120px; text-align: right;" oninput="calcSupplierMargin()">
              <span style="color: #065f46;">ì›</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 13px; color: #065f46;">ğŸ’³ PGìˆ˜ìˆ˜ë£Œ</span>
              <span style="font-weight: 700; color: #059669; font-size: 15px; background: white; padding: 6px 12px; border-radius: 6px;">4%</span>
              <span style="font-size: 11px; color: #6b7280;">(ìë™ê³„ì‚°)</span>
            </div>
          </div>
          
          <!-- ê²°ê³¼ í‘œì‹œ -->
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: var(--gray-500);">ì˜ˆìƒ ë§¤ì¶œì•¡</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--primary);" id="supExpectedSalesTotal">0ì›</div>
            </div>
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #3b82f6;">ì…€ëŸ¬ ë§ˆì§„</div>
              <div style="font-size: 18px; font-weight: 700; color: #3b82f6;" id="supExpectedSellerMargin">0ì›</div>
            </div>
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #f59e0b;">PGìˆ˜ìˆ˜ë£Œ (4%)</div>
              <div style="font-size: 18px; font-weight: 700; color: #f59e0b;" id="supExpectedPgFee">0ì›</div>
            </div>
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #8b5cf6;">ì´ë²¤íŠ¸ë¹„ìš©</div>
              <div style="font-size: 18px; font-weight: 700; color: #8b5cf6;" id="supExpectedEventCost">0ì›</div>
            </div>
            <div style="text-align: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: var(--gray-500);">ì´ ë¹„ìš©</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--danger);" id="supExpectedTotalCost">0ì›</div>
            </div>
            <div style="text-align: center; background: linear-gradient(135deg, #22c55e, #16a34a); padding: 12px; border-radius: 10px; box-shadow: 0 2px 6px rgba(34,197,94,0.3);">
              <div style="font-size: 11px; color: rgba(255,255,255,0.9);">ğŸ¯ ìµœì¢… ìˆœë§ˆì§„</div>
              <div style="font-size: 20px; font-weight: 800; color: white;" id="supExpectedFinalProfit">0ì›</div>
            </div>
          </div>
          
          <!-- ìˆœë§ˆì§„ íŒì • -->
          <div id="supProfitVerdict" style="margin-top: 12px; padding: 12px; border-radius: 8px; display: none;"></div>
        </div>
        
        <!-- ëˆ„ì  ê³„ì‚° í…Œì´ë¸” -->
        <div style="flex: 1; overflow: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-weight: 600; color: var(--gray-700);">ğŸ“‹ í˜‘ìƒ ê²€í†  ë‚´ì—­</div>
            <button class="btn btn-sm" style="background: #059669; color: white;" onclick="exportSupplierCalcToPdf()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
          </div>
          <table class="data-table" style="font-size: 12px;" id="supCalcTable">
            <thead>
              <tr style="background: var(--gray-100);">
                <th>ê³µê¸‰ì‚¬</th>
                <th>ìƒí’ˆëª…</th>
                <th style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                <th style="text-align: right;">ê³µê¸‰ë‹¨ê°€</th>
                <th style="text-align: center;">ì…€ëŸ¬ë§ˆì§„ìœ¨</th>
                <th style="text-align: right;">ì…€ëŸ¬ë§ˆì§„ê¸ˆ</th>
                <th style="text-align: right; background: #dcfce7;">ëª¨ì—¬ë¼ë”œë§ˆì§„</th>
                <th style="text-align: right;">ì˜ˆìƒìˆ˜ëŸ‰</th>
                <th style="text-align: right;">ì´ë²¤íŠ¸ë¹„ìš©</th>
                <th style="text-align: right;">PGìˆ˜ìˆ˜ë£Œ</th>
                <th style="text-align: right; background: #dcfce7;">ìµœì¢…ìˆœë§ˆì§„</th>
                <th style="text-align: center;">íŒì •</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="supCalcBody">
            </tbody>
          </table>
          <div id="supCalcEmpty" style="text-align: center; padding: 30px; color: var(--gray-500);">
            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“</div>
            <div>ìœ„ì—ì„œ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì¶”ê°€í•˜ì„¸ìš”</div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="clearCalcRows()">ğŸ—‘ï¸ ëª¨ë‘ ì§€ìš°ê¸°</button>
        <button type="button" class="btn btn-primary" onclick="exportCalcToExcel()">ğŸ“¤ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// íƒ­ ì „í™˜
function switchCalcTab(tab) {
  const sellerTab = document.getElementById('calcSellerTab');
  const supplierTab = document.getElementById('calcSupplierTab');
  const sellerBtn = document.getElementById('calcTabSeller');
  const supplierBtn = document.getElementById('calcTabSupplier');
  
  if (tab === 'seller') {
    sellerTab.style.display = 'flex';
    supplierTab.style.display = 'none';
    sellerBtn.style.background = 'var(--primary)';
    sellerBtn.style.color = 'white';
    supplierBtn.style.background = 'var(--gray-100)';
    supplierBtn.style.color = 'var(--gray-600)';
  } else {
    sellerTab.style.display = 'none';
    supplierTab.style.display = 'flex';
    sellerBtn.style.background = 'var(--gray-100)';
    sellerBtn.style.color = 'var(--gray-600)';
    supplierBtn.style.background = 'var(--primary)';
    supplierBtn.style.color = 'white';
  }
}

// ê³µê¸‰ì‚¬ í˜‘ìƒìš© ì‹¤ì‹œê°„ ê³„ì‚°
function calcSupplierMargin() {
  const salePrice = Number(document.getElementById('supCalcSalePrice').value) || 0;
  const supplyPrice = Number(document.getElementById('supCalcSupplyPrice').value) || 0;
  const sellerRate = Number(document.getElementById('supCalcSellerRate').value) || 0;
  const eventCost = Number(document.getElementById('supCalcEventCost').value) || 0;
  const qty = Number(document.getElementById('supCalcQty').value) || 250;
  
  // 1ê°œë‹¹ ê³„ì‚°
  const totalMargin = salePrice - supplyPrice;
  const sellerAmt = Math.round(salePrice * sellerRate / 100);
  const moyeoraMargin = totalMargin - sellerAmt; // 1ê°œë‹¹ ëª¨ì—¬ë¼ë”œ ë§ˆì§„ (ë¹„ìš© ì°¨ê° ì „)
  
  // ğŸ 500ê°œ ë‹¨ìœ„ ë³´ë„ˆìŠ¤ ë§ˆì§„ìœ¨ ê³„ì‚° (500ê°œë‹¹ 1%)
  const bonusRate = Math.floor(qty / 500);
  const bonusSellerMarginPerItem = salePrice > 0 ? Math.round(salePrice * bonusRate / 100) : 0;
  const totalBonusMargin = bonusSellerMarginPerItem * qty;
  
  // ì˜ˆìƒ ê³µêµ¬ ë§¤ì¶œì•¡ ê³„ì‚° (ì „ì²´) - ë³´ë„ˆìŠ¤ ë°˜ì˜
  const expectedSales = salePrice * qty;
  const baseSellerMargin = sellerAmt * qty;
  const expectedSellerMargin = baseSellerMargin + totalBonusMargin; // ë³´ë„ˆìŠ¤ í¬í•¨
  const expectedPgFee = Math.round(expectedSales * 0.04); // PGìˆ˜ìˆ˜ë£Œ 4%
  const expectedEventCost = eventCost;
  const expectedTotalCost = expectedSellerMargin + expectedPgFee + expectedEventCost;
  const expectedFinalProfit = (moyeoraMargin * qty) - totalBonusMargin - expectedPgFee - expectedEventCost;
  
  // ì˜ˆìƒ ê³µêµ¬ ë§¤ì¶œì•¡ ì„¹ì…˜ ì—…ë°ì´íŠ¸
  const supExpectedSalesTotal = document.getElementById('supExpectedSalesTotal');
  const supExpectedSellerMargin = document.getElementById('supExpectedSellerMargin');
  const supExpectedPgFee = document.getElementById('supExpectedPgFee');
  const supExpectedEventCost = document.getElementById('supExpectedEventCost');
  const supExpectedTotalCost = document.getElementById('supExpectedTotalCost');
  const supExpectedFinalProfit = document.getElementById('supExpectedFinalProfit');
  
  if (supExpectedSalesTotal) supExpectedSalesTotal.textContent = expectedSales.toLocaleString() + 'ì›';
  if (supExpectedSellerMargin) {
    if (bonusRate > 0) {
      supExpectedSellerMargin.innerHTML = `${expectedSellerMargin.toLocaleString()}ì›<br><span style="font-size:10px;color:#059669;">(+${bonusRate}% ë³´ë„ˆìŠ¤)</span>`;
    } else {
      supExpectedSellerMargin.textContent = expectedSellerMargin.toLocaleString() + 'ì›';
    }
  }
  if (supExpectedPgFee) supExpectedPgFee.textContent = expectedPgFee.toLocaleString() + 'ì›';
  if (supExpectedEventCost) supExpectedEventCost.textContent = expectedEventCost.toLocaleString() + 'ì›';
  if (supExpectedTotalCost) supExpectedTotalCost.textContent = expectedTotalCost.toLocaleString() + 'ì›';
  if (supExpectedFinalProfit) supExpectedFinalProfit.textContent = expectedFinalProfit.toLocaleString() + 'ì›';
  
  // ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰ ë™ê¸°í™”
  const qtyDisplay = document.getElementById('supCalcQtyDisplay');
  if (qtyDisplay && qtyDisplay.value != qty) {
    qtyDisplay.value = qty;
  }
  
  // ìˆœë§ˆì§„ íŒì • (ì˜ˆì™¸ ì¡°ê±´ ì ìš©)
  // 500ê°œ ì´ìƒ & ì´ë²¤íŠ¸ë¹„ìš© ìˆìŒ â†’ ê±´ë‹¹ 1,000ì› ê¸°ì¤€
  // ê·¸ ì™¸ â†’ ê±´ë‹¹ 2,000ì› ê¸°ì¤€
  const hasEventCost = eventCost > 0;
  const isHighVolume = qty >= 500;
  const profitThreshold = isHighVolume ? 1000 : 2000;
  
  const profitVerdict = document.getElementById('supProfitVerdict');
  if (profitVerdict && salePrice > 0 && supplyPrice > 0) {
    profitVerdict.style.display = 'block';
    const profitPerItem = qty > 0 ? Math.round(expectedFinalProfit / qty) : 0;
    
    // ì˜ˆì™¸ ì¡°ê±´ ì•ˆë‚´ í…ìŠ¤íŠ¸
    const thresholdNote = isHighVolume 
      ? `<span style="color: #6366f1; font-size: 11px;">(500ê°œ ì´ìƒ â†’ ê¸°ì¤€ 1,000ì›)</span>` 
      : '';
    
    if (expectedFinalProfit < 0) {
      profitVerdict.style.background = '#fef2f2';
      profitVerdict.style.border = '1px solid #fecaca';
      profitVerdict.innerHTML = `
        <div style="color: #dc2626; font-weight: 600;">âŒ ì ì ì˜ˆìƒ</div>
        <div style="color: #b91c1c; font-size: 13px; margin-top: 4px;">
          ìˆœë§ˆì§„ì´ ë§ˆì´ë„ˆìŠ¤ì…ë‹ˆë‹¤. ê³µê¸‰ë‹¨ê°€ ì¸í•˜ ë˜ëŠ” ì…€ëŸ¬ë§ˆì§„ ì¡°ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
      `;
    } else if (profitPerItem < profitThreshold) {
      profitVerdict.style.background = '#fffbeb';
      profitVerdict.style.border = '1px solid #fcd34d';
      profitVerdict.innerHTML = `
        <div style="color: #d97706; font-weight: 600;">âš ï¸ ìˆ˜ìµì„± ì ê²€ í•„ìš”</div>
        <div style="color: #92400e; font-size: 13px; margin-top: 4px;">
          ê±´ë‹¹ ìˆœë§ˆì§„ <strong>${profitPerItem.toLocaleString()}ì›</strong> (ëª©í‘œ: ${profitThreshold.toLocaleString()}ì› ì´ìƒ) ${thresholdNote}<br>
          ${bonusRate > 0 ? `<span style="color: #059669;">ğŸ“¦ ${qty}ê°œ íŒë§¤ â†’ ì…€ëŸ¬ ë³´ë„ˆìŠ¤ +${bonusRate}% ì ìš©ë¨</span><br>` : ''}
          ê³µê¸‰ë‹¨ê°€ ì¸í•˜ ë˜ëŠ” ì…€ëŸ¬ë§ˆì§„ ì¡°ì •ì„ ê²€í† í•˜ì„¸ìš”.
        </div>
      `;
    } else {
      profitVerdict.style.background = '#f0fdf4';
      profitVerdict.style.border = '1px solid #86efac';
      profitVerdict.innerHTML = `
        <div style="color: #16a34a; font-weight: 600;">âœ… ì ì • ìˆ˜ìµ</div>
        <div style="color: #15803d; font-size: 13px; margin-top: 4px;">
          ê±´ë‹¹ ìˆœë§ˆì§„ <strong>${profitPerItem.toLocaleString()}ì›</strong> | ì´ ìˆœë§ˆì§„ <strong>${expectedFinalProfit.toLocaleString()}ì›</strong> ${thresholdNote}<br>
          ${bonusRate > 0 ? `<span style="color: #059669;">ğŸ“¦ ${qty}ê°œ íŒë§¤ â†’ ì…€ëŸ¬ ë³´ë„ˆìŠ¤ +${bonusRate}% ì ìš©ë¨</span>` : ''}
        </div>
      `;
    }
  } else if (profitVerdict) {
    profitVerdict.style.display = 'none';
  }
}

// ê³µê¸‰ì‚¬ í˜‘ìƒ ê²°ê³¼ ì¶”ê°€
let supCalcRowId = 0;
function addSupplierCalcRow() {
  const supplierName = document.getElementById('supCalcSupplier').value || 'ì§ì ‘ì…ë ¥';
  const productName = document.getElementById('supCalcProductName').value || 'ë¯¸ì…ë ¥';
  const retailPrice = Number(document.getElementById('supCalcRetailPrice').value) || 0;
  const salePrice = Number(document.getElementById('supCalcSalePrice').value) || 0;
  const supplyPrice = Number(document.getElementById('supCalcSupplyPrice').value) || 0;
  const sellerRate = Number(document.getElementById('supCalcSellerRate').value) || 0;
  const eventCost = Number(document.getElementById('supCalcEventCost').value) || 0;
  const qty = Number(document.getElementById('supCalcQty').value) || 250;
  
  if (salePrice === 0 || supplyPrice === 0) {
    showToast('ê³µêµ¬íŒë§¤ê°€ì™€ ê³µê¸‰ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  const totalMargin = salePrice - supplyPrice;
  const sellerAmt = Math.round(salePrice * sellerRate / 100);
  const moyeoraMargin = totalMargin - sellerAmt;
  
  // ğŸ 500ê°œ ë‹¨ìœ„ ë³´ë„ˆìŠ¤ ë§ˆì§„ìœ¨ ê³„ì‚°
  const bonusRate = Math.floor(qty / 500);
  const bonusSellerMarginPerItem = salePrice > 0 ? Math.round(salePrice * bonusRate / 100) : 0;
  const totalBonusMargin = bonusSellerMarginPerItem * qty;
  
  const expectedSales = salePrice * qty;
  const baseSellerMargin = sellerAmt * qty;
  const totalSellerMargin = baseSellerMargin + totalBonusMargin;
  const pgFee = Math.round(expectedSales * 0.04); // PGìˆ˜ìˆ˜ë£Œ 4%
  const finalProfit = (moyeoraMargin * qty) - totalBonusMargin - pgFee - eventCost;
  const profitPerItem = qty > 0 ? Math.round(finalProfit / qty) : 0;
  
  // ì˜ˆì™¸ ì¡°ê±´: 500ê°œ ì´ìƒ & ì´ë²¤íŠ¸ë¹„ìš© ìˆìŒ â†’ 1000ì› ê¸°ì¤€
  const hasEventCost = eventCost > 0;
  const isHighVolume = qty >= 500;
  const profitThreshold = isHighVolume ? 1000 : 2000;
  
  supCalcRowId++;
  const tbody = document.getElementById('supCalcBody');
  const tr = document.createElement('tr');
  tr.id = `supRow_${supCalcRowId}`;
  
  let verdictBadge = '';
  if (finalProfit < 0) {
    verdictBadge = '<span style="background: #FEE2E2; color: #DC2626; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">âŒ ì ì</span>';
  } else if (profitPerItem < profitThreshold) {
    verdictBadge = '<span style="background: #fffbeb; color: #d97706; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">âš ï¸ ì¡°ì •í•„ìš”</span>';
  } else {
    verdictBadge = '<span style="background: #dcfce7; color: var(--success); padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">âœ… ì–‘í˜¸</span>';
  }
  
  // ì…€ëŸ¬ë§ˆì§„ìœ¨ í‘œì‹œ (ë³´ë„ˆìŠ¤ í¬í•¨)
  const sellerRateDisplay = bonusRate > 0 ? `${sellerRate}%<br><span style="color:#059669;font-size:10px;">(+${bonusRate}%)</span>` : `${sellerRate}%`;
  
  tr.innerHTML = `
    <td><span class="status-badge status-confirmed" style="font-size: 10px;">${supplierName}</span></td>
    <td style="font-weight: 500;">${productName}</td>
    <td style="text-align: right;">${salePrice.toLocaleString()}ì›</td>
    <td style="text-align: right;">${supplyPrice.toLocaleString()}ì›</td>
    <td style="text-align: center;">${sellerRateDisplay}</td>
    <td style="text-align: right;">${totalSellerMargin.toLocaleString()}ì›</td>
    <td style="text-align: right; font-weight: 600; color: var(--success); background: #f0fdf4;">${moyeoraMargin.toLocaleString()}ì›</td>
    <td style="text-align: right;">${qty.toLocaleString()}ê°œ</td>
    <td style="text-align: right; color: #8b5cf6;">${eventCost.toLocaleString()}ì›</td>
    <td style="text-align: right; color: #f59e0b;">${pgFee.toLocaleString()}ì›</td>
    <td style="text-align: right; font-weight: 700; color: ${finalProfit >= 0 ? 'var(--success)' : '#DC2626'}; background: ${finalProfit >= 0 ? '#dcfce7' : '#FEE2E2'};">${finalProfit.toLocaleString()}ì›</td>
    <td style="text-align: center;">${verdictBadge}</td>
    <td><button class="btn btn-secondary btn-sm" style="padding: 4px 8px; color: var(--danger);" onclick="document.getElementById('supRow_${supCalcRowId}').remove(); document.getElementById('supCalcEmpty').style.display = document.querySelectorAll('#supCalcBody tr').length === 0 ? '' : 'none';">Ã—</button></td>
  `;
  tbody.appendChild(tr);
  document.getElementById('supCalcEmpty').style.display = 'none';
  
  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
  document.getElementById('supCalcProductName').value = '';
  document.getElementById('supCalcRetailPrice').value = '';
  document.getElementById('supCalcSalePrice').value = '';
  document.getElementById('supCalcSupplyPrice').value = '';
  
  showToast('ê³„ì‚° ê²°ê³¼ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

let calcRowId = 0;

function filterCalcProducts() {
  const brand = document.getElementById('calcBrandFilter').value.toLowerCase();
  const search = document.getElementById('calcProductSearch').value.toLowerCase();
  const rows = document.querySelectorAll('#calcProductBody tr');
  
  rows.forEach(row => {
    const rowBrand = (row.dataset.brand || '').toLowerCase();
    const rowName = (row.dataset.name || '').toLowerCase();
    const brandMatch = !brand || rowBrand === brand;
    const searchMatch = !search || rowName.includes(search);
    row.style.display = brandMatch && searchMatch ? '' : 'none';
  });
}

function toggleCalcSelectAll(checkbox) {
  const checkboxes = document.querySelectorAll('#calcProductBody tr:not([style*="display: none"]) .calc-product-check');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateCalcSelectedCount();
}

function updateCalcSelectedCount() {
  const count = document.querySelectorAll('.calc-product-check:checked').length;
  document.getElementById('calcSelectedCount').textContent = count;
}

// ì²´í¬ë°•ìŠ¤ ë³€ê²½ì‹œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('calc-product-check')) {
    updateCalcSelectedCount();
  }
});

function addSelectedCalcProducts() {
  const checkboxes = document.querySelectorAll('.calc-product-check:checked');
  if (checkboxes.length === 0) {
    showToast('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”');
    return;
  }
  
  const products = state.supplierProducts || [];
  const globalSellerRate = Number(document.getElementById('calcSellerRateGlobal')?.value) || 20;
  
  checkboxes.forEach(cb => {
    const productId = cb.dataset.id;
    const product = products.find(p => p.id === productId);
    if (product) {
      addCalcRow({
        brandName: product.brandName,
        productName: product.productName,
        salePrice: product.salePrice,
        supplyPrice: product.supplyPrice,
        sellerRate: globalSellerRate  // ê¸€ë¡œë²Œ ì…€ëŸ¬ ë§ˆì§„ìœ¨ ì ìš©
      });
    }
    cb.checked = false;  // ì²´í¬ í•´ì œ
  });
  
  document.getElementById('calcSelectAll').checked = false;
  updateCalcSelectedCount();
  document.getElementById('calcEmptyState').style.display = 'none';
  showToast(`${checkboxes.length}ê°œ ìƒí’ˆì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤`);
}

function addCalcRow(data = {}) {
  calcRowId++;
  const tbody = document.getElementById('calcBody');
  const row = document.createElement('tr');
  row.id = `calcRow_${calcRowId}`;
  
  const salePrice = Number(data.salePrice) || 0;
  const supplyPrice = Number(data.supplyPrice) || 0;
  const totalMargin = salePrice - supplyPrice;
  const sellerRate = Number(data.sellerRate) || 20;
  const sellerAmt = Math.round(salePrice * sellerRate / 100);
  const moyeoraMargin = totalMargin - sellerAmt;
  const moyeoraRate = salePrice > 0 ? (moyeoraMargin / salePrice * 100) : 0;
  
  // ëª¨ì—¬ë¼ë”œ ë§ˆì§„ ìƒ‰ìƒ ê²°ì •
  let moyeoraColor = 'var(--success)';
  let moyeoraAmtBg = 'var(--gray-50)';
  let moyeoraAmtWeight = '600';
  if (moyeoraMargin < 0) {
    moyeoraColor = 'var(--danger)';
    moyeoraAmtWeight = '700';
  } else if (moyeoraMargin <= 2000) {
    moyeoraColor = '#DC2626';
    moyeoraAmtBg = '#FEE2E2';
    moyeoraAmtWeight = '700';
  }
  
  row.innerHTML = `
    <td style="text-align: center; color: var(--gray-500);">${calcRowId}</td>
    <td><span class="status-badge status-confirmed" style="font-size:11px;">${data.brandName || '-'}</span></td>
    <td style="font-weight:500;">${data.productName || '-'}</td>
    <td style="text-align:right;" class="calc-sale" data-value="${salePrice}">${salePrice.toLocaleString()}ì›</td>
    <td style="text-align:right;background:var(--gray-50);" class="calc-supply" data-value="${supplyPrice}">${supplyPrice.toLocaleString()}ì›</td>
    <td style="text-align:right;font-weight:600;" class="calc-margin-amt">${totalMargin.toLocaleString()}ì›</td>
    <td style="background: var(--gray-50);"><input type="number" class="form-input calc-seller-rate" style="font-size: 12px; padding: 6px; text-align: center; width: 60px;" value="${sellerRate}" step="1" oninput="recalcRow(this)">%</td>
    <td class="calc-seller-amt" style="text-align: right; background: var(--gray-50); font-weight:600; color:var(--info);">${sellerAmt.toLocaleString()}ì›</td>
    <td class="calc-moyeora-rate" style="text-align: center; background: var(--gray-50); color:${moyeoraColor};">${moyeoraRate.toFixed(1)}%</td>
    <td class="calc-moyeora-amt" style="text-align: right; background: ${moyeoraAmtBg}; font-weight: ${moyeoraAmtWeight}; color:${moyeoraColor};">${moyeoraMargin.toLocaleString()}ì›</td>
    <td><button class="btn btn-secondary btn-sm" style="padding: 4px 8px; color: var(--danger);" onclick="removeCalcRow('${row.id}')">Ã—</button></td>
  `;
  tbody.appendChild(row);
  updateCalcTotals();
}

function removeCalcRow(rowId) {
  document.getElementById(rowId)?.remove();
  updateCalcTotals();
  
  // ë¹ˆ ìƒíƒœ ì²´í¬
  if (document.querySelectorAll('#calcBody tr').length === 0) {
    document.getElementById('calcEmptyState').style.display = '';
  }
}

function clearCalcRows() {
  document.getElementById('calcBody').innerHTML = '';
  calcRowId = 0;
  document.getElementById('calcEmptyState').style.display = '';
  
  // ì…€ëŸ¬ ì œì•ˆì„œë„ ì´ˆê¸°í™”
  const proposalBody = document.getElementById('sellerProposalBody');
  if (proposalBody) proposalBody.innerHTML = '';
  sellerProposalRowId = 0;
  const proposalSection = document.getElementById('sellerProposalSection');
  if (proposalSection) proposalSection.style.display = 'none';
  
  updateCalcTotals();
}

// ì…€ëŸ¬ ì œì•ˆì„œì— ì¶”ê°€
let sellerProposalRowId = 0;
function addToSellerProposal() {
  const rows = document.querySelectorAll('#calcBody tr');
  if (rows.length === 0) {
    showToast('ë¨¼ì € ìƒí’ˆì„ ì¶”ê°€í•˜ì„¸ìš”');
    return;
  }
  
  const expectedQty = Number(document.getElementById('calcExpectedQty')?.value) || 250;
  const eventCost = Number(document.getElementById('calcEventCost')?.value) || 0;
  const pgFeeRate = Number(document.getElementById('calcPgFeeRate')?.value) || 4;
  
  // 500ê°œ ë‹¨ìœ„ ë³´ë„ˆìŠ¤ ë§ˆì§„ìœ¨
  const bonusRate = Math.floor(expectedQty / 500);
  
  // ì˜ˆì™¸ ì¡°ê±´: 500ê°œ ì´ìƒ & ì´ë²¤íŠ¸ë¹„ìš© ìˆìŒ â†’ 1000ì› ê¸°ì¤€
  const hasEventCost = eventCost > 0;
  const isHighVolume = expectedQty >= 500;
  const profitThreshold = isHighVolume ? 1000 : 2000;
  
  const tbody = document.getElementById('sellerProposalBody');
  
  rows.forEach(row => {
    const brandName = row.querySelector('.status-badge')?.textContent || '-';
    const productName = row.querySelectorAll('td')[2]?.textContent || '-';
    const salePrice = Number(row.querySelector('.calc-sale')?.dataset?.value) || 0;
    const supplyPrice = Number(row.querySelector('.calc-supply')?.dataset?.value) || 0;
    const sellerRate = Number(row.querySelector('.calc-seller-rate')?.value) || 0;
    
    const totalMargin = salePrice - supplyPrice;
    const baseSellerAmt = Math.round(salePrice * sellerRate / 100);
    const bonusSellerAmt = Math.round(salePrice * bonusRate / 100);
    const totalSellerAmt = (baseSellerAmt + bonusSellerAmt) * expectedQty;
    const moyeoraMarginPerItem = totalMargin - baseSellerAmt - bonusSellerAmt;
    
    // ì „ì²´ ê³„ì‚°
    const expectedSales = salePrice * expectedQty;
    const expectedPgFee = Math.round(expectedSales * pgFeeRate / 100);
    const moyeoraProfit = (moyeoraMarginPerItem * expectedQty) - expectedPgFee - eventCost;
    const profitPerItem = expectedQty > 0 ? Math.round(moyeoraProfit / expectedQty) : 0;
    
    // íŒì •
    let verdictBadge = '';
    if (moyeoraProfit < 0) {
      verdictBadge = '<span style="background: #FEE2E2; color: #DC2626; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">âŒ ì ì</span>';
    } else if (profitPerItem < profitThreshold) {
      verdictBadge = '<span style="background: #fffbeb; color: #d97706; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">âš ï¸ ì ê²€</span>';
    } else {
      verdictBadge = '<span style="background: #dcfce7; color: var(--success); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">âœ… ì–‘í˜¸</span>';
    }
    
    sellerProposalRowId++;
    const tr = document.createElement('tr');
    tr.id = `spRow_${sellerProposalRowId}`;
    tr.dataset.brandName = brandName;
    tr.dataset.productName = productName;
    tr.dataset.salePrice = salePrice;
    tr.dataset.sellerRate = sellerRate;
    tr.dataset.bonusRate = bonusRate;
    tr.dataset.expectedQty = expectedQty;
    tr.dataset.totalSellerAmt = totalSellerAmt;
    tr.dataset.moyeoraProfit = moyeoraProfit;
    tr.dataset.eventCost = eventCost;
    tr.dataset.pgFeeRate = pgFeeRate;
    
    // ê°œë‹¹ ë§ˆì§„ê¸ˆ (ê¸°ë³¸ + ë³´ë„ˆìŠ¤)
    const marginPerItem = baseSellerAmt + bonusSellerAmt;
    
    tr.innerHTML = `
      <td style="padding: 10px;"><span class="status-badge status-confirmed" style="font-size: 10px;">${brandName}</span></td>
      <td style="padding: 10px; font-weight: 500;">${productName}</td>
      <td style="padding: 10px; text-align: right;">${salePrice.toLocaleString()}ì›</td>
      <td style="padding: 10px; text-align: right; background: #eff6ff; font-weight: 600; color: #3b82f6;">${marginPerItem.toLocaleString()}ì›</td>
      <td style="padding: 10px; text-align: center; background: #f0fdf4; color: #059669; font-weight: 600;">${bonusRate > 0 ? '+' + bonusRate + '%' : '-'}</td>
      <td style="padding: 10px; text-align: right;">${expectedQty.toLocaleString()}ê°œ</td>
      <td style="padding: 10px; text-align: right; background: #eff6ff; font-weight: 600; color: #3b82f6;">${totalSellerAmt.toLocaleString()}ì›</td>
      <td style="padding: 10px; text-align: right; background: ${moyeoraProfit >= 0 ? '#f0fdf4' : '#fef2f2'}; font-weight: 700; color: ${moyeoraProfit >= 0 ? '#16a34a' : '#dc2626'};">${moyeoraProfit.toLocaleString()}ì›</td>
      <td style="padding: 10px; text-align: center;">${verdictBadge}</td>
      <td style="padding: 10px;"><button class="btn btn-secondary btn-sm" style="padding: 4px 8px; color: var(--danger);" onclick="removeSellerProposalRow('spRow_${sellerProposalRowId}')">Ã—</button></td>
    `;
    tbody.appendChild(tr);
  });
  
  document.getElementById('sellerProposalSection').style.display = 'block';
  document.getElementById('sellerProposalEmpty').style.display = 'none';
  showToast(`${rows.length}ê°œ ìƒí’ˆì´ ì œì•ˆì„œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
}

function removeSellerProposalRow(rowId) {
  document.getElementById(rowId)?.remove();
  if (document.querySelectorAll('#sellerProposalBody tr').length === 0) {
    document.getElementById('sellerProposalEmpty').style.display = '';
  }
}

// ì…€ëŸ¬ ì œì•ˆì„œ PDF ë‹¤ìš´ë¡œë“œ
function exportSellerProposalToPdf() {
  const rows = document.querySelectorAll('#sellerProposalBody tr');
  if (rows.length === 0) {
    showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // ì²« ë²ˆì§¸ í–‰ì˜ ë°ì´í„°ë¡œ ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
  const firstRow = rows[0];
  const expectedQty = Number(firstRow.dataset.expectedQty) || 250;
  const bonusRate = Number(firstRow.dataset.bonusRate) || 0;
  const eventCost = Number(firstRow.dataset.eventCost) || 0;
  const pgFeeRate = Number(firstRow.dataset.pgFeeRate) || 4;
  
  // ìƒí’ˆ ë°ì´í„° ìˆ˜ì§‘
  let totalSellerMargin = 0;
  let productRows = '';
  rows.forEach((row, idx) => {
    const brandName = row.dataset.brandName || '';
    const productName = row.dataset.productName || '';
    const salePrice = Number(row.dataset.salePrice) || 0;
    const sellerRate = Number(row.dataset.sellerRate) || 0;
    const rowBonusRate = Number(row.dataset.bonusRate) || 0;
    const rowQty = Number(row.dataset.expectedQty) || 0;
    const totalSellerAmt = Number(row.dataset.totalSellerAmt) || 0;
    
    // ê°œë‹¹ ë§ˆì§„ê¸ˆ ê³„ì‚° (ê¸°ë³¸ + ë³´ë„ˆìŠ¤)
    const marginPerItem = Math.round(salePrice * (sellerRate + rowBonusRate) / 100);
    
    totalSellerMargin += totalSellerAmt;
    
    const rowBg = idx % 2 === 0 ? '#ffffff' : '#faf5ff';
    productRows += `
      <tr style="background: ${rowBg};">
        <td style="text-align: center; font-weight: 500;">${idx + 1}</td>
        <td><span style="background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px;">${brandName}</span></td>
        <td style="font-weight: 600; font-size: 10px;">${productName}</td>
        <td style="text-align: right;">${salePrice.toLocaleString()}ì›</td>
        <td style="text-align: right; font-weight: 700; color: #7c3aed;">${marginPerItem.toLocaleString()}ì›</td>
        <td style="text-align: center; color: #059669; font-weight: 700;">${rowBonusRate > 0 ? '+' + rowBonusRate + '%' : '-'}</td>
        <td style="text-align: right;">${rowQty.toLocaleString()}ê°œ</td>
        <td style="text-align: right; font-weight: 800; color: #6366f1;">${totalSellerAmt.toLocaleString()}ì›</td>
      </tr>
    `;
  });
  
  // PDFìš© HTML ìƒì„±
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ëª¨ì—¬ë¼ë”œ ì…€ëŸ¬ ì œì•ˆì„œ</title>
      <style>
        @page { size: A4; margin: 8mm; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Malgun Gothic', sans-serif; font-size: 11px; color: #1f2937; line-height: 1.4; }
        
        .header { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 16px 20px; text-align: center; }
        .header h1 { font-size: 20px; font-weight: 800; }
        .header p { margin-top: 4px; opacity: 0.9; font-size: 11px; }
        
        .content { padding: 12px 16px; }
        .section { margin-bottom: 12px; }
        .section-title { font-size: 12px; font-weight: 700; color: #4f46e5; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 2px solid #8b5cf6; }
        
        .info-grid { display: flex; gap: 10px; }
        .info-box { flex: 1; background: #f9fafb; padding: 10px 8px; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb; }
        .info-box.highlight { background: #f0fdf4; border-color: #86efac; }
        .info-box .label { font-size: 9px; color: #6b7280; }
        .info-box .value { font-size: 16px; font-weight: 800; color: #4f46e5; margin-top: 2px; }
        .info-box.highlight .value { color: #059669; }
        
        .product-card { border-radius: 8px; overflow: hidden; border: 1px solid #e9d5ff; }
        .product-table { width: 100%; border-collapse: collapse; }
        .product-table th { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 8px 6px; font-weight: 600; font-size: 9px; }
        .product-table td { padding: 10px 6px; border-bottom: 1px solid #f3e8ff; }
        .total-row { background: #faf5ff; }
        .total-row td { border-top: 2px solid #8b5cf6; padding: 10px 6px; }
        
        .policy-card { background: #faf5ff; border-radius: 8px; padding: 10px; border: 1px solid #e9d5ff; }
        .policy-table { width: 100%; border-collapse: collapse; }
        .policy-table th { background: #8b5cf6; color: white; padding: 6px 8px; font-size: 9px; font-weight: 600; }
        .policy-table td { padding: 6px 8px; text-align: center; border-bottom: 1px solid #e9d5ff; font-size: 10px; }
        .policy-note { font-size: 9px; color: #7c3aed; margin-top: 6px; padding: 6px 8px; background: white; border-radius: 4px; border-left: 3px solid #8b5cf6; }
        
        .footer { margin-top: 10px; padding: 10px 12px; background: #fef3c7; border-radius: 6px; display: flex; gap: 20px; flex-wrap: wrap; }
        .footer p { font-size: 9px; color: #78350f; display: flex; align-items: center; gap: 4px; }
        .footer p::before { content: 'â€¢'; color: #f59e0b; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>ğŸ“‹ ëª¨ì—¬ë¼ë”œ ì…€ëŸ¬ ì œì•ˆì„œ</h1>
        <p>ì‘ì„±ì¼: ${formatDate(new Date())}</p>
      </div>
      
      <div class="content">
        <div class="section">
          <div class="section-title">ğŸ“Š ì´ë²ˆ ì œì•ˆ ì¡°ê±´</div>
          <div class="info-grid">
            <div class="info-box">
              <div class="label">ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰</div>
              <div class="value">${expectedQty.toLocaleString()}ê°œ</div>
            </div>
            <div class="info-box highlight">
              <div class="label">ë³´ë„ˆìŠ¤ ë§ˆì§„ìœ¨</div>
              <div class="value">${bonusRate > 0 ? '+' + bonusRate + '%' : '-'}</div>
            </div>
            <div class="info-box">
              <div class="label">ì´ë²¤íŠ¸ë¹„ìš©</div>
              <div class="value">${eventCost.toLocaleString()}ì›</div>
            </div>
            <div class="info-box">
              <div class="label">PGìˆ˜ìˆ˜ë£Œìœ¨</div>
              <div class="value">${pgFeeRate}%</div>
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">ğŸ“¦ ìƒí’ˆë³„ ë§ˆì§„ ìƒì„¸</div>
          <div class="product-card">
            <table class="product-table">
              <tr>
                <th style="width: 30px;">No</th>
                <th style="width: 60px;">ê³µê¸‰ì‚¬</th>
                <th>ìƒí’ˆëª…</th>
                <th style="width: 75px;">ê³µêµ¬íŒë§¤ê°€</th>
                <th style="width: 70px;">ê°œë‹¹ ë§ˆì§„ê¸ˆ</th>
                <th style="width: 50px;">ë³´ë„ˆìŠ¤</th>
                <th style="width: 60px;">ì˜ˆìƒìˆ˜ëŸ‰</th>
                <th style="width: 90px;">ì…€ëŸ¬ë§ˆì§„(ì´)</th>
              </tr>
              ${productRows}
              <tr class="total-row">
                <td colspan="7" style="text-align: right; font-size: 12px; font-weight: 700; color: #4f46e5;">ì´ ì…€ëŸ¬ë§ˆì§„</td>
                <td style="text-align: right; font-size: 14px; font-weight: 800; color: #6366f1;">${totalSellerMargin.toLocaleString()}ì›</td>
              </tr>
            </table>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">ğŸ’° ì…€ëŸ¬ ë§ˆì§„ ì •ì±…</div>
          <div class="policy-card">
            <table class="policy-table">
              <tr>
                <th>íŒë§¤ìˆ˜ëŸ‰</th>
                <th>ë³´ë„ˆìŠ¤ ë§ˆì§„ìœ¨</th>
                <th>ê°œë‹¹ ë§ˆì§„ê¸ˆ</th>
                <th>ì ìš© ì˜ˆì‹œ</th>
              </tr>
              <tr>
                <td style="font-weight: 600;">500ê°œ ë¯¸ë§Œ</td>
                <td style="color: #9ca3af;">+0%</td>
                <td>ê¸°ë³¸ ë§ˆì§„ê¸ˆ</td>
                <td style="color: #6b7280;">ê¸°ë³¸ ë§ˆì§„ë§Œ ì ìš©</td>
              </tr>
              <tr style="background: rgba(139,92,246,0.05);">
                <td style="font-weight: 600;">500 ~ 999ê°œ</td>
                <td style="color: #059669; font-weight: 700;">+1%</td>
                <td style="color: #059669;">ê¸°ë³¸ + 1%</td>
                <td style="color: #059669;">ë§ˆì§„ê¸ˆ ìƒìŠ¹</td>
              </tr>
              <tr>
                <td style="font-weight: 600;">1,000 ~ 1,499ê°œ</td>
                <td style="color: #059669; font-weight: 700;">+2%</td>
                <td style="color: #059669;">ê¸°ë³¸ + 2%</td>
                <td style="color: #059669;">ë§ˆì§„ê¸ˆ ìƒìŠ¹</td>
              </tr>
              <tr style="background: rgba(139,92,246,0.05);">
                <td style="font-weight: 600;">1,500ê°œ ì´ìƒ</td>
                <td style="color: #059669; font-weight: 700;">+3%â†‘</td>
                <td style="color: #059669;">ê¸°ë³¸ + 3%â†‘</td>
                <td style="color: #059669;">ë§ˆì§„ê¸ˆ ìƒìŠ¹</td>
              </tr>
            </table>
            <div class="policy-note">ğŸ’¡ 500ê°œ ë‹¨ìœ„ë¡œ ë§ˆì§„ìœ¨ 1%ì”© ì¶”ê°€! ë§ì´ íŒ”ìˆ˜ë¡ ê°œë‹¹ ë§ˆì§„ê¸ˆì´ ë†’ì•„ì§‘ë‹ˆë‹¤.</div>
          </div>
        </div>
        
        <div class="footer">
          <p>ì›ì²œì§•ìˆ˜(3.3%) ë³„ë„ ê³µì œ í›„ ì§€ê¸‰</p>
          <p>ì •ì‚°ì¼: ê³µêµ¬ ì¢…ë£Œ í›„ 3~7ì¼ ì´ë‚´</p>
          <p>ë¬¸ì˜: ëª¨ì—¬ë¼ë”œ ìš´ì˜íŒ€</p>
        </div>
      </div>
    </body>
    </html>
  `;
  
  // ìƒˆ ì°½ì—ì„œ PDF ì¶œë ¥
  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.onload = function() {
    printWindow.print();
  };
  showToast('PDF ì¸ì‡„ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤');
}

function loadProductsToCalc() {
  const products = state.supplierProducts || [];
  if (products.length === 0) { showToast('ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤'); return; }
  
  document.getElementById('calcBody').innerHTML = '';
  calcRowId = 0;
  
  products.forEach(p => {
    addCalcRow({
      brandName: p.brandName,
      productName: p.productName,
      salePrice: p.salePrice,
      supplyPrice: p.supplyPrice,
      sellerRate: 20
    });
  });
  
  document.getElementById('calcEmptyState').style.display = 'none';
  showToast(`${products.length}ê°œ ìƒí’ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
}

// ì…€ëŸ¬ ë§ˆì§„ìœ¨ ì¼ê´„ ì ìš©
function applyGlobalSellerRate() {
  const globalRate = Number(document.getElementById('calcSellerRateGlobal')?.value) || 20;
  const rows = document.querySelectorAll('#calcBody tr');
  
  if (rows.length === 0) {
    showToast('ë¨¼ì € ìƒí’ˆì„ ì¶”ê°€í•˜ì„¸ìš”');
    return;
  }
  
  rows.forEach(row => {
    const rateInput = row.querySelector('.calc-seller-rate');
    if (rateInput) {
      rateInput.value = globalRate;
      recalcRow(rateInput);
    }
  });
  
  updateCalcTotals();
  showToast(`ì…€ëŸ¬ ë§ˆì§„ìœ¨ ${globalRate}% ì¼ê´„ ì ìš© ì™„ë£Œ`);
}

function recalcRow(input) {
  const row = input.closest('tr');
  const salePrice = Number(row.querySelector('.calc-sale').dataset.value) || 0;
  const supplyPrice = Number(row.querySelector('.calc-supply').dataset.value) || 0;
  const sellerRate = Number(row.querySelector('.calc-seller-rate').value) || 0;
  
  // ì´ë§ˆì§„ê¸ˆ
  const totalMargin = salePrice - supplyPrice;
  
  // ì…€ëŸ¬ ë§ˆì§„ê¸ˆ (íŒë§¤ê°€ Ã— ì…€ëŸ¬ë§ˆì§„ìœ¨)
  const sellerAmt = Math.round(salePrice * sellerRate / 100);
  row.querySelector('.calc-seller-amt').textContent = sellerAmt.toLocaleString() + 'ì›';
  
  // ëª¨ì—¬ë¼ë”œ ë§ˆì§„ (ì´ë§ˆì§„ê¸ˆ - ì…€ëŸ¬ë§ˆì§„ê¸ˆ)
  const moyeoraMargin = totalMargin - sellerAmt;
  const moyeoraRate = salePrice > 0 ? (moyeoraMargin / salePrice * 100) : 0;
  
  const moyeoraRateCell = row.querySelector('.calc-moyeora-rate');
  const moyeoraAmtCell = row.querySelector('.calc-moyeora-amt');
  
  moyeoraRateCell.textContent = moyeoraRate.toFixed(1) + '%';
  moyeoraAmtCell.textContent = moyeoraMargin.toLocaleString() + 'ì›';
  
  // ë§ˆì§„ì´ ë§ˆì´ë„ˆìŠ¤ë©´ ë¹¨ê°„ìƒ‰, 2000ì› ì´í•˜ë©´ ì£¼í™©ìƒ‰/ë¹¨ê°„ìƒ‰ ê²½ê³ 
  if (moyeoraMargin < 0) {
    moyeoraRateCell.style.color = 'var(--danger)';
    moyeoraAmtCell.style.color = 'var(--danger)';
    moyeoraAmtCell.style.fontWeight = '700';
  } else if (moyeoraMargin <= 2000) {
    moyeoraRateCell.style.color = '#DC2626';
    moyeoraAmtCell.style.color = '#DC2626';
    moyeoraAmtCell.style.fontWeight = '700';
    moyeoraAmtCell.style.background = '#FEE2E2';
  } else {
    moyeoraRateCell.style.color = 'var(--success)';
    moyeoraAmtCell.style.color = 'var(--success)';
    moyeoraAmtCell.style.fontWeight = '600';
    moyeoraAmtCell.style.background = 'var(--gray-50)';
  }
  
  updateCalcTotals();
}

function updateCalcTotals() {
  const rows = document.querySelectorAll('#calcBody tr');
  let totalSales = 0, totalMargin = 0, totalSeller = 0, totalMoyeora = 0;
  
  rows.forEach(row => {
    const salePrice = Number(row.querySelector('.calc-sale')?.dataset?.value) || 0;
    const supplyPrice = Number(row.querySelector('.calc-supply')?.dataset?.value) || 0;
    const sellerRate = Number(row.querySelector('.calc-seller-rate')?.value) || 0;
    
    const margin = salePrice - supplyPrice;
    const sellerAmt = Math.round(salePrice * sellerRate / 100);
    const moyeoraAmt = margin - sellerAmt;
    
    totalSales += salePrice;
    totalMargin += margin;
    totalSeller += sellerAmt;
    totalMoyeora += moyeoraAmt;
  });
  
  document.getElementById('calcTotalSales').textContent = totalSales.toLocaleString() + 'ì›';
  document.getElementById('calcTotalMargin').textContent = totalMargin.toLocaleString() + 'ì›';
  document.getElementById('calcTotalSeller').textContent = totalSeller.toLocaleString() + 'ì›';
  
  const moyeoraEl = document.getElementById('calcTotalMoyeora');
  moyeoraEl.textContent = totalMoyeora.toLocaleString() + 'ì›';
  
  // ì˜ˆìƒ ê³µêµ¬ ë§¤ì¶œì•¡ ê³„ì‚°
  const expectedQty = Number(document.getElementById('calcExpectedQty')?.value) || 250;
  const eventCost = Number(document.getElementById('calcEventCost')?.value) || 0;
  const pgFeeRate = Number(document.getElementById('calcPgFeeRate')?.value) || 4;
  
  // ğŸ 500ê°œ ë‹¨ìœ„ ë³´ë„ˆìŠ¤ ë§ˆì§„ìœ¨ ê³„ì‚° (500ê°œë‹¹ 1%)
  const bonusRate = Math.floor(expectedQty / 500);
  const bonusSellerMarginPerItem = totalSales > 0 ? Math.round(totalSales * bonusRate / 100) : 0;
  const totalBonusMargin = bonusSellerMarginPerItem * expectedQty;
  
  // ê³„ì‚° (ë³´ë„ˆìŠ¤ ë§ˆì§„ ë°˜ì˜)
  const expectedSales = totalSales * expectedQty;
  const baseSellerMargin = totalSeller * expectedQty;
  const expectedSellerMargin = baseSellerMargin + totalBonusMargin; // ë³´ë„ˆìŠ¤ í¬í•¨
  const expectedPgFee = Math.round(expectedSales * pgFeeRate / 100);
  const expectedEventCost = eventCost;
  const expectedTotalCost = expectedSellerMargin + expectedPgFee + expectedEventCost;
  const expectedProfit = (totalMoyeora * expectedQty) - totalBonusMargin - expectedPgFee - expectedEventCost;
  
  // ê²°ê³¼ í‘œì‹œ
  const expectedSalesEl = document.getElementById('calcExpectedSales');
  const expectedSellerMarginEl = document.getElementById('calcExpectedSellerMargin');
  const expectedPgFeeEl = document.getElementById('calcExpectedPgFee');
  const expectedEventCostEl = document.getElementById('calcExpectedEventCost');
  const expectedTotalCostEl = document.getElementById('calcExpectedTotalCost');
  const expectedProfitEl = document.getElementById('calcExpectedProfit');
  
  if (expectedSalesEl) expectedSalesEl.textContent = expectedSales.toLocaleString() + 'ì›';
  if (expectedSellerMarginEl) {
    if (bonusRate > 0) {
      expectedSellerMarginEl.innerHTML = `${expectedSellerMargin.toLocaleString()}ì›<br><span style="font-size:10px;color:#059669;">(+${bonusRate}% ë³´ë„ˆìŠ¤)</span>`;
    } else {
      expectedSellerMarginEl.textContent = expectedSellerMargin.toLocaleString() + 'ì›';
    }
  }
  if (expectedPgFeeEl) expectedPgFeeEl.textContent = expectedPgFee.toLocaleString() + 'ì›';
  if (expectedEventCostEl) expectedEventCostEl.textContent = expectedEventCost.toLocaleString() + 'ì›';
  if (expectedTotalCostEl) expectedTotalCostEl.textContent = expectedTotalCost.toLocaleString() + 'ì›';
  if (expectedProfitEl) {
    expectedProfitEl.textContent = expectedProfit.toLocaleString() + 'ì›';
  }
  
  // ìˆœë§ˆì§„ íŒì • (ì˜ˆì™¸ ì¡°ê±´ ì ìš©)
  // 500ê°œ ì´ìƒ & ì´ë²¤íŠ¸ë¹„ìš© ìˆìŒ â†’ ê±´ë‹¹ 1,000ì› ê¸°ì¤€
  // ê·¸ ì™¸ â†’ ê±´ë‹¹ 2,000ì› ê¸°ì¤€
  const hasEventCost = eventCost > 0;
  const isHighVolume = expectedQty >= 500;
  const profitThreshold = isHighVolume ? 1000 : 2000;
  
  const verdictEl = document.getElementById('calcProfitVerdict');
  if (verdictEl && rows.length > 0) {
    verdictEl.style.display = 'block';
    const profitPerItem = expectedQty > 0 ? Math.round(expectedProfit / expectedQty) : 0;
    
    // ì˜ˆì™¸ ì¡°ê±´ ì•ˆë‚´ í…ìŠ¤íŠ¸
    const thresholdNote = isHighVolume 
      ? `<span style="color: #6366f1; font-size: 11px;">(500ê°œ ì´ìƒ â†’ ê¸°ì¤€ 1,000ì›)</span>` 
      : '';
    
    if (expectedProfit < 0) {
      verdictEl.style.background = '#fef2f2';
      verdictEl.style.border = '1px solid #fecaca';
      verdictEl.innerHTML = `
        <div style="color: #dc2626; font-weight: 600;">âŒ ì ì ì˜ˆìƒ</div>
        <div style="color: #b91c1c; font-size: 13px; margin-top: 4px;">
          ìˆœë§ˆì§„ì´ ë§ˆì´ë„ˆìŠ¤ì…ë‹ˆë‹¤. ì…€ëŸ¬ ë§ˆì§„ìœ¨ ì¡°ì • ë˜ëŠ” ì´ë²¤íŠ¸ë¹„ìš© ì ˆê°ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
      `;
    } else if (profitPerItem < profitThreshold) {
      verdictEl.style.background = '#fffbeb';
      verdictEl.style.border = '1px solid #fcd34d';
      verdictEl.innerHTML = `
        <div style="color: #d97706; font-weight: 600;">âš ï¸ ìˆ˜ìµì„± ì ê²€ í•„ìš”</div>
        <div style="color: #92400e; font-size: 13px; margin-top: 4px;">
          ê±´ë‹¹ ìˆœë§ˆì§„ <strong>${profitPerItem.toLocaleString()}ì›</strong> (ëª©í‘œ: ${profitThreshold.toLocaleString()}ì› ì´ìƒ) ${thresholdNote}<br>
          ${bonusRate > 0 ? `<span style="color: #059669;">ğŸ“¦ ${expectedQty}ê°œ íŒë§¤ â†’ ì…€ëŸ¬ ë³´ë„ˆìŠ¤ +${bonusRate}% ì ìš©ë¨</span><br>` : ''}
          ì…€ëŸ¬ ë§ˆì§„ìœ¨ ì¡°ì • ë˜ëŠ” íŒë§¤ìˆ˜ëŸ‰ í™•ëŒ€ë¥¼ ê²€í† í•˜ì„¸ìš”.
        </div>
      `;
    } else {
      verdictEl.style.background = '#f0fdf4';
      verdictEl.style.border = '1px solid #86efac';
      verdictEl.innerHTML = `
        <div style="color: #16a34a; font-weight: 600;">âœ… ì ì • ìˆ˜ìµ</div>
        <div style="color: #15803d; font-size: 13px; margin-top: 4px;">
          ê±´ë‹¹ ìˆœë§ˆì§„ <strong>${profitPerItem.toLocaleString()}ì›</strong> | ì´ ìˆœë§ˆì§„ <strong>${expectedProfit.toLocaleString()}ì›</strong> ${thresholdNote}<br>
          ${bonusRate > 0 ? `<span style="color: #059669;">ğŸ“¦ ${expectedQty}ê°œ íŒë§¤ â†’ ì…€ëŸ¬ ë³´ë„ˆìŠ¤ +${bonusRate}% ì ìš©ë¨</span>` : ''}
        </div>
      `;
    }
  } else if (verdictEl) {
    verdictEl.style.display = 'none';
  }
  
  // ìƒí’ˆ ê°œìˆ˜ë¡œ í‰ê·  ë§ˆì§„ ê³„ì‚°
  const itemCount = rows.length;
  const avgMoyeora = itemCount > 0 ? totalMoyeora / itemCount : 0;
  
  // í‰ê·  ë§ˆì§„ì´ 2000ì› ì´í•˜ë©´ ê²½ê³  ìƒ‰ìƒ
  if (totalMoyeora < 0) {
    moyeoraEl.style.color = 'var(--danger)';
  } else if (avgMoyeora <= 2000 && itemCount > 0) {
    moyeoraEl.style.color = '#DC2626';
  } else {
    moyeoraEl.style.color = 'var(--success)';
  }
}

// ê³µê¸‰ì‚¬ í˜‘ìƒìš© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
// ê³µê¸‰ì‚¬ í˜‘ìƒ ê²€í† ì„œ PDF ë‹¤ìš´ë¡œë“œ
function exportSupplierCalcToPdf() {
  const rows = document.querySelectorAll('#supCalcBody tr');
  if (rows.length === 0) { 
    showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê³„ì‚° ê²°ê³¼ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.'); 
    return; 
  }
  
  // ìƒí’ˆ ë°ì´í„° ìˆ˜ì§‘
  let totalFinalProfit = 0;
  let productRows = '';
  rows.forEach((row, idx) => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 12) return;
    
    const supplierName = cells[0]?.textContent?.trim() || '';
    const productName = cells[1]?.textContent?.trim() || '';
    const salePrice = cells[2]?.textContent?.trim() || '';
    const supplyPrice = cells[3]?.textContent?.trim() || '';
    const sellerRate = cells[4]?.textContent?.trim() || '';
    const sellerAmt = cells[5]?.textContent?.trim() || '';
    const moyeoraMargin = cells[6]?.textContent?.trim() || '';
    const qty = cells[7]?.textContent?.trim() || '';
    const eventCost = cells[8]?.textContent?.trim() || '';
    const pgFee = cells[9]?.textContent?.trim() || '';
    const finalProfit = Number(cells[10]?.textContent?.replace(/[^0-9-]/g, '')) || 0;
    const verdictText = cells[11]?.textContent?.trim() || '';
    
    totalFinalProfit += finalProfit;
    
    const isProfit = finalProfit >= 0;
    productRows += `
      <tr>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">${idx + 1}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb;"><span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${supplierName}</span></td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: 500;">${productName}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${salePrice}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; background: #f9fafb;">${supplyPrice}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">${sellerRate}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; color: #3b82f6;">${sellerAmt}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${moyeoraMargin}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${qty}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; color: #8b5cf6;">${eventCost}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; color: #f59e0b;">${pgFee}</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 700; background: ${isProfit ? '#f0fdf4' : '#fef2f2'}; color: ${isProfit ? '#16a34a' : '#dc2626'};">${finalProfit.toLocaleString()}ì›</td>
        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 10px;">${verdictText}</td>
      </tr>
    `;
  });
  
  // PDFìš© HTML ìƒì„±
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ëª¨ì—¬ë¼ë”œ ê³µê¸‰ì‚¬ í˜‘ìƒ ê²€í† ì„œ</title>
      <style>
        @page { size: A4 landscape; margin: 10mm; }
        body { font-family: 'Malgun Gothic', sans-serif; font-size: 11px; color: #1f2937; line-height: 1.4; }
        .header { background: linear-gradient(135deg, #059669, #10b981); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 22px; }
        .header p { margin: 6px 0 0 0; opacity: 0.9; }
        .section { margin-bottom: 16px; }
        .section-title { font-size: 13px; font-weight: 700; color: #059669; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #10b981; }
        .two-col { display: flex; gap: 20px; }
        .two-col > div { flex: 1; }
        .policy-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .policy-table th { background: #f0fdf4; padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; }
        .policy-table td { padding: 8px; border: 1px solid #e5e7eb; text-align: center; }
        .target-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .target-table th { background: #fef3c7; padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; }
        .target-table td { padding: 8px; border: 1px solid #e5e7eb; text-align: center; }
        .product-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .product-table th { background: #059669; color: white; padding: 8px; border: 1px solid #047857; font-weight: 600; }
        .total-row { background: #f0fdf4; font-weight: 700; }
        .footer { margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 10px; color: #6b7280; }
        .footer p { margin: 3px 0; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>ğŸ“Š ëª¨ì—¬ë¼ë”œ ê³µê¸‰ì‚¬ í˜‘ìƒ ê²€í† ì„œ</h1>
        <p>ì‘ì„±ì¼: ${formatDate(new Date())}</p>
      </div>
      
      <div class="two-col">
        <div class="section">
          <div class="section-title">ğŸ’° ì…€ëŸ¬ ë§ˆì§„ ì •ì±…</div>
          <table class="policy-table">
            <tr>
              <th>íŒë§¤ìˆ˜ëŸ‰</th>
              <th>ê¸°ë³¸ ë§ˆì§„ìœ¨</th>
              <th>ë³´ë„ˆìŠ¤</th>
              <th>ì´ ë§ˆì§„ìœ¨</th>
            </tr>
            <tr><td>500ê°œ ë¯¸ë§Œ</td><td>í˜‘ì˜ê°’</td><td>+0%</td><td>ê¸°ë³¸</td></tr>
            <tr><td>500~999ê°œ</td><td>í˜‘ì˜ê°’</td><td style="color: #059669; font-weight: 600;">+1%</td><td>ê¸°ë³¸+1%</td></tr>
            <tr><td>1,000~1,499ê°œ</td><td>í˜‘ì˜ê°’</td><td style="color: #059669; font-weight: 600;">+2%</td><td>ê¸°ë³¸+2%</td></tr>
            <tr><td>1,500ê°œâ†‘</td><td>í˜‘ì˜ê°’</td><td style="color: #059669; font-weight: 600;">+3%â†‘</td><td>ê¸°ë³¸+3%â†‘</td></tr>
          </table>
          <p style="font-size: 9px; color: #6b7280; margin-top: 6px;">â€» ë³´ë„ˆìŠ¤ ë§ˆì§„ì€ ëª¨ì—¬ë¼ë”œ ë¶€ë‹´ (ê³µê¸‰ì‚¬ ë§ˆì§„ ì˜í–¥ ì—†ìŒ)</p>
        </div>
        
        <div class="section">
          <div class="section-title">ğŸ¯ ìˆ˜ìµì„± ëª©í‘œ ê¸°ì¤€</div>
          <table class="target-table">
            <tr>
              <th>ì¡°ê±´</th>
              <th>ê±´ë‹¹ ìˆœë§ˆì§„ ê¸°ì¤€</th>
            </tr>
            <tr><td>500ê°œ ë¯¸ë§Œ</td><td style="font-weight: 600; color: #dc2626;">2,000ì› ì´ìƒ</td></tr>
            <tr style="background: #fef3c7;"><td>500ê°œ ì´ìƒ</td><td style="font-weight: 600; color: #059669;">1,000ì› ì´ìƒ</td></tr>
          </table>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">ğŸ“¦ í˜‘ìƒ ê²€í†  ìƒì„¸</div>
        <table class="product-table">
          <tr>
            <th>No</th>
            <th>ê³µê¸‰ì‚¬</th>
            <th>ìƒí’ˆëª…</th>
            <th>ê³µêµ¬íŒë§¤ê°€</th>
            <th>ê³µê¸‰ë‹¨ê°€</th>
            <th>ì…€ëŸ¬ë§ˆì§„ìœ¨</th>
            <th>ì…€ëŸ¬ë§ˆì§„(ì´)</th>
            <th>ëª¨ì—¬ë¼ë”œ(1ê°œ)</th>
            <th>ì˜ˆìƒìˆ˜ëŸ‰</th>
            <th>ì´ë²¤íŠ¸ë¹„ìš©</th>
            <th>PGìˆ˜ìˆ˜ë£Œ</th>
            <th>ìµœì¢…ìˆœë§ˆì§„</th>
            <th>íŒì •</th>
          </tr>
          ${productRows}
          <tr class="total-row">
            <td colspan="11" style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; font-size: 12px;">ì´ ìˆœë§ˆì§„</td>
            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; font-size: 14px; color: ${totalFinalProfit >= 0 ? '#059669' : '#dc2626'};">${totalFinalProfit.toLocaleString()}ì›</td>
            <td style="border: 1px solid #e5e7eb;"></td>
          </tr>
        </table>
      </div>
      
      <div class="footer">
        <p>â€» PGìˆ˜ìˆ˜ë£Œ: íŒë§¤ê¸ˆì•¡ì˜ 4% (ì¹´ë“œê²°ì œ ê¸°ì¤€)</p>
        <p>â€» ê³µê¸‰ë‹¨ê°€ëŠ” VAT í¬í•¨ ê¸ˆì•¡ ê¸°ì¤€</p>
        <p>â€» ì •ì‚°ì¼: ê³µêµ¬ ì¢…ë£Œ í›„ 3~7ì¼ ì´ë‚´</p>
      </div>
    </body>
    </html>
  `;
  
  // ìƒˆ ì°½ì—ì„œ PDF ì¶œë ¥
  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.onload = function() {
    printWindow.print();
  };
  showToast('PDF ì¸ì‡„ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤');
}

function exportCalcToExcel() {
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    script.onload = () => doExportCalc();
    return;
  }
  doExportCalc();
}

function doExportCalc() {
  const rows = document.querySelectorAll('#calcBody tr');
  const headers = ['No', 'ë¸Œëœë“œ', 'ìƒí’ˆëª…', 'ê³µêµ¬íŒë§¤ê°€', 'ê³µê¸‰ë‹¨ê°€(V+)', 'ì´ë§ˆì§„ê¸ˆ', 'ì…€ëŸ¬ë§ˆì§„ìœ¨(%)', 'ì…€ëŸ¬ë§ˆì§„ê¸ˆ', 'ëª¨ì—¬ë¼ë”œë§ˆì§„ìœ¨(%)', 'ëª¨ì—¬ë¼ë”œë§ˆì§„ê¸ˆ'];
  const data = [];
  
  rows.forEach((row, idx) => {
    const brandName = row.querySelector('.status-badge')?.textContent || '';
    const productName = row.querySelectorAll('td')[2]?.textContent || '';
    const salePrice = Number(row.querySelector('.calc-sale')?.dataset?.value) || 0;
    const supplyPrice = Number(row.querySelector('.calc-supply')?.dataset?.value) || 0;
    const sellerRate = Number(row.querySelector('.calc-seller-rate')?.value) || 0;
    
    if (!productName || productName === '-') return;
    
    const totalMargin = salePrice - supplyPrice;
    const sellerAmt = Math.round(salePrice * sellerRate / 100);
    const moyeoraMargin = totalMargin - sellerAmt;
    const moyeoraRate = salePrice > 0 ? (moyeoraMargin / salePrice * 100) : 0;
    
    data.push([idx + 1, brandName, productName, salePrice, supplyPrice, totalMargin, sellerRate + '%', sellerAmt, moyeoraRate.toFixed(1) + '%', moyeoraMargin]);
  });
  
  if (data.length === 0) { showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
  
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  ws['!cols'] = [{ wch: 5 }, { wch: 15 }, { wch: 30 }, { wch: 12 }, { wch: 14 }, { wch: 12 }, { wch: 14 }, { wch: 12 }, { wch: 16 }, { wch: 14 }];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ë§ˆì§„ê³„ì‚°');
  XLSX.writeFile(wb, `ë§ˆì§„ê³„ì‚°_${formatDate(new Date())}.xlsx`);
  showToast('ë§ˆì§„ ê³„ì‚° ê²°ê³¼ê°€ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤');
}

function openSupplierSettlementModal(item = null) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const isEdit = item !== null;
  const s = item || { brandName: '', sellerName: '', sellerId: '', dealPeriod: '', settlementDate: formatDate(new Date()), items: [], notes: '' };
  const brands = state.settlementBrands || [];
  const sellers = state.sellers || [];
  const settlementItems = s.items || [];
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header"><h2 class="modal-title">${isEdit ? 'ê³µê¸‰ì‚¬ ì •ì‚° ìˆ˜ì •' : 'ìƒˆ ê³µê¸‰ì‚¬ ì •ì‚° ë“±ë¡'}</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      <div style="background: #fef3c3; border-radius: 12px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #d97706;">
        <div style="font-weight: 600; color: var(--gray-600);">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚°</div>
        <div style="font-size: 13px; color: var(--gray-600);">ìƒí’ˆì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ê³  íŒë§¤ìˆ˜ëŸ‰ë§Œ ì…ë ¥í•˜ë©´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</div>
      </div>
      <form onsubmit="submitSupplierSettlement(event, '${s.id || ''}')">
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê³µê¸‰ì‚¬(ë¸Œëœë“œ) *</label><input type="text" class="form-input" id="sps-brandName" value="${s.brandName}" required placeholder="ì˜ˆ: ë¡œì§€ì˜¤ê°€ë‹‰" list="brand-list" onchange="onBrandNameChange()"><datalist id="brand-list">${brands.map(b => `<option value="${b.name}">`).join('')}</datalist></div>
          <div class="form-group">
            <label class="form-label">ì…€ëŸ¬ëª… *</label>
            <div style="position: relative;">
              <input type="text" class="form-input" id="sps-sellerName" value="${s.sellerName}" required placeholder="ì…€ëŸ¬ ê²€ìƒ‰..." autocomplete="off" oninput="filterSellerDropdown(this.value)" onfocus="showSellerDropdown()">
              <input type="hidden" id="sps-sellerId" value="${s.sellerId || ''}">
              <div id="seller-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; z-index: 100;">
                ${sellers.map(seller => `
                  <div class="seller-option" onclick="selectSeller('${seller.id}', '${seller.nickname || seller.name}')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--gray-100); transition: background 0.15s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='white'">
                    <div style="font-weight: 600; color: var(--gray-900);">${seller.nickname || '-'}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">${seller.name || ''} ${seller.phone ? 'Â· ' + seller.phone : ''}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê³µêµ¬ ê¸°ê°„</label><input type="text" class="form-input" id="sps-dealPeriod" value="${s.dealPeriod}" placeholder="2025-11-27~2025-11-30"></div>
          <div class="form-group"><label class="form-label">ì •ì‚°ì¼</label><input type="date" class="form-input" id="sps-settlementDate" value="${s.settlementDate}"></div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">íŒë§¤ê¸ˆì•¡ (ì†Œë¹„ì ê²°ì œ ì´ì•¡) *</label>
            <input type="number" class="form-input" id="sps-salesAmount" value="${s.salesAmount || ''}" required placeholder="ì˜ˆ: 49700" style="background: var(--gray-50); font-weight: 600; font-size: 16px;">
            <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ğŸ’¡ í•´ë‹¹ ê³µêµ¬ì˜ ì´ íŒë§¤ê¸ˆì•¡ (ì…€ëŸ¬ ì •ì‚°ì˜ íŒë§¤ê¸ˆì•¡ê³¼ ë™ì¼)</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <label class="form-label" style="margin: 0; font-weight: 600;">ğŸ“¦ ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ì…ë ¥</label>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn btn-primary btn-sm" onclick="openProductSearchModal()">ğŸ” ìƒí’ˆ ê²€ìƒ‰ ì¶”ê°€</button>
              <button type="button" class="btn btn-secondary btn-sm" onclick="openSupplierProductModal()">ìƒí’ˆ ê´€ë¦¬</button>
            </div>
          </div>
          
          <div id="sps-productsList" style="max-height: 350px; overflow-y: auto;">
            ${settlementItems.length === 0 ? `<div style="color: var(--gray-500); font-size: 13px; text-align: center; padding: 30px;">ğŸ” ìƒí’ˆ ê²€ìƒ‰ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒí’ˆì„ ì¶”ê°€í•˜ì„¸ìš”</div>` : `
              <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                <thead><tr style="background: var(--gray-200);"><th style="padding: 8px; text-align: left;">No.</th><th style="padding: 8px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ë‹¨ê°€(VAT+)</th><th style="padding: 8px; text-align: center; width: 80px; background: var(--gray-50);">íŒë§¤ìˆ˜ëŸ‰</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ê°€ì•¡</th><th style="padding: 8px; text-align: right;">ë¶€ê°€ì„¸(10%)</th><th style="padding: 8px; text-align: right; background: #d1fae5;">í•©ê³„ê¸ˆì•¡(VATí¬í•¨)</th><th style="width: 40px;"></th></tr></thead>
                <tbody>
                  ${settlementItems.map((si, idx) => `<tr style="border-bottom: 1px solid var(--gray-200);" data-product-id="${si.productId}" data-supply-price="${si.supplyPrice}"><td style="padding: 8px;">${idx + 1}</td><td style="padding: 8px;">${si.productName}</td><td style="padding: 8px; text-align: right;">${Number(si.supplyPrice).toLocaleString()}ì›</td><td style="padding: 4px; text-align: center;"><input type="number" class="form-input sps-qty" value="${si.quantity}" min="0" style="width: 70px; text-align: center; padding: 6px; background: var(--gray-50);" oninput="calculateSupplierRow(this)"></td><td style="padding: 8px; text-align: right;" class="sps-supply">0ì›</td><td style="padding: 8px; text-align: right;" class="sps-vat">0ì›</td><td style="padding: 8px; text-align: right; font-weight: 600; background: #ecfdf5;" class="sps-total">0ì›</td><td style="padding: 4px;"><button type="button" class="btn btn-secondary btn-sm" style="padding: 4px 8px; color: var(--danger);" onclick="removeSettlementProduct(this)">Ã—</button></td></tr>`).join('')}
                </tbody>
                <tfoot><tr style="background: var(--gray-100); font-weight: 700;"><td colspan="3" style="padding: 10px;">í•© ê³„</td><td style="padding: 10px; text-align: center;" id="sps-totalQty">0</td><td style="padding: 10px; text-align: right;" id="sps-totalSupply">0ì›</td><td style="padding: 10px; text-align: right;" id="sps-totalVat">0ì›</td><td style="padding: 10px; text-align: right; background: #d1fae5;" id="sps-grandTotal">0ì›</td><td></td></tr></tfoot>
              </table>
            `}
          </div>
        </div>
        
        <div class="form-group"><label class="form-label">ë¹„ê³ </label><textarea class="form-textarea" id="sps-notes" rows="2" placeholder="ì¶”ê°€ ë©”ëª¨">${s.notes || ''}</textarea></div>
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSupplierSettlement('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  setTimeout(() => { document.querySelectorAll('.sps-qty').forEach(input => calculateSupplierRow(input)); }, 100);
  
  // ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
  document.addEventListener('click', closeSellerDropdownOnOutsideClick);
}

// ì…€ëŸ¬ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
function showSellerDropdown() {
  const dropdown = document.getElementById('seller-dropdown');
  if (dropdown) {
    dropdown.style.display = 'block';
    filterSellerDropdown(document.getElementById('sps-sellerName').value);
  }
}

// ì…€ëŸ¬ ë“œë¡­ë‹¤ìš´ í•„í„°ë§
function filterSellerDropdown(searchText) {
  const dropdown = document.getElementById('seller-dropdown');
  if (!dropdown) return;
  
  const sellers = state.sellers || [];
  const filtered = sellers.filter(seller => {
    const nickname = (seller.nickname || '').toLowerCase();
    const name = (seller.name || '').toLowerCase();
    const search = searchText.toLowerCase();
    return nickname.includes(search) || name.includes(search);
  });
  
  dropdown.innerHTML = filtered.length === 0 
    ? `<div style="padding: 16px; text-align: center; color: var(--gray-500);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>`
    : filtered.map(seller => `
      <div class="seller-option" onclick="selectSeller('${seller.id}', '${seller.nickname || seller.name}')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--gray-100); transition: background 0.15s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='white'">
        <div style="font-weight: 600; color: var(--gray-900);">${seller.nickname || '-'}</div>
        <div style="font-size: 12px; color: var(--gray-500);">${seller.name || ''} ${seller.phone ? 'Â· ' + seller.phone : ''}</div>
      </div>
    `).join('');
  
  dropdown.style.display = 'block';
}

// ì…€ëŸ¬ ì„ íƒ
function selectSeller(sellerId, sellerNickname) {
  document.getElementById('sps-sellerName').value = sellerNickname;
  document.getElementById('sps-sellerId').value = sellerId;
  document.getElementById('seller-dropdown').style.display = 'none';
  
  // í•´ë‹¹ ì…€ëŸ¬ì˜ íƒ€ì‚¬ìƒí’ˆ ì •ì‚° ë‚´ì—­ì—ì„œ íŒë§¤ê¸ˆì•¡ ìë™ ì—°ë™
  const brandName = document.getElementById('sps-brandName').value;
  if (brandName && sellerId) {
    autoFillSalesAmount(sellerId, sellerNickname, brandName);
  }
}

// íŒë§¤ê¸ˆì•¡ ìë™ ì—°ë™ (ì…€ëŸ¬ ì •ì‚°ì—ì„œ ë™ì¼ ê³µêµ¬ ì°¾ê¸°)
function autoFillSalesAmount(sellerId, sellerNickname, brandName) {
  const sellerSettlements = state.sellerSettlements || [];
  
  // ë™ì¼ ì…€ëŸ¬ + ë™ì¼ ë¸Œëœë“œì˜ ìµœê·¼ ì •ì‚° ì°¾ê¸°
  const matchingSettlement = sellerSettlements.find(s => {
    const matchSeller = s.sellerId === sellerId || (s.sellerName || '').includes(sellerNickname);
    const matchBrand = (s.brandName || '').includes(brandName) || (brandName || '').includes(s.brandName || '');
    return matchSeller && matchBrand && !s.isInhouse;
  });
  
  if (matchingSettlement && matchingSettlement.salesAmount) {
    const salesAmountInput = document.getElementById('sps-salesAmount');
    if (salesAmountInput && !salesAmountInput.value) {
      salesAmountInput.value = matchingSettlement.salesAmount;
      showToast(`ì…€ëŸ¬ ì •ì‚°ì—ì„œ íŒë§¤ê¸ˆì•¡ ${Number(matchingSettlement.salesAmount).toLocaleString()}ì›ì´ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤`);
    }
  }
}

// ë¸Œëœë“œëª… ë³€ê²½ ì‹œ ìë™ ì—°ë™ íŠ¸ë¦¬ê±°
function onBrandNameChange() {
  const brandName = document.getElementById('sps-brandName').value;
  const sellerId = document.getElementById('sps-sellerId')?.value;
  const sellerNickname = document.getElementById('sps-sellerName').value;
  
  if (brandName && (sellerId || sellerNickname)) {
    autoFillSalesAmount(sellerId, sellerNickname, brandName);
  }
}

// ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
function closeSellerDropdownOnOutsideClick(e) {
  const dropdown = document.getElementById('seller-dropdown');
  const input = document.getElementById('sps-sellerName');
  if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
    dropdown.style.display = 'none';
  }
}

// ìƒí’ˆ ê²€ìƒ‰ ëª¨ë‹¬
function openProductSearchModal() {
  const products = state.supplierProducts || [];
  const brands = [...new Set(products.map(p => p.brandName))];
  
  const searchModal = document.createElement('div');
  searchModal.id = 'productSearchModal';
  searchModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  searchModal.innerHTML = `
    <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">ğŸ” ìƒí’ˆ ê²€ìƒ‰</h3>
        <button onclick="document.getElementById('productSearchModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
      </div>
      <div style="padding: 16px; border-bottom: 1px solid var(--gray-200);">
        <div style="display: flex; gap: 8px;">
          <select id="search-brand-filter" class="form-input" style="width: 150px;" onchange="filterSearchProducts()">
            <option value="">ì „ì²´ ë¸Œëœë“œ</option>
            ${brands.map(b => `<option value="${b}">${b}</option>`).join('')}
          </select>
          <input type="text" id="search-product-input" class="form-input" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." oninput="filterSearchProducts()" style="flex: 1;">
        </div>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 16px;" id="search-results">
        ${renderSearchResults(products)}
      </div>
      <div style="padding: 16px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 13px; color: var(--gray-600);"><span id="selected-count">0</span>ê°œ ì„ íƒë¨</span>
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('productSearchModal').remove()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="addSelectedProducts()">ì„ íƒ ìƒí’ˆ ì¶”ê°€</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(searchModal);
}

function renderSearchResults(products) {
  if (products.length === 0) {
    return '<div style="text-align: center; padding: 40px; color: var(--gray-500);">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>';
  }
  
  // ì´ë¯¸ ì¶”ê°€ëœ ìƒí’ˆ ID ëª©ë¡
  const existingIds = [];
  document.querySelectorAll('#sps-productsList tbody tr').forEach(tr => {
    if (tr.dataset.productId) existingIds.push(tr.dataset.productId);
  });
  
  return `
    <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
      <thead><tr style="background: var(--gray-100);"><th style="padding: 8px; width: 40px;"></th><th style="padding: 8px; text-align: left;">ë¸Œëœë“œ</th><th style="padding: 8px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ë‹¨ê°€</th></tr></thead>
      <tbody>
        ${products.map(p => {
          const isExisting = existingIds.includes(p.id);
          return `<tr style="border-bottom: 1px solid var(--gray-200); ${isExisting ? 'opacity: 0.5;' : ''}" data-product='${JSON.stringify(p).replace(/'/g, "&#39;")}'>
            <td style="padding: 8px; text-align: center;">
              <input type="checkbox" class="search-checkbox" ${isExisting ? 'disabled checked' : ''} onchange="updateSelectedCount()" style="width: 18px; height: 18px; cursor: ${isExisting ? 'not-allowed' : 'pointer'};">
            </td>
            <td style="padding: 8px;"><span class="status-badge status-negotiating" style="font-size: 11px;">${p.brandName}</span></td>
            <td style="padding: 8px;">${p.productName}</td>
            <td style="padding: 8px; text-align: right; font-weight: 600;">${Number(p.supplyPrice).toLocaleString()}ì›</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  `;
}

function filterSearchProducts() {
  const brandFilter = document.getElementById('search-brand-filter').value;
  const searchText = document.getElementById('search-product-input').value.toLowerCase();
  const products = state.supplierProducts || [];
  
  const filtered = products.filter(p => {
    const matchBrand = !brandFilter || p.brandName === brandFilter;
    const matchText = !searchText || p.productName.toLowerCase().includes(searchText) || p.brandName.toLowerCase().includes(searchText);
    return matchBrand && matchText;
  });
  
  document.getElementById('search-results').innerHTML = renderSearchResults(filtered);
  updateSelectedCount();
}

function updateSelectedCount() {
  const count = document.querySelectorAll('.search-checkbox:checked:not(:disabled)').length;
  const countEl = document.getElementById('selected-count');
  if (countEl) countEl.textContent = count;
}

function addSelectedProducts() {
  const selectedProducts = [];
  document.querySelectorAll('.search-checkbox:checked:not(:disabled)').forEach(checkbox => {
    const row = checkbox.closest('tr');
    const productData = JSON.parse(row.dataset.product);
    selectedProducts.push(productData);
  });
  
  if (selectedProducts.length === 0) {
    showToast('ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // ìƒí’ˆ ëª©ë¡ í…Œì´ë¸”ì— ì¶”ê°€
  const container = document.getElementById('sps-productsList');
  let tbody = container.querySelector('tbody');
  
  if (!tbody) {
    // ì²« ìƒí’ˆ ì¶”ê°€ ì‹œ í…Œì´ë¸” ìƒì„±
    container.innerHTML = `
      <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
        <thead><tr style="background: var(--gray-200);"><th style="padding: 8px; text-align: left;">No.</th><th style="padding: 8px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ë‹¨ê°€(VAT+)</th><th style="padding: 8px; text-align: center; width: 80px; background: var(--gray-50);">íŒë§¤ìˆ˜ëŸ‰</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ê°€ì•¡</th><th style="padding: 8px; text-align: right;">ë¶€ê°€ì„¸(10%)</th><th style="padding: 8px; text-align: right; background: #d1fae5;">í•©ê³„ê¸ˆì•¡(VATí¬í•¨)</th><th style="width: 40px;"></th></tr></thead>
        <tbody></tbody>
        <tfoot><tr style="background: var(--gray-100); font-weight: 700;"><td colspan="3" style="padding: 10px;">í•© ê³„</td><td style="padding: 10px; text-align: center;" id="sps-totalQty">0</td><td style="padding: 10px; text-align: right;" id="sps-totalSupply">0ì›</td><td style="padding: 10px; text-align: right;" id="sps-totalVat">0ì›</td><td style="padding: 10px; text-align: right; background: #d1fae5;" id="sps-grandTotal">0ì›</td><td></td></tr></tfoot>
      </table>
    `;
    tbody = container.querySelector('tbody');
  }
  
  // ê¸°ì¡´ í–‰ ê°œìˆ˜
  const existingCount = tbody.querySelectorAll('tr').length;
  
  selectedProducts.forEach((p, idx) => {
    const rowNum = existingCount + idx + 1;
    const newRow = document.createElement('tr');
    newRow.style.cssText = 'border-bottom: 1px solid var(--gray-200);';
    newRow.dataset.productId = p.id;
    newRow.dataset.supplyPrice = p.supplyPrice;
    newRow.innerHTML = `
      <td style="padding: 8px;">${rowNum}</td>
      <td style="padding: 8px;">${p.productName}</td>
      <td style="padding: 8px; text-align: right;">${Number(p.supplyPrice).toLocaleString()}ì›</td>
      <td style="padding: 4px; text-align: center;"><input type="number" class="form-input sps-qty" value="0" min="0" style="width: 70px; text-align: center; padding: 6px; background: var(--gray-50);" oninput="calculateSupplierRow(this)"></td>
      <td style="padding: 8px; text-align: right;" class="sps-supply">0ì›</td>
      <td style="padding: 8px; text-align: right;" class="sps-vat">0ì›</td>
      <td style="padding: 8px; text-align: right; font-weight: 600; background: #ecfdf5;" class="sps-total">0ì›</td>
      <td style="padding: 4px;"><button type="button" class="btn btn-secondary btn-sm" style="padding: 4px 8px; color: var(--danger);" onclick="removeSettlementProduct(this)">Ã—</button></td>
    `;
    tbody.appendChild(newRow);
  });
  
  // í–‰ ë²ˆí˜¸ ì¬ì •ë ¬
  renumberSettlementRows();
  
  document.getElementById('productSearchModal').remove();
  showToast(`${selectedProducts.length}ê°œ ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
}

function removeSettlementProduct(btn) {
  btn.closest('tr').remove();
  renumberSettlementRows();
  // í•©ê³„ ì¬ê³„ì‚°
  const firstQty = document.querySelector('.sps-qty');
  if (firstQty) calculateSupplierRow(firstQty);
  else {
    // ëª¨ë“  ìƒí’ˆ ì‚­ì œë¨
    document.getElementById('sps-productsList').innerHTML = `<div style="color: var(--gray-500); font-size: 13px; text-align: center; padding: 30px;">ğŸ” ìƒí’ˆ ê²€ìƒ‰ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒí’ˆì„ ì¶”ê°€í•˜ì„¸ìš”</div>`;
  }
}

function renumberSettlementRows() {
  document.querySelectorAll('#sps-productsList tbody tr').forEach((tr, idx) => {
    tr.querySelector('td:first-child').textContent = idx + 1;
  });
}

function loadBrandProducts() {
  // ì´ì „ í˜¸í™˜ì„± ìœ ì§€ (ì‚¬ìš© ì•ˆí•¨)
}

function calculateSupplierRow(input) {
  const row = input.closest('tr');
  const supplyPrice = Number(row.dataset.supplyPrice) || 0;
  const quantity = Number(input.value) || 0;
  const supplyAmount = Math.round(supplyPrice * quantity / 1.1);
  const vatAmount = Math.round(supplyAmount * 0.1);
  const totalAmount = supplyAmount + vatAmount;
  
  row.querySelector('.sps-supply').textContent = supplyAmount.toLocaleString() + 'ì›';
  row.querySelector('.sps-vat').textContent = vatAmount.toLocaleString() + 'ì›';
  row.querySelector('.sps-total').textContent = totalAmount.toLocaleString() + 'ì›';
  
  let totalQty = 0, totalSupply = 0, totalVat = 0, grandTotal = 0;
  document.querySelectorAll('#sps-productsList tbody tr').forEach(tr => {
    const qty = Number(tr.querySelector('.sps-qty')?.value) || 0;
    const price = Number(tr.dataset.supplyPrice) || 0;
    const supply = Math.round(price * qty / 1.1);
    const vat = Math.round(supply * 0.1);
    totalQty += qty; totalSupply += supply; totalVat += vat; grandTotal += supply + vat;
  });
  
  if (document.getElementById('sps-totalQty')) document.getElementById('sps-totalQty').textContent = totalQty;
  if (document.getElementById('sps-totalSupply')) document.getElementById('sps-totalSupply').textContent = totalSupply.toLocaleString() + 'ì›';
  if (document.getElementById('sps-totalVat')) document.getElementById('sps-totalVat').textContent = totalVat.toLocaleString() + 'ì›';
  if (document.getElementById('sps-grandTotal')) document.getElementById('sps-grandTotal').textContent = grandTotal.toLocaleString() + 'ì›';
}

async function submitSupplierSettlement(e, id) {
  e.preventDefault();
  const items = [];
  let totalQuantity = 0, totalSupplyAmount = 0, totalVatAmount = 0, totalAmount = 0;
  
  document.querySelectorAll('#sps-productsList tbody tr').forEach(tr => {
    const productId = tr.dataset.productId;
    const supplyPrice = Number(tr.dataset.supplyPrice) || 0;
    const quantity = Number(tr.querySelector('.sps-qty')?.value) || 0;
    if (quantity > 0) {
      const supplyAmount = Math.round(supplyPrice * quantity / 1.1);
      const vatAmount = Math.round(supplyAmount * 0.1);
      const productName = tr.querySelectorAll('td')[1].textContent;
      items.push({ productId, productName, supplyPrice, quantity, supplyAmount, vatAmount, totalAmount: supplyAmount + vatAmount });
      totalQuantity += quantity; totalSupplyAmount += supplyAmount; totalVatAmount += vatAmount; totalAmount += supplyAmount + vatAmount;
    }
  });
  
  // supplierId ì°¾ê¸° (ë¸Œëœë“œëª…ìœ¼ë¡œ ë§¤ì¹­)
  const brandNameValue = document.getElementById('sps-brandName').value;
  const matchedSupplier = state.suppliers.find(s => s.name === brandNameValue);
  const supplierId = matchedSupplier?.id || '';
  
  const data = {
    brandName: brandNameValue, 
    supplierId: supplierId,
    sellerName: document.getElementById('sps-sellerName').value,
    sellerId: document.getElementById('sps-sellerId')?.value || '',
    dealPeriod: document.getElementById('sps-dealPeriod').value, 
    settlementDate: document.getElementById('sps-settlementDate').value,
    salesAmount: Number(document.getElementById('sps-salesAmount').value) || 0,
    items, totalQuantity, totalSupplyAmount, totalVatAmount, totalAmount,
    notes: document.getElementById('sps-notes').value, updatedAt: new Date().toISOString()
  };
  
  try {
    if (id) { await db.collection('supplierSettlements').doc(id).update(data); }
    else { data.createdAt = new Date().toISOString(); await db.collection('supplierSettlements').add(data); }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤'); closeModal();
  } catch(err) { showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

async function deleteSupplierSettlement(id) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try { await db.collection('supplierSettlements').doc(id).delete(); showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); closeModal(); } catch(err) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

// ì´ë²¤íŠ¸ë¹„ìš© ì„¤ì • ëª¨ë‹¬
function openEventCostModal() {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const eventCost = state.eventCost || 0;
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header"><h2 class="modal-title">ğŸ ì´ë²¤íŠ¸ë¹„ìš© ì„¤ì •</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      <div style="padding: 20px 0;">
        <div style="background: #fef3c3; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="font-size: 13px; color: var(--gray-600);">
            <strong>ì´ë²¤íŠ¸ë¹„ìš©ì´ë€?</strong><br>
            ì…€ëŸ¬ì—ê²Œ ë¬´ë£Œë¡œ ì§€ì›í•œ ì„œë¹„ìŠ¤ ë¹„ìš©ì…ë‹ˆë‹¤.<br>
            ì˜ˆ: ë¬´ë£Œ ë°°ì†¡ë¹„ ì§€ì›, ìƒ˜í”Œ ì œê³µ, í”„ë¡œëª¨ì…˜ ë¹„ìš© ë“±
          </div>
        </div>
        <form onsubmit="saveEventCost(event)">
          <div class="form-group">
            <label class="form-label">ì´ë²¤íŠ¸ë¹„ìš© (ì›)</label>
            <input type="number" class="form-input" id="event-cost-input" value="${eventCost}" placeholder="0" style="font-size: 18px; text-align: right;">
          </div>
          <div style="background: var(--gray-50); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; font-size: 14px;">
              <span style="color: var(--gray-600);">í˜„ì¬ ì„¤ì •ëœ ì´ë²¤íŠ¸ë¹„ìš©</span>
              <span style="font-weight: 700; color: var(--danger);">${eventCost.toLocaleString()}ì›</span>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
          </div>
        </form>
      </div>
    </div>
  `;
}

async function saveEventCost(e) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();
  const eventCost = Number(document.getElementById('event-cost-input').value) || 0;
  
  try {
    // settings ì»¬ë ‰ì…˜ì— ì €ì¥
    await db.collection('settings').doc('eventCost').set({ value: eventCost, updatedAt: new Date().toISOString() });
    state.eventCost = eventCost;
    showToast('ì´ë²¤íŠ¸ë¹„ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    render();
  } catch(err) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function openBrandManageModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const suppliers = state.suppliers || [];
  
  // ê³µê¸‰ì‚¬ë¥¼ ìœ í˜•ë³„ë¡œ ë¶„ë¥˜
  const inhouseSuppliers = suppliers.filter(s => s.supplierType === 'inhouse');
  const externalSuppliers = suppliers.filter(s => s.supplierType !== 'inhouse');
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header"><h2 class="modal-title">ğŸ·ï¸ ë¸Œëœë“œ(ê³µê¸‰ì‚¬) ê´€ë¦¬</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      
      <div style="background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 20px;">ğŸ’¡</span>
          <strong style="color: var(--gray-600);">ê³µê¸‰ì‚¬ ì •ë³´ ì—°ë™</strong>
        </div>
        <p style="color: var(--gray-500); font-size: 13px; margin: 0;">
          ì™¼ìª½ ë©”ë‰´ì˜ <strong>'ê³µê¸‰ì‚¬'</strong>ì—ì„œ ë“±ë¡í•œ ë°ì´í„°ì™€ ì—°ë™ë©ë‹ˆë‹¤.<br>
          ìƒˆ ê³µê¸‰ì‚¬ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ ê³µê¸‰ì‚¬ ë©”ë‰´ì—ì„œ ë“±ë¡í•˜ì„¸ìš”.
        </p>
        <button class="btn btn-sm" style="margin-top: 12px; background: var(--gray-600); color: #fff;" onclick="closeModal(); setTab('suppliers')">
          ğŸ­ ê³µê¸‰ì‚¬ ê´€ë¦¬ ë°”ë¡œê°€ê¸°
        </button>
      </div>
      
      <div style="max-height: 400px; overflow-y: auto;">
        <!-- ìì‚¬ ê³µê¸‰ì‚¬ -->
        <div style="margin-bottom: 20px;">
          <h3 style="font-size: 14px; color: var(--info); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span style="background: var(--info); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">ìì‚¬</span>
            ìì‚¬ ê³µê¸‰ì‚¬ (${inhouseSuppliers.length}ê°œ)
          </h3>
          ${inhouseSuppliers.length === 0 ? 
            '<div style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">ìì‚¬ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
            `<table class="data-table" style="font-size: 13px;">
              <thead><tr><th>ê³µê¸‰ì‚¬ëª…</th><th>ë‹´ë‹¹ì</th><th>ê³„ì•½ìƒíƒœ</th></tr></thead>
              <tbody>${inhouseSuppliers.map(s => `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td>${s.managerName || '-'}</td>
                  <td><span class="status-badge ${s.contractStatus === 'completed' ? 'status-confirmed' : 'status-negotiating'}">${s.contractStatus === 'completed' ? 'ê³„ì•½ì™„ë£Œ' : 'í˜‘ì˜ì¤‘'}</span></td>
                </tr>
              `).join('')}</tbody>
            </table>`
          }
        </div>
        
        <!-- íƒ€ì‚¬ ê³µê¸‰ì‚¬ -->
        <div>
          <h3 style="font-size: 14px; color: var(--success); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span style="background: var(--success); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">íƒ€ì‚¬</span>
            íƒ€ì‚¬ ê³µê¸‰ì‚¬ (${externalSuppliers.length}ê°œ)
          </h3>
          ${externalSuppliers.length === 0 ? 
            '<div style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">íƒ€ì‚¬ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
            `<table class="data-table" style="font-size: 13px;">
              <thead><tr><th>ê³µê¸‰ì‚¬ëª…</th><th>ë‹´ë‹¹ì</th><th>ê³„ì•½ìƒíƒœ</th></tr></thead>
              <tbody>${externalSuppliers.map(s => `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td>${s.managerName || '-'}</td>
                  <td><span class="status-badge ${s.contractStatus === 'completed' ? 'status-confirmed' : 'status-negotiating'}">${s.contractStatus === 'completed' ? 'ê³„ì•½ì™„ë£Œ' : 'í˜‘ì˜ì¤‘'}</span></td>
                </tr>
              `).join('')}</tbody>
            </table>`
          }
        </div>
      </div>
      
      <div class="modal-footer" style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// ê¸°ì¡´ settlementBrands ê´€ë ¨ í•¨ìˆ˜ ìœ ì§€ (í˜¸í™˜ì„±)
async function addBrand(e) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();
  const data = { name: document.getElementById('new-brand-name').value, type: document.getElementById('new-brand-type').value || 'íƒ€ì‚¬', defaultMarginRate: Number(document.getElementById('new-brand-rate').value) || 20, createdAt: new Date().toISOString() };
  try { await db.collection('settlementBrands').add(data); showToast('ë¸Œëœë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤'); openBrandManageModal(); } catch(err) { showToast('ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

async function deleteBrand(id) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try { await db.collection('settlementBrands').doc(id).delete(); showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); openBrandManageModal(); } catch(err) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

// ë¸Œëœë“œ ì„ íƒ ë³€ê²½ í•¸ë“¤ëŸ¬
function handleBrandChange(select) {
  const customInput = document.getElementById('ss-brandNameCustom');
  if (select.value === '_other') {
    customInput.style.display = 'block';
    customInput.focus();
  } else {
    customInput.style.display = 'none';
    customInput.value = '';
  }
}

// ì…€ëŸ¬ëª… ì„ íƒ ë³€ê²½ í•¸ë“¤ëŸ¬
function handleSellerNameChange(select) {
  const customInput = document.getElementById('ss-sellerNameCustom');
  if (select.value === '_other') {
    customInput.style.display = 'block';
    customInput.focus();
  } else {
    customInput.style.display = 'none';
    customInput.value = '';
  }
}

// íŒë§¤ì•¡ ê¸°ì¤€ ì…€ëŸ¬ í‹°ì–´ ë¦¬ìŠ¤íŠ¸ í† ê¸€
function toggleSellerTierList(tier) {
  const el = document.getElementById(`seller-tier-${tier}`);
  if (el) {
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }
}

// ê³µê¸‰ì‚¬ í•„ë“œ ì¸ë¼ì¸ ì—…ë°ì´íŠ¸
async function updateSupplierField(supplierId, field, value) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  try {
    const supplierRef = db.collection('suppliers').doc(supplierId);
    await supplierRef.update({ [field]: value });
    
    // state ì—…ë°ì´íŠ¸
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (supplier) {
      supplier[field] = value;
    }
    
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    renderSuppliers();
  } catch (error) {
    console.error('ê³µê¸‰ì‚¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì…€ëŸ¬ í•„ë“œ ì¸ë¼ì¸ ì—…ë°ì´íŠ¸
async function updateSellerField(sellerId, field, value) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  try {
    const sellerRef = db.collection('sellers').doc(sellerId);
    await sellerRef.update({ [field]: value });
    
    // state ì—…ë°ì´íŠ¸
    const seller = state.sellers.find(s => s.id === sellerId);
    if (seller) {
      seller[field] = value;
    }
    
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    renderSellers();
  } catch (error) {
    console.error('ì…€ëŸ¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³µê¸‰ì‚¬ ì„œë¥˜ íŒŒì¼ ì—…ë¡œë“œ (Base64ë¡œ ì €ì¥)
async function uploadSupplierDocument(supplierId, docType, file) {
  if (!file) {
    showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  console.log('ì—…ë¡œë“œ ì‹œì‘:', { supplierId, docType, fileName: file.name, fileSize: file.size, fileType: file.type });
  
  // íŒŒì¼ í¬ê¸° ì œí•œ (10MB ì›ë³¸ ê¸°ì¤€)
  if (file.size > 10 * 1024 * 1024) {
    showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    return;
  }
  
  // í—ˆìš©ëœ íŒŒì¼ í˜•ì‹ í™•ì¸
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
  if (!allowedTypes.includes(file.type)) {
    showToast('JPG, PNG, PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    return;
  }
  
  showToast('íŒŒì¼ ì²˜ë¦¬ ì¤‘...');
  
  try {
    let base64Data;
    const fileName = file.name;
    const fileType = file.type;
    
    // ì´ë¯¸ì§€ì¸ ê²½ìš° ì••ì¶•
    if (file.type.startsWith('image/') && file.type !== 'image/gif') {
      base64Data = await compressImage(file, 800, 0.7); // ìµœëŒ€ 800px, í’ˆì§ˆ 70%
      console.log('ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ:', Math.round(base64Data.length / 1024) + 'KB');
    } else {
      // PDFë‚˜ GIFëŠ” ê·¸ëŒ€ë¡œ
      base64Data = await readFileAsBase64(file);
    }
    
    // Firebase ë¬¸ì„œ í¬ê¸° ì œí•œ ì²´í¬ (ì•½ 700KBê¹Œì§€ ì•ˆì „)
    if (base64Data.length > 700000) {
      showToast('íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ë” ì‘ì€ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    let fieldName, fileNameField, fileTypeField, checkField;
    if (docType === 'businessLicense') {
      fieldName = 'businessLicenseData';
      fileNameField = 'businessLicenseFileName';
      fileTypeField = 'businessLicenseFileType';
      checkField = 'hasBusinessLicense';
    } else if (docType === 'bankAccount') {
      fieldName = 'bankAccountData';
      fileNameField = 'bankAccountFileName';
      fileTypeField = 'bankAccountFileType';
      checkField = 'hasBankAccount';
    } else if (docType === 'contract') {
      fieldName = 'contractData';
      fileNameField = 'contractFileName';
      fileTypeField = 'contractFileType';
      checkField = 'hasContract';
    }
    
    const updatePayload = {
      [fieldName]: base64Data,
      [fileNameField]: fileName,
      [fileTypeField]: fileType,
      [checkField]: true,
      updatedAt: new Date().toISOString()
    };
    
    await db.collection('suppliers').doc(supplierId).update(updatePayload);
    
    console.log('Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    
    // state ì—…ë°ì´íŠ¸
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (supplier) {
      supplier[fieldName] = base64Data;
      supplier[fileNameField] = fileName;
      supplier[fileTypeField] = fileType;
      supplier[checkField] = true;
    }
    
    showToast('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    renderSuppliers();
  } catch (error) {
    console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
  }
}

// ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
function compressImage(file, maxSize, quality) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // í¬ê¸° ì¡°ì •
        if (width > maxSize || height > maxSize) {
          if (width > height) {
            height = Math.round(height * maxSize / width);
            width = maxSize;
          } else {
            width = Math.round(width * maxSize / height);
            height = maxSize;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // JPEGë¡œ ì••ì¶•
        const compressedData = canvas.toDataURL('image/jpeg', quality);
        resolve(compressedData);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// íŒŒì¼ì„ Base64ë¡œ ì½ê¸°
function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ì„œë¥˜ ë³´ê¸° (ìƒˆ ì°½ì—ì„œ ì—´ê¸°)
function viewDocument(supplierId, docType) {
  const supplier = state.suppliers.find(s => s.id === supplierId);
  if (!supplier) return;
  
  let fieldName, fileNameField, fileTypeField, docTitle;
  if (docType === 'businessLicense') {
    fieldName = 'businessLicenseData';
    fileNameField = 'businessLicenseFileName';
    fileTypeField = 'businessLicenseFileType';
    docTitle = 'ì‚¬ì—…ìë“±ë¡ì¦';
  } else if (docType === 'bankAccount') {
    fieldName = 'bankAccountData';
    fileNameField = 'bankAccountFileName';
    fileTypeField = 'bankAccountFileType';
    docTitle = 'í†µì¥ì‚¬ë³¸';
  } else if (docType === 'contract') {
    fieldName = 'contractData';
    fileNameField = 'contractFileName';
    fileTypeField = 'contractFileType';
    docTitle = 'ê³„ì•½ì„œ';
  }
  
  const data = supplier[fieldName];
  const fileName = supplier[fileNameField] || 'ë¬¸ì„œ';
  const fileType = supplier[fileTypeField] || 'image/png';
  
  if (!data) {
    showToast('ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ìƒˆ ì°½ì—ì„œ ë¬¸ì„œ ë³´ê¸°
  const newWindow = window.open('', '_blank');
  newWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>${supplier.name} - ${docTitle}</title>
      <style>
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          margin: 0; 
          padding: 20px; 
          background: #f5f5f5;
        }
        .header {
          background: white;
          padding: 16px 24px;
          border-radius: 12px;
          margin-bottom: 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .header h1 {
          margin: 0;
          font-size: 18px;
          color: #333;
        }
        .header .info {
          font-size: 14px;
          color: #666;
        }
        .btn {
          padding: 8px 16px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
        }
        .btn-primary {
          background: #f97316;
          color: white;
        }
        .btn-danger {
          background: #dc2626;
          color: white;
          margin-left: 8px;
        }
        .content {
          background: white;
          padding: 24px;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          text-align: center;
        }
        img {
          max-width: 100%;
          height: auto;
          border-radius: 8px;
        }
        iframe {
          width: 100%;
          height: 80vh;
          border: none;
          border-radius: 8px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <div>
          <h1>ğŸ“„ ${supplier.name} - ${docTitle}</h1>
          <div class="info">íŒŒì¼ëª…: ${fileName}</div>
        </div>
        <div>
          <a href="${data}" download="${fileName}" class="btn btn-primary">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</a>
          <button class="btn btn-danger" onclick="if(confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { window.opener.deleteSupplierDocument('${supplierId}', '${docType}'); window.close(); }">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>
      </div>
      <div class="content">
        ${fileType.includes('pdf') ? 
          `<iframe src="${data}"></iframe>` :
          `<img src="${data}" alt="${docTitle}">`
        }
      </div>
    </body>
    </html>
  `);
  newWindow.document.close();
}

// ì„œë¥˜ ì‚­ì œ
async function deleteSupplierDocument(supplierId, docType) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  try {
    const fieldName = docType === 'businessLicense' ? 'businessLicenseData' : 'bankAccountData';
    const fileNameField = docType === 'businessLicense' ? 'businessLicenseFileName' : 'bankAccountFileName';
    const fileTypeField = docType === 'businessLicense' ? 'businessLicenseFileType' : 'bankAccountFileType';
    
    const supplierRef = db.collection('suppliers').doc(supplierId);
    await supplierRef.update({
      [fieldName]: firebase.firestore.FieldValue.delete(),
      [fileNameField]: firebase.firestore.FieldValue.delete(),
      [fileTypeField]: firebase.firestore.FieldValue.delete()
    });
    
    // state ì—…ë°ì´íŠ¸
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (supplier) {
      delete supplier[fieldName];
      delete supplier[fileNameField];
      delete supplier[fileTypeField];
    }
    
    renderSuppliers();
  } catch (error) {
    console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
    alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ========== ê³µê¸‰ì‚¬ ì •ì‚°ì„œ(ì¸ë³´ì´ìŠ¤) ê¸°ëŠ¥ ==========

// ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ëª©ë¡ ëª¨ë‹¬
function openSupplierInvoiceList() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const settlements = state.supplierSettlements || [];
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ§¾ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ë°œí–‰</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 16px; background: var(--gray-50); border-bottom: 1px solid #bbf7d0;">
        <p style="margin: 0; font-size: 13px; color: #166534;">
          ğŸ’¡ ê³µê¸‰ì‚¬ì—ê²Œ ë°œì†¡í•  ì •ì‚°ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê° ì •ì‚° ê±´ë³„ë¡œ ì •ì‚°ì„œë¥¼ ì¶œë ¥í•˜ê±°ë‚˜ HTML íŒŒì¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
      </div>
      
      <div style="flex: 1; overflow-y: auto; padding: 16px;">
        ${settlements.length === 0 ? '<div class="empty-state"><div class="icon">ğŸ§¾</div><div class="text">ë°œí–‰í•  ê³µê¸‰ì‚¬ ì •ì‚°ì´ ì—†ìŠµë‹ˆë‹¤<br><small>ë¨¼ì € ê³µê¸‰ì‚¬ ì •ì‚°ì„ ë“±ë¡í•´ì£¼ì„¸ìš”</small></div></div>' : `
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr style="background: var(--gray-100);">
                <th>ë¸Œëœë“œ(ê³µê¸‰ì‚¬)</th>
                <th>ì…€ëŸ¬</th>
                <th>ê³µêµ¬ê¸°ê°„</th>
                <th style="text-align: center;">ìˆ˜ëŸ‰</th>
                <th style="text-align: right;">í•©ê³„ê¸ˆì•¡(V+)</th>
                <th style="text-align: center;">ì •ì‚°ì¼</th>
                <th style="width: 100px;"></th>
              </tr>
            </thead>
            <tbody>
              ${settlements.map(s => `
                <tr>
                  <td><strong>${s.brandName || '-'}</strong></td>
                  <td>${s.sellerName || '-'}</td>
                  <td style="font-size: 12px;">${s.dealPeriod || '-'}</td>
                  <td style="text-align: center;">${s.totalQuantity || 0}</td>
                  <td style="text-align: right; font-weight: 600; color: var(--gray-600);">${Number(s.totalAmount || 0).toLocaleString()}ì›</td>
                  <td style="text-align: center;">${s.settlementDate || '-'}</td>
                  <td class="actions">
                    <button class="btn btn-primary btn-sm" onclick="generateSupplierInvoice('${s.id}')" style="background: #059669;">ì •ì‚°ì„œ ìƒì„±</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `}
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// ê°œë³„ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ìƒì„±
function generateSupplierInvoice(settlementId) {
  const settlement = state.supplierSettlements.find(s => s.id === settlementId);
  if (!settlement) {
    showToast('ì •ì‚° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // ê³µê¸‰ì‚¬ ì •ë³´ ì°¾ê¸°
  const supplier = state.suppliers.find(sup => sup.name === settlement.brandName) || {};
  
  // ì…€ëŸ¬ ì •ë³´ ì°¾ê¸°
  const seller = state.sellers.find(sel => sel.id === settlement.sellerId) || 
                 state.sellers.find(sel => sel.nickname === settlement.sellerName) || {};
  const sellerNickname = seller.nickname || settlement.sellerName || '-';
  const sellerLink = seller.sns || seller.instagramLink || '';
  
  // ìƒí’ˆ ì •ë³´ (items í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°)
  const products = settlement.items || settlement.products || [];
  
  // ì˜¤ëŠ˜ ë‚ ì§œ
  const today = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
  
  // í•©ê³„ ê³„ì‚°
  let totalSupplyAmount = 0;
  let totalVatAmount = 0;
  let totalShippingFee = 0;
  let totalAmount = 0;
  let totalQuantity = 0;
  
  products.forEach(p => {
    const qty = Number(p.quantity) || 0;
    const supplyPrice = Number(p.supplyPrice) || 0;
    const shippingFee = Number(p.shippingFee) || 0;
    // ê³µê¸‰ê°€ì•¡ ê³„ì‚° (VAT ì œì™¸)
    const supplyAmount = Math.round(supplyPrice * qty / 1.1);
    const vatAmount = Math.round(supplyAmount * 0.1);
    const shipping = shippingFee * qty;
    
    totalQuantity += qty;
    totalSupplyAmount += supplyAmount;
    totalVatAmount += vatAmount;
    totalShippingFee += shipping;
    totalAmount += supplyAmount + vatAmount + shipping;
  });
  
  // ëª¨ë‹¬ì— ì •ì‚°ì„œ í‘œì‹œ
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ§¾ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ - ${settlement.brandName}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div id="supplier-invoice-content" style="flex: 1; overflow-y: auto; padding: 24px; background: white;">
        <!-- í—¤ë” -->
        <div style="text-align: center; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid #059669;">
          <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #1f2937;">ê³µê¸‰ ëŒ€ê¸ˆ ì •ì‚°ì„œ</h1>
          <p style="color: #6b7280; font-size: 14px;">ëª¨ì—¬ë¼ë”œ | ${today}</p>
        </div>
        
        <!-- ê³µê¸‰ì‚¬ ì •ë³´ & ì…€ëŸ¬ ì •ë³´ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
          <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; border: 1px solid #bbf7d0;">
            <h3 style="font-size: 14px; font-weight: 700; color: #166534; margin-bottom: 16px;">ğŸ“¦ ê³µê¸‰ì‚¬ ì •ë³´</h3>
            <div style="font-size: 13px; line-height: 1.8;">
              <div><strong>ê³µê¸‰ì‚¬ëª…:</strong> ${settlement.brandName || '-'}</div>
              <div><strong>ë‹´ë‹¹ì:</strong> ${supplier.contactPerson || '-'}</div>
              <div><strong>ì—°ë½ì²˜:</strong> ${supplier.phone || '-'}</div>
              <div><strong>ì…ê¸ˆê³„ì¢Œ:</strong> ${supplier.bankInfo || '-'}</div>
            </div>
          </div>
          <div style="background: var(--gray-100); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-300);">
            <h3 style="font-size: 14px; font-weight: 700; color: var(--gray-600); margin-bottom: 16px;">ğŸ‘¤ ì…€ëŸ¬ ì •ë³´</h3>
            <div style="font-size: 13px; line-height: 1.8;">
              <div><strong>ì…€ëŸ¬:</strong> ${sellerNickname}</div>
              ${sellerLink ? `<div><strong>ê³„ì •:</strong> <a href="${sellerLink.startsWith('http') ? sellerLink : 'https://instagram.com/' + sellerLink}" target="_blank" style="color: #2563eb; text-decoration: underline;">${sellerLink.includes('instagram') ? '@' + sellerLink.split('/').pop() : sellerLink}</a></div>` : ''}
              <div><strong>ê³µêµ¬ ê¸°ê°„:</strong> ${settlement.dealPeriod || '-'}</div>
              <div><strong>ì •ì‚° ì˜ˆì •ì¼:</strong> ${settlement.settlementDate || '-'}</div>
              <div><strong>ì´ ìˆ˜ëŸ‰:</strong> ${totalQuantity > 0 ? totalQuantity.toLocaleString() : (settlement.totalQuantity || 0).toLocaleString()}ê°œ</div>
            </div>
          </div>
        </div>
        
        <!-- ìƒí’ˆë³„ ì •ì‚° ë‚´ì—­ -->
        <div style="margin-bottom: 32px;">
          <h3 style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #059669;">
            ğŸ“¦ ìƒí’ˆë³„ ì •ì‚° ë‚´ì—­
          </h3>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: left;">ìƒí’ˆëª…</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">ê³µê¸‰ë‹¨ê°€(V+)</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: center;">íŒë§¤ìˆ˜ëŸ‰</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">ê³µê¸‰ê°€ì•¡</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">ë¶€ê°€ì„¸(10%)</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">ë°°ì†¡ë£Œ</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right; font-weight: 700;">í•©ê³„ê¸ˆì•¡(V+)</th>
              </tr>
            </thead>
            <tbody>
              ${products.length === 0 ? `
                <tr>
                  <td colspan="7" style="padding: 20px; text-align: center; color: #9ca3af; border: 1px solid #e5e7eb;">
                    ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (ì¼ê´„ ì…ë ¥ëœ ì •ì‚°)
                  </td>
                </tr>
                <tr style="background: var(--gray-50); font-weight: 700;">
                  <td colspan="3" style="padding: 12px; border: 1px solid #bbf7d0;">í•©ê³„</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${Number(settlement.totalSupplyAmount || 0).toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${Number(settlement.totalVatAmount || 0).toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${Number(settlement.totalShippingFee || 0).toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right; color: #059669;">${Number(settlement.totalAmount || 0).toLocaleString()}ì›</td>
                </tr>
              ` : `
                ${products.map(p => {
                  const qty = Number(p.quantity) || 0;
                  const supplyPrice = Number(p.supplyPrice) || 0;
                  const shippingFee = Number(p.shippingFee) || 0;
                  const supplyAmount = Math.round(supplyPrice * qty / 1.1);
                  const vatAmount = Math.round(supplyAmount * 0.1);
                  const shipping = shippingFee * qty;
                  const rowTotal = supplyAmount + vatAmount + shipping;
                  return '<tr>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb;">' + (p.productName || '-') + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">' + supplyPrice.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">' + qty.toLocaleString() + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">' + supplyAmount.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">' + vatAmount.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">' + shipping.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600;">' + rowTotal.toLocaleString() + 'ì›</td>' +
                    '</tr>';
                }).join('')}
                <tr style="background: var(--gray-50); font-weight: 700;">
                  <td style="padding: 12px; border: 1px solid #bbf7d0;">í•©ê³„</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0;"></td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: center;">${totalQuantity.toLocaleString()}</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${totalSupplyAmount.toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${totalVatAmount.toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${totalShippingFee.toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right; color: #059669;">${totalAmount.toLocaleString()}ì›</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
        
        <!-- ìµœì¢… ì •ì‚° ê¸ˆì•¡ -->
        <div style="background: linear-gradient(135deg, #059669 0%, #047857 100%); border-radius: 16px; padding: 24px; color: white; text-align: center;">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ’° ìµœì¢… ì •ì‚° ê¸ˆì•¡ (VAT í¬í•¨)</div>
          <div style="font-size: 36px; font-weight: 700;">${(products.length > 0 ? totalAmount : Number(settlement.totalAmount || 0)).toLocaleString()}ì›</div>
        </div>
        
        <!-- ë©”ëª¨ -->
        ${settlement.memo ? `
          <div style="margin-top: 24px; padding: 16px; background: var(--gray-100); border-radius: 8px; border: 1px solid var(--gray-300);">
            <strong style="color: var(--gray-600);">ğŸ“ ë©”ëª¨:</strong>
            <p style="margin: 8px 0 0 0; color: var(--gray-500);">${settlement.memo}</p>
          </div>
        ` : ''}
        
        <!-- í‘¸í„° -->
        <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 12px;">
          <p>ë³¸ ì •ì‚°ì„œì˜ ë‚´ìš©ì€ ì •ì‚° ê¸°ì¤€ì¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          <p style="margin-top: 4px;">ë¬¸ì˜: moyeoradeal@gmail.com</p>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: center;">
        <button class="btn btn-secondary" onclick="openSupplierInvoiceList()">â† ëª©ë¡ìœ¼ë¡œ</button>
        <button class="btn btn-primary" onclick="printSupplierInvoice()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
        <button class="btn btn-primary" style="background: #059669;" onclick="downloadSupplierInvoice('${settlement.brandName}', '${settlement.dealPeriod || ''}')">ğŸ’¾ HTML ì €ì¥</button>
      </div>
    </div>
  `;
}

// ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì¸ì‡„
function printSupplierInvoice() {
  const content = document.getElementById('supplier-invoice-content');
  if (!content) return;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <title>ê³µê¸‰ì‚¬ ì •ì‚°ì„œ</title>
      <style>
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif; 
          padding: 20px; 
          color: #1f2937;
        }
        @media print { 
          body { padding: 0; }
          @page { margin: 1cm; }
        }
      </style>
    </head>
    <body>${content.innerHTML}</body>
    </html>
  `);
  printWindow.document.close();
  setTimeout(() => printWindow.print(), 300);
}

// ê³µê¸‰ì‚¬ ì •ì‚°ì„œ HTML ë‹¤ìš´ë¡œë“œ
function downloadSupplierInvoice(brandName, period) {
  const content = document.getElementById('supplier-invoice-content');
  if (!content) return;
  
  const today = new Date().toISOString().split('T')[0];
  const fileName = 'ê³µê¸‰ì‚¬ì •ì‚°ì„œ_' + brandName + '_' + (period || today).replace(/[\/\s~]/g, '-') + '.html';
  
  const htmlContent = '<!DOCTYPE html>' +
    '<html lang="ko">' +
    '<head>' +
    '<meta charset="UTF-8">' +
    '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
    '<title>ê³µê¸‰ì‚¬ ì •ì‚°ì„œ - ' + brandName + '</title>' +
    '<style>' +
    'body { font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; background: #f9fafb; color: #1f2937; }' +
    '.container { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }' +
    'table { width: 100%; border-collapse: collapse; font-size: 13px; }' +
    'th, td { padding: 12px; border: 1px solid #e5e7eb; }' +
    '@media print { body { padding: 0; background: white; } .container { box-shadow: none; } }' +
    '</style>' +
    '</head>' +
    '<body>' +
    '<div class="container">' +
    content.innerHTML +
    '</div>' +
    '</body>' +
    '</html>';
  
  const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('ì •ì‚°ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ==================== í†µí•© ì •ì‚° ëª¨ë‹¬ ====================
function openUnifiedSettlementModal(item = null, dealId = null) {
  const modalEl = document.getElementById('modal');
  const isEdit = item !== null;
  
  // ìº˜ë¦°ë”ì—ì„œ ê³µêµ¬ ì„ íƒí–ˆì„ ê²½ìš° ìë™ ì…ë ¥
  let prefillData = null;
  if (dealId) {
    const deal = (state.deals || []).find(d => d.id === dealId);
    if (deal) {
      const seller = state.sellers.find(s => s.id === deal.sellerId);
      prefillData = {
        sellerName: seller?.name || deal.sellerName || '',
        brandName: deal.brandName || '',
        dealPeriod: deal.startDate && deal.endDate ? deal.startDate + '~' + deal.endDate : '',
        dealId: deal.id
      };
    }
  }
  
  const s = item || {
    productType: 'inhouse',
    sellerName: prefillData?.sellerName || '',
    brandName: prefillData?.brandName || '',
    dealPeriod: prefillData?.dealPeriod || '',
    dealId: prefillData?.dealId || '',
    totalQuantity: '',
    salesAmount: '',
    marginRate: '',
    marginAmount: '',
    withholdingTax: '',
    actualPayment: '',
    eventCost: '',
    settlementDate: new Date().toISOString().split('T')[0],
    // íƒ€ì‚¬ ìƒí’ˆ ê³µê¸‰ì‚¬ ì •ë³´
    supplyAmount: '',
    vatAmount: '',
    supplierTotalAmount: '',
    products: []
  };
  
  const sellers = state.sellers || [];
  const brands = state.brands || [];
  const supplierProducts = state.supplierProducts || [];
  
  // ë§ˆê°ëœ ê³µêµ¬ ëª©ë¡ (ì •ì‚° ê°€ëŠ¥í•œ ê³µêµ¬)
  const completedDeals = (state.deals || []).filter(d => {
    const endDate = new Date(d.endDate);
    const today = new Date();
    return endDate < today && d.status !== 'settled'; // ë§ˆê°ë˜ì—ˆê³  ì•„ì§ ì •ì‚° ì•ˆëœ ê³µêµ¬
  });
  
  // ë¸Œëœë“œë³„ ìƒí’ˆ ê·¸ë£¹í™”
  const productsByBrand = {};
  supplierProducts.forEach(p => {
    if (!productsByBrand[p.brandName]) productsByBrand[p.brandName] = [];
    productsByBrand[p.brandName].push(p);
  });
  
  modalEl.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>${isEdit ? 'ğŸ“ ì •ì‚° ìˆ˜ì •' : 'â• ì •ì‚° ì¶”ê°€'}</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="submitUnifiedSettlement(event, '${s.id || ''}')" id="unified-settlement-form">
        <div class="modal-body">
          <!-- ìº˜ë¦°ë”ì—ì„œ ê³µêµ¬ ì„ íƒ -->
          ${!isEdit ? `
          <div style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div>
                <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">ğŸ“… ìº˜ë¦°ë”ì—ì„œ ê³µêµ¬ ì„ íƒ</div>
                <div style="font-size: 12px; color: var(--gray-600);">ë§ˆê°ëœ ê³µêµ¬ë¥¼ ì„ íƒí•˜ë©´ ì •ë³´ê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤</div>
              </div>
            </div>
            <select id="us-selectDeal" class="form-input" style="width: 100%;" onchange="onSelectDealForSettlement(this.value)">
              <option value="">ê³µêµ¬ ì„ íƒ (ë§ˆê°ëœ ê³µêµ¬ ${completedDeals.length}ê±´)</option>
              ${completedDeals.map(d => {
                const seller = state.sellers.find(sel => sel.id === d.sellerId);
                return `<option value="${d.id}" ${s.dealId === d.id ? 'selected' : ''}>${d.startDate || ''} | ${seller?.name || d.sellerName || '-'} | ${d.brandName || d.productName || '-'}</option>`;
              }).join('')}
            </select>
            ${completedDeals.length === 0 ? '<div style="font-size: 12px; color: var(--gray-500); margin-top: 8px; text-align: center;">ë§ˆê°ëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : ''}
          </div>
          ` : ''}
          
          <!-- ìƒí’ˆ ìœ í˜• ì„ íƒ -->
          <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <label style="flex: 1; padding: 16px; border: 2px solid ${s.productType === 'inhouse' ? 'var(--info)' : 'var(--gray-200)'}; border-radius: 12px; cursor: pointer; text-align: center; background: ${s.productType === 'inhouse' ? 'var(--info-light)' : 'transparent'};" onclick="toggleProductType('inhouse')">
              <input type="radio" name="productType" value="inhouse" ${s.productType === 'inhouse' ? 'checked' : ''} style="display: none;">
              <div style="font-size: 24px; margin-bottom: 8px;">ğŸ </div>
              <div style="font-weight: 700; color: var(--info);">1. ìì‚¬ ìƒí’ˆ</div>
              <div style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬ ì •ì‚°ë§Œ</div>
            </label>
            <label style="flex: 1; padding: 16px; border: 2px solid ${s.productType === 'external' ? 'var(--success)' : 'var(--gray-200)'}; border-radius: 12px; cursor: pointer; text-align: center; background: ${s.productType === 'external' ? 'var(--success-light)' : 'transparent'};" onclick="toggleProductType('external')">
              <input type="radio" name="productType" value="external" ${s.productType === 'external' ? 'checked' : ''} style="display: none;">
              <div style="font-size: 24px; margin-bottom: 8px;">ğŸ­</div>
              <div style="font-weight: 700; color: var(--success);">2. íƒ€ì‚¬ ìƒí’ˆ</div>
              <div style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬ + ê³µê¸‰ì‚¬ ì •ì‚°</div>
            </label>
          </div>
          
          <!-- ê¸°ë³¸ ì •ë³´ -->
          <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px; font-size: 14px; color: var(--gray-700);">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h4>
            <input type="hidden" id="us-dealId" value="${s.dealId || ''}">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ì…€ëŸ¬ëª… *</label>
                <input type="text" class="form-input" id="us-sellerName" value="${s.sellerName}" required list="us-seller-list">
                <datalist id="us-seller-list">${sellers.map(sel => `<option value="${sel.name}">`).join('')}</datalist>
              </div>
              <div class="form-group">
                <label class="form-label">ë¸Œëœë“œ *</label>
                <input type="text" class="form-input" id="us-brandName" value="${s.brandName}" required list="us-brand-list" onchange="onBrandChange(this.value)">
                <datalist id="us-brand-list">${brands.map(b => `<option value="${b.name}">`).join('')}</datalist>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ê³µêµ¬ê¸°ê°„</label>
                <input type="text" class="form-input" id="us-dealPeriod" value="${s.dealPeriod}" placeholder="2025-11-27~2025-11-30">
              </div>
              <div class="form-group">
                <label class="form-label">ì •ì‚°ì¼ *</label>
                <input type="date" class="form-input" id="us-settlementDate" value="${s.settlementDate}" required>
              </div>
            </div>
          </div>
          
          <!-- íƒ€ì‚¬ ìƒí’ˆ: ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ì…ë ¥ -->
          <div id="supplier-products-section" style="display: ${s.productType === 'external' ? 'block' : 'none'}; background: #fefce8; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0; font-size: 14px; color: #ca8a04;">ğŸ­ ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ì…ë ¥</h4>
              <button type="button" class="btn btn-secondary btn-sm" onclick="openSupplierProductModal()">ğŸ“¦ ìƒí’ˆê´€ë¦¬</button>
            </div>
            <div id="product-quantity-inputs">
              ${s.products && s.products.length > 0 ? 
                s.products.map((p, i) => `
                  <div class="form-row" style="align-items: center; margin-bottom: 8px;">
                    <div style="flex: 3;"><input type="text" class="form-input" value="${p.productName}" readonly style="background: #fff;"></div>
                    <div style="flex: 1;"><input type="number" class="form-input product-qty" data-supply="${p.supplyPrice}" data-sale="${p.salePrice}" value="${p.quantity || 0}" placeholder="ìˆ˜ëŸ‰" oninput="calculateSupplierTotals()"></div>
                    <div style="flex: 1; text-align: right; font-size: 12px; color: var(--gray-600);">${Number(p.supplyPrice).toLocaleString()}ì›</div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; padding: 20px; color: var(--gray-500);">ë¸Œëœë“œë¥¼ ì„ íƒí•˜ë©´ ë“±ë¡ëœ ìƒí’ˆì´ í‘œì‹œë©ë‹ˆë‹¤</div>'
              }
            </div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #fde68a;">
              <div class="form-row">
                <div class="form-group"><label class="form-label">ì´ ìˆ˜ëŸ‰</label><input type="number" class="form-input" id="us-totalQuantity" value="${s.totalQuantity}" readonly style="background: #fff;"></div>
                <div class="form-group"><label class="form-label">ì´ íŒë§¤ê¸ˆì•¡</label><input type="number" class="form-input" id="us-salesAmount" value="${s.salesAmount}" readonly style="background: #fff;"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">ê³µê¸‰ê°€ì•¡ (V-)</label><input type="number" class="form-input" id="us-supplyAmount" value="${s.supplyAmount}" readonly style="background: #fff8f0;"></div>
                <div class="form-group"><label class="form-label">ë¶€ê°€ì„¸ (10%)</label><input type="number" class="form-input" id="us-vatAmount" value="${s.vatAmount}" readonly style="background: #fff8f0;"></div>
                <div class="form-group"><label class="form-label">ê³µê¸‰ì‚¬ ì •ì‚°ê¸ˆì•¡ (V+)</label><input type="number" class="form-input" id="us-supplierTotalAmount" value="${s.supplierTotalAmount}" readonly style="background: #fff8f0; font-weight: 700;"></div>
              </div>
            </div>
          </div>
          
          <!-- ìì‚¬ ìƒí’ˆ: ì§ì ‘ ì…ë ¥ -->
          <div id="inhouse-inputs-section" style="display: ${s.productType === 'inhouse' ? 'block' : 'none'}; background: var(--info-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px; font-size: 14px; color: var(--info);">ğŸ’° íŒë§¤ ì •ë³´</h4>
            <div class="form-row">
              <div class="form-group"><label class="form-label">ì´ ìˆ˜ëŸ‰</label><input type="number" class="form-input" id="us-totalQuantity-inhouse" value="${s.totalQuantity}" oninput="calculateInhouseTotals()"></div>
              <div class="form-group"><label class="form-label">ì´ íŒë§¤ê¸ˆì•¡ *</label><input type="number" class="form-input" id="us-salesAmount-inhouse" value="${s.salesAmount}" required oninput="calculateInhouseTotals()"></div>
            </div>
          </div>
          
          <!-- ì…€ëŸ¬ ì •ì‚° ì •ë³´ -->
          <div style="background: #dcfce7; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px; font-size: 14px; color: #16a34a;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚° ì •ë³´</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ë§ˆì§„ìœ¨ (%)</label>
                <input type="number" class="form-input" id="us-marginRate" value="${s.marginRate || ''}" step="0.1" oninput="calculateMarginFromRate()">
              </div>
              <div class="form-group">
                <label class="form-label">ë§ˆì§„ê¸ˆì•¡</label>
                <input type="number" class="form-input" id="us-marginAmount" value="${s.marginAmount}" oninput="calculateMarginFromAmount()">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">ì›ì²œì„¸ (3.3%)</label><input type="number" class="form-input" id="us-withholdingTax" value="${s.withholdingTax}" readonly style="background: #f0fdf4;"></div>
              <div class="form-group"><label class="form-label">ì‹¤ì§€ê¸‰ì•¡</label><input type="number" class="form-input" id="us-actualPayment" value="${s.actualPayment}" readonly style="background: #f0fdf4; font-weight: 700;"></div>
            </div>
            <div class="form-group"><label class="form-label">ì´ë²¤íŠ¸ ë¹„ìš©</label><input type="number" class="form-input" id="us-eventCost" value="${s.eventCost || 0}" placeholder="0"></div>
          </div>
        </div>
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSettlement('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ì €ì¥í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  modalEl.className = 'modal show';
  
  // ë¸Œëœë“œ ë³€ê²½ì‹œ ìƒí’ˆ ë¡œë“œ
  window.onBrandChange = function(brandName) {
    const productType = document.querySelector('input[name="productType"]:checked')?.value;
    if (productType !== 'external') return;
    
    const products = productsByBrand[brandName] || [];
    const container = document.getElementById('product-quantity-inputs');
    
    if (products.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆê´€ë¦¬ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>';
      return;
    }
    
    container.innerHTML = products.map(p => `
      <div class="form-row" style="align-items: center; margin-bottom: 8px;">
        <div style="flex: 3;"><input type="text" class="form-input" value="${p.productName}" data-product-id="${p.id}" readonly style="background: #fff;"></div>
        <div style="flex: 1;"><input type="number" class="form-input product-qty" data-supply="${p.supplyPrice}" data-sale="${p.salePrice}" value="0" placeholder="ìˆ˜ëŸ‰" min="0" oninput="calculateSupplierTotals()"></div>
        <div style="flex: 1; text-align: right; font-size: 12px; color: var(--gray-600);">${Number(p.supplyPrice).toLocaleString()}ì›</div>
      </div>
    `).join('');
  };
  
  // ìƒí’ˆìœ í˜• í† ê¸€
  window.toggleProductType = function(type) {
    document.querySelector(`input[name="productType"][value="${type}"]`).checked = true;
    
    // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('label[onclick^="toggleProductType"]').forEach(label => {
      const isSelected = label.querySelector('input').checked;
      const isInhouse = label.querySelector('input').value === 'inhouse';
      label.style.borderColor = isSelected ? (isInhouse ? 'var(--info)' : 'var(--success)') : 'var(--gray-200)';
      label.style.background = isSelected ? (isInhouse ? 'var(--info-light)' : 'var(--success-light)') : 'transparent';
    });
    
    // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
    document.getElementById('supplier-products-section').style.display = type === 'external' ? 'block' : 'none';
    document.getElementById('inhouse-inputs-section').style.display = type === 'inhouse' ? 'block' : 'none';
  };
  
  // ìº˜ë¦°ë”ì—ì„œ ê³µêµ¬ ì„ íƒ ì‹œ ìë™ ì…ë ¥ (ìƒí’ˆDB, ë§ˆì§„ìœ¨ ë“± í¬í•¨)
  window.onSelectDealForSettlement = function(dealId) {
    if (!dealId) return;

    const deal = (state.deals || []).find(d => d.id === dealId);
    if (!deal) return;

    const seller = state.sellers.find(s => s.id === deal.sellerId);
    const supplier = state.suppliers?.find(sp => sp.id === deal.supplierId);

    // 1. ê¸°ë³¸ ì •ë³´ ìë™ ì…ë ¥
    document.getElementById('us-dealId').value = deal.id;
    document.getElementById('us-sellerName').value = seller?.name || deal.sellerName || '';
    document.getElementById('us-brandName').value = deal.brandName || '';

    // 2. ê³µêµ¬ê¸°ê°„
    if (deal.startDate && deal.endDate) {
      document.getElementById('us-dealPeriod').value = deal.startDate + '~' + deal.endDate;
    }

    // 3. ìƒí’ˆ ìœ í˜• ìë™ ì„ íƒ (ìì‚¬/íƒ€ì‚¬)
    const productType = deal.productType || supplier?.supplierType || 'inhouse';
    toggleProductType(productType);

    // 4. ë§ˆì§„ìœ¨ ìë™ ì…ë ¥ (ê³µêµ¬ ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ìš°ì„  ì‚¬ìš©)
    // selectedProductsì—ì„œ ì²« ë²ˆì§¸ ìƒí’ˆì˜ ë§ˆì§„ìœ¨ ë˜ëŠ” í‰ê·  ë§ˆì§„ìœ¨ ì‚¬ìš©
    let marginRate = 10; // ê¸°ë³¸ê°’
    if (deal.selectedProducts && deal.selectedProducts.length > 0) {
      const productsWithMargin = deal.selectedProducts.filter(p => p.marginRate && Number(p.marginRate) > 0);
      if (productsWithMargin.length > 0) {
        // ìƒí’ˆë³„ ë§ˆì§„ìœ¨ì˜ í‰ê·  ê³„ì‚°
        const avgMarginRate = productsWithMargin.reduce((sum, p) => sum + Number(p.marginRate), 0) / productsWithMargin.length;
        marginRate = Math.round(avgMarginRate * 10) / 10; // ì†Œìˆ˜ì  1ìë¦¬
      }
    }
    // selectedProductsì— ë§ˆì§„ìœ¨ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ í´ë°±
    if (marginRate === 10 && (deal.marginRate || deal.sellerMarginRate || seller?.defaultMarginRate)) {
      marginRate = deal.marginRate || deal.sellerMarginRate || seller?.defaultMarginRate || 10;
    }
    document.getElementById('us-marginRate').value = marginRate;

    // 5. íŒë§¤ê¸ˆì•¡/ìˆ˜ëŸ‰ ìë™ ì…ë ¥ (ê³µêµ¬ì— ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´)
    if (deal.totalSales || deal.totalQty) {
      if (productType === 'inhouse') {
        document.getElementById('us-totalQuantity-inhouse').value = deal.totalQty || '';
        document.getElementById('us-salesAmount-inhouse').value = deal.totalSales || '';
      }
    }

    // 6. ë¸Œëœë“œ ë³€ê²½ íŠ¸ë¦¬ê±° (ìƒí’ˆ ëª©ë¡ ê°±ì‹ )
    if (deal.brandName) {
      onBrandChange(deal.brandName);
    }

    // 7. ê³µêµ¬ì— ì„ íƒëœ ìƒí’ˆì´ ìˆìœ¼ë©´ í•´ë‹¹ ìƒí’ˆ ì •ë³´ë„ í‘œì‹œ
    if (deal.selectedProducts && deal.selectedProducts.length > 0 && productType === 'external') {
      setTimeout(() => {
        const container = document.getElementById('product-quantity-inputs');
        const dealProducts = deal.selectedProducts;

        // ìƒí’ˆDBì—ì„œ ë§¤ì¹­ë˜ëŠ” ìƒí’ˆ ì°¾ê¸°
        const matchedProducts = [];
        dealProducts.forEach(dp => {
          const dbProduct = supplierProducts.find(p =>
            p.id === dp.productId ||
            p.productName === dp.productName ||
            (p.brandName === deal.brandName && p.productName?.includes(dp.productName?.split(' ')[0]))
          );
          if (dbProduct) {
            matchedProducts.push({
              ...dbProduct,
              quantity: dp.quantity || 0,
              marginRate: dp.marginRate || marginRate
            });
          }
        });

        if (matchedProducts.length > 0) {
          container.innerHTML = matchedProducts.map(p => `
            <div class="form-row" style="align-items: center; margin-bottom: 8px;">
              <div style="flex: 3;"><input type="text" class="form-input" value="${p.productName}" data-product-id="${p.id}" readonly style="background: #fff;"></div>
              <div style="flex: 1;"><input type="number" class="form-input product-qty" data-supply="${p.supplyPrice}" data-sale="${p.salePrice}" value="${p.quantity}" placeholder="ìˆ˜ëŸ‰" min="0" oninput="calculateSupplierTotals()"></div>
              <div style="flex: 1; text-align: right; font-size: 12px; color: var(--gray-600);">${Number(p.supplyPrice).toLocaleString()}ì›</div>
            </div>
          `).join('');

          // ì´ì•¡ ìë™ ê³„ì‚°
          calculateSupplierTotals();
        }
      }, 100);
    }

    // 8. ë§ˆì§„ ê³„ì‚° íŠ¸ë¦¬ê±°
    setTimeout(() => {
      calculateMarginFromRate();
    }, 150);

    showToast('ê³µêµ¬ ì •ë³´ê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ìƒí’ˆ/ë§ˆì§„ìœ¨ í¬í•¨)');
  };
  
  // ê³µê¸‰ì‚¬ ì´ì•¡ ê³„ì‚°
  window.calculateSupplierTotals = function() {
    const inputs = document.querySelectorAll('.product-qty');
    let totalQty = 0, totalSales = 0, totalSupply = 0;
    
    inputs.forEach(input => {
      const qty = Number(input.value) || 0;
      const supplyPrice = Number(input.dataset.supply) || 0;
      const salePrice = Number(input.dataset.sale) || 0;
      totalQty += qty;
      totalSales += salePrice * qty;
      totalSupply += supplyPrice * qty;
    });
    
    const vat = Math.round(totalSupply * 0.1);
    const supplierTotal = totalSupply + vat;
    
    document.getElementById('us-totalQuantity').value = totalQty;
    document.getElementById('us-salesAmount').value = totalSales;
    document.getElementById('us-supplyAmount').value = totalSupply;
    document.getElementById('us-vatAmount').value = vat;
    document.getElementById('us-supplierTotalAmount').value = supplierTotal;
    
    // ë§ˆì§„ ìë™ ê³„ì‚° (íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ì‚¬ì •ì‚°ê¸ˆì•¡)
    const marginAmount = totalSales - supplierTotal;
    if (marginAmount > 0) {
      document.getElementById('us-marginAmount').value = marginAmount;
      calculateMarginFromAmount();
    }
  };
  
  // ìì‚¬ ìƒí’ˆ ê³„ì‚°
  window.calculateInhouseTotals = function() {
    // í•„ìš”ì‹œ êµ¬í˜„
  };
  
  // ë§ˆì§„ìœ¨ë¡œ ë§ˆì§„ê¸ˆì•¡ ê³„ì‚°
  window.calculateMarginFromRate = function() {
    const productType = document.querySelector('input[name="productType"]:checked')?.value;
    const salesAmount = productType === 'inhouse' ? 
      Number(document.getElementById('us-salesAmount-inhouse').value) : 
      Number(document.getElementById('us-salesAmount').value);
    const marginRate = Number(document.getElementById('us-marginRate').value) || 0;
    
    const marginAmount = Math.round(salesAmount * (marginRate / 100));
    document.getElementById('us-marginAmount').value = marginAmount;
    
    const withholdingTax = Math.round(marginAmount * 0.033);
    const actualPayment = marginAmount - withholdingTax;
    
    document.getElementById('us-withholdingTax').value = withholdingTax;
    document.getElementById('us-actualPayment').value = actualPayment;
  };
  
  // ë§ˆì§„ê¸ˆì•¡ìœ¼ë¡œ ë§ˆì§„ìœ¨ ê³„ì‚°
  window.calculateMarginFromAmount = function() {
    const productType = document.querySelector('input[name="productType"]:checked')?.value;
    const salesAmount = productType === 'inhouse' ? 
      Number(document.getElementById('us-salesAmount-inhouse').value) : 
      Number(document.getElementById('us-salesAmount').value);
    const marginAmount = Number(document.getElementById('us-marginAmount').value) || 0;
    
    if (salesAmount > 0) {
      const marginRate = (marginAmount / salesAmount * 100).toFixed(1);
      document.getElementById('us-marginRate').value = marginRate;
    }
    
    const withholdingTax = Math.round(marginAmount * 0.033);
    const actualPayment = marginAmount - withholdingTax;
    
    document.getElementById('us-withholdingTax').value = withholdingTax;
    document.getElementById('us-actualPayment').value = actualPayment;
  };
}

// í†µí•© ì •ì‚° ì €ì¥
async function submitUnifiedSettlement(e, id) {
  e.preventDefault();
  
  const productType = document.querySelector('input[name="productType"]:checked')?.value;
  const isExternal = productType === 'external';
  
  const data = {
    productType: productType,
    sellerName: document.getElementById('us-sellerName').value.trim(),
    brandName: document.getElementById('us-brandName').value.trim(),
    dealPeriod: document.getElementById('us-dealPeriod').value.trim(),
    settlementDate: document.getElementById('us-settlementDate').value,
    marginRate: Number(document.getElementById('us-marginRate').value) || 0,
    marginAmount: Number(document.getElementById('us-marginAmount').value) || 0,
    withholdingTax: Number(document.getElementById('us-withholdingTax').value) || 0,
    actualPayment: Number(document.getElementById('us-actualPayment').value) || 0,
    eventCost: Number(document.getElementById('us-eventCost').value) || 0,
    isCompleted: false,
    updatedAt: new Date().toISOString()
  };
  
  if (isExternal) {
    data.totalQuantity = Number(document.getElementById('us-totalQuantity').value) || 0;
    data.salesAmount = Number(document.getElementById('us-salesAmount').value) || 0;
    data.supplyAmount = Number(document.getElementById('us-supplyAmount').value) || 0;
    data.vatAmount = Number(document.getElementById('us-vatAmount').value) || 0;
    data.supplierTotalAmount = Number(document.getElementById('us-supplierTotalAmount').value) || 0;
    
    // ìƒí’ˆ ì •ë³´ ì €ì¥
    const products = [];
    document.querySelectorAll('.product-qty').forEach(input => {
      const qty = Number(input.value) || 0;
      if (qty > 0) {
        const row = input.closest('.form-row');
        const productName = row.querySelector('input[readonly]').value;
        products.push({
          productName,
          quantity: qty,
          supplyPrice: Number(input.dataset.supply),
          salePrice: Number(input.dataset.sale)
        });
      }
    });
    data.products = products;
  } else {
    data.totalQuantity = Number(document.getElementById('us-totalQuantity-inhouse').value) || 0;
    data.salesAmount = Number(document.getElementById('us-salesAmount-inhouse').value) || 0;
  }
  
  try {
    if (id) {
      await db.collection('sellerSettlements').doc(id).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('sellerSettlements').add(data);
    }
    
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    renderSalesManagement();
  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì •ì‚° ì‚­ì œ
async function deleteSettlement(id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }

  const settlement = state.sellerSettlements.find(s => s.id === id);
  if (!settlement) {
    showToast('âŒ ì •ì‚° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  showDeleteConfirmModal({
    title: 'ì •ì‚°ì„œ ì‚­ì œ',
    message: `<strong>${settlement.sellerName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong>ì˜ <strong>${settlement.brandName || ''}</strong> ì •ì‚°ì„œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.<br><br>
      â€¢ ì •ì‚°ê¸°ê°„: ${settlement.dealPeriod || '-'}<br>
      â€¢ ì‹¤ì§€ê¸‰ì•¡: ${Number(settlement.actualPayment || 0).toLocaleString()}ì›<br>
      â€¢ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`,
    deleteType: 'settlement',
    onConfirm: async (method) => {
      try {
        await db.collection('sellerSettlements').doc(id).delete();
        showToast('âœ… ì •ì‚°ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        renderSalesManagement();
      } catch (err) {
        showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }
  });
}

// ==================== ê°œë³„ ì •ì‚°ì„œ ìƒì„± ====================
// ì…€ëŸ¬ ì •ì‚°ì„œ ìƒì„±
function generateSellerStatement(settlementId) {
  const settlement = state.sellerSettlements.find(s => s.id === settlementId);
  if (!settlement) return showToast('ì •ì‚° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  
  const today = new Date().toLocaleDateString('ko-KR');
  
  // ìƒí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê²½ì˜íŒ€ ì •ì‚°ì„œì™€ ë™ì¼í•œ ë¡œì§)
  let items = settlement.salesItems || settlement.items || [];
  
  // salesItemsê°€ ì—†ìœ¼ë©´ ê³µêµ¬ ê´€ë¦¬(deals)ì—ì„œ ìƒí’ˆ ì •ë³´ ì—°ë™
  if (items.length === 0 && settlement.dealPeriod) {
    const matchingDeal = state.deals.find(d => {
      const dealPeriod = d.startDate + '~' + d.endDate;
      return dealPeriod === settlement.dealPeriod || 
             (d.brandName === settlement.brandName) ||
             (d.sellerName && d.sellerName.includes(settlement.sellerName));
    });
    if (matchingDeal && matchingDeal.products && matchingDeal.products.length > 0) {
      items = matchingDeal.products.map(p => ({
        productName: p.productName || p.name,
        unitPrice: Number(p.salePrice) || Number(p.price) || 0,
        quantity: 0,
        amount: 0
      }));
    }
  }
  
  // ë§¤ì¹­ë˜ëŠ” ê³µê¸‰ì‚¬ ì •ì‚°ì—ì„œ ì•„ì´í…œ ê°€ì ¸ì˜¤ê¸°
  if (items.length === 0) {
    const supplierSettlements = state.supplierSettlements || [];
    const matchingSupplier = supplierSettlements.find(sup => 
      ((sup.sellerName || '').includes(settlement.sellerName || '') || (settlement.sellerName || '').includes(sup.sellerName || '')) &&
      ((sup.brandName || '').includes(settlement.brandName || '') || (settlement.brandName || '').includes(sup.brandName || ''))
    );
    if (matchingSupplier && matchingSupplier.items) {
      items = matchingSupplier.items;
    }
  }
  
  // ìƒí’ˆë³„ í–‰ ìƒì„±
  let productRows = '';
  let totalQty = 0;
  let totalSalesAmount = 0;
  
  if (items.length > 0) {
    items.forEach((item, i) => {
      const price = Number(item.unitPrice) || Number(item.salePrice) || Number(item.price) || 0;
      const qty = Number(item.quantity) || 0;
      const amount = Number(item.amount) || (price * qty);
      totalQty += qty;
      totalSalesAmount += amount;
      
      productRows += '<tr>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; font-size: 13px;">' + (item.productName || '-') + '</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + price.toLocaleString() + 'ì›</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">' + qty + '</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + amount.toLocaleString() + 'ì›</td>' +
        '</tr>';
    });
    
    // í•©ê³„í–‰
    productRows += '<tr style="background: #f9fafb; font-weight: 600;">' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">í•©ê³„</td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb;"></td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">' + (totalQty || settlement.totalQuantity || 0) + '</td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + (totalSalesAmount || Number(settlement.salesAmount) || 0).toLocaleString() + 'ì›</td>' +
      '</tr>';
  }
  
  const content = `
    <div style="max-width: 700px; margin: 0 auto; padding: 40px; font-family: 'Malgun Gothic', sans-serif;">
      <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 28px; margin-bottom: 8px; color: #16a34a;">ì…€ëŸ¬ ì •ì‚°ì„œ</h1>
        <p style="color: #6b7684;">ëª¨ì—¬ë¼ë”œ | ${today}</p>
      </div>
      
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #dcfce7;">
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; width: 25%;">ì…€ëŸ¬ëª…</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;"><strong>${settlement.sellerName}</strong></td>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; width: 25%;">ë¸Œëœë“œ</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.brandName}</td>
        </tr>
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ê³µêµ¬ê¸°ê°„</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.dealPeriod || '-'}</td>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ì •ì‚°ì¼</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.settlementDate}</td>
        </tr>
      </table>
      
      <!-- íŒë§¤ ìƒí’ˆ ë‚´ì—­ -->
      <h3 style="font-size: 16px; margin-bottom: 16px; color: #16a34a;">ğŸ“¦ íŒë§¤ ìƒí’ˆ ë‚´ì—­</h3>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #dcfce7;">
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb;">íŒë§¤ìƒí’ˆ</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 100px;">ë‹¨ê°€</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 60px;">ìˆ˜ëŸ‰</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 120px;">íŒë§¤ê¸ˆì•¡</th>
        </tr>
        ${productRows || '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7684;">ìƒí’ˆ ì •ë³´ ì—†ìŒ</td></tr>'}
      </table>
      
      <!-- ì •ì‚° ë‚´ì—­ -->
      <h3 style="font-size: 16px; margin-bottom: 16px; color: #16a34a;">ğŸ’° ì •ì‚° ë‚´ì—­</h3>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #f9fafb;">
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left;">í•­ëª©</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">ê¸ˆì•¡</th>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">ì´ íŒë§¤ê¸ˆì•¡</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">${Number(settlement.salesAmount || 0).toLocaleString()}ì›</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">ì´ ìˆ˜ëŸ‰</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">${settlement.totalQuantity || totalQty || '-'}ê°œ</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">ë§ˆì§„ê¸ˆì•¡ (${settlement.marginRate || 0}%)</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">${Number(settlement.marginAmount || 0).toLocaleString()}ì›</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">ì›ì²œì„¸ (3.3%)</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right; color: #dc2626;">-${Number(settlement.withholdingTax || 0).toLocaleString()}ì›</td>
        </tr>
        <tr style="background: #dcfce7;">
          <td style="padding: 16px; border: 1px solid #e5e7eb; font-weight: 700;">ì‹¤ì§€ê¸‰ì•¡</td>
          <td style="padding: 16px; border: 1px solid #e5e7eb; text-align: right; font-weight: 700; font-size: 20px; color: #16a34a;">${Number(settlement.actualPayment || 0).toLocaleString()}ì›</td>
        </tr>
      </table>
      
      <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <p style="color: #6b7684; font-size: 13px;">ë³¸ ì •ì‚°ì„œì˜ ë‚´ìš©ì€ ì •ì‚° ê¸°ì¤€ì¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write('<!DOCTYPE html><html><head><title>ì…€ëŸ¬ ì •ì‚°ì„œ - ' + settlement.sellerName + '</title></head><body>' + content + '</body></html>');
  printWindow.document.close();
}

// ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ìƒì„±
function generateSupplierStatement(settlementId) {
  const settlement = state.sellerSettlements.find(s => s.id === settlementId);
  if (!settlement) return showToast('ì •ì‚° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  
  const today = new Date().toLocaleDateString('ko-KR');
  
  // ë§¤ì¹­ë˜ëŠ” ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸° (ê²½ì˜íŒ€ ì‹œìŠ¤í…œê³¼ ë™ì¼í•œ ë¡œì§)
  const supplierSettlements = state.supplierSettlements || [];
  const matchingSupplier = supplierSettlements.find(sup => 
    ((sup.sellerName || '').includes(settlement.sellerName || '') || (settlement.sellerName || '').includes(sup.sellerName || '')) &&
    ((sup.brandName || '').includes(settlement.brandName || '') || (settlement.brandName || '').includes(sup.brandName || ''))
  );
  
  // ìƒí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê²½ì˜íŒ€ ì •ì‚°ì„œì™€ ë™ì¼í•œ ë¡œì§)
  let items = settlement.salesItems || settlement.items || [];
  
  // ê³µê¸‰ì‚¬ ì •ì‚°ì˜ items ë¨¼ì € í™•ì¸
  if (items.length === 0 && matchingSupplier && matchingSupplier.items) {
    items = matchingSupplier.items;
  }
  
  // ê³µêµ¬ ê´€ë¦¬(deals)ì—ì„œ ìƒí’ˆ ì •ë³´ ì—°ë™
  if (items.length === 0 && settlement.dealPeriod) {
    const matchingDeal = state.deals.find(d => {
      const dealPeriod = d.startDate + '~' + d.endDate;
      return dealPeriod === settlement.dealPeriod || 
             (d.brandName === settlement.brandName) ||
             (d.sellerName && d.sellerName.includes(settlement.sellerName));
    });
    if (matchingDeal && matchingDeal.products && matchingDeal.products.length > 0) {
      items = matchingDeal.products.map(p => ({
        productName: p.productName || p.name,
        unitPrice: Number(p.salePrice) || Number(p.price) || 0,
        salePrice: Number(p.salePrice) || Number(p.price) || 0,
        supplyPrice: Number(p.supplyPrice) || 0,
        quantity: 0
      }));
    }
  }
  
  // ì…€ëŸ¬ëª…ì—ì„œ ë‹‰ë„¤ì„ë§Œ ì¶”ì¶œ (ì˜ˆ: ì •ì§€ì„ /ìš¸ë§˜(2ë§Œ) â†’ ìš¸ë§˜(2ë§Œ))
  const sellerName = settlement.sellerName || '-';
  const sellerParts = sellerName.split('/');
  const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
  
  // ê³µê¸‰ì‚¬ ì •ì‚° ê¸ˆì•¡ - supplierSettlementsì—ì„œ ìš°ì„  ê°€ì ¸ì˜¤ê¸°
  const supplyAmount = matchingSupplier ? Number(matchingSupplier.totalSupplyAmount) || 0 : Number(settlement.supplyAmount) || 0;
  const vatAmount = matchingSupplier ? Number(matchingSupplier.totalVatAmount) || 0 : Number(settlement.vatAmount) || 0;
  const totalAmount = matchingSupplier ? Number(matchingSupplier.totalAmount) || 0 : Number(settlement.supplierTotalAmount) || 0;
  const salesAmount = Number(settlement.salesAmount) || 0;
  
  // ìƒí’ˆë³„ í–‰ ìƒì„±
  let productRows = '';
  let totalQty = 0;
  let totalSalesAmount = 0;
  
  if (items.length > 0) {
    items.forEach((item, i) => {
      const price = Number(item.unitPrice) || Number(item.salePrice) || Number(item.price) || 0;
      const qty = Number(item.quantity) || 0;
      const amount = Number(item.amount) || (price * qty);
      totalQty += qty;
      totalSalesAmount += amount;
      
      productRows += '<tr>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; font-size: 13px;">' + (item.productName || '-') + '</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + price.toLocaleString() + 'ì›</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">' + qty + '</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + amount.toLocaleString() + 'ì›</td>' +
        '</tr>';
    });
    
    // í•©ê³„í–‰
    productRows += '<tr style="background: #f9fafb; font-weight: 600;">' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">í•©ê³„</td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb;"></td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">' + (totalQty || settlement.totalQuantity || 0) + '</td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + (totalSalesAmount || salesAmount).toLocaleString() + 'ì›</td>' +
      '</tr>';
  }
  
  const content = `
    <div style="max-width: 700px; margin: 0 auto; padding: 40px; font-family: 'Malgun Gothic', sans-serif;">
      <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 28px; margin-bottom: 8px; color: #ca8a04;">ê³µê¸‰ì‚¬ ì •ì‚°ì„œ</h1>
        <p style="color: #6b7684;">ëª¨ì—¬ë¼ë”œ | ${today}</p>
      </div>
      
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #fef9c3;">
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; width: 25%;">ê³µê¸‰ì‚¬(ë¸Œëœë“œ)</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;"><strong>${settlement.brandName}</strong></td>
        </tr>
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ì…€ëŸ¬</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${sellerDisplay}</td>
        </tr>
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ê³µêµ¬ê¸°ê°„</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.dealPeriod || '-'}</td>
        </tr>
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ì •ì‚°ì¼</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.settlementDate}</td>
        </tr>
      </table>
      
      <h3 style="font-size: 16px; margin-bottom: 16px; color: #ca8a04;">ğŸ“¦ íŒë§¤ ìƒí’ˆ ë‚´ì—­</h3>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #fef9c3;">
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb;">íŒë§¤ìƒí’ˆ</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 100px;">ë‹¨ê°€</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 60px;">ìˆ˜ëŸ‰</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 120px;">íŒë§¤ê¸ˆì•¡</th>
        </tr>
        ${productRows || '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7684;">ìƒí’ˆ ì •ë³´ ì—†ìŒ</td></tr>'}
      </table>
      
      <h3 style="font-size: 16px; margin-bottom: 16px; color: #ca8a04;">ğŸ’° ê³µê¸‰ì‚¬ ì •ì‚° ê¸ˆì•¡</h3>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr>
          <td style="padding: 14px; border: 1px solid #e5e7eb; background: #f9fafb; width: 50%;">ê³µê¸‰ê°€ì•¡</td>
          <td style="padding: 14px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600;">${supplyAmount.toLocaleString()}ì›</td>
        </tr>
        <tr>
          <td style="padding: 14px; border: 1px solid #e5e7eb; background: #f9fafb;">ë¶€ê°€ì„¸ (10%)</td>
          <td style="padding: 14px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600;">${vatAmount.toLocaleString()}ì›</td>
        </tr>
        <tr style="background: #fef9c3;">
          <td style="padding: 16px; border: 1px solid #e5e7eb; font-weight: 700; font-size: 15px;">í•©ê³„ ì •ì‚°ê¸ˆì•¡ (V+)</td>
          <td style="padding: 16px; border: 1px solid #e5e7eb; text-align: right; font-weight: 700; font-size: 20px; color: #ca8a04;">${totalAmount.toLocaleString()}ì›</td>
        </tr>
      </table>
      
      <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <p style="color: #6b7684; font-size: 13px;">ë³¸ ì •ì‚°ì„œì˜ ë‚´ìš©ì€ ì •ì‚° ê¸°ì¤€ì¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write('<!DOCTYPE html><html><head><title>ê³µê¸‰ì‚¬ ì •ì‚°ì„œ - ' + settlement.brandName + '</title></head><body>' + content + '</body></html>');
  printWindow.document.close();
}

// ==================== íŒŒíŠ¸ë„ˆ ì†Œí†µ ê´€ë¦¬ ====================
function renderPartnerMessages() {
  const app = document.getElementById('app');
  
  // íŒŒíŠ¸ë„ˆë³„ë¡œ ê·¸ë£¹í™”
  const grouped = {};
  state.partnerMessages.forEach(m => {
    const key = `${m.partnerType}-${m.partnerId}`;
    if (!grouped[key]) {
      grouped[key] = {
        partnerId: m.partnerId,
        partnerType: m.partnerType,
        partnerName: m.partnerName,
        messages: [],
        lastMessage: null,
        unreadCount: 0
      };
    }
    grouped[key].messages.push(m);
    if (!grouped[key].lastMessage || new Date(m.createdAt) > new Date(grouped[key].lastMessage.createdAt)) {
      grouped[key].lastMessage = m;
    }
    if (!m.isAdmin && !m.isRead) {
      grouped[key].unreadCount++;
    }
  });
  
  const conversations = Object.values(grouped).sort((a, b) => 
    new Date(b.lastMessage?.createdAt || 0) - new Date(a.lastMessage?.createdAt || 0)
  );
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ’¬ íŒŒíŠ¸ë„ˆ ì†Œí†µ</h1>
      <p style="color: var(--gray-500); margin-top: 4px;">ê³µê¸‰ì‚¬/ì…€ëŸ¬ì™€ 1:1 ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ìŠµë‹ˆë‹¤.</p>
    </div>
    
    <div class="card">
      ${conversations.length === 0 ? `
        <div style="text-align: center; padding: 60px 20px; color: var(--gray-500);">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’¬</div>
          <p>ì•„ì§ íŒŒíŠ¸ë„ˆ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      ` : `
        <div style="display: grid; gap: 8px;">
          ${conversations.map(c => `
            <div onclick="openMessageThread('${c.partnerType}', '${c.partnerId}', '${c.partnerName}')" 
                 style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid var(--gray-200); border-radius: 12px; cursor: pointer; transition: all 0.15s; ${c.unreadCount > 0 ? 'background: var(--primary-light); border-color: var(--primary);' : ''}"
                 onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='${c.unreadCount > 0 ? 'var(--primary-light)' : ''}'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; background: ${c.partnerType === 'supplier' ? 'var(--info-light)' : 'var(--primary-light)'};">
                  ${c.partnerType === 'supplier' ? 'ğŸ­' : 'ğŸ‘¤'}
                </div>
                <div>
                  <div style="font-weight: 600; margin-bottom: 4px;">
                    ${c.partnerName}
                    <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; background: ${c.partnerType === 'supplier' ? 'var(--info-light)' : 'var(--primary-light)'}; color: ${c.partnerType === 'supplier' ? 'var(--info)' : 'var(--primary)'};">
                      ${c.partnerType === 'supplier' ? 'ê³µê¸‰ì‚¬' : 'ì…€ëŸ¬'}
                    </span>
                  </div>
                  <div style="font-size: 13px; color: var(--gray-500); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${c.lastMessage?.content || ''}
                  </div>
                </div>
              </div>
              <div style="text-align: right;">
                ${c.unreadCount > 0 ? `
                  <div style="background: var(--danger); color: white; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; margin-bottom: 4px;">
                    ${c.unreadCount}
                  </div>
                ` : ''}
                <div style="font-size: 12px; color: var(--gray-400);">
                  ${formatDateKR(c.lastMessage?.createdAt)}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

// ë©”ì‹œì§€ ìŠ¤ë ˆë“œ ì—´ê¸°
function openMessageThread(partnerType, partnerId, partnerName) {
  const messages = state.partnerMessages
    .filter(m => m.partnerId === partnerId && m.partnerType === partnerType)
    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
  
  // ì•ˆì½ì€ ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
  messages.forEach(m => {
    if (!m.isAdmin && !m.isRead) {
      db.collection('partnerMessages').doc(m.id).update({ isRead: true });
    }
  });
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
      <div class="modal-header" style="flex-shrink: 0;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: ${partnerType === 'supplier' ? 'var(--info-light)' : 'var(--primary-light)'};">
            ${partnerType === 'supplier' ? 'ğŸ­' : 'ğŸ‘¤'}
          </div>
          <div>
            <h2 class="modal-title" style="margin: 0;">${partnerName}</h2>
            <span style="font-size: 12px; color: var(--gray-500);">${partnerType === 'supplier' ? 'ê³µê¸‰ì‚¬' : 'ì…€ëŸ¬'}</span>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div id="message-thread" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--gray-50);">
        ${messages.length === 0 ? `
          <div style="text-align: center; padding: 40px; color: var(--gray-500);">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        ` : messages.map(msg => `
          <div style="display: flex; flex-direction: column; align-items: ${msg.isAdmin ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
            <div style="max-width: 80%; padding: 12px 16px; border-radius: 16px; ${msg.isAdmin ? 'background: var(--primary); color: white; border-bottom-right-radius: 4px;' : 'background: white; border: 1px solid var(--gray-200); border-bottom-left-radius: 4px;'}">
              <div style="font-size: 14px; line-height: 1.5;">${msg.content}</div>
            </div>
            <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px; padding: 0 4px;">
              ${msg.isAdmin ? 'ê´€ë¦¬ì' : partnerName} Â· ${formatDateKR(msg.createdAt)}
            </div>
          </div>
        `).join('')}
      </div>
      
      <div style="flex-shrink: 0; padding: 16px; border-top: 1px solid var(--gray-200); background: white;">
        <div style="display: flex; gap: 8px;">
          <input type="text" id="admin-message-input" class="form-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1;" onkeypress="if(event.key==='Enter')sendAdminMessage('${partnerType}','${partnerId}','${partnerName}')">
          <button class="btn btn-primary" style="flex-shrink: 0;" onclick="sendAdminMessage('${partnerType}','${partnerId}','${partnerName}')">ì „ì†¡</button>
        </div>
      </div>
    </div>
  `;
  
  // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
  setTimeout(() => {
    const thread = document.getElementById('message-thread');
    if (thread) thread.scrollTop = thread.scrollHeight;
  }, 100);
}

// ê´€ë¦¬ì ë©”ì‹œì§€ ì „ì†¡
async function sendAdminMessage(partnerType, partnerId, partnerName) {
  const input = document.getElementById('admin-message-input');
  const content = input.value.trim();
  if (!content) return;
  
  try {
    await db.collection('partnerMessages').add({
      partnerId: partnerId,
      partnerType: partnerType,
      partnerName: partnerName,
      content: content,
      isAdmin: true,
      isRead: true,
      createdAt: new Date().toISOString()
    });
    
    input.value = '';
    showToast('ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.');
    openMessageThread(partnerType, partnerId, partnerName);
  } catch (e) {
    console.error(e);
    showToast('ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ğŸš€ ê³µêµ¬ì„¼í„° (í†µí•©) ====================
function renderDealCenter() {
  const app = document.getElementById('app');
  
  // ë°ì´í„° ì¤€ë¹„
  const urgentList = (state.urgentSales || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const sellerProposals = (state.sellerProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const adminProposals = (state.adminProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  // ë³´ë‚¸ ì œì•ˆ êµ¬ë¶„: ê¸´ê¸‰ìš”ì²­ ì—°ê³„ vs ì§ì ‘ ì œì•ˆ
  const sentFromUrgent = adminProposals.filter(p => p.urgentSaleId);
  const sentDirect = adminProposals.filter(p => !p.urgentSaleId);
  
  // í†µê³„
  const urgentPending = urgentList.filter(u => !u.status || u.status === 'pending').length;
  const sellerPending = sellerProposals.filter(p => !p.status || p.status === 'pending').length;
  const adminPending = adminProposals.filter(p => !p.sellerStatus || p.sellerStatus === 'pending').length;
  
  // ì„±ì‚¬ëœ ì œì•ˆ (ìº˜ë¦°ë” ë“±ë¡ ê°€ëŠ¥)
  const approvedProposals = [
    ...sellerProposals.filter(p => p.status === 'approved' && !p.calendarRegistered),
    ...adminProposals.filter(p => p.sellerStatus === 'accepted' && !p.calendarRegistered)
  ];
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ê³µêµ¬ ì œì•ˆ ê´€ë¦¬</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ê³µê¸‰ì‚¬ ê¸´ê¸‰ìš”ì²­ ì ‘ìˆ˜ â†’ ì…€ëŸ¬ì—ê²Œ ì œì•ˆ â†’ ê³µêµ¬ ì„±ì‚¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
      <button onclick="openAdminProposalModal()" style="
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35);
        display: flex;
        align-items: center;
        gap: 6px;
      ">
        <span style="font-size: 18px;">+</span> ì…€ëŸ¬ì—ê²Œ ì œì•ˆ
      </button>
    </div>
    
    ${approvedProposals.length > 0 ? `
    <!-- ì„±ì‚¬ëœ ì œì•ˆ ì•Œë¦¼ -->
    <div style="background: #dcfce7; border: 1px solid #86efac; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600; color: var(--success);">ğŸ‰ ì„±ì‚¬ëœ ì œì•ˆ ${approvedProposals.length}ê±´</div>
          <div style="font-size: 13px; color: var(--gray-600); margin-top: 4px;">ìº˜ë¦°ë”ì— ê³µêµ¬ ì¼ì •ì„ ë“±ë¡í•˜ì„¸ìš”</div>
        </div>
        <button onclick="showApprovedProposals()" style="padding: 10px 16px; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
          ğŸ“… ìº˜ë¦°ë” ë“±ë¡
        </button>
      </div>
    </div>
    ` : ''}
    
    <!-- íƒ­ -->
    <div style="display: flex; gap: 4px; margin-bottom: 24px; background: var(--gray-100); padding: 4px; border-radius: 12px;">
      <button id="tab-urgent" onclick="switchDealCenterTab('urgent')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600); color: white; cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.3);
      ">
        ğŸ­ ê³µê¸‰ì‚¬ ê¸´ê¸‰ìš”ì²­ <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 8px; margin-left: 4px;">${urgentList.length}</span>
        ${urgentPending > 0 ? `<span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ëŒ€ê¸° ${urgentPending}</span>` : ''}
      </button>
      <button id="tab-received" onclick="switchDealCenterTab('received')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: transparent; color: var(--gray-500); cursor: pointer;
      ">
        ğŸ‘¤ ì…€ëŸ¬ ë°›ì€ ì œì•ˆ <span style="opacity: 0.7;">${sellerProposals.length}</span>
        ${sellerPending > 0 ? `<span style="background: #2563eb; color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ê²€í†  ${sellerPending}</span>` : ''}
      </button>
      <button id="tab-sent" onclick="switchDealCenterTab('sent')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: transparent; color: var(--gray-500); cursor: pointer;
      ">
        ğŸ“¤ ë³´ë‚¸ ì œì•ˆ <span style="opacity: 0.7;">${adminProposals.length}</span>
        ${adminPending > 0 ? `<span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ëŒ€ê¸° ${adminPending}</span>` : ''}
      </button>
    </div>
    
    <!-- ì½˜í…ì¸  ì˜ì—­ -->
    <div id="dealCenterContent">
      ${renderDealCenterUrgent(urgentList)}
    </div>
  `;
}

// ì„±ì‚¬ëœ ì œì•ˆ ëª©ë¡ í‘œì‹œ (ìº˜ë¦°ë” ë“±ë¡ìš©)
function showApprovedProposals() {
  const sellerProposals = (state.sellerProposals || []).filter(p => p.status === 'approved' && !p.calendarRegistered);
  const adminProposals = (state.adminProposals || []).filter(p => p.sellerStatus === 'accepted' && !p.calendarRegistered);
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“… ì„±ì‚¬ëœ ì œì•ˆ â†’ ìº˜ë¦°ë” ë“±ë¡</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <p style="color: var(--gray-600); margin-bottom: 16px;">ì„±ì‚¬ëœ ê³µêµ¬ ì œì•ˆì„ ìº˜ë¦°ë”ì— ë“±ë¡í•˜ì„¸ìš”.</p>
        
        ${sellerProposals.length > 0 ? `
        <div style="margin-bottom: 20px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ‘¤ ì…€ëŸ¬ì—ê²Œ ë°›ì€ ì œì•ˆ</div>
          ${sellerProposals.map(p => {
            const seller = state.sellers.find(s => s.id === p.sellerId);
            return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600;">${p.productName || '-'}</div>
                <div style="font-size: 12px; color: var(--gray-500);">ì…€ëŸ¬: ${seller?.name || '-'} | ${p.desiredDate || '-'}</div>
              </div>
              <button onclick="registerToCalendar('sellerProposal', '${p.id}')" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                ë“±ë¡
              </button>
            </div>
          `}).join('')}
        </div>
        ` : ''}
        
        ${adminProposals.length > 0 ? `
        <div>
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ“¤ ë³´ë‚¸ ì œì•ˆ (ì…€ëŸ¬ ìˆ˜ë½)</div>
          ${adminProposals.map(p => {
            const seller = state.sellers.find(s => s.id === p.sellerId);
            return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600;">${p.productName || '-'}</div>
                <div style="font-size: 12px; color: var(--gray-500);">ì…€ëŸ¬: ${seller?.name || '-'} | ${p.urgentSaleId ? 'ğŸ­ ê¸´ê¸‰ìš”ì²­ ì—°ê³„' : 'âœï¸ ì§ì ‘ ì œì•ˆ'}</div>
              </div>
              <button onclick="registerToCalendar('adminProposal', '${p.id}')" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                ë“±ë¡
              </button>
            </div>
          `}).join('')}
        </div>
        ` : ''}
        
        ${sellerProposals.length === 0 && adminProposals.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          <div style="font-size: 32px; margin-bottom: 8px;">âœ…</div>
          <p>ë“±ë¡ ëŒ€ê¸° ì¤‘ì¸ ì„±ì‚¬ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        ` : ''}
      </div>
    </div>
  `;
}

// ì„±ì‚¬ëœ ì œì•ˆ â†’ ìº˜ë¦°ë” ë“±ë¡
async function registerToCalendar(type, proposalId) {
  let proposal;
  if (type === 'sellerProposal') {
    proposal = state.sellerProposals.find(p => p.id === proposalId);
  } else {
    proposal = state.adminProposals.find(p => p.id === proposalId);
  }
  
  if (!proposal) {
    showToast('ì œì•ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ìº˜ë¦°ë” ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
  closeModal();
  
  // ê³µêµ¬ ë“±ë¡ ëª¨ë‹¬ì— ë°ì´í„° ë¯¸ë¦¬ ì±„ìš°ê¸°
  setTimeout(() => {
    openAddDealModal(proposal.desiredDate || new Date().toISOString().slice(0, 10));
    
    // ëª¨ë‹¬ì´ ì—´ë¦° í›„ ë°ì´í„° ì±„ìš°ê¸°
    setTimeout(() => {
      const nameInput = document.getElementById('dealName');
      const sellerSelect = document.getElementById('dealSellerId');
      
      if (nameInput) nameInput.value = proposal.productName || '';
      if (sellerSelect && proposal.sellerId) {
        sellerSelect.value = proposal.sellerId;
      }
      
      // calendarRegistered í”Œë˜ê·¸ ì„¤ì • (ì €ì¥ ì‹œ)
      window.pendingProposalRegistration = { type, proposalId };
      
      showToast('ê³µêµ¬ ì •ë³´ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ì •ë³´ë¥¼ ì…ë ¥ í›„ ì €ì¥í•˜ì„¸ìš”.');
    }, 300);
  }, 200);
}

// ì˜¤ëŠ˜ ì²˜ë¦¬ëœ ê±´ìˆ˜
function getTodayProcessed() {
  const today = new Date().toISOString().slice(0, 10);
  let count = 0;
  
  // ê¸´ê¸‰íŒë§¤ìš”ì²­ ì¤‘ ì˜¤ëŠ˜ ì™„ë£Œëœ ê²ƒ
  (state.urgentSales || []).forEach(u => {
    if (u.status === 'completed' && u.updatedAt?.slice(0, 10) === today) count++;
  });
  
  // ì…€ëŸ¬ ì œì•ˆ ì¤‘ ì˜¤ëŠ˜ ì²˜ë¦¬ëœ ê²ƒ
  (state.sellerProposals || []).forEach(p => {
    if ((p.status === 'approved' || p.status === 'rejected') && p.updatedAt?.slice(0, 10) === today) count++;
  });
  
  return count;
}

// íƒ­ ì „í™˜
function switchDealCenterTab(tab) {
  // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
  ['urgent', 'received', 'sent'].forEach(t => {
    const btn = document.getElementById('tab-' + t);
    if (btn) {
      if (t === tab) {
        btn.style.background = 'linear-gradient(145deg, #fc9600, #e08600)';
        btn.style.color = 'white';
        btn.style.boxShadow = '0 4px 12px rgba(252,150,0,0.3)';
      } else {
        btn.style.background = 'transparent';
        btn.style.color = 'var(--gray-500)';
        btn.style.boxShadow = 'none';
      }
    }
  });
  
  // ì½˜í…ì¸  ë³€ê²½
  const content = document.getElementById('dealCenterContent');
  if (tab === 'urgent') {
    const urgentList = (state.urgentSales || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    content.innerHTML = renderDealCenterUrgent(urgentList);
  } else if (tab === 'received') {
    const sellerProposals = (state.sellerProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    content.innerHTML = renderDealCenterReceived(sellerProposals);
  } else if (tab === 'sent') {
    const adminProposals = (state.adminProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    content.innerHTML = renderDealCenterSent(adminProposals);
  }
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ íƒ­ ì½˜í…ì¸ 
function renderDealCenterUrgent(urgentList) {
  if (urgentList.length === 0) {
    return `
      <div class="card" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div>
        <p style="color: var(--gray-500);">ë“±ë¡ëœ ê¸´ê¸‰íŒë§¤ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <p style="font-size: 13px; color: var(--gray-400); margin-top: 8px;">íŒŒíŠ¸ë„ˆ í¬í„¸ì—ì„œ ê³µê¸‰ì‚¬ê°€ ê¸´ê¸‰íŒë§¤ìš”ì²­ì„ ë“±ë¡í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
    `;
  }
  
  return `
    <div class="card">
      <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
        ğŸ­ <strong>ê³µê¸‰ì‚¬ íŒŒíŠ¸ë„ˆ í¬í„¸</strong>ì—ì„œ ë“±ë¡í•œ ê¸´ê¸‰íŒë§¤ìš”ì²­ì…ë‹ˆë‹¤. ê²€í†  í›„ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ë¥¼ ì œì•ˆí•˜ì„¸ìš”.
      </p>
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ìƒíƒœ</th>
              <th>ê³µê¸‰ì‚¬</th>
              <th>ìƒí’ˆëª…</th>
              <th>ìš”ì²­ìœ í˜•</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>í¬ë§ì¼</th>
              <th>ë“±ë¡ì¼</th>
              <th style="text-align: center;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${urgentList.map(u => {
              const supplier = state.suppliers.find(s => s.id === u.supplierId);
              const supplierName = supplier?.name || u.supplierName || '-';
              const statusLabel = u.status === 'completed' ? 'ì™„ë£Œ' : u.status === 'processing' ? 'ì²˜ë¦¬ì¤‘' : 'ëŒ€ê¸°';
              const statusColor = u.status === 'completed' ? '#16a34a' : u.status === 'processing' ? 'var(--primary)' : '#dc2626';
              const statusBg = u.status === 'completed' ? '#f0fdf4' : u.status === 'processing' ? '#fff8f0' : '#fef2f2';
              
              return `
                <tr>
                  <td>
                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">
                      ${statusLabel}
                    </span>
                  </td>
                  <td style="font-weight: 600;">${supplierName}</td>
                  <td>${u.productName || '-'}</td>
                  <td>
                    <span style="padding: 3px 8px; border-radius: 8px; font-size: 11px; background: ${u.requestType === 'newProduct' ? '#dbeafe' : u.requestType === 'inventory' ? '#fef3c7' : '#f3e8ff'}; color: ${u.requestType === 'newProduct' ? '#1d4ed8' : u.requestType === 'inventory' ? '#d97706' : '#7c3aed'};">
                      ${u.requestType === 'newProduct' ? 'ì‹ ìƒí’ˆ' : u.requestType === 'inventory' ? 'ì¬ê³ ì²˜ë¦¬' : u.requestType === 'seasonal' ? 'ì‹œì¦Œìƒí’ˆ' : 'ê¸°íƒ€'}
                    </span>
                  </td>
                  <td>${u.quantity || '-'}ê°œ</td>
                  <td>${u.desiredDate || '-'}</td>
                  <td style="font-size: 12px; color: var(--gray-500);">${u.createdAt?.slice(0, 10) || '-'}</td>
                  <td style="text-align: center;">
                    <div style="display: flex; gap: 6px; justify-content: center;">
                      <button onclick="viewUrgentSalesDetail('${u.id}')" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; background: white; cursor: pointer; font-size: 12px;">ìƒì„¸</button>
                      ${u.status !== 'completed' ? `
                        <button onclick="proposeUrgentToSeller('${u.id}')" style="padding: 6px 12px; border: none; border-radius: 6px; background: var(--primary); color: white; cursor: pointer; font-size: 12px; font-weight: 600;">ê³µêµ¬ì œì•ˆ</button>
                      ` : ''}
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ë°›ì€ ì œì•ˆ íƒ­ ì½˜í…ì¸  (ì…€ëŸ¬ â†’ ì–´ë“œë¯¼)
function renderDealCenterReceived(sellerProposals) {
  if (sellerProposals.length === 0) {
    return `
      <div class="card" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¨</div>
        <p style="color: var(--gray-500);">ì…€ëŸ¬ë¡œë¶€í„° ë°›ì€ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <p style="font-size: 13px; color: var(--gray-400); margin-top: 8px;">íŒŒíŠ¸ë„ˆ í¬í„¸ì—ì„œ ì…€ëŸ¬ê°€ ê³µêµ¬ ì œì•ˆì„ ë³´ë‚´ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
    `;
  }
  
  return `
    <div class="card">
      <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
        ğŸ‘¤ <strong>ì…€ëŸ¬ íŒŒíŠ¸ë„ˆ í¬í„¸</strong>ì—ì„œ ë³´ë‚¸ ê³µêµ¬ ì œì•ˆì…ë‹ˆë‹¤.
      </p>
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ìƒíƒœ</th>
              <th>ì…€ëŸ¬</th>
              <th>ì œì•ˆ ì œëª©</th>
              <th>ë¸Œëœë“œ/ìƒí’ˆ</th>
              <th>í¬ë§ê°€ê²©</th>
              <th>ì œì•ˆì¼</th>
              <th style="text-align: center;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${sellerProposals.map(p => {
              const statusLabel = p.status === 'approved' ? 'ìŠ¹ì¸' : p.status === 'rejected' ? 'ë°˜ë ¤' : 'ê²€í† ëŒ€ê¸°';
              const statusColor = p.status === 'approved' ? '#16a34a' : p.status === 'rejected' ? '#dc2626' : '#2563eb';
              const statusBg = p.status === 'approved' ? '#f0fdf4' : p.status === 'rejected' ? '#fef2f2' : '#eff6ff';
              
              return `
                <tr>
                  <td>
                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">
                      ${statusLabel}
                    </span>
                    ${p.status === 'approved' && !p.calendarRegistered ? '<span style="margin-left: 4px; font-size: 10px; color: var(--success);">ğŸ“… ë“±ë¡ê°€ëŠ¥</span>' : ''}
                  </td>
                  <td style="font-weight: 600;">${p.sellerName || '-'}</td>
                  <td>${p.title || '-'}</td>
                  <td>${p.brandName || p.productName || '-'}</td>
                  <td>${p.desiredPrice ? formatNumber(p.desiredPrice) + 'ì›' : '-'}</td>
                  <td style="font-size: 12px; color: var(--gray-500);">${p.createdAt?.slice(0, 10) || '-'}</td>
                  <td style="text-align: center;">
                    <div style="display: flex; gap: 6px; justify-content: center;">
                      ${p.status === 'approved' && !p.calendarRegistered ? `
                        <button onclick="registerToCalendar('sellerProposal', '${p.id}')" style="padding: 6px 12px; border: 1px solid var(--success); border-radius: 6px; background: #f0fdf4; color: var(--success); cursor: pointer; font-size: 12px; font-weight: 600;">ğŸ“… ë“±ë¡</button>
                      ` : ''}
                      <button onclick="viewSellerProposalDetail('${p.id}')" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; background: white; cursor: pointer; font-size: 12px;">ìƒì„¸</button>
                      <button onclick="deleteSellerProposal('${p.id}')" style="padding: 6px 12px; border: 1px solid #dc2626; border-radius: 6px; background: white; color: #dc2626; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ë³´ë‚¸ ì œì•ˆ íƒ­ ì½˜í…ì¸  (ì–´ë“œë¯¼ â†’ ì…€ëŸ¬)
function renderDealCenterSent(adminProposals) {
  if (adminProposals.length === 0) {
    return `
      <div class="card" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¬</div>
        <p style="color: var(--gray-500);">ì…€ëŸ¬ì—ê²Œ ë³´ë‚¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <button class="btn btn-primary" style="margin-top: 16px;" onclick="openAdminProposalModal()">+ ìƒˆ ì œì•ˆ ë³´ë‚´ê¸°</button>
      </div>
    `;
  }
  
  return `
    <div class="card">
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>êµ¬ë¶„</th>
              <th>ì…€ëŸ¬ì‘ë‹µ</th>
              <th>ëŒ€ìƒ ì…€ëŸ¬</th>
              <th>ìƒí’ˆëª…</th>
              <th>ê³µê¸‰ì‚¬</th>
              <th>ì œì•ˆì¼</th>
              <th style="text-align: center;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${adminProposals.map(p => {
              const statusLabel = p.sellerStatus === 'accepted' ? 'ìˆ˜ë½' : p.sellerStatus === 'rejected' ? 'ê±°ì ˆ' : 'ëŒ€ê¸°ì¤‘';
              const statusColor = p.sellerStatus === 'accepted' ? '#16a34a' : p.sellerStatus === 'rejected' ? '#dc2626' : 'var(--primary)';
              const statusBg = p.sellerStatus === 'accepted' ? '#f0fdf4' : p.sellerStatus === 'rejected' ? '#fef2f2' : '#fff8f0';
              
              // êµ¬ë¶„: ê¸´ê¸‰ìš”ì²­ ì—°ê³„ vs ì§ì ‘ ì œì•ˆ
              const sourceType = p.urgentSaleId ? 'ğŸ­ ê¸´ê¸‰ìš”ì²­' : 'âœï¸ ì§ì ‘ì œì•ˆ';
              const sourceBg = p.urgentSaleId ? '#fef3c7' : '#e0e7ff';
              const sourceColor = p.urgentSaleId ? '#d97706' : '#4f46e5';
              
              return `
                <tr>
                  <td>
                    <span style="padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ${sourceBg}; color: ${sourceColor};">
                      ${sourceType}
                    </span>
                  </td>
                  <td>
                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">
                      ${statusLabel}
                    </span>
                    ${p.sellerStatus === 'accepted' && !p.calendarRegistered ? '<span style="margin-left: 4px; font-size: 10px; color: var(--success);">ğŸ“… ë“±ë¡ê°€ëŠ¥</span>' : ''}
                  </td>
                  <td style="font-weight: 600;">${p.sellerName || '-'}</td>
                  <td>${p.productName || '-'}</td>
                  <td>${p.supplierName || '-'}</td>
                  <td style="font-size: 12px; color: var(--gray-500);">${p.createdAt?.slice(0, 10) || '-'}</td>
                  <td style="text-align: center;">
                    <div style="display: flex; gap: 6px; justify-content: center;">
                      ${p.sellerStatus === 'accepted' && !p.calendarRegistered ? `
                        <button onclick="registerToCalendar('adminProposal', '${p.id}')" style="padding: 6px 12px; border: 1px solid var(--success); border-radius: 6px; background: #f0fdf4; color: var(--success); cursor: pointer; font-size: 12px; font-weight: 600;">ğŸ“… ë“±ë¡</button>
                      ` : ''}
                      <button onclick="openAdminProposalModal(true, '${p.id}')" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; background: white; cursor: pointer; font-size: 12px;">ìˆ˜ì •</button>
                      <button onclick="deleteAdminProposal('${p.id}')" style="padding: 6px 12px; border: 1px solid #dc2626; border-radius: 6px; background: white; color: #dc2626; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ì…€ëŸ¬ ì œì•ˆ ìƒì„¸ ë³´ê¸°
function viewSellerProposalDetail(proposalId) {
  const p = (state.sellerProposals || []).find(pr => pr.id === proposalId);
  if (!p) return;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ“¨ ì…€ëŸ¬ ì œì•ˆ ìƒì„¸</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; gap: 12px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ì…€ëŸ¬</div>
              <div style="font-weight: 600;">${p.sellerName || '-'}</div>
            </div>
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ì œì•ˆì¼</div>
              <div style="font-weight: 600;">${p.createdAt?.slice(0, 10) || '-'}</div>
            </div>
          </div>
          <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
            <div style="font-size: 11px; color: var(--gray-500);">ì œì•ˆ ì œëª©</div>
            <div style="font-weight: 600; font-size: 15px;">${p.title || '-'}</div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ë¸Œëœë“œ/ìƒí’ˆ</div>
              <div style="font-weight: 600;">${p.brandName || p.productName || '-'}</div>
            </div>
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">í¬ë§ê°€ê²©</div>
              <div style="font-weight: 600;">${p.desiredPrice ? formatNumber(p.desiredPrice) + 'ì›' : '-'}</div>
            </div>
          </div>
          ${p.content ? `
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ì œì•ˆ ë‚´ìš©</div>
              <div style="white-space: pre-wrap; margin-top: 4px;">${p.content}</div>
            </div>
          ` : ''}
          ${p.referenceLink ? `
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ì°¸ê³  ë§í¬</div>
              <a href="${p.referenceLink}" target="_blank" style="color: var(--primary); text-decoration: underline;">${p.referenceLink}</a>
            </div>
          ` : ''}
          <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
            <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 8px;">ìƒíƒœ ë³€ê²½</div>
            <select id="sellerProposalStatus" style="width: 100%; padding: 8px; border: 1px solid var(--gray-200); border-radius: 6px;">
              <option value="pending" ${!p.status || p.status === 'pending' ? 'selected' : ''}>ê²€í† ëŒ€ê¸°</option>
              <option value="approved" ${p.status === 'approved' ? 'selected' : ''}>ìŠ¹ì¸</option>
              <option value="rejected" ${p.status === 'rejected' ? 'selected' : ''}>ë°˜ë ¤</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 8px; justify-content: space-between;">
        <button class="btn" style="background: var(--danger); color: white;" onclick="deleteSellerProposal('${p.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          <button class="btn btn-primary" onclick="updateSellerProposalStatus('${p.id}')">ìƒíƒœ ì €ì¥</button>
        </div>
      </div>
    </div>
  `;
}

// ì…€ëŸ¬ ì œì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateSellerProposalStatus(proposalId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const status = document.getElementById('sellerProposalStatus').value;
  try {
    await db.collection('sellerProposals').doc(proposalId).update({ 
      status,
      updatedAt: new Date().toISOString()
    });
    showToast('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    setTimeout(() => switchDealCenterTab('received'), 300);
  } catch (e) {
    console.error(e);
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì…€ëŸ¬ ì œì•ˆ ì‚­ì œ
async function deleteSellerProposal(proposalId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì´ ì œì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('sellerProposals').doc(proposalId).delete();
    showToast('ì œì•ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    setTimeout(() => switchDealCenterTab('received'), 300);
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì–´ë“œë¯¼ ì œì•ˆ ì‚­ì œ
async function deleteAdminProposal(proposalId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì´ ì œì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('adminProposals').doc(proposalId).delete();
    showToast('ì œì•ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(() => switchDealCenterTab('sent'), 300);
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ê¸´ê¸‰íŒë§¤ìš”ì²­ ê´€ë¦¬ ====================
function renderUrgentSales() {
  const app = document.getElementById('app');
  
  const urgentList = state.urgentSales.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  // ìƒíƒœë³„ ë¶„ë¥˜
  const pendingList = urgentList.filter(u => u.status === 'pending' || !u.status);
  const processingList = urgentList.filter(u => u.status === 'processing');
  const completedList = urgentList.filter(u => u.status === 'completed');
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ”¥ ê¸´ê¸‰íŒë§¤ìš”ì²­</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ê³µê¸‰ì‚¬ê°€ ë“±ë¡í•œ ê¸´ê¸‰íŒë§¤ìš”ì²­ì„ í™•ì¸í•˜ê³  ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ì œì•ˆí•©ë‹ˆë‹¤.</p>
      </div>
    </div>
    
    <!-- ìš”ì•½ ì¹´ë“œ -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
      <div style="padding: 20px; background: linear-gradient(145deg, #fef2f2, #fee2e2); border-radius: 14px; border: 1px solid #fecaca;">
        <div style="font-size: 28px; font-weight: 700; color: #dc2626;">${pendingList.length}</div>
        <div style="font-size: 13px; color: var(--gray-600);">ëŒ€ê¸° ì¤‘</div>
      </div>
      <div style="padding: 20px; background: linear-gradient(145deg, #fff8f0, #fff5eb); border-radius: 14px; border: 1px solid rgba(252,150,0,0.3);">
        <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${processingList.length}</div>
        <div style="font-size: 13px; color: var(--gray-600);">ì²˜ë¦¬ ì¤‘</div>
      </div>
      <div style="padding: 20px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 14px; border: 1px solid #86efac;">
        <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${completedList.length}</div>
        <div style="font-size: 13px; color: var(--gray-600);">ì™„ë£Œ</div>
      </div>
    </div>
    
    <div class="card">
      <h3 class="card-title" style="margin-bottom: 16px;">ìš”ì²­ ëª©ë¡ (${urgentList.length}ê±´)</h3>
      
      ${urgentList.length === 0 ? `
        <div style="text-align: center; padding: 60px 20px; color: var(--gray-500);">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div>
          <p>ì•„ì§ ë“±ë¡ëœ ê¸´ê¸‰íŒë§¤ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ìƒíƒœ</th>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ìƒí’ˆëª…</th>
                <th>ìš”ì²­ìœ í˜•</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>í¬ë§ì¼</th>
                <th>ë“±ë¡ì¼</th>
                <th style="text-align: center;">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${urgentList.map(u => {
                const supplier = state.suppliers.find(s => s.id === u.supplierId);
                const supplierName = supplier?.name || u.supplierName || '-';
                const statusLabel = u.status === 'completed' ? 'ì™„ë£Œ' : u.status === 'processing' ? 'ì²˜ë¦¬ì¤‘' : 'ëŒ€ê¸°';
                const statusColor = u.status === 'completed' ? '#16a34a' : u.status === 'processing' ? 'var(--primary)' : '#dc2626';
                const statusBg = u.status === 'completed' ? '#f0fdf4' : u.status === 'processing' ? '#fff8f0' : '#fef2f2';
                
                return `
                  <tr>
                    <td>
                      <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">
                        ${statusLabel}
                      </span>
                    </td>
                    <td style="font-weight: 600;">${supplierName}</td>
                    <td>${u.productName || '-'}</td>
                    <td>
                      <span style="padding: 3px 8px; border-radius: 8px; font-size: 11px; background: ${u.requestType === 'newProduct' ? '#dbeafe' : u.requestType === 'inventory' ? '#fef3c7' : '#f3e8ff'}; color: ${u.requestType === 'newProduct' ? '#1d4ed8' : u.requestType === 'inventory' ? '#d97706' : '#7c3aed'};">
                        ${u.requestType === 'newProduct' ? 'ì‹ ìƒí’ˆ' : u.requestType === 'inventory' ? 'ì¬ê³ ì²˜ë¦¬' : u.requestType === 'seasonal' ? 'ì‹œì¦Œìƒí’ˆ' : 'ê¸°íƒ€'}
                      </span>
                    </td>
                    <td>${u.quantity || '-'}ê°œ</td>
                    <td>${u.desiredDate || '-'}</td>
                    <td style="font-size: 12px; color: var(--gray-500);">${u.createdAt?.slice(0, 10) || '-'}</td>
                    <td style="text-align: center;">
                      <div style="display: flex; gap: 6px; justify-content: center;">
                        <button onclick="viewUrgentSalesDetail('${u.id}')" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; background: white; cursor: pointer; font-size: 12px;">ìƒì„¸</button>
                        ${u.status !== 'completed' ? `
                          <button onclick="proposeUrgentToSeller('${u.id}')" style="padding: 6px 12px; border: none; border-radius: 6px; background: var(--primary); color: white; cursor: pointer; font-size: 12px; font-weight: 600;">ê³µêµ¬ì œì•ˆ</button>
                        ` : ''}
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ ìƒì„¸ ë³´ê¸°
function viewUrgentSalesDetail(urgentId) {
  const u = state.urgentSales.find(item => item.id === urgentId);
  if (!u) return;
  
  const supplier = state.suppliers.find(s => s.id === u.supplierId);
  const supplierName = supplier?.name || u.supplierName || '-';
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ”¥ ê¸´ê¸‰íŒë§¤ìš”ì²­ ìƒì„¸</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; gap: 16px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ê³µê¸‰ì‚¬</div>
              <div style="font-weight: 700; color: var(--gray-800);">${supplierName}</div>
            </div>
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìš”ì²­ìœ í˜•</div>
              <div style="font-weight: 700; color: var(--primary);">
                ${u.requestType === 'newProduct' ? 'ì‹ ìƒí’ˆ í™ë³´' : u.requestType === 'inventory' ? 'ì¬ê³ ì²˜ë¦¬' : u.requestType === 'seasonal' ? 'ì‹œì¦Œìƒí’ˆ' : 'ê¸°íƒ€'}
              </div>
            </div>
          </div>
          
          <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìƒí’ˆëª…</div>
            <div style="font-weight: 700; font-size: 16px; color: var(--gray-800);">${u.productName || '-'}</div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">í¬ë§ ìˆ˜ëŸ‰</div>
              <div style="font-weight: 700; color: var(--gray-800);">${u.quantity || '-'}ê°œ</div>
            </div>
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">í¬ë§ì¼</div>
              <div style="font-weight: 700; color: var(--gray-800);">${u.desiredDate || '-'}</div>
            </div>
          </div>
          
          ${u.note ? `
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìš”ì²­ì‚¬í•­</div>
              <div style="color: var(--gray-700); white-space: pre-wrap;">${u.note}</div>
            </div>
          ` : ''}
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ë“±ë¡ì¼</div>
              <div style="color: var(--gray-700);">${u.createdAt?.slice(0, 10) || '-'}</div>
            </div>
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìƒíƒœ</div>
              <div>
                <select id="urgentStatus" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 13px;">
                  <option value="pending" ${u.status === 'pending' || !u.status ? 'selected' : ''}>ëŒ€ê¸°</option>
                  <option value="processing" ${u.status === 'processing' ? 'selected' : ''}>ì²˜ë¦¬ì¤‘</option>
                  <option value="completed" ${u.status === 'completed' ? 'selected' : ''}>ì™„ë£Œ</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 8px; justify-content: space-between;">
        <button class="btn" style="background: var(--danger); color: white;" onclick="deleteUrgentSales('${u.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          <button class="btn btn-secondary" onclick="updateUrgentSalesStatus('${u.id}')">ìƒíƒœ ì €ì¥</button>
          ${u.status !== 'completed' ? `
            <button class="btn btn-primary" onclick="proposeUrgentToSeller('${u.id}')">ğŸš€ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ì œì•ˆ</button>
          ` : ''}
      </div>
    </div>
  `;
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateUrgentSalesStatus(urgentId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const status = document.getElementById('urgentStatus').value;
  try {
    await db.collection('urgentSales').doc(urgentId).update({ status });
    showToast('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ ì‚­ì œ
async function deleteUrgentSales(urgentId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì´ ê¸´ê¸‰íŒë§¤ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('urgentSales').doc(urgentId).delete();
    showToast('ê¸´ê¸‰íŒë§¤ìš”ì²­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ â†’ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ì œì•ˆ
function proposeUrgentToSeller(urgentId) {
  const u = state.urgentSales.find(item => item.id === urgentId);
  if (!u) return;
  
  const supplier = state.suppliers.find(s => s.id === u.supplierId);
  const supplierName = supplier?.name || u.supplierName || '-';
  
  // ì…€ëŸ¬ ëª©ë¡ (ì—°ë½ì²˜ ìˆëŠ” ì…€ëŸ¬ë§Œ)
  const activeSellers = state.sellers.filter(s => s.name);
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸš€ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ì œì•ˆ</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="padding: 16px; background: linear-gradient(145deg, #fff8f0, #fff5eb); border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ê¸´ê¸‰íŒë§¤ìš”ì²­ ì •ë³´</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <span style="font-size: 12px; color: var(--gray-500);">ê³µê¸‰ì‚¬:</span>
              <span style="font-weight: 600; margin-left: 4px;">${supplierName}</span>
            </div>
            <div>
              <span style="font-size: 12px; color: var(--gray-500);">ìƒí’ˆ:</span>
              <span style="font-weight: 600; margin-left: 4px;">${u.productName || '-'}</span>
            </div>
            <div>
              <span style="font-size: 12px; color: var(--gray-500);">ìˆ˜ëŸ‰:</span>
              <span style="font-weight: 600; margin-left: 4px;">${u.quantity || '-'}ê°œ</span>
            </div>
            <div>
              <span style="font-size: 12px; color: var(--gray-500);">í¬ë§ì¼:</span>
              <span style="font-weight: 600; margin-left: 4px;">${u.desiredDate || '-'}</span>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œì•ˆí•  ì…€ëŸ¬ ì„ íƒ <span style="color: #dc2626;">*</span></label>
          <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 10px; padding: 12px;">
            ${activeSellers.length === 0 ? `
              <p style="text-align: center; color: var(--gray-400); padding: 20px;">ë“±ë¡ëœ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            ` : activeSellers.map(s => {
              const parts = s.name?.split('/') || [s.name];
              const displayName = parts.length > 1 ? `${parts[0]} (${parts[1]})` : s.name;
              return `
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; background: var(--gray-50);">
                  <input type="checkbox" class="urgent-seller-checkbox" value="${s.id}" style="width: 18px; height: 18px;">
                  <span style="flex: 1; font-weight: 500;">${displayName}</span>
                </label>
              `;
            }).join('')}
          </div>
          <div style="margin-top: 8px; display: flex; gap: 8px;">
            <button type="button" onclick="document.querySelectorAll('.urgent-seller-checkbox').forEach(c=>c.checked=true)" style="padding: 6px 12px; background: var(--gray-100); border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">ì „ì²´ì„ íƒ</button>
            <button type="button" onclick="document.querySelectorAll('.urgent-seller-checkbox').forEach(c=>c.checked=false)" style="padding: 6px 12px; background: var(--gray-100); border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">ì „ì²´í•´ì œ</button>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œì•ˆ ë©”ì‹œì§€</label>
          <textarea id="urgentProposalMessage" class="form-control" rows="4" placeholder="ì…€ëŸ¬ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">${supplierName}ì—ì„œ ê¸´ê¸‰íŒë§¤ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤.\n\nìƒí’ˆ: ${u.productName || '-'}\nìˆ˜ëŸ‰: ${u.quantity || '-'}ê°œ\ní¬ë§ì¼: ${u.desiredDate || '-'}\n\nê´€ì‹¬ ìˆìœ¼ì‹œë©´ ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤!</textarea>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="sendUrgentProposalToSellers('${u.id}')">ğŸš€ ì œì•ˆ ë³´ë‚´ê¸°</button>
      </div>
    </div>
  `;
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ ê³µêµ¬ì œì•ˆ ì „ì†¡
async function sendUrgentProposalToSellers(urgentId) {
  const u = state.urgentSales.find(item => item.id === urgentId);
  if (!u) return;
  
  const checkedSellers = Array.from(document.querySelectorAll('.urgent-seller-checkbox:checked')).map(c => c.value);
  const message = document.getElementById('urgentProposalMessage').value;
  
  if (checkedSellers.length === 0) {
    showToast('ì œì•ˆí•  ì…€ëŸ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    // ê° ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ì œì•ˆ ìƒì„±
    for (const sellerId of checkedSellers) {
      const seller = state.sellers.find(s => s.id === sellerId);
      const supplier = state.suppliers.find(s => s.id === u.supplierId);
      
      await db.collection('adminProposals').add({
        sellerId,
        sellerName: seller?.name || '',
        supplierId: u.supplierId || '',
        supplierName: supplier?.name || u.supplierName || '',
        productName: u.productName || '',
        message: message,
        quantity: u.quantity || '',
        desiredDate: u.desiredDate || '',
        status: 'pending',
        source: 'urgentSales',
        urgentSalesId: urgentId,
        createdAt: new Date().toISOString()
      });
    }
    
    // ê¸´ê¸‰íŒë§¤ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await db.collection('urgentSales').doc(urgentId).update({ 
      status: 'processing',
      proposedAt: new Date().toISOString(),
      proposedSellers: checkedSellers
    });
    
    showToast(`${checkedSellers.length}ëª…ì˜ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì œì•ˆ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ê³µì§€ì‚¬í•­ ê´€ë¦¬ ====================
function renderPartnerNotices() {
  const app = document.getElementById('app');
  
  const notices = state.partnerNotices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ“¢ íŒŒíŠ¸ë„ˆ ê³µì§€</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">íŒŒíŠ¸ë„ˆì—ê²Œ ì „ë‹¬í•  ê³µì§€ì‚¬í•­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
      <button class="btn btn-primary" onclick="openNoticeModal()">+ ê³µì§€ ì‘ì„±</button>
    </div>
    
    <div class="card">
      ${notices.length === 0 ? `
        <div style="text-align: center; padding: 60px 20px; color: var(--gray-500);">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¢</div>
          <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 80px;">êµ¬ë¶„</th>
              <th>ì œëª©</th>
              <th style="width: 120px;">ì‘ì„±ì¼</th>
              <th style="width: 100px;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${notices.map(n => `
              <tr>
                <td>
                  <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; ${n.important ? 'background: var(--danger-light); color: var(--danger);' : 'background: var(--gray-100); color: var(--gray-600);'}">
                    ${n.important ? 'ì¤‘ìš”' : 'ì¼ë°˜'}
                  </span>
                </td>
                <td style="font-weight: 500;">${n.title}</td>
                <td style="color: var(--gray-500); font-size: 13px;">${formatDateKR(n.createdAt)}</td>
                <td>
                  <div class="actions">
                    <button class="btn btn-ghost btn-sm" onclick="openNoticeModal('${n.id}')">ìˆ˜ì •</button>
                    <button class="btn btn-ghost btn-sm" style="color: var(--danger);" onclick="deleteNotice('${n.id}')">ì‚­ì œ</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
}

// ê³µì§€ì‚¬í•­ ëª¨ë‹¬
function openNoticeModal(noticeId) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const notice = noticeId ? state.partnerNotices.find(n => n.id === noticeId) : null;
  const isEdit = !!notice;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ê³µì§€ ìˆ˜ì •' : 'ìƒˆ ê³µì§€ ì‘ì„±'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="saveNotice(event, '${noticeId || ''}')">
        <div style="padding: 20px;">
          <div class="form-group">
            <label class="form-label">ì œëª© *</label>
            <input type="text" class="form-input" id="notice-title" value="${notice?.title || ''}" placeholder="ê³µì§€ì‚¬í•­ ì œëª©" required>
          </div>
          <div class="form-group">
            <label class="form-label">ë‚´ìš© *</label>
            <textarea class="form-textarea" id="notice-content" rows="8" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required>${notice?.content || ''}</textarea>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="notice-important" ${notice?.important ? 'checked' : ''} style="width: 18px; height: 18px;">
              <span class="form-label" style="margin: 0;">ì¤‘ìš” ê³µì§€ë¡œ í‘œì‹œ</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •' : 'ë“±ë¡'}</button>
        </div>
      </form>
    </div>
  `;
}

// ê³µì§€ì‚¬í•­ ì €ì¥
async function saveNotice(e, noticeId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();
  
  const data = {
    title: document.getElementById('notice-title').value.trim(),
    content: document.getElementById('notice-content').value.trim(),
    important: document.getElementById('notice-important').checked,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (noticeId) {
      await db.collection('partnerNotices').doc(noticeId).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('partnerNotices').add(data);
    }
    
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³µì§€ì‚¬í•­ ì‚­ì œ
async function deleteNotice(noticeId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('partnerNotices').doc(noticeId).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ì…€ëŸ¬ì—ê²Œ ì œì•ˆ ê´€ë¦¬ ====================
function renderSellerProposals() {
  const app = document.getElementById('app');
  
  const proposals = (state.adminProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  const pending = proposals.filter(p => !p.sellerStatus || p.sellerStatus === 'pending');
  const accepted = proposals.filter(p => p.sellerStatus === 'accepted');
  const rejected = proposals.filter(p => p.sellerStatus === 'rejected');
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ“¨ ì…€ëŸ¬ì—ê²Œ ì œì•ˆ</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ê³µêµ¬ ì§„í–‰ì„ ìœ„í•œ ì œì•ˆì„ ì…€ëŸ¬ì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.</p>
      </div>
      <button onclick="openAdminProposalModal()" style="
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        gap: 6px;
      ">
        <span style="font-size: 18px;">+</span> ìƒˆ ì œì•ˆ ë³´ë‚´ê¸°
      </button>
    </div>
    
    <!-- í†µê³„ ì¹´ë“œ -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
      <div class="stat-card">
        <div class="stat-value">${proposals.length}</div>
        <div class="stat-label">ì „ì²´ ì œì•ˆ</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #fff8f0, #fffbf5);">
        <div class="stat-value" style="color: var(--primary);">${pending.length}</div>
        <div class="stat-label">ì‘ë‹µ ëŒ€ê¸°</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f0fdf4, #f7fef9);">
        <div class="stat-value" style="color: #16a34a;">${accepted.length}</div>
        <div class="stat-label">ìˆ˜ë½ë¨</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #fef2f2, #fef7f7);">
        <div class="stat-value" style="color: #dc2626;">${rejected.length}</div>
        <div class="stat-label">ê±°ì ˆë¨</div>
      </div>
    </div>
    
    ${pending.length > 0 ? `
      <div class="card" style="border: 2px solid var(--primary); margin-bottom: 16px; background: linear-gradient(145deg, #fffbf5, #fff8f0);">
        <h3 style="margin-bottom: 16px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 8px; font-size: 14px;">${pending.length}</span>
          ì‘ë‹µ ëŒ€ê¸°ì¤‘
        </h3>
        <div style="display: grid; gap: 12px;">
          ${pending.map(p => renderAdminProposalCard(p)).join('')}
        </div>
      </div>
    ` : ''}
    
    <div class="card">
      <h3 style="margin-bottom: 16px;">ğŸ“ ì „ì²´ ì œì•ˆ ëª©ë¡</h3>
      ${proposals.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
          ì•„ì§ ë³´ë‚¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>
          <button onclick="openAdminProposalModal()" style="
            margin-top: 16px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(145deg, #fc9600, #e08600);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(252,150,0,0.35);
          ">ì²« ì œì•ˆ ë³´ë‚´ê¸°</button>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th>ì œì•ˆì¼</th>
              <th>ì…€ëŸ¬</th>
              <th>ì œì•ˆ ì œëª©</th>
              <th>ë¸Œëœë“œ/ê³µê¸‰ì‚¬</th>
              <th>ìƒíƒœ</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${proposals.map(p => {
              const seller = state.sellers.find(s => s.id === p.targetSellerId);
              const sellerName = seller?.name?.split('/')[0] || p.targetSellerName || 'ì „ì²´ê³µê°œ';
              const statusColor = p.sellerStatus === 'accepted' ? '#16a34a' : p.sellerStatus === 'rejected' ? '#dc2626' : 'var(--primary)';
              const statusText = p.sellerStatus === 'accepted' ? 'ìˆ˜ë½ë¨' : p.sellerStatus === 'rejected' ? 'ê±°ì ˆë¨' : 'ì‘ë‹µëŒ€ê¸°';
              return `
                <tr>
                  <td>${formatDate(p.createdAt)}</td>
                  <td>${sellerName}</td>
                  <td>${p.title}</td>
                  <td>${p.brandName || '-'}</td>
                  <td><span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; background: ${p.sellerStatus === 'accepted' ? 'linear-gradient(145deg, #dcfce7, #bbf7d0)' : p.sellerStatus === 'rejected' ? 'linear-gradient(145deg, #fee2e2, #fecaca)' : 'linear-gradient(145deg, #fff8f0, #ffedd5)'}; color: ${statusColor};">${statusText}</span></td>
                  <td>
                    <div style="display: flex; gap: 6px;">
                      <button onclick="viewAdminProposal('${p.id}')" style="
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                        color: var(--gray-600);
                        border: 1px solid var(--gray-200);
                        border-radius: 6px;
                        cursor: pointer;
                      ">ìƒì„¸</button>
                      <button onclick="deleteAdminProposal('${p.id}')" style="
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        background: linear-gradient(145deg, #fef2f2, #fee2e2);
                        color: #dc2626;
                        border: 1px solid #fecaca;
                        border-radius: 6px;
                        cursor: pointer;
                      ">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
}

function renderAdminProposalCard(p) {
  const seller = state.sellers.find(s => s.id === p.targetSellerId);
  const sellerName = seller?.name?.split('/')[0] || p.targetSellerName || 'ì „ì²´ê³µê°œ';
  const sellerNickname = seller?.name?.split('/')[1] || '';
  
  return `
    <div style="padding: 16px; background: white; border-radius: 12px; border: 1px solid rgba(252,150,0,0.2); box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
        <div>
          <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">${p.title}</div>
          <div style="font-size: 13px; color: var(--gray-500);">${formatDate(p.createdAt)} Â· ëŒ€ìƒ: ${sellerName}${sellerNickname ? ` (${sellerNickname})` : ''}</div>
        </div>
        <span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; background: linear-gradient(145deg, #fff8f0, #ffedd5); color: var(--primary);">ì‘ë‹µëŒ€ê¸°</span>
      </div>
      ${p.content ? `<div style="font-size: 14px; color: var(--gray-600); margin-bottom: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px;">${p.content.substring(0, 100)}${p.content.length > 100 ? '...' : ''}</div>` : ''}
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        ${p.brandName ? `<span style="background: var(--gray-100); padding: 4px 10px; border-radius: 6px; font-size: 12px;">ë¸Œëœë“œ: ${p.brandName}</span>` : ''}
        ${p.expectedPeriod ? `<span style="background: var(--gray-100); padding: 4px 10px; border-radius: 6px; font-size: 12px;">í¬ë§ì¼ì: ${p.expectedPeriod}</span>` : ''}
        ${p.expectedMargin ? `<span style="background: var(--gray-100); padding: 4px 10px; border-radius: 6px; font-size: 12px;">ìˆ˜ìˆ˜ë£Œìœ¨: ${p.expectedMargin}</span>` : ''}
      </div>
    </div>
  `;
}

function openAdminProposalModal(proposalId = null) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const isEdit = !!proposalId;
  const p = isEdit ? state.adminProposals.find(pr => pr.id === proposalId) : {};
  
  const sellerOptions = state.sellers.map(s => {
    const name = s.name?.split('/')[0] || s.name;
    const nickname = s.name?.split('/')[1] || '';
    return `<option value="${s.id}" ${p.targetSellerId === s.id ? 'selected' : ''}>${name}${nickname ? ` (${nickname})` : ''}</option>`;
  }).join('');
  
  const modal = document.getElementById('modal');
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“¨ ${isEdit ? 'ì œì•ˆ ìˆ˜ì •' : 'ì…€ëŸ¬ì—ê²Œ ì œì•ˆ ë³´ë‚´ê¸°'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="saveAdminProposal(event, '${proposalId || ''}')">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ëŒ€ìƒ ì…€ëŸ¬ *</label>
            <select class="form-input" id="proposal-seller" required>
              <option value="">ì…€ëŸ¬ ì„ íƒ...</option>
              ${sellerOptions}
            </select>
            <small style="color: var(--gray-500);">ë˜ëŠ” ì „ì²´ ì…€ëŸ¬ì—ê²Œ ê³µê°œí•˜ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”</small>
          </div>
          <div class="form-group">
            <label class="form-label">ì œì•ˆ ì œëª© *</label>
            <input type="text" class="form-input" id="proposal-title" value="${p.title || ''}" placeholder="ì˜ˆ: 12ì›” ì‹ ì œí’ˆ ê³µêµ¬ ì œì•ˆ" required>
          </div>
          <div class="form-group">
            <label class="form-label">ë¸Œëœë“œ/ê³µê¸‰ì‚¬ëª…</label>
            <input type="text" class="form-input" id="proposal-brand" value="${p.brandName || ''}" placeholder="ì˜ˆ: ë¡œì§€ì˜¤ê°€ë‹‰">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">ì˜ˆìƒ ê¸°ê°„</label>
              <input type="text" class="form-input" id="proposal-period" value="${p.expectedPeriod || ''}" placeholder="ì˜ˆ: 12/18~12/20">
            </div>
            <div class="form-group">
              <label class="form-label">ì˜ˆìƒ ë§ˆì§„</label>
              <input type="text" class="form-input" id="proposal-margin" value="${p.expectedMargin || ''}" placeholder="ì˜ˆ: 15%">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ì œì•ˆ ë‚´ìš© *</label>
            <textarea class="form-input" id="proposal-content" rows="5" placeholder="ê³µêµ¬ ì œì•ˆ ìƒì„¸ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..." required>${p.content || ''}</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">ìƒí’ˆ ë§í¬</label>
            <input type="text" class="form-input" id="proposal-link" value="${p.productLink || ''}" placeholder="https://...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ì œì•ˆ ë³´ë‚´ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  modal.classList.add('show');
}

async function saveAdminProposal(e, proposalId = '') {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  e.preventDefault();
  
  const sellerId = document.getElementById('proposal-seller').value;
  const seller = state.sellers.find(s => s.id === sellerId);
  
  const data = {
    targetSellerId: sellerId || null,
    targetSellerName: seller?.name?.split('/')[0] || null,
    title: document.getElementById('proposal-title').value,
    brandName: document.getElementById('proposal-brand').value,
    expectedPeriod: document.getElementById('proposal-period').value,
    expectedMargin: document.getElementById('proposal-margin').value,
    content: document.getElementById('proposal-content').value,
    productLink: document.getElementById('proposal-link').value,
    isPublic: !sellerId, // ì…€ëŸ¬ ë¯¸ì„ íƒì‹œ ì „ì²´ê³µê°œ
    sellerStatus: 'pending',
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (proposalId) {
      await db.collection('adminProposals').doc(proposalId).update(data);
      showToast('ì œì•ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('adminProposals').add(data);
      showToast('ì…€ëŸ¬ì—ê²Œ ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤!');
    }
    closeModal();
    // Firebase onSnapshotì´ ìë™ìœ¼ë¡œ stateë¥¼ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë Œë”ë§
    setTimeout(() => renderSellerProposals(), 500);
  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

async function deleteAdminProposal(proposalId) {
  if (!confirm('ì´ ì œì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('adminProposals').doc(proposalId).delete();
    showToast('ì œì•ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    // Firebase onSnapshotì´ ìë™ìœ¼ë¡œ stateë¥¼ ì—…ë°ì´íŠ¸
    setTimeout(() => renderSellerProposals(), 500);
  } catch (err) {
    console.error(err);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

function viewAdminProposal(proposalId) {
  const p = state.adminProposals.find(pr => pr.id === proposalId);
  if (!p) return;
  
  const seller = state.sellers.find(s => s.id === p.targetSellerId);
  const sellerName = seller?.name?.split('/')[0] || p.targetSellerName || 'ì „ì²´ê³µê°œ';
  const sellerNickname = seller?.name?.split('/')[1] || '';
  
  const statusColor = p.sellerStatus === 'accepted' ? '#16a34a' : p.sellerStatus === 'rejected' ? '#dc2626' : 'var(--primary)';
  const statusText = p.sellerStatus === 'accepted' ? 'ìˆ˜ë½ë¨' : p.sellerStatus === 'rejected' ? 'ê±°ì ˆë¨' : 'ì‘ë‹µëŒ€ê¸°';
  
  const modal = document.getElementById('modal');
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“¨ ì œì•ˆ ìƒì„¸</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="margin-bottom: 8px;">${p.title}</h3>
          <span style="padding: 4px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; background: ${p.sellerStatus === 'accepted' ? '#dcfce7' : p.sellerStatus === 'rejected' ? '#fee2e2' : '#fff8f0'}; color: ${statusColor};">${statusText}</span>
        </div>
        
        <div style="background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="display: grid; gap: 10px; font-size: 14px;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--gray-500);">ëŒ€ìƒ ì…€ëŸ¬</span>
              <span style="font-weight: 600;">${sellerName}${sellerNickname ? ` (${sellerNickname})` : ''}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--gray-500);">ì œì•ˆì¼</span>
              <span>${formatDate(p.createdAt)}</span>
            </div>
            ${p.brandName ? `
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ë¸Œëœë“œ/ê³µê¸‰ì‚¬</span>
                <span>${p.brandName}</span>
              </div>
            ` : ''}
            ${p.expectedPeriod ? `
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ì˜ˆìƒ ê¸°ê°„</span>
                <span>${p.expectedPeriod}</span>
              </div>
            ` : ''}
            ${p.expectedMargin ? `
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ì˜ˆìƒ ë§ˆì§„</span>
                <span>${p.expectedMargin}</span>
              </div>
            ` : ''}
          </div>
        </div>
        
        ${p.content ? `
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 8px;">ì œì•ˆ ë‚´ìš©</h4>
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; white-space: pre-wrap;">${p.content}</div>
          </div>
        ` : ''}
        
        ${p.productLink ? `
          <a href="${p.productLink}" target="_blank" style="display: block; padding: 12px; background: var(--info-light); border-radius: 8px; text-align: center; color: var(--info); font-weight: 500; text-decoration: none;">ğŸ”— ìƒí’ˆ ë§í¬ ë³´ê¸°</a>
        ` : ''}
        
        ${p.respondedAt ? `
          <div style="margin-top: 16px; padding: 12px; background: ${p.sellerStatus === 'accepted' ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px; text-align: center; font-size: 13px; color: ${statusColor};">
            ${formatDate(p.respondedAt)}ì— ${statusText}
          </div>
        ` : ''}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button type="button" class="btn-primary" onclick="openAdminProposalModal('${p.id}')">ìˆ˜ì •</button>
      </div>
    </div>
  `;
  modal.classList.add('show');
}

// ==================== ê³µêµ¬ ì œì•ˆ ê´€ë¦¬ ====================
function renderDealSuggestions() {
  const app = document.getElementById('app');
  
  const suggestions = state.dealSuggestions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  const pending = suggestions.filter(s => s.status === 'pending');
  const renegotiating = suggestions.filter(s => s.status === 'renegotiating');
  const processed = suggestions.filter(s => s.status !== 'pending' && s.status !== 'renegotiating');
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ’¡ ê³µêµ¬ ì œì•ˆ ì ‘ìˆ˜</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬ë“¤ì˜ ê³µêµ¬ ì œì•ˆì„ ê²€í† í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
      <!-- í†µê³„ ìš”ì•½ -->
      <div style="display: flex; gap: 12px;">
        <div style="padding: 12px 20px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 12px; text-align: center; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${pending.length}</div>
          <div style="font-size: 11px; color: var(--gray-500);">ê²€í† ëŒ€ê¸°</div>
        </div>
        <div style="padding: 12px 20px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 12px; text-align: center; border: 1px solid #86efac;">
          <div style="font-size: 24px; font-weight: 700; color: #16a34a;">${processed.filter(s => s.status === 'approved').length}</div>
          <div style="font-size: 11px; color: var(--gray-500);">ìŠ¹ì¸</div>
        </div>
        <div style="padding: 12px 20px; background: linear-gradient(145deg, #fef2f2, #fee2e2); border-radius: 12px; text-align: center; border: 1px solid #fecaca;">
          <div style="font-size: 24px; font-weight: 700; color: #dc2626;">${processed.filter(s => s.status === 'rejected').length}</div>
          <div style="font-size: 11px; color: var(--gray-500);">ë°˜ë ¤</div>
        </div>
      </div>
    </div>
    
    ${pending.length > 0 ? `
      <div class="card" style="border: 2px solid var(--primary); background: linear-gradient(145deg, #fffbf5, #fff8f0);">
        <h3 style="margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 8px; font-size: 14px;">${pending.length}</span>
          ê²€í†  ëŒ€ê¸°ì¤‘ì¸ ì œì•ˆ
        </h3>
        <div style="display: grid; gap: 16px;">
          ${pending.map(s => renderSuggestionCard(s)).join('')}
        </div>
      </div>
    ` : `
      <div class="card" style="text-align: center; padding: 48px; background: linear-gradient(145deg, #f9fafb, #f3f4f6);">
        <div style="font-size: 48px; margin-bottom: 12px;">âœ…</div>
        <p style="color: var(--gray-500);">ê²€í†  ëŒ€ê¸°ì¤‘ì¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    `}
    
    ${renegotiating.length > 0 ? `
      <div class="card" style="border: 2px solid var(--info); margin-top: 20px; background: linear-gradient(145deg, #f0f9ff, #e0f2fe);">
        <h3 style="margin-bottom: 20px; color: var(--info); display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--info); color: white; padding: 4px 10px; border-radius: 8px; font-size: 14px;">${renegotiating.length}</span>
          ì¬í˜‘ì˜ ì§„í–‰ì¤‘
        </h3>
        <div style="display: grid; gap: 16px;">
          ${renegotiating.map(s => renderSuggestionCard(s, true)).join('')}
        </div>
      </div>
    ` : ''}
    
    <div class="card" style="margin-top: 20px;">
      <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">ğŸ“ ì „ì²´ ì œì•ˆ ëª©ë¡</h3>
      ${processed.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          ì²˜ë¦¬ëœ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th>ì…€ëŸ¬</th>
              <th>ì œì•ˆ ì œëª©</th>
              <th>ë¸Œëœë“œ/ìƒí’ˆ</th>
              <th>ìƒíƒœ</th>
              <th>ì œì•ˆì¼</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${processed.map(s => `
              <tr>
                <td>${s.sellerName}</td>
                <td style="font-weight: 500;">${s.title}</td>
                <td>${s.brand || '-'}</td>
                <td>
                  <span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; ${s.status === 'approved' ? 'background: linear-gradient(145deg, #dcfce7, #bbf7d0); color: #16a34a;' : 'background: linear-gradient(145deg, #fee2e2, #fecaca); color: #dc2626;'}">
                    ${s.status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'}
                  </span>
                </td>
                <td style="font-size: 13px; color: var(--gray-500);">${formatDateKR(s.createdAt)}</td>
                <td>
                  <div style="display: flex; gap: 4px;">
                    <button class="btn btn-ghost btn-sm" onclick="openSuggestionDetail('${s.id}')">ìƒì„¸</button>
                    ${s.status === 'rejected' ? `<button class="btn-secondary" style="padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); color: var(--info); border: 1px solid #7dd3fc;" onclick="updateSuggestionStatus('${s.id}', 'renegotiating')">ğŸ”„ ì¬í˜‘ì˜</button>` : ''}
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
}

function renderSuggestionCard(s, isRenegotiating = false) {
  const seller = state.sellers.find(sel => sel.id === s.sellerId);
  const sellerDisplayName = seller?.name?.split('/')[0] || s.sellerName || 'ì•Œ ìˆ˜ ì—†ìŒ';
  
  return `
    <div style="
      padding: 20px;
      background: white;
      border-radius: 14px;
      border: 1px solid ${isRenegotiating ? '#7dd3fc' : 'rgba(252,150,0,0.3)'};
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    ">
      <!-- í—¤ë” -->
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="
              padding: 4px 10px;
              border-radius: 6px;
              font-size: 12px;
              font-weight: 600;
              background: ${isRenegotiating ? 'linear-gradient(145deg, #e0f2fe, #bae6fd)' : 'linear-gradient(145deg, #fff8f0, #ffedd5)'};
              color: ${isRenegotiating ? 'var(--info)' : 'var(--primary)'};
            ">${isRenegotiating ? 'ğŸ”„ ì¬í˜‘ì˜' : 'ğŸ‘¤'} ${sellerDisplayName}</span>
            <span style="font-size: 12px; color: var(--gray-400);">${formatDateKR(s.createdAt)}</span>
          </div>
          <h4 style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 4px;">${s.title}</h4>
          <p style="font-size: 13px; color: var(--gray-500);">${s.brand || ''} ${s.price ? 'Â· ' + s.price : ''}</p>
        </div>
      </div>
      
      <!-- ë‚´ìš© -->
      <div style="
        font-size: 14px;
        color: var(--gray-700);
        margin-bottom: 16px;
        padding: 14px;
        background: var(--gray-50);
        border-radius: 10px;
        line-height: 1.6;
        max-height: 100px;
        overflow: hidden;
      ">${s.content}</div>
      
      ${s.renegotiationNote ? `
        <div style="padding: 12px 14px; background: linear-gradient(145deg, #e0f2fe, #bae6fd); border-radius: 10px; margin-bottom: 16px;">
          <div style="font-size: 12px; color: var(--info); font-weight: 600; margin-bottom: 6px;">ğŸ’¬ ì¬í˜‘ì˜ ë©”ëª¨</div>
          <div style="font-size: 13px; color: var(--gray-700);">${s.renegotiationNote}</div>
        </div>
      ` : ''}
      
      ${s.link ? `
        <a href="${s.link}" target="_blank" style="
          display: inline-flex;
          align-items: center;
          gap: 4px;
          font-size: 13px;
          color: var(--info);
          text-decoration: none;
          margin-bottom: 16px;
        ">ğŸ”— ì°¸ê³  ë§í¬ ë³´ê¸°</a>
      ` : ''}
      
      <!-- ì•¡ì…˜ ë²„íŠ¼ -->
      <div style="display: flex; gap: 10px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
        <button onclick="updateSuggestionStatus('${s.id}', 'approved')" style="
          flex: 1;
          padding: 12px;
          font-size: 14px;
          font-weight: 600;
          background: linear-gradient(145deg, #22c55e, #16a34a);
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(34,197,94,0.3);
        ">âœ“ ìŠ¹ì¸</button>
        <button onclick="updateSuggestionStatus('${s.id}', 'rejected')" style="
          flex: 1;
          padding: 12px;
          font-size: 14px;
          font-weight: 600;
          background: linear-gradient(145deg, #f9fafb, #f3f4f6);
          color: #dc2626;
          border: 1px solid #fecaca;
          border-radius: 10px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        ">âœ• ë°˜ë ¤</button>
        <button onclick="openSuggestionDetail('${s.id}')" style="
          padding: 12px 16px;
          font-size: 14px;
          font-weight: 600;
          background: linear-gradient(145deg, #f9fafb, #f3f4f6);
          color: var(--gray-600);
          border: 1px solid var(--gray-200);
          border-radius: 10px;
          cursor: pointer;
        ">ìƒì„¸</button>
      </div>
    </div>
  `;
}

// ì œì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateSuggestionStatus(suggestionId, status) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (status === 'renegotiating') {
    // ì¬í˜‘ì˜ ëª¨ë‹¬ ì—´ê¸°
    openRenegotiationModal(suggestionId);
    return;
  }
  
  const statusText = status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤';
  if (!confirm(`ì´ ì œì•ˆì„ ${statusText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  try {
    await db.collection('dealSuggestions').doc(suggestionId).update({
      status: status,
      processedAt: new Date().toISOString()
    });
    showToast(`${statusText}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  } catch (e) {
    console.error(e);
    showToast('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì¬í˜‘ì˜ ëª¨ë‹¬
function openRenegotiationModal(suggestionId) {
  const s = state.dealSuggestions.find(item => item.id === suggestionId);
  if (!s) return;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ”„ ì¬í˜‘ì˜ ìš”ì²­</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="padding: 16px; background: var(--gray-50); border-radius: 8px; margin-bottom: 20px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">${s.title}</div>
          <div style="font-size: 13px; color: var(--gray-500);">ì…€ëŸ¬: ${s.sellerName}</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì¬í˜‘ì˜ ì‚¬ìœ /ë©”ëª¨</label>
          <textarea id="renegotiation-note" class="form-textarea" rows="4" placeholder="ì…€ëŸ¬ì—ê²Œ ì „ë‹¬í•  ì¬í˜‘ì˜ ì‚¬ìœ ë‚˜ ìˆ˜ì • ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        
        <div style="display: flex; gap: 12px; padding-top: 16px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="submitRenegotiation('${suggestionId}')">ğŸ”„ ì¬í˜‘ì˜ ìš”ì²­</button>
        </div>
      </div>
    </div>
  `;
}

// ì¬í˜‘ì˜ ì œì¶œ
async function submitRenegotiation(suggestionId) {
  const note = document.getElementById('renegotiation-note').value.trim();
  
  try {
    await db.collection('dealSuggestions').doc(suggestionId).update({
      status: 'renegotiating',
      renegotiationNote: note,
      renegotiationAt: new Date().toISOString()
    });
    closeModal();
    showToast('ì¬í˜‘ì˜ê°€ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    console.error(e);
    showToast('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì œì•ˆ ìƒì„¸ ëª¨ë‹¬
function openSuggestionDetail(suggestionId) {
  const s = state.dealSuggestions.find(item => item.id === suggestionId);
  if (!s) return;
  
  // ìƒíƒœ í‘œì‹œ ë¡œì§
  const getStatusStyle = (status) => {
    switch(status) {
      case 'pending': return 'background: var(--warning-light); color: var(--warning);';
      case 'approved': return 'background: var(--success-light); color: var(--success);';
      case 'renegotiating': return 'background: var(--info-light); color: var(--info);';
      default: return 'background: var(--danger-light); color: var(--danger);';
    }
  };
  const getStatusText = (status) => {
    switch(status) {
      case 'pending': return 'ê²€í† ì¤‘';
      case 'approved': return 'ìŠ¹ì¸';
      case 'renegotiating': return 'ì¬í˜‘ì˜ì¤‘';
      default: return 'ë°˜ë ¤';
    }
  };
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ’¡ ê³µêµ¬ ì œì•ˆ ìƒì„¸</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <span style="padding: 4px 10px; border-radius: 6px; font-size: 13px; background: var(--primary-light); color: var(--primary);">
            ì…€ëŸ¬: ${s.sellerName}
          </span>
          <span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; ${getStatusStyle(s.status)}">
            ${getStatusText(s.status)}
          </span>
        </div>
        
        <h3 style="font-size: 18px; margin-bottom: 8px;">${s.title}</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; padding: 16px; background: var(--gray-50); border-radius: 8px;">
          <div>
            <div style="font-size: 12px; color: var(--gray-500);">ë¸Œëœë“œ/ìƒí’ˆ</div>
            <div style="font-weight: 500;">${s.brand || '-'}</div>
          </div>
          <div>
            <div style="font-size: 12px; color: var(--gray-500);">ì˜ˆìƒ íŒë§¤ê°€</div>
            <div style="font-weight: 500;">${s.price || '-'}</div>
          </div>
          <div>
            <div style="font-size: 12px; color: var(--gray-500);">ì œì•ˆì¼</div>
            <div>${formatDateKR(s.createdAt)}</div>
          </div>
          ${s.link ? `
            <div>
              <div style="font-size: 12px; color: var(--gray-500);">ì°¸ê³  ë§í¬</div>
              <a href="${s.link}" target="_blank" style="color: var(--info);">ë§í¬ ì—´ê¸° â†’</a>
            </div>
          ` : ''}
        </div>
        
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ì œì•ˆ ë‚´ìš©</div>
          <div style="padding: 16px; background: var(--gray-50); border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">${s.content}</div>
        </div>
        
        ${s.renegotiationNote ? `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; color: var(--info); margin-bottom: 8px;">ğŸ’¬ ì¬í˜‘ì˜ ë©”ëª¨</div>
            <div style="padding: 16px; background: var(--info-light); border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">${s.renegotiationNote}</div>
          </div>
        ` : ''}
        
        ${s.status === 'pending' || s.status === 'renegotiating' ? `
          <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
            <button class="btn btn-primary" style="flex: 1;" onclick="updateSuggestionStatus('${s.id}', 'approved'); closeModal();">âœ“ ìŠ¹ì¸</button>
            <button class="btn btn-secondary" style="flex: 1; color: var(--danger);" onclick="updateSuggestionStatus('${s.id}', 'rejected'); closeModal();">âœ• ë°˜ë ¤</button>
          </div>
        ` : s.status === 'rejected' ? `
          <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
            <button class="btn btn-secondary" style="flex: 1; color: var(--info);" onclick="closeModal(); updateSuggestionStatus('${s.id}', 'renegotiating');">ğŸ”„ ì¬í˜‘ì˜ ìš”ì²­</button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

// ============================================
// ë¬¸ì˜ì ‘ìˆ˜ ê´€ë¦¬
// ============================================

function getInquiries() {
  return JSON.parse(localStorage.getItem('moyeora_inquiries') || '[]');
}

function saveInquiries(inquiries) {
  localStorage.setItem('moyeora_inquiries', JSON.stringify(inquiries));
}

function updateInquiryBadge() {
  const inquiries = getInquiries();
  const newCount = inquiries.filter(i => i.status === 'new').length;
  const badge = document.getElementById('inquiry-badge');
  if (badge) {
    if (newCount > 0) {
      badge.textContent = newCount;
      badge.style.display = 'inline';
    } else {
      badge.style.display = 'none';
    }
  }
}

function updateInquiryStatus(id, status) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  const inquiries = getInquiries();
  const idx = inquiries.findIndex(i => i.id === id);
  if (idx !== -1) {
    inquiries[idx].status = status;
    if (status === 'contacted') {
      inquiries[idx].contactedAt = new Date().toISOString();
    }
    saveInquiries(inquiries);
    renderInquiries();
    updateInquiryBadge();
  }
}

function deleteInquiry(id) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm('ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const inquiries = getInquiries().filter(i => i.id !== id);
  saveInquiries(inquiries);
  renderInquiries();
  updateInquiryBadge();
}

function renderInquiries() {
  const app = document.getElementById('app');
  const inquiries = getInquiries().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  const supplierInquiries = inquiries.filter(i => i.type === 'supplier');
  const sellerInquiries = inquiries.filter(i => i.type === 'seller');
  
  const formatDate = (dateStr) => {
    const d = new Date(dateStr);
    return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  };
  
  const getStatusBadge = (status) => {
    switch(status) {
      case 'new': return '<span style="background: #fee2e2; color: #dc2626; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">ì‹ ê·œ</span>';
      case 'contacted': return '<span style="background: #d1fae5; color: #059669; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">ì—°ë½ì™„ë£Œ</span>';
      case 'pending': return '<span style="background: #fef3c7; color: #d97706; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">ëŒ€ê¸°ì¤‘</span>';
      default: return '<span style="background: #f3f4f6; color: #6b7280; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">ê¸°íƒ€</span>';
    }
  };
  
  const renderTable = (items, type) => {
    if (items.length === 0) {
      return '<div style="text-align: center; padding: 48px; color: var(--gray-500);">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    }
    
    return `
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: var(--gray-50); border-bottom: 1px solid var(--gray-200);">
            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600);">ìƒíƒœ</th>
            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600);">${type === 'supplier' ? 'ê³µê¸‰ì‚¬ëª…' : 'ì„±í•¨'}</th>
            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600);">ì—°ë½ì²˜</th>
            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600);">ì ‘ìˆ˜ì¼ì‹œ</th>
            <th style="padding: 12px 16px; text-align: center; font-size: 13px; font-weight: 600; color: var(--gray-600);">ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(item => `
            <tr style="border-bottom: 1px solid var(--gray-100);">
              <td style="padding: 14px 16px;">${getStatusBadge(item.status)}</td>
              <td style="padding: 14px 16px; font-weight: 500;">${item.name}</td>
              <td style="padding: 14px 16px;">
                <a href="tel:${item.contact.replace(/-/g, '')}" style="color: var(--info); text-decoration: none; font-weight: 500;">${item.contact}</a>
              </td>
              <td style="padding: 14px 16px; font-size: 13px; color: var(--gray-600);">${formatDate(item.createdAt)}</td>
              <td style="padding: 14px 16px; text-align: center;">
                <div style="display: flex; gap: 8px; justify-content: center;">
                  ${item.status === 'new' ? `
                    <button onclick="updateInquiryStatus(${item.id}, 'contacted')" style="padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ì—°ë½ì™„ë£Œ</button>
                    <button onclick="updateInquiryStatus(${item.id}, 'pending')" style="padding: 6px 12px; background: var(--warning); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ëŒ€ê¸°</button>
                  ` : item.status === 'pending' ? `
                    <button onclick="updateInquiryStatus(${item.id}, 'contacted')" style="padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ì—°ë½ì™„ë£Œ</button>
                  ` : ''}
                  <button onclick="deleteInquiry(${item.id})" style="padding: 6px 12px; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ì‚­ì œ</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  };
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ“© ë¬¸ì˜ì ‘ìˆ˜</h1>
      <p style="color: var(--gray-600); font-size: 14px; margin-top: 4px;">
        ëœë”©í˜ì´ì§€ì—ì„œ ì ‘ìˆ˜ëœ ë¬¸ì˜ ë‚´ì—­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤
      </p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;">
      <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 4px;">ì „ì²´ ë¬¸ì˜</div>
        <div style="font-size: 28px; font-weight: 700; color: var(--gray-900);">${inquiries.length}</div>
      </div>
      <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 4px;">ì‹ ê·œ ë¬¸ì˜</div>
        <div style="font-size: 28px; font-weight: 700; color: var(--danger);">${inquiries.filter(i => i.status === 'new').length}</div>
      </div>
      <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 4px;">ì—°ë½ì™„ë£Œ</div>
        <div style="font-size: 28px; font-weight: 700; color: var(--success);">${inquiries.filter(i => i.status === 'contacted').length}</div>
      </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 24px;">
      <!-- ê³µê¸‰ì‚¬ ë¬¸ì˜ -->
      <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="padding: 20px; border-bottom: 1px solid var(--gray-100); display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 18px;">ğŸ¢</span>
          <h2 style="font-size: 16px; font-weight: 700;">ê³µê¸‰ì‚¬ ë¬¸ì˜</h2>
          <span style="background: var(--gray-100); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; color: var(--gray-600);">${supplierInquiries.length}</span>
        </div>
        ${renderTable(supplierInquiries, 'supplier')}
      </div>
      
      <!-- ì…€ëŸ¬ ë¬¸ì˜ -->
      <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="padding: 20px; border-bottom: 1px solid var(--gray-100); display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 18px;">ğŸ‘¤</span>
          <h2 style="font-size: 16px; font-weight: 700;">ì…€ëŸ¬ ë¬¸ì˜</h2>
          <span style="background: var(--gray-100); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; color: var(--gray-600);">${sellerInquiries.length}</span>
        </div>
        ${renderTable(sellerInquiries, 'seller')}
      </div>
    </div>
  `;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°°ì§€ ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(updateInquiryBadge, 500);
});

// ==================== í†µí•© ê³µêµ¬ ì œì•ˆ ê´€ë¦¬ ====================
function renderProposalManagement() {
  const app = document.getElementById('app');
  
  // ì…€ëŸ¬ê°€ ë³´ë‚¸ ì œì•ˆ (dealSuggestions)
  const sellerSuggestions = (state.dealSuggestions || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const pendingSuggestions = sellerSuggestions.filter(s => s.status === 'pending');
  
  // ì–´ë“œë¯¼ì´ ë³´ë‚¸ ì œì•ˆ (adminProposals)
  const adminProposals = (state.adminProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const pendingProposals = adminProposals.filter(p => !p.sellerStatus || p.sellerStatus === 'pending');
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ“‹ ê³µêµ¬ ì œì•ˆ ê´€ë¦¬</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬ ì œì•ˆ ê²€í†  ë° ì…€ëŸ¬ì—ê²Œ ì œì•ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
      <button onclick="openAdminProposalModal()" style="
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        gap: 6px;
      ">
        <span style="font-size: 18px;">+</span> ì…€ëŸ¬ì—ê²Œ ì œì•ˆ
      </button>
    </div>
    
    <!-- íƒ­ -->
    <div style="display: flex; gap: 4px; margin-bottom: 24px; background: var(--gray-100); padding: 4px; border-radius: 12px;">
      <button id="proposalTab-received" onclick="switchProposalTab('received')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600); color: white; cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.3);
      ">
        ğŸ“¥ ë°›ì€ ì œì•ˆ <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 8px; margin-left: 4px;">${sellerSuggestions.length}</span>
        ${pendingSuggestions.length > 0 ? `<span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ê²€í†  ${pendingSuggestions.length}</span>` : ''}
      </button>
      <button id="proposalTab-sent" onclick="switchProposalTab('sent')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: transparent; color: var(--gray-500); cursor: pointer;
      ">
        ğŸ“¤ ë³´ë‚¸ ì œì•ˆ <span style="opacity: 0.7;">${adminProposals.length}</span>
        ${pendingProposals.length > 0 ? `<span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ëŒ€ê¸° ${pendingProposals.length}</span>` : ''}
      </button>
    </div>
    
    <!-- ë°›ì€ ì œì•ˆ (ì…€ëŸ¬ â†’ ì–´ë“œë¯¼) -->
    <div id="proposalContent-received">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div style="padding: 16px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 12px; text-align: center; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${pendingSuggestions.length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ê²€í†  ëŒ€ê¸°</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 12px; text-align: center; border: 1px solid #86efac;">
          <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${sellerSuggestions.filter(s => s.status === 'approved').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ìŠ¹ì¸</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #fef2f2, #fee2e2); border-radius: 12px; text-align: center; border: 1px solid #fecaca;">
          <div style="font-size: 28px; font-weight: 700; color: #dc2626;">${sellerSuggestions.filter(s => s.status === 'rejected').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ë°˜ë ¤</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); border-radius: 12px; text-align: center; border: 1px solid #7dd3fc;">
          <div style="font-size: 28px; font-weight: 700; color: var(--info);">${sellerSuggestions.filter(s => s.status === 'renegotiating').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ì¬í˜‘ì˜</div>
        </div>
      </div>
      
      <div class="card">
        <h3 style="margin-bottom: 16px;">ì…€ëŸ¬ë“¤ì´ ë³´ë‚¸ ì œì•ˆ</h3>
        ${sellerSuggestions.length === 0 ? `
          <div style="text-align: center; padding: 48px; color: var(--gray-500);">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
            <p>ì•„ì§ ë°›ì€ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        ` : `
          <table class="data-table">
            <thead>
              <tr>
                <th>ì…€ëŸ¬</th>
                <th>ì œì•ˆ ì œëª©</th>
                <th>ë¸Œëœë“œ/ìƒí’ˆ</th>
                <th>ìƒíƒœ</th>
                <th>ì œì•ˆì¼</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${sellerSuggestions.map(s => {
                const seller = state.sellers.find(sel => sel.id === s.sellerId);
                const sellerName = seller?.name?.split('/')[0] || s.sellerName || '-';
                const statusStyle = s.status === 'approved' ? 'background: linear-gradient(145deg, #dcfce7, #bbf7d0); color: #16a34a;' :
                                   s.status === 'rejected' ? 'background: linear-gradient(145deg, #fee2e2, #fecaca); color: #dc2626;' :
                                   s.status === 'renegotiating' ? 'background: linear-gradient(145deg, #e0f2fe, #bae6fd); color: var(--info);' :
                                   'background: linear-gradient(145deg, #fff8f0, #ffedd5); color: var(--primary);';
                const statusText = s.status === 'approved' ? 'ìŠ¹ì¸' : s.status === 'rejected' ? 'ë°˜ë ¤' : s.status === 'renegotiating' ? 'ì¬í˜‘ì˜' : 'ê²€í† ëŒ€ê¸°';
                return `
                  <tr>
                    <td style="font-weight: 500;">${sellerName}</td>
                    <td>${s.title}</td>
                    <td>${s.brand || '-'}</td>
                    <td><span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; ${statusStyle}">${statusText}</span></td>
                    <td style="font-size: 13px; color: var(--gray-500);">${formatDateKR(s.createdAt)}</td>
                    <td>
                      <button onclick="openSuggestionDetailModal('${s.id}')" style="
                        padding: 6px 14px;
                        font-size: 12px;
                        font-weight: 600;
                        background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                        color: var(--gray-600);
                        border: 1px solid var(--gray-200);
                        border-radius: 8px;
                        cursor: pointer;
                      ">ìƒì„¸</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `}
      </div>
    </div>
    
    <!-- ë³´ë‚¸ ì œì•ˆ (ì–´ë“œë¯¼ â†’ ì…€ëŸ¬) -->
    <div id="proposalContent-sent" style="display: none;">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div style="padding: 16px; background: var(--gray-50); border-radius: 12px; text-align: center;">
          <div style="font-size: 28px; font-weight: 700;">${adminProposals.length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ì „ì²´</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 12px; text-align: center; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${pendingProposals.length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ì‘ë‹µ ëŒ€ê¸°</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 12px; text-align: center; border: 1px solid #86efac;">
          <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${adminProposals.filter(p => p.sellerStatus === 'accepted').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ìˆ˜ë½ë¨</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #fef2f2, #fee2e2); border-radius: 12px; text-align: center; border: 1px solid #fecaca;">
          <div style="font-size: 28px; font-weight: 700; color: #dc2626;">${adminProposals.filter(p => p.sellerStatus === 'rejected').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ê±°ì ˆë¨</div>
        </div>
      </div>
      
      <div class="card">
        <h3 style="margin-bottom: 16px;">ì…€ëŸ¬ì—ê²Œ ë³´ë‚¸ ì œì•ˆ</h3>
        ${adminProposals.length === 0 ? `
          <div style="text-align: center; padding: 48px; color: var(--gray-500);">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
            <p>ì•„ì§ ë³´ë‚¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <button onclick="openAdminProposalModal()" style="
              margin-top: 16px;
              padding: 12px 24px;
              font-size: 14px;
              font-weight: 600;
              background: linear-gradient(145deg, #fc9600, #e08600);
              color: white;
              border: none;
              border-radius: 12px;
              cursor: pointer;
            ">ì²« ì œì•ˆ ë³´ë‚´ê¸°</button>
          </div>
        ` : `
          <table class="data-table">
            <thead>
              <tr>
                <th>ì œì•ˆì¼</th>
                <th>ëŒ€ìƒ ì…€ëŸ¬</th>
                <th>ì œì•ˆ ì œëª©</th>
                <th>ë¸Œëœë“œ</th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${adminProposals.map(p => {
                const seller = state.sellers.find(s => s.id === p.targetSellerId);
                const sellerName = seller?.name?.split('/')[0] || p.targetSellerName || 'ì „ì²´ê³µê°œ';
                const statusStyle = p.sellerStatus === 'accepted' ? 'background: linear-gradient(145deg, #dcfce7, #bbf7d0); color: #16a34a;' :
                                   p.sellerStatus === 'rejected' ? 'background: linear-gradient(145deg, #fee2e2, #fecaca); color: #dc2626;' :
                                   'background: linear-gradient(145deg, #fff8f0, #ffedd5); color: var(--primary);';
                const statusText = p.sellerStatus === 'accepted' ? 'ìˆ˜ë½ë¨' : p.sellerStatus === 'rejected' ? 'ê±°ì ˆë¨' : 'ì‘ë‹µëŒ€ê¸°';
                return `
                  <tr>
                    <td style="font-size: 13px; color: var(--gray-500);">${formatDate(p.createdAt)}</td>
                    <td style="font-weight: 500;">${sellerName}</td>
                    <td>${p.title}</td>
                    <td>${p.brandName || '-'}</td>
                    <td><span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; ${statusStyle}">${statusText}</span></td>
                    <td>
                      <div style="display: flex; gap: 6px;">
                        <button onclick="viewAdminProposal('${p.id}')" style="
                          padding: 6px 12px;
                          font-size: 12px;
                          font-weight: 500;
                          background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                          color: var(--gray-600);
                          border: 1px solid var(--gray-200);
                          border-radius: 6px;
                          cursor: pointer;
                        ">ìƒì„¸</button>
                        <button onclick="deleteAdminProposal('${p.id}')" style="
                          padding: 6px 12px;
                          font-size: 12px;
                          font-weight: 500;
                          background: linear-gradient(145deg, #fef2f2, #fee2e2);
                          color: #dc2626;
                          border: 1px solid #fecaca;
                          border-radius: 6px;
                          cursor: pointer;
                        ">ì‚­ì œ</button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `}
      </div>
    </div>
  `;
}

// ì œì•ˆ íƒ­ ì „í™˜
function switchProposalTab(tab) {
  const receivedTab = document.getElementById('proposalTab-received');
  const sentTab = document.getElementById('proposalTab-sent');
  
  if (tab === 'received') {
    receivedTab.style.background = 'linear-gradient(145deg, #fc9600, #e08600)';
    receivedTab.style.color = 'white';
    receivedTab.style.boxShadow = '0 4px 12px rgba(252,150,0,0.3)';
    sentTab.style.background = 'transparent';
    sentTab.style.color = 'var(--gray-500)';
    sentTab.style.boxShadow = 'none';
  } else {
    sentTab.style.background = 'linear-gradient(145deg, #fc9600, #e08600)';
    sentTab.style.color = 'white';
    sentTab.style.boxShadow = '0 4px 12px rgba(252,150,0,0.3)';
    receivedTab.style.background = 'transparent';
    receivedTab.style.color = 'var(--gray-500)';
    receivedTab.style.boxShadow = 'none';
  }
  
  document.getElementById('proposalContent-received').style.display = tab === 'received' ? 'block' : 'none';
  document.getElementById('proposalContent-sent').style.display = tab === 'sent' ? 'block' : 'none';
}

// ì œì•ˆ ìƒì„¸ ëª¨ë‹¬ (ìŠ¹ì¸/ë°˜ë ¤)
function openSuggestionDetailModal(suggestionId) {
  const s = state.dealSuggestions.find(item => item.id === suggestionId);
  if (!s) return;
  
  const seller = state.sellers.find(sel => sel.id === s.sellerId);
  const sellerName = seller?.name?.split('/')[0] || s.sellerName || '-';
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ ì œì•ˆ ìƒì„¸</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 24px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">${s.title}</h3>
          <span style="padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; ${
            s.status === 'approved' ? 'background: #dcfce7; color: #16a34a;' :
            s.status === 'rejected' ? 'background: #fee2e2; color: #dc2626;' :
            s.status === 'renegotiating' ? 'background: #e0f2fe; color: var(--info);' :
            'background: #fff8f0; color: var(--primary);'
          }">
            ${s.status === 'approved' ? 'ìŠ¹ì¸ë¨' : s.status === 'rejected' ? 'ë°˜ë ¤ë¨' : s.status === 'renegotiating' ? 'ì¬í˜‘ì˜ì¤‘' : 'ê²€í† ëŒ€ê¸°'}
          </span>
        </div>
        
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì œì•ˆ ì…€ëŸ¬</div>
              <div style="font-weight: 600;">${sellerName}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì œì•ˆì¼</div>
              <div style="font-weight: 600;">${formatDate(s.createdAt)}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ë¸Œëœë“œ/ìƒí’ˆ</div>
              <div style="font-weight: 600;">${s.brand || '-'}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">í¬ë§ ê°€ê²©</div>
              <div style="font-weight: 600;">${s.price || '-'}</div>
            </div>
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ì œì•ˆ ë‚´ìš©</div>
          <div style="padding: 16px; background: white; border: 1px solid var(--gray-200); border-radius: 10px; line-height: 1.6; white-space: pre-wrap;">${s.content || 'ë‚´ìš© ì—†ìŒ'}</div>
        </div>
        
        ${s.link ? `
          <a href="${s.link}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; background: var(--info-light); color: var(--info); border-radius: 8px; text-decoration: none; font-size: 14px; margin-bottom: 20px;">
            ğŸ”— ì°¸ê³  ë§í¬ ë³´ê¸°
          </a>
        ` : ''}
        
        ${s.renegotiationNote ? `
          <div style="padding: 16px; background: #e0f2fe; border-radius: 10px; margin-bottom: 20px;">
            <div style="font-size: 12px; color: var(--info); font-weight: 600; margin-bottom: 6px;">ğŸ’¬ ì¬í˜‘ì˜ ë©”ëª¨</div>
            <div style="font-size: 14px; color: var(--gray-700);">${s.renegotiationNote}</div>
          </div>
        ` : ''}
        
        ${s.status === 'pending' || s.status === 'renegotiating' ? `
          <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
            <button onclick="updateSuggestionStatus('${s.id}', 'approved')" style="
              flex: 1;
              padding: 14px;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(145deg, #22c55e, #16a34a);
              color: white;
              border: none;
              border-radius: 12px;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(34,197,94,0.3);
            ">âœ“ ìŠ¹ì¸í•˜ê¸°</button>
            <button onclick="updateSuggestionStatus('${s.id}', 'rejected')" style="
              flex: 1;
              padding: 14px;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(145deg, #f9fafb, #f3f4f6);
              color: #dc2626;
              border: 1px solid #fecaca;
              border-radius: 12px;
              cursor: pointer;
            ">âœ• ë°˜ë ¤í•˜ê¸°</button>
            <button onclick="openRenegotiationModal('${s.id}')" style="
              padding: 14px 20px;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(145deg, #f0f9ff, #e0f2fe);
              color: var(--info);
              border: 1px solid #7dd3fc;
              border-radius: 12px;
              cursor: pointer;
            ">ğŸ”„ ì¬í˜‘ì˜</button>
          </div>
        ` : `
          <div style="display: flex; gap: 12px; justify-content: center; padding-top: 20px; border-top: 1px solid var(--gray-200);">
            <button onclick="closeModal()" style="
              padding: 14px 40px;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(145deg, #f9fafb, #f3f4f6);
              color: var(--gray-600);
              border: 1px solid var(--gray-200);
              border-radius: 12px;
              cursor: pointer;
            ">ë‹«ê¸°</button>
          </div>
        `}
      </div>
    </div>
  `;
}

// ==================== íŒ€ì› ê´€ë¦¬ ====================
function renderTeamMembers() {
  const app = document.getElementById('app');
  const members = state.teamMembers || [];
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ‘¥ íŒ€ì› ê´€ë¦¬</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ëª¨ì—¬ë¼ë”œ íŒ€ì› ê³„ì •ì„ ê´€ë¦¬í•˜ê³  ë‹´ë‹¹ìë¥¼ ë°°ì •í•©ë‹ˆë‹¤.</p>
      </div>
      <button onclick="openTeamMemberModal()" style="
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35);
      ">
        + íŒ€ì› ì¶”ê°€
      </button>
    </div>
    
    <!-- í†µê³„ -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
      <div style="padding: 20px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 14px; text-align: center; border: 1px solid rgba(252,150,0,0.2);">
        <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${members.length}</div>
        <div style="font-size: 13px; color: var(--gray-500);">ì „ì²´ íŒ€ì›</div>
      </div>
      <div style="padding: 20px; background: var(--gray-50); border-radius: 14px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--gray-700);">${members.filter(m => m.role === 'admin').length}</div>
        <div style="font-size: 13px; color: var(--gray-500);">ê´€ë¦¬ì</div>
      </div>
      <div style="padding: 20px; background: var(--gray-50); border-radius: 14px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--gray-700);">${members.filter(m => m.role === 'manager').length}</div>
        <div style="font-size: 13px; color: var(--gray-500);">ë§¤ë‹ˆì €</div>
      </div>
      <div style="padding: 20px; background: var(--gray-50); border-radius: 14px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--gray-700);">${members.filter(m => m.role === 'staff').length}</div>
        <div style="font-size: 13px; color: var(--gray-500);">ì¼ë°˜</div>
      </div>
      <div style="padding: 20px; background: #fef3c7; border-radius: 14px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: #92400e;">${members.filter(m => m.role === 'guest').length}</div>
        <div style="font-size: 13px; color: #92400e;">ê²ŒìŠ¤íŠ¸</div>
      </div>
    </div>
    
    <div class="card">
      ${members.length === 0 ? `
        <div style="text-align: center; padding: 60px 20px; color: var(--gray-500);">
          <div style="font-size: 56px; margin-bottom: 16px;">ğŸ‘¥</div>
          <p style="font-size: 15px; margin-bottom: 20px;">ì•„ì§ ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          <button onclick="openTeamMemberModal()" style="
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(145deg, #fc9600, #e08600);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
          ">ì²« íŒ€ì› ë“±ë¡í•˜ê¸°</button>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th>ì´ë¦„</th>
              <th>ì•„ì´ë””</th>
              <th>ì—­í• </th>
              <th>ë“±ë¡ì¼</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${members.map(m => {
              const roleStyle = m.role === 'admin' ? 'background: linear-gradient(145deg, #fef2f2, #fee2e2); color: #dc2626;' :
                               m.role === 'manager' ? 'background: linear-gradient(145deg, #fff8f0, #ffedd5); color: var(--primary);' :
                               m.role === 'guest' ? 'background: linear-gradient(145deg, #fef3c7, #fde68a); color: #92400e;' :
                               'background: var(--gray-100); color: var(--gray-600);';
              const roleText = m.role === 'admin' ? 'ê´€ë¦¬ì' : m.role === 'manager' ? 'ë§¤ë‹ˆì €' : m.role === 'guest' ? 'ê²ŒìŠ¤íŠ¸' : 'ì¼ë°˜';
              return `
                <tr>
                  <td style="font-weight: 600;">${m.name}</td>
                  <td><code style="background: var(--gray-100); padding: 2px 8px; border-radius: 4px; font-size: 12px;">${m.loginId || '-'}</code></td>
                  <td><span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; ${roleStyle}">${roleText}</span></td>
                  <td style="font-size: 13px; color: var(--gray-500);">${formatDate(m.createdAt)}</td>
                  <td>
                    <div style="display: flex; gap: 6px;">
                      <button onclick="openTeamMemberModal('${m.id}')" style="
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        background: var(--gray-100);
                        color: var(--gray-600);
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                      ">ìˆ˜ì •</button>
                      <button onclick="deleteTeamMember('${m.id}')" style="
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        background: #fee2e2;
                        color: #dc2626;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                      ">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
}

// íŒ€ì› ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬
function openTeamMemberModal(memberId = null) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  const member = memberId ? state.teamMembers.find(m => m.id === memberId) : null;
  const isEdit = !!member;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'âœï¸ íŒ€ì› ìˆ˜ì •' : 'â• íŒ€ì› ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form id="teamMemberForm" onsubmit="saveTeamMember(event, '${memberId || ''}')">
        <div style="padding: 24px;">
          <div class="form-group">
            <label class="form-label">ì´ë¦„ *</label>
            <input type="text" class="form-input" id="memberName" value="${member?.name || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">ì´ë©”ì¼</label>
            <input type="email" class="form-input" id="memberEmail" value="${member?.email || ''}" placeholder="example@moyeoradeal.com">
          </div>
          
          <!-- ë¡œê·¸ì¸ ì •ë³´ -->
          <div style="padding: 16px; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); border-radius: 12px; margin-bottom: 16px;">
            <div style="font-size: 13px; font-weight: 600; color: var(--info); margin-bottom: 12px;">ğŸ” ë¡œê·¸ì¸ ì •ë³´</div>
            <div class="form-group" style="margin-bottom: 12px;">
              <label class="form-label">ì•„ì´ë”” *</label>
              <input type="text" class="form-input" id="memberLoginId" value="${member?.loginId || ''}" placeholder="ì˜ë¬¸/ìˆ«ì ì¡°í•©" required>
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
              <label class="form-label">ë¹„ë°€ë²ˆí˜¸ *</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" id="memberLoginPw" value="${member?.loginPw || ''}" placeholder="ë¹„ë°€ë²ˆí˜¸" required style="flex: 1;">
                <button type="button" onclick="generateTempPassword()" style="padding: 8px 12px; background: var(--info); color: white; border: none; border-radius: 8px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                  ì„ì‹œë°œê¸‰
                </button>
              </div>
              <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">â€» ì„ì‹œë°œê¸‰ ì‹œ íŒ€ì›ì´ ì²« ë¡œê·¸ì¸ í›„ ì§ì ‘ ë³€ê²½</div>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-700); cursor: pointer;">
                <input type="checkbox" id="memberNeedPwChange" ${member?.needPasswordChange ? 'checked' : ''}>
                <span>ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìˆ˜</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì—­í•  *</label>
            <select class="form-select" id="memberRole" required>
              <option value="guest" ${member?.role === 'guest' ? 'selected' : ''}>ğŸ‘€ ê²ŒìŠ¤íŠ¸ (ë³´ê¸°ì „ìš©)</option>
              <option value="staff" ${!member?.role || member?.role === 'staff' ? 'selected' : ''}>ì¼ë°˜</option>
              <option value="manager" ${member?.role === 'manager' ? 'selected' : ''}>ë§¤ë‹ˆì €</option>
              <option value="admin" ${member?.role === 'admin' ? 'selected' : ''}>ê´€ë¦¬ì</option>
            </select>
            <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">
              ğŸ’¡ ê²ŒìŠ¤íŠ¸: ì¡°íšŒë§Œ ê°€ëŠ¥ / ì¼ë°˜: ê¸°ë³¸ ê¸°ëŠ¥ / ë§¤ë‹ˆì €: íŒ€ ê´€ë¦¬ / ê´€ë¦¬ì: ì „ì²´ ê¶Œí•œ
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <textarea class="form-textarea" id="memberNote" rows="2" placeholder="ë‹´ë‹¹ ì—…ë¬´ ë“±">${member?.note || ''}</textarea>
          </div>
        </div>
        <div style="padding: 16px 24px; background: var(--gray-50); display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •' : 'ë“±ë¡'}</button>
        </div>
      </form>
    </div>
  `;
}

// íŒ€ì› ì €ì¥
async function saveTeamMember(e, memberId) {
  e.preventDefault();
  
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  const loginId = document.getElementById('memberLoginId').value.trim();
  
  // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬
  const existingMember = state.teamMembers.find(m => m.loginId === loginId && m.id !== memberId);
  if (existingMember) {
    showToast('ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.');
    return;
  }
  
  const data = {
    name: document.getElementById('memberName').value.trim(),
    email: document.getElementById('memberEmail').value.trim(),
    loginId: loginId,
    loginPw: document.getElementById('memberLoginPw').value.trim(),
    role: document.getElementById('memberRole').value,
    note: document.getElementById('memberNote').value.trim(),
    needPasswordChange: document.getElementById('memberNeedPwChange').checked,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (memberId) {
      await db.collection('teamMembers').doc(memberId).update(data);
      showToast('íŒ€ì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('teamMembers').add(data);
      showToast('íŒ€ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    closeModal();
  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// íŒ€ì› ì‚­ì œ
async function deleteTeamMember(memberId) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }

  if (!confirm('ì´ íŒ€ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  try {
    await db.collection('teamMembers').doc(memberId).delete();
    showToast('íŒ€ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (err) {
    console.error(err);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
function generateTempPassword() {
  const chars = '0123456789abcdefghijklmnopqrstuvwxyz';
  let tempPw = '';
  for (let i = 0; i < 6; i++) {
    tempPw += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  document.getElementById('memberLoginPw').value = tempPw;
  document.getElementById('memberNeedPwChange').checked = true;
  showToast('ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ' + tempPw);
}

// íŒ€ì› ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ (ë³¸ì¸ ì „ìš© - í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë°©ì‹)
function showMyPasswordChangeModal() {
  const currentUser = state.currentAdmin || state.currentUser || {};

  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 420px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="saveMyPassword(event)">
        <div style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" class="form-input" id="current-pw" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required>
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" class="form-input" id="new-pw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (4ì ì´ìƒ)" required minlength="4">
          </div>

          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" class="form-input" id="new-pw-confirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" required>
          </div>

          <div id="pw-change-error" style="color: var(--danger); font-size: 13px; margin-top: 12px; display: none;"></div>

          <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px;">
            <p style="font-size: 12px; color: #92400e; margin: 0;">
              ğŸ’¡ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?<br>
              ê´€ë¦¬ìì—ê²Œ ìš”ì²­í•˜ë©´ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ë³€ê²½í•˜ê¸°</button>
        </div>
      </form>
    </div>
  `;
}

// ë¹„ë°€ë²ˆí˜¸ ì €ì¥ (ë³¸ì¸ìš©)
async function saveMyPassword(e) {
  e.preventDefault();

  const currentUser = state.currentAdmin || state.currentUser || {};
  const currentPw = document.getElementById('current-pw').value;
  const newPw = document.getElementById('new-pw').value;
  const confirmPw = document.getElementById('new-pw-confirm').value;
  const errorEl = document.getElementById('pw-change-error');

  // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  const member = state.teamMembers.find(m => m.id === currentUser.id);
  if (!member || member.loginPw !== currentPw) {
    errorEl.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }

  // ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  if (newPw !== confirmPw) {
    errorEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }

  if (newPw.length < 4) {
    errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }

  try {
    await db.collection('teamMembers').doc(currentUser.id).update({
      loginPw: newPw,
      needPasswordChange: false,
      updatedAt: new Date().toISOString()
    });

    // ì„¸ì…˜ ì—…ë°ì´íŠ¸
    if (state.currentAdmin) {
      state.currentAdmin.loginPw = newPw;
      sessionStorage.setItem('moyeora_admin_user', JSON.stringify(state.currentAdmin));
    }
    if (state.currentUser) {
      state.currentUser.loginPw = newPw;
      sessionStorage.setItem('moyeora_admin_user', JSON.stringify(state.currentUser));
    }

    showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (err) {
    console.error(err);
    errorEl.textContent = 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    errorEl.style.display = 'block';
  }
}

// ==================== ì˜ì—… í˜„í™© ëŒ€ì‹œë³´ë“œ ====================
function renderSalesDashboard() {
  const app = document.getElementById('app');
  
  // ì´ˆê¸° ë¡œë”© í‘œì‹œ
  app.innerHTML = `
    <div style="background: #F2F4F6; min-height: 100vh; margin: -24px; padding: 24px;">
      <div style="text-align: center; padding: 60px;">
        <div class="loading-spinner"></div>
        <p style="color: #6B7684; margin-top: 16px;">ì˜ì—…í˜„í™© ë¡œë”©ì¤‘...</p>
      </div>
    </div>
  `;
  
  loadSalesDashboardWithOKR();
}

async function loadSalesDashboardWithOKR() {
  try {
    // OKR ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const currentQuarter = getQuarter();
    const quarterKey = currentQuarter.year + '-Q' + currentQuarter.quarter;
    
    const okrSnapshot = await db.collection('okrs').where('quarter', '==', quarterKey).get();
    const okrList = [];
    okrSnapshot.forEach(doc => {
      okrList.push({ id: doc.id, ...doc.data() });
    });
    
    // ì‹¤ì œ ë°ì´í„° ê³„ì‚°
    const allSettlements = state.sellerSettlements || [];
    const actualData = {
      sales: allSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0),
      profit: allSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0),
      dealCount: state.deals?.length || 0,
      sellerCount: state.sellers?.length || 0,
      supplierCount: state.suppliers?.length || 0,
      orderCount: allSettlements.reduce((sum, s) => {
        const items = s.items || [];
        return sum + items.reduce((qSum, item) => qSum + (Number(item.quantity) || 0), 0);
      }, 0)
    };
    
    // ì˜ì—… ê´€ë ¨ KRë§Œ í•„í„°ë§ + ì‹¤ì œ ë°ì´í„° ì—°ë™
    const salesKRs = [];
    okrList.forEach(okr => {
      if (okr.keyResults) {
        okr.keyResults.forEach(kr => {
          if (kr.type && kr.type !== 'manual') {
            // íƒ€ì…ë³„ë¡œ ì‹¤ì œ ë°ì´í„° ìë™ ë§¤í•‘
            let actualValue = kr.actual || 0;
            if (kr.type === 'sales') actualValue = actualData.sales;
            else if (kr.type === 'profit') actualValue = actualData.profit;
            else if (kr.type === 'dealCount') actualValue = actualData.dealCount;
            else if (kr.type === 'sellerCount') actualValue = actualData.sellerCount;
            else if (kr.type === 'supplierCount') actualValue = actualData.supplierCount;
            else if (kr.type === 'orderCount') actualValue = actualData.orderCount;
            
            salesKRs.push({
              ...kr,
              actual: actualValue,
              okrId: okr.id,
              okrObjective: okr.objective,
              memberId: okr.memberId
            });
          }
        });
      }
    });
    
    renderSalesDashboardContent(salesKRs, quarterKey);
  } catch (error) {
    console.error('ì˜ì—…í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', error);
    renderSalesDashboardContent([], '');
  }
}

function renderSalesDashboardContent(salesKRs, quarterKey) {
  const app = document.getElementById('app');
  const members = state.teamMembers || [];
  const currentUser = state.currentUser || {};
  const isAdmin = currentUser.role === 'admin';
  
  // ì‚¬ì´ë“œë°” í”„ë¡œí•„ ì—…ë°ì´íŠ¸
  updateSidebarUserProfile();
  
  // ëª©í‘œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const goals = state.salesGoals || {};
  
  // ë¯¸ë°°ì • ë°ì´í„° ì§‘ê³„
  const unassignedSuppliers = state.suppliers.filter(s => !s.registeredBy);
  const unassignedSellers = state.sellers.filter(s => !s.registeredBy);
  const unassignedDeals = state.deals.filter(d => !d.registeredBy);
  
  // ì´ë²ˆë‹¬/ì „ì›” ê¸°ì¤€
  const now = new Date();
  const thisMonth = now.toISOString().slice(0, 7);
  const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const lastMonth = lastMonthDate.toISOString().slice(0, 7);
  
  // ì •ì‚° ë°ì´í„°
  const allSettlements = state.sellerSettlements || [];
  
  // íŒ€ì›ë³„ ì‹¤ì  ê³„ì‚° (íŒë§¤ê±´ìˆ˜, ë§¤ì¶œ, ìˆœìˆ˜ìµ í¬í•¨)
  const memberStats = members.map(member => {
    // ë‹´ë‹¹ìë¡œ ë“±ë¡ëœ í•­ëª©
    const suppliers = state.suppliers.filter(s => s.registeredBy === member.id);
    const sellers = state.sellers.filter(s => s.registeredBy === member.id);
    const deals = state.deals.filter(d => d.registeredBy === member.id);
    
    // ì´ë²ˆ ë‹¬ / ì „ì›” ì…ì 
    const monthlySuppliers = suppliers.filter(s => s.createdAt?.startsWith(thisMonth));
    const monthlySellers = sellers.filter(s => s.createdAt?.startsWith(thisMonth));
    const monthlyDeals = deals.filter(d => d.createdAt?.startsWith(thisMonth));
    
    const lastMonthSuppliers = suppliers.filter(s => s.createdAt?.startsWith(lastMonth));
    const lastMonthSellers = sellers.filter(s => s.createdAt?.startsWith(lastMonth));
    const lastMonthDeals = deals.filter(d => d.createdAt?.startsWith(lastMonth));
    
    // ë‹´ë‹¹ ì…€ëŸ¬ ì´ë¦„ ëª©ë¡
    const sellerNames = sellers.map(s => s.name).filter(Boolean);
    
    // ì •ì‚° ë°ì´í„° ì—°ë™ (ë‹´ë‹¹ ì…€ëŸ¬ë“¤ì˜ ì •ì‚° ë°ì´í„°)
    const memberSettlements = allSettlements.filter(s => {
      // 1. registeredByë¡œ ì§ì ‘ ì—°ê²°
      if (s.registeredBy === member.id) return true;
      // 2. ë‹´ë‹¹ ì…€ëŸ¬ ì´ë¦„ìœ¼ë¡œ ì—°ê²°
      const settlementSellerName = s.sellerName || '';
      return sellerNames.some(name => {
        if (!name) return false;
        const namePart = name.split('/')[0];
        return settlementSellerName.includes(namePart) || settlementSellerName.includes(name);
      });
    });
    
    // ì´ë²ˆë‹¬/ì „ì›” ì •ì‚°
    const thisMonthSettlements = memberSettlements.filter(s => {
      const dateStr = s.settlementDate || s.createdAt || '';
      return dateStr.startsWith(thisMonth) || dateStr.includes(thisMonth.replace('-', '.'));
    });
    const lastMonthSettlements = memberSettlements.filter(s => {
      const dateStr = s.settlementDate || s.createdAt || '';
      return dateStr.startsWith(lastMonth) || dateStr.includes(lastMonth.replace('-', '.'));
    });
    
    // ë§¤ì¶œ ì§‘ê³„
    const totalSales = memberSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
    const totalProfit = memberSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
    
    // ì‹¤ì œ íŒë§¤ ìˆ˜ëŸ‰ í•©ê³„ (ì •ì‚°ì˜ itemsì—ì„œ quantity í•©ì‚°)
    const totalQuantity = memberSettlements.reduce((sum, s) => {
      const items = s.items || [];
      return sum + items.reduce((qSum, item) => qSum + (Number(item.quantity) || 0), 0);
    }, 0);
    
    const thisMonthSales = thisMonthSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
    const thisMonthProfit = thisMonthSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
    
    return {
      ...member,
      totalSuppliers: suppliers.length,
      totalSellers: sellers.length,
      totalDeals: deals.length,
      monthlySuppliers: monthlySuppliers.length,
      monthlySellers: monthlySellers.length,
      monthlyDeals: monthlyDeals.length,
      lastMonthSuppliers: lastMonthSuppliers.length,
      lastMonthSellers: lastMonthSellers.length,
      lastMonthDeals: lastMonthDeals.length,
      salesCount: memberSettlements.length,
      totalQuantity,  // ì‹¤ì œ íŒë§¤ ìˆ˜ëŸ‰
      thisMonthSalesCount: thisMonthSettlements.length,
      totalSales,
      totalProfit,
      thisMonthSales,
      thisMonthProfit
    };
  });
  
  // ì „ì²´ í†µê³„
  const totalSupplierCount = state.suppliers.length;
  const totalSellerCount = state.sellers.length;
  const totalDealCount = state.deals.length;
  const totalSalesCount = allSettlements.length;
  const totalSalesAmount = allSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  const totalProfitAmount = allSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
  
  // ì „ì²´ íŒë§¤ ìˆ˜ëŸ‰ (ì„±ê³µë¥  ê³„ì‚°ìš©)
  const totalQuantityAll = allSettlements.reduce((sum, s) => {
    const items = s.items || [];
    return sum + items.reduce((qSum, item) => qSum + (Number(item.quantity) || 0), 0);
  }, 0);
  const expectedSalesAll = totalDealCount * 300;
  const teamSuccessRate = expectedSalesAll > 0 ? ((totalQuantityAll / expectedSalesAll) * 100).toFixed(1) : '0.0';
  
  // ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚° (ì†Œìˆ˜ì  1ìë¦¬)
  const calcRate = (current, goal) => goal > 0 ? Math.min((current / goal) * 100, 100).toFixed(3) : '0.000';
  const calcRateNum = (current, goal) => goal > 0 ? Math.min((current / goal) * 100, 100) : 0;
  
  // í† ìŠ¤ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸
  const tossColors = {
    blue: '#0064FF',
    blueDark: '#0050CC',
    blueLight: '#E8F3FF',
    black: '#191F28',
    gray700: '#333D4B',
    gray600: '#4E5968',
    gray500: '#6B7684',
    gray400: '#8B95A1',
    gray300: '#B0B8C1',
    gray200: '#D1D6DB',
    gray100: '#E5E8EB',
    gray50: '#F2F4F6',
    white: '#FFFFFF',
    green: '#00C471',
    red: '#F04452',
    yellow: '#FFC107'
  };
  
  app.innerHTML = `
    <div style="background: ${tossColors.gray50}; min-height: 100vh; margin: -24px; padding: 24px;">
      <!-- í—¤ë” -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h1 style="font-size: 26px; font-weight: 700; color: ${tossColors.black}; margin: 0;">ì˜ì—…í˜„í™©</h1>
          <p style="color: ${tossColors.gray500}; margin-top: 8px; font-size: 15px;">íŒ€ì›ë³„ ì…ì , ë§¤ì¶œ ì„±ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
        </div>
        ${isAdmin ? `
          <div style="display: flex; gap: 10px;">
            <button onclick="openGoalCalculator()" style="
              padding: 12px 20px;
              font-size: 14px;
              font-weight: 600;
              background: ${tossColors.white};
              color: ${tossColors.blue};
              border: none;
              border-radius: 12px;
              cursor: pointer;
              box-shadow: 0 2px 8px rgba(0,0,0,0.08);
              transition: all 0.2s;
            ">ğŸ“Š ê³„ì‚°ê¸°</button>
            <button onclick="openGoalSettingModal()" style="
              padding: 12px 20px;
              font-size: 14px;
              font-weight: 600;
              background: ${tossColors.blue};
              color: white;
              border: none;
              border-radius: 12px;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(0,100,255,0.3);
              transition: all 0.2s;
            ">ğŸ‘¥ íŒ€ì›ë³„ ëª©í‘œ</button>
          </div>
        ` : ''}
      </div>

    <!-- íŒ€ ëª©í‘œ í˜„í™© (ëª©í‘œ ì„¤ì • ì‹œì—ë§Œ í‘œì‹œ) -->
    ${(goals.suppliers || goals.sellers || goals.deals || goals.salesAmount || goals.profitAmount) ? `
      <div style="background: ${tossColors.white}; border-radius: 20px; padding: 28px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
          <div>
            <div style="font-size: 13px; font-weight: 600; color: ${tossColors.blue}; margin-bottom: 4px;">íŒ€ ëª©í‘œ</div>
            <div style="font-size: 20px; font-weight: 700; color: ${tossColors.black};">ì „ì²´ ë‹¬ì„± í˜„í™©</div>
          </div>
          ${goals.salesAmount ? `
            <div style="text-align: right;">
              <div style="font-size: 13px; color: ${tossColors.gray500}; margin-bottom: 4px;">ìµœì¢… ë‹¬ì„±ë¥ </div>
              <div style="font-size: 36px; font-weight: 700; color: ${tossColors.blue};">${calcRate(totalSalesAmount, goals.salesAmount)}%</div>
              <div style="width: 120px; height: 6px; background: ${tossColors.gray100}; border-radius: 3px; overflow: hidden; margin-top: 8px;">
                <div style="height: 100%; width: ${calcRateNum(totalSalesAmount, goals.salesAmount)}%; background: ${tossColors.blue}; border-radius: 3px; transition: width 0.5s;"></div>
              </div>
            </div>
          ` : ''}
        </div>
        
        <div style="display: grid; grid-template-columns: ${isAdmin ? 'repeat(6, 1fr)' : 'repeat(5, 1fr)'}; gap: 16px;">
          ${goals.suppliers ? `
            <div style="background: ${tossColors.gray50}; border-radius: 16px; padding: 20px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700; color: ${tossColors.black};">${totalSupplierCount}<span style="font-size: 16px; color: ${tossColors.gray400};">/${goals.suppliers}</span></div>
              <div style="font-size: 13px; color: ${tossColors.gray500}; margin-top: 8px;">ê³µê¸‰ì‚¬</div>
              <div style="height: 4px; background: ${tossColors.gray200}; border-radius: 2px; margin-top: 12px;">
                <div style="height: 100%; width: ${calcRateNum(totalSupplierCount, goals.suppliers)}%; background: ${tossColors.blue}; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 12px; color: ${tossColors.gray400}; margin-top: 8px;">${goals.suppliers - totalSupplierCount > 0 ? `${goals.suppliers - totalSupplierCount}ê°œ ë‚¨ìŒ` : 'ë‹¬ì„±!'}</div>
            </div>
          ` : ''}
          ${goals.sellers ? `
            <div style="background: ${tossColors.gray50}; border-radius: 16px; padding: 20px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700; color: ${tossColors.black};">${totalSellerCount}<span style="font-size: 16px; color: ${tossColors.gray400};">/${goals.sellers}</span></div>
              <div style="font-size: 13px; color: ${tossColors.gray500}; margin-top: 8px;">ì…€ëŸ¬</div>
              <div style="height: 4px; background: ${tossColors.gray200}; border-radius: 2px; margin-top: 12px;">
                <div style="height: 100%; width: ${calcRateNum(totalSellerCount, goals.sellers)}%; background: ${tossColors.blue}; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 12px; color: ${tossColors.gray400}; margin-top: 8px;">${goals.sellers - totalSellerCount > 0 ? `${goals.sellers - totalSellerCount}ëª… ë‚¨ìŒ` : 'ë‹¬ì„±!'}</div>
            </div>
          ` : ''}
          ${goals.deals ? `
            <div style="background: ${tossColors.gray50}; border-radius: 16px; padding: 20px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700; color: ${tossColors.black};">${totalDealCount}<span style="font-size: 16px; color: ${tossColors.gray400};">/${goals.deals}</span></div>
              <div style="font-size: 13px; color: ${tossColors.gray500}; margin-top: 8px;">ê³µêµ¬ ê±´</div>
              <div style="height: 4px; background: ${tossColors.gray200}; border-radius: 2px; margin-top: 12px;">
                <div style="height: 100%; width: ${calcRateNum(totalDealCount, goals.deals)}%; background: ${tossColors.blue}; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 12px; color: ${tossColors.gray400}; margin-top: 8px;">${goals.deals - totalDealCount > 0 ? `${goals.deals - totalDealCount}ê±´ ë‚¨ìŒ` : 'ë‹¬ì„±!'}</div>
            </div>
          ` : ''}
          <!-- ì„±ê³µë¥  (300ê°œ ê¸°ì¤€) - ì—°í•œ ë°°ê²½ -->
          <div style="background: ${teamSuccessRate >= 30 ? '#E8F5E9' : teamSuccessRate >= 20 ? '#FFF8E1' : '#FFEBEE'}; border-radius: 16px; padding: 20px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: ${teamSuccessRate >= 30 ? tossColors.green : teamSuccessRate >= 20 ? '#F59E0B' : tossColors.red};">${teamSuccessRate}%</div>
            <div style="font-size: 13px; color: ${tossColors.gray500}; margin-top: 8px;">ì„±ê³µë¥ </div>
            <div style="font-size: 11px; color: ${tossColors.gray400}; margin-top: 8px;">${totalQuantityAll}ê°œ / ${expectedSalesAll}ê°œ</div>
            <div style="font-size: 10px; color: ${tossColors.gray400}; margin-top: 4px;">ê³µêµ¬ë‹¹ 300ê°œ ê¸°ì¤€</div>
          </div>
          ${goals.salesAmount ? `
            <div style="background: ${tossColors.blueLight}; border-radius: 16px; padding: 20px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: ${tossColors.blue};">${formatNumber(totalSalesAmount)}ì›</div>
              <div style="font-size: 13px; color: ${tossColors.gray500}; margin-top: 8px;">ë§¤ì¶œ</div>
              <div style="height: 4px; background: rgba(0,100,255,0.2); border-radius: 2px; margin-top: 12px;">
                <div style="height: 100%; width: ${calcRateNum(totalSalesAmount, goals.salesAmount)}%; background: ${tossColors.blue}; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 12px; color: ${tossColors.gray400}; margin-top: 8px;">ëª©í‘œ ${formatNumber(goals.salesAmount)}ì›</div>
            </div>
          ` : ''}
          ${isAdmin && goals.profitAmount ? `
            <div style="background: linear-gradient(135deg, ${tossColors.blue}, #3B82F6); border-radius: 16px; padding: 20px; text-align: center; color: white;">
              <div style="font-size: 20px; font-weight: 700;">${formatNumber(totalProfitAmount)}ì›</div>
              <div style="font-size: 13px; opacity: 0.9; margin-top: 8px; position: relative; display: inline-block;">
                ìˆœìˆ˜ìµ
                <span class="profit-tooltip-trigger" style="display: inline-block; width: 18px; height: 18px; background: rgba(255,255,255,0.3); border-radius: 50%; font-size: 11px; line-height: 18px; cursor: help; margin-left: 4px; position: relative;">?
                  <span class="profit-tooltip" style="display: none; position: absolute; bottom: 28px; left: 50%; transform: translateX(-50%); width: 280px; background: #1a1a2e; color: white; padding: 14px; border-radius: 10px; font-size: 12px; text-align: left; line-height: 1.6; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <strong style="color: #60a5fa;">ğŸ“Š ìˆœìˆ˜ìµ ê³„ì‚° ë°©ì‹</strong><br><br>
                    <strong style="color: #fbbf24;">[íƒ€ì‚¬ ì œí’ˆ]</strong><br>
                    íŒë§¤ê°€ - ì…€ëŸ¬ë§ˆì§„ - ê³µê¸‰ë‹¨ê°€ - PGìˆ˜ìˆ˜ë£Œ - ì´ë²¤íŠ¸ë¹„ìš©<br><br>
                    <strong style="color: #34d399;">[ìì‚¬ ì œí’ˆ]</strong><br>
                    íŒë§¤ê°€ - ì…€ëŸ¬ë§ˆì§„ - PGìˆ˜ìˆ˜ë£Œ - ì´ë²¤íŠ¸ë¹„ìš©<br>
                    <span style="color: #9ca3af; font-size: 11px;">â€» ìì‚¬ ì œí’ˆì€ ê³µê¸‰ë‹¨ê°€ê°€ ë¹ ì§€ì§€ ì•ŠìŒ</span>
                    <span style="position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #1a1a2e;"></span>
                  </span>
                </span>
              </div>
              <div style="height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 12px;">
                <div style="height: 100%; width: ${calcRateNum(totalProfitAmount, goals.profitAmount)}%; background: white; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">ëª©í‘œ ${formatNumber(goals.profitAmount)}ì›</div>
            </div>
          ` : ''}
        </div>
        
        <!-- ëª©í‘œ ì„¤ì • ê·¼ê±° -->
        ${goals.calcParams ? `
        <div style="margin-top: 20px; padding: 16px; background: ${tossColors.blueLight}; border-radius: 12px;">
          <div style="font-size: 13px; color: ${tossColors.blue}; font-weight: 600; margin-bottom: 8px;">ğŸ“Š ëª©í‘œ ì„¤ì • ê·¼ê±°</div>
          <div style="font-size: 13px; color: ${tossColors.gray700}; line-height: 1.8;">
            â€¢ ì—° ëª©í‘œ ìˆœìˆ˜ìµ <strong>${formatNumber(goals.calcParams.annualExpectedProfit)}ì›</strong> ë‹¬ì„±ì„ ìœ„í•´<br>
            â€¢ ê³µêµ¬ë‹¹ ì˜ˆìƒ íŒë§¤ <strong>${goals.calcParams.salesPerDeal}ê°œ</strong> Ã— ê±´ë‹¹ ìˆœë§ˆì§„ <strong>${formatNumber(goals.calcParams.marginPerItem)}ì›</strong> = ê³µêµ¬ë‹¹ ê¸°ëŒ€ìˆœìµ <strong>${formatNumber(goals.calcParams.expectedProfit)}ì›</strong><br>
            â€¢ ì›” <strong>${goals.calcParams.monthlyDeals}ê±´</strong> Ã— 12ê°œì›” = ì—° <strong>${goals.deals}ê±´</strong> ê³µêµ¬ í•„ìš”
          </div>
        </div>
        ` : ''}
      </div>
    ` : ''}
    
    <!-- ì˜ì—… ê¸°ì¤€ ì •ë³´ (ê³„ì‚°ê¸° ì„¤ì •ê°’) -->
    ${goals.calcParams ? `
      <div style="background: ${tossColors.white}; border-radius: 20px; padding: 28px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <div style="font-size: 13px; font-weight: 600; color: ${tossColors.blue}; margin-bottom: 4px;">ì˜ì—… ê¸°ì¤€</div>
            <div style="font-size: 18px; font-weight: 700; color: ${tossColors.black};">ëª©í‘œ ë‹¬ì„± ê°€ì´ë“œ</div>
          </div>
          <div style="font-size: 12px; color: ${tossColors.gray400};">ê³„ì‚°ê¸° ì„¤ì • ê¸°ì¤€</div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;">
          <div style="text-align: center; padding: 16px; background: ${tossColors.blue}; border-radius: 16px; color: white;">
            <div style="font-size: 28px; font-weight: 700;">${goals.calcParams.monthlyDeals}</div>
            <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">ì›” í•„ìš” ê³µêµ¬</div>
          </div>
          <div style="text-align: center; padding: 16px; background: ${tossColors.gray50}; border-radius: 16px;">
            <div style="font-size: 18px; font-weight: 700; color: ${tossColors.black};">${formatNumber(goals.calcParams.pricePerItem)}ì›</div>
            <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ê±´ë‹¹ íŒë§¤ê°€</div>
          </div>
          <div style="text-align: center; padding: 16px; background: ${tossColors.gray50}; border-radius: 16px;">
            <div style="font-size: 18px; font-weight: 700; color: ${tossColors.blue};">${formatNumber(goals.calcParams.marginPerItem)}ì›</div>
            <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ê±´ë‹¹ ìˆœë§ˆì§„</div>
          </div>
          <div style="text-align: center; padding: 16px; background: ${tossColors.gray50}; border-radius: 16px;">
            <div style="font-size: 18px; font-weight: 700; color: ${tossColors.black};">${goals.calcParams.salesPerDeal}ê°œ</div>
            <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ê³µêµ¬ë‹¹ ì˜ˆìƒíŒë§¤</div>
          </div>
          <div style="text-align: center; padding: 16px; background: ${tossColors.gray50}; border-radius: 16px;">
            <div style="font-size: 18px; font-weight: 700; color: ${tossColors.black};">${goals.calcParams.successRate}%</div>
            <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ì˜ˆìƒ ì„±ê³µë¥ </div>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding-top: 20px; border-top: 1px solid ${tossColors.gray100};">
          <div style="text-align: center;">
            <div style="font-size: 15px; font-weight: 600; color: ${tossColors.gray700};">${formatNumber(goals.calcParams.expectedRevenue)}ì›</div>
            <div style="font-size: 11px; color: ${tossColors.gray400}; margin-top: 4px;">ê±´ë‹¹ ê¸°ëŒ€ë§¤ì¶œ</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 15px; font-weight: 600; color: ${tossColors.blue};">${formatNumber(goals.calcParams.expectedProfit)}ì›</div>
            <div style="font-size: 11px; color: ${tossColors.gray400}; margin-top: 4px;">ê±´ë‹¹ ê¸°ëŒ€ìˆœìµ</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 15px; font-weight: 600; color: ${tossColors.gray700};">${formatNumber(goals.calcParams.annualExpectedRevenue)}ì›</div>
            <div style="font-size: 11px; color: ${tossColors.gray400}; margin-top: 4px;">ì—°ê°„ ì˜ˆìƒë§¤ì¶œ</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 15px; font-weight: 600; color: ${tossColors.green};">${formatNumber(goals.calcParams.annualExpectedProfit)}ì›</div>
            <div style="font-size: 11px; color: ${tossColors.gray400}; margin-top: 4px;">ì—°ê°„ ì˜ˆìƒìˆœìµ</div>
          </div>
        </div>
      </div>
    ` : ''}
    
    <!-- ì£¼ê°„ ëª©í‘œ ê°€ì´ë“œ (ë§¤ì£¼ ìë™ ë¶„ì„) -->
    ${goals.calcParams ? (() => {
      // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ê³„ì‚°
      const today = new Date();
      const yearStart = new Date(today.getFullYear(), 0, 1);
      const yearEnd = new Date(today.getFullYear(), 11, 31);
      const dayOfWeek = today.getDay();
      const isMonday = dayOfWeek === 1;
      
      // ì˜¬í•´ ì´ ì£¼ìˆ˜ì™€ í˜„ì¬ ì£¼ì°¨
      const totalWeeks = 52;
      const currentWeek = Math.ceil((today - yearStart) / (7 * 24 * 60 * 60 * 1000));
      const remainingWeeks = Math.max(totalWeeks - currentWeek, 1);
      const remainingMonths = Math.max(12 - today.getMonth(), 1);
      
      // ëª©í‘œ ëŒ€ë¹„ ë‚¨ì€ ìˆ˜ì¹˜
      const goalDeals = goals.deals || 0;
      const remainingDeals = Math.max(goalDeals - totalDealCount, 0);
      const weeklyNeededDeals = Math.ceil(remainingDeals / remainingWeeks);
      const monthlyNeededDeals = Math.ceil(remainingDeals / remainingMonths);
      
      const goalSales = goals.salesAmount || 0;
      const remainingSales = Math.max(goalSales - totalSalesAmount, 0);
      const weeklyNeededSales = Math.ceil(remainingSales / remainingWeeks);
      
      const goalProfit = goals.profitAmount || 0;
      const remainingProfit = Math.max(goalProfit - totalProfitAmount, 0);
      const weeklyNeededProfit = Math.ceil(remainingProfit / remainingWeeks);
      
      // ë‹¬ì„±ë¥ 
      const dealsRate = goalDeals > 0 ? Math.round((totalDealCount / goalDeals) * 100) : 0;
      const salesRate = goalSales > 0 ? Math.round((totalSalesAmount / goalSales) * 100) : 0;
      
      // ìƒíƒœ íŒë‹¨
      const expectedDealsNow = Math.round(goalDeals * (currentWeek / totalWeeks));
      const isOnTrack = totalDealCount >= expectedDealsNow;
      const behindBy = expectedDealsNow - totalDealCount;
      
      return `
      <div style="background: ${tossColors.white}; border-radius: 20px; padding: 28px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); ${isMonday ? `border: 2px solid ${tossColors.red};` : ''}">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
          <div>
            <div style="font-size: 13px; font-weight: 600; color: ${isMonday ? tossColors.red : tossColors.blue}; margin-bottom: 4px;">
              ${isMonday ? 'ğŸ”” ì›”ìš”ì¼ ë¸Œë¦¬í•‘' : 'ì£¼ê°„ ê°€ì´ë“œ'}
            </div>
            <div style="font-size: 18px; font-weight: 700; color: ${tossColors.black};">
              ${today.getFullYear()}ë…„ ${currentWeek}ì£¼ì°¨
            </div>
            <div style="font-size: 13px; color: ${tossColors.gray500}; margin-top: 4px;">
              ë‚¨ì€ ê¸°ê°„ ${remainingWeeks}ì£¼ (${remainingMonths}ê°œì›”)
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 12px; color: ${tossColors.gray400}; margin-bottom: 4px;">í˜„ì¬ ì§„í–‰ë¥ </div>
            <div style="font-size: 32px; font-weight: 700; color: ${isOnTrack ? tossColors.green : tossColors.red};">${dealsRate}%</div>
          </div>
        </div>
        
        ${!isOnTrack && behindBy > 0 ? `
          <div style="background: #FEF2F2; border-radius: 12px; padding: 14px; margin-bottom: 20px;">
            <div style="font-size: 14px; color: ${tossColors.red}; font-weight: 600;">
              âš ï¸ ì˜ˆìƒ ì§„ë„ë³´ë‹¤ ${behindBy}ê±´ ë’¤ì²˜ì ¸ ìˆì–´ìš”
            </div>
          </div>
        ` : isOnTrack ? `
          <div style="background: #F0FDF4; border-radius: 12px; padding: 14px; margin-bottom: 20px;">
            <div style="font-size: 14px; color: ${tossColors.green}; font-weight: 600;">
              âœ… ëª©í‘œ ì§„ë„ì— ë§ê²Œ ì§„í–‰ë˜ê³  ìˆì–´ìš”
            </div>
          </div>
        ` : ''}
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
          <div style="text-align: center; padding: 20px 16px; background: ${tossColors.blue}; border-radius: 16px; color: white;">
            <div style="font-size: 32px; font-weight: 700;">${weeklyNeededDeals}</div>
            <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">ì£¼ê°„ í•„ìš” ê³µêµ¬ê±´</div>
          </div>
          <div style="text-align: center; padding: 20px 16px; background: ${tossColors.gray50}; border-radius: 16px;">
            <div style="font-size: 32px; font-weight: 700; color: ${tossColors.black};">${monthlyNeededDeals}</div>
            <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ì›”ê°„ í•„ìš” ê³µêµ¬</div>
          </div>
          <div style="text-align: center; padding: 20px 16px; background: ${tossColors.gray50}; border-radius: 16px;">
            <div style="font-size: 18px; font-weight: 700; color: ${tossColors.black};">${formatNumber(weeklyNeededSales)}ì›</div>
            <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ì£¼ê°„ í•„ìš” ë§¤ì¶œ</div>
          </div>
          <div style="text-align: center; padding: 20px 16px; background: ${tossColors.gray50}; border-radius: 16px;">
            <div style="font-size: 18px; font-weight: 700; color: ${tossColors.green};">${formatNumber(weeklyNeededProfit)}ì›</div>
            <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ì£¼ê°„ í•„ìš” ìˆœìµ</div>
          </div>
        </div>
        
        <div style="margin-top: 20px; padding: 16px; background: ${tossColors.blueLight}; border-radius: 12px;">
          <div style="font-size: 13px; color: ${tossColors.gray700}; line-height: 1.6;">
            ğŸ’¡ <strong>ì´ë²ˆ ì£¼ ì•¡ì…˜:</strong> 
            ê³µêµ¬ ${weeklyNeededDeals}ê±´ ì§„í–‰ ì‹œ ì•½ 
            <strong style="color: ${tossColors.blue};">${formatNumber(weeklyNeededDeals * goals.calcParams.salesPerDeal * goals.calcParams.marginPerItem * (goals.calcParams.successRate / 100))}ì› ìˆœìµ</strong> ì˜ˆìƒ
          </div>
        </div>
      </div>
    `;
    })() : ''}
    
    <!-- ë‹´ë‹¹ì ë¯¸ë°°ì • ì•Œë¦¼ -->
    ${(unassignedSuppliers.length + unassignedSellers.length + unassignedDeals.length) > 0 ? `
      <div style="padding: 20px 24px; background: ${tossColors.white}; border-radius: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <div>
            <div style="font-weight: 600; color: ${tossColors.black}; margin-bottom: 4px;">âš ï¸ ë‹´ë‹¹ì ë¯¸ë°°ì •</div>
            <div style="font-size: 14px; color: ${tossColors.gray500};">
              ê³µê¸‰ì‚¬ ${unassignedSuppliers.length}ê±´ Â· ì…€ëŸ¬ ${unassignedSellers.length}ê±´ Â· ê³µêµ¬ ${unassignedDeals.length}ê±´
            </div>
          </div>
          <div style="display: flex; gap: 8px;">
            ${isAdmin ? `
            <button onclick="openAssignManagerModal()" style="
              padding: 12px 20px;
              font-size: 14px;
              font-weight: 600;
              background: ${tossColors.white};
              color: ${tossColors.blue};
              border: 1px solid ${tossColors.blue};
              border-radius: 12px;
              cursor: pointer;
            ">ë‹´ë‹¹ì ìˆ˜ì •</button>
            ` : ''}
            <button onclick="viewAssignmentStatus()" style="
              padding: 12px 20px;
              font-size: 14px;
              font-weight: 600;
              background: ${tossColors.blue};
              color: white;
              border: none;
              border-radius: 12px;
              cursor: pointer;
            ">${isAdmin ? 'ë°°ì •í•˜ê¸°' : 'ë°°ì •ë³´ê¸°'}</button>
          </div>
        </div>
      </div>
    ` : `
      ${isAdmin ? `
      <div style="padding: 20px 24px; background: ${tossColors.white}; border-radius: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: 600; color: ${tossColors.black}; margin-bottom: 4px;">âœ… ë‹´ë‹¹ì ë°°ì • ì™„ë£Œ</div>
            <div style="font-size: 14px; color: ${tossColors.gray500};">ëª¨ë“  ë°ì´í„°ì— ë‹´ë‹¹ìê°€ ë°°ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div>
          </div>
          <button onclick="openAssignManagerModal()" style="
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            background: ${tossColors.white};
            color: ${tossColors.blue};
            border: 1px solid ${tossColors.blue};
            border-radius: 12px;
            cursor: pointer;
          ">ë‹´ë‹¹ì ìˆ˜ì •</button>
        </div>
      </div>
      ` : ''}
    `}
    
    ${(() => {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì°¾ê¸°
      const currentMember = memberStats.find(m => m.id === currentUser?.odiyaId || m.loginId === currentUser?.loginId);
      let otherMembers = memberStats.filter(m => m.id !== currentMember?.id);
      
      // ì €ì¥ëœ ìˆœì„œ ì ìš©
      const savedOrder = JSON.parse(localStorage.getItem('memberCardOrder') || '[]');
      if (savedOrder.length > 0) {
        otherMembers = otherMembers.sort((a, b) => {
          const aIdx = savedOrder.indexOf(a.id);
          const bIdx = savedOrder.indexOf(b.id);
          if (aIdx === -1 && bIdx === -1) return 0;
          if (aIdx === -1) return 1;
          if (bIdx === -1) return -1;
          return aIdx - bIdx;
        });
      }
      
      // ë©¤ë²„ ì¹´ë“œ ìƒì„± í•¨ìˆ˜
      const renderMemberCard = (m, isMe = false) => {
        const supplierDiff = m.monthlySuppliers - m.lastMonthSuppliers;
        const sellerDiff = m.monthlySellers - m.lastMonthSellers;
        const dealDiff = m.monthlyDeals - m.lastMonthDeals;
        const mGoal = (state.memberGoals || {})[m.id] || {};
        const hasGoal = mGoal.suppliers || mGoal.sellers || mGoal.deals || mGoal.salesAmount;
        
        // ê°œì¸ ì£¼ê°„ ê°€ì´ë“œ ê³„ì‚°
        const today = new Date();
        const yearStart = new Date(today.getFullYear(), 0, 1);
        const totalWeeks = 52;
        const currentWeek = Math.ceil((today - yearStart) / (7 * 24 * 60 * 60 * 1000));
        const remainingWeeks = Math.max(totalWeeks - currentWeek, 1);
        
        const memberRemainingDeals = hasGoal && mGoal.deals ? Math.max(mGoal.deals - m.totalDeals, 0) : 0;
        const memberWeeklyNeededDeals = Math.ceil(memberRemainingDeals / remainingWeeks);
        const memberRemainingProfit = hasGoal && mGoal.profitAmount ? Math.max(mGoal.profitAmount - m.totalProfit, 0) : 0;
        const memberWeeklyNeededProfit = Math.ceil(memberRemainingProfit / remainingWeeks);
        
        // ì„±ê³µë¥  ê³„ì‚° (ì‹¤ì œ íŒë§¤ìˆ˜ëŸ‰ / (ê³µêµ¬ìˆ˜ Ã— 300))
        const expectedSales = m.totalDeals * 300;
        const successRate = expectedSales > 0 ? ((m.totalQuantity / expectedSales) * 100).toFixed(1) : 0;
        
        // AI ì½”ì¹­ ë©”ì‹œì§€ ìƒì„±
        let coachingMsg = '';
        if (hasGoal && mGoal.deals) {
          const dealsRate = mGoal.deals > 0 ? (m.totalDeals / mGoal.deals * 100) : 0;
          const expectedProgress = (currentWeek / totalWeeks) * 100;
          
          if (successRate >= 30) {
            coachingMsg = 'ğŸ‘ ì„±ê³µë¥  ' + successRate + '%ë¡œ ìš°ìˆ˜í•©ë‹ˆë‹¤! í˜„ì¬ í˜ì´ìŠ¤ ìœ ì§€í•˜ë©´ì„œ ê³µêµ¬ ìˆ˜ë¥¼ ëŠ˜ë ¤ë³´ì„¸ìš”.';
          } else if (successRate >= 20) {
            coachingMsg = 'ğŸ’ª ì„±ê³µë¥  ' + successRate + '%, ëª©í‘œ 30%ê¹Œì§€ ' + (30 - successRate).toFixed(1) + '%p ë‚¨ì•˜ì–´ìš”. ì…€ëŸ¬ íŒ”ë¡œì—…ì— ì§‘ì¤‘í•´ë³´ì„¸ìš”.';
          } else if (successRate >= 10) {
            coachingMsg = 'ğŸ“ˆ ì„±ê³µë¥  ' + successRate + '%, ì…€ëŸ¬ ì„ ì • ê¸°ì¤€ì„ ì ê²€í•´ë³´ì„¸ìš”. íŒ”ë¡œì›Œ ìˆ˜ì™€ ì°¸ì—¬ìœ¨ì´ ë†’ì€ ì…€ëŸ¬ ìš°ì„ !';
          } else if (m.totalDeals > 0) {
            coachingMsg = 'ğŸ¯ ì„±ê³µë¥  ' + successRate + '%, ê³µêµ¬ í’ˆì§ˆ ê°œì„ ì´ í•„ìš”í•´ìš”. ì¸ê¸° ì¹´í…Œê³ ë¦¬ ì œí’ˆìœ¼ë¡œ ì „í™˜ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.';
          } else {
            coachingMsg = 'ğŸš€ ì²« ê³µêµ¬ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ì£¼ê°„ ' + memberWeeklyNeededDeals + 'ê±´ ëª©í‘œë¡œ ë„ì „!';
          }
          
          if (dealsRate < expectedProgress - 10) {
            coachingMsg += ' âš ï¸ ëª©í‘œ ëŒ€ë¹„ ì§„ë„ê°€ ëŠ¦ì–´ìš”, ì´ë²ˆ ì£¼ ì§‘ì¤‘!';
          }
        }
        
        // ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚° (ì†Œìˆ˜ 2ì§¸ìë¦¬)
        const myGoalRate = mGoal.salesAmount && mGoal.salesAmount > 0 ? (m.totalSales / mGoal.salesAmount * 100).toFixed(2) : '0.00';

        // ë³¸ì¸ì¼ ê²½ìš° ì‚¬ì´ë“œë°”ì—ë„ ë™ì¼í•œ ê°’ í‘œì‹œ
        if (isMe) {
          const rateEl = document.getElementById('userGoalRate');
          if (rateEl) rateEl.textContent = myGoalRate + '%';
        }
        
        return `
        <div style="padding: 24px; background: ${tossColors.white}; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); ${isMe ? `border: 2px solid ${tossColors.blue};` : ''}">
          ${isMe ? `
          <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid ${tossColors.gray100};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 13px; font-weight: 600; color: ${tossColors.blue}; margin-bottom: 4px;">ë‚´ ì‹¤ì </div>
                <div style="font-size: 20px; font-weight: 700; color: ${tossColors.black};">ì˜¤ëŠ˜ë„ í™”ì´íŒ…! ğŸ’ª</div>
              </div>
              ${hasGoal ? `
              <div style="text-align: right;">
                <div style="font-size: 11px; color: ${tossColors.gray400}; margin-bottom: 4px;">ëª©í‘œ ë‹¬ì„±ë¥ </div>
                <div style="font-size: 28px; font-weight: 700; color: ${tossColors.blue};">${myGoalRate}%</div>
              </div>
              ` : ''}
            </div>
          </div>
          ` : ''}
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div>
                <div style="font-weight: 700; font-size: 18px; color: ${tossColors.black};">
                  ${m.name}
                  ${isMe ? `<span style="font-size: 11px; background: ${tossColors.blue}; color: white; padding: 3px 8px; border-radius: 6px; margin-left: 8px;">ë‚˜</span>` : ''}
                </div>
                <div style="font-size: 13px; color: ${tossColors.gray500}; margin-top: 4px;">${m.loginId || '-'} Â· ${m.role === 'admin' ? 'ê´€ë¦¬ì' : m.role === 'manager' ? 'ë§¤ë‹ˆì €' : m.role === 'guest' ? 'ê²ŒìŠ¤íŠ¸' : 'ì¼ë°˜'}</div>
              </div>
            </div>
            <div style="text-align: right; font-size: 12px; color: ${tossColors.gray400};">
              ì´ë²ˆ ë‹¬ vs ì „ì›”
            </div>
          </div>
          
          ${hasGoal && mGoal.deals ? `
          <!-- ê°œì¸ ì£¼ê°„ ê°€ì´ë“œ + AI ì½”ì¹­ -->
          <div style="background: ${tossColors.blueLight}; border-radius: 16px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-size: 13px; color: ${tossColors.blue}; font-weight: 600;">ì´ë²ˆ ì£¼ ëª©í‘œ</div>
              <div style="font-size: 12px; color: ${tossColors.gray500};">ë‚¨ì€ ${remainingWeeks}ì£¼</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;">
              <div style="text-align: center; background: ${tossColors.white}; border-radius: 12px; padding: 14px;">
                <div style="font-size: 24px; font-weight: 700; color: ${tossColors.blue};">${memberWeeklyNeededDeals}</div>
                <div style="font-size: 11px; color: ${tossColors.gray500}; margin-top: 4px;">ì£¼ê°„ í•„ìš” ê³µêµ¬ê±´</div>
              </div>
              <div style="text-align: center; background: ${tossColors.white}; border-radius: 12px; padding: 14px;">
                <div style="font-size: 18px; font-weight: 700; color: ${tossColors.green};">${formatNumber(memberWeeklyNeededProfit)}ì›</div>
                <div style="font-size: 11px; color: ${tossColors.gray500}; margin-top: 4px;">ì£¼ê°„ í•„ìš” ìˆœìµ</div>
              </div>
            </div>
            ${coachingMsg ? `
              <div style="margin-top: 12px; padding: 14px; background: ${tossColors.white}; border-radius: 12px;">
                <div style="font-size: 12px; color: ${tossColors.gray700}; line-height: 1.6;">
                  ğŸ¤– <strong style="color: ${tossColors.blue};">AI ì½”ì¹­</strong> ${coachingMsg}
                </div>
              </div>
            ` : ''}
          </div>
          ` : ''}
          
          <!-- 1í–‰: ì…ì /ë“±ë¡ í˜„í™© -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
            <div style="text-align: center; padding: 16px; background: ${tossColors.gray100}; border-radius: 14px;">
              <div style="font-size: 26px; font-weight: 700; color: ${tossColors.black};">${m.totalSuppliers}${mGoal.suppliers ? `<span style="font-size: 14px; color: ${tossColors.gray400};">/${mGoal.suppliers}</span>` : ''}</div>
              <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ê³µê¸‰ì‚¬</div>
              <div style="font-size: 11px; margin-top: 6px; color: ${supplierDiff >= 0 ? tossColors.blue : tossColors.gray400};">
                ${supplierDiff >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(supplierDiff)}
              </div>
            </div>
            <div style="text-align: center; padding: 16px; background: ${tossColors.gray100}; border-radius: 14px;">
              <div style="font-size: 26px; font-weight: 700; color: ${tossColors.black};">${m.totalSellers}${mGoal.sellers ? `<span style="font-size: 14px; color: ${tossColors.gray400};">/${mGoal.sellers}</span>` : ''}</div>
              <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ì…€ëŸ¬</div>
              <div style="font-size: 11px; margin-top: 6px; color: ${sellerDiff >= 0 ? tossColors.blue : tossColors.gray400};">
                ${sellerDiff >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(sellerDiff)}
              </div>
            </div>
            <div style="text-align: center; padding: 16px; background: ${tossColors.gray100}; border-radius: 14px;">
              <div style="font-size: 26px; font-weight: 700; color: ${tossColors.black};">${m.totalDeals}${mGoal.deals ? `<span style="font-size: 14px; color: ${tossColors.gray400};">/${mGoal.deals}</span>` : ''}</div>
              <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ê³µêµ¬</div>
              <div style="font-size: 11px; margin-top: 6px; color: ${dealDiff >= 0 ? tossColors.blue : tossColors.gray400};">
                ${dealDiff >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(dealDiff)}
              </div>
            </div>
          </div>
          
          <!-- 2í–‰: ì„±ê³µë¥ /ë§¤ì¶œ/ìˆ˜ìµ í˜„í™© -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="text-align: center; padding: 16px; background: ${successRate >= 30 ? '#E8F5E9' : successRate >= 20 ? '#FFF8E1' : '#FFEBEE'}; border-radius: 14px;">
              <div style="font-size: 26px; font-weight: 700; color: ${successRate >= 30 ? tossColors.green : successRate >= 20 ? '#F59E0B' : tossColors.red};">${successRate}%</div>
              <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ì„±ê³µë¥ </div>
              <div style="font-size: 11px; margin-top: 6px; color: ${tossColors.gray400};">
                ${m.totalQuantity}ê°œ / ${expectedSales}ê°œ
              </div>
            </div>
            <div style="text-align: center; padding: 16px; background: ${tossColors.blueLight}; border-radius: 14px;">
              <div style="font-size: 18px; font-weight: 700; color: ${tossColors.blue};">${formatNumber(m.totalSales)}ì›</div>
              <div style="font-size: 12px; color: ${tossColors.gray500}; margin-top: 4px;">ë§¤ì¶œ</div>
              <div style="font-size: 11px; margin-top: 6px; color: ${tossColors.gray400};">
                ì´ë²ˆë‹¬ ${formatNumber(m.thisMonthSales)}ì›
              </div>
            </div>
            <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, ${tossColors.blue}, #3B82F6); border-radius: 14px;">
              <div style="font-size: 18px; font-weight: 700; color: white;">${formatNumber(m.totalProfit)}ì›</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">ìˆœìˆ˜ìµ</div>
              <div style="font-size: 11px; margin-top: 6px; color: rgba(255,255,255,0.7);">
                ì´ë²ˆë‹¬ ${formatNumber(m.thisMonthProfit)}ì›
              </div>
            </div>
          </div>
        </div>
        `;
      };
      
      return `
      <!-- ë‚˜ì˜ ì‹¤ì  -->
      ${currentMember ? `
        <div style="margin-bottom: 16px;">
          ${renderMemberCard(currentMember, true)}
        </div>
      ` : ''}
      
      <!-- íŒ€ì›ë³„ ì‹¤ì  -->
      <div style="background: ${tossColors.white}; border-radius: 20px; padding: 28px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <div style="font-size: 13px; font-weight: 600; color: ${tossColors.blue}; margin-bottom: 4px;">íŒ€ì›</div>
            <div style="font-size: 20px; font-weight: 700; color: ${tossColors.black};">íŒ€ì›ë³„ ì‹¤ì  <span style="font-size: 12px; color: ${tossColors.gray400}; font-weight: 400;">ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½</span></div>
          </div>
        </div>
        ${otherMembers.length === 0 ? `
          <div style="text-align: center; padding: 60px 40px; color: ${tossColors.gray500};">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¥</div>
            <p style="font-size: 15px;">ë‹¤ë¥¸ íŒ€ì›ì´ ì—†ì–´ìš”</p>
          </div>
        ` : `
          <div id="teamMembersContainer" style="display: grid; gap: 16px;">
            ${otherMembers.map((m, idx) => `
              <div class="draggable-member" draggable="true" data-member-id="${m.id}" data-index="${idx}" style="cursor: grab;">
                ${renderMemberCard(m, false)}
              </div>
            `).join('')}
          </div>
        `}
      </div>
      `;
    })()}
    
    <!-- ì…€ëŸ¬/ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì˜ì—… ì„±ê³¼ -->
    ${(() => {
      const allSellerList = state.sellerList || [];
      const allProductList = state.productList || [];
      
      // ë‹´ë‹¹ìë³„ ì…€ëŸ¬ë¦¬ìŠ¤íŠ¸ í†µê³„
      const listUserStats = {};
      
      allSellerList.forEach(s => {
        const user = s.createdBy || 'ë¯¸ì§€ì •';
        if (!listUserStats[user]) {
          listUserStats[user] = {
            sellerRegistered: 0, sellerContacted: 0, sellerProposed: 0, sellerContracted: 0,
            productRegistered: 0, productContacted: 0, productProposed: 0, productContracted: 0
          };
        }
        listUserStats[user].sellerRegistered++;
        if (s.contacted) listUserStats[user].sellerContacted++;
        if (s.proposed) listUserStats[user].sellerProposed++;
        if (s.contracted) listUserStats[user].sellerContracted++;
      });
      
      allProductList.forEach(p => {
        const user = p.createdBy || 'ë¯¸ì§€ì •';
        if (!listUserStats[user]) {
          listUserStats[user] = {
            sellerRegistered: 0, sellerContacted: 0, sellerProposed: 0, sellerContracted: 0,
            productRegistered: 0, productContacted: 0, productProposed: 0, productContracted: 0
          };
        }
        listUserStats[user].productRegistered++;
        if (p.contacted) listUserStats[user].productContacted++;
        if (p.proposed) listUserStats[user].productProposed++;
        if (p.contracted) listUserStats[user].productContracted++;
      });
      
      const totalListStats = {
        sellerRegistered: allSellerList.length,
        sellerContacted: allSellerList.filter(s => s.contacted).length,
        sellerProposed: allSellerList.filter(s => s.proposed).length,
        sellerContracted: allSellerList.filter(s => s.contracted).length,
        productRegistered: allProductList.length,
        productContacted: allProductList.filter(p => p.contacted).length,
        productProposed: allProductList.filter(p => p.proposed).length,
        productContracted: allProductList.filter(p => p.contracted).length
      };
      
      const convRate = (from, to) => from > 0 ? ((to / from) * 100).toFixed(1) : '0';
      
      if (allSellerList.length === 0 && allProductList.length === 0) return '';
      
      return `
      <div style="background: ${tossColors.white}; border-radius: 20px; padding: 28px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="margin-bottom: 20px;">
          <div style="font-size: 13px; font-weight: 600; color: #8b5cf6; margin-bottom: 4px;">íƒìƒ‰ ì˜ì—…</div>
          <div style="font-size: 20px; font-weight: 700; color: ${tossColors.black};">ì…€ëŸ¬/ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì„±ê³¼</div>
        </div>
        
        <!-- ì „ì²´ í¼ë„ -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px;">
          <!-- ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ í¼ë„ -->
          <div style="padding: 20px; background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 16px;">
            <h4 style="color: #1e40af; margin-bottom: 14px; font-size: 14px; font-weight: 600;">ğŸ‘¤ ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</h4>
            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
              <div style="text-align: center; padding: 10px 14px; background: white; border-radius: 10px; min-width: 60px;">
                <div style="font-size: 22px; font-weight: 700; color: #6b7280;">${totalListStats.sellerRegistered}</div>
                <div style="font-size: 10px; color: #9ca3af;">ë“±ë¡</div>
              </div>
              <div style="color: #9ca3af; font-size: 12px;">â†’</div>
              <div style="text-align: center; padding: 10px 14px; background: white; border-radius: 10px; min-width: 60px;">
                <div style="font-size: 22px; font-weight: 700; color: #22c55e;">${totalListStats.sellerProposed}</div>
                <div style="font-size: 10px; color: #22c55e;">ì œì•ˆ</div>
              </div>
              <div style="color: #9ca3af; font-size: 12px;">â†’</div>
              <div style="text-align: center; padding: 10px 14px; background: white; border-radius: 10px; min-width: 60px;">
                <div style="font-size: 22px; font-weight: 700; color: #3b82f6;">${totalListStats.sellerContacted}</div>
                <div style="font-size: 10px; color: #3b82f6;">ì»¨íƒ</div>
              </div>
              <div style="color: #9ca3af; font-size: 12px;">â†’</div>
              <div style="text-align: center; padding: 10px 14px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 10px; min-width: 60px;">
                <div style="font-size: 22px; font-weight: 700; color: white;">${totalListStats.sellerContracted}</div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.8);">ê³„ì•½</div>
              </div>
            </div>
            <div style="margin-top: 12px; font-size: 11px; color: #6b7280;">
              ì œì•ˆë¥  ${convRate(totalListStats.sellerRegistered, totalListStats.sellerProposed)}% Â· ì»¨íƒë¥  ${convRate(totalListStats.sellerProposed, totalListStats.sellerContacted)}% Â· ê³„ì•½ë¥  ${convRate(totalListStats.sellerContacted, totalListStats.sellerContracted)}%
            </div>
          </div>
          
          <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ í¼ë„ -->
          <div style="padding: 20px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px;">
            <h4 style="color: #92400e; margin-bottom: 14px; font-size: 14px; font-weight: 600;">ğŸ“¦ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸</h4>
            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
              <div style="text-align: center; padding: 10px 14px; background: white; border-radius: 10px; min-width: 60px;">
                <div style="font-size: 22px; font-weight: 700; color: #6b7280;">${totalListStats.productRegistered}</div>
                <div style="font-size: 10px; color: #9ca3af;">ë“±ë¡</div>
              </div>
              <div style="color: #9ca3af; font-size: 12px;">â†’</div>
              <div style="text-align: center; padding: 10px 14px; background: white; border-radius: 10px; min-width: 60px;">
                <div style="font-size: 22px; font-weight: 700; color: #22c55e;">${totalListStats.productProposed}</div>
                <div style="font-size: 10px; color: #22c55e;">ì œì•ˆ</div>
              </div>
              <div style="color: #9ca3af; font-size: 12px;">â†’</div>
              <div style="text-align: center; padding: 10px 14px; background: white; border-radius: 10px; min-width: 60px;">
                <div style="font-size: 22px; font-weight: 700; color: #3b82f6;">${totalListStats.productContacted}</div>
                <div style="font-size: 10px; color: #3b82f6;">ì»¨íƒ</div>
              </div>
              <div style="color: #9ca3af; font-size: 12px;">â†’</div>
              <div style="text-align: center; padding: 10px 14px; background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 10px; min-width: 60px;">
                <div style="font-size: 22px; font-weight: 700; color: white;">${totalListStats.productContracted}</div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.8);">ê³„ì•½</div>
              </div>
            </div>
            <div style="margin-top: 12px; font-size: 11px; color: #6b7280;">
              ì œì•ˆë¥  ${convRate(totalListStats.productRegistered, totalListStats.productProposed)}% Â· ì»¨íƒë¥  ${convRate(totalListStats.productProposed, totalListStats.productContacted)}% Â· ê³„ì•½ë¥  ${convRate(totalListStats.productContacted, totalListStats.productContracted)}%
            </div>
          </div>
        </div>
        
        <!-- ë‹´ë‹¹ìë³„ ì„±ê³¼ í…Œì´ë¸” -->
        ${Object.keys(listUserStats).length > 0 ? `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: ${tossColors.gray50};">
                <th style="padding: 12px; text-align: left; font-weight: 600; color: ${tossColors.gray700}; border-bottom: 2px solid ${tossColors.gray200};">ë‹´ë‹¹ì</th>
                <th style="padding: 12px; text-align: center; font-weight: 600; color: ${tossColors.gray700}; border-bottom: 2px solid ${tossColors.gray200};" colspan="4">ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</th>
                <th style="padding: 12px; text-align: center; font-weight: 600; color: ${tossColors.gray700}; border-bottom: 2px solid ${tossColors.gray200};" colspan="4">ìƒí’ˆ ë¦¬ìŠ¤íŠ¸</th>
              </tr>
              <tr style="background: ${tossColors.gray50};">
                <th style="padding: 8px; text-align: left; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};"></th>
                <th style="padding: 8px; text-align: center; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};">ë“±ë¡</th>
                <th style="padding: 8px; text-align: center; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};">ì œì•ˆ</th>
                <th style="padding: 8px; text-align: center; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};">ì»¨íƒ</th>
                <th style="padding: 8px; text-align: center; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};">ê³„ì•½</th>
                <th style="padding: 8px; text-align: center; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};">ë“±ë¡</th>
                <th style="padding: 8px; text-align: center; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};">ì œì•ˆ</th>
                <th style="padding: 8px; text-align: center; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};">ì»¨íƒ</th>
                <th style="padding: 8px; text-align: center; font-weight: 500; color: ${tossColors.gray500}; border-bottom: 1px solid ${tossColors.gray200};">ê³„ì•½</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(listUserStats)
                .sort((a, b) => (b[1].sellerContracted + b[1].productContracted) - (a[1].sellerContracted + a[1].productContracted))
                .map(([email, stats]) => {
                  const userName = email === 'ë¯¸ì§€ì •' ? 'ë¯¸ì§€ì •' : email.split('@')[0];
                  return `
                    <tr style="border-bottom: 1px solid ${tossColors.gray100};">
                      <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <div style="width: 28px; height: 28px; border-radius: 50%; background: ${tossColors.blueLight}; display: flex; align-items: center; justify-content: center; font-weight: 600; color: ${tossColors.blue}; font-size: 12px;">
                            ${userName.charAt(0).toUpperCase()}
                          </div>
                          <span style="font-weight: 500;">${userName}</span>
                        </div>
                      </td>
                      <td style="padding: 12px; text-align: center;">${stats.sellerRegistered}</td>
                      <td style="padding: 12px; text-align: center; color: #22c55e; font-weight: 600;">${stats.sellerProposed}</td>
                      <td style="padding: 12px; text-align: center; color: #3b82f6; font-weight: 600;">${stats.sellerContacted}</td>
                      <td style="padding: 12px; text-align: center;">
                        ${stats.sellerContracted > 0 ? `<span style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 4px 10px; border-radius: 12px; font-weight: 700;">${stats.sellerContracted}</span>` : '-'}
                      </td>
                      <td style="padding: 12px; text-align: center;">${stats.productRegistered}</td>
                      <td style="padding: 12px; text-align: center; color: #22c55e; font-weight: 600;">${stats.productProposed}</td>
                      <td style="padding: 12px; text-align: center; color: #3b82f6; font-weight: 600;">${stats.productContacted}</td>
                      <td style="padding: 12px; text-align: center;">
                        ${stats.productContracted > 0 ? `<span style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 4px 10px; border-radius: 12px; font-weight: 700;">${stats.productContracted}</span>` : '-'}
                      </td>
                    </tr>
                  `;
                }).join('')}
            </tbody>
          </table>
        </div>
        ` : ''}
        
        <!-- ìµœê·¼ ì…ì  ê³„ì•½ -->
        ${allSellerList.filter(s => s.contracted).length > 0 ? `
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid ${tossColors.gray100};">
          <div style="font-size: 14px; font-weight: 600; color: #7c3aed; margin-bottom: 12px;">ğŸ‰ ìµœê·¼ ì…ì  ê³„ì•½</div>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            ${allSellerList.filter(s => s.contracted).slice(0, 5).map(s => `
              <div style="padding: 10px 14px; background: linear-gradient(135deg, #f5f3ff, #ede9fe); border-radius: 10px; border: 1px solid #c4b5fd;">
                <div style="font-weight: 600; color: #5b21b6; font-size: 13px;">${s.accountName}</div>
                <div style="font-size: 11px; color: #7c3aed;">${s.category || '-'}</div>
              </div>
            `).join('')}
          </div>
        </div>
        ` : ''}
      </div>
      `;
    })()}
    
    <div style="padding: 20px; background: ${tossColors.white}; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
      <div style="font-size: 14px; color: ${tossColors.gray600}; line-height: 1.6;">
        ğŸ’¡ <strong>ë°ì´í„° ì—°ë™:</strong> ê³µê¸‰ì‚¬/ì…€ëŸ¬/ê³µêµ¬ ë“±ë¡ ì‹œ ë‹´ë‹¹ìë¥¼ ë°°ì •í•˜ë©´ í•´ë‹¹ íŒ€ì›ì˜ ì‹¤ì ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. 
        ì…€ëŸ¬ ì •ì‚° ë°ì´í„°ë„ ë‹´ë‹¹ ì…€ëŸ¬ ê¸°ì¤€ìœ¼ë¡œ ì—°ë™ë©ë‹ˆë‹¤.
      </div>
    </div>
    </div>
  `;
  
  // ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™”
  setTimeout(() => initMemberDragDrop(), 100);
}

// íŒ€ì› ì¹´ë“œ ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™”
function initMemberDragDrop() {
  const container = document.getElementById('teamMembersContainer');
  if (!container) return;
  
  let draggedEl = null;
  
  container.querySelectorAll('.draggable-member').forEach(item => {
    item.addEventListener('dragstart', function(e) {
      draggedEl = this;
      this.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    });
    
    item.addEventListener('dragend', function() {
      this.style.opacity = '1';
      container.querySelectorAll('.draggable-member').forEach(el => {
        el.style.borderTop = '';
        el.style.borderBottom = '';
      });
    });
    
    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const rect = this.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      
      container.querySelectorAll('.draggable-member').forEach(el => {
        el.style.borderTop = '';
        el.style.borderBottom = '';
      });
      
      if (e.clientY < midY) {
        this.style.borderTop = '3px solid #0064FF';
      } else {
        this.style.borderBottom = '3px solid #0064FF';
      }
    });
    
    item.addEventListener('drop', function(e) {
      e.preventDefault();
      if (draggedEl === this) return;
      
      const rect = this.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      
      if (e.clientY < midY) {
        container.insertBefore(draggedEl, this);
      } else {
        container.insertBefore(draggedEl, this.nextSibling);
      }
      
      this.style.borderTop = '';
      this.style.borderBottom = '';
      
      // ìƒˆ ìˆœì„œ ì €ì¥
      saveMemberCardOrder();
    });
  });
}

// íŒ€ì› ì¹´ë“œ ìˆœì„œ ì €ì¥
function saveMemberCardOrder() {
  const container = document.getElementById('teamMembersContainer');
  if (!container) return;
  
  const order = [];
  container.querySelectorAll('.draggable-member').forEach(el => {
    const memberId = el.getAttribute('data-member-id');
    if (memberId) order.push(memberId);
  });
  
  localStorage.setItem('memberCardOrder', JSON.stringify(order));
  showToast('ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ëª©í‘œ ê³„ì‚°ê¸° ëª¨ë‹¬
function openGoalCalculator() {
  // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
  if (!isAdminUnlocked) {
    showAdminAuthThen('openGoalCalculatorReal');
    return;
  }
  openGoalCalculatorReal();
}

function openGoalCalculatorReal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“Š ëª©í‘œ ê³„ì‚°ê¸°</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- ì…ë ¥ ì„¹ì…˜ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ“ ê¸°ë³¸ ì¡°ê±´ ì…ë ¥</div>
          
          <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
            <button onclick="setCalcPreset('default')" class="calc-preset active" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: #1e40af; color: white; font-size: 12px; cursor: pointer;">ê¸°ë³¸ê°’</button>
            <button onclick="setCalcPreset('conservative')" class="calc-preset" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; color: var(--gray-600); font-size: 12px; cursor: pointer;">ë³´ìˆ˜ì </button>
            <button onclick="setCalcPreset('aggressive')" class="calc-preset" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; color: var(--gray-600); font-size: 12px; cursor: pointer;">ê³µê²©ì </button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div style="grid-column: 1 / -1;">
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">ğŸ¯ ì—°ê°„ ë§¤ì¶œ ëª©í‘œ (ì›)</label>
              <input type="number" id="calc-annualTarget" value="500000000" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">ğŸ’° ê±´ë‹¹ íŒë§¤ê°€ (ì›)</label>
              <input type="number" id="calc-pricePerItem" value="9000" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">ğŸ“ˆ ê±´ë‹¹ ìˆœë§ˆì§„ (ì›)</label>
              <input type="number" id="calc-marginPerItem" value="2000" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">ğŸ“¦ ê³µêµ¬ë‹¹ ì˜ˆìƒ íŒë§¤ëŸ‰ (ê°œ)</label>
              <input type="number" id="calc-salesPerDeal" value="300" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">âœ… ê³µêµ¬ ì„±ê³µë¥  (%)</label>
              <input type="number" id="calc-successRate" value="30" min="1" max="100" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
          </div>
        </div>
        
        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); border-radius: 12px; padding: 20px; color: white; margin-bottom: 20px;">
          <div style="font-weight: 600; margin-bottom: 16px;">ğŸ“Š ê³„ì‚° ê²°ê³¼</div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;" id="calc-monthlyDeals">52</div>
              <div style="font-size: 11px; opacity: 0.8;">ì›” í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;" id="calc-annualDeals">624</div>
              <div style="font-size: 11px; opacity: 0.8;">ì—° í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;" id="calc-weeklyDeals">13</div>
              <div style="font-size: 11px; opacity: 0.8;">ì£¼ í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 18px; font-weight: 700;" id="calc-revenuePerDeal">81ë§Œ</div>
              <div style="font-size: 11px; opacity: 0.8;">ê±´ë‹¹ ê¸°ëŒ€ë§¤ì¶œ</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 18px; font-weight: 700;" id="calc-profitPerDeal">18ë§Œ</div>
              <div style="font-size: 11px; opacity: 0.8;">ê±´ë‹¹ ê¸°ëŒ€ìˆœìµ</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 18px; font-weight: 700;" id="calc-annualRevenue">5.1ì–µì›</div>
              <div style="font-size: 11px; opacity: 0.8;">ì—°ê°„ ì˜ˆìƒë§¤ì¶œ</div>
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; font-size: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span>ê³µêµ¬ 1ê±´ ì„±ê³µ ì‹œ ë§¤ì¶œ</span>
              <span id="calc-successRevenue">270ë§Œì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span>ê³µêµ¬ 1ê±´ ì„±ê³µ ì‹œ ìˆœìµ</span>
              <span id="calc-successProfit">60ë§Œì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span>ì›”ê°„ ë§¤ì¶œ ëª©í‘œ</span>
              <span id="calc-monthlyTarget">4,167ë§Œì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span>ì—°ê°„ ì˜ˆìƒ ìˆœìµ</span>
              <span id="calc-annualProfit" style="color: #fbbf24; font-weight: 600;">1ì–µì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
              <span>ë§ˆì§„ìœ¨</span>
              <span id="calc-marginRate">22.2%</span>
            </div>
          </div>
        </div>
        
        <!-- ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ -->
        <div style="background: white; border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ”„ ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ</div>
          <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="padding: 10px; text-align: left;">ì‹œë‚˜ë¦¬ì˜¤</th>
                <th style="padding: 10px; text-align: center;">ì„±ê³µë¥ </th>
                <th style="padding: 10px; text-align: center;">ì›” ê³µêµ¬</th>
                <th style="padding: 10px; text-align: center;">ì—° ê³µêµ¬</th>
                <th style="padding: 10px; text-align: center;">ì—° ìˆœìµ</th>
              </tr>
            </thead>
            <tbody id="calc-scenarios"></tbody>
          </table>
        </div>
        
        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 10px; padding: 14px; margin-top: 16px; font-size: 12px; color: #92400e;">
          <strong>ğŸ’¡ ì°¸ê³ </strong><br>
          ì„±ê³µë¥  30% = ì§„í–‰í•œ ê³µêµ¬ ì¤‘ 30%ë§Œ ëª©í‘œ íŒë§¤ëŸ‰ ë‹¬ì„±, ë‚˜ë¨¸ì§€ 70%ëŠ” ì‹¤íŒ¨ ë˜ëŠ” ë¶€ë¶„ ë‹¬ì„±
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button class="btn btn-primary" onclick="applyCalculatedGoals()">ì´ ê°’ìœ¼ë¡œ ëª©í‘œ ì„¤ì •</button>
      </div>
    </div>
  `;
  
  calculateGoal();
}

// í”„ë¦¬ì…‹ ì„¤ì •
function setCalcPreset(type) {
  document.querySelectorAll('.calc-preset').forEach(btn => {
    btn.style.background = 'white';
    btn.style.color = 'var(--gray-600)';
  });
  event.target.style.background = '#1e40af';
  event.target.style.color = 'white';
  
  const presets = {
    default: { target: 500000000, price: 9000, margin: 2000, sales: 300, rate: 30 },
    conservative: { target: 300000000, price: 9000, margin: 2000, sales: 200, rate: 25 },
    aggressive: { target: 500000000, price: 9000, margin: 2500, sales: 400, rate: 40 }
  };
  
  if (presets[type]) {
    document.getElementById('calc-annualTarget').value = presets[type].target;
    document.getElementById('calc-pricePerItem').value = presets[type].price;
    document.getElementById('calc-marginPerItem').value = presets[type].margin;
    document.getElementById('calc-salesPerDeal').value = presets[type].sales;
    document.getElementById('calc-successRate').value = presets[type].rate;
  }
  
  calculateGoal();
}

// ëª©í‘œ ê³„ì‚°
function calculateGoal() {
  const annualTarget = Number(document.getElementById('calc-annualTarget').value) || 0;
  const pricePerItem = Number(document.getElementById('calc-pricePerItem').value) || 0;
  const marginPerItem = Number(document.getElementById('calc-marginPerItem').value) || 0;
  const salesPerDeal = Number(document.getElementById('calc-salesPerDeal').value) || 0;
  const successRate = Number(document.getElementById('calc-successRate').value) / 100 || 0;
  
  const successRevenue = pricePerItem * salesPerDeal;
  const successProfit = marginPerItem * salesPerDeal;
  const expectedRevenue = successRevenue * successRate;
  const expectedProfit = successProfit * successRate;
  
  const monthlyTarget = annualTarget / 12;
  const monthlyDeals = Math.ceil(monthlyTarget / expectedRevenue) || 0;
  const annualDeals = monthlyDeals * 12;
  const weeklyDeals = Math.ceil(monthlyDeals / 4);
  
  // ì—°ê°„ ì˜ˆìƒ ë§¤ì¶œ = ì›” ê³µêµ¬ ìˆ˜ Ã— 12 Ã— ê±´ë‹¹ ê¸°ëŒ€ë§¤ì¶œ
  const annualExpectedRevenue = monthlyDeals * 12 * expectedRevenue;
  // ì—°ê°„ ì˜ˆìƒ ìˆœìµ = ì›” ê³µêµ¬ ìˆ˜ Ã— 12 Ã— ê±´ë‹¹ ê¸°ëŒ€ìˆœìµ
  const annualExpectedProfit = monthlyDeals * 12 * expectedProfit;
  const marginRate = (marginPerItem / pricePerItem * 100).toFixed(1);
  
  // ê²°ê³¼ í‘œì‹œ
  document.getElementById('calc-monthlyDeals').textContent = monthlyDeals;
  document.getElementById('calc-annualDeals').textContent = annualDeals;
  document.getElementById('calc-weeklyDeals').textContent = weeklyDeals;
  document.getElementById('calc-revenuePerDeal').textContent = formatCalcWon(expectedRevenue);
  document.getElementById('calc-profitPerDeal').textContent = formatCalcWon(expectedProfit);
  document.getElementById('calc-annualRevenue').textContent = formatCalcWon(annualExpectedRevenue);
  document.getElementById('calc-annualProfit').textContent = formatCalcWon(annualExpectedProfit);
  
  document.getElementById('calc-successRevenue').textContent = formatCalcWon(successRevenue);
  document.getElementById('calc-successProfit').textContent = formatCalcWon(successProfit);
  document.getElementById('calc-monthlyTarget').textContent = formatCalcWon(monthlyTarget);
  document.getElementById('calc-marginRate').textContent = marginRate + '%';
  
  // ì‹œë‚˜ë¦¬ì˜¤ ë Œë”ë§
  renderCalcScenarios(pricePerItem, marginPerItem, salesPerDeal);
}

function formatCalcWon(num) {
  if (num >= 100000000) return (num / 100000000).toFixed(1) + 'ì–µì›';
  if (num >= 10000) return Math.round(num / 10000) + 'ë§Œì›';
  return formatNumber(num) + 'ì›';
}

function renderCalcScenarios(price, margin, sales) {
  const scenarios = [
    { name: '3ì–µ (í˜„ì‹¤ì )', target: 300000000, rate: 30 },
    { name: '5ì–µ (ëª©í‘œ)', target: 500000000, rate: 30 },
    { name: '5ì–µ (ì„±ê³µë¥ â†‘)', target: 500000000, rate: 40 },
  ];
  
  let html = '';
  scenarios.forEach(s => {
    const successRevenue = price * sales;
    const expectedRevenue = successRevenue * (s.rate / 100);
    const monthlyTarget = s.target / 12;
    const monthlyDeals = Math.ceil(monthlyTarget / expectedRevenue);
    const annualDeals = monthlyDeals * 12;
    const annualProfit = s.target * (margin / price);
    
    html += `<tr style="border-bottom: 1px solid var(--gray-100);">
      <td style="padding: 10px; font-weight: 600;">${s.name}</td>
      <td style="padding: 10px; text-align: center;">${s.rate}%</td>
      <td style="padding: 10px; text-align: center; color: #1e40af; font-weight: 700;">${monthlyDeals}ê±´</td>
      <td style="padding: 10px; text-align: center;">${annualDeals}ê±´</td>
      <td style="padding: 10px; text-align: center; color: #16a34a;">${formatCalcWon(annualProfit)}</td>
    </tr>`;
  });
  
  document.getElementById('calc-scenarios').innerHTML = html;
}

// ê³„ì‚° ê²°ê³¼ë¡œ ëª©í‘œ ì„¤ì • ì ìš© - ì§ì ‘ ì €ì¥
async function applyCalculatedGoals() {
  // ğŸ”’ ê´€ë¦¬ìë§Œ ê°€ëŠ¥
  if (!isAdminRole()) { showAdminOnlyPermission(); return; }
  const annualTarget = Number(document.getElementById('calc-annualTarget').value) || 0;
  const pricePerItem = Number(document.getElementById('calc-pricePerItem').value) || 0;
  const marginPerItem = Number(document.getElementById('calc-marginPerItem').value) || 0;
  const salesPerDeal = Number(document.getElementById('calc-salesPerDeal').value) || 0;
  const successRate = Number(document.getElementById('calc-successRate').value) || 0;
  
  const monthlyDeals = Number(document.getElementById('calc-monthlyDeals').textContent) || 0;
  const annualDeals = Number(document.getElementById('calc-annualDeals').textContent) || 0;
  
  // ê³„ì‚°
  const successRevenue = pricePerItem * salesPerDeal;
  const successProfit = marginPerItem * salesPerDeal;
  const expectedRevenue = successRevenue * (successRate / 100);
  const expectedProfit = successProfit * (successRate / 100);
  const annualExpectedRevenue = monthlyDeals * 12 * expectedRevenue;
  const annualExpectedProfit = monthlyDeals * 12 * expectedProfit;
  
  // ìˆœìµ ëª©í‘œ = ë§¤ì¶œëª©í‘œ Ã— ë§ˆì§„ìœ¨
  const marginRate = marginPerItem / pricePerItem;
  const annualProfit = Math.round(annualTarget * marginRate);
  
  const goals = {
    // ê¸°ì¡´ ëª©í‘œ
    deals: annualDeals,
    salesAmount: annualTarget,
    profitAmount: annualProfit,
    // ê³„ì‚° ê¸°ì¤€ ì •ë³´ (ì˜ì—… ê°€ì´ë“œ)
    calcParams: {
      pricePerItem,
      marginPerItem,
      salesPerDeal,
      successRate,
      monthlyDeals,
      expectedRevenue,
      expectedProfit,
      annualExpectedRevenue,
      annualExpectedProfit
    },
    updatedAt: new Date().toISOString()
  };
  
  try {
    // ê¸°ì¡´ ëª©í‘œì™€ ë³‘í•©
    const existingGoals = state.salesGoals || {};
    await db.collection('settings').doc('salesGoals').set({
      ...existingGoals,
      ...goals
    });
    state.salesGoals = { ...existingGoals, ...goals };
    showToast('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    closeModal();
    renderSalesDashboard();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

function openGoalSettingModal() {
  // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
  if (!isAdminUnlocked) {
    showAdminAuthThen('openGoalSettingModalReal');
    return;
  }
  openGoalSettingModalReal();
}

function openGoalSettingModalReal() {
  const goals = state.salesGoals || {};
  const members = state.teamMembers || [];
  const memberGoals = state.memberGoals || {};
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ¯ ëª©í‘œ ì„¤ì •</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- íƒ­ -->
        <div style="display: flex; gap: 4px; margin-bottom: 20px; background: var(--gray-100); padding: 4px; border-radius: 10px;">
          <button onclick="switchGoalTab('team')" id="goalTab-team" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--primary); color: white; cursor: pointer;">
            íŒ€ ëª©í‘œ
          </button>
          <button onclick="switchGoalTab('member')" id="goalTab-member" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            íŒ€ì›ë³„ ëª©í‘œ
          </button>
        </div>
        
        <!-- íŒ€ ëª©í‘œ -->
        <div id="goalContent-team">
          <div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
            <div style="font-size: 13px; color: #1e40af;">íŒ€ ì „ì²´ì˜ ëª©í‘œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œ ìƒë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label class="form-label">ê³µê¸‰ì‚¬ ì…ì </label>
              <input type="number" class="form-input" id="goal-suppliers" value="${goals.suppliers || ''}" placeholder="ì˜ˆ: 50">
            </div>
            <div class="form-group">
              <label class="form-label">ì…€ëŸ¬ ì…ì </label>
              <input type="number" class="form-input" id="goal-sellers" value="${goals.sellers || ''}" placeholder="ì˜ˆ: 100">
            </div>
            <div class="form-group">
              <label class="form-label">ê³µêµ¬ ë“±ë¡</label>
              <input type="number" class="form-input" id="goal-deals" value="${goals.deals || ''}" placeholder="ì˜ˆ: 200">
            </div>
            <div class="form-group">
              <label class="form-label">íŒë§¤ ê±´ìˆ˜</label>
              <input type="number" class="form-input" id="goal-salesCount" value="${goals.salesCount || ''}" placeholder="ì˜ˆ: 500">
            </div>
            <div class="form-group">
              <label class="form-label">ë§¤ì¶œê¸ˆì•¡ (ì›)</label>
              <input type="number" class="form-input" id="goal-salesAmount" value="${goals.salesAmount || ''}" placeholder="ì˜ˆ: 100000000">
            </div>
            <div class="form-group">
              <label class="form-label">ìˆœìˆ˜ìµ (ì›)</label>
              <input type="number" class="form-input" id="goal-profitAmount" value="${goals.profitAmount || ''}" placeholder="ì˜ˆ: 10000000">
            </div>
          </div>
          
          <div style="margin-top: 20px; text-align: right;">
            <button class="btn btn-primary" onclick="saveSalesGoals()">íŒ€ ëª©í‘œ ì €ì¥</button>
          </div>
        </div>
        
        <!-- íŒ€ì›ë³„ ëª©í‘œ -->
        <div id="goalContent-member" style="display: none;">
          <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
            <div style="font-size: 13px; color: #92400e;">ê° íŒ€ì›ì˜ ê°œì¸ ëª©í‘œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</div>
          </div>
          
          ${members.length === 0 ? `
            <div style="text-align: center; padding: 40px; color: var(--gray-500);">
              íŒ€ì›ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
            </div>
          ` : members.map(member => {
            const mGoal = memberGoals[member.id] || {};
            return `
            <div style="border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(145deg, #fc9600, #e08600); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                  ${member.name.charAt(0)}
                </div>
                <div>
                  <div style="font-weight: 600;">${member.name}</div>
                  <div style="font-size: 12px; color: var(--gray-500);">${member.role === 'admin' ? 'ê´€ë¦¬ì' : member.role === 'manager' ? 'ë§¤ë‹ˆì €' : member.role === 'guest' ? 'ê²ŒìŠ¤íŠ¸' : 'ì¼ë°˜'}</div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ê³µê¸‰ì‚¬</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-suppliers" value="${mGoal.suppliers || ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ì…€ëŸ¬</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-sellers" value="${mGoal.sellers || ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ê³µêµ¬</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-deals" value="${mGoal.deals || ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">íŒë§¤ê±´ìˆ˜</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-salesCount" value="${mGoal.salesCount || ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ë§¤ì¶œ(ë§Œì›)</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-salesAmount" value="${mGoal.salesAmount ? mGoal.salesAmount / 10000 : ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ìˆœìˆ˜ìµ(ë§Œì›)</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-profitAmount" value="${mGoal.profitAmount ? mGoal.profitAmount / 10000 : ''}" placeholder="0" style="padding: 8px;">
                </div>
              </div>
            </div>
          `}).join('')}
          
          ${members.length > 0 ? `
            <div style="margin-top: 20px; text-align: right;">
              <button class="btn btn-primary" onclick="saveMemberGoals()">íŒ€ì›ë³„ ëª©í‘œ ì €ì¥</button>
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

// ëª©í‘œ íƒ­ ì „í™˜
function switchGoalTab(tab) {
  ['team', 'member'].forEach(t => {
    const btn = document.getElementById('goalTab-' + t);
    const content = document.getElementById('goalContent-' + t);
    if (btn && content) {
      if (t === tab) {
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        content.style.display = 'block';
      } else {
        btn.style.background = 'transparent';
        btn.style.color = 'var(--gray-500)';
        content.style.display = 'none';
      }
    }
  });
}

// ê´€ë¦¬ì ì¸ì¦ í›„ í•¨ìˆ˜ ì‹¤í–‰
function showAdminAuthThen(callbackFn) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ” ê´€ë¦¬ì ì¸ì¦</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="background: var(--gray-100); border-radius: 8px; padding: 12px; margin: 20px;">
        <p style="color: var(--gray-600); font-size: 13px; margin: 0;">ì´ ê¸°ëŠ¥ì€ ê´€ë¦¬ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
      </div>
      <form onsubmit="checkAdminPasswordThen(event, '${callbackFn}')">
        <div style="padding: 0 20px;">
          <div class="form-group">
            <label class="form-label">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" class="form-input" id="admin-auth-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required autofocus>
          </div>
          <div id="admin-auth-error" style="color: var(--danger); font-size: 14px; margin-bottom: 12px; display: none;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">í™•ì¸</button>
        </div>
      </form>
    </div>
  `;
}

function checkAdminPasswordThen(e, callbackFn) {
  e.preventDefault();
  const password = document.getElementById('admin-auth-password').value;
  
  if (password === ADMIN_PASSWORD) {
    isAdminUnlocked = true;
    sessionStorage.setItem('adminUnlocked', 'true');
    closeModal();
    
    // ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
    if (callbackFn === 'openGoalSettingModalReal') {
      setTimeout(() => openGoalSettingModalReal(), 100);
    } else if (callbackFn === 'openAssignManagerModalReal') {
      setTimeout(() => openAssignManagerModalReal(), 100);
    } else if (callbackFn === 'openGoalCalculatorReal') {
      setTimeout(() => openGoalCalculatorReal(), 100);
    }
  } else {
    document.getElementById('admin-auth-error').style.display = 'block';
    document.getElementById('admin-auth-password').value = '';
    document.getElementById('admin-auth-password').focus();
  }
}

// ëª©í‘œ ì €ì¥
async function saveSalesGoals() {
  // ğŸ”’ ê´€ë¦¬ìë§Œ ê°€ëŠ¥
  if (!isAdminRole()) { showAdminOnlyPermission(); return; }
  const goals = {
    suppliers: parseInt(document.getElementById('goal-suppliers').value) || 0,
    sellers: parseInt(document.getElementById('goal-sellers').value) || 0,
    deals: parseInt(document.getElementById('goal-deals').value) || 0,
    salesCount: parseInt(document.getElementById('goal-salesCount').value) || 0,
    salesAmount: parseInt(document.getElementById('goal-salesAmount').value) || 0,
    profitAmount: parseInt(document.getElementById('goal-profitAmount').value) || 0,
    updatedAt: new Date().toISOString()
  };
  
  try {
    await db.collection('settings').doc('salesGoals').set(goals);
    state.salesGoals = goals;
    showToast('íŒ€ ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    renderSalesDashboard();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// íŒ€ì›ë³„ ëª©í‘œ ì €ì¥
async function saveMemberGoals() {
  // ğŸ”’ ê´€ë¦¬ìë§Œ ê°€ëŠ¥
  if (!isAdminRole()) { showAdminOnlyPermission(); return; }
  const members = state.teamMembers || [];
  const memberGoals = {};
  
  members.forEach(member => {
    memberGoals[member.id] = {
      suppliers: parseInt(document.getElementById(`mgoal-${member.id}-suppliers`)?.value) || 0,
      sellers: parseInt(document.getElementById(`mgoal-${member.id}-sellers`)?.value) || 0,
      deals: parseInt(document.getElementById(`mgoal-${member.id}-deals`)?.value) || 0,
      salesCount: parseInt(document.getElementById(`mgoal-${member.id}-salesCount`)?.value) || 0,
      salesAmount: (parseInt(document.getElementById(`mgoal-${member.id}-salesAmount`)?.value) || 0) * 10000,
      profitAmount: (parseInt(document.getElementById(`mgoal-${member.id}-profitAmount`)?.value) || 0) * 10000
    };
  });
  
  try {
    await db.collection('settings').doc('memberGoals').set({
      goals: memberGoals,
      updatedAt: new Date().toISOString()
    });
    state.memberGoals = memberGoals;
    showToast('íŒ€ì›ë³„ ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    renderSalesDashboard();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ë‹´ë‹¹ì ë°°ì •/ìˆ˜ì • ëª¨ë‹¬
// ë‹´ë‹¹ì ë°°ì • í™•ì¸ (ë³´ê¸° ì „ìš©)
function viewAssignmentStatus() {
  const members = state.teamMembers || [];
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ ë‹´ë‹¹ì ë°°ì •í˜„í™©</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- íƒ­ -->
        <div style="display: flex; gap: 4px; margin-bottom: 20px; background: var(--gray-100); padding: 4px; border-radius: 10px;">
          <button onclick="switchViewAssignTab('suppliers')" id="viewAssignTab-suppliers" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--primary); color: white; cursor: pointer;">
            ê³µê¸‰ì‚¬ (${state.suppliers.length})
          </button>
          <button onclick="switchViewAssignTab('sellers')" id="viewAssignTab-sellers" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            ì…€ëŸ¬ (${state.sellers.length})
          </button>
          <button onclick="switchViewAssignTab('deals')" id="viewAssignTab-deals" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            ê³µêµ¬ (${state.deals.length})
          </button>
        </div>
        
        <!-- ê³µê¸‰ì‚¬ íƒ­ -->
        <div id="viewAssignContent-suppliers">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬ëª…</th>
                <th>ë“±ë¡ì¼</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.suppliers.map(s => {
                const manager = members.find(m => m.id === s.registeredBy);
                return `
                <tr>
                  <td style="font-weight: 500;">${s.name}</td>
                  <td style="color: var(--gray-500);">${formatDate(s.createdAt)}</td>
                  <td>
                    <span style="padding: 6px 12px; border-radius: 6px; font-size: 12px; background: ${s.registeredBy ? 'var(--gray-100)' : '#fef2f2'}; color: ${s.registeredBy ? 'var(--gray-700)' : '#dc2626'};">
                      ${manager ? manager.name : 'ë¯¸ë°°ì •'}
                    </span>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- ì…€ëŸ¬ íƒ­ -->
        <div id="viewAssignContent-sellers" style="display: none;">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ì…€ëŸ¬ëª…</th>
                <th>ë“±ë¡ì¼</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.sellers.map(s => {
                const manager = members.find(m => m.id === s.registeredBy);
                return `
                <tr>
                  <td style="font-weight: 500;">${s.name?.split('/')[0] || s.name}</td>
                  <td style="color: var(--gray-500);">${formatDate(s.createdAt)}</td>
                  <td>
                    <span style="padding: 6px 12px; border-radius: 6px; font-size: 12px; background: ${s.registeredBy ? 'var(--gray-100)' : '#fef2f2'}; color: ${s.registeredBy ? 'var(--gray-700)' : '#dc2626'};">
                      ${manager ? manager.name : 'ë¯¸ë°°ì •'}
                    </span>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- ê³µêµ¬ íƒ­ -->
        <div id="viewAssignContent-deals" style="display: none;">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ê³µêµ¬ëª…</th>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ê¸°ê°„</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.deals.map(d => {
                const supplier = state.suppliers.find(s => s.id === d.supplierId);
                const manager = members.find(m => m.id === d.registeredBy);
                return `
                <tr>
                  <td style="font-weight: 500;">${d.title || '-'}</td>
                  <td>${supplier?.name || '-'}</td>
                  <td style="font-size: 11px; color: var(--gray-500);">${d.startDate || ''} ~ ${d.endDate || ''}</td>
                  <td>
                    <span style="padding: 6px 12px; border-radius: 6px; font-size: 12px; background: ${d.registeredBy ? 'var(--gray-100)' : '#fef2f2'}; color: ${d.registeredBy ? 'var(--gray-700)' : '#dc2626'};">
                      ${manager ? manager.name : 'ë¯¸ë°°ì •'}
                    </span>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// ë°°ì •í™•ì¸ íƒ­ ì „í™˜
function switchViewAssignTab(tab) {
  ['suppliers', 'sellers', 'deals'].forEach(t => {
    const btn = document.getElementById('viewAssignTab-' + t);
    const content = document.getElementById('viewAssignContent-' + t);
    if (btn && content) {
      if (t === tab) {
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        content.style.display = 'block';
      } else {
        btn.style.background = 'transparent';
        btn.style.color = 'var(--gray-500)';
        content.style.display = 'none';
      }
    }
  });
}

function openAssignManagerModal() {
  // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
  if (!isAdminUnlocked) {
    showAdminAuthThen('openAssignManagerModalReal');
    return;
  }
  openAssignManagerModalReal();
}

function openAssignManagerModalReal() {
  const members = state.teamMembers || [];
  
  if (members.length === 0) {
    showToast('ë¨¼ì € íŒ€ì›ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
    switchTab('teamMembers');
    return;
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">âœï¸ ë‹´ë‹¹ì ë°°ì •/ìˆ˜ì •</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- íƒ­ -->
        <div style="display: flex; gap: 4px; margin-bottom: 20px; background: var(--gray-100); padding: 4px; border-radius: 10px;">
          <button onclick="switchAssignTab('suppliers')" id="assignTab-suppliers" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--primary); color: white; cursor: pointer;">
            ğŸ­ ê³µê¸‰ì‚¬ (${state.suppliers.length})
          </button>
          <button onclick="switchAssignTab('sellers')" id="assignTab-sellers" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            ğŸ‘¤ ì…€ëŸ¬ (${state.sellers.length})
          </button>
          <button onclick="switchAssignTab('deals')" id="assignTab-deals" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            ğŸ“¦ ê³µêµ¬ (${state.deals.length})
          </button>
        </div>
        
        <!-- ê³µê¸‰ì‚¬ íƒ­ -->
        <div id="assignContent-suppliers">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬ëª…</th>
                <th>ë“±ë¡ì¼</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.suppliers.map(s => `
                <tr>
                  <td style="font-weight: 500;">${s.name}</td>
                  <td style="color: var(--gray-500);">${formatDate(s.createdAt)}</td>
                  <td>
                    <select onchange="updateRegisteredBy('suppliers', '${s.id}', this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid ${s.registeredBy ? 'var(--gray-200)' : '#fecaca'}; border-radius: 6px; font-size: 12px; background: ${s.registeredBy ? 'white' : '#fef2f2'};">
                      <option value="">ë¯¸ë°°ì •</option>
                      ${members.map(m => `<option value="${m.id}" ${s.registeredBy === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                    </select>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- ì…€ëŸ¬ íƒ­ -->
        <div id="assignContent-sellers" style="display: none;">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ì…€ëŸ¬ëª…</th>
                <th>ë“±ë¡ì¼</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.sellers.map(s => `
                <tr>
                  <td style="font-weight: 500;">${s.name?.split('/')[0] || s.name}</td>
                  <td style="color: var(--gray-500);">${formatDate(s.createdAt)}</td>
                  <td>
                    <select onchange="updateRegisteredBy('sellers', '${s.id}', this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid ${s.registeredBy ? 'var(--gray-200)' : '#fecaca'}; border-radius: 6px; font-size: 12px; background: ${s.registeredBy ? 'white' : '#fef2f2'};">
                      <option value="">ë¯¸ë°°ì •</option>
                      ${members.map(m => `<option value="${m.id}" ${s.registeredBy === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                    </select>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- ê³µêµ¬ íƒ­ -->
        <div id="assignContent-deals" style="display: none;">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ê³µêµ¬ëª…</th>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ê¸°ê°„</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.deals.map(d => {
                const supplier = state.suppliers.find(s => s.id === d.supplierId);
                return `
                <tr>
                  <td style="font-weight: 500;">${d.title || '-'}</td>
                  <td>${supplier?.name || '-'}</td>
                  <td style="color: var(--gray-500); font-size: 12px;">${d.startDate || '-'}</td>
                  <td>
                    <select onchange="updateRegisteredBy('deals', '${d.id}', this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid ${d.registeredBy ? 'var(--gray-200)' : '#fecaca'}; border-radius: 6px; font-size: 12px; background: ${d.registeredBy ? 'white' : '#fef2f2'};">
                      <option value="">ë¯¸ë°°ì •</option>
                      ${members.map(m => `<option value="${m.id}" ${d.registeredBy === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                    </select>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
      </div>
      <div style="padding: 16px 20px; background: var(--gray-50); border-top: 1px solid var(--gray-200); text-align: right;">
        <button onclick="closeModal()" class="btn btn-primary">ì™„ë£Œ</button>
      </div>
    </div>
  `;
}

// ë‹´ë‹¹ì ë°°ì • íƒ­ ì „í™˜
function switchAssignTab(tab) {
  ['suppliers', 'sellers', 'deals'].forEach(t => {
    const tabBtn = document.getElementById('assignTab-' + t);
    const content = document.getElementById('assignContent-' + t);
    if (t === tab) {
      tabBtn.style.background = 'var(--primary)';
      tabBtn.style.color = 'white';
      content.style.display = 'block';
    } else {
      tabBtn.style.background = 'transparent';
      tabBtn.style.color = 'var(--gray-500)';
      content.style.display = 'none';
    }
  });
}

// ë‹´ë‹¹ì ì—…ë°ì´íŠ¸
async function updateRegisteredBy(collection, docId, memberId) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  try {
    await db.collection(collection).doc(docId).update({
      registeredBy: memberId || null,
      registeredByUpdatedAt: new Date().toISOString()
    });
    showToast('ë‹´ë‹¹ìê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (err) {
    console.error(err);
    showToast('ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ë°ì´í„° ì‚¬ìš©ëŸ‰ ====================
async function renderDataUsage() {
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ’¾ ë°ì´í„° ì‚¬ìš©ëŸ‰</h1>
      <p style="color: var(--gray-500); margin-top: 4px;">Firebase Firestore ë°ì´í„° ì‚¬ìš© í˜„í™©ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
    </div>
    
    <div style="text-align: center; padding: 40px;">
      <div style="font-size: 48px; margin-bottom: 16px;">â³</div>
      <p style="color: var(--gray-500);">ë°ì´í„° ì‚¬ìš©ëŸ‰ì„ ì¡°íšŒí•˜ëŠ” ì¤‘...</p>
    </div>
  `;
  
  // ë°ì´í„° ìˆ˜ ê³„ì‚°
  try {
    const collections = [
      { name: 'deals', label: 'ê³µêµ¬', icon: 'ğŸ“¦' },
      { name: 'suppliers', label: 'ê³µê¸‰ì‚¬', icon: 'ğŸ­' },
      { name: 'sellers', label: 'ì…€ëŸ¬', icon: 'ğŸ‘¤' },
      { name: 'products', label: 'ìƒí’ˆ', icon: 'ğŸ›ï¸' },
      { name: 'sellerSettlements', label: 'ì…€ëŸ¬ ì •ì‚°', icon: 'ğŸ’°' },
      { name: 'supplierSettlements', label: 'ê³µê¸‰ì‚¬ ì •ì‚°', icon: 'ğŸ’µ' },
      { name: 'dealSuggestions', label: 'ê³µêµ¬ ì œì•ˆ', icon: 'ğŸ’¡' },
      { name: 'adminProposals', label: 'ì–´ë“œë¯¼ ì œì•ˆ', icon: 'ğŸ“¨' },
      { name: 'partnerMessages', label: 'íŒŒíŠ¸ë„ˆ ë©”ì‹œì§€', icon: 'ğŸ’¬' },
      { name: 'partnerNotices', label: 'ê³µì§€ì‚¬í•­', icon: 'ğŸ“¢' },
      { name: 'teamMembers', label: 'íŒ€ì›', icon: 'ğŸ‘¥' },
      { name: 'partnerAccounts', label: 'íŒŒíŠ¸ë„ˆ ê³„ì •', icon: 'ğŸ”' }
    ];
    
    const stats = [];
    let totalDocs = 0;
    
    for (const col of collections) {
      try {
        const snapshot = await db.collection(col.name).get();
        const count = snapshot.size;
        totalDocs += count;
        stats.push({ ...col, count });
      } catch (e) {
        stats.push({ ...col, count: 0, error: true });
      }
    }
    
    // ìš©ëŸ‰ ê³„ì‚° (ë¬¸ì„œë‹¹ ì•½ 1KB ê°€ì •)
    const estimatedSizeKB = totalDocs * 1; // KB
    const estimatedSizeMB = (estimatedSizeKB / 1024).toFixed(3); // MB (ì†Œìˆ˜ì  3ìë¦¬)
    const freeLimitMB = 1024; // 1GB = 1024MB
    const remainingMB = (freeLimitMB - estimatedSizeKB / 1024).toFixed(2);
    const usagePercent = ((estimatedSizeKB / 1024 / freeLimitMB) * 100).toFixed(4); // ì†Œìˆ˜ì  4ìë¦¬ê¹Œì§€
    
    // ë‚¨ì€ ë¬¸ì„œ ìˆ˜ (1GB = ì•½ 100ë§Œ ë¬¸ì„œ ê°€ì •)
    const maxDocs = 1000000;
    const remainingDocs = maxDocs - totalDocs;
    
    app.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">ğŸ’¾ ë°ì´í„° ì‚¬ìš©ëŸ‰</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">Firebase Firestore ë°ì´í„° ì‚¬ìš© í˜„í™©ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
      </div>
      
      <!-- ì „ì²´ ìš”ì•½ -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
        <div style="padding: 20px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 14px; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${totalDocs.toLocaleString()}</div>
          <div style="font-size: 13px; color: var(--gray-600);">ì´ ë¬¸ì„œ ìˆ˜</div>
        </div>
        <div style="padding: 20px; background: var(--gray-50); border-radius: 14px;">
          <div style="font-size: 28px; font-weight: 700; color: var(--gray-700);">${estimatedSizeKB < 1024 ? estimatedSizeKB + ' KB' : estimatedSizeMB + ' MB'}</div>
          <div style="font-size: 13px; color: var(--gray-600);">ì¶”ì • ìš©ëŸ‰</div>
        </div>
        <div style="padding: 20px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 14px; border: 1px solid #86efac;">
          <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${remainingMB} MB</div>
          <div style="font-size: 13px; color: var(--gray-600);">ë‚¨ì€ ìš©ëŸ‰</div>
        </div>
        <div style="padding: 20px; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); border-radius: 14px; border: 1px solid #7dd3fc;">
          <div style="font-size: 28px; font-weight: 700; color: var(--info);">${usagePercent}%</div>
          <div style="font-size: 13px; color: var(--gray-600);">ì‚¬ìš©ë¥ </div>
        </div>
      </div>
      
      <!-- ì‚¬ìš©ëŸ‰ í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
      <div style="padding: 20px; background: white; border-radius: 14px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="font-weight: 600;">ë¬´ë£Œ í•œë„ ì‚¬ìš©ëŸ‰</span>
          <span style="font-size: 14px; color: var(--gray-600);">${estimatedSizeMB} MB / 1,024 MB (1GB)</span>
        </div>
        <div style="height: 20px; background: var(--gray-200); border-radius: 10px; overflow: hidden;">
          <div style="height: 100%; width: ${Math.min(parseFloat(usagePercent), 100)}%; background: linear-gradient(90deg, #22c55e, #16a34a); border-radius: 10px; transition: width 0.3s;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--gray-500);">
          <span>í˜„ì¬ ì‚¬ìš©: ${usagePercent}%</span>
          <span>ë‚¨ì€ ë¬¸ì„œ ê°€ëŠ¥: ì•½ ${remainingDocs.toLocaleString()}ê°œ</span>
        </div>
      </div>
      
      <!-- ë¬´ë£Œ í•œë„ ë° ì´ˆê³¼ ë¹„ìš© ì•ˆë‚´ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
        <div style="padding: 20px; background: #e0f2fe; border-radius: 12px;">
          <div style="font-weight: 600; color: var(--info); margin-bottom: 12px;">ğŸ“Œ Firebase ë¬´ë£Œ í•œë„ (Spark Plan)</div>
          <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8;">
            <div>â€¢ ì €ì¥ì†Œ: <strong>1GB</strong></div>
            <div>â€¢ ì½ê¸°: <strong>50,000ê±´/ì¼</strong></div>
            <div>â€¢ ì“°ê¸°: <strong>20,000ê±´/ì¼</strong></div>
            <div>â€¢ ì‚­ì œ: <strong>20,000ê±´/ì¼</strong></div>
          </div>
        </div>
        <div style="padding: 20px; background: #fef2f2; border-radius: 12px;">
          <div style="font-weight: 600; color: #dc2626; margin-bottom: 12px;">ğŸ’¸ ë¬´ë£Œ í•œë„ ì´ˆê³¼ ì‹œ ìš”ê¸ˆ (Blaze Plan)</div>
          <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8;">
            <div>â€¢ ì €ì¥ì†Œ: <strong>$0.18 / GBÂ·ì›”</strong></div>
            <div>â€¢ ì½ê¸°: <strong>$0.06 / 10ë§Œê±´</strong></div>
            <div>â€¢ ì“°ê¸°: <strong>$0.18 / 10ë§Œê±´</strong></div>
            <div>â€¢ ì‚­ì œ: <strong>$0.02 / 10ë§Œê±´</strong></div>
          </div>
          <div style="margin-top: 12px; padding: 10px; background: #fee2e2; border-radius: 8px; font-size: 12px; color: #991b1b;">
            ğŸ’¡ ì˜ˆì‹œ: 2GB ì‚¬ìš© ì‹œ ì•½ $0.18/ì›”, ì½ê¸° 100ë§Œê±´ ì‹œ ì•½ $0.60 ì¶”ê°€
          </div>
        </div>
      </div>
      
      <!-- ì»¬ë ‰ì…˜ë³„ ìƒì„¸ -->
      <div class="card">
        <h3 style="margin-bottom: 20px;">ğŸ“‚ ì»¬ë ‰ì…˜ë³„ ë¬¸ì„œ ìˆ˜</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          ${stats.map(s => `
            <div style="padding: 16px; background: ${s.count > 100 ? 'linear-gradient(145deg, #fff8f0, #fffbeb)' : 'var(--gray-50)'}; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;">${s.icon}</span>
                <div>
                  <div style="font-weight: 600; font-size: 14px;">${s.label}</div>
                  <div style="font-size: 11px; color: var(--gray-400);">${s.name}</div>
                </div>
              </div>
              <div style="font-size: 20px; font-weight: 700; color: ${s.count > 100 ? 'var(--primary)' : 'var(--gray-600)'};">
                ${s.error ? '-' : s.count.toLocaleString()}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <!-- ê´€ë¦¬ íŒ -->
      <div style="margin-top: 20px; padding: 20px; background: #fffbeb; border-radius: 12px; border: 1px solid rgba(252,150,0,0.2);">
        <div style="font-weight: 600; color: var(--primary); margin-bottom: 12px;">ğŸ’¡ ë°ì´í„° ê´€ë¦¬ íŒ</div>
        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--gray-600); line-height: 1.8;">
          <li>ì •ê¸°ì ìœ¼ë¡œ "ë°ì´í„° ë°±ì—…"ì„ ì‹¤í–‰í•˜ì—¬ ì¤‘ìš” ë°ì´í„°ë¥¼ ë³´ê´€í•˜ì„¸ìš”.</li>
          <li>ì˜¤ë˜ëœ ë©”ì‹œì§€ë‚˜ ì™„ë£Œëœ ê³µêµ¬ëŠ” ì •ë¦¬í•˜ì—¬ ìš©ëŸ‰ì„ í™•ë³´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>í˜„ì¬ ì‚¬ìš©ëŸ‰(${usagePercent}%)ì´ ë§¤ìš° ë‚®ì•„ ë¬´ë£Œ í•œë„ ë‚´ì—ì„œ ì¶©ë¶„íˆ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
          <li>ì •í™•í•œ ì‚¬ìš©ëŸ‰ì€ <a href="https://console.firebase.google.com" target="_blank" style="color: var(--info);">Firebase Console</a>ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</li>
        </ul>
      </div>
      
      <!-- ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ -->
      <div style="margin-top: 20px; padding: 20px; background: #f0f9ff; border-radius: 12px; border: 1px solid #bae6fd;">
        <div style="font-weight: 600; color: var(--info); margin-bottom: 12px;">ğŸ”§ ë°ì´í„° ì—°ë™ ë„êµ¬</div>
        <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">
          íŒŒíŠ¸ë„ˆí¬í„¸ì—ì„œ ì •ì‚° ë°ì´í„°ê°€ ì•ˆ ë³´ì´ëŠ” ê²½ìš°, ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê¸°ì¡´ ì •ì‚° ë°ì´í„°ì— ì—°ë™ IDë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
        </p>
        <button onclick="migrateSettlementIds()" class="btn btn-secondary" style="background: var(--info); color: white; border: none;">
          ğŸ”„ ì •ì‚° ë°ì´í„° ID ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
        </button>
      </div>
    `;
  } catch (err) {
    console.error(err);
    app.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">ğŸ’¾ ë°ì´í„° ì‚¬ìš©ëŸ‰</h1>
      </div>
      <div class="card" style="text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
        <p style="color: var(--gray-500);">ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
        <p style="font-size: 13px; color: var(--gray-400); margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°°ì§€ ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(updateInquiryBadge, 500);
});

// ==================== ì •ì‚° ë°ì´í„° ID ë§ˆì´ê·¸ë ˆì´ì…˜ ====================
// ê¸°ì¡´ ì •ì‚° ë°ì´í„°ì— supplierId, sellerIdê°€ ì—†ëŠ” ê²½ìš° ì¶”ê°€
async function migrateSettlementIds() {
  if (!confirm('ê¸°ì¡´ ì •ì‚° ë°ì´í„°ì— supplierId, sellerIdë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  let updatedCount = 0;
  const batch = db.batch();
  
  try {
    // sellerSettlements ë§ˆì´ê·¸ë ˆì´ì…˜
    const sellerSettlementsSnapshot = await db.collection('sellerSettlements').get();
    sellerSettlementsSnapshot.docs.forEach(doc => {
      const data = doc.data();
      const updates = {};
      
      // sellerIdê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!data.sellerId && data.sellerName) {
        const matchedSeller = state.sellers.find(s => s.name === data.sellerName);
        if (matchedSeller) {
          updates.sellerId = matchedSeller.id;
        }
      }
      
      // supplierIdê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!data.supplierId && data.brandName) {
        const matchedSupplier = state.suppliers.find(s => s.name === data.brandName);
        if (matchedSupplier) {
          updates.supplierId = matchedSupplier.id;
        }
      }
      
      if (Object.keys(updates).length > 0) {
        batch.update(doc.ref, updates);
        updatedCount++;
      }
    });
    
    // supplierSettlements ë§ˆì´ê·¸ë ˆì´ì…˜
    const supplierSettlementsSnapshot = await db.collection('supplierSettlements').get();
    supplierSettlementsSnapshot.docs.forEach(doc => {
      const data = doc.data();
      const updates = {};
      
      // supplierIdê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!data.supplierId && data.brandName) {
        const matchedSupplier = state.suppliers.find(s => s.name === data.brandName);
        if (matchedSupplier) {
          updates.supplierId = matchedSupplier.id;
        }
      }
      
      // sellerIdê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!data.sellerId && data.sellerName) {
        const matchedSeller = state.sellers.find(s => s.name === data.sellerName);
        if (matchedSeller) {
          updates.sellerId = matchedSeller.id;
        }
      }
      
      if (Object.keys(updates).length > 0) {
        batch.update(doc.ref, updates);
        updatedCount++;
      }
    });
    
    await batch.commit();
    showToast(`âœ… ${updatedCount}ê±´ì˜ ì •ì‚° ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    
  } catch (err) {
    console.error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', err);
    showToast('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ì¹´í˜24 ë©”ë‰´ í† ê¸€ ====================
function toggleCafe24Menu() {
  const submenu = document.getElementById('cafe24-submenu');
  const arrow = document.getElementById('cafe24-menu-arrow');
  if (submenu.style.display === 'none') {
    submenu.style.display = 'block';
    arrow.style.transform = 'rotate(180deg)';
  } else {
    submenu.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  }
}

function toggleOKRMenu() {
  const submenu = document.getElementById('okr-submenu');
  const arrow = document.getElementById('okr-menu-arrow');
  if (submenu.style.display === 'none') {
    submenu.style.display = 'block';
    arrow.style.transform = 'rotate(180deg)';
  } else {
    submenu.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  }
}

// ==================== ì¹´í˜24 API ì„¤ì • ====================
const CAFE24_CONFIG = {
  clientId: 'Ag6Iw2O9NNFqjAb7037UOD',
  clientSecret: 'eeolPKxRyk0jWeRJOSeL9J',
  redirectUri: 'https://partner-moyeoradeal.kr/admin/', // ì¹´í˜24 ê°œë°œìì„¼í„°ì— ë“±ë¡ëœ URIì™€ ì •í™•íˆ ì¼ì¹˜
  scope: 'mall.read_order,mall.read_product,mall.read_customer',
  // Cloud Run í”„ë¡ì‹œ URL (CORS ìš°íšŒìš©)
  tokenProxyUrl: 'https://cafe24oauthtoken-751113514390.asia-northeast3.run.app'
};

// ì¹´í˜24 API í”„ë¡ì‹œ í˜¸ì¶œ í•¨ìˆ˜ (CORS ìš°íšŒ)
async function callCafe24Api(mallId, accessToken, apiEndpoint) {
  console.log('API í˜¸ì¶œ:', { mallId, apiEndpoint });

  const response = await fetch(CAFE24_CONFIG.tokenProxyUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      mallId: mallId,
      accessToken: accessToken,
      apiEndpoint: apiEndpoint
    })
  });

  const data = await response.json();
  console.log('API ì‘ë‹µ:', response.status, data);

  if (!response.ok) {
    // ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ì¶œ (ê°ì²´ì¸ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜)
    let errorMsg = data.error_description || data.error || data.message;
    if (typeof errorMsg === 'object') {
      errorMsg = JSON.stringify(errorMsg);
    }
    const error = new Error(errorMsg || `API ì˜¤ë¥˜: ${response.status}`);
    error.status = response.status;
    error.data = data;
    throw error;
  }

  return data;
}

// ==================== ì¹´í˜24 OAuth ì¸ì¦ ====================

// CSRF í† í° ìƒì„± ë° ì €ì¥
function generateCsrfToken() {
  const token = crypto.randomUUID ? crypto.randomUUID() :
    Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
  sessionStorage.setItem('cafe24_csrf_token', token);
  return token;
}

// OAuth ì¸ì¦ ì‹œì‘ - ì¹´í˜24 ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
function startCafe24OAuth() {
  const mallId = document.getElementById('cafe24MallId')?.value?.trim();

  if (!mallId) {
    alert('ë¨¼ì € Mall IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: moyeora02');
    return;
  }

  // Mall ID ì €ì¥ (ì½œë°± ì‹œ ì‚¬ìš©)
  sessionStorage.setItem('cafe24_mall_id', mallId);

  // CSRF í† í° ìƒì„±
  const state = generateCsrfToken();

  // OAuth ì¸ì¦ URL ìƒì„±
  const authUrl = new URL(`https://${mallId}.cafe24api.com/api/v2/oauth/authorize`);
  authUrl.searchParams.set('response_type', 'code');
  authUrl.searchParams.set('client_id', CAFE24_CONFIG.clientId);
  authUrl.searchParams.set('state', state);
  authUrl.searchParams.set('redirect_uri', CAFE24_CONFIG.redirectUri);
  authUrl.searchParams.set('scope', CAFE24_CONFIG.scope);

  console.log('ğŸ” ì¹´í˜24 OAuth ì¸ì¦ ì‹œì‘:', authUrl.toString());

  // ì¹´í˜24 ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  window.location.href = authUrl.toString();
}

// OAuth ì½œë°± ì²˜ë¦¬ - authorization codeë¡œ access token ë°œê¸‰
async function handleOAuthCallback() {
  // ì¦‰ì‹œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì €ì¥í•œ ê°’ í™•ì¸
  const code = window.__OAUTH_CODE__;
  const state = window.__OAUTH_STATE__;
  const error = window.__OAUTH_ERROR__;

  // OAuth íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
  if (!window.__OAUTH_CALLBACK_PENDING__) return false;

  // í”Œë˜ê·¸ ë¦¬ì…‹
  window.__OAUTH_CALLBACK_PENDING__ = false;

  // ì—ëŸ¬ ì²˜ë¦¬
  if (error) {
    const errorDesc = window.__OAUTH_ERROR_DESC__ || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
    alert(`âŒ ì¹´í˜24 ì¸ì¦ ì‹¤íŒ¨\n\nì˜¤ë¥˜: ${error}\nì„¤ëª…: ${errorDesc}`);
    window.location.reload();
    return true;
  }

  // CSRF í† í° ê²€ì¦
  const savedState = sessionStorage.getItem('cafe24_csrf_token');
  if (state !== savedState) {
    alert('âŒ ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨ (CSRF í† í° ë¶ˆì¼ì¹˜)\n\në‹¤ì‹œ ì¸ì¦ì„ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return true;
  }

  // ì €ì¥ëœ Mall ID ê°€ì ¸ì˜¤ê¸°
  const mallId = sessionStorage.getItem('cafe24_mall_id');
  if (!mallId) {
    alert('âŒ Mall IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ ì¸ì¦ì„ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return true;
  }

  // ë¡œë”© í‘œì‹œ
  showLoadingOverlay('ì¹´í˜24 ì¸ì¦ ì²˜ë¦¬ ì¤‘...');

  try {
    // Firebase Functions í”„ë¡ì‹œë¥¼ í†µí•´ Access Token ë°œê¸‰ (CORS ìš°íšŒ)
    const response = await fetch(CAFE24_CONFIG.tokenProxyUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        mallId: mallId,
        code: code,
        redirectUri: CAFE24_CONFIG.redirectUri,
        clientId: CAFE24_CONFIG.clientId,
        clientSecret: CAFE24_CONFIG.clientSecret,
        grantType: 'authorization_code'
      })
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error_description || `í† í° ë°œê¸‰ ì‹¤íŒ¨: ${response.status}`);
    }

    const tokenData = await response.json();
    console.log('âœ… Access Token ë°œê¸‰ ì„±ê³µ:', JSON.stringify(tokenData, null, 2));

    // expires_in ê¸°ë³¸ê°’ ì„¤ì • (Cafe24ëŠ” ë³´í†µ 2ì‹œê°„ = 7200ì´ˆ)
    const expiresIn = tokenData.expires_in || 7200;
    const tokenExpiry = new Date(Date.now() + (expiresIn * 1000)).toISOString();

    // refresh_token ë§Œë£Œ ê³„ì‚° (ê¸°ë³¸ 14ì¼)
    let refreshTokenExpiry;
    if (tokenData.refresh_token_expires_at) {
      refreshTokenExpiry = tokenData.refresh_token_expires_at;
    } else if (tokenData.refresh_token_expires_in) {
      refreshTokenExpiry = new Date(Date.now() + (tokenData.refresh_token_expires_in * 1000)).toISOString();
    } else {
      refreshTokenExpiry = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString();
    }

    console.log('Token expiry:', tokenExpiry);
    console.log('Refresh token expiry:', refreshTokenExpiry);

    // Firestoreì— í† í° ì •ë³´ ì €ì¥
    await db.collection('settings').doc('cafe24').set({
      mallId: mallId,
      clientId: CAFE24_CONFIG.clientId,
      clientSecret: CAFE24_CONFIG.clientSecret,
      accessToken: tokenData.access_token,
      refreshToken: tokenData.refresh_token,
      tokenExpiry: tokenExpiry,
      refreshTokenExpiry: refreshTokenExpiry,
      scopes: tokenData.scopes || CAFE24_CONFIG.scope.split(','),
      lastTokenRefresh: new Date().toISOString(),
      lastSync: null,
      autoSync: false
    }, { merge: true });

    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
    sessionStorage.removeItem('cafe24_csrf_token');
    sessionStorage.removeItem('cafe24_mall_id');

    alert('âœ… ì¹´í˜24 ì¸ì¦ ì™„ë£Œ!\n\nì´ì œ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në¡œê·¸ì¸ í›„ ì¹´í˜24 ì„¤ì • í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');

    // í˜ì´ì§€ ë¦¬ë¡œë“œ (ì •ìƒ ë¡œê·¸ì¸ íë¦„ìœ¼ë¡œ)
    window.location.reload();

  } catch (err) {
    console.error('OAuth í† í° ë°œê¸‰ ì˜¤ë¥˜:', err);
    alert(`âŒ í† í° ë°œê¸‰ ì‹¤íŒ¨\n\n${err.message}\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
    window.location.reload();
  }

  return true;
}

// ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ/ìˆ¨ê¹€
function showLoadingOverlay(message) {
  let overlay = document.getElementById('loading-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'loading-overlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
    overlay.innerHTML = `<div style="background:white;padding:24px 32px;border-radius:12px;text-align:center;">
      <div style="font-size:32px;margin-bottom:12px;">â³</div>
      <div id="loading-message" style="font-size:15px;color:#333;">${message || 'ì²˜ë¦¬ ì¤‘...'}</div>
    </div>`;
    document.body.appendChild(overlay);
  } else {
    document.getElementById('loading-message').textContent = message || 'ì²˜ë¦¬ ì¤‘...';
    overlay.style.display = 'flex';
  }
}

function hideLoadingOverlay() {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.style.display = 'none';
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ OAuth ì½œë°± í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
  handleOAuthCallback();
});

// ì¹´í˜24 ì„¤ì • í˜ì´ì§€ ë Œë”ë§
async function renderCafe24Settings() {
  const app = document.getElementById('app');

  // Firestoreì—ì„œ ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
  let savedConfig = { mallId: '', accessToken: '', refreshToken: '', tokenExpiry: null, lastSync: null };
  try {
    const doc = await db.collection('settings').doc('cafe24').get();
    if (doc.exists) {
      savedConfig = doc.data();
    }
  } catch (err) {
    console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', err);
  }

  const isConnected = !!savedConfig.accessToken;
  const lastSyncText = savedConfig.lastSync
    ? new Date(savedConfig.lastSync).toLocaleString('ko-KR')
    : 'ì—†ìŒ';

  const tokenExpiryText = savedConfig.tokenExpiry
    ? new Date(savedConfig.tokenExpiry).toLocaleString('ko-KR')
    : 'ì—†ìŒ';

  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">âš™ï¸ ì¹´í˜24 API ì—°ë™ ì„¤ì •</h1>
      <p class="page-desc">ì¹´í˜24 ì‡¼í•‘ëª°ê³¼ ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”</p>
    </div>

    <div class="card" style="margin-bottom: 16px;">
      <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: ${isConnected ? 'var(--success-light)' : 'var(--warning-light)'}; border-radius: 8px; margin-bottom: 20px;">
        <div style="font-size: 32px;">${isConnected ? 'âœ…' : 'âš ï¸'}</div>
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 15px; color: var(--gray-900); margin-bottom: 4px;">
            ${isConnected ? 'ì¹´í˜24 ì—°ë™ ì™„ë£Œ' : 'ì¹´í˜24 ì—°ë™ í•„ìš”'}
          </div>
          <div style="font-size: 13px; color: var(--gray-600);">
            ${isConnected ? `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${lastSyncText}` : 'Mall IDì™€ Access Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”'}
          </div>
        </div>
        ${isConnected ? `<button onclick="disconnectCafe24()" class="btn btn-sm" style="background: var(--danger); color: white;">ì—°ë™ í•´ì œ</button>` : ''}
      </div>

      <div class="form-group">
        <label class="form-label">Mall ID (ì‡¼í•‘ëª° ì•„ì´ë””)</label>
        <input type="text" id="cafe24MallId" class="form-input" placeholder="ì˜ˆ: moyeora02" value="${savedConfig.mallId || ''}" ${isConnected ? 'disabled' : ''}>
        <p style="font-size: 12px; color: var(--gray-500); margin-top: 6px;">
          ğŸ’¡ ì¹´í˜24 ì‡¼í•‘ëª° ì•„ì´ë”” (ì˜ˆ: moyeora02.cafe24.comì˜ moyeora02)
        </p>
      </div>

      <div class="form-group">
        <label class="form-label">Client ID</label>
        <input type="text" id="cafe24ClientId" class="form-input" placeholder="ì¹´í˜24 ì•± Client ID" value="${savedConfig.clientId || ''}" ${isConnected ? 'disabled' : ''}>
        <p style="font-size: 12px; color: var(--gray-500); margin-top: 6px;">
          ğŸ”‘ ì¹´í˜24 ê°œë°œìì„¼í„° > ì•± ìƒì„¸ > App Keyì˜ Client ID
        </p>
      </div>

      <div class="form-group">
        <label class="form-label">Client Secret</label>
        <input type="password" id="cafe24ClientSecret" class="form-input" placeholder="ì¹´í˜24 ì•± Client Secret" value="${savedConfig.clientSecret || ''}" ${isConnected ? 'disabled' : ''}>
        <p style="font-size: 12px; color: var(--gray-500); margin-top: 6px;">
          ğŸ” ì¹´í˜24 ê°œë°œìì„¼í„° > ì•± ìƒì„¸ > App Keyì˜ Client Secret
        </p>
      </div>

      <div class="form-group">
        <label class="form-label">Access Token</label>
        <textarea id="cafe24AccessToken" class="form-input" placeholder="Access Tokenì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°" rows="3" ${isConnected ? 'disabled' : ''}>${savedConfig.accessToken || ''}</textarea>
        <p style="font-size: 12px; color: var(--gray-500); margin-top: 6px;">
          ğŸ“ ì¹´í˜24 ê°œë°œìì„¼í„° > Apps > App ê´€ë¦¬ > í† í° ë°œê¸‰
        </p>
      </div>

      <div class="form-group">
        <label class="form-label">Refresh Token (ì„ íƒ)</label>
        <textarea id="cafe24RefreshToken" class="form-input" placeholder="Refresh Tokenì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (ìë™ ê°±ì‹ ìš©)" rows="2" ${isConnected ? 'disabled' : ''}>${savedConfig.refreshToken || ''}</textarea>
        <p style="font-size: 12px; color: var(--gray-500); margin-top: 6px;">
          ğŸ”„ Access Token ìë™ ê°±ì‹ ì„ ìœ„í•´ ì…ë ¥ (ì„ íƒì‚¬í•­)
        </p>
      </div>

      ${!isConnected ? `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button onclick="startCafe24OAuth()" class="btn" style="width: 100%; background: linear-gradient(135deg, #1a73e8, #0d5bcc); color: white; font-weight: 600; padding: 14px;">
            ğŸ” ì¹´í˜24 OAuth ì¸ì¦í•˜ê¸° (ê¶Œì¥)
          </button>
          <div style="text-align: center; color: var(--gray-400); font-size: 12px;">ë˜ëŠ”</div>
          <button onclick="saveCafe24Tokens()" class="btn btn-secondary" style="width: 100%;">
            ğŸ’¾ ìˆ˜ë™ìœ¼ë¡œ í† í° ì…ë ¥í•˜ê¸°
          </button>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: var(--info-light); border-radius: 8px; font-size: 12px; color: var(--gray-700);">
          ğŸ’¡ <strong>OAuth ì¸ì¦ì„ ê¶Œì¥í•©ë‹ˆë‹¤!</strong><br>
          Mall IDë§Œ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ Access Tokenê³¼ Refresh Tokenì´ ë°œê¸‰ë©ë‹ˆë‹¤.
        </div>
      ` : `
        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
          <button onclick="syncCafe24Orders()" class="btn btn-primary" style="flex: 1;">
            ğŸ”„ ì£¼ë¬¸ ë°ì´í„° ë™ê¸°í™”
          </button>
          <button onclick="testCafe24Connection()" class="btn btn-secondary">
            ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
        </div>
        <div style="padding: 12px; background: var(--info-light); border-radius: 8px; font-size: 13px;">
          <div style="color: var(--gray-700); margin-bottom: 4px;">â° í† í° ë§Œë£Œ ì˜ˆì •: ${tokenExpiryText}</div>
          ${savedConfig.refreshToken ? '<div style="color: var(--success);">âœ… Refresh Token ì„¤ì •ë¨ (ìë™ ê°±ì‹  ê°€ëŠ¥)</div>' : '<div style="color: var(--warning);">âš ï¸ Refresh Token ë¯¸ì„¤ì • (ìˆ˜ë™ ê°±ì‹  í•„ìš”)</div>'}
        </div>
      `}
    </div>

    ${isConnected ? `
      <div class="card">
        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">âš™ï¸ ìë™ ë™ê¸°í™” ì„¤ì •</h3>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="cafe24AutoSync" onchange="toggleAutoSync()" ${savedConfig.autoSync ? 'checked' : ''} style="width: 18px; height: 18px;">
            <span style="font-size: 14px; font-weight: 500;">ìë™ ë™ê¸°í™” í™œì„±í™”</span>
          </label>
          <p style="font-size: 12px; color: var(--gray-500); margin-top: 6px; margin-left: 26px;">
            1ì‹œê°„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ì¹´í˜24 ì£¼ë¬¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
          </p>
          ${savedConfig.autoSync ? `
            <div style="margin-top: 12px; padding: 12px; background: var(--success-light); border-radius: 8px; margin-left: 26px;">
              <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--success);">
                <span>ğŸ”„</span>
                <span style="font-weight: 600;">ìë™ ë™ê¸°í™” ì‹¤í–‰ ì¤‘</span>
              </div>
              <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">
                ë‹¤ìŒ ë™ê¸°í™”ëŠ” ì•½ 1ì‹œê°„ í›„ì— ì‹¤í–‰ë©ë‹ˆë‹¤
              </div>
            </div>
          ` : ''}
        </div>

        <div style="margin-top: 16px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
          <div style="font-size: 13px; color: var(--gray-600); margin-bottom: 8px;">ì—°ë™ ì •ë³´</div>
          <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px; font-size: 13px;">
            <div style="color: var(--gray-500);">Mall ID:</div>
            <div style="font-weight: 600;">${savedConfig.mallId}</div>
            <div style="color: var(--gray-500);">Access Token:</div>
            <div style="font-family: monospace; font-size: 11px;">${savedConfig.accessToken ? savedConfig.accessToken.substring(0, 20) + '...' : '-'}</div>
            <div style="color: var(--gray-500);">ë™ê¸°í™” íšŸìˆ˜:</div>
            <div style="font-weight: 600;">${savedConfig.lastSyncCount || 0}ê±´</div>
          </div>
        </div>
      </div>
    ` : ''}

    <div class="card" style="margin-top: 16px;">
      <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">ğŸ“– ì¹´í˜24 API ì—°ë™ ì„¤ì • ê°€ì´ë“œ</h3>

      <div style="margin-bottom: 20px;">
        <h4 style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">1ï¸âƒ£ Client ID / Client Secret í™•ì¸</h4>
        <ol style="font-size: 13px; line-height: 1.8; color: var(--gray-700); padding-left: 20px;">
          <li><a href="https://developers.cafe24.com" target="_blank" style="color: var(--primary);">ì¹´í˜24 ê°œë°œìì„¼í„°</a>ì— ë¡œê·¸ì¸</li>
          <li>ì¢Œì¸¡ ë©”ë‰´ > <strong>Apps</strong> > <strong>App ê´€ë¦¬</strong> í´ë¦­</li>
          <li>ë“±ë¡í•œ ì•±(<strong>ëª¨ì—¬ë¼ë”œ ì •ì‚°ì—°ë™</strong>) í´ë¦­</li>
          <li><strong>App Key</strong> ì„¹ì…˜ì—ì„œ <strong>Client ID</strong>ì™€ <strong>Client Secret</strong> ë³µì‚¬</li>
          <li>ìœ„ ì…ë ¥ë€ì— ë¶™ì—¬ë„£ê¸°</li>
        </ol>
      </div>

      <div style="margin-bottom: 20px;">
        <h4 style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">2ï¸âƒ£ Access Token / Refresh Token ë°œê¸‰</h4>
        <ol style="font-size: 13px; line-height: 1.8; color: var(--gray-700); padding-left: 20px;">
          <li>ê°™ì€ í˜ì´ì§€ í•˜ë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤</li>
          <li><strong>"í† í° ë°œê¸‰ë°›ê¸°"</strong> ë˜ëŠ” <strong>"Get Access Token"</strong> ë²„íŠ¼ í´ë¦­</li>
          <li>í•„ìš”í•œ ê¶Œí•œ(Scope) ì„ íƒ:
            <ul style="margin-left: 20px; margin-top: 4px;">
              <li><code>mall.read_order</code> - ì£¼ë¬¸ ì¡°íšŒ</li>
              <li><code>mall.read_product</code> - ìƒí’ˆ ì¡°íšŒ</li>
              <li><code>mall.read_store</code> - ì‡¼í•‘ëª° ì •ë³´ ì¡°íšŒ</li>
            </ul>
          </li>
          <li>ë°œê¸‰ëœ <strong>Access Token</strong>ê³¼ <strong>Refresh Token</strong>ì„ ë³µì‚¬</li>
          <li>ìœ„ ì…ë ¥ë€ì— ë¶™ì—¬ë„£ê¸°</li>
        </ol>
      </div>

      <div style="margin-bottom: 20px;">
        <h4 style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">3ï¸âƒ£ ì—°ë™ ì™„ë£Œ</h4>
        <ol style="font-size: 13px; line-height: 1.8; color: var(--gray-700); padding-left: 20px;">
          <li><strong>"ì—°ë™ ì •ë³´ ì €ì¥"</strong> ë²„íŠ¼ í´ë¦­</li>
          <li><strong>"ì—°ê²° í…ŒìŠ¤íŠ¸"</strong> ë²„íŠ¼ìœ¼ë¡œ ì—°ê²° í™•ì¸</li>
          <li><strong>"ì£¼ë¬¸ ë°ì´í„° ë™ê¸°í™”"</strong> ë²„íŠ¼ìœ¼ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</li>
        </ol>
      </div>

      <div style="padding: 12px; background: var(--info-light); border-radius: 8px; font-size: 12px; color: var(--gray-700); margin-bottom: 12px;">
        ğŸ’¡ <strong>Refresh Tokenì„ ì„¤ì •í•˜ë©´:</strong><br>
        Access Tokenì´ ë§Œë£Œë˜ì–´ë„ ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ë¯€ë¡œ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
      </div>

      <div style="padding: 12px; background: var(--warning-light); border-radius: 8px; font-size: 12px; color: var(--gray-700);">
        âš ï¸ <strong>ì£¼ì˜:</strong> Access Token, Client Secretì€ ë³´ì•ˆì´ ì¤‘ìš”í•©ë‹ˆë‹¤. íƒ€ì¸ê³¼ ê³µìœ í•˜ì§€ ë§ˆì„¸ìš”.
      </div>
    </div>
  `;
}

// ì¹´í˜24 í† í° ì €ì¥ (ìˆ˜ë™ ì…ë ¥ ë°©ì‹)
async function saveCafe24Tokens() {
  const mallId = document.getElementById('cafe24MallId').value.trim();
  const clientId = document.getElementById('cafe24ClientId').value.trim();
  const clientSecret = document.getElementById('cafe24ClientSecret').value.trim();
  const accessToken = document.getElementById('cafe24AccessToken').value.trim();
  const refreshToken = document.getElementById('cafe24RefreshToken').value.trim();

  if (!mallId) {
    alert('Mall IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  if (!accessToken) {
    alert('Access Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  // Refresh Token ì‚¬ìš© ì‹œ Client ID/Secret í•„ìˆ˜
  if (refreshToken && (!clientId || !clientSecret)) {
    alert('Refresh Tokenì„ ì‚¬ìš©í•˜ë ¤ë©´ Client IDì™€ Client Secretì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  try {
    // Firestoreì— ì €ì¥
    await db.collection('settings').doc('cafe24').set({
      mallId: mallId,
      clientId: clientId || null,
      clientSecret: clientSecret || null,
      accessToken: accessToken,
      refreshToken: refreshToken || null,
      tokenExpiry: refreshToken ? new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString() : null, // ê¸°ë³¸ 2ì£¼
      connectedAt: new Date().toISOString()
    }, { merge: true });

    alert('âœ… ì—°ë™ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    renderCafe24Settings();

  } catch (err) {
    console.error('ì €ì¥ ì˜¤ë¥˜:', err);
    alert('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
  }
}

// ì¹´í˜24 Refresh Tokenìœ¼ë¡œ Access Token ê°±ì‹ 
async function refreshCafe24AccessToken() {
  try {
    const doc = await db.collection('settings').doc('cafe24').get();
    if (!doc.exists) {
      throw new Error('ì¹´í˜24 ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
    }

    const config = doc.data();
    if (!config.refreshToken) {
      throw new Error('Refresh Tokenì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    if (!config.clientId || !config.clientSecret) {
      throw new Error('Client IDì™€ Client Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    const { mallId, refreshToken, clientId, clientSecret } = config;

    // Firebase Functions í”„ë¡ì‹œë¥¼ í†µí•´ í† í° ê°±ì‹  (CORS ìš°íšŒ)
    const response = await fetch(CAFE24_CONFIG.tokenProxyUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        mallId: mallId,
        refreshToken: refreshToken,
        clientId: clientId,
        clientSecret: clientSecret,
        grantType: 'refresh_token'
      })
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(`í† í° ê°±ì‹  ì‹¤íŒ¨: ${response.status} - ${errorData.error_description || ''}`);
    }

    const data = await response.json();
    console.log('í† í° ê°±ì‹  ì‘ë‹µ:', JSON.stringify(data, null, 2));

    // expires_in ê¸°ë³¸ê°’ ì„¤ì • (Cafe24ëŠ” ë³´í†µ 2ì‹œê°„ = 7200ì´ˆ)
    const expiresIn = data.expires_in || 7200;
    const tokenExpiry = new Date(Date.now() + (expiresIn * 1000)).toISOString();

    // refresh_token ë§Œë£Œ ê³„ì‚°
    let refreshTokenExpiry;
    if (data.refresh_token_expires_at) {
      refreshTokenExpiry = data.refresh_token_expires_at;
    } else if (data.refresh_token_expires_in) {
      refreshTokenExpiry = new Date(Date.now() + (data.refresh_token_expires_in * 1000)).toISOString();
    } else {
      refreshTokenExpiry = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString();
    }

    // ìƒˆë¡œìš´ í† í° ì •ë³´ ì €ì¥
    await db.collection('settings').doc('cafe24').update({
      accessToken: data.access_token,
      refreshToken: data.refresh_token, // ìƒˆë¡œìš´ refresh tokenë„ í•¨ê»˜ ë°œê¸‰ë¨
      tokenExpiry: tokenExpiry,
      refreshTokenExpiry: refreshTokenExpiry,
      lastTokenRefresh: new Date().toISOString()
    });

    console.log('âœ… Access Tokenì´ ì„±ê³µì ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
    return data.access_token;

  } catch (err) {
    console.error('í† í° ê°±ì‹  ì˜¤ë¥˜:', err);
    throw err;
  }
}

// ì¹´í˜24 ì—°ê²° í…ŒìŠ¤íŠ¸
async function testCafe24Connection() {
  const btn = event.target;
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'ğŸ” í…ŒìŠ¤íŠ¸ ì¤‘...';

  try {
    const doc = await db.collection('settings').doc('cafe24').get();
    if (!doc.exists || !doc.data().accessToken) {
      alert('ì—°ë™ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    let { mallId, accessToken } = doc.data();

    // í”„ë¡ì‹œë¥¼ í†µí•´ ì¹´í˜24 API í…ŒìŠ¤íŠ¸ í˜¸ì¶œ (shop ì •ë³´ ì¡°íšŒ)
    let data;
    try {
      data = await callCafe24Api(mallId, accessToken, '/api/v2/admin/shop');
    } catch (apiErr) {
      // 401 ì—ëŸ¬ ì‹œ í† í° ê°±ì‹  ì‹œë„
      if (apiErr.status === 401) {
        console.log('Access Token ë§Œë£Œ, ê°±ì‹  ì‹œë„...');
        accessToken = await refreshCafe24AccessToken();
        data = await callCafe24Api(mallId, accessToken, '/api/v2/admin/shop');
      } else {
        throw apiErr;
      }
    }

    alert(`âœ… ì—°ê²° ì„±ê³µ!\n\nì‡¼í•‘ëª°: ${data.shop?.shop_name || mallId}\nìƒíƒœ: ì •ìƒ`);

  } catch (err) {
    console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', err);
    const errorMsg = typeof err === 'object' ? (err.message || JSON.stringify(err)) : String(err);
    alert('âŒ ì—°ê²° ì‹¤íŒ¨: ' + errorMsg + '\n\nAccess Tokenì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// ì¹´í˜24 ì£¼ë¬¸ ë°ì´í„° ë™ê¸°í™”
async function syncCafe24Orders(isAuto = false) {
  // ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ í™•ì¸
  if (!isAuto && !confirm('ì¹´í˜24ì—ì„œ ìµœì‹  ì£¼ë¬¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  const btn = isAuto ? null : event.target;
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'ğŸ”„ ë™ê¸°í™” ì¤‘...';
  }

  try {
    // Firestoreì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const doc = await db.collection('settings').doc('cafe24').get();
    if (!doc.exists || !doc.data().accessToken) {
      if (!isAuto) alert('ë¨¼ì € ì¹´í˜24 ì¸ì¦ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }

    let { mallId, accessToken } = doc.data();

    // ìµœê·¼ 30ì¼ ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    const startDateStr = startDate.toISOString().split('T')[0];
    const endDateStr = new Date().toISOString().split('T')[0];

    // í”„ë¡ì‹œë¥¼ í†µí•´ ì¹´í˜24 API í˜¸ì¶œ
    const apiEndpoint = `/api/v2/admin/orders?start_date=${startDateStr}&end_date=${endDateStr}&limit=1000`;

    let ordersData;
    try {
      ordersData = await callCafe24Api(mallId, accessToken, apiEndpoint);
    } catch (apiErr) {
      // 401 ì—ëŸ¬ ì‹œ í† í° ê°±ì‹  ì‹œë„
      if (apiErr.status === 401) {
        console.log('Access Token ë§Œë£Œ, ê°±ì‹  ì‹œë„...');
        accessToken = await refreshCafe24AccessToken();
        ordersData = await callCafe24Api(mallId, accessToken, apiEndpoint);
      } else {
        throw apiErr;
      }
    }

    const orders = ordersData.orders || [];

    // Firestoreì— ì €ì¥
    let savedCount = 0;
    const batch = db.batch();

    for (const order of orders) {
      const docRef = db.collection('cafe24_orders').doc(order.order_id);
      batch.set(docRef, {
        order_id: order.order_id,
        order_date: order.order_date,
        member_id: order.member_id,
        billing_name: order.billing_name,
        total_amount: parseFloat(order.order_price_amount || 0),
        payment_status: order.payment_status,
        order_status: order.order_status,
        items: order.items || [],
        synced_at: new Date().toISOString()
      }, { merge: true });

      savedCount++;

      // FirestoreëŠ” í•œ ë²ˆì— 500ê°œê¹Œì§€ë§Œ batch ê°€ëŠ¥
      if (savedCount % 500 === 0) {
        await batch.commit();
      }
    }

    // ë‚¨ì€ ë°ì´í„° ì»¤ë°‹
    if (savedCount % 500 !== 0) {
      await batch.commit();
    }

    // ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„ ì—…ë°ì´íŠ¸
    await db.collection('settings').doc('cafe24').update({
      lastSync: new Date().toISOString(),
      lastSyncCount: savedCount
    });

    if (!isAuto) {
      alert(`âœ… ì´ ${savedCount}ê±´ì˜ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë™ê¸°í™”í–ˆìŠµë‹ˆë‹¤!`);
      renderCafe24Settings();
    } else {
      console.log(`âœ… [ìë™ ë™ê¸°í™”] ${savedCount}ê±´ì˜ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë™ê¸°í™”í–ˆìŠµë‹ˆë‹¤ (${new Date().toLocaleString('ko-KR')})`);
    }

  } catch (err) {
    console.error('ë™ê¸°í™” ì˜¤ë¥˜:', err);
    if (!isAuto) {
      alert('âŒ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    }
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'ğŸ”„ ì£¼ë¬¸ ë°ì´í„° ë™ê¸°í™”';
    }
  }
}

// ì¹´í˜24 ì—°ë™ í•´ì œ
async function disconnectCafe24() {
  if (!confirm('ì¹´í˜24 ì—°ë™ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  try {
    await db.collection('settings').doc('cafe24').update({
      accessToken: null,
      refreshToken: null,
      tokenExpiry: null,
      disconnectedAt: new Date().toISOString()
    });

    alert('âœ… ì¹´í˜24 ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    renderCafe24Settings();
  } catch (err) {
    console.error('ì—°ë™ í•´ì œ ì˜¤ë¥˜:', err);
    alert('âŒ ì—°ë™ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ìë™ ë™ê¸°í™” í† ê¸€
async function toggleAutoSync() {
  const checked = document.getElementById('cafe24AutoSync').checked;

  try {
    await db.collection('settings').doc('cafe24').update({
      autoSync: checked,
      autoSyncUpdatedAt: new Date().toISOString()
    });

    if (checked) {
      alert('âœ… ìë™ ë™ê¸°í™”ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰)');
      startCafe24AutoSync(); // ìë™ ë™ê¸°í™” ì‹œì‘
    } else {
      stopCafe24AutoSync(); // ìë™ ë™ê¸°í™” ì¤‘ì§€
      alert('â¸ï¸ ìë™ ë™ê¸°í™”ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  } catch (err) {
    console.error('ìë™ ë™ê¸°í™” ì„¤ì • ì˜¤ë¥˜:', err);
    alert('âŒ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ìë™ ë™ê¸°í™” íƒ€ì´ë¨¸ ë³€ìˆ˜
let cafe24AutoSyncInterval = null;

// ìë™ ë™ê¸°í™” ì‹œì‘
function startCafe24AutoSync() {
  // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì¤‘ì§€
  if (cafe24AutoSyncInterval) {
    clearInterval(cafe24AutoSyncInterval);
  }

  console.log('ğŸ”„ ì¹´í˜24 ìë™ ë™ê¸°í™” ì‹œì‘ (1ì‹œê°„ ê°„ê²©)');

  // 1ì‹œê°„(3600000ms)ë§ˆë‹¤ ìë™ ë™ê¸°í™” ì‹¤í–‰
  cafe24AutoSyncInterval = setInterval(async () => {
    console.log('â° ì¹´í˜24 ìë™ ë™ê¸°í™” ì‹¤í–‰ ì‹œì‘...');
    try {
      await syncCafe24Orders(true); // isAuto = true
    } catch (err) {
      console.error('ìë™ ë™ê¸°í™” ì‹¤í–‰ ì˜¤ë¥˜:', err);
    }
  }, 60 * 60 * 1000); // 1ì‹œê°„ = 60ë¶„ Ã— 60ì´ˆ Ã— 1000ms

  // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰ (ì„ íƒì‚¬í•­)
  // syncCafe24Orders(true);
}

// ìë™ ë™ê¸°í™” ì¤‘ì§€
function stopCafe24AutoSync() {
  if (cafe24AutoSyncInterval) {
    clearInterval(cafe24AutoSyncInterval);
    cafe24AutoSyncInterval = null;
    console.log('â¸ï¸ ì¹´í˜24 ìë™ ë™ê¸°í™” ì¤‘ì§€');
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë™ê¸°í™” ì„¤ì • í™•ì¸ ë° ì‹œì‘
async function initCafe24AutoSync() {
  try {
    const doc = await db.collection('settings').doc('cafe24').get();
    if (doc.exists && doc.data().autoSync === true && doc.data().accessToken) {
      console.log('âœ… ì¹´í˜24 ìë™ ë™ê¸°í™” ì„¤ì • í™•ì¸ë¨, ì‹œì‘í•©ë‹ˆë‹¤...');
      startCafe24AutoSync();
    }
  } catch (err) {
    console.error('ìë™ ë™ê¸°í™” ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
  }
}

// ë™ê¸°í™” ë¡œê·¸ ë³´ê¸°
function viewCafe24Logs() {
  alert('ë™ê¸°í™” ë¡œê·¸ ê¸°ëŠ¥ì€ ì¶”í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ==================== ì¹´í˜24 ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ ====================
async function renderCafe24Dashboard() {
  const app = document.getElementById('app');
  app.innerHTML = '<div style="text-align: center; padding: 60px;"><div class="loading"></div><p style="margin-top: 16px; color: var(--gray-500);">ì¹´í˜24 ë°ì´í„° ë¡œë”© ì¤‘...</p></div>';
  
  try {
    const ordersSnapshot = await db.collection('cafe24_orders').orderBy('order_date', 'desc').limit(1000).get();
    const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // ì •ì‚° ë‚´ì—­ ë¡œë“œ
    const settlementsSnapshot = await db.collection('cafe24_settlements').orderBy('period', 'desc').get();
    const settlements = settlementsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay() + 1);
    const weekStartStr = weekStart.toISOString().split('T')[0];
    const monthStartStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    const todayOrders = orders.filter(o => o.order_date && o.order_date.startsWith(todayStr));
    const weekOrders = orders.filter(o => o.order_date && o.order_date >= weekStartStr);
    const monthOrders = orders.filter(o => o.order_date && o.order_date >= monthStartStr);
    
    const todaySales = todayOrders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);
    const weekSales = weekOrders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);
    const monthSales = monthOrders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);
    
    // ê²°ì œì™„ë£Œ ê±´ë§Œ ì§‘ê³„ (F = ê²°ì œì™„ë£Œ)
    const paidOrders = orders.filter(o => o.payment_status === 'F' || o.payment_status === 'ê²°ì œì™„ë£Œ');
    const totalPaidAmount = paidOrders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);
    
    // ğŸ¯ ì…€ëŸ¬ë³„ ì§‘ê³„ (ë§ˆì§„ê¸ˆì•¡ í¬í•¨)
    const sellerStats = {};
    orders.forEach(o => {
      const seller = o.seller_name || '(ë¯¸ì§€ì •)';
      if (!sellerStats[seller]) {
        sellerStats[seller] = { orderCount: 0, totalQuantity: 0, totalAmount: 0, paidAmount: 0, pgFee: 0, marginAmount: 0 };
      }
      sellerStats[seller].orderCount += 1;
      sellerStats[seller].totalQuantity += Number(o.quantity) || 1;
      sellerStats[seller].totalAmount += Number(o.total_amount) || 0;
      sellerStats[seller].pgFee += Number(o.pg_fee) || 0;
      // ë§ˆì§„ê¸ˆì•¡ ê³„ì‚° (margin_rate ì‚¬ìš©)
      const marginRate = Number(o.margin_rate) || 10;
      sellerStats[seller].marginAmount += Math.round((Number(o.total_amount) || 0) * marginRate / 100);
      if (o.payment_status === 'F') {
        sellerStats[seller].paidAmount += Number(o.total_amount) || 0;
      }
    });

    // ğŸ¯ ê³µê¸‰ì‚¬ë³„ ì§‘ê³„ (íƒ€ì‚¬ë§Œ, ê³µê¸‰ê°€ì•¡ í¬í•¨)
    const supplierStats = {};
    orders.forEach(o => {
      if (o.product_type === 'external' && o.supplier_name) {
        const supplier = o.supplier_name;
        if (!supplierStats[supplier]) {
          supplierStats[supplier] = { orderCount: 0, totalQuantity: 0, totalAmount: 0, pgFee: 0, supplyAmount: 0 };
        }
        supplierStats[supplier].orderCount += 1;
        supplierStats[supplier].totalQuantity += Number(o.quantity) || 1;
        supplierStats[supplier].totalAmount += Number(o.total_amount) || 0;
        supplierStats[supplier].pgFee += Number(o.pg_fee) || 0;
        // ê³µê¸‰ê°€ì•¡ ê³„ì‚° (supply_price * quantity)
        const supplyPrice = Number(o.supply_price) || 0;
        supplierStats[supplier].supplyAmount += supplyPrice * (Number(o.quantity) || 1);
      }
    });
    
    // ì´ë²ˆ ë‹¬ ì…€ëŸ¬ë³„ ì§‘ê³„ (ìì‚¬/íƒ€ì‚¬ êµ¬ë¶„ í¬í•¨)
    const monthSellerStats = {};
    monthOrders.forEach(o => {
      const seller = o.seller_name || '(ë¯¸ì§€ì •)';
      if (!monthSellerStats[seller]) {
        monthSellerStats[seller] = { 
          orderCount: 0, 
          totalQuantity: 0,
          totalAmount: 0, 
          pgFee: 0,
          supplierName: o.supplier_name || '', 
          productType: o.product_type || 'inhouse',
          sellerFullName: o.seller_full_name || ''
        };
      }
      monthSellerStats[seller].orderCount += 1;
      monthSellerStats[seller].totalQuantity += Number(o.quantity) || 1;
      monthSellerStats[seller].totalAmount += Number(o.total_amount) || 0;
      monthSellerStats[seller].pgFee += Number(o.pg_fee) || 0;
    });
    
    // ì´ë²ˆ ë‹¬ ê³µê¸‰ì‚¬ë³„ ì§‘ê³„ (íƒ€ì‚¬ë§Œ)
    const monthSupplierStats = {};
    monthOrders.forEach(o => {
      if (o.product_type === 'external' && o.supplier_name) {
        const supplier = o.supplier_name;
        if (!monthSupplierStats[supplier]) {
          monthSupplierStats[supplier] = { orderCount: 0, totalQuantity: 0, totalAmount: 0, pgFee: 0 };
        }
        monthSupplierStats[supplier].orderCount += 1;
        monthSupplierStats[supplier].totalQuantity += Number(o.quantity) || 1;
        monthSupplierStats[supplier].totalAmount += Number(o.total_amount) || 0;
        monthSupplierStats[supplier].pgFee += Number(o.pg_fee) || 0;
      }
    });
    
    // ğŸ¯ ì „ì²´ PGìˆ˜ìˆ˜ë£Œ ê³„ì‚°
    const totalPgFee = monthOrders.reduce((sum, o) => sum + (Number(o.pg_fee) || 0), 0);

    // ì´ë²ˆ ë‹¬ ì •ì‚° ìƒíƒœ í™•ì¸
    const currentMonthSettlement = settlements.find(s => s.period === currentMonth);

    const recentOrders = orders.slice(0, 5);

    // ğŸ“Š ì°¨íŠ¸ìš© ë°ì´í„° ê³„ì‚°
    const dailySalesMap = {};
    const monthlySalesMap = {};
    orders.forEach(o => {
      if (!o.order_date) return;
      const date = o.order_date.split('T')[0];
      const month = date.substring(0, 7);
      const amount = Number(o.total_amount) || 0;
      dailySalesMap[date] = (dailySalesMap[date] || 0) + amount;
      monthlySalesMap[month] = (monthlySalesMap[month] || 0) + amount;
    });

    const chartLast14Days = [];
    for (let i = 13; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      chartLast14Days.push({ date: dateStr, label: (d.getMonth() + 1) + '/' + d.getDate(), sales: dailySalesMap[dateStr] || 0 });
    }

    const chartLast6Months = [];
    for (let i = 5; i >= 0; i--) {
      const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
      const monthStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
      chartLast6Months.push({ month: monthStr, label: (d.getMonth() + 1) + 'ì›”', sales: monthlySalesMap[monthStr] || 0 });
    }

    const chartMaxDaily = Math.max(...chartLast14Days.map(d => d.sales), 1);
    const chartMaxMonthly = Math.max(...chartLast6Months.map(d => d.sales), 1);
    const chartTotalSales = orders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);
    const chartAvgOrder = orders.length > 0 ? Math.round(chartTotalSales / orders.length) : 0;
    
    app.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">ğŸ“Š ì¹´í˜24 ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ì¹´í˜24 ì‡¼í•‘ëª° ë§¤ì¶œ í˜„í™© (ì—‘ì…€/CSV ì—…ë¡œë“œ ê¸°ë°˜)</p>
      </div>
      
      <!-- ì—‘ì…€ ì—…ë¡œë“œ ì¹´ë“œ -->
      <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px dashed #3b82f6;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
          <div>
            <h3 style="font-size: 16px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">ğŸ“¤ ì¹´í˜24 ì£¼ë¬¸ ë°ì´í„° ì—…ë¡œë“œ</h3>
            <p style="font-size: 13px; color: #3b82f6;">ì¹´í˜24 â†’ ì£¼ë¬¸ê´€ë¦¬ â†’ ì „ì²´ì£¼ë¬¸ì¡°íšŒ â†’ ì—‘ì…€ë‹¤ìš´ë¡œë“œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (CSV, XLSX ì§€ì›)</p>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <label class="btn btn-primary" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
              ğŸ“ íŒŒì¼ ì„ íƒ
              <input type="file" accept=".xlsx,.xls,.csv" onchange="uploadCafe24Excel(event)" style="display: none;">
            </label>
            <button onclick="renderCafe24Dashboard()" class="btn btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>
        <div style="margin-top: 12px; font-size: 12px; color: var(--gray-500);">
          ë§ˆì§€ë§‰ ì—…ë¡œë“œ: ${orders.length > 0 && orders[0].synced_at ? new Date(orders[0].synced_at).toLocaleString('ko-KR') : 'ì—†ìŒ'} | ì´ ${orders.length}ê±´ ì €ì¥ë¨
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="padding: 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 16px; color: white;">
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">ì˜¤ëŠ˜ ë§¤ì¶œ</div>
          <div style="font-size: 28px; font-weight: 700;">${formatNumber(todaySales)}ì›</div>
          <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">${todayOrders.length}ê±´</div>
        </div>
        <div style="padding: 24px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; color: white;">
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">ì´ë²ˆ ì£¼ ë§¤ì¶œ</div>
          <div style="font-size: 28px; font-weight: 700;">${formatNumber(weekSales)}ì›</div>
          <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">${weekOrders.length}ê±´</div>
        </div>
        <div style="padding: 24px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 16px; color: white;">
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
          <div style="font-size: 28px; font-weight: 700;">${formatNumber(monthSales)}ì›</div>
          <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">${monthOrders.length}ê±´</div>
        </div>
        <div style="padding: 24px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 16px; color: white;">
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">ì´ ê²°ì œì™„ë£Œ</div>
          <div style="font-size: 28px; font-weight: 700;">${formatNumber(totalPaidAmount)}ì›</div>
          <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">${paidOrders.length}ê±´</div>
        </div>
        <div style="padding: 24px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 16px; color: white;">
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">PGìˆ˜ìˆ˜ë£Œ (4%)</div>
          <div style="font-size: 28px; font-weight: 700;">${formatNumber(totalPgFee)}ì›</div>
          <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">ì¹´ë“œê²°ì œ ê¸°ì¤€</div>
        </div>
      </div>
      
      <!-- ë§¤ì¶œ í†µê³„ ì°¨íŠ¸ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
        <div class="card">
          <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ğŸ“Š ìµœê·¼ 14ì¼ ì¼ë³„ ë§¤ì¶œ</h3>
          <div style="display: flex; align-items: flex-end; gap: 4px; height: 120px;">
            ${chartLast14Days.map(d => {
              const height = chartMaxDaily > 0 ? (d.sales / chartMaxDaily * 100) : 0;
              return '<div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px;">' +
                '<div style="width: 100%; background: linear-gradient(180deg, #3b82f6, #2563eb); border-radius: 3px 3px 0 0; height: ' + Math.max(height, 2) + 'px;" title="' + d.date + ': ' + formatNumber(d.sales) + 'ì›"></div>' +
                '<div style="font-size: 8px; color: var(--gray-400);">' + d.label + '</div>' +
              '</div>';
            }).join('')}
          </div>
        </div>
        <div class="card">
          <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ğŸ“… ìµœê·¼ 6ê°œì›” ì›”ë³„ ë§¤ì¶œ</h3>
          <div style="display: flex; align-items: flex-end; gap: 8px; height: 120px;">
            ${chartLast6Months.map(d => {
              const height = chartMaxMonthly > 0 ? (d.sales / chartMaxMonthly * 100) : 0;
              return '<div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;">' +
                '<div style="font-size: 10px; font-weight: 600; color: var(--gray-600);">' + formatNumber(d.sales / 10000) + 'ë§Œ</div>' +
                '<div style="width: 100%; background: linear-gradient(180deg, #10b981, #059669); border-radius: 4px 4px 0 0; height: ' + Math.max(height, 4) + 'px;" title="' + d.month + ': ' + formatNumber(d.sales) + 'ì›"></div>' +
                '<div style="font-size: 11px; color: var(--gray-500);">' + d.label + '</div>' +
              '</div>';
            }).join('')}
          </div>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
        <div style="padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
          <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">ì´ ë§¤ì¶œì•¡</div>
          <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">${formatNumber(chartTotalSales)}ì›</div>
        </div>
        <div style="padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
          <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">í‰ê·  ì£¼ë¬¸ê¸ˆì•¡</div>
          <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">${formatNumber(chartAvgOrder)}ì›</div>
        </div>
      </div>
      
      <!-- ì…€ëŸ¬ë³„/ê³µê¸‰ì‚¬ë³„ ìˆœìœ„ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
        <!-- ì…€ëŸ¬ë³„ ìˆœìœ„ -->
        <div class="card">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">ğŸ‘¤ ì…€ëŸ¬ë³„ ë§¤ì¶œ ìˆœìœ„</h3>
          <div style="overflow-x: auto;">
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--gray-50);">
                  <th style="padding: 8px; text-align: left;">ì…€ëŸ¬ëª…</th>
                  <th style="padding: 8px; text-align: right;">íŒë§¤ê±´</th>
                  <th style="padding: 8px; text-align: right;">íŒë§¤ê¸ˆì•¡</th>
                  <th style="padding: 8px; text-align: right;">ë§ˆì§„ê¸ˆì•¡</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(sellerStats)
                  .sort((a, b) => b[1].totalAmount - a[1].totalAmount)
                  .slice(0, 10)
                  .map(([name, stat], idx) => `
                    <tr style="border-top: 1px solid var(--gray-100);">
                      <td style="padding: 8px;">
                        <span style="background: ${idx < 3 ? '#fef3c7' : 'var(--gray-100)'}; color: ${idx < 3 ? '#92400e' : 'var(--gray-600)'}; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px;">${idx + 1}</span>
                        ${name}
                      </td>
                      <td style="padding: 8px; text-align: right;">${stat.orderCount}ê±´</td>
                      <td style="padding: 8px; text-align: right; font-weight: 600;">${formatNumber(stat.totalAmount)}ì›</td>
                      <td style="padding: 8px; text-align: right; color: #1d4ed8;">${formatNumber(stat.marginAmount)}ì›</td>
                    </tr>
                  `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- ê³µê¸‰ì‚¬ë³„ ìˆœìœ„ -->
        <div class="card">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">ğŸ­ ê³µê¸‰ì‚¬ë³„ ë§¤ì¶œ ìˆœìœ„ (íƒ€ì‚¬)</h3>
          <div style="overflow-x: auto;">
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--gray-50);">
                  <th style="padding: 8px; text-align: left;">ê³µê¸‰ì‚¬ëª…</th>
                  <th style="padding: 8px; text-align: right;">íŒë§¤ê±´</th>
                  <th style="padding: 8px; text-align: right;">íŒë§¤ê¸ˆì•¡</th>
                  <th style="padding: 8px; text-align: right;">ê³µê¸‰ê°€ì•¡</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(supplierStats).length === 0 ?
                  '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--gray-400);">íƒ€ì‚¬ ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>' :
                  Object.entries(supplierStats)
                  .sort((a, b) => b[1].totalAmount - a[1].totalAmount)
                  .slice(0, 10)
                  .map(([name, stat], idx) => `
                    <tr style="border-top: 1px solid var(--gray-100);">
                      <td style="padding: 8px;">
                        <span style="background: ${idx < 3 ? '#fef3c7' : 'var(--gray-100)'}; color: ${idx < 3 ? '#92400e' : 'var(--gray-600)'}; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px;">${idx + 1}</span>
                        ${name}
                      </td>
                      <td style="padding: 8px; text-align: right;">${stat.orderCount}ê±´</td>
                      <td style="padding: 8px; text-align: right; font-weight: 600;">${formatNumber(stat.totalAmount)}ì›</td>
                      <td style="padding: 8px; text-align: right; color: #92400e;">${formatNumber(stat.supplyAmount)}ì›</td>
                    </tr>
                  `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="font-size: 16px; font-weight: 600;">ğŸ• ìµœê·¼ ì£¼ë¬¸</h3>
          <button onclick="switchTab('cafe24Orders')" class="btn btn-sm btn-secondary">ì „ì²´ë³´ê¸° â†’</button>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead><tr><th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ì£¼ë¬¸ì¼ì‹œ</th><th>ìˆ˜ë ¹ì¸</th><th>ì—°ë½ì²˜</th><th>ê²°ì œê¸ˆì•¡</th><th>ê²°ì œìƒíƒœ</th></tr></thead>
            <tbody>
              ${recentOrders.length === 0 ? '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-400);">ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í˜24ì—ì„œ ì—‘ì…€ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”.</td></tr>' : recentOrders.map(order => `
                <tr>
                  <td style="font-weight: 600; color: var(--info);">${order.order_id || '-'}</td>
                  <td>${order.order_date ? order.order_date.replace('T', ' ').substring(0, 16) : '-'}</td>
                  <td>${order.buyer_name || '-'}</td>
                  <td>${order.buyer_phone || '-'}</td>
                  <td style="font-weight: 600;">${formatNumber(order.total_amount)}ì›</td>
                  <td>${getCafe24PaymentStatusBadge(order.payment_status)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  } catch (err) {
    console.error('ì¹´í˜24 ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨:', err);
    app.innerHTML = `<div class="page-header"><h1 class="page-title">ğŸ“Š ì¹´í˜24 ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1></div><div class="card" style="text-align: center; padding: 60px;"><div style="font-size: 48px; margin-bottom: 16px;">âŒ</div><p style="color: var(--gray-500);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><button onclick="renderCafe24Dashboard()" class="btn btn-primary" style="margin-top: 16px;">ë‹¤ì‹œ ì‹œë„</button></div>`;
  }
}

// ì¹´í˜24 ì •ì‚° ì™„ë£Œ ì²˜ë¦¬
async function completeCafe24Settlement(period, amount, orderCount) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm(`${period} ì •ì‚°ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në§¤ì¶œ: ${formatNumber(amount)}ì›\nì£¼ë¬¸: ${orderCount}ê±´`)) return;
  
  try {
    await db.collection('cafe24_settlements').doc(period).set({
      period: period,
      amount: amount,
      orderCount: orderCount,
      status: 'completed',
      settledAt: new Date().toISOString(),
      createdAt: new Date().toISOString()
    });
    showToast(`âœ… ${period} ì •ì‚° ì™„ë£Œ!`);
    renderCafe24Dashboard();
  } catch (err) {
    console.error('ì •ì‚° ì²˜ë¦¬ ì‹¤íŒ¨:', err);
    showToast('âŒ ì •ì‚° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì¹´í˜24 ì…€ëŸ¬ë³„ ì •ì‚° ì™„ë£Œ (ê¸°ì¡´ ë§¤ì¶œê´€ë¦¬ì—ë„ ë“±ë¡)
async function completeCafe24SellerSettlement(period, sellerName, amount, orderCount, productType, supplierName) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm(`[${sellerName}] ${period} ì •ì‚°ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në§¤ì¶œ: ${formatNumber(amount)}ì›\nì£¼ë¬¸: ${orderCount}ê±´\nêµ¬ë¶„: ${productType === 'external' ? 'íƒ€ì‚¬ (' + supplierName + ')' : 'ìì‚¬'}`)) return;
  
  try {
    // 1. ì¹´í˜24 ì •ì‚° ê¸°ë¡
    const docId = `${period}_${sellerName}`;
    await db.collection('cafe24_settlements').doc(docId).set({
      period: period,
      seller_name: sellerName,
      supplier_name: supplierName || '',
      product_type: productType,
      amount: amount,
      orderCount: orderCount,
      status: 'completed',
      settledAt: new Date().toISOString(),
      createdAt: new Date().toISOString()
    });
    
    // 2. ê¸°ì¡´ ë§¤ì¶œê´€ë¦¬ ì‹œìŠ¤í…œ(sellerSettlements)ì—ë„ ë“±ë¡
    const existingSettlement = (state.sellerSettlements || []).find(s => 
      s.sellerName === sellerName && 
      s.period === period &&
      s.source === 'cafe24'
    );
    
    if (!existingSettlement) {
      await db.collection('sellerSettlements').add({
        sellerName: sellerName,
        brandName: supplierName || 'ìì‚¬',
        period: period,
        productType: productType, // 'inhouse' or 'external'
        salesCount: orderCount,
        totalSalesAmount: amount,
        source: 'cafe24', // ì¹´í˜24ì—ì„œ ë“±ë¡ë¨ì„ í‘œì‹œ
        isCompleted: true,
        completedAt: new Date().toISOString(),
        createdAt: new Date().toISOString()
      });
    }
    
    showToast(`âœ… [${sellerName}] ${period} ì •ì‚° ì™„ë£Œ! (ë§¤ì¶œê´€ë¦¬ì—ë„ ë“±ë¡ë¨)`);
    renderCafe24Dashboard();
  } catch (err) {
    console.error('ì •ì‚° ì²˜ë¦¬ ì‹¤íŒ¨:', err);
    showToast('âŒ ì •ì‚° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì¹´í˜24 ì…€ëŸ¬ë³„ ì •ì‚° ì·¨ì†Œ
async function cancelCafe24SellerSettlement(period, sellerName) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm(`[${sellerName}] ${period} ì •ì‚°ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
  
  try {
    // 1. ì¹´í˜24 ì •ì‚° ì‚­ì œ
    const docId = `${period}_${sellerName}`;
    await db.collection('cafe24_settlements').doc(docId).delete();
    
    // 2. ê¸°ì¡´ ë§¤ì¶œê´€ë¦¬ì—ì„œë„ ì‚­ì œ (cafe24 ì†ŒìŠ¤ì¸ ê²ƒë§Œ)
    const existingSettlement = (state.sellerSettlements || []).find(s => 
      s.sellerName === sellerName && 
      s.period === period &&
      s.source === 'cafe24'
    );
    if (existingSettlement) {
      await db.collection('sellerSettlements').doc(existingSettlement.id).delete();
    }
    
    showToast(`âš ï¸ [${sellerName}] ${period} ì •ì‚°ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    renderCafe24Dashboard();
  } catch (err) {
    console.error('ì •ì‚° ì·¨ì†Œ ì‹¤íŒ¨:', err);
    showToast('âŒ ì •ì‚° ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì¹´í˜24 ê³µê¸‰ì‚¬ë³„ ì •ì‚° ì™„ë£Œ (ê¸°ì¡´ ë§¤ì¶œê´€ë¦¬ì—ë„ ë“±ë¡)
async function completeCafe24SupplierSettlement(period, supplierName, amount, orderCount) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm(`[${supplierName}] ${period} ê³µê¸‰ì‚¬ ì •ì‚°ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në§¤ì¶œ: ${formatNumber(amount)}ì›\nì£¼ë¬¸: ${orderCount}ê±´`)) return;
  
  try {
    // 1. ì¹´í˜24 ê³µê¸‰ì‚¬ ì •ì‚° ê¸°ë¡
    const docId = `${period}_supplier_${supplierName}`;
    await db.collection('cafe24_settlements').doc(docId).set({
      period: period,
      supplier_name: supplierName,
      type: 'supplier',
      amount: amount,
      orderCount: orderCount,
      status: 'completed',
      settledAt: new Date().toISOString(),
      createdAt: new Date().toISOString()
    });
    
    // 2. ê¸°ì¡´ ë§¤ì¶œê´€ë¦¬ ì‹œìŠ¤í…œ(supplierSettlements)ì—ë„ ë“±ë¡
    const existingSupplierSettlement = (state.supplierSettlements || []).find(s => 
      s.brandName === supplierName && 
      s.period === period &&
      s.source === 'cafe24'
    );
    
    if (!existingSupplierSettlement) {
      await db.collection('supplierSettlements').add({
        brandName: supplierName,
        period: period,
        totalAmount: amount,
        orderCount: orderCount,
        source: 'cafe24',
        isCompleted: true,
        completedAt: new Date().toISOString(),
        createdAt: new Date().toISOString()
      });
    }
    
    showToast(`âœ… [${supplierName}] ${period} ê³µê¸‰ì‚¬ ì •ì‚° ì™„ë£Œ! (ë§¤ì¶œê´€ë¦¬ì—ë„ ë“±ë¡ë¨)`);
    renderCafe24Dashboard();
  } catch (err) {
    console.error('ì •ì‚° ì²˜ë¦¬ ì‹¤íŒ¨:', err);
    showToast('âŒ ì •ì‚° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì¹´í˜24 ê³µê¸‰ì‚¬ë³„ ì •ì‚° ì·¨ì†Œ
async function cancelCafe24SupplierSettlement(period, supplierName) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm(`[${supplierName}] ${period} ê³µê¸‰ì‚¬ ì •ì‚°ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
  
  try {
    // 1. ì¹´í˜24 ì •ì‚° ì‚­ì œ
    const docId = `${period}_supplier_${supplierName}`;
    await db.collection('cafe24_settlements').doc(docId).delete();
    
    // 2. ê¸°ì¡´ ë§¤ì¶œê´€ë¦¬ì—ì„œë„ ì‚­ì œ
    const existingSettlement = (state.supplierSettlements || []).find(s => 
      s.brandName === supplierName && 
      s.period === period &&
      s.source === 'cafe24'
    );
    if (existingSettlement) {
      await db.collection('supplierSettlements').doc(existingSettlement.id).delete();
    }
    
    showToast(`âš ï¸ [${supplierName}] ${period} ê³µê¸‰ì‚¬ ì •ì‚°ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    renderCafe24Dashboard();
  } catch (err) {
    console.error('ì •ì‚° ì·¨ì†Œ ì‹¤íŒ¨:', err);
    showToast('âŒ ì •ì‚° ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì¹´í˜24 ì •ì‚° ì·¨ì†Œ
async function cancelCafe24Settlement(period) {
 // ğŸ”’ ê¶Œí•œ ì²´í¬
 if (!canEdit()) { showNoPermission(); return; }
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  if (!confirm(`${period} ì •ì‚°ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  try {
    await db.collection('cafe24_settlements').doc(period).delete();
    showToast(`âš ï¸ ${period} ì •ì‚°ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    renderCafe24Dashboard();
  } catch (err) {
    console.error('ì •ì‚° ì·¨ì†Œ ì‹¤íŒ¨:', err);
    showToast('âŒ ì •ì‚° ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì¹´í˜24 ì •ì‚° ë‚´ì—­ ë³´ê¸°
async function showCafe24SettlementHistory() {
  try {
    const snapshot = await db.collection('cafe24_settlements').orderBy('period', 'desc').get();
    const settlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // ì…€ëŸ¬ ì •ì‚°ê³¼ ê³µê¸‰ì‚¬ ì •ì‚° ë¶„ë¦¬
    const sellerSettlements = settlements.filter(s => s.type !== 'supplier');
    const supplierSettlements = settlements.filter(s => s.type === 'supplier');
    
    const totalSellerAmount = sellerSettlements.reduce((sum, s) => sum + (s.amount || 0), 0);
    const totalSupplierAmount = supplierSettlements.reduce((sum, s) => sum + (s.amount || 0), 0);
    
    let html = `
      <div style="padding: 20px; max-height: 80vh; overflow-y: auto;">
        <h2 style="margin-bottom: 20px;">ğŸ“‹ ì¹´í˜24 ì •ì‚° ë‚´ì—­</h2>
        
        <!-- ì…€ëŸ¬ ì •ì‚° -->
        <div style="margin-bottom: 24px;">
          <div style="background: #dbeafe; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <div style="font-size: 14px; color: #1d4ed8;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚° ì™„ë£Œ ê¸ˆì•¡</div>
            <div style="font-size: 28px; font-weight: 700; color: #1e40af;">${formatNumber(totalSellerAmount)}ì›</div>
          </div>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: #f3f4f6;">
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">ì •ì‚°ì›”</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">ì…€ëŸ¬</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb;">êµ¬ë¶„</th>
                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">ë§¤ì¶œì•¡</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb;">ì •ì‚°ì¼</th>
              </tr>
            </thead>
            <tbody>
              ${sellerSettlements.length === 0 
                ? '<tr><td colspan="5" style="padding: 30px; text-align: center; color: #9ca3af;">ì…€ëŸ¬ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'
                : sellerSettlements.map(s => `
                  <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; font-weight: 600;">${s.period}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">${s.seller_name || '-'}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center;">
                      ${s.product_type === 'external' 
                        ? `<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 11px;">íƒ€ì‚¬</span>` 
                        : `<span style="background: #dbeafe; color: #1d4ed8; padding: 2px 8px; border-radius: 4px; font-size: 11px;">ìì‚¬</span>`}
                    </td>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #2563eb;">${formatNumber(s.amount)}ì›</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center;">${s.settledAt ? new Date(s.settledAt).toLocaleDateString('ko-KR') : '-'}</td>
                  </tr>
                `).join('')
              }
            </tbody>
          </table>
        </div>
        
        <!-- ê³µê¸‰ì‚¬ ì •ì‚° -->
        <div>
          <div style="background: #fef3c7; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <div style="font-size: 14px; color: #92400e;">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚° ì™„ë£Œ ê¸ˆì•¡</div>
            <div style="font-size: 28px; font-weight: 700; color: #b45309;">${formatNumber(totalSupplierAmount)}ì›</div>
          </div>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: #f3f4f6;">
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">ì •ì‚°ì›”</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">ê³µê¸‰ì‚¬</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb;">ì£¼ë¬¸ìˆ˜</th>
                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">ë§¤ì¶œì•¡</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb;">ì •ì‚°ì¼</th>
              </tr>
            </thead>
            <tbody>
              ${supplierSettlements.length === 0 
                ? '<tr><td colspan="5" style="padding: 30px; text-align: center; color: #9ca3af;">ê³µê¸‰ì‚¬ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'
                : supplierSettlements.map(s => `
                  <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; font-weight: 600;">${s.period}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">${s.supplier_name || '-'}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center;">${s.orderCount || '-'}ê±´</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #b45309;">${formatNumber(s.amount)}ì›</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center;">${s.settledAt ? new Date(s.settledAt).toLocaleDateString('ko-KR') : '-'}</td>
                  </tr>
                `).join('')
              }
            </tbody>
          </table>
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
          <button onclick="closeModal()" class="btn btn-secondary">ë‹«ê¸°</button>
        </div>
      </div>
    `;
    
    openModal('ì¹´í˜24 ì •ì‚° ë‚´ì—­', html);
  } catch (err) {
    console.error('ì •ì‚° ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', err);
    showToast('âŒ ì •ì‚° ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ì¹´í˜24 ì—‘ì…€ ì—…ë¡œë“œ ====================
async function uploadCafe24Excel(event) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); event.target.value = ''; return; }
  
  const file = event.target.files[0];
  if (!file) return;
  
  showToast('ğŸ“¤ íŒŒì¼ ì²˜ë¦¬ ì¤‘...');
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      let rows = [];
      const fileName = file.name.toLowerCase();
      
      if (fileName.endsWith('.csv')) {
        // CSV íŒŒì¼ ì²˜ë¦¬
        const text = e.target.result;
        rows = parseCSV(text);
      } else {
        // Excel íŒŒì¼ ì²˜ë¦¬
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(sheet);
      }
      
      if (rows.length === 0) {
        showToast('âŒ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      console.log('íŒŒì‹±ëœ ì²« í–‰:', rows[0]);
      console.log('ì´ í–‰ ìˆ˜:', rows.length);
      
      // ì£¼ë¬¸+ìƒí’ˆë³„ë¡œ ì €ì¥ (í–‰ë³„ë¡œ ê°œë³„ ì €ì¥)
      const orderMap = new Map();
      
      // ê¸°ì¡´ ê³µê¸‰ì‚¬ ëª©ë¡ì—ì„œ ìì‚¬/íƒ€ì‚¬ ë§¤í•‘ ìƒì„±
      const supplierTypeMap = {};
      (state.suppliers || []).forEach(s => {
        supplierTypeMap[s.name.trim().toLowerCase()] = s.supplierType || 'external';
      });
      
      console.log('ê³µê¸‰ì‚¬ íƒ€ì… ë§¤í•‘:', supplierTypeMap);
      
      let rowIndex = 0;
      for (const row of rows) {
        rowIndex++;
        
        // ì£¼ë¬¸ë²ˆí˜¸ ì°¾ê¸° (ì¹´í˜24 CSV í˜•ì‹)
        const orderId = row['ì£¼ë¬¸ë²ˆí˜¸'] || row['ì£¼ë¬¸ ë²ˆí˜¸'] || row['order_id'] || '';
        if (!orderId) continue;
        
        // ìƒí’ˆë²ˆí˜¸ (ì—†ìœ¼ë©´ í–‰ ì¸ë±ìŠ¤ ì‚¬ìš©)
        const productNo = row['ìƒí’ˆë²ˆí˜¸'] || rowIndex;
        
        // ğŸ”‘ ê³ ìœ í‚¤: ì£¼ë¬¸ë²ˆí˜¸_ìƒí’ˆë²ˆí˜¸ (í–‰ë³„ ê°œë³„ ì €ì¥)
        const docId = `${orderId}_${productNo}`;
        
        // ì¤‘ë³µ ì²´í¬ (ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ)
        if (orderMap.has(docId)) continue;
        
        // ê³µê¸‰ì‚¬ëª… ì¶”ì¶œ (ì•ë’¤ ê³µë°± ì œê±°) - ë‹¤ì–‘í•œ ì—‘ì…€ ì»¬ëŸ¼ëª… ì§€ì›
        const supplierName = (row['ê³µê¸‰ì‚¬'] || row['ê³µê¸‰ì‚¬ëª…'] || row['ê³µê¸‰ì—…ì²´'] || row['ê³µê¸‰ì²˜'] || row['ì—…ì²´ëª…'] || row['ê±°ë˜ì²˜'] || row['ë²¤ë”'] || '').trim();
        
        // ğŸ¯ ìì‚¬/íƒ€ì‚¬ êµ¬ë¶„: ê¸°ì¡´ ê³µê¸‰ì‚¬ DBì—ì„œ supplierType í™•ì¸
        const supplierKey = supplierName.toLowerCase();
        const dbSupplierType = supplierTypeMap[supplierKey];
        const productType = dbSupplierType === 'inhouse' ? 'inhouse' : 'external';
        
        // ì…€ëŸ¬ëª… ì¶”ì¶œ (ìƒí’ˆëª…(ê´€ë¦¬ìš©) ì»¬ëŸ¼)
        const rawSellerName = (row['ìƒí’ˆëª…(ê´€ë¦¬ìš©)'] || row['ê´€ë¦¬ìš© ìƒí’ˆëª…'] || '').trim();
        const sellerName = extractSellerName(rawSellerName);
        
        // ì£¼ë¬¸ë²ˆí˜¸ì—ì„œ ë‚ ì§œ ì¶”ì¶œ: 20251127-0000014 â†’ 2025-11-27
        let orderDate = '';
        if (orderId.length >= 8) {
          const dateStr = orderId.substring(0, 8);
          if (/^\d{8}$/.test(dateStr)) {
            orderDate = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}T00:00:00`;
          }
        }
        
        // ğŸ¯ ìˆ˜ëŸ‰ íŒŒì‹±
        const quantity = parseInt(row['ìˆ˜ëŸ‰'] || row['ì£¼ë¬¸ìˆ˜ëŸ‰'] || 1) || 1;
        
        // ğŸ¯ ë‹¨ê°€ íŒŒì‹±
        const unitPrice = parseCafe24Amount(row['íŒë§¤ê°€'] || row['ë‹¨ê°€'] || 0);
        
        // ê²°ì œê¸ˆì•¡ íŒŒì‹±
        const totalAmount = parseCafe24Amount(row['ì´ ê²°ì œê¸ˆì•¡(KRW)'] || row['ì´ ê²°ì œê¸ˆì•¡'] || row['ì´ì£¼ë¬¸ê¸ˆì•¡'] || 0);
        const orderAmount = parseCafe24Amount(row['ì´ ì£¼ë¬¸ê¸ˆì•¡(KRW)'] || row['ì´ ì£¼ë¬¸ê¸ˆì•¡'] || row['ì´ì£¼ë¬¸ê¸ˆì•¡'] || 0);

        // ê²°ì œìƒíƒœ (ê²°ì œê¸ˆì•¡ > 0 ì´ë©´ ê²°ì œì™„ë£Œ)
        const paymentStatus = totalAmount > 0 ? 'F' : 'T';

        // ìˆ˜ë ¹ì¸ ì •ë³´
        const buyerName = row['ìˆ˜ë ¹ì¸'] || row['ì£¼ë¬¸ìëª…'] || '';
        const buyerPhone = row['ìˆ˜ë ¹ì¸ íœ´ëŒ€ì „í™”'] || row['ì—°ë½ì²˜'] || '';

        // ìƒí’ˆëª…
        const productName = row['ì£¼ë¬¸ìƒí’ˆëª…(ê¸°ë³¸)'] || row['ì£¼ë¬¸ìƒí’ˆëª…'] || '';
        const productOption = row['ì£¼ë¬¸ìƒí’ˆëª…(ì˜µì…˜í¬í•¨)'] || '';
        
        // ğŸ¯ PGìˆ˜ìˆ˜ë£Œ ìë™ ê³„ì‚° (ì‹ ìš©ì¹´ë“œ = 4%)
        const paymentMethod = row['ê²°ì œìˆ˜ë‹¨'] || '';
        const isCard = paymentMethod.includes('ì¹´ë“œ') || paymentMethod.includes('ì‹ ìš©') || paymentMethod.toLowerCase().includes('card');
        const pgFeeRate = isCard ? 0.04 : 0; // ì¹´ë“œ 4%, ê·¸ ì™¸ 0%
        const pgFee = Math.round(totalAmount * pgFeeRate);
        
        orderMap.set(docId, {
          order_id: String(orderId),
          product_no: String(productNo),
          order_date: orderDate,
          supplier_name: supplierName,
          seller_name: sellerName,
          seller_full_name: rawSellerName,
          product_type: productType,
          buyer_name: buyerName,
          buyer_phone: buyerPhone,
          product_name: productName,
          product_option: productOption,
          quantity: quantity,           // ğŸ¯ ìˆ˜ëŸ‰!
          unit_price: unitPrice,        // ğŸ¯ ë‹¨ê°€!
          total_amount: totalAmount,    // ê²°ì œê¸ˆì•¡
          order_amount: orderAmount,    // ì£¼ë¬¸ê¸ˆì•¡
          payment_status: paymentStatus,
          payment_method: paymentMethod,
          pg_fee_rate: pgFeeRate,       // ğŸ¯ PGìˆ˜ìˆ˜ë£Œìœ¨ (0.04 = 4%)
          pg_fee: pgFee,                // ğŸ¯ PGìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡
          shipping_address: row['ìˆ˜ë ¹ì¸ ì£¼ì†Œ(ì „ì²´)'] || '',
          synced_at: new Date().toISOString()
        });
      }
      
      // Firebaseì— ì €ì¥
      let uploadedCount = 0;
      let errorCount = 0;
      
      for (const [docId, orderData] of orderMap) {
        try {
          await db.collection('cafe24_orders').doc(docId).set(orderData, { merge: true });
          uploadedCount++;
        } catch (rowErr) {
          console.error('ì €ì¥ ì˜¤ë¥˜:', rowErr);
          errorCount++;
        }
      }
      
      showToast(`âœ… ${uploadedCount}ê±´ ì—…ë¡œë“œ ì™„ë£Œ!` + (errorCount > 0 ? ` (${errorCount}ê±´ ì˜¤ë¥˜)` : ''));
      renderCafe24Dashboard();
      
    } catch (err) {
      console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', err);
      showToast('âŒ íŒŒì¼ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
    }
  };
  
  // CSVëŠ” í…ìŠ¤íŠ¸ë¡œ, Excelì€ ë°”ì´ë„ˆë¦¬ë¡œ ì½ê¸°
  if (file.name.toLowerCase().endsWith('.csv')) {
    reader.readAsText(file, 'UTF-8');
  } else {
    reader.readAsArrayBuffer(file);
  }
  event.target.value = '';
}

// CSV íŒŒì‹± í•¨ìˆ˜
function parseCSV(text) {
  const lines = text.split('\n');
  if (lines.length < 2) return [];
  
  // BOM ì œê±°
  let headerLine = lines[0].replace(/^\uFEFF/, '');
  const headers = parseCSVLine(headerLine);
  
  console.log('CSV í—¤ë”:', headers);
  
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    const values = parseCSVLine(line);
    const row = {};
    headers.forEach((header, idx) => {
      row[header.trim()] = values[idx] || '';
    });
    rows.push(row);
  }
  return rows;
}

// CSV ë¼ì¸ íŒŒì‹± (ë”°ì˜´í‘œ ì²˜ë¦¬)
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current);
  return result;
}

// ì¹´í˜24 ê¸ˆì•¡ íŒŒì‹±
function parseCafe24Amount(value) {
  if (!value) return 0;
  if (typeof value === 'number') return value;
  // "12500.00" ë˜ëŠ” "12,500ì›" í˜•ì‹ ì²˜ë¦¬
  const cleaned = String(value).replace(/[^0-9.-]/g, '');
  return parseFloat(cleaned) || 0;
}

// ì…€ëŸ¬ëª… ì¶”ì¶œ (ìƒí’ˆëª…(ê´€ë¦¬ìš©) ì»¬ëŸ¼ì—ì„œ)
// "ìµœì§„ì˜/í˜„ë¸Œë¡œë§˜(0.4ë§Œ)" â†’ "í˜„ë¸Œë¡œë§˜"
// "í˜„ë¸Œë¡œë§˜" â†’ "í˜„ë¸Œë¡œë§˜"
// "ì½”ì½”ë§˜(0.5ë§Œ)" â†’ "ì½”ì½”ë§˜"
function extractSellerName(raw) {
  if (!raw) return '';
  let name = String(raw).trim();
  
  // ìŠ¬ë˜ì‹œê°€ ìˆìœ¼ë©´ ë’¤ ë¶€ë¶„ ì‚¬ìš©
  if (name.includes('/')) {
    name = name.split('/')[1];
  }
  
  // ê´„í˜¸ê°€ ìˆìœ¼ë©´ ê´„í˜¸ ì•ê¹Œì§€ë§Œ
  if (name.includes('(')) {
    name = name.split('(')[0];
  }
  
  return name.trim();
}

// ì¹´í˜24 ì£¼ë¬¸ìƒíƒœ ë§¤í•‘
function mapCafe24OrderStatus(status) {
  if (!status) return 'N22';
  const s = String(status).trim();
  
  if (['N00', 'N10', 'N20', 'N21', 'N22', 'C00', 'C10'].includes(s)) return s;
  
  if (s.includes('ì…ê¸ˆì „') || s.includes('ì…ê¸ˆëŒ€ê¸°')) return 'N00';
  if (s.includes('ìƒí’ˆì¤€ë¹„')) return 'N10';
  if (s.includes('ë°°ì†¡ì¤€ë¹„')) return 'N20';
  if (s.includes('ë°°ì†¡ì¤‘')) return 'N21';
  if (s.includes('ë°°ì†¡ì™„ë£Œ')) return 'N22';
  if (s.includes('ì·¨ì†Œ')) return 'C00';
  
  return 'N22'; // ê¸°ë³¸ê°’
}

// ì¹´í˜24 ê²°ì œìƒíƒœ ë§¤í•‘
function mapCafe24PaymentStatus(status) {
  if (!status) return 'F';
  const s = String(status).trim();
  
  if (['F', 'T', 'M'].includes(s)) return s;
  
  if (s.includes('ê²°ì œì™„ë£Œ') || s.includes('ì…ê¸ˆì™„ë£Œ')) return 'F';
  if (s.includes('ì…ê¸ˆëŒ€ê¸°') || s.includes('ì…ê¸ˆì „')) return 'T';
  if (s.includes('ë¯¸ê²°ì œ')) return 'M';
  
  return 'F';
}

function getCafe24OrderStatusBadge(status) {
  const statusMap = { 'N00': { label: 'ì…ê¸ˆëŒ€ê¸°', color: '#d97706', bg: '#fef3c7' }, 'N10': { label: 'ìƒí’ˆì¤€ë¹„', color: '#2563eb', bg: '#dbeafe' }, 'N20': { label: 'ë°°ì†¡ì¤€ë¹„', color: '#4f46e5', bg: '#e0e7ff' }, 'N21': { label: 'ë°°ì†¡ì¤‘', color: '#059669', bg: '#d1fae5' }, 'N22': { label: 'ë°°ì†¡ì™„ë£Œ', color: '#16a34a', bg: '#dcfce7' }, 'C00': { label: 'ì·¨ì†Œ', color: '#dc2626', bg: '#fee2e2' } };
  const s = statusMap[status] || { label: status || '-', color: '#6b7280', bg: '#f3f4f6' };
  return `<span style="display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${s.bg}; color: ${s.color};">${s.label}</span>`;
}

function getCafe24PaymentStatusBadge(status) {
  const statusMap = { 'F': { label: 'ê²°ì œì™„ë£Œ', color: '#16a34a', bg: '#dcfce7' }, 'T': { label: 'ì…ê¸ˆëŒ€ê¸°', color: '#d97706', bg: '#fef3c7' }, 'M': { label: 'ë¯¸ê²°ì œ', color: '#dc2626', bg: '#fee2e2' } };
  const s = statusMap[status] || { label: status || '-', color: '#6b7280', bg: '#f3f4f6' };
  return `<span style="display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${s.bg}; color: ${s.color};">${s.label}</span>`;
}

// ==================== ìƒí’ˆ ë°ì´í„° í†µí•© ê´€ë¦¬ ====================
async function renderProductDataManager() {
  const app = document.getElementById('app');
  app.innerHTML = '<div style="text-align: center; padding: 60px;"><div class="loading"></div><p style="margin-top: 16px; color: var(--gray-500);">ìƒí’ˆ ë°ì´í„° ë¡œë”© ì¤‘...</p></div>';

  try {
    // 1. cafe24 ì£¼ë¬¸ ë¡œë“œ
    const ordersSnapshot = await db.collection('cafe24_orders').orderBy('order_date', 'desc').limit(2000).get();
    const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // 2. ê³µêµ¬(deals) ë¡œë“œ
    const dealsSnapshot = await db.collection('deals').get();
    const deals = dealsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // 3. ì…€ëŸ¬ ë¡œë“œ
    const sellersSnapshot = await db.collection('sellers').get();
    const sellers = sellersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // 4. ê³µê¸‰ì‚¬ ë¡œë“œ
    const suppliersSnapshot = await db.collection('suppliers').get();
    const suppliers = suppliersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // 4-1. ê³µê¸‰ì‚¬ ìƒí’ˆ ë¡œë“œ
    const supplierProductsSnapshot = await db.collection('supplierProducts').get();
    const supplierProducts = supplierProductsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // 5. ì…€ëŸ¬ë³„ ìƒí’ˆ ê·¸ë£¹í™”
    const productGroups = {};
    orders.forEach(order => {
      const sellerName = order.seller_name || '(ë¯¸ì§€ì •)';
      const productName = order.product_option || order.product_name || '(ìƒí’ˆëª…ì—†ìŒ)';
      const key = `${sellerName}___${productName}`;

      if (!productGroups[key]) {
        productGroups[key] = {
          sellerName,
          productName,
          supplierName: order.supplier_name || '',
          productType: order.product_type || 'inhouse',
          marginRate: Number(order.margin_rate) || 0,
          supplyPrice: Number(order.supply_price) || 0,
          unitPrice: Number(order.unit_price) || 0,
          quantity: 0,
          totalAmount: 0,
          orderCount: 0,
          orderIds: [],
          // ê³µêµ¬ ë§¤ì¹­ ì •ë³´
          matchedDeal: null,
          matchedDealId: '',
          // ì €ì¥ëœ SKU ë§¤ì¹­ ì •ë³´
          savedMatchedSku: order.matched_sku || ''
        };
      }
      // ì €ì¥ëœ SKUê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
      if (order.matched_sku && !productGroups[key].savedMatchedSku) {
        productGroups[key].savedMatchedSku = order.matched_sku;
      }
      productGroups[key].quantity += Number(order.quantity) || 1;
      productGroups[key].totalAmount += Number(order.total_amount) || 0;
      productGroups[key].orderCount += 1;
      productGroups[key].orderIds.push(order.id);

      // ë‹¨ê°€ ì—…ë°ì´íŠ¸ (ìµœì‹  ê°’ ì‚¬ìš©)
      if (!productGroups[key].unitPrice && order.unit_price) {
        productGroups[key].unitPrice = Number(order.unit_price);
      }
    });

    // 6. ê³µêµ¬ ìƒí’ˆ ëª©ë¡ ìƒì„± (selectedProducts ê¸°ë°˜)
    const dealProducts = [];
    deals.forEach(deal => {
      if (deal.selectedProducts && deal.selectedProducts.length > 0) {
        const supplierInfo = suppliers.find(s => s.id === deal.supplierId);
        deal.selectedProducts.forEach(sp => {
          // ê³µê¸‰ê°€: ìƒí’ˆDB ìš°ì„  ì¡°íšŒ (ìµœì‹  ë°ì´í„°) > ì €ì¥ëœ ê°’ > 0
          const productDbMatch = supplierProducts.find(p =>
            p.id === sp.productId ||
            (p.productName && sp.productName && p.productName === sp.productName)
          );
          const productDbSupplyPrice = productDbMatch ? Number(productDbMatch.supplyPrice) || 0 : 0;
          const savedSupplyPrice = Number(sp.supplyPrice) || 0;
          // ìƒí’ˆDB ê°’ ìš°ì„  ì‚¬ìš© (ìƒí’ˆDBê°€ ìµœì‹  ë°ì´í„°)
          const finalSupplyPrice = productDbSupplyPrice || savedSupplyPrice || 0;

          dealProducts.push({
            dealId: deal.id,
            dealTitle: deal.title || '',
            sellerId: deal.sellerId,
            sellerName: sellers.find(s => s.id === deal.sellerId)?.name || '',
            supplierId: deal.supplierId || '',
            supplierName: supplierInfo?.name || sp.brandName || 'ë¯¸ì§€ì •',
            productName: sp.productName || sp.name || '',
            sku: sp.sku || sp.productName || '',
            supplyPrice: finalSupplyPrice,
            marginRate: Number(sp.marginRate) || Number(deal.sellerMarginRate) || 0
          });
        });
      }
    });

    // 7. ê³µêµ¬ì™€ ë§¤ì¹­
    Object.values(productGroups).forEach(group => {
      group.dataSource = 'cafe24'; // ë°ì´í„° ì¶œì²˜ í‘œì‹œ

      // ì…€ëŸ¬ëª…ìœ¼ë¡œ ê³µêµ¬ ì°¾ê¸°
      const seller = sellers.find(s =>
        s.nickname?.toLowerCase() === group.sellerName.toLowerCase() ||
        s.name?.toLowerCase().includes(group.sellerName.toLowerCase())
      );

      if (seller) {
        const matchedDeal = deals.find(d => d.sellerId === seller.id);
        if (matchedDeal) {
          group.matchedDeal = matchedDeal;
          group.matchedDealId = matchedDeal.id;

          // ê³µêµ¬ì˜ selectedProductsì—ì„œ ë§ˆì§„ìœ¨/ê³µê¸‰ë‹¨ê°€ ê°€ì ¸ì˜¤ê¸°
          if (matchedDeal.selectedProducts?.length > 0) {
            const sp = matchedDeal.selectedProducts[0];
            if (!group.marginRate) group.marginRate = Number(sp.marginRate) || 0;
            if (!group.supplyPrice) group.supplyPrice = Number(sp.supplyPrice) || 0;
          }
          if (!group.marginRate) group.marginRate = Number(matchedDeal.sellerMarginRate) || 10;
        }
      }
    });

    // ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ì •ë ¬
    const productList = Object.values(productGroups).sort((a, b) => b.totalAmount - a.totalAmount);

    // í†µê³„
    const totalProducts = productList.length;
    const totalOrders = orders.length;
    const totalSales = productList.reduce((sum, p) => sum + p.totalAmount, 0);
    const productsWithMargin = productList.filter(p => p.marginRate > 0).length;
    const productsWithSupply = productList.filter(p => p.supplyPrice > 0).length;

    app.innerHTML = `
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <div>
          <h1 class="page-title" style="display: flex; align-items: center; gap: 12px;">
            ğŸ“‹ ìƒí’ˆ ë°ì´í„° ê´€ë¦¬
            <span style="font-size: 14px; font-weight: 500; background: #dbeafe; color: #1d4ed8; padding: 4px 12px; border-radius: 20px;">${totalProducts}ê°œ ìƒí’ˆ</span>
          </h1>
          <p style="color: var(--gray-500); font-size: 13px; margin-top: 4px;">ì¹´í˜24 ì£¼ë¬¸ê³¼ ê³µêµ¬ ë°ì´í„°ë¥¼ í†µí•©í•˜ì—¬ ë§ˆì§„ìœ¨/ê³µê¸‰ë‹¨ê°€ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="renderProductDataManager()" class="btn btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          <button onclick="saveAllProductData()" class="btn btn-primary">ğŸ’¾ ì „ì²´ ì €ì¥</button>
        </div>
      </div>

      <!-- í†µê³„ ì¹´ë“œ -->
      <div class="stats-row" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 24px;">
        <div class="stat-card">
          <div class="stat-label">ì´ ìƒí’ˆ</div>
          <div class="stat-value" style="font-size: 24px;">${totalProducts}ê°œ</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì´ ì£¼ë¬¸ìˆ˜</div>
          <div class="stat-value" style="font-size: 24px;">${totalOrders.toLocaleString()}ê±´</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì´ íŒë§¤ì•¡</div>
          <div class="stat-value" style="font-size: 24px;">${totalSales.toLocaleString()}ì›</div>
        </div>
        <div class="stat-card" style="background: ${productsWithMargin === totalProducts ? '#dcfce7' : '#fef3c7'};">
          <div class="stat-label">ë§ˆì§„ìœ¨ ì„¤ì •</div>
          <div class="stat-value" style="font-size: 24px; color: ${productsWithMargin === totalProducts ? '#166534' : '#92400e'};">${productsWithMargin}/${totalProducts}</div>
        </div>
        <div class="stat-card" style="background: ${productsWithSupply === totalProducts ? '#dcfce7' : '#fef3c7'};">
          <div class="stat-label">ê³µê¸‰ë‹¨ê°€ ì„¤ì •</div>
          <div class="stat-value" style="font-size: 24px; color: ${productsWithSupply === totalProducts ? '#166534' : '#92400e'};">${productsWithSupply}/${totalProducts}</div>
        </div>
      </div>

      <!-- í•„í„° -->
      <div class="card" style="margin-bottom: 16px; padding: 16px;">
        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
          <select id="pdm-filter-type" onchange="filterProductData()" class="form-input" style="width: auto; min-width: 120px;">
            <option value="all">ì „ì²´</option>
            <option value="inhouse">ìì‚¬</option>
            <option value="external">íƒ€ì‚¬</option>
          </select>
          <select id="pdm-filter-status" onchange="filterProductData()" class="form-input" style="width: auto; min-width: 150px;">
            <option value="all">ì „ì²´ ìƒíƒœ</option>
            <option value="no-margin">ë§ˆì§„ìœ¨ ë¯¸ì„¤ì •</option>
            <option value="no-supply">ê³µê¸‰ë‹¨ê°€ ë¯¸ì„¤ì •</option>
            <option value="complete">ì„¤ì • ì™„ë£Œ</option>
          </select>
          <input type="text" id="pdm-search" placeholder="ì…€ëŸ¬ëª…/ìƒí’ˆëª… ê²€ìƒ‰..." class="form-input" style="width: 200px;" oninput="filterProductData()">
          <span style="color: var(--gray-500); font-size: 13px;">| í‘œì‹œ: <span id="pdm-filtered-count">${totalProducts}</span>ê°œ</span>
        </div>
      </div>

      <!-- ë²”ë¡€ -->
      <div style="display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; font-size: 12px;">
        <div style="display: flex; align-items: center; gap: 6px;">
          <span style="display: inline-block; width: 14px; height: 14px; background: #dbeafe; border-radius: 3px;"></span>
          <span>ì¹´í˜24 ì£¼ë¬¸ë°ì´í„°</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <span style="display: inline-block; width: 14px; height: 14px; background: #f0fdf4; border: 1px solid #22c55e; border-radius: 3px;"></span>
          <span>ê³µêµ¬DB ë§¤ì¹­</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <span style="display: inline-block; width: 14px; height: 14px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 3px;"></span>
          <span style="font-weight: 600; color: #1d4ed8;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚°</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <span style="display: inline-block; width: 14px; height: 14px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 3px;"></span>
          <span style="font-weight: 600; color: #92400e;">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚°</span>
        </div>
      </div>

      <!-- ìƒí’ˆ í…Œì´ë¸” -->
      <div class="card" style="padding: 0; overflow: hidden;">
        <div style="overflow-x: auto;">
          <table class="data-table" id="pdm-table" style="margin: 0;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="width: 40px; text-align: center;">#</th>
                <th style="width: 70px; text-align: center; background: #dbeafe;">ì¶œì²˜</th>
                <th style="min-width: 80px; background: #dbeafe;">ì…€ëŸ¬ëª…<br><span style="font-size:9px;color:#6b7280;font-weight:400;">ì¹´í˜24</span></th>
                <th style="min-width: 150px; background: #dbeafe;">ìƒí’ˆëª…<br><span style="font-size:9px;color:#6b7280;font-weight:400;">ì¹´í˜24 ì£¼ë¬¸</span></th>
                <th style="min-width: 140px; background: #f0fdf4;">ê³µêµ¬ SKU<br><span style="font-size:9px;color:#16a34a;font-weight:400;">ê³µêµ¬DB ë§¤ì¹­</span></th>
                <th style="width: 70px; text-align: center; background: #f0fdf4;">ê³µê¸‰ì‚¬<br><span style="font-size:9px;color:#16a34a;font-weight:400;">ê³µêµ¬DB</span></th>
                <th style="width: 50px; text-align: center; background: #dbeafe;">êµ¬ë¶„</th>
                <th style="width: 70px; text-align: right; background: #dbeafe;">íŒë§¤ë‹¨ê°€</th>
                <th style="width: 45px; text-align: center; background: #dbeafe;">ìˆ˜ëŸ‰</th>
                <th style="width: 80px; text-align: right; background: #dbeafe;">íŒë§¤ê¸ˆì•¡</th>
                <th colspan="3" style="text-align: center; background: #dbeafe; border: 2px solid #3b82f6; border-bottom: none;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚°</th>
                <th colspan="3" style="text-align: center; background: #fef3c7; border: 2px solid #f59e0b; border-bottom: none;">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚°</th>
                <th style="width: 60px; text-align: center;">ìƒíƒœ</th>
              </tr>
              <tr style="background: var(--gray-50);">
                <th colspan="10"></th>
                <th style="width: 60px; text-align: center; background: #eff6ff; border-left: 2px solid #3b82f6;">ë§ˆì§„ìœ¨(%)<br><span style="font-size:8px;color:#1d4ed8;">ê³µêµ¬ì •ë³´</span></th>
                <th style="width: 80px; text-align: right; background: #eff6ff;">ë§ˆì§„ê¸ˆì•¡<br><span style="font-size:8px;color:#1d4ed8;">ìë™ê³„ì‚°</span></th>
                <th style="width: 70px; text-align: right; background: #eff6ff; border-right: 2px solid #3b82f6;">ì…€ëŸ¬ì§€ê¸‰<br><span style="font-size:8px;color:#1d4ed8;">-3.3%</span></th>
                <th style="width: 60px; text-align: center; background: #fef9c3; border-left: 2px solid #f59e0b;">ìˆ˜ìˆ˜ë£Œ(%)<br><span style="font-size:8px;color:#92400e;">ìƒí’ˆDB</span></th>
                <th style="width: 80px; text-align: right; background: #fef9c3;">ê³µê¸‰ê°€(V+)<br><span style="font-size:8px;color:#92400e;">ìƒí’ˆDB</span></th>
                <th style="width: 80px; text-align: right; background: #fef9c3; border-right: 2px solid #f59e0b;">ê³µê¸‰ê°€ì•¡<br><span style="font-size:8px;color:#92400e;">ìë™ê³„ì‚°</span></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="pdm-tbody">
              ${productList.map((p, idx) => {
                const marginAmount = Math.round(p.totalAmount * p.marginRate / 100);
                const supplyTotal = p.supplyPrice * p.quantity;
                const isComplete = p.marginRate > 0 && (p.productType === 'inhouse' || p.supplyPrice > 0);
                const statusBadge = isComplete
                  ? '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:10px;font-size:11px;">âœ“ ì™„ë£Œ</span>'
                  : '<span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:11px;">âš  ë¯¸ì™„ë£Œ</span>';

                // í•´ë‹¹ ì…€ëŸ¬ì˜ ê³µêµ¬ ìƒí’ˆ ëª©ë¡ (ìœ ì—°í•œ ë§¤ì¹­)
                const normalizeSellerName = (name) => (name || '').toLowerCase().replace(/[^ê°€-í£a-z0-9]/g, '');
                const pSellerNorm = normalizeSellerName(p.sellerName);

                let sellerDealProducts = dealProducts.filter(dp => {
                  const dpSellerNorm = normalizeSellerName(dp.sellerName);
                  // ì •í™•í•œ ë§¤ì¹­ ë˜ëŠ” í¬í•¨ ê´€ê³„
                  return dpSellerNorm === pSellerNorm ||
                         dpSellerNorm.includes(pSellerNorm) ||
                         pSellerNorm.includes(dpSellerNorm);
                });

                // ë§¤ì¹­ë˜ëŠ” ìƒí’ˆì´ ì—†ìœ¼ë©´ ì „ì²´ ê³µêµ¬ ìƒí’ˆ ëª©ë¡ ì œê³µ
                const showAllProducts = sellerDealProducts.length === 0;
                if (showAllProducts) {
                  sellerDealProducts = dealProducts;
                }

                // ìƒí’ˆëª… ìœ ì‚¬ë„ ê³„ì‚° í•¨ìˆ˜
                const getSimilarity = (str1, str2) => {
                  const s1 = str1.toLowerCase().replace(/[^ê°€-í£a-z0-9]/g, '');
                  const s2 = str2.toLowerCase().replace(/[^ê°€-í£a-z0-9]/g, '');
                  if (s1 === s2) return 1;
                  if (s1.includes(s2) || s2.includes(s1)) return 0.8;
                  // ê³µí†µ ë‹¨ì–´ ë¹„ìœ¨
                  const words1 = s1.split(/\s+/);
                  const words2 = s2.split(/\s+/);
                  let matches = 0;
                  words1.forEach(w => { if (s2.includes(w) && w.length > 1) matches++; });
                  return matches / Math.max(words1.length, 1);
                };

                // ìë™ ë§¤ì¹­: ì €ì¥ëœ SKU ìš°ì„ , ì—†ìœ¼ë©´ ìœ ì‚¬ë„ ê¸°ë°˜
                let bestMatch = null;
                let bestScore = 0;

                // 1. ì €ì¥ëœ SKUê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
                if (p.savedMatchedSku) {
                  bestMatch = sellerDealProducts.find(dp => dp.sku === p.savedMatchedSku);
                  if (bestMatch) bestScore = 1;
                }

                // 2. ì €ì¥ëœ SKUê°€ ì—†ê±°ë‚˜ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ìœ ì‚¬ë„ ê¸°ë°˜ ë§¤ì¹­
                if (!bestMatch) {
                  sellerDealProducts.forEach(dp => {
                    const score = getSimilarity(p.productName, dp.productName || dp.sku);
                    if (score > bestScore && score >= 0.3) {
                      bestScore = score;
                      bestMatch = dp;
                    }
                  });
                }

                // ê³µêµ¬ ìƒí’ˆ ë§¤ì¹­ ë“œë¡­ë‹¤ìš´ ìƒì„±
                let dealProductOptions = '<option value="">ì„ íƒ...</option>';
                sellerDealProducts.forEach(dp => {
                  const isAutoMatched = bestMatch && dp.sku === bestMatch.sku;
                  const selected = isAutoMatched ? 'selected' : '';
                  const sellerLabel = showAllProducts ? ` [${dp.sellerName}]` : '';
                  dealProductOptions += `<option value="${dp.sku}" data-supply="${dp.supplyPrice}" data-margin="${dp.marginRate}" data-supplier="${dp.supplierName || ''}" ${selected}>
                    ${dp.sku}${sellerLabel} (${dp.supplyPrice.toLocaleString()}ì›)
                  </option>`;
                });

                // ìë™ ë§¤ì¹­ëœ ê²½ìš° ê°’ ì ìš©
                const autoMatchedMargin = bestMatch ? bestMatch.marginRate : p.marginRate;
                const autoMatchedSupply = bestMatch ? bestMatch.supplyPrice : p.supplyPrice;

                // ìë™ ë§¤ì¹­ëœ ê°’ìœ¼ë¡œ ê³„ì‚°
                const finalMargin = autoMatchedMargin || p.marginRate;
                const finalSupply = autoMatchedSupply || p.supplyPrice;
                const finalMarginAmount = Math.round(p.totalAmount * finalMargin / 100);
                const finalSupplyTotal = finalSupply * p.quantity;
                const finalIsComplete = finalMargin > 0 && (p.productType === 'inhouse' || finalSupply > 0);
                const finalStatusBadge = finalIsComplete
                  ? '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:10px;font-size:11px;">âœ“ ì™„ë£Œ</span>'
                  : '<span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:11px;">âš  ë¯¸ì™„ë£Œ</span>';

                // ìë™ ë§¤ì¹­ í‘œì‹œ ìŠ¤íƒ€ì¼
                const selectStyle = bestMatch
                  ? 'width: 100%; font-size: 11px; border: 2px solid #22c55e; border-radius: 4px; padding: 3px; background: #f0fdf4;'
                  : 'width: 100%; font-size: 11px; border: 1px solid #d1d5db; border-radius: 4px; padding: 3px;';

                let autoMatchLabel = '';
                const isSavedMatch = p.savedMatchedSku && bestMatch?.sku === p.savedMatchedSku;
                if (sellerDealProducts.length === 0 && dealProducts.length === 0) {
                  autoMatchLabel = '<div style="font-size: 9px; color: #9ca3af;">ê³µêµ¬ ì—†ìŒ</div>';
                } else if (isSavedMatch) {
                  autoMatchLabel = '<div style="font-size: 9px; color: #3b82f6; margin-top: 1px;">ğŸ’¾ ì €ì¥ë¨</div>';
                } else if (bestMatch) {
                  autoMatchLabel = '<div style="font-size: 9px; color: #16a34a; margin-top: 1px;">âœ“ ìë™</div>';
                } else if (showAllProducts) {
                  autoMatchLabel = '<div style="font-size: 9px; color: #f59e0b;">ì „ì²´ ëª©ë¡</div>';
                }

                // ê³µê¸‰ì‚¬ëª… ê°€ì ¸ì˜¤ê¸°
                const supplierName = bestMatch?.supplierName || '-';

                // ê³µê¸‰ì‚¬ ìˆ˜ìˆ˜ë£Œìœ¨ (ìƒí’ˆDBì—ì„œ ì¡°íšŒ)
                const matchedSupplierProduct = supplierProducts.find(sp =>
                  (sp.productName && p.productName && sp.productName.includes(p.productName.split(' ')[0])) ||
                  (bestMatch && sp.productName === bestMatch.productName)
                );
                const commissionRate = matchedSupplierProduct?.commission || 0;

                // ì…€ëŸ¬ ì •ì‚° ê³„ì‚°
                const sellerMarginAmount = finalMarginAmount;
                const sellerWithholdingTax = Math.round(sellerMarginAmount * 0.033);
                const sellerPayment = sellerMarginAmount - sellerWithholdingTax;

                // ê³µê¸‰ì‚¬ ì •ì‚° ê³„ì‚°
                const supplyAmount = finalSupply * p.quantity;

                return `
                  <tr data-idx="${idx}" data-key="${p.sellerName}___${p.productName}" data-type="${p.productType}">
                    <td style="text-align: center; color: var(--gray-500); font-size: 10px;">${idx + 1}</td>
                    <td style="text-align: center; background: #eff6ff;">
                      <span style="background: #dbeafe; color: #1d4ed8; padding: 2px 5px; border-radius: 6px; font-size: 9px;">ì¹´í˜24</span>
                    </td>
                    <td style="font-weight: 600; font-size: 11px; background: #eff6ff;">${p.sellerName}</td>
                    <td style="font-size: 10px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; background: #eff6ff;" title="${p.productName}">${p.productName}</td>
                    <td style="background: #f0fdf4;">
                      <select class="pdm-deal-product-select" data-key="${p.sellerName}___${p.productName}"
                        style="${selectStyle}"
                        onchange="matchDealProduct(this)" ${dealProducts.length === 0 ? 'disabled' : ''}>
                        ${dealProductOptions}
                      </select>
                      ${autoMatchLabel}
                    </td>
                    <td style="font-size: 10px; background: #f0fdf4; color: #166534; text-align: center;" class="pdm-supplier-name">${supplierName}</td>
                    <td style="text-align: center; background: #eff6ff;">
                      <span style="background: ${p.productType === 'external' ? '#fef3c7' : '#dbeafe'}; color: ${p.productType === 'external' ? '#92400e' : '#1d4ed8'}; padding: 2px 5px; border-radius: 6px; font-size: 9px;">
                        ${p.productType === 'external' ? 'íƒ€ì‚¬' : 'ìì‚¬'}
                      </span>
                    </td>
                    <td style="text-align: right; font-size: 10px; background: #eff6ff;">${p.unitPrice.toLocaleString()}</td>
                    <td style="text-align: center; font-size: 10px; background: #eff6ff;">${p.quantity}</td>
                    <td style="text-align: right; font-weight: 600; font-size: 10px; background: #eff6ff;">${p.totalAmount.toLocaleString()}</td>
                    <!-- ì…€ëŸ¬ ì •ì‚° -->
                    <td style="text-align: center; background: #eff6ff; border-left: 2px solid #3b82f6; font-size: 10px;">
                      <input type="number" class="pdm-margin-input" data-key="${p.sellerName}___${p.productName}"
                        value="${finalMargin}" step="0.1" min="0" max="100"
                        style="width: 45px; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px; padding: 2px; font-size: 10px;${bestMatch ? ' background: #dcfce7;' : ''}"
                        onchange="updateProductCalc(this)">
                    </td>
                    <td style="text-align: right; background: #eff6ff; font-weight: 600; color: #1d4ed8; font-size: 10px;" class="pdm-margin-amount">
                      ${sellerMarginAmount.toLocaleString()}
                    </td>
                    <td style="text-align: right; background: #eff6ff; border-right: 2px solid #3b82f6; font-size: 10px; color: #059669;" class="pdm-seller-payment">
                      ${sellerPayment.toLocaleString()}
                    </td>
                    <!-- ê³µê¸‰ì‚¬ ì •ì‚° -->
                    <td style="text-align: center; background: #fef9c3; border-left: 2px solid #f59e0b; font-size: 10px;" class="pdm-commission">
                      ${commissionRate > 0 ? commissionRate + '%' : '-'}
                    </td>
                    <td style="text-align: right; background: #fef9c3; font-size: 10px;">
                      <input type="number" class="pdm-supply-input" data-key="${p.sellerName}___${p.productName}"
                        value="${finalSupply}" step="100" min="0"
                        style="width: 65px; text-align: right; border: 1px solid #e5e7eb; border-radius: 4px; padding: 2px; font-size: 10px;${bestMatch ? ' background: #dcfce7;' : ''}"
                        onchange="updateProductCalc(this)" ${p.productType === 'inhouse' ? 'disabled placeholder="ìì‚¬"' : ''}>
                    </td>
                    <td style="text-align: right; background: #fef9c3; border-right: 2px solid #f59e0b; font-weight: 600; color: #b45309; font-size: 10px;" class="pdm-supply-amount">
                      ${p.productType === 'external' ? supplyAmount.toLocaleString() : '-'}
                    </td>
                    <td style="text-align: center;">${finalStatusBadge}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>

      <!-- ì•ˆë‚´ -->
      <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
        <div style="font-weight: 600; color: #334155; margin-bottom: 12px;">ğŸ’¡ ì»¬ëŸ¼ ì„¤ëª…</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; font-size: 12px;">
          <div style="background: #eff6ff; padding: 10px; border-radius: 8px;">
            <div style="font-weight: 600; color: #1d4ed8; margin-bottom: 4px;">ğŸ“¦ ì¹´í˜24 ë°ì´í„°</div>
            <div style="color: #4b5563;">ì…€ëŸ¬ëª…, ìƒí’ˆëª…, êµ¬ë¶„, ë‹¨ê°€, ìˆ˜ëŸ‰, ê¸ˆì•¡</div>
            <div style="color: #6b7280; font-size: 11px; margin-top: 2px;">â†’ ì¹´í˜24 ì£¼ë¬¸ì—ì„œ ìë™ ìˆ˜ì§‘</div>
          </div>
          <div style="background: #f0fdf4; padding: 10px; border-radius: 8px;">
            <div style="font-weight: 600; color: #16a34a; margin-bottom: 4px;">ğŸ”— ê³µêµ¬DB ë§¤ì¹­</div>
            <div style="color: #4b5563;">ê³µêµ¬ SKU, ê³µê¸‰ì‚¬</div>
            <div style="color: #6b7280; font-size: 11px; margin-top: 2px;">â†’ ìƒí’ˆëª… ìœ ì‚¬ë„ ìë™ë§¤ì¹­</div>
          </div>
          <div style="background: #eff6ff; padding: 10px; border-radius: 8px; border: 2px solid #3b82f6;">
            <div style="font-weight: 600; color: #1d4ed8; margin-bottom: 4px;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚°</div>
            <div style="color: #4b5563;">ë§ˆì§„ìœ¨(ê³µêµ¬ì •ë³´), ë§ˆì§„ê¸ˆì•¡, ì…€ëŸ¬ì§€ê¸‰</div>
            <div style="color: #6b7280; font-size: 11px; margin-top: 2px;">â†’ ê³µêµ¬í˜„í™©ì˜ ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ì ìš©</div>
          </div>
          <div style="background: #fef9c3; padding: 10px; border-radius: 8px; border: 2px solid #f59e0b;">
            <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚°</div>
            <div style="color: #4b5563;">ìˆ˜ìˆ˜ë£Œ(ìƒí’ˆDB), ê³µê¸‰ê°€(V+), ê³µê¸‰ê°€ì•¡</div>
            <div style="color: #6b7280; font-size: 11px; margin-top: 2px;">â†’ ìƒí’ˆDBì˜ ìˆ˜ìˆ˜ë£Œìœ¨/ê³µê¸‰ê°€ ì ìš©</div>
          </div>
        </div>
      </div>
    `;

    // ì „ì—­ì— ë°ì´í„° ì €ì¥
    window.pdmProductList = productList;
    window.pdmOrders = orders;
    window.pdmDealProducts = dealProducts;

  } catch (err) {
    console.error(err);
    app.innerHTML = `<div class="card" style="text-align: center; padding: 60px;"><div style="font-size: 48px; margin-bottom: 16px;">âŒ</div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><button onclick="renderProductDataManager()" class="btn btn-primary" style="margin-top: 16px;">ë‹¤ì‹œ ì‹œë„</button></div>`;
  }
}

// ìƒí’ˆ ë°ì´í„° í•„í„°ë§
function filterProductData() {
  const typeFilter = document.getElementById('pdm-filter-type')?.value || 'all';
  const statusFilter = document.getElementById('pdm-filter-status')?.value || 'all';
  const searchText = (document.getElementById('pdm-search')?.value || '').toLowerCase();

  const rows = document.querySelectorAll('#pdm-tbody tr');
  let visibleCount = 0;

  rows.forEach(row => {
    const type = row.dataset.type;
    const key = row.dataset.key || '';
    const marginInput = row.querySelector('.pdm-margin-input');
    const supplyInput = row.querySelector('.pdm-supply-input');
    const marginRate = Number(marginInput?.value) || 0;
    const supplyPrice = Number(supplyInput?.value) || 0;

    let visible = true;

    // íƒ€ì… í•„í„°
    if (typeFilter !== 'all' && type !== typeFilter) visible = false;

    // ìƒíƒœ í•„í„°
    if (statusFilter === 'no-margin' && marginRate > 0) visible = false;
    if (statusFilter === 'no-supply' && (type === 'inhouse' || supplyPrice > 0)) visible = false;
    if (statusFilter === 'complete') {
      if (marginRate === 0 || (type === 'external' && supplyPrice === 0)) visible = false;
    }

    // ê²€ìƒ‰ í•„í„°
    if (searchText && !key.toLowerCase().includes(searchText)) visible = false;

    row.style.display = visible ? '' : 'none';
    if (visible) visibleCount++;
  });

  document.getElementById('pdm-filtered-count').textContent = visibleCount;
}

// ë§ˆì§„/ê³µê¸‰ë‹¨ê°€ ë³€ê²½ ì‹œ ê³„ì‚° ì—…ë°ì´íŠ¸
function updateProductCalc(input) {
  const row = input.closest('tr');
  const key = input.dataset.key;
  const product = window.pdmProductList?.find(p => `${p.sellerName}___${p.productName}` === key);
  if (!product) return;

  const marginInput = row.querySelector('.pdm-margin-input');
  const supplyInput = row.querySelector('.pdm-supply-input');
  const marginAmountCell = row.querySelector('.pdm-margin-amount');
  const sellerPaymentCell = row.querySelector('.pdm-seller-payment');
  const supplyAmountCell = row.querySelector('.pdm-supply-amount');

  const marginRate = Number(marginInput?.value) || 0;
  const supplyPrice = Number(supplyInput?.value) || 0;

  // ë§ˆì§„ê¸ˆì•¡ ê³„ì‚°
  const marginAmount = Math.round(product.totalAmount * marginRate / 100);
  if (marginAmountCell) marginAmountCell.textContent = marginAmount.toLocaleString();

  // ì…€ëŸ¬ ì§€ê¸‰ì•¡ ê³„ì‚° (ë§ˆì§„ê¸ˆì•¡ - 3.3% ì›ì²œì§•ìˆ˜)
  const withholdingTax = Math.round(marginAmount * 0.033);
  const sellerPayment = marginAmount - withholdingTax;
  if (sellerPaymentCell) sellerPaymentCell.textContent = sellerPayment.toLocaleString();

  // ê³µê¸‰ê°€ì•¡ ê³„ì‚° (íƒ€ì‚¬ë§Œ)
  if (product.productType === 'external' && supplyAmountCell) {
    const supplyAmount = supplyPrice * product.quantity;
    supplyAmountCell.textContent = supplyAmount.toLocaleString();
  }

  // ì…ë ¥ í•„ë“œ ë°°ê²½ìƒ‰ ë³€ê²½ (ìˆ˜ì •ë¨ í‘œì‹œ)
  input.style.background = '#fef9c3';
}

// ê³µêµ¬ ìƒí’ˆ ë§¤ì¹­ ì‹œ ê³µê¸‰ë‹¨ê°€/ë§ˆì§„ìœ¨ ìë™ ì…ë ¥
function matchDealProduct(select) {
  const selectedOption = select.options[select.selectedIndex];
  const row = select.closest('tr');
  const key = select.dataset.key;
  const product = window.pdmProductList?.find(p => `${p.sellerName}___${p.productName}` === key);
  if (!product) return;

  // ì„ íƒ ì•ˆí•¨ì¸ ê²½ìš°
  if (!selectedOption || !selectedOption.value) {
    select.style.border = '1px solid #d1d5db';
    select.style.background = '';
    const label = select.parentElement.querySelector('div');
    if (label && label.textContent.includes('ìë™ë§¤ì¹­')) {
      label.remove();
    }
    return;
  }

  // ì„ íƒí•œ ê³µêµ¬ ìƒí’ˆì˜ ê³µê¸‰ë‹¨ê°€ì™€ ë§ˆì§„ìœ¨ ê°€ì ¸ì˜¤ê¸°
  const supplyPrice = Number(selectedOption.dataset.supply) || 0;
  const marginRate = Number(selectedOption.dataset.margin) || 0;

  // ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
  const marginInput = row.querySelector('.pdm-margin-input');
  const supplyInput = row.querySelector('.pdm-supply-input');

  if (marginInput) {
    marginInput.value = marginRate;
    marginInput.style.background = '#fef9c3'; // ë…¸ë€ìƒ‰ ë°°ê²½ (ìˆ˜ë™ ìˆ˜ì •ë¨ í‘œì‹œ)
  }

  if (supplyInput && !supplyInput.disabled) {
    supplyInput.value = supplyPrice;
    supplyInput.style.background = '#fef9c3'; // ë…¸ë€ìƒ‰ ë°°ê²½ (ìˆ˜ë™ ìˆ˜ì •ë¨ í‘œì‹œ)
  }

  // ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ ë³€ê²½ (ìˆ˜ë™ ì„ íƒ í‘œì‹œ)
  select.style.border = '2px solid #f59e0b';
  select.style.background = '#fefce8';
  const existingLabel = select.parentElement.querySelector('div');
  if (existingLabel && (existingLabel.textContent.includes('ìë™') || existingLabel.textContent.includes('ìˆ˜ë™'))) {
    existingLabel.textContent = 'âœ ìˆ˜ë™';
    existingLabel.style.color = '#d97706';
  }

  // ê³µê¸‰ì‚¬ëª… ì—…ë°ì´íŠ¸
  const supplierNameFromOption = selectedOption.dataset.supplier || '';
  const selectedSku = selectedOption.value;
  const matchedDealProduct = window.pdmDealProducts?.find(dp => dp.sku === selectedSku);
  const supplierNameCell = row.querySelector('.pdm-supplier-name');
  if (supplierNameCell) {
    supplierNameCell.textContent = supplierNameFromOption || matchedDealProduct?.supplierName || '-';
  }

  // ê³„ì‚° ì—…ë°ì´íŠ¸
  const marginAmountCell = row.querySelector('.pdm-margin-amount');
  const sellerPaymentCell = row.querySelector('.pdm-seller-payment');
  const supplyAmountCell = row.querySelector('.pdm-supply-amount');

  const marginAmount = Math.round(product.totalAmount * marginRate / 100);
  if (marginAmountCell) marginAmountCell.textContent = marginAmount.toLocaleString();

  // ì…€ëŸ¬ ì§€ê¸‰ì•¡ ê³„ì‚° (ë§ˆì§„ê¸ˆì•¡ - 3.3% ì›ì²œì§•ìˆ˜)
  const withholdingTax = Math.round(marginAmount * 0.033);
  const sellerPayment = marginAmount - withholdingTax;
  if (sellerPaymentCell) sellerPaymentCell.textContent = sellerPayment.toLocaleString();

  // ê³µê¸‰ê°€ì•¡ ê³„ì‚° (íƒ€ì‚¬ë§Œ)
  if (product.productType === 'external' && supplyAmountCell) {
    const supplyAmount = supplyPrice * product.quantity;
    supplyAmountCell.textContent = supplyAmount.toLocaleString();
  }

  // ìƒíƒœ ì—…ë°ì´íŠ¸
  const statusCell = row.querySelector('td:last-child');
  const isComplete = marginRate > 0 && (product.productType === 'inhouse' || supplyPrice > 0);
  statusCell.innerHTML = isComplete
    ? '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:10px;font-size:11px;">âœ“ ì™„ë£Œ</span>'
    : '<span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:11px;">âš  ë¯¸ì™„ë£Œ</span>';

  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
  showToast(`SKU ë§¤ì¹­: ${selectedOption.value} (ê³µê¸‰ê°€ ${supplyPrice.toLocaleString()}ì›, ë§ˆì§„ìœ¨ ${marginRate}%)`, 'success');
}

// ì „ì²´ ì €ì¥
async function saveAllProductData() {
  if (!canEdit()) { showNoPermission(); return; }

  const rows = document.querySelectorAll('#pdm-tbody tr');
  const updates = [];

  rows.forEach(row => {
    const key = row.querySelector('.pdm-margin-input')?.dataset.key;
    if (!key) return;

    const product = window.pdmProductList?.find(p => `${p.sellerName}___${p.productName}` === key);
    if (!product) return;

    const marginRate = Number(row.querySelector('.pdm-margin-input')?.value) || 0;
    const supplyPrice = Number(row.querySelector('.pdm-supply-input')?.value) || 0;
    const skuSelect = row.querySelector('.pdm-deal-product-select');
    const matchedSku = skuSelect?.value || '';
    const supplierName = row.querySelector('.pdm-supplier-name')?.textContent || '';

    // ë³€ê²½ëœ ê²½ìš°ë§Œ ì—…ë°ì´íŠ¸
    if (marginRate !== product.marginRate || supplyPrice !== product.supplyPrice || matchedSku) {
      product.orderIds.forEach(orderId => {
        updates.push({
          orderId,
          marginRate,
          supplyPrice: product.productType === 'external' ? supplyPrice : 0,
          matchedSku,
          supplierName: supplierName !== '-' ? supplierName : ''
        });
      });
    }
  });

  if (updates.length === 0) {
    showToast('ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
    return;
  }

  if (!confirm(`${updates.length}ê±´ì˜ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  try {
    showToast('ì €ì¥ ì¤‘...', 'info');

    // Firestore ë°°ì¹˜ ì—…ë°ì´íŠ¸
    const batchSize = 500;
    for (let i = 0; i < updates.length; i += batchSize) {
      const batch = db.batch();
      const chunk = updates.slice(i, i + batchSize);

      chunk.forEach(u => {
        const ref = db.collection('cafe24_orders').doc(u.orderId);
        batch.update(ref, {
          margin_rate: u.marginRate,
          supply_price: u.supplyPrice,
          matched_sku: u.matchedSku,
          supplier_name: u.supplierName,
          updatedAt: new Date().toISOString()
        });
      });

      await batch.commit();
    }

    showToast(`âœ… ${updates.length}ê±´ ì €ì¥ ì™„ë£Œ! ì •ì‚°ì„œì— ë°˜ì˜ë©ë‹ˆë‹¤.`, 'success');

    // ìƒˆë¡œê³ ì¹¨
    setTimeout(() => renderProductDataManager(), 500);

  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ==================== ìƒí’ˆë°ì´í„°ì—ì„œ ì •ì‚°ì„œ ìƒì„± ====================
async function generateSettlementFromProductData() {
  if (!canEdit()) { showNoPermission(); return; }

  // ê¸°ê°„ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
  const modal = document.getElementById('modal');
  const today = new Date();
  const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
  const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>âœ¨ ì •ì‚°ì„œ ìƒì„±</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="background: #f0fdf4; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #22c55e;">
          <div style="font-weight: 600; color: #166534; margin-bottom: 8px;">ğŸ“‹ ì •ì‚°ì„œ ìƒì„± ì•ˆë‚´</div>
          <div style="font-size: 13px; color: #4b5563;">
            ìƒí’ˆë°ì´í„°ê´€ë¦¬ì—ì„œ ì €ì¥ëœ ë§ˆì§„ìœ¨/ê³µê¸‰ê°€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ<br>
            ì…€ëŸ¬ë³„/ê³µê¸‰ì‚¬ë³„ ì •ì‚°ì„œë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="form-row" style="margin-bottom: 16px;">
          <div class="form-group" style="flex: 1;">
            <label class="form-label">ì‹œì‘ì¼</label>
            <input type="date" id="gen-start-date" class="form-input" value="${firstDayOfMonth}">
          </div>
          <div class="form-group" style="flex: 1;">
            <label class="form-label">ì¢…ë£Œì¼</label>
            <input type="date" id="gen-end-date" class="form-input" value="${lastDayOfMonth}">
          </div>
        </div>

        <div id="gen-preview" style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="text-align: center; color: #9ca3af; padding: 20px;">
            ê¸°ê°„ì„ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤
          </div>
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="previewSettlementGeneration()" class="btn btn-secondary" style="flex: 1;">
            ğŸ” ë¯¸ë¦¬ë³´ê¸°
          </button>
          <button onclick="executeSettlementGeneration()" class="btn btn-primary" style="flex: 1; background: #22c55e;">
            âœ¨ ì •ì‚°ì„œ ìƒì„±
          </button>
        </div>
      </div>
    </div>
  `;
  modal.classList.add('show');
}

// ì •ì‚°ì„œ ìƒì„± ë¯¸ë¦¬ë³´ê¸°
async function previewSettlementGeneration() {
  const startDate = document.getElementById('gen-start-date').value;
  const endDate = document.getElementById('gen-end-date').value;
  const previewEl = document.getElementById('gen-preview');

  if (!startDate || !endDate) {
    showToast('ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
    return;
  }

  previewEl.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div></div>';

  try {
    // cafe24_ordersì—ì„œ ê¸°ê°„ ë‚´ ì €ì¥ëœ ë°ì´í„° ì¡°íšŒ
    const ordersSnapshot = await db.collection('cafe24_orders')
      .where('order_date', '>=', startDate)
      .where('order_date', '<=', endDate)
      .get();

    const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // ë§ˆì§„ìœ¨ì´ ì„¤ì •ëœ ì£¼ë¬¸ë§Œ í•„í„°
    const validOrders = orders.filter(o => Number(o.margin_rate) > 0 || Number(o.supply_price) > 0);

    if (validOrders.length === 0) {
      previewEl.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #dc2626;">
          <div style="font-size: 24px; margin-bottom: 8px;">âš ï¸</div>
          í•´ë‹¹ ê¸°ê°„ì— ì €ì¥ëœ ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
          <span style="font-size: 12px; color: #6b7280;">ë¨¼ì € ìƒí’ˆë°ì´í„°ê´€ë¦¬ì—ì„œ ë§ˆì§„ìœ¨/ê³µê¸‰ê°€ë¥¼ ì„¤ì • í›„ ì €ì¥í•´ì£¼ì„¸ìš”.</span>
        </div>
      `;
      return;
    }

    // ì…€ëŸ¬ë³„ ì§‘ê³„
    const sellerStats = {};
    const supplierStats = {}; // ê³µê¸‰ì‚¬ë³„ ì§‘ê³„ ì¶”ê°€

    validOrders.forEach(o => {
      const sellerName = o.seller_name || 'ë¯¸ì§€ì •';
      const supplierName = o.supplier_name || '';
      const productType = o.product_type || 'inhouse';
      const qty = Number(o.quantity) || 1;
      const amount = Number(o.total_amount) || 0;
      const marginRate = Number(o.margin_rate) || 0;
      const supplyPrice = Number(o.supply_price) || 0;
      const productName = o.product_name || 'ìƒí’ˆëª… ì—†ìŒ';

      // ì…€ëŸ¬ë³„ ì§‘ê³„
      if (!sellerStats[sellerName]) {
        sellerStats[sellerName] = {
          orderCount: 0,
          totalQuantity: 0,
          totalAmount: 0,
          marginAmount: 0,
          supplyAmount: 0,
          productType: productType,
          products: {}
        };
      }
      sellerStats[sellerName].orderCount += 1;
      sellerStats[sellerName].totalQuantity += qty;
      sellerStats[sellerName].totalAmount += amount;
      sellerStats[sellerName].marginAmount += Math.round(amount * marginRate / 100);
      sellerStats[sellerName].supplyAmount += supplyPrice * qty;

      // ìƒí’ˆë³„ ì§‘ê³„
      if (!sellerStats[sellerName].products[productName]) {
        sellerStats[sellerName].products[productName] = { quantity: 0, amount: 0, marginRate, supplyPrice };
      }
      sellerStats[sellerName].products[productName].quantity += qty;
      sellerStats[sellerName].products[productName].amount += amount;

      // ê³µê¸‰ì‚¬ë³„ ì§‘ê³„ (íƒ€ì‚¬ ìƒí’ˆë§Œ)
      if (productType === 'external' && supplierName) {
        if (!supplierStats[supplierName]) {
          supplierStats[supplierName] = {
            orderCount: 0,
            totalQuantity: 0,
            supplyAmount: 0,
            products: {}
          };
        }
        supplierStats[supplierName].orderCount += 1;
        supplierStats[supplierName].totalQuantity += qty;
        supplierStats[supplierName].supplyAmount += supplyPrice * qty;

        if (!supplierStats[supplierName].products[productName]) {
          supplierStats[supplierName].products[productName] = { quantity: 0, supplyPrice };
        }
        supplierStats[supplierName].products[productName].quantity += qty;
      }
    });

    const sellerCount = Object.keys(sellerStats).length;
    const supplierCount = Object.keys(supplierStats).length;
    const totalAmount = Object.values(sellerStats).reduce((sum, s) => sum + s.totalAmount, 0);
    const totalMargin = Object.values(sellerStats).reduce((sum, s) => sum + s.marginAmount, 0);
    const totalSupply = Object.values(supplierStats).reduce((sum, s) => sum + s.supplyAmount, 0);

    previewEl.innerHTML = `
      <div style="margin-bottom: 16px;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px;">
          <div style="background: #dbeafe; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 10px; color: #1d4ed8;">ğŸ‘¤ ì…€ëŸ¬</div>
            <div style="font-size: 18px; font-weight: 700; color: #1e40af;">${sellerCount}ëª…</div>
          </div>
          <div style="background: #fef3c7; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 10px; color: #92400e;">ğŸ­ ê³µê¸‰ì‚¬</div>
            <div style="font-size: 18px; font-weight: 700; color: #b45309;">${supplierCount}ê³³</div>
          </div>
          <div style="background: #dcfce7; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 10px; color: #166534;">ì´ ë§¤ì¶œì•¡</div>
            <div style="font-size: 18px; font-weight: 700; color: #15803d;">${totalAmount.toLocaleString()}</div>
          </div>
          <div style="background: #ede9fe; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 10px; color: #7c3aed;">ì…€ëŸ¬ ë§ˆì§„</div>
            <div style="font-size: 18px; font-weight: 700; color: #6d28d9;">${totalMargin.toLocaleString()}</div>
          </div>
        </div>

        <!-- ì…€ëŸ¬ ì •ì‚° -->
        <div style="margin-bottom: 16px; padding: 12px; background: #eff6ff; border-radius: 8px; border: 2px solid #3b82f6;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1d4ed8;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚° (${sellerCount}ê±´)</div>
          <div style="max-height: 120px; overflow-y: auto;">
            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
              <thead>
                <tr style="background: #dbeafe;">
                  <th style="padding: 6px; text-align: left;">ì…€ëŸ¬ëª…</th>
                  <th style="padding: 6px; text-align: right;">ë§¤ì¶œì•¡</th>
                  <th style="padding: 6px; text-align: right;">ë§ˆì§„ê¸ˆì•¡</th>
                  <th style="padding: 6px; text-align: right;">ì§€ê¸‰ì•¡(-3.3%)</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(sellerStats).map(([name, s]) => {
                  const payment = s.marginAmount - Math.round(s.marginAmount * 0.033);
                  return `
                  <tr>
                    <td style="padding: 6px;">${name}</td>
                    <td style="padding: 6px; text-align: right;">${s.totalAmount.toLocaleString()}</td>
                    <td style="padding: 6px; text-align: right; color: #1d4ed8;">${s.marginAmount.toLocaleString()}</td>
                    <td style="padding: 6px; text-align: right; color: #059669; font-weight: 600;">${payment.toLocaleString()}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- ê³µê¸‰ì‚¬ ì •ì‚° -->
        ${supplierCount > 0 ? `
        <div style="padding: 12px; background: #fef9c3; border-radius: 8px; border: 2px solid #f59e0b;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #92400e;">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚° (${supplierCount}ê±´)</div>
          <div style="max-height: 120px; overflow-y: auto;">
            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
              <thead>
                <tr style="background: #fde68a;">
                  <th style="padding: 6px; text-align: left;">ê³µê¸‰ì‚¬ëª…</th>
                  <th style="padding: 6px; text-align: right;">ìˆ˜ëŸ‰</th>
                  <th style="padding: 6px; text-align: right;">ê³µê¸‰ê°€ì•¡</th>
                  <th style="padding: 6px; text-align: right;">VAT ë³„ë„</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(supplierStats).map(([name, s]) => {
                  const vatExcluded = Math.round(s.supplyAmount / 1.1);
                  return `
                  <tr>
                    <td style="padding: 6px;">${name}</td>
                    <td style="padding: 6px; text-align: right;">${s.totalQuantity}ê°œ</td>
                    <td style="padding: 6px; text-align: right; color: #92400e;">${s.supplyAmount.toLocaleString()}</td>
                    <td style="padding: 6px; text-align: right; color: #b45309; font-weight: 600;">${vatExcluded.toLocaleString()}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
        ` : '<div style="padding: 12px; background: #f3f4f6; border-radius: 8px; text-align: center; color: #6b7280; font-size: 12px;">íƒ€ì‚¬ ìƒí’ˆì´ ì—†ì–´ ê³µê¸‰ì‚¬ ì •ì‚°ì´ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>'}
      </div>
    `;

    // ì „ì—­ì— ì €ì¥ (ìƒì„± ì‹œ ì‚¬ìš©)
    window.settlementPreviewData = { startDate, endDate, sellerStats, supplierStats, validOrders };

  } catch (err) {
    console.error(err);
    previewEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc2626;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
  }
}

// ì •ì‚°ì„œ ì‹¤ì œ ìƒì„±
async function executeSettlementGeneration() {
  if (!canEdit()) { showNoPermission(); return; }

  const previewData = window.settlementPreviewData;
  if (!previewData || !previewData.sellerStats) {
    showToast('ë¨¼ì € ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”');
    return;
  }

  const sellerCount = Object.keys(previewData.sellerStats).length;
  const supplierCount = Object.keys(previewData.supplierStats || {}).length;

  if (!confirm(`ì…€ëŸ¬ ${sellerCount}ê±´, ê³µê¸‰ì‚¬ ${supplierCount}ê±´ì˜ ì •ì‚°ì„œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }

  try {
    const { startDate, endDate, sellerStats, supplierStats, validOrders } = previewData;
    const period = `${startDate}~${endDate}`;
    const today = new Date().toISOString().split('T')[0];
    let sellerCreatedCount = 0;
    let supplierCreatedCount = 0;

    // 1. ì…€ëŸ¬ë³„ ì •ì‚°ì„œ ìƒì„±
    for (const [sellerName, stats] of Object.entries(sellerStats)) {
      // ìƒí’ˆë³„ ìƒì„¸ ë°ì´í„°
      const salesItems = Object.entries(stats.products).map(([productName, p]) => ({
        productName,
        quantity: p.quantity,
        amount: p.amount,
        marginRate: p.marginRate,
        supplyPrice: p.supplyPrice || 0,
        marginAmount: Math.round(p.amount * p.marginRate / 100)
      }));

      // ì…€ëŸ¬ ì •ë³´ ì°¾ê¸°
      const seller = state.sellers?.find(s =>
        s.name === sellerName ||
        s.nickname?.toLowerCase() === sellerName.toLowerCase()
      );

      // ê¸°ì¡´ ì •ì‚°ì„œ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
      const existingQuery = await db.collection('sellerSettlements')
        .where('sellerName', '==', sellerName)
        .where('dealPeriod', '==', period)
        .where('source', '==', 'productData')
        .get();

      const withholdingTax = Math.round(stats.marginAmount * 0.033);
      const actualPayment = stats.marginAmount - withholdingTax;

      if (!existingQuery.empty) {
        // ê¸°ì¡´ ì •ì‚°ì„œ ì—…ë°ì´íŠ¸
        const docId = existingQuery.docs[0].id;
        await db.collection('sellerSettlements').doc(docId).update({
          salesItems,
          totalQuantity: stats.totalQuantity,
          salesAmount: stats.totalAmount,
          marginAmount: stats.marginAmount,
          supplyAmount: stats.supplyAmount,
          withholdingTax,
          actualPayment,
          productType: stats.productType,
          updatedAt: new Date().toISOString()
        });
      } else {
        // ìƒˆ ì •ì‚°ì„œ ìƒì„±
        await db.collection('sellerSettlements').add({
          type: 'seller',
          sellerName,
          sellerId: seller?.id || '',
          brandName: '-',
          productType: stats.productType,
          dealPeriod: period,
          salesItems,
          totalQuantity: stats.totalQuantity,
          salesAmount: stats.totalAmount,
          marginAmount: stats.marginAmount,
          supplyAmount: stats.supplyAmount,
          withholdingTax,
          actualPayment,
          settlementDate: today,
          isCompleted: false,
          isSellerCompleted: false,
          source: 'productData',
          createdAt: new Date().toISOString(),
          createdBy: 'generateSettlementFromProductData'
        });
      }
      sellerCreatedCount++;
    }

    // 2. ê³µê¸‰ì‚¬ë³„ ì •ì‚°ì„œ ìƒì„± (íƒ€ì‚¬ ìƒí’ˆ)
    for (const [supplierName, stats] of Object.entries(supplierStats || {})) {
      // ìƒí’ˆë³„ ìƒì„¸ ë°ì´í„°
      const supplyItems = Object.entries(stats.products).map(([productName, p]) => ({
        productName,
        quantity: p.quantity,
        supplyPrice: p.supplyPrice || 0,
        supplyAmount: (p.supplyPrice || 0) * p.quantity
      }));

      // ê³µê¸‰ì‚¬ ì •ë³´ ì°¾ê¸°
      const supplier = state.suppliers?.find(s => s.name === supplierName);

      // ê¸°ì¡´ ì •ì‚°ì„œ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
      const existingQuery = await db.collection('supplierSettlements')
        .where('supplierName', '==', supplierName)
        .where('dealPeriod', '==', period)
        .where('source', '==', 'productData')
        .get();

      const totalSupplyAmount = stats.supplyAmount;
      const vatAmount = Math.round(totalSupplyAmount / 11); // VAT
      const supplyAmountExVat = totalSupplyAmount - vatAmount;

      if (!existingQuery.empty) {
        // ê¸°ì¡´ ì •ì‚°ì„œ ì—…ë°ì´íŠ¸
        const docId = existingQuery.docs[0].id;
        await db.collection('supplierSettlements').doc(docId).update({
          supplyItems,
          totalQuantity: stats.totalQuantity,
          supplyAmount: totalSupplyAmount,
          supplyAmountExVat,
          vatAmount,
          updatedAt: new Date().toISOString()
        });
      } else {
        // ìƒˆ ì •ì‚°ì„œ ìƒì„±
        await db.collection('supplierSettlements').add({
          type: 'supplier',
          supplierName,
          supplierId: supplier?.id || '',
          dealPeriod: period,
          supplyItems,
          totalQuantity: stats.totalQuantity,
          supplyAmount: totalSupplyAmount,
          supplyAmountExVat,
          vatAmount,
          settlementDate: today,
          isCompleted: false,
          source: 'productData',
          createdAt: new Date().toISOString(),
          createdBy: 'generateSettlementFromProductData'
        });
      }
      supplierCreatedCount++;
    }

    showToast(`âœ… ì…€ëŸ¬ ${sellerCreatedCount}ê±´, ê³µê¸‰ì‚¬ ${supplierCreatedCount}ê±´ ì •ì‚°ì„œ ìƒì„± ì™„ë£Œ!`, 'success');
    closeModal();

    // ì •ì‚°ê´€ë¦¬ ìƒˆë¡œê³ ì¹¨
    if (typeof renderSalesManagement === 'function') {
      setTimeout(() => renderSalesManagement(), 500);
    }

  } catch (err) {
    console.error(err);
    showToast('ì •ì‚°ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ==================== ì¹´í˜24 ì£¼ë¬¸ ê´€ë¦¬ ====================
async function renderCafe24Orders() {
  const app = document.getElementById('app');
  app.innerHTML = '<div style="text-align: center; padding: 60px;"><div class="loading"></div><p style="margin-top: 16px; color: var(--gray-500);">ì£¼ë¬¸ ë°ì´í„° ë¡œë”© ì¤‘...</p></div>';
  try {
    const ordersSnapshot = await db.collection('cafe24_orders').orderBy('order_date', 'desc').limit(500).get();
    const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    state.cafe24Orders = orders;
    state.cafe24FilteredOrders = orders;
    state.cafe24OrdersPage = 1;
    state.cafe24SelectedOrders = []; // ì„ íƒ ì´ˆê¸°í™”
    renderCafe24OrdersUI();
  } catch (err) {
    app.innerHTML = `<div class="page-header"><h1 class="page-title">ğŸ“¦ ì¹´í˜24 ì£¼ë¬¸ ê´€ë¦¬</h1></div><div class="card" style="text-align: center; padding: 60px;"><div style="font-size: 48px; margin-bottom: 16px;">âŒ</div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><button onclick="renderCafe24Orders()" class="btn btn-primary" style="margin-top: 16px;">ë‹¤ì‹œ ì‹œë„</button></div>`;
  }
}

function renderCafe24OrdersUI() {
  const app = document.getElementById('app');
  const orders = state.cafe24FilteredOrders || [];
  const allOrders = state.cafe24Orders || [];
  const currentPage = state.cafe24OrdersPage || 1;
  const perPage = 20;
  const totalPages = Math.ceil(orders.length / perPage);
  const pageOrders = orders.slice((currentPage - 1) * perPage, currentPage * perPage);
  
  // ì…€ëŸ¬/ê³µê¸‰ì‚¬ ëª©ë¡ ì¶”ì¶œ
  const sellers = [...new Set(allOrders.map(o => o.seller_name).filter(Boolean))].sort();
  const suppliers = [...new Set(allOrders.map(o => o.supplier_name).filter(Boolean))].sort();
  
  // ì„ íƒëœ í•­ëª© ìˆ˜
  const selectedCount = (state.cafe24SelectedOrders || []).length;
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ“¦ ì¹´í˜24 ì£¼ë¬¸ ê´€ë¦¬</h1>
      <p style="color: var(--gray-500); margin-top: 4px;">ì´ ${orders.length}ê±´ì˜ ì£¼ë¬¸</p>
    </div>
    <div class="card" style="margin-bottom: 16px;">
      <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
        <div style="flex: 1; min-width: 200px;"><input type="text" id="cafe24OrderSearch" placeholder="ì£¼ë¬¸ë²ˆí˜¸, ìˆ˜ë ¹ì¸, ì—°ë½ì²˜ ê²€ìƒ‰..." style="width: 100%; padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" onkeyup="filterCafe24Orders()"></div>
        <select id="cafe24SellerFilter" onchange="filterCafe24Orders()" style="padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
          <option value="">ì „ì²´ ì…€ëŸ¬</option>
          ${sellers.map(s => `<option value="${s}">${s}</option>`).join('')}
        </select>
        <select id="cafe24SupplierFilter" onchange="filterCafe24Orders()" style="padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
          <option value="">ì „ì²´ ë¸Œëœë“œ</option>
          ${suppliers.map(s => `<option value="${s}">${s}</option>`).join('')}
        </select>
        <select id="cafe24ProductTypeFilter" onchange="filterCafe24Orders()" style="padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
          <option value="">ì „ì²´ êµ¬ë¶„</option>
          <option value="inhouse">ìì‚¬</option>
          <option value="external">íƒ€ì‚¬</option>
        </select>
        <select id="cafe24DateFilter" onchange="filterCafe24Orders()" style="padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;"><option value="">ì „ì²´ ê¸°ê°„</option><option value="today">ì˜¤ëŠ˜</option><option value="week">ì´ë²ˆ ì£¼</option><option value="month">ì´ë²ˆ ë‹¬</option><option value="3months">ìµœê·¼ 3ê°œì›”</option></select>
        <button onclick="renderCafe24Orders()" class="btn btn-secondary">ğŸ”„</button>
        <button onclick="exportCafe24OrdersToExcel()" class="btn btn-primary">ğŸ“¥ Excel</button>
      </div>
      
      <!-- ì„ íƒ ì‚­ì œ ì˜ì—­ -->
      <div style="display: flex; gap: 12px; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200);">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="cafe24SelectAll" onchange="toggleCafe24SelectAll()" style="width: 18px; height: 18px; cursor: pointer;">
          <span style="font-size: 13px; color: var(--gray-600);">ì „ì²´ì„ íƒ</span>
        </label>
        <span style="font-size: 13px; color: var(--gray-500);">|</span>
        <span style="font-size: 13px; color: var(--primary); font-weight: 600;">${selectedCount}ê±´ ì„ íƒë¨</span>
        <div style="flex: 1;"></div>
        <button onclick="deleteSelectedCafe24Orders()" class="btn btn-sm" style="background: #fee2e2; color: #dc2626;" ${selectedCount === 0 ? 'disabled' : ''}>ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ (${selectedCount})</button>
        <button onclick="deleteAllCafe24Orders()" class="btn btn-sm" style="background: #ef4444; color: white;">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
      </div>
    </div>

    <!-- ëª¨ë°”ì¼ ë¹ ë¥¸ í•„í„° -->
    <div class="mobile-quick-filters">
      <div class="mobile-filter-chip" data-filter-type="date" data-filter-value="" onclick="applyMobileQuickFilter('date', '')">ì „ì²´</div>
      <div class="mobile-filter-chip active" data-filter-type="date" data-filter-value="today" onclick="applyMobileQuickFilter('date', 'today')">ì˜¤ëŠ˜</div>
      <div class="mobile-filter-chip" data-filter-type="date" data-filter-value="week" onclick="applyMobileQuickFilter('date', 'week')">ì´ë²ˆ ì£¼</div>
      <div class="mobile-filter-chip" data-filter-type="date" data-filter-value="month" onclick="applyMobileQuickFilter('date', 'month')">ì´ë²ˆ ë‹¬</div>
    </div>

    <!-- ë°ìŠ¤í¬í†± í…Œì´ë¸”ë·° -->
    <div class="card desktop-table-view">
      <div class="table-wrapper">
        <table class="data-table">
          <thead><tr>
            <th style="width: 40px;"><input type="checkbox" id="cafe24SelectAllTable" onchange="toggleCafe24SelectAll()" ${pageOrders.length > 0 && pageOrders.every(o => (state.cafe24SelectedOrders || []).includes(o.order_id + '_' + o.product_no)) ? 'checked' : ''}></th>
            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
            <th>ì£¼ë¬¸ì¼</th>
            <th>êµ¬ë¶„</th>
            <th>ë¸Œëœë“œ</th>
            <th>ì…€ëŸ¬</th>
            <th>ìƒí’ˆëª…</th>
            <th>ìˆ˜ë ¹ì¸</th>
            <th style="text-align: center;">ìˆ˜ëŸ‰</th>
            <th style="text-align: right;">ê²°ì œê¸ˆì•¡</th>
            <th>ìƒíƒœ</th>
            <th style="width: 80px;">ê´€ë¦¬</th>
          </tr></thead>
          <tbody>
            ${pageOrders.length === 0 ? '<tr><td colspan="12" style="text-align: center; padding: 40px; color: var(--gray-400);">ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>' : pageOrders.map(order => {
              const docId = order.id;
              const isExternal = order.product_type === 'external';
              const productName = order.product_option || order.product_name || '-';
              return `
              <tr>
                <td><input type="checkbox" class="cafe24OrderCheckbox" value="${docId}" onchange="toggleCafe24OrderSelect('${docId}')" ${(state.cafe24SelectedOrders || []).includes(docId) ? 'checked' : ''}></td>
                <td style="font-weight: 600; color: var(--info); font-size: 12px;">${order.order_id || '-'}</td>
                <td style="font-size: 12px;">${order.order_date ? order.order_date.substring(0, 10) : '-'}</td>
                <td>${isExternal
                  ? '<span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">íƒ€ì‚¬</span>'
                  : '<span style="background: #dbeafe; color: #1d4ed8; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">ìì‚¬</span>'}</td>
                <td><span style="background: var(--gray-100); color: var(--gray-700); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${order.supplier_name || '-'}</span></td>
                <td><span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${order.seller_name || '-'}</span></td>
                <td style="font-size: 11px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${productName}">${productName}</td>
                <td style="font-size: 12px;">${order.buyer_name || '-'}</td>
                <td style="text-align: center; font-weight: 600;">${order.quantity || 1}</td>
                <td style="text-align: right; font-weight: 600; font-size: 12px;">${formatNumber(order.total_amount)}ì›</td>
                <td>${getCafe24PaymentStatusBadge(order.payment_status)}</td>
                <td>
                  <div style="display: flex; gap: 4px;">
                    <button onclick="editCafe24Order('${docId}')" class="btn btn-sm btn-secondary" style="padding: 4px 8px; font-size: 11px;">âœï¸</button>
                    <button onclick="deleteCafe24Order('${docId}')" class="btn btn-sm" style="padding: 4px 8px; font-size: 11px; background: #fee2e2; color: #dc2626;">ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>
            `;}).join('')}
          </tbody>
        </table>
      </div>
      ${totalPages > 1 ? `<div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px;"><button onclick="changeCafe24OrdersPage(${currentPage - 1})" class="btn btn-sm btn-secondary" ${currentPage === 1 ? 'disabled' : ''}>ì´ì „</button><span style="font-size: 14px; color: var(--gray-600);">${currentPage} / ${totalPages}</span><button onclick="changeCafe24OrdersPage(${currentPage + 1})" class="btn btn-sm btn-secondary" ${currentPage === totalPages ? 'disabled' : ''}>ë‹¤ìŒ</button></div>` : ''}
    </div>

    <!-- ëª¨ë°”ì¼ ì¹´ë“œë·° -->
    <div class="mobile-card-view" style="display: none;">
      ${pageOrders.length === 0 ? '<div style="text-align: center; padding: 40px; color: var(--gray-400);">ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : pageOrders.map(order => {
        const docId = order.id;
        const mobileProductName = order.product_option || order.product_name || '-';
        return `
          <div class="mobile-order-card"
               ontouchstart="handleTouchStart(event, this)"
               ontouchmove="handleTouchMove(event, this)"
               ontouchend="handleTouchEnd(event)">
            <div class="mobile-order-card-header">
              <div>
                <div class="mobile-order-card-title">${order.buyer_name || 'ìˆ˜ë ¹ì¸ ì—†ìŒ'}</div>
                <div class="mobile-order-card-meta">${order.order_date ? order.order_date.substring(0, 10) : '-'} Â· ${order.order_id || '-'}</div>
              </div>
              ${getCafe24PaymentStatusBadge(order.payment_status)}
            </div>
            <div class="mobile-order-card-body">
              <div class="mobile-order-card-row">
                <span class="mobile-order-card-label">ë¸Œëœë“œ</span>
                <span class="mobile-order-card-value">${order.supplier_name || '-'}</span>
              </div>
              <div class="mobile-order-card-row">
                <span class="mobile-order-card-label">ì…€ëŸ¬</span>
                <span class="mobile-order-card-value">${order.seller_name || '-'}</span>
              </div>
              <div class="mobile-order-card-row">
                <span class="mobile-order-card-label">ìƒí’ˆëª…</span>
                <span class="mobile-order-card-value" style="font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${mobileProductName}</span>
              </div>
              <div class="mobile-order-card-row">
                <span class="mobile-order-card-label">ìˆ˜ëŸ‰</span>
                <span class="mobile-order-card-value">${order.quantity || 1}ê°œ</span>
              </div>
              <div class="mobile-order-card-row">
                <span class="mobile-order-card-label">ê²°ì œê¸ˆì•¡</span>
                <span class="mobile-order-card-value" style="color: var(--primary); font-size: 16px;">${formatNumber(order.total_amount)}ì›</span>
              </div>
            </div>
            <div class="mobile-order-card-actions">
              <button onclick="editCafe24Order('${docId}')" class="btn btn-secondary" style="border: 1px solid var(--gray-300);">âœï¸ ìˆ˜ì •</button>
              <button onclick="deleteCafe24Order('${docId}')" class="btn" style="background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
            <!-- ìŠ¤ì™€ì´í”„ ì•¡ì…˜ -->
            <div class="swipe-actions">
              <button class="swipe-action-btn edit" onclick="editCafe24Order('${docId}'); resetAllSwipeCards();">âœï¸</button>
              <button class="swipe-action-btn delete" onclick="deleteCafe24Order('${docId}'); resetAllSwipeCards();">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;
      }).join('')}
      ${totalPages > 1 ? `
        <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 20px; padding: 16px;">
          <button onclick="changeCafe24OrdersPage(${currentPage - 1})" class="btn btn-secondary" ${currentPage === 1 ? 'disabled' : ''} style="flex: 1;">â† ì´ì „</button>
          <span style="font-size: 14px; color: var(--gray-600); white-space: nowrap;">${currentPage} / ${totalPages}</span>
          <button onclick="changeCafe24OrdersPage(${currentPage + 1})" class="btn btn-secondary" ${currentPage === totalPages ? 'disabled' : ''} style="flex: 1;">ë‹¤ìŒ â†’</button>
        </div>
      ` : ''}
    </div>
  `;
}

function filterCafe24Orders() {
  const searchText = document.getElementById('cafe24OrderSearch')?.value.toLowerCase() || '';
  const sellerFilter = document.getElementById('cafe24SellerFilter')?.value || '';
  const supplierFilter = document.getElementById('cafe24SupplierFilter')?.value || '';
  const productTypeFilter = document.getElementById('cafe24ProductTypeFilter')?.value || '';
  const dateFilter = document.getElementById('cafe24DateFilter')?.value || '';
  let filtered = state.cafe24Orders || [];
  if (searchText) filtered = filtered.filter(o => (o.order_id && o.order_id.toLowerCase().includes(searchText)) || (o.buyer_name && o.buyer_name.toLowerCase().includes(searchText)) || (o.buyer_phone && o.buyer_phone.includes(searchText)));
  if (sellerFilter) filtered = filtered.filter(o => o.seller_name === sellerFilter);
  if (supplierFilter) filtered = filtered.filter(o => o.supplier_name === supplierFilter);
  if (productTypeFilter) filtered = filtered.filter(o => o.product_type === productTypeFilter);
  if (dateFilter) {
    const today = new Date(); let startDate = '';
    if (dateFilter === 'today') startDate = today.toISOString().split('T')[0];
    else if (dateFilter === 'week') { const ws = new Date(today); ws.setDate(today.getDate() - today.getDay() + 1); startDate = ws.toISOString().split('T')[0]; }
    else if (dateFilter === 'month') startDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
    else if (dateFilter === '3months') { const tm = new Date(today); tm.setMonth(today.getMonth() - 3); startDate = tm.toISOString().split('T')[0]; }
    if (startDate) filtered = filtered.filter(o => o.order_date && o.order_date >= startDate);
  }
  state.cafe24FilteredOrders = filtered;
  state.cafe24OrdersPage = 1;
  state.cafe24SelectedOrders = []; // í•„í„° ë³€ê²½ ì‹œ ì„ íƒ ì´ˆê¸°í™”
  renderCafe24OrdersUI();
}

// ì „ì²´ ì„ íƒ í† ê¸€
function toggleCafe24SelectAll() {
  const filtered = state.cafe24FilteredOrders || [];
  const allIds = filtered.map(o => o.order_id + '_' + (o.product_no || ''));
  
  if ((state.cafe24SelectedOrders || []).length === allIds.length) {
    state.cafe24SelectedOrders = [];
  } else {
    state.cafe24SelectedOrders = [...allIds];
  }
  renderCafe24OrdersUI();
}

// ê°œë³„ ì„ íƒ í† ê¸€
function toggleCafe24OrderSelect(docId) {
  if (!state.cafe24SelectedOrders) state.cafe24SelectedOrders = [];
  
  const idx = state.cafe24SelectedOrders.indexOf(docId);
  if (idx === -1) {
    state.cafe24SelectedOrders.push(docId);
  } else {
    state.cafe24SelectedOrders.splice(idx, 1);
  }
  renderCafe24OrdersUI();
}

// ì„ íƒëœ ì£¼ë¬¸ ì‚­ì œ
async function deleteSelectedCafe24Orders() {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  const selected = state.cafe24SelectedOrders || [];
  if (selected.length === 0) {
    showToast('ì‚­ì œí•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!confirm(`ì„ íƒëœ ${selected.length}ê±´ì˜ ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  try {
    showToast('ğŸ—‘ï¸ ì‚­ì œ ì¤‘...');
    
    for (const docId of selected) {
      await db.collection('cafe24_orders').doc(docId).delete();
    }
    
    state.cafe24SelectedOrders = [];
    showToast(`âœ… ${selected.length}ê±´ ì‚­ì œ ì™„ë£Œ`);
    renderCafe24Orders();
  } catch (err) {
    console.error('ì‚­ì œ ì‹¤íŒ¨:', err);
    showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

function changeCafe24OrdersPage(page) {
  const totalPages = Math.ceil((state.cafe24FilteredOrders || []).length / 20);
  if (page < 1 || page > totalPages) return;
  state.cafe24OrdersPage = page;
  renderCafe24OrdersUI();
}

function exportCafe24OrdersToExcel() {
  const orders = state.cafe24FilteredOrders || [];
  if (orders.length === 0) { showToast('ë‹¤ìš´ë¡œë“œí•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const data = orders.map(o => ({ 
    'ì£¼ë¬¸ë²ˆí˜¸': o.order_id || '', 
    'ì£¼ë¬¸ì¼': o.order_date ? o.order_date.substring(0, 10) : '', 
    'êµ¬ë¶„': o.product_type === 'external' ? 'íƒ€ì‚¬' : 'ìì‚¬',
    'ë¸Œëœë“œ': o.supplier_name || '', 
    'ì…€ëŸ¬': o.seller_name || '', 
    'ìƒí’ˆëª…': o.product_name || '',
    'ìˆ˜ëŸ‰': o.quantity || 1,
    'ë‹¨ê°€': o.unit_price || 0,
    'ê²°ì œê¸ˆì•¡': o.total_amount || 0, 
    'ìˆ˜ë ¹ì¸': o.buyer_name || '', 
    'ì—°ë½ì²˜': o.buyer_phone || '', 
    'ê²°ì œìƒíƒœ': { 'F': 'ê²°ì œì™„ë£Œ', 'T': 'ì…ê¸ˆëŒ€ê¸°' }[o.payment_status] || o.payment_status
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì£¼ë¬¸ëª©ë¡');
  XLSX.writeFile(wb, `ì¹´í˜24_ì£¼ë¬¸ëª©ë¡_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ê°œë³„ ì£¼ë¬¸ ì‚­ì œ
async function deleteCafe24Order(docId) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  if (!confirm(`ì´ ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  try {
    await db.collection('cafe24_orders').doc(docId).delete();
    showToast(`âœ… ì‚­ì œ ì™„ë£Œ`);
    renderCafe24Orders();
  } catch (err) {
    console.error('ì‚­ì œ ì‹¤íŒ¨:', err);
    showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì „ì²´ ì£¼ë¬¸ ì‚­ì œ
async function deleteAllCafe24Orders() {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }

  const orders = state.cafe24Orders || [];
  if (orders.length === 0) {
    showToast('ì‚­ì œí•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // ì¹´í˜24 ìë™ ìƒì„± ì •ì‚° ë°ì´í„° í™•ì¸
  const cafe24SellerSettlements = (state.sellerSettlements || []).filter(s => s.createdBy === 'auto_cafe24_mapping');
  const cafe24SupplierSettlements = (state.supplierSettlements || []).filter(s => s.createdBy === 'auto_cafe24_mapping');
  const settlementCount = cafe24SellerSettlements.length + cafe24SupplierSettlements.length;

  const deleteSettlements = settlementCount > 0 && confirm(
    `ğŸ“Š ì¹´í˜24 ìë™ ìƒì„± ì •ì‚° ${settlementCount}ê±´ì´ ìˆìŠµë‹ˆë‹¤.\n\n` +
    `[í™•ì¸] ì£¼ë¬¸ + ì •ì‚° ëª¨ë‘ ì‚­ì œ\n` +
    `[ì·¨ì†Œ] ì£¼ë¬¸ë§Œ ì‚­ì œ (ì •ì‚°ì€ ìœ ì§€)`
  );

  if (!confirm(`âš ï¸ ì „ì²´ ${orders.length}ê±´ì˜ ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?${deleteSettlements ? `\n+ ì •ì‚° ${settlementCount}ê±´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.` : ''}\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

  try {
    showToast('ğŸ—‘ï¸ ì‚­ì œ ì¤‘...');

    // 1. ì¹´í˜24 ì£¼ë¬¸ ì‚­ì œ
    for (const order of orders) {
      const docId = order.id;
      await db.collection('cafe24_orders').doc(docId).delete();
    }

    // 2. ì¹´í˜24 ìë™ ìƒì„± ì •ì‚°ë„ ì‚­ì œ (ì‚¬ìš©ìê°€ ì„ íƒí•œ ê²½ìš°)
    let deletedSettlements = 0;
    if (deleteSettlements) {
      for (const s of cafe24SellerSettlements) {
        await db.collection('sellerSettlements').doc(s.id).delete();
        deletedSettlements++;
      }
      for (const s of cafe24SupplierSettlements) {
        await db.collection('supplierSettlements').doc(s.id).delete();
        deletedSettlements++;
      }
    }

    showToast(`âœ… ì£¼ë¬¸ ${orders.length}ê±´ ì‚­ì œ ì™„ë£Œ${deletedSettlements > 0 ? ` + ì •ì‚° ${deletedSettlements}ê±´` : ''}`);
    renderCafe24Orders();
  } catch (err) {
    console.error('ì „ì²´ ì‚­ì œ ì‹¤íŒ¨:', err);
    showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì£¼ë¬¸ ìˆ˜ì •
async function editCafe24Order(docId) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  const order = (state.cafe24Orders || []).find(o => (o.order_id + '_' + (o.product_no || '')) === docId);
  if (!order) {
    showToast('ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ì…€ëŸ¬/ê³µê¸‰ì‚¬ ëª©ë¡ (ê¸°ì¡´ ì‹œìŠ¤í…œ + ì¹´í˜24 ë°ì´í„°)
  const sellers = [...new Set([
    ...(state.sellers || []).map(s => s.name),
    ...(state.cafe24Orders || []).map(o => o.seller_name).filter(Boolean)
  ])].sort();
  
  const suppliers = [...new Set([
    ...(state.suppliers || []).map(s => s.name),
    ...(state.cafe24Orders || []).map(o => o.supplier_name).filter(Boolean)
  ])].sort();
  
  const html = `
    <div style="padding: 20px;">
      <h2 style="margin-bottom: 20px;">âœï¸ ì£¼ë¬¸ ìˆ˜ì •</h2>
      <div style="display: grid; gap: 16px;">
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ì£¼ë¬¸ë²ˆí˜¸</label>
          <input type="text" value="${order.order_id}" readonly style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; background: #f3f4f6;">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">êµ¬ë¶„</label>
            <select id="editProductType" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;">
              <option value="inhouse" ${order.product_type !== 'external' ? 'selected' : ''}>ìì‚¬</option>
              <option value="external" ${order.product_type === 'external' ? 'selected' : ''}>íƒ€ì‚¬</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ë¸Œëœë“œ/ê³µê¸‰ì‚¬</label>
            <input type="text" id="editSupplierName" value="${order.supplier_name || ''}" list="supplierList" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;">
            <datalist id="supplierList">
              ${suppliers.map(s => `<option value="${s}">`).join('')}
            </datalist>
          </div>
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ì…€ëŸ¬</label>
          <input type="text" id="editSellerName" value="${order.seller_name || ''}" list="sellerList" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;">
          <datalist id="sellerList">
            ${sellers.map(s => `<option value="${s}">`).join('')}
          </datalist>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ìˆ˜ëŸ‰</label>
            <input type="number" id="editQuantity" value="${order.quantity || 1}" min="1" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;">
          </div>
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ë‹¨ê°€</label>
            <input type="number" id="editUnitPrice" value="${order.unit_price || 0}" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;">
          </div>
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ê²°ì œê¸ˆì•¡</label>
            <input type="number" id="editTotalAmount" value="${order.total_amount || 0}" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ìˆ˜ë ¹ì¸</label>
            <input type="text" id="editBuyerName" value="${order.buyer_name || ''}" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;">
          </div>
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ê²°ì œìƒíƒœ</label>
            <select id="editPaymentStatus" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;">
              <option value="T" ${order.payment_status === 'T' ? 'selected' : ''}>ì…ê¸ˆëŒ€ê¸°</option>
              <option value="F" ${order.payment_status === 'F' ? 'selected' : ''}>ê²°ì œì™„ë£Œ</option>
            </select>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
        <button onclick="closeModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
        <button onclick="saveCafe24Order('${docId}')" class="btn btn-primary">ì €ì¥</button>
      </div>
    </div>
  `;
  
  openModal('ì£¼ë¬¸ ìˆ˜ì •', html);
}

// ì£¼ë¬¸ ì €ì¥
async function saveCafe24Order(docId) {
  // ğŸ”’ ê¶Œí•œ ì²´í¬
  if (!canEdit()) { showNoPermission(); return; }
  
  try {
    const productType = document.getElementById('editProductType').value;
    const supplierName = document.getElementById('editSupplierName').value.trim();
    const sellerName = document.getElementById('editSellerName').value.trim();
    const quantity = parseInt(document.getElementById('editQuantity').value) || 1;
    const unitPrice = parseFloat(document.getElementById('editUnitPrice').value) || 0;
    const totalAmount = parseFloat(document.getElementById('editTotalAmount').value) || 0;
    const buyerName = document.getElementById('editBuyerName').value.trim();
    const paymentStatus = document.getElementById('editPaymentStatus').value;
    
    await db.collection('cafe24_orders').doc(docId).update({
      product_type: productType,
      supplier_name: supplierName,
      seller_name: sellerName,
      quantity: quantity,
      unit_price: unitPrice,
      total_amount: totalAmount,
      buyer_name: buyerName,
      payment_status: paymentStatus,
      updated_at: new Date().toISOString()
    });
    
    showToast('âœ… ì£¼ë¬¸ ìˆ˜ì • ì™„ë£Œ');
    closeModal();
    renderCafe24Orders();
  } catch (err) {
    console.error('ìˆ˜ì • ì‹¤íŒ¨:', err);
    showToast('âŒ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ì¹´í˜24 ì†¡ì¥ ë“±ë¡ ====================
async function renderCafe24Shipping() {
  const app = document.getElementById('app');
  app.innerHTML = '<div style="text-align: center; padding: 60px;"><div class="loading"></div><p style="margin-top: 16px; color: var(--gray-500);">ë°°ì†¡ ë°ì´í„° ë¡œë”© ì¤‘...</p></div>';
  try {
    const ordersSnapshot = await db.collection('cafe24_orders').where('order_status', 'in', ['N10', 'N20']).orderBy('order_date', 'desc').limit(200).get();
    state.cafe24ShippingOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderCafe24ShippingUI();
  } catch (err) {
    app.innerHTML = `<div class="page-header"><h1 class="page-title">ğŸšš ì†¡ì¥ë²ˆí˜¸ ë“±ë¡</h1></div><div class="card" style="text-align: center; padding: 60px;"><div style="font-size: 48px; margin-bottom: 16px;">âŒ</div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><button onclick="renderCafe24Shipping()" class="btn btn-primary" style="margin-top: 16px;">ë‹¤ì‹œ ì‹œë„</button></div>`;
  }
}

function renderCafe24ShippingUI() {
  const app = document.getElementById('app');
  const orders = state.cafe24ShippingOrders || [];
  app.innerHTML = `
    <div class="page-header"><h1 class="page-title">ğŸšš ì†¡ì¥ë²ˆí˜¸ ë“±ë¡</h1><p style="color: var(--gray-500); margin-top: 4px;">ë°°ì†¡ ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸: ${orders.length}ê±´</p></div>
    <div class="card" style="margin-bottom: 16px;">
      <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">ğŸ“¦ ì¼ê´„ ì†¡ì¥ ë“±ë¡</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div style="padding: 20px; background: var(--gray-50); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">ê°œë³„ ë“±ë¡</div><p style="font-size: 13px; color: var(--gray-500);">ì•„ë˜ ëª©ë¡ì—ì„œ ê° ì£¼ë¬¸ë³„ë¡œ íƒë°°ì‚¬ì™€ ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p></div>
        <div style="padding: 20px; background: #e0f2fe; border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">Excel ì¼ê´„ ë“±ë¡</div><p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">Excel íŒŒì¼ë¡œ ì†¡ì¥ë²ˆí˜¸ë¥¼ ì¼ê´„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><div style="display: flex; gap: 8px;"><button onclick="downloadShippingTemplate()" class="btn btn-sm btn-secondary">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button><label class="btn btn-sm btn-primary" style="cursor: pointer;">ğŸ“¤ Excel ì—…ë¡œë“œ<input type="file" accept=".xlsx,.xls" onchange="uploadShippingExcel(event)" style="display: none;"></label></div></div>
      </div>
    </div>
    <div class="card" style="margin-bottom: 16px;"><div style="display: flex; align-items: center; gap: 12px;"><span style="font-weight: 600;">ê¸°ë³¸ íƒë°°ì‚¬:</span><select id="defaultCarrier" style="padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 14px;"><option value="CJëŒ€í•œí†µìš´">CJëŒ€í•œí†µìš´</option><option value="ë¡¯ë°íƒë°°">ë¡¯ë°íƒë°°</option><option value="í•œì§„íƒë°°">í•œì§„íƒë°°</option><option value="ìš°ì²´êµ­íƒë°°">ìš°ì²´êµ­íƒë°°</option><option value="ë¡œì  íƒë°°">ë¡œì  íƒë°°</option></select><button onclick="applyDefaultCarrier()" class="btn btn-sm btn-secondary">ì „ì²´ ì ìš©</button></div></div>
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;"><h3 style="font-size: 16px; font-weight: 600;">ë°°ì†¡ ëŒ€ê¸° ì£¼ë¬¸</h3><button onclick="submitAllShipping()" class="btn btn-primary" ${orders.length === 0 ? 'disabled' : ''}>âœ… ì†¡ì¥ ì¼ê´„ ë“±ë¡</button></div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead><tr><th style="width: 40px;"><input type="checkbox" id="shippingSelectAll" onchange="toggleShippingSelectAll()" checked></th><th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ì£¼ë¬¸ì¼ì‹œ</th><th>ì£¼ë¬¸ì</th><th>ì—°ë½ì²˜</th><th>ê²°ì œê¸ˆì•¡</th><th>íƒë°°ì‚¬</th><th>ì†¡ì¥ë²ˆí˜¸</th><th>ìƒíƒœ</th></tr></thead>
          <tbody>
            ${orders.length === 0 ? '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-400);">ë°°ì†¡ ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‰</td></tr>' : orders.map(order => `
              <tr>
                <td><input type="checkbox" class="shipping-checkbox" value="${order.order_id}" checked></td>
                <td style="font-weight: 600; color: var(--info);">${order.order_id || '-'}</td>
                <td style="font-size: 13px;">${order.order_date ? order.order_date.replace('T', ' ').substring(0, 16) : '-'}</td>
                <td>${order.buyer_name || '-'}</td>
                <td style="font-size: 13px;">${order.buyer_phone || '-'}</td>
                <td style="font-weight: 600;">${formatNumber(order.total_amount)}ì›</td>
                <td><select class="shipping-carrier" data-order="${order.order_id}" style="padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px;"><option value="CJëŒ€í•œí†µìš´">CJëŒ€í•œí†µìš´</option><option value="ë¡¯ë°íƒë°°">ë¡¯ë°íƒë°°</option><option value="í•œì§„íƒë°°">í•œì§„íƒë°°</option><option value="ìš°ì²´êµ­íƒë°°">ìš°ì²´êµ­íƒë°°</option><option value="ë¡œì  íƒë°°">ë¡œì  íƒë°°</option></select></td>
                <td><input type="text" class="shipping-number" data-order="${order.order_id}" placeholder="ì†¡ì¥ë²ˆí˜¸ ì…ë ¥" style="padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px; width: 140px;"></td>
                <td>${getCafe24OrderStatusBadge(order.order_status)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function applyDefaultCarrier() { const dc = document.getElementById('defaultCarrier').value; document.querySelectorAll('.shipping-carrier').forEach(s => s.value = dc); showToast(`âœ… íƒë°°ì‚¬ê°€ "${dc}"ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`); }
function toggleShippingSelectAll() { const sa = document.getElementById('shippingSelectAll'); document.querySelectorAll('.shipping-checkbox').forEach(cb => cb.checked = sa.checked); }

function downloadShippingTemplate() {
  const orders = state.cafe24ShippingOrders || [];
  const data = orders.map(o => ({ 'ì£¼ë¬¸ë²ˆí˜¸': o.order_id || '', 'ì£¼ë¬¸ì': o.buyer_name || '', 'ì—°ë½ì²˜': o.buyer_phone || '', 'ê²°ì œê¸ˆì•¡': o.total_amount || 0, 'íƒë°°ì‚¬': 'CJëŒ€í•œí†µìš´', 'ì†¡ì¥ë²ˆí˜¸': '' }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì†¡ì¥ë“±ë¡');
  XLSX.writeFile(wb, `ì†¡ì¥ë“±ë¡_ì–‘ì‹_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('âœ… ì†¡ì¥ ë“±ë¡ ì–‘ì‹ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

async function uploadShippingExcel(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
      let updatedCount = 0;
      for (const row of rows) {
        if (row['ì£¼ë¬¸ë²ˆí˜¸'] && row['ì†¡ì¥ë²ˆí˜¸']) {
          await db.collection('cafe24_orders').doc(String(row['ì£¼ë¬¸ë²ˆí˜¸'])).update({ shipping_carrier: row['íƒë°°ì‚¬'] || 'CJëŒ€í•œí†µìš´', tracking_number: row['ì†¡ì¥ë²ˆí˜¸'], shipping_updated_at: new Date().toISOString() });
          updatedCount++;
        }
      }
      showToast(`âœ… ${updatedCount}ê±´ì˜ ì†¡ì¥ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      renderCafe24Shipping();
    } catch (err) { showToast('âŒ Excel íŒŒì¼ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

async function submitAllShipping() {
  const checkboxes = document.querySelectorAll('.shipping-checkbox:checked');
  if (checkboxes.length === 0) { showToast('ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const updates = [];
  checkboxes.forEach(cb => {
    const orderId = cb.value;
    const carrier = document.querySelector(`.shipping-carrier[data-order="${orderId}"]`)?.value;
    const trackingNumber = document.querySelector(`.shipping-number[data-order="${orderId}"]`)?.value;
    if (trackingNumber && trackingNumber.trim()) updates.push({ orderId, carrier: carrier || 'CJëŒ€í•œí†µìš´', trackingNumber: trackingNumber.trim() });
  });
  if (updates.length === 0) { showToast('ì†¡ì¥ë²ˆí˜¸ê°€ ì…ë ¥ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  if (!confirm(`${updates.length}ê±´ì˜ ì†¡ì¥ë²ˆí˜¸ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  try {
    const batch = db.batch();
    for (const u of updates) batch.update(db.collection('cafe24_orders').doc(u.orderId), { shipping_carrier: u.carrier, tracking_number: u.trackingNumber, order_status: 'N21', shipping_updated_at: new Date().toISOString() });
    await batch.commit();
    showToast(`âœ… ${updates.length}ê±´ì˜ ì†¡ì¥ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    renderCafe24Shipping();
  } catch (err) { showToast('âŒ ì†¡ì¥ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
}

// ==================== ì¹´í˜24 ë§¤ì¶œ í†µê³„ ====================
async function renderCafe24Stats() {
  const app = document.getElementById('app');
  app.innerHTML = '<div style="text-align: center; padding: 60px;"><div class="loading"></div><p style="margin-top: 16px; color: var(--gray-500);">í†µê³„ ë°ì´í„° ê³„ì‚° ì¤‘...</p></div>';
  try {
    const ordersSnapshot = await db.collection('cafe24_orders').orderBy('order_date', 'desc').get();
    const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderCafe24StatsUI(orders);
  } catch (err) {
    app.innerHTML = `<div class="page-header"><h1 class="page-title">ğŸ“ˆ ì¹´í˜24 ë§¤ì¶œ í†µê³„</h1></div><div class="card" style="text-align: center; padding: 60px;"><div style="font-size: 48px; margin-bottom: 16px;">âŒ</div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><button onclick="renderCafe24Stats()" class="btn btn-primary" style="margin-top: 16px;">ë‹¤ì‹œ ì‹œë„</button></div>`;
  }
}

function renderCafe24StatsUI(orders) {
  const app = document.getElementById('app');
  const dailySales = {}, monthlySales = {};
  orders.forEach(order => { if (!order.order_date) return; const date = order.order_date.split('T')[0]; const month = date.substring(0, 7); const amount = Number(order.total_amount) || 0; dailySales[date] = (dailySales[date] || 0) + amount; monthlySales[month] = (monthlySales[month] || 0) + amount; });
  
  const last30Days = [], today = new Date();
  for (let i = 29; i >= 0; i--) { const d = new Date(today); d.setDate(d.getDate() - i); const dateStr = d.toISOString().split('T')[0]; last30Days.push({ date: dateStr, label: `${d.getMonth() + 1}/${d.getDate()}`, sales: dailySales[dateStr] || 0 }); }
  
  const last12Months = [];
  for (let i = 11; i >= 0; i--) { const d = new Date(today.getFullYear(), today.getMonth() - i, 1); const monthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; last12Months.push({ month: monthStr, label: `${d.getMonth() + 1}ì›”`, sales: monthlySales[monthStr] || 0 }); }
  
  const maxDailySales = Math.max(...last30Days.map(d => d.sales), 1);
  const maxMonthlySales = Math.max(...last12Months.map(d => d.sales), 1);
  const totalSales = orders.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);
  const avgOrderAmount = orders.length > 0 ? Math.round(totalSales / orders.length) : 0;
  const thisMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
  const lastMonth = today.getMonth() === 0 ? `${today.getFullYear() - 1}-12` : `${today.getFullYear()}-${String(today.getMonth()).padStart(2, '0')}`;
  const thisMonthSales = monthlySales[thisMonth] || 0;
  const lastMonthSales = monthlySales[lastMonth] || 0;
  const monthGrowth = lastMonthSales > 0 ? ((thisMonthSales - lastMonthSales) / lastMonthSales * 100).toFixed(1) : 0;
  
  app.innerHTML = `
    <div class="page-header"><h1 class="page-title">ğŸ“ˆ ì¹´í˜24 ë§¤ì¶œ í†µê³„</h1><p style="color: var(--gray-500); margin-top: 4px;">ì „ì²´ ${orders.length}ê±´ì˜ ì£¼ë¬¸ ë¶„ì„</p></div>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
      <div style="padding: 24px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);"><div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">ì´ ë§¤ì¶œ</div><div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">${formatNumber(totalSales)}ì›</div></div>
      <div style="padding: 24px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);"><div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">í‰ê·  ì£¼ë¬¸ê¸ˆì•¡</div><div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">${formatNumber(avgOrderAmount)}ì›</div></div>
      <div style="padding: 24px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);"><div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div><div style="font-size: 24px; font-weight: 700; color: var(--info);">${formatNumber(thisMonthSales)}ì›</div></div>
      <div style="padding: 24px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);"><div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">ì „ì›” ëŒ€ë¹„</div><div style="font-size: 24px; font-weight: 700; color: ${Number(monthGrowth) >= 0 ? '#16a34a' : '#dc2626'};">${Number(monthGrowth) >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(monthGrowth)}%</div></div>
    </div>
    <div class="card" style="margin-bottom: 24px;">
      <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600;">ğŸ“Š ìµœê·¼ 30ì¼ ì¼ë³„ ë§¤ì¶œ</h3>
      <div style="display: flex; align-items: flex-end; gap: 4px; height: 200px; padding: 0 10px;">
        ${last30Days.map(d => { const height = maxDailySales > 0 ? (d.sales / maxDailySales * 160) : 0; return `<div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;"><div style="width: 100%; background: linear-gradient(180deg, #3b82f6, #2563eb); border-radius: 4px 4px 0 0; height: ${Math.max(height, 2)}px;" title="${d.date}: ${formatNumber(d.sales)}ì›"></div><div style="font-size: 9px; color: var(--gray-400); transform: rotate(-45deg); white-space: nowrap;">${d.label}</div></div>`; }).join('')}
      </div>
    </div>
    <div class="card" style="margin-bottom: 24px;">
      <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600;">ğŸ“… ìµœê·¼ 12ê°œì›” ì›”ë³„ ë§¤ì¶œ</h3>
      <div style="display: flex; align-items: flex-end; gap: 12px; height: 220px; padding: 0 20px;">
        ${last12Months.map(d => { const height = maxMonthlySales > 0 ? (d.sales / maxMonthlySales * 160) : 0; return `<div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;"><div style="font-size: 11px; font-weight: 600; color: var(--gray-700);">${formatNumber(d.sales / 10000)}ë§Œ</div><div style="width: 100%; background: linear-gradient(180deg, #10b981, #059669); border-radius: 6px 6px 0 0; height: ${Math.max(height, 4)}px;" title="${d.month}: ${formatNumber(d.sales)}ì›"></div><div style="font-size: 12px; color: var(--gray-600); font-weight: 500;">${d.label}</div></div>`; }).join('')}
      </div>
    </div>
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;"><h3 style="font-size: 16px; font-weight: 600;">ğŸ“‹ ìµœê·¼ 30ì¼ ìƒì„¸</h3><button onclick="exportCafe24DailyStatsToExcel()" class="btn btn-sm btn-secondary">ğŸ“¥ Excel ë‹¤ìš´ë¡œë“œ</button></div>
      <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
        <table class="data-table">
          <thead><tr><th>ë‚ ì§œ</th><th>ë§¤ì¶œì•¡</th><th>ë¹„ì¤‘</th></tr></thead>
          <tbody>
            ${last30Days.slice().reverse().map(d => { const total30 = last30Days.reduce((sum, x) => sum + x.sales, 0); const percent = total30 > 0 ? (d.sales / total30 * 100).toFixed(1) : 0; return `<tr><td>${d.date}</td><td style="font-weight: 600;">${formatNumber(d.sales)}ì›</td><td><div style="display: flex; align-items: center; gap: 8px;"><div style="flex: 1; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;"><div style="width: ${percent}%; height: 100%; background: var(--info);"></div></div><span style="font-size: 12px; color: var(--gray-500);">${percent}%</span></div></td></tr>`; }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  state.cafe24Last30Days = last30Days;
}

function exportCafe24DailyStatsToExcel() {
  const data = (state.cafe24Last30Days || []).map(d => ({ 'ë‚ ì§œ': d.date, 'ë§¤ì¶œì•¡': d.sales }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì¼ë³„ë§¤ì¶œ');
  XLSX.writeFile(wb, `ì¹´í˜24_ë§¤ì¶œí†µê³„_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('âœ… ë§¤ì¶œ í†µê³„ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

</script>

<!-- ê°€ì´ë“œ ì±—ë´‡ í€µë°°ë„ˆ -->
<div id="chatbot-fab" onclick="toggleChatbot()" style="position: fixed; bottom: 90px; right: 24px; width: 56px; height: 56px; background: linear-gradient(135deg, #fc9600, #e08600); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; box-shadow: 0 4px 16px rgba(252,150,0,0.4); z-index: 999; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(252,150,0,0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 16px rgba(252,150,0,0.4)';">
  ğŸ’¬
</div>

<!-- ì±—ë´‡ ì°½ -->
<div id="chatbot-window" style="position: fixed; bottom: 160px; right: 24px; width: min(380px, calc(100vw - 48px)); max-height: min(600px, calc(100vh - 200px)); background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); z-index: 998; display: none; flex-direction: column; overflow: hidden;">
  <!-- í—¤ë” -->
  <div style="background: linear-gradient(135deg, #fc9600, #e08600); color: white; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="font-size: 24px;">ğŸ¤–</div>
      <div>
        <div style="font-size: 16px; font-weight: 700;">ëª¨ì—¬ë¼ë”œ ê°€ì´ë“œ</div>
        <div style="font-size: 11px; opacity: 0.9;">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
      </div>
    </div>
    <button onclick="toggleChatbot()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">Ã—</button>
  </div>

  <!-- ë©”ì‹œì§€ ì˜ì—­ -->
  <div id="chatbot-messages" style="flex: 1; overflow-y: auto; padding: 16px; max-height: 400px; background: #f9fafb;">
    <!-- ì´ˆê¸° ë©”ì‹œì§€ -->
  </div>

  <!-- ì…ë ¥ ì˜ì—­ -->
  <div style="padding: 12px; border-top: 1px solid var(--gray-200); background: white;">
    <div style="display: flex; gap: 8px;">
      <input id="chatbot-input" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: 20px; font-size: 13px; font-family: inherit;" onkeypress="if(event.key==='Enter') sendChatMessage()">
      <button onclick="sendChatMessage()" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">ì „ì†¡</button>
    </div>
  </div>
</div>

<!-- ë§ˆì§„ê³„ì‚°ê¸° í€µë°°ë„ˆ -->
<div id="margin-calc-fab" onclick="openMarginCalculator()" style="position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: linear-gradient(135deg, #1e3a5f, #2d5a87); color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 16px rgba(30,58,95,0.4); z-index: 999; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 20px rgba(30,58,95,0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 16px rgba(30,58,95,0.4)';">
  ğŸ§®
</div>

<script>
// ê³„ì‚°ê¸° ì‚¬ìš©ì„¤ëª…ì„œ í† ê¸€
function toggleCalcGuide() {
  const content = document.getElementById('calcGuideContent');
  const arrow = document.getElementById('calcGuideArrow');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    arrow.style.transform = 'rotate(180deg)';
  } else {
    content.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  }
}


// ì±—ë´‡ í† ê¸€
function toggleChatbot() {
  const chatbot = document.getElementById('chatbot-window');
  if (chatbot.style.display === 'none' || chatbot.style.display === '') {
    chatbot.style.display = 'flex';
    initChatbot();
  } else {
    chatbot.style.display = 'none';
  }
}

// ì±—ë´‡ ì´ˆê¸°í™”
function initChatbot() {
  const messages = document.getElementById('chatbot-messages');
  messages.innerHTML = `
    <div style="margin-bottom: 16px;">
      <div style="background: white; padding: 12px 16px; border-radius: 12px 12px 12px 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 12px; max-width: 85%;">
        <div style="font-size: 13px; color: var(--gray-800); line-height: 1.6;">
          ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹<br>
          ëª¨ì—¬ë¼ë”œ ê°€ì´ë“œ ì±—ë´‡ì…ë‹ˆë‹¤.<br>
          ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”!
        </div>
      </div>
      <div style="font-size: 11px; color: var(--gray-400); margin-bottom: 12px;">ë¹ ë¥¸ ì§ˆë¬¸</div>
      <div style="display: grid; gap: 6px;">
        <button onclick="askQuestion('ì²˜ìŒ ì‹œì‘í•˜ê¸°')" style="background: linear-gradient(135deg, #fff8f0, #ffe8cc); border: 1px solid var(--primary); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--primary); font-weight: 600; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
          ğŸš€ ì²˜ìŒ ì‹œì‘í•˜ê¸° (ì‹ ê·œ íŒ€ì›)
        </button>
        <button onclick="askQuestion('ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ê°€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
          ğŸ“‹ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ê°€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?
        </button>
        <button onclick="askQuestion('ê³µêµ¬ ë“±ë¡ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
          ğŸ¯ ê³µêµ¬ ë“±ë¡ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?
        </button>
        <button onclick="askQuestion('ì…€ëŸ¬ DBëŠ” ë¬´ì—‡ì¸ê°€ìš”?')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
          ğŸ‘¥ ì…€ëŸ¬ DBëŠ” ë¬´ì—‡ì¸ê°€ìš”?
        </button>
        <button onclick="askQuestion('ë§ˆì§„ ê³„ì‚°ê¸° ì‚¬ìš©ë²•')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
          ğŸ§® ë§ˆì§„ ê³„ì‚°ê¸° ì‚¬ìš©ë²•
        </button>
        <button onclick="askQuestion('ì¹´í˜24 ì •ì‚°ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
          ğŸ’° ì¹´í˜24 ì •ì‚°ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?
        </button>
        <button onclick="askQuestion('ë©”ë‰´ ì „ì²´ ì„¤ëª…')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
          ğŸ“š ë©”ë‰´ ì „ì²´ ì„¤ëª…
        </button>
        <div style="border-top: 1px solid var(--gray-200); margin: 8px 0;"></div>
        <button onclick="showFeatureRequestInChatbot()" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); border: 1px solid #ec4899; padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: #db2777; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
          ğŸ’¡ ê¸°ëŠ¥ ì¶”ê°€ ìš”ì²­ / ë¶ˆí¸ì‚¬í•­ ì‹ ê³ 
        </button>
      </div>
    </div>
  `;
}

// ì§ˆë¬¸í•˜ê¸°
function askQuestion(question) {
  addUserMessage(question);
  setTimeout(() => {
    const answer = getChatbotAnswer(question);
    addBotMessage(answer);
  }, 500);
}

// ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
function addUserMessage(message) {
  const messages = document.getElementById('chatbot-messages');
  const userMsg = document.createElement('div');
  userMsg.style.cssText = 'display: flex; justify-content: flex-end; margin-bottom: 12px;';
  userMsg.innerHTML = `
    <div style="background: var(--primary); color: white; padding: 10px 14px; border-radius: 12px 12px 4px 12px; max-width: 75%; font-size: 13px;">
      ${message}
    </div>
  `;
  messages.appendChild(userMsg);
  messages.scrollTop = messages.scrollHeight;
}

// ë´‡ ë©”ì‹œì§€ ì¶”ê°€
function addBotMessage(message) {
  const messages = document.getElementById('chatbot-messages');
  const botMsg = document.createElement('div');
  botMsg.style.cssText = 'margin-bottom: 12px;';
  botMsg.innerHTML = `
    <div style="background: white; padding: 12px 16px; border-radius: 12px 12px 12px 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 85%; font-size: 13px; color: var(--gray-800); line-height: 1.7;">
      ${message}
    </div>
  `;
  messages.appendChild(botMsg);
  messages.scrollTop = messages.scrollHeight;
}

// ì…ë ¥ì°½ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
function sendChatMessage() {
  const input = document.getElementById('chatbot-input');
  const message = input.value.trim();
  if (!message) return;

  askQuestion(message);
  input.value = '';
}

// ì±—ë´‡ ë‚´ ê¸°ëŠ¥ ìš”ì²­ í¼ í‘œì‹œ
function showFeatureRequestInChatbot() {
  const messages = document.getElementById('chatbot-messages');
  messages.innerHTML = `
    <div style="margin-bottom: 16px;">
      <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="font-size: 15px; font-weight: 700; color: #db2777; margin-bottom: 12px;">ğŸ’¡ ê¸°ëŠ¥ ì¶”ê°€ ìš”ì²­</div>
        <p style="font-size: 12px; color: var(--gray-600); margin-bottom: 16px;">
          ë¶ˆí¸í•œ ì ì´ë‚˜ ì¶”ê°€ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ê¸°ëŠ¥ì„ ì•Œë ¤ì£¼ì„¸ìš”!
        </p>
        <div style="margin-bottom: 12px;">
          <label style="font-size: 11px; font-weight: 600; color: var(--gray-600); display: block; margin-bottom: 4px;">ìš”ì²­ ìœ í˜•</label>
          <select id="chatbot-request-type" style="width: 100%; padding: 8px 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 12px; background: white;">
            <option value="feature">âœ¨ ìƒˆ ê¸°ëŠ¥ ì¶”ê°€</option>
            <option value="improve">ğŸ”§ ê¸°ì¡´ ê¸°ëŠ¥ ê°œì„ </option>
            <option value="bug">ğŸ› ë²„ê·¸/ì˜¤ë¥˜ ì‹ ê³ </option>
            <option value="inconvenient">ğŸ˜¤ ë¶ˆí¸í•œ ì </option>
            <option value="other">ğŸ’¬ ê¸°íƒ€ ì˜ê²¬</option>
          </select>
        </div>
        <div style="margin-bottom: 12px;">
          <label style="font-size: 11px; font-weight: 600; color: var(--gray-600); display: block; margin-bottom: 4px;">ë‚´ìš©</label>
          <textarea id="chatbot-request-content" placeholder="ì–´ë–¤ ê¸°ëŠ¥ì´ í•„ìš”í•˜ì‹ ê°€ìš”?" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 12px; min-height: 80px; resize: vertical; font-family: inherit;"></textarea>
        </div>
        <div style="margin-bottom: 12px;">
          <label style="font-size: 11px; font-weight: 600; color: var(--gray-600); display: block; margin-bottom: 4px;">ì‘ì„±ì (ì„ íƒ)</label>
          <input type="text" id="chatbot-request-author" placeholder="ì´ë¦„" style="width: 100%; padding: 8px 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 12px;">
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="initChatbot()" style="flex: 1; padding: 10px; background: var(--gray-100); color: var(--gray-600); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">â† ëŒì•„ê°€ê¸°</button>
          <button onclick="submitChatbotFeatureRequest()" style="flex: 2; padding: 10px; background: linear-gradient(135deg, #ec4899, #db2777); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ğŸ“® ìš”ì²­ ì œì¶œ</button>
        </div>
      </div>
    </div>
  `;
}

// ì±—ë´‡ì—ì„œ ê¸°ëŠ¥ ìš”ì²­ ì œì¶œ
async function submitChatbotFeatureRequest() {
  const type = document.getElementById('chatbot-request-type').value;
  const content = document.getElementById('chatbot-request-content').value.trim();
  const author = document.getElementById('chatbot-request-author').value.trim();

  if (!content) {
    alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
    return;
  }

  try {
    await db.collection('feature_requests').add({
      type: type,
      content: content,
      author: author || 'ìµëª…',
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    const messages = document.getElementById('chatbot-messages');
    messages.innerHTML = `
      <div style="text-align: center; padding: 30px 20px;">
        <div style="font-size: 48px; margin-bottom: 12px;">ğŸ‰</div>
        <div style="font-size: 15px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆì–´ìš”!</div>
        <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 20px;">ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤.<br>ê²€í†  í›„ ë°˜ì˜í• ê²Œìš”.</div>
        <button onclick="initChatbot()" style="padding: 10px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
          â† ì²˜ìŒìœ¼ë¡œ
        </button>
      </div>
    `;
  } catch (e) {
    console.error('ê¸°ëŠ¥ ìš”ì²­ ì €ì¥ ì˜¤ë¥˜:', e);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

// ì±—ë´‡ ë‹µë³€ ìƒì„±
function getChatbotAnswer(question) {
  const q = question.toLowerCase();

  // ì—…ë¬´ í”„ë¡œì„¸ìŠ¤
  if (q.includes('ì—…ë¬´') || q.includes('í”„ë¡œì„¸ìŠ¤') || q.includes('ì „ì²´') && q.includes('íë¦„')) {
    return getProcessAnswer();
  }

  // ê³µêµ¬ ë“±ë¡
  if (q.includes('ê³µêµ¬') && (q.includes('ë“±ë¡') || q.includes('ë§Œë“¤') || q.includes('ìƒì„±'))) {
    return `<strong>ğŸ“‹ ê³µêµ¬ ë“±ë¡ ë°©ë²•</strong><br><br>
      1ï¸âƒ£ <strong>ê³µêµ¬ ìº˜ë¦°ë”</strong> ë©”ë‰´ë¡œ ì´ë™<br>
      2ï¸âƒ£ ì›í•˜ëŠ” ë‚ ì§œë¥¼ í´ë¦­<br>
      3ï¸âƒ£ ê³µêµ¬ ì •ë³´ ì…ë ¥ (ìƒí’ˆ, ì…€ëŸ¬, ê¸°ê°„, ê°€ê²© ë“±)<br>
      4ï¸âƒ£ ì €ì¥í•˜ë©´ ìº˜ë¦°ë”ì— í‘œì‹œë©ë‹ˆë‹¤<br>
      5ï¸âƒ£ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ê°€ì´ë“œ ì „ë‹¬<br>
      6ï¸âƒ£ ì…€ëŸ¬ê°€ SNSì— í™ë³´ ì‹œì‘!<br><br>
      ğŸ’¡ <strong>ë” ìì„¸í•œ ë‚´ìš©ì€ "ğŸ“š ì—…ë¬´ ê°€ì´ë“œ" ë©”ë‰´ë¥¼ í™•ì¸í•˜ì„¸ìš”!</strong>`;
  }

  // ì…€ëŸ¬ ê´€ë ¨
  if (q.includes('ì…€ëŸ¬')) {
    if (q.includes('db')) {
      return `<strong>ğŸ‘¥ ì…€ëŸ¬ DB</strong><br><br>
        ê³„ì•½ëœ ì…€ëŸ¬ ëª©ë¡ì„ ê´€ë¦¬í•˜ëŠ” ë©”ë‰´ì…ë‹ˆë‹¤.<br><br>
        <strong>ì£¼ìš” ê¸°ëŠ¥:</strong><br>
        â€¢ ì…€ëŸ¬ ì •ë³´ ê´€ë¦¬ (ì—°ë½ì²˜, SNS ì±„ë„ ë“±)<br>
        â€¢ ê³„ì•½ ì¡°ê±´ í™•ì¸<br>
        â€¢ ê³µêµ¬ ì´ë ¥ ì¡°íšŒ<br>
        â€¢ ì •ì‚° ë‚´ì—­ í™•ì¸<br><br>
        <strong>ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì™€ì˜ ì°¨ì´:</strong><br>
        ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ëŠ” ì‹ ê·œ ë°œêµ´ìš©, ì…€ëŸ¬ DBëŠ” ê³„ì•½ ì™„ë£Œëœ ì…€ëŸ¬ ê´€ë¦¬ìš©ì…ë‹ˆë‹¤.<br><br>
        ğŸ’¡ <strong>ë” ìì„¸í•œ ë‚´ìš©ì€ "ğŸ“š ì—…ë¬´ ê°€ì´ë“œ" ë©”ë‰´ë¥¼ í™•ì¸í•˜ì„¸ìš”!</strong>`;
    }
    return `<strong>ğŸ‘¥ ì…€ëŸ¬ ê´€ë¦¬</strong><br><br>
      <strong>ì…€ëŸ¬ DB:</strong> ê³„ì•½ëœ ì…€ëŸ¬ ëª©ë¡ ê´€ë¦¬<br>
      <strong>ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸:</strong> ì‹ ê·œ ì…€ëŸ¬ ë°œêµ´ ë° ì»¨íƒ ê´€ë¦¬<br><br>
      <strong>ì…€ëŸ¬ ì¤€ë¹„ ê³¼ì •:</strong><br>
      1. ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¸í”Œë£¨ì–¸ì„œ ì°¾ê¸°<br>
      2. ì»¨íƒ â†’ ì œì•ˆ â†’ ê³„ì•½<br>
      3. ê³„ì•½ ì™„ë£Œ ì‹œ ì…€ëŸ¬ DBì— ë“±ë¡<br>
      4. ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ì…€ëŸ¬ ë§ˆì§„ í˜‘ìƒ<br><br>
      ğŸ’¡ <strong>ë” ìì„¸í•œ ë‚´ìš©ì€ "ğŸ“š ì—…ë¬´ ê°€ì´ë“œ" ë©”ë‰´ë¥¼ í™•ì¸í•˜ì„¸ìš”!</strong>`;
  }

  // ë§ˆì§„ ê³„ì‚°ê¸°
  if (q.includes('ë§ˆì§„') || q.includes('ê³„ì‚°ê¸°')) {
    return `<strong>ğŸ§® ë§ˆì§„ ê³„ì‚°ê¸° ì‚¬ìš©ë²•</strong><br><br>
      í™”ë©´ ì˜¤ë¥¸ìª½ ì•„ë˜ ê³„ì‚°ê¸°(ğŸ§®) ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.<br><br>
      <strong>ì…€ëŸ¬ í˜‘ìƒìš©:</strong><br>
      â€¢ ìƒí’ˆ DBì—ì„œ ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°<br>
      â€¢ ì…€ëŸ¬ ë§ˆì§„ìœ¨ ì¡°ì •í•˜ë©° ì‹œë®¬ë ˆì´ì…˜<br>
      â€¢ ì…€ëŸ¬ ì œì•ˆì„œ PDF ë‹¤ìš´ë¡œë“œ<br><br>
      <strong>ê³µê¸‰ì‚¬ í˜‘ìƒìš©:</strong><br>
      â€¢ ê³µê¸‰ë‹¨ê°€/íŒë§¤ê°€ ì…ë ¥<br>
      â€¢ ìˆ˜ìµì„± íŒì • í™•ì¸<br>
      â€¢ í˜‘ìƒ ê²€í† ì„œ PDF ë‹¤ìš´ë¡œë“œ`;
  }

  // ì¹´í˜24 ì •ì‚°
  if (q.includes('ì¹´í˜24') || q.includes('ì •ì‚°')) {
    return `<strong>ğŸ’° ì¹´í˜24 ì •ì‚° ë°©ë²•</strong><br><br>
      <strong>ğŸ“‹ ì •ì‚° ìˆœì„œ:</strong><br>
      1ï¸âƒ£ ì¹´í˜24 ê´€ë¦¬ì â†’ ì£¼ë¬¸ê´€ë¦¬ â†’ ì „ì²´ì£¼ë¬¸ì¡°íšŒ<br>
      2ï¸âƒ£ ê³µêµ¬ ê¸°ê°„ìœ¼ë¡œ ë‚ ì§œ í•„í„° ì„¤ì •<br>
      3ï¸âƒ£ "ì—‘ì…€ ë‹¤ìš´ë¡œë“œ" í´ë¦­<br>
      4ï¸âƒ£ ì •ì‚° ê´€ë¦¬ â†’ ì—‘ì…€ ì—…ë¡œë“œ & ë§¤í•‘<br>
      5ï¸âƒ£ ê³µê¸‰ì‚¬/ì…€ëŸ¬ë³„ ì •ì‚° ê¸ˆì•¡ ìë™ ê³„ì‚°<br>
      6ï¸âƒ£ ì •ì‚° ì™„ë£Œ ì²˜ë¦¬<br><br>
      ğŸ’¡ ì—‘ì…€ íŒŒì¼ì€ ì¹´í˜24 ê¸°ë³¸ ì–‘ì‹ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤!`;
  }

  // ë©”ë‰´ ì„¤ëª…
  if (q.includes('ë©”ë‰´')) {
    return getMenuAnswer();
  }

  // ê³µê¸‰ì‚¬
  if (q.includes('ê³µê¸‰ì‚¬')) {
    return `<strong>ğŸ­ ê³µê¸‰ì‚¬ ê´€ë¦¬</strong><br><br>
      <strong>ê³µê¸‰ì‚¬ DB:</strong> ê³„ì•½ëœ ê³µê¸‰ì‚¬ ëª©ë¡ê³¼ ê³„ì•½ ì¡°ê±´ ê´€ë¦¬<br>
      <strong>ìƒí’ˆ DB:</strong> ë“±ë¡ëœ ìƒí’ˆ ëª©ë¡ (ê³µê¸‰ê°€, íŒë§¤ê°€, ë§ˆì§„)<br>
      <strong>ìƒí’ˆ ë¦¬ìŠ¤íŠ¸:</strong> ì‹ ê·œ ê³µê¸‰ì‚¬/ìƒí’ˆ ë°œêµ´ ë° ê¸°ë¡<br><br>
      <strong>ìƒí’ˆ ì¤€ë¹„ ê³¼ì •:</strong><br>
      1. ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê³µê¸‰ì‚¬ ì°¾ê¸°<br>
      2. ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ<br>
      3. ìƒí’ˆ DBì— ë“±ë¡`;
  }

  // ìš©ì–´ ì„¤ëª…
  if (q.includes('ìš©ì–´') || q.includes('ëœ»') || q.includes('ì˜ë¯¸')) {
    return `<strong>ğŸ“– ìš©ì–´ ì„¤ëª…</strong><br><br>
      <strong>ê³µê¸‰ì‚¬:</strong> ë¬¼ê±´ì„ ê³µê¸‰í•˜ëŠ” íšŒì‚¬<br>
      <strong>ì…€ëŸ¬:</strong> ì¸í”Œë£¨ì–¸ì„œ/ë¸”ë¡œê±° (ìƒí’ˆ í™ë³´)<br>
      <strong>ê³µêµ¬:</strong> ê³µë™êµ¬ë§¤<br>
      <strong>ë§ˆì§„:</strong> íŒë§¤ í›„ ë‚¨ëŠ” ëˆ (ì´ìµ)<br>
      <strong>PG:</strong> ì¹´ë“œê²°ì œ ìˆ˜ìˆ˜ë£Œ íšŒì‚¬<br>
      <strong>ì •ì‚°:</strong> ê³µêµ¬ ì¢…ë£Œ í›„ ëˆ ë‚˜ëˆ ì£¼ê¸°`;
  }

  // ìˆ˜ìµ êµ¬ì¡°
  if (q.includes('ìˆ˜ìµ') || q.includes('ëˆ') || q.includes('ì´ìµ')) {
    return `<strong>ğŸ’° ìˆ˜ìµ êµ¬ì¡°</strong><br><br>
      <strong>íŒë§¤ê°€ êµ¬ì„±:</strong><br>
      ê³µê¸‰ê°€ + ì…€ëŸ¬ ë§ˆì§„(-3.3%) + PG ìˆ˜ìˆ˜ë£Œ(4%) + ëª¨ì—¬ë¼ë”œ ìˆœì´ìµ<br><br>
      <strong>ì…€ëŸ¬ ë³´ë„ˆìŠ¤:</strong><br>
      500ê°œ ì´ìƒ íŒë§¤ ì‹œ ì…€ëŸ¬ ë§ˆì§„ +1%ì”© ì¶”ê°€ (ëª¨ì—¬ë¼ë”œ ë¶€ë‹´)<br><br>
      <strong>ì •ì‚° ì‹œê¸°:</strong><br>
      ê³µêµ¬ ì¢…ë£Œ í›„ 3~7ì¼ ë‚´`;
  }

  // ì‹œì‘í•˜ê¸°
  if (q.includes('ì‹œì‘') || q.includes('ì²˜ìŒ') || q.includes('ì²˜ìŒ')) {
    return `<strong>ğŸš€ ì²˜ìŒ ì‹œì‘í•˜ê¸°</strong><br><br>
      <strong>ì‹ ê·œ íŒ€ì›ì´ë¼ë©´:</strong><br><br>
      1ï¸âƒ£ ë¨¼ì € "ì—…ë¬´ í”„ë¡œì„¸ìŠ¤" ì½ê¸°<br>
      2ï¸âƒ£ "ë©”ë‰´ ì„¤ëª…" ë³´ê³  ê° ë©”ë‰´ ì´í•´í•˜ê¸°<br>
      3ï¸âƒ£ ë§ˆì§„ ê³„ì‚°ê¸° ì‚¬ìš©ë²• ìµíˆê¸°<br>
      4ï¸âƒ£ ê³µêµ¬ ìº˜ë¦°ë”ì—ì„œ ì‹¤ì œ ê³µêµ¬ í™•ì¸í•´ë³´ê¸°<br><br>
      <strong>íŒ:</strong> ê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ë©´ ì–¸ì œë“  ì €ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”! ğŸ˜Š`;
  }

  // ì¹´í˜24
  if (q.includes('ì¹´í˜24') && !q.includes('ì •ì‚°')) {
    return `<strong>ğŸ’š ì¹´í˜24 ì—°ë™</strong><br><br>
      <strong>ëŒ€ì‹œë³´ë“œ:</strong><br>
      ì¹´í˜24 ì‡¼í•‘ëª°ì˜ ë§¤ì¶œ, ì£¼ë¬¸, ìƒí’ˆ í˜„í™©ì„ í•œëˆˆì— í™•ì¸<br><br>
      <strong>ì£¼ë¬¸í˜„í™©:</strong><br>
      ì‹¤ì‹œê°„ ì£¼ë¬¸ ëª©ë¡ í™•ì¸ ë° ë°°ì†¡ ìƒíƒœ ê´€ë¦¬<br><br>
      <strong>í†µê³„:</strong><br>
      ë§¤ì¶œ ì¶”ì´, ë² ìŠ¤íŠ¸ ìƒí’ˆ, ê³ ê° ë¶„ì„<br><br>
      <strong>API ì—°ë™ ì„¤ì •:</strong><br>
      ì¹´í˜24 ê´€ë¦¬ì â†’ API ì—°ë™ ë©”ë‰´ì—ì„œ ì„¤ì •`;
  }

  // ê³µêµ¬ ê´€ë ¨
  if (q.includes('ê³µêµ¬') && !q.includes('ë“±ë¡')) {
    return `<strong>ğŸ¯ ê³µêµ¬ ê´€ë¦¬</strong><br><br>
      <strong>ê³µêµ¬ ìº˜ë¦°ë”:</strong><br>
      â€¢ ë‚ ì§œë³„ ê³µêµ¬ ì¼ì • í™•ì¸<br>
      â€¢ ë‚ ì§œ í´ë¦­í•´ì„œ ê³µêµ¬ ë“±ë¡<br><br>
      <strong>ê³µêµ¬ í˜„í™©:</strong><br>
      â€¢ ë“±ë¡ëœ ê³µêµ¬ ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬<br>
      â€¢ ìƒíƒœ, ê¸°ê°„, ë§¤ì¶œ í™•ì¸<br><br>
      <strong>ê³µêµ¬ ì œì•ˆ:</strong><br>
      â€¢ ê³µê¸‰ì‚¬ ê¸´ê¸‰ìš”ì²­ ì ‘ìˆ˜<br>
      â€¢ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ì œì•ˆ<br><br>
      ë” ìì„¸í•œ ë‚´ìš©ì€ "ê³µêµ¬ ë“±ë¡ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?" ì§ˆë¬¸í•´ë³´ì„¸ìš”!`;
  }

  // ê¸°ë³¸ ì‘ë‹µ
  return `ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ğŸ˜…<br><br>
    ë‹¤ìŒ í‚¤ì›Œë“œë¡œ ë‹¤ì‹œ ì§ˆë¬¸í•´ë³´ì„¸ìš”:<br>
    â€¢ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤<br>
    â€¢ ê³µêµ¬ ë“±ë¡<br>
    â€¢ ì…€ëŸ¬ / ê³µê¸‰ì‚¬<br>
    â€¢ ë§ˆì§„ ê³„ì‚°ê¸°<br>
    â€¢ ì¹´í˜24 ì •ì‚°<br>
    â€¢ ë©”ë‰´ ì„¤ëª…<br>
    â€¢ ì‹œì‘í•˜ê¸°<br>
    â€¢ ìš©ì–´ ì„¤ëª…`;
}

// ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ ë‹µë³€
function getProcessAnswer() {
  return `<strong>ğŸ“‹ ëª¨ì—¬ë¼ë”œ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤</strong><br><br>
    <strong>ì „ì²´ íë¦„:</strong><br>
    ìƒí’ˆ ì¤€ë¹„ â†’ ì…€ëŸ¬ ì¤€ë¹„ â†’ ê³µêµ¬ ë“±ë¡ â†’ íŒë§¤ â†’ ì •ì‚°<br><br>

    <strong>1ë‹¨ê³„: ìƒí’ˆ ì¤€ë¹„ (êµ¬ë§¤íŒ€)</strong><br>
    â‘  ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê³µê¸‰ì‚¬ ì°¾ê¸°<br>
    â‘¡ ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ<br>
    â‘¢ ìƒí’ˆ DBì— ë“±ë¡<br><br>

    <strong>2ë‹¨ê³„: ì…€ëŸ¬ ì¤€ë¹„ (ë§ˆì¼€íŒ…íŒ€)</strong><br>
    [ì‹ ê·œ ì…€ëŸ¬] ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ â†’ ì»¨íƒ/ì œì•ˆ/ê³„ì•½ â†’ ì…€ëŸ¬ DB ë“±ë¡<br>
    [ê¸°ì¡´ ì…€ëŸ¬] ì…€ëŸ¬ DB ì„ íƒ â†’ ë§ˆì§„ í˜‘ìƒ â†’ ì œì•ˆì„œ ì „ë‹¬<br><br>

    <strong>3ë‹¨ê³„: ê³µêµ¬ ë“±ë¡</strong><br>
    â‘  ê³µêµ¬ ìº˜ë¦°ë”ì—ì„œ ë“±ë¡<br>
    â‘¡ ì…€ëŸ¬ì—ê²Œ ê°€ì´ë“œ ì „ë‹¬<br>
    â‘¢ ì…€ëŸ¬ê°€ SNS í™ë³´<br><br>

    <strong>4ë‹¨ê³„: íŒë§¤ & ì •ì‚°</strong><br>
    ê²°ì œ â†’ ë°œì£¼ â†’ ë°°ì†¡ â†’ ì†¡ì¥ì „ë‹¬ â†’ ì •ì‚°(3~7ì¼)<br><br>

    ğŸ’¡ <strong>ìì„¸í•œ ë‚´ìš©ì€ ì‚¬ì´ë“œë°”ì˜ "ğŸ“š ì—…ë¬´ ê°€ì´ë“œ" ë©”ë‰´ë¥¼ í™•ì¸í•˜ì„¸ìš”!</strong>`;
}

// ë©”ë‰´ ì„¤ëª… ë‹µë³€
function getMenuAnswer() {
  return `<strong>ğŸ“š ë©”ë‰´ ì„¤ëª…</strong><br><br>
    <strong>ğŸ¯ ê³µêµ¬ì„¼í„°</strong><br>
    â€¢ ê³µêµ¬ ìº˜ë¦°ë”: ê³µêµ¬ ë“±ë¡ ë° ì¼ì • ê´€ë¦¬<br>
    â€¢ ê³µêµ¬ í˜„í™©/ì²´í¬ë¦¬ìŠ¤íŠ¸: ê³µêµ¬ ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬<br>
    â€¢ ê³µêµ¬ ì œì•ˆ ê´€ë¦¬: ê³µê¸‰ì‚¬ ê¸´ê¸‰ìš”ì²­, ì…€ëŸ¬ ì œì•ˆ<br>
    â€¢ ì •ì‚° ê´€ë¦¬: ì¹´í˜24 ë§¤ì¶œ ì—°ë™, ì •ì‚° ì²˜ë¦¬<br><br>

    <strong>ğŸ­ ê³µê¸‰ì‚¬ ê´€ë¦¬</strong><br>
    â€¢ ê³µê¸‰ì‚¬ DB: ê³„ì•½ëœ ê³µê¸‰ì‚¬ ê´€ë¦¬<br>
    â€¢ ìƒí’ˆ DB: ë“±ë¡ëœ ìƒí’ˆ ëª©ë¡<br>
    â€¢ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸: ì‹ ê·œ ê³µê¸‰ì‚¬/ìƒí’ˆ ë°œêµ´<br><br>

    <strong>ğŸ‘¥ ì…€ëŸ¬ ê´€ë¦¬</strong><br>
    â€¢ ì…€ëŸ¬ DB: ê³„ì•½ëœ ì…€ëŸ¬ ê´€ë¦¬<br>
    â€¢ ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸: ì‹ ê·œ ì…€ëŸ¬ ë°œêµ´<br><br>

    <strong>ğŸ”— ê¸°íƒ€</strong><br>
    â€¢ ê³µìœ  ë§í¬: íŒŒíŠ¸ë„ˆ ê³µìœ  ë§í¬ ìƒì„±<br>
    â€¢ íŒŒíŠ¸ë„ˆ ê³µì§€: ê³µì§€ì‚¬í•­ ë°œì†¡<br><br>

    <strong>ğŸ’š ì¹´í˜24 ì—°ë™</strong><br>
    â€¢ ëŒ€ì‹œë³´ë“œ: ë§¤ì¶œ/ì£¼ë¬¸/ìƒí’ˆ í˜„í™©<br>
    â€¢ ì£¼ë¬¸í˜„í™©: ì‹¤ì‹œê°„ ì£¼ë¬¸ ê´€ë¦¬<br>
    â€¢ í†µê³„: ë§¤ì¶œ ì¶”ì´ ë¶„ì„<br><br>

    ğŸ’¡ <strong>ìì„¸í•œ ë‚´ìš©ì€ ì‚¬ì´ë“œë°”ì˜ "ğŸ“š ì—…ë¬´ ê°€ì´ë“œ" ë©”ë‰´ë¥¼ í™•ì¸í•˜ì„¸ìš”!</strong>`;
}

// ê°€ì´ë“œ í˜ì´ì§€ ë Œë”ë§
let guideTab = 'essence';

function renderGuide() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
      <!-- í—¤ë” -->
      <div style="background: linear-gradient(135deg, #fc9600, #e08600); color: white; padding: 28px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 16px rgba(252,150,0,0.2);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div style="font-size: 36px;">ğŸ“š</div>
          <div>
            <div style="font-size: 24px; font-weight: 700;">ëª¨ì—¬ë¼ë”œ ì—…ë¬´ ê°€ì´ë“œ</div>
            <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">ì‹ ê·œ íŒ€ì›ì„ ìœ„í•œ ìƒì„¸ ê°€ì´ë“œ - ë³¸ì§ˆë¶€í„° ì‹¤ë¬´ê¹Œì§€</div>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; margin-top: 12px;">
          <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px;">ğŸ’¡ ëª¨ì—¬ë¼ë”œ í•µì‹¬ ì •ì˜</div>
          <div style="font-size: 15px; line-height: 1.6;">"<strong>ì‚¬ëŒì˜ ì‹ ë¢°</strong>ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼"</div>
        </div>
      </div>

      <!-- íƒ­ ë©”ë‰´ -->
      <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--gray-200); padding-bottom: 8px; flex-wrap: wrap;">
        <button onclick="switchGuideTab('essence')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'essence' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
          ğŸ¯ ë³¸ì§ˆ ë©”ì‹œì§€
        </button>
        <button onclick="switchGuideTab('process')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'process' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
          ğŸ“‹ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤
        </button>
        <button onclick="switchGuideTab('partner')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'partner' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
          ğŸ¤ íŒŒíŠ¸ë„ˆ ì‘ëŒ€
        </button>
        <button onclick="switchGuideTab('menu')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'menu' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
          ğŸ“š ë©”ë‰´ ì„¤ëª…
        </button>
        <button onclick="switchGuideTab('tools')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'tools' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
          ğŸ› ï¸ ì£¼ìš” ê¸°ëŠ¥
        </button>
      </div>

      <!-- ì»¨í…ì¸  ì˜ì—­ -->
      <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
        ${guideTab === 'essence' ? getEssenceContent() : guideTab === 'process' ? getProcessContent() : guideTab === 'partner' ? getPartnerContent() : guideTab === 'menu' ? getMenuContent() : getToolsContent()}
      </div>

      <!-- í•˜ë‹¨ ë„ì›€ë§ -->
      <div style="margin-top: 24px; padding: 16px; background: var(--info-light); border-radius: 12px; border-left: 4px solid var(--info);">
        <div style="font-size: 14px; font-weight: 600; color: var(--info); margin-bottom: 8px;">ğŸ’¡ ë¹ ë¥¸ ì§ˆë¬¸ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</div>
        <div style="font-size: 13px; color: var(--gray-700);">
          ì˜¤ë¥¸ìª½ í•˜ë‹¨ì˜ ğŸ’¬ ì±—ë´‡ì„ í´ë¦­í•˜ë©´ ê¶ê¸ˆí•œ ë‚´ìš©ì„ ë¹ ë¥´ê²Œ ë¬¼ì–´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!
        </div>
      </div>
    </div>
  `;
}

function switchGuideTab(tab) {
  guideTab = tab;
  renderGuide();
  if (tab === 'tools') {
    setTimeout(() => loadFeatureRequests(), 100);
  }
}

// ë³¸ì§ˆ ë©”ì‹œì§€ íƒ­
function getEssenceContent() {
  return `
    <!-- í•µì‹¬ ê°€ì¹˜ -->
    <div style="text-align: center; padding: 20px 0 30px;">
      <div style="font-size: 28px; font-weight: 700; color: #191F28; margin-bottom: 12px;">ì™œ ëª¨ì—¬ë¼ë”œì¸ê°€?</div>
      <div style="font-size: 16px; color: #6B7684; max-width: 600px; margin: 0 auto; line-height: 1.6;">
        ê´‘ê³  ì‹ ë¢°ë„ëŠ” í•˜ë½í•˜ê³ , 'ì‚¬ëŒ ì¶”ì²œ'ì˜ ê°€ì¹˜ëŠ” ìƒìŠ¹í•©ë‹ˆë‹¤.<br>
        ëª¨ì—¬ë¼ë”œì€ <strong>"ì‹ ë¢° â†’ êµ¬ë§¤"</strong> êµ¬ì¡°ì— ìµœì í™”ëœ í”Œë«í¼ì…ë‹ˆë‹¤.
      </div>
    </div>
    
    <!-- 3ëŒ€ ê³ ê° ê°€ì¹˜ ì¹´ë“œ -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
      <!-- ê³µê¸‰ì‚¬ -->
      <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border-radius: 16px; padding: 24px; border: 1px solid #C7D2FE;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ­</div>
        <div style="font-size: 18px; font-weight: 700; color: #4338CA; margin-bottom: 8px;">ê³µê¸‰ì‚¬</div>
        <div style="font-size: 13px; color: #6366F1; font-weight: 600; margin-bottom: 16px;">"ì¢‹ì€ ì œí’ˆì´ ë” ë¹ ë¥´ê³  íš¨ìœ¨ì ìœ¼ë¡œ íŒ”ë¦¬ëŠ” êµ¬ì¡°"</div>
        <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
          âœ“ ì´ˆê¸°ë¹„ìš© <strong>0ì›</strong><br>
          âœ“ í”„ë¦¬ë¯¸ì—„ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬ë¡œ <strong>ë¹ ë¥¸ í™•ì‚°</strong><br>
          âœ“ ì´ë²¤íŠ¸ ê¸°íšÂ·ì‚¬ì€í’ˆÂ·íŒ¨í‚¤ì§•Â·ê²°ì œì°½ <strong>ì¼ê´„ ì§€ì›</strong><br>
          âœ“ <strong>3~7ì¼ ë‚´ ë¹ ë¥¸ ì •ì‚°</strong>, ì¶”ê°€ ê´€ë¦¬ë¹„ ì—†ìŒ<br>
          âœ“ ì½˜í…ì¸  <strong>2ì°¨ ë§ˆì¼€íŒ… í™œìš©</strong> ê°€ëŠ¥
        </div>
      </div>
      
      <!-- ì…€ëŸ¬ -->
      <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 24px; border: 1px solid #FCD34D;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ‘©â€ğŸ’¼</div>
        <div style="font-size: 18px; font-weight: 700; color: #B45309; margin-bottom: 8px;">ì…€ëŸ¬</div>
        <div style="font-size: 13px; color: #D97706; font-weight: 600; margin-bottom: 16px;">"ì½˜í…ì¸ ëŠ” ì…€ëŸ¬ê°€, êµ¬ì¡°ëŠ” ëª¨ì—¬ë¼ë”œì´"</div>
        <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
          âœ“ ì´ˆê¸°ë¹„ìš© <strong>0ì›</strong><br>
          âœ“ ê¸°íšÂ·ë””ìì¸Â·ê²°ì œÂ·ì •ì‚°ê¹Œì§€ <strong>í’€ì„œí¬íŠ¸</strong><br>
          âœ“ ì „ì† ê³„ì•½ ê¸°ë°˜ <strong>ìˆ˜ìµ ì•ˆì •ì„±</strong> í™•ë³´<br>
          âœ“ ë¸Œëœë“œ ì§ê±°ë˜/ì •ì‚° <strong>ë¦¬ìŠ¤í¬ ì°¨ë‹¨</strong><br>
          âœ“ ì„±ì¥ ì‹œ ìˆ˜ìˆ˜ë£Œ ìƒìŠ¹, <strong>ë¸Œëœë“œí™”ê¹Œì§€ í™•ì¥</strong>
        </div>
      </div>
      
      <!-- ì†Œë¹„ì -->
      <div style="background: linear-gradient(135deg, #DCFCE7, #BBF7D0); border-radius: 16px; padding: 24px; border: 1px solid #86EFAC;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ›’</div>
        <div style="font-size: 18px; font-weight: 700; color: #166534; margin-bottom: 8px;">ì†Œë¹„ì</div>
        <div style="font-size: 13px; color: #16A34A; font-weight: 600; margin-bottom: 16px;">"ì‹ ë¢°ë¥¼ ì „ì œë¡œ í•œ ê³µë™êµ¬ë§¤ ê²½í—˜"</div>
        <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
          âœ“ ê´‘ê³ ê°€ ì•„ë‹Œ, <strong>ì‹¤ì œ ì‚¬ìš© ê¸°ë°˜ ì¶”ì²œ</strong><br>
          âœ“ ê³µì‹ ë¸Œëœë“œ ì—°ë™ìœ¼ë¡œ <strong>ê°€ê²©Â·í’ˆì§ˆ ì‹ ë¢°</strong><br>
          âœ“ <strong>ë³µì¡í•œ ê²½ë¡œ ì—†ëŠ”</strong> ê°„í¸ êµ¬ë§¤<br>
          âœ“ ì…€ëŸ¬ê°€ ì§ì ‘ ì¨ë³´ê³  ì¢‹ì•˜ë˜ ì œí’ˆ<br>
          âœ“ <strong>í•©ë¦¬ì ì¸ ê°€ê²©</strong>ì— ë§Œë‚˜ëŠ” í’ˆì§ˆ
        </div>
      </div>
    </div>
    
    <!-- ë³¸ì§ˆì  ì°¨ë³„ì  -->
    <div style="background: #F9FAFB; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
      <div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 16px;">ğŸ† ëª¨ì—¬ë¼ë”œì˜ ë³¸ì§ˆì  ì°¨ë³„ì  (MOAT)</div>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
        <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
          <div style="width: 40px; height: 40px; background: #E8F3FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ“Š</div>
          <div>
            <div style="font-size: 14px; font-weight: 600; color: #191F28;">ì…€ëŸ¬ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬ & ë¹…ë°ì´í„°</div>
            <div style="font-size: 12px; color: #6B7684;">ì–´ë–¤ ìƒí’ˆì´ ì˜ íŒ”ë¦¬ëŠ”ì§€ ë°ì´í„° ê¸°ë°˜ ë¶„ì„</div>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
          <div style="width: 40px; height: 40px; background: #FEF3C7; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ“</div>
          <div>
            <div style="font-size: 14px; font-weight: 600; color: #191F28;">ì „ì† ê³„ì•½ ê¸°ë°˜ì˜ ì•ˆì •ì  êµ¬ì¡°</div>
            <div style="font-size: 12px; color: #6B7684;">1ë…„ ì „ì†ê³„ì•½ìœ¼ë¡œ ì§ê±°ë˜ ìœ„í—˜ ì°¨ë‹¨</div>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
          <div style="width: 40px; height: 40px; background: #DCFCE7; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">âš¡</div>
          <div>
            <div style="font-size: 14px; font-weight: 600; color: #191F28;">í’€ìŠ¤íƒ ìœ í†µ ìš´ì˜</div>
            <div style="font-size: 12px; color: #6B7684;">ì´ë²¤íŠ¸Â·ì •ì‚°Â·ê²°ì œê¹Œì§€ ì›ìŠ¤í†± ì§€ì›</div>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
          <div style="width: 40px; height: 40px; background: #FCE7F3; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ’</div>
          <div>
            <div style="font-size: 14px; font-weight: 600; color: #191F28;">"ì‹ ë¢° â†’ êµ¬ë§¤" êµ¬ì¡°</div>
            <div style="font-size: 12px; color: #6B7684;">ê´‘ê³ â†’ì „í™˜ì´ ì•„ë‹Œ, ì‹ ë¢° ê¸°ë°˜ í”Œë«í¼</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ë¹„ì „ -->
    <div style="background: linear-gradient(135deg, #fc9600, #e08600); border-radius: 12px; padding: 24px; color: white; text-align: center;">
      <div style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">ğŸš€ ëª¨ì—¬ë¼ë”œì´ ë§Œë“œëŠ” ë¯¸ë˜</div>
      <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
        <div>
          <div style="font-size: 24px; margin-bottom: 4px;">ğŸ­</div>
          <div style="font-size: 13px; opacity: 0.9;">ë¸Œëœë“œì—ê²ŒëŠ”</div>
          <div style="font-size: 14px; font-weight: 600;">ê°€ì¥ íš¨ìœ¨ì ì¸ ìœ í†µ ì±„ë„</div>
        </div>
        <div>
          <div style="font-size: 24px; margin-bottom: 4px;">ğŸ‘©â€ğŸ’¼</div>
          <div style="font-size: 13px; opacity: 0.9;">ì…€ëŸ¬ì—ê²ŒëŠ”</div>
          <div style="font-size: 14px; font-weight: 600;">ì§€ì† ê°€ëŠ¥í•œ ìˆ˜ìµ ì¸í”„ë¼</div>
        </div>
        <div>
          <div style="font-size: 24px; margin-bottom: 4px;">ğŸ›’</div>
          <div style="font-size: 13px; opacity: 0.9;">ì†Œë¹„ìì—ê²ŒëŠ”</div>
          <div style="font-size: 14px; font-weight: 600;">ê°€ì¥ ë¯¿ì„ ìˆ˜ ìˆëŠ” ì¶”ì²œ ê³µê°„</div>
        </div>
      </div>
    </div>
  `;
}

// íŒŒíŠ¸ë„ˆ ì‘ëŒ€ ê°€ì´ë“œ
function getPartnerContent() {
  return `
    <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 20px;">ğŸ¤ íŒŒíŠ¸ë„ˆ ì‘ëŒ€ ê°€ì´ë“œ</div>
    
    <!-- ê³µê¸‰ì‚¬ ì‘ëŒ€ -->
    <div style="background: #EEF2FF; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #C7D2FE;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
        <span style="font-size: 24px;">ğŸ­</span>
        <span style="font-size: 16px; font-weight: 700; color: #4338CA;">ê³µê¸‰ì‚¬ ì‘ëŒ€ ì‹œ í•µì‹¬ í¬ì¸íŠ¸</span>
      </div>
      
      <div style="background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
        <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸ“Œ ì²« ì»¨íƒ ì‹œ ì „ë‹¬í•  ë©”ì‹œì§€</div>
        <div style="font-size: 13px; color: #4B5563; line-height: 1.8; padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 3px solid #4338CA;">
          "ëª¨ì—¬ë¼ë”œì€ ë‹¨ìˆœ ë²¤ë”ì‚¬ê°€ ì•„ë‹ˆë¼,<br>
          <strong>ì œí’ˆì´ ì‹œì¥ì— ë¹ ë¥´ê²Œ ë…¸ì¶œë˜ê³  ì‹¤êµ¬ë§¤ë¡œ ì´ì–´ì§€ëŠ” êµ¬ì¡°</strong>ë¥¼ ë§Œë“œëŠ” ê³³ì…ë‹ˆë‹¤."
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
        <div style="background: white; border-radius: 8px; padding: 14px;">
          <div style="font-size: 13px; font-weight: 600; color: #4338CA; margin-bottom: 8px;">âœ… ê°•ì¡°í•´ì•¼ í•  ê²ƒ</div>
          <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
            â€¢ ì´ˆê¸°ë¹„ìš© 0ì›<br>
            â€¢ í”„ë¦¬ë¯¸ì—„ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬<br>
            â€¢ ì´ë²¤íŠ¸ ê¸°íšÂ·ì‚¬ì€í’ˆÂ·ê²°ì œì°½ ì§€ì›<br>
            â€¢ 3~7ì¼ ë‚´ ë¹ ë¥¸ ì •ì‚°<br>
            â€¢ ì½˜í…ì¸  2ì°¨ ë§ˆì¼€íŒ… í™œìš© ê°€ëŠ¥
          </div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 14px;">
          <div style="font-size: 13px; font-weight: 600; color: #DC2626; margin-bottom: 8px;">âŒ í”¼í•´ì•¼ í•  ê²ƒ</div>
          <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
            â€¢ ë‹¨ìˆœ "ê³µë™êµ¬ë§¤ ì§„í–‰í•´ìš”" ì‹ ì ‘ê·¼<br>
            â€¢ ìˆ˜ìˆ˜ë£Œë§Œ ê°•ì¡°í•˜ëŠ” ì„¤ëª…<br>
            â€¢ íŒë§¤ ë³´ì¥ ì•½ì†<br>
            â€¢ ê²½ìŸì‚¬ ë¹„ë°©
          </div>
        </div>
      </div>
    </div>
    
    <!-- ì…€ëŸ¬ ì‘ëŒ€ -->
    <div style="background: #FEF3C7; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #FCD34D;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
        <span style="font-size: 24px;">ğŸ‘©â€ğŸ’¼</span>
        <span style="font-size: 16px; font-weight: 700; color: #B45309;">ì…€ëŸ¬ ì‘ëŒ€ ì‹œ í•µì‹¬ í¬ì¸íŠ¸</span>
      </div>
      
      <div style="background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
        <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸ“Œ ì²« ì»¨íƒ ì‹œ ì „ë‹¬í•  ë©”ì‹œì§€</div>
        <div style="font-size: 13px; color: #4B5563; line-height: 1.8; padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 3px solid #B45309;">
          "ëª¨ì—¬ë¼ë”œì€ ì…€ëŸ¬ê°€ <strong>'ì§€ì†ì ìœ¼ë¡œ ì˜ íŒ” ìˆ˜ ìˆëŠ” êµ¬ì¡°'</strong>ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ì„±ì¥ í”Œë«í¼ì…ë‹ˆë‹¤.<br>
          ì½˜í…ì¸ ëŠ” ì…€ëŸ¬ê°€, êµ¬ì¡°ëŠ” ëª¨ì—¬ë¼ë”œì´ ì±…ì„ì§‘ë‹ˆë‹¤."
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
        <div style="background: white; border-radius: 8px; padding: 14px;">
          <div style="font-size: 13px; font-weight: 600; color: #B45309; margin-bottom: 8px;">âœ… ê°•ì¡°í•´ì•¼ í•  ê²ƒ</div>
          <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
            â€¢ ì´ˆê¸°ë¹„ìš© 0ì›, í’€ì„œí¬íŠ¸<br>
            â€¢ ì „ì†ê³„ì•½ìœ¼ë¡œ ìˆ˜ìµ ì•ˆì •ì„±<br>
            â€¢ ë¸Œëœë“œ í˜‘ìƒ/ì •ì‚° ìœ„í—˜ ì°¨ë‹¨<br>
            â€¢ ì„±ì¥ ì‹œ ìˆ˜ìˆ˜ë£Œ ìë™ ìƒìŠ¹<br>
            â€¢ ODM/OEM ë¸Œëœë“œí™” ì§€ì›
          </div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 14px;">
          <div style="font-size: 13px; font-weight: 600; color: #DC2626; margin-bottom: 8px;">âŒ í”¼í•´ì•¼ í•  ê²ƒ</div>
          <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
            â€¢ "ë§ì´ íŒ”ë©´ ëˆ ë©ë‹ˆë‹¤" ì‹ ì ‘ê·¼<br>
            â€¢ ìˆ˜ìµë§Œ ê°•ì¡°í•˜ëŠ” ì„¤ëª…<br>
            â€¢ ì „ì†ê³„ì•½ ë¶€ë‹´ê° ì£¼ê¸°<br>
            â€¢ ì„±ê¸‰í•œ ê³„ì•½ ìš”êµ¬
          </div>
        </div>
      </div>
      
      <div style="background: white; border-radius: 8px; padding: 14px; margin-top: 12px;">
        <div style="font-size: 13px; font-weight: 600; color: #B45309; margin-bottom: 8px;">ğŸ’° ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ êµ¬ì¡° ì„¤ëª…</div>
        <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
          â€¢ ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ: í˜‘ì˜ (ìƒí’ˆ/ì…€ëŸ¬ë³„ ìƒì´)<br>
          â€¢ 500ê°œ ì´ìƒ íŒë§¤ ì‹œ: ë³´ë„ˆìŠ¤ ë§ˆì§„ +1%ì”© (ëª¨ì—¬ë¼ë”œ ë¶€ë‹´)<br>
          â€¢ ì •ì‚°: ê³µêµ¬ ì¢…ë£Œ í›„ 3~7ì¼ ë‚´ ë¹ ë¥¸ ì…ê¸ˆ
        </div>
      </div>
    </div>
    
    <!-- FAQ -->
    <div style="background: #F2F4F6; border-radius: 12px; padding: 20px;">
      <div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 16px;">â“ ìì£¼ ë°›ëŠ” ì§ˆë¬¸ & ë‹µë³€</div>
      
      <div style="display: grid; gap: 12px;">
        <div style="background: white; border-radius: 10px; padding: 16px;">
          <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ì™œ ì´ˆê¸°ë¹„ìš©ì´ 0ì›ì¸ê°€ìš”?</div>
          <div style="font-size: 13px; color: #4B5563;">A. ëª¨ì—¬ë¼ë”œì€ íŒë§¤ ìˆ˜ìˆ˜ë£Œ ê¸°ë°˜ ìˆ˜ìµ êµ¬ì¡°ì…ë‹ˆë‹¤. íŒŒíŠ¸ë„ˆì˜ ì„±ê³µì´ ê³§ ìš°ë¦¬ì˜ ì„±ê³µì´ê¸° ë•Œë¬¸ì—, ì§„ì… ì¥ë²½ì„ ë‚®ì¶”ê³  í•¨ê»˜ ì„±ì¥í•˜ëŠ” êµ¬ì¡°ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>
        <div style="background: white; border-radius: 10px; padding: 16px;">
          <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ë‹¤ë¥¸ ê³µë™êµ¬ë§¤ í”Œë«í¼ê³¼ ë­ê°€ ë‹¤ë¥¸ê°€ìš”?</div>
          <div style="font-size: 13px; color: #4B5563;">A. ëª¨ì—¬ë¼ë”œì€ 'ì‹ ë¢° â†’ êµ¬ë§¤' êµ¬ì¡°ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¨ìˆœ ì¤‘ê°œê°€ ì•„ë‹ˆë¼, ì´ë²¤íŠ¸ ê¸°íšë¶€í„° ì •ì‚°ê¹Œì§€ í’€ìŠ¤íƒ ìœ í†µ ìš´ì˜ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
        </div>
        <div style="background: white; border-radius: 10px; padding: 16px;">
          <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ì „ì†ê³„ì•½ì´ë©´ ë‹¤ë¥¸ ê³³ì—ì„œ ëª» íŒŒë‚˜ìš”?</div>
          <div style="font-size: 13px; color: #4B5563;">A. ì „ì†ê³„ì•½ì€ 'ëª¨ì—¬ë¼ë”œ ì±„ë„ ë‚´'ì—ì„œì˜ ë…ì ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì…€ëŸ¬ë‹˜ì˜ ë‹¤ë¥¸ ì±„ë„ í™œë™ì—ëŠ” ì œí•œì´ ì—†ìœ¼ë©°, ì˜¤íˆë ¤ ì•ˆì •ì ì¸ ìˆ˜ìµ ë³´í˜¸ë¥¼ ìœ„í•œ ì¥ì¹˜ì…ë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>
  `;
}

function getProcessContent() {
  return `
    <!-- ì „ì²´ íë¦„ -->
    <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--gray-200);">
      <div style="font-size: 14px; font-weight: 700; color: var(--gray-800); margin-bottom: 12px;">ì „ì²´ íë¦„</div>
      <div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; font-size: 12px; font-weight: 600;">
        <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ìƒí’ˆ ì¤€ë¹„</span>
        <span style="color: var(--gray-400);">â†’</span>
        <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ì…€ëŸ¬ ì¤€ë¹„</span>
        <span style="color: var(--gray-400);">â†’</span>
        <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ê³µêµ¬ ë“±ë¡</span>
        <span style="color: var(--gray-400);">â†’</span>
        <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">íŒë§¤</span>
        <span style="color: var(--gray-400);">â†’</span>
        <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ì •ì‚°</span>
      </div>
    </div>
    
    <!-- ë‹¨ê³„ë³„ ì„¤ëª… -->
    <div style="display: grid; gap: 12px;">
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
          <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">1</div>
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ìƒí’ˆ ì¤€ë¹„</div>
          <span style="font-size: 11px; color: var(--gray-500); background: var(--gray-100); padding: 2px 8px; border-radius: 4px;">êµ¬ë§¤íŒ€</span>
        </div>
        <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
          <div>â‘  ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê³µê¸‰ì‚¬ ì°¾ê¸°</div>
          <div>â‘¡ ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ</div>
          <div>â‘¢ ìƒí’ˆ DBì— ë“±ë¡</div>
        </div>
      </div>
      
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
          <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">2</div>
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ì…€ëŸ¬ ì¤€ë¹„</div>
          <span style="font-size: 11px; color: var(--gray-500); background: var(--gray-100); padding: 2px 8px; border-radius: 4px;">ë§ˆì¼€íŒ…íŒ€</span>
        </div>
        <div style="padding-left: 38px;">
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 11px; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-weight: 600;">A. ì‹ ê·œ ì…€ëŸ¬ ë°œêµ´</span>
          </div>
          <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); margin-bottom: 12px; flex-wrap: wrap;">
            <div>â‘  ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¸í”Œë£¨ì–¸ì„œ ì°¾ê¸°</div>
            <div>â‘¡ ì»¨íƒ â†’ ì œì•ˆ â†’ ê³„ì•½</div>
            <div>â‘¢ ì…€ëŸ¬ DBì— ë“±ë¡</div>
          </div>
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 11px; background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-weight: 600;">B. ê¸°ì¡´ ì…€ëŸ¬ì—ê²Œ ì œì•ˆ</span>
          </div>
          <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); flex-wrap: wrap;">
            <div>â‘  ì…€ëŸ¬ DBì—ì„œ ì í•©í•œ ì…€ëŸ¬ ì„ íƒ</div>
            <div>â‘¡ ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ì…€ëŸ¬ ë§ˆì§„ í˜‘ìƒ</div>
            <div>â‘¢ ì…€ëŸ¬ ì œì•ˆì„œ ì „ë‹¬</div>
          </div>
        </div>
      </div>
      
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
          <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">3</div>
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ê³µêµ¬ ë“±ë¡</div>
        </div>
        <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
          <div>â‘  ê³µêµ¬ ìº˜ë¦°ë”ì—ì„œ ê³µêµ¬ ë“±ë¡</div>
          <div>â‘¡ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ê°€ì´ë“œ ì „ë‹¬</div>
          <div>â‘¢ ì…€ëŸ¬ê°€ SNSì— í™ë³´</div>
        </div>
      </div>
      
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
          <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">4</div>
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">íŒë§¤ & ì •ì‚°</div>
        </div>
        <div style="display: flex; gap: 16px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
          <div>â‘  ì†Œë¹„ìê°€ ëª¨ì—¬ë¼ë”œì—ì„œ ê²°ì œ</div>
          <div>â‘¡ ê³µê¸‰ì‚¬ì—ê²Œ ë°œì£¼ì„œ ì „ë‹¬</div>
          <div>â‘¢ ê³µê¸‰ì‚¬ê°€ ìƒí’ˆ ë°°ì†¡</div>
          <div>â‘£ ê³µê¸‰ì‚¬ê°€ ì†¡ì¥ ëª¨ì—¬ë¼ë”œì—ê²Œ ì „ë‹¬</div>
          <div>â‘¤ ê³µêµ¬ ì¢…ë£Œ í›„ ì…€ëŸ¬, ê³µê¸‰ì‚¬ì—ê²Œ 3~7ì¼ ë‚´ ì •ì‚°</div>
        </div>
      </div>
    </div>
    
    <!-- ìˆ˜ìµ êµ¬ì¡° -->
    <div style="background: var(--gray-50); border-radius: 10px; padding: 16px; margin-top: 16px; border: 1px solid var(--gray-200);">
      <div style="font-size: 13px; font-weight: 700; color: var(--gray-800); margin-bottom: 10px;">ìˆ˜ìµ êµ¬ì¡°</div>
      <div style="display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 11px; flex-wrap: wrap;">
        <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
          <div style="font-weight: 600; color: var(--gray-700);">ê³µê¸‰ì‚¬</div>
          <div style="color: var(--gray-500);">ê³µê¸‰ê°€</div>
        </div>
        <span style="color: var(--gray-400);">+</span>
        <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
          <div style="font-weight: 600; color: var(--gray-700);">ì…€ëŸ¬</div>
          <div style="color: var(--gray-500);">ë§ˆì§„(-3.3%)</div>
        </div>
        <span style="color: var(--gray-400);">+</span>
        <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
          <div style="font-weight: 600; color: var(--gray-700);">PGì‚¬</div>
          <div style="color: var(--gray-500);">4%</div>
        </div>
        <span style="color: var(--gray-400);">+</span>
        <div style="text-align: center; padding: 8px 12px; background: var(--primary); border-radius: 6px; color: white;">
          <div style="font-weight: 600;">ëª¨ì—¬ë¼ë”œ</div>
          <div style="opacity: 0.9;">ìˆœì´ìµ</div>
        </div>
      </div>
      <div style="text-align: center; margin-top: 10px; font-size: 11px; color: var(--gray-500);">
        * 500ê°œ ì´ìƒ íŒë§¤ ì‹œ ì…€ëŸ¬ ë³´ë„ˆìŠ¤ ë§ˆì§„ +1%ì”© (ëª¨ì—¬ë¼ë”œ ë¶€ë‹´)
      </div>
    </div>
  `;
}

function getMenuContent() {
  return `
    <div style="display: grid; gap: 16px;">
      <!-- ê³µêµ¬ì„¼í„° -->
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;">
        <div style="background: var(--primary); color: white; padding: 12px 16px; font-weight: 700; font-size: 14px;">
          ê³µêµ¬ì„¼í„°
        </div>
        <div style="padding: 16px;">
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 110px; font-size: 13px;">ê³µêµ¬ ìº˜ë¦°ë”</div>
              <div style="font-size: 12px; color: var(--gray-600);">ê³µêµ¬ë¥¼ ë“±ë¡í•˜ê³  ìº˜ë¦°ë”ì—ì„œ í•œëˆˆì— í™•ì¸í•´ìš”. ë‚ ì§œ í´ë¦­í•´ì„œ ìƒˆ ê³µêµ¬ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 110px; font-size: 13px;">ê³µêµ¬ í˜„í™©/ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
              <div style="font-size: 12px; color: var(--gray-600);">ë“±ë¡ëœ ê³µêµ¬ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ê´€ë¦¬í•´ìš”. ìƒíƒœ, ê¸°ê°„, ë§¤ì¶œ ë“±ì„ í™•ì¸í•©ë‹ˆë‹¤.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 110px; font-size: 13px;">ê³µêµ¬ ì œì•ˆ ê´€ë¦¬</div>
              <div style="font-size: 12px; color: var(--gray-600);">ê³µê¸‰ì‚¬ ê¸´ê¸‰ìš”ì²­ ì ‘ìˆ˜, ì…€ëŸ¬ì—ê²Œ ì œì•ˆ, ê³µêµ¬ ì„±ì‚¬ë¥¼ ê´€ë¦¬í•´ìš”.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 110px; font-size: 13px;">ì •ì‚° ê´€ë¦¬</div>
              <div style="font-size: 12px; color: var(--gray-600);">ì¹´í˜24 ë§¤ì¶œ ì—°ë™, ê³µê¸‰ì‚¬/ì…€ëŸ¬ ì •ì‚°ì„ ì²˜ë¦¬í•´ìš”.</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- íŒŒíŠ¸ë„ˆ ê´€ë¦¬ -->
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;">
        <div style="background: var(--primary); color: white; padding: 12px 16px; font-weight: 700; font-size: 14px;">
          íŒŒíŠ¸ë„ˆ ê´€ë¦¬
        </div>
        <div style="padding: 16px;">
          <div style="font-size: 12px; font-weight: 600; color: var(--gray-500); margin-bottom: 8px; padding-left: 4px;">ê³µê¸‰ì‚¬ ê´€ë¦¬</div>
          <div style="display: grid; gap: 8px; margin-bottom: 16px;">
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 80px; font-size: 13px;">ê³µê¸‰ì‚¬ DB</div>
              <div style="font-size: 12px; color: var(--gray-600);">ê³„ì•½ëœ ê³µê¸‰ì‚¬ ëª©ë¡. ê³µê¸‰ì‚¬ ì •ë³´ì™€ ê³„ì•½ ì¡°ê±´ì„ ê´€ë¦¬í•´ìš”.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 80px; font-size: 13px;">ìƒí’ˆ DB</div>
              <div style="font-size: 12px; color: var(--gray-600);">ë“±ë¡ëœ ìƒí’ˆ ëª©ë¡. ê³µê¸‰ê°€, íŒë§¤ê°€, ë§ˆì§„ ì •ë³´ê°€ ìˆì–´ìš”.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 80px; font-size: 13px;">ìƒí’ˆ ë¦¬ìŠ¤íŠ¸</div>
              <div style="font-size: 12px; color: var(--gray-600);">ê³µê¸‰ì‚¬ ë°œêµ´ìš©. ìƒˆë¡œìš´ ê³µê¸‰ì‚¬/ìƒí’ˆì„ ì°¾ì•„ì„œ ê¸°ë¡í•´ìš”.</div>
            </div>
          </div>
          
          <div style="font-size: 12px; font-weight: 600; color: var(--gray-500); margin-bottom: 8px; padding-left: 4px;">ì…€ëŸ¬ ê´€ë¦¬</div>
          <div style="display: grid; gap: 8px; margin-bottom: 16px;">
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 80px; font-size: 13px;">ì…€ëŸ¬ DB</div>
              <div style="font-size: 12px; color: var(--gray-600);">ê³„ì•½ëœ ì…€ëŸ¬ ëª©ë¡. ì…€ëŸ¬ ì •ë³´ì™€ ê³„ì•½ ì¡°ê±´ì„ ê´€ë¦¬í•´ìš”.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 80px; font-size: 13px;">ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</div>
              <div style="font-size: 12px; color: var(--gray-600);">ì…€ëŸ¬ ë°œêµ´ìš©. ìƒˆë¡œìš´ ì…€ëŸ¬ë¥¼ ì°¾ì•„ì„œ ì»¨íƒ/ì œì•ˆ/ê³„ì•½ ìƒíƒœë¥¼ ê´€ë¦¬í•´ìš”.</div>
            </div>
          </div>
          
          <div style="font-size: 12px; font-weight: 600; color: var(--gray-500); margin-bottom: 8px; padding-left: 4px;">ê¸°íƒ€</div>
          <div style="display: grid; gap: 8px;">
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 80px; font-size: 13px;">ê³µìœ  ë§í¬</div>
              <div style="font-size: 12px; color: var(--gray-600);">íŒŒíŠ¸ë„ˆì—ê²Œ ê³µìœ í•  ë§í¬ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•´ìš”.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); min-width: 80px; font-size: 13px;">íŒŒíŠ¸ë„ˆ ê³µì§€</div>
              <div style="font-size: 12px; color: var(--gray-600);">ê³µê¸‰ì‚¬/ì…€ëŸ¬ì—ê²Œ ê³µì§€í•  ë‚´ìš©ì„ ì‘ì„±í•˜ê³  ë°œì†¡í•´ìš”.</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ì¹´í˜24 ì—°ë™ -->
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;">
        <div style="background: #10b981; color: white; padding: 12px 16px; font-weight: 700; font-size: 14px;">
          ì¹´í˜24 ì—°ë™
        </div>
        <div style="padding: 16px;">
          <div style="display: grid; gap: 8px;">
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: #10b981; min-width: 80px; font-size: 13px;">ëŒ€ì‹œë³´ë“œ</div>
              <div style="font-size: 12px; color: var(--gray-600);">ì¹´í˜24 ì‡¼í•‘ëª° ë§¤ì¶œ, ì£¼ë¬¸, ìƒí’ˆ í˜„í™©ì„ í•œëˆˆì— ë´ìš”.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: #10b981; min-width: 80px; font-size: 13px;">ì£¼ë¬¸í˜„í™©</div>
              <div style="font-size: 12px; color: var(--gray-600);">ì‹¤ì‹œê°„ ì£¼ë¬¸ ëª©ë¡ì„ í™•ì¸í•˜ê³  ë°°ì†¡ ìƒíƒœë¥¼ ê´€ë¦¬í•´ìš”.</div>
            </div>
            <div style="display: flex; gap: 12px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: #10b981; min-width: 80px; font-size: 13px;">í†µê³„</div>
              <div style="font-size: 12px; color: var(--gray-600);">ë§¤ì¶œ ì¶”ì´, ë² ìŠ¤íŠ¸ ìƒí’ˆ, ê³ ê° ë¶„ì„ ë“± í†µê³„ë¥¼ ë´ìš”.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function getToolsContent() {
  return `
    <div style="display: grid; gap: 16px;">
      <!-- ë§ˆì§„ ê³„ì‚°ê¸° -->
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;">
        <div style="background: var(--primary); color: white; padding: 12px 16px; font-weight: 700; font-size: 14px;">
          ë§ˆì§„ ê³„ì‚°ê¸°
        </div>
        <div style="padding: 16px;">
          <p style="font-size: 12px; color: var(--gray-600); margin: 0 0 12px 0;">
            ê³µê¸‰ì‚¬/ì…€ëŸ¬ì™€ í˜‘ìƒí•  ë•Œ ë§ˆì§„ì„ ê³„ì‚°í•˜ëŠ” ë„êµ¬ì˜ˆìš”. í™”ë©´ ì˜¤ë¥¸ìª½ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ì—´ ìˆ˜ ìˆì–´ìš”.
          </p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); font-size: 13px; margin-bottom: 6px;">ì…€ëŸ¬ í˜‘ìƒìš©</div>
              <div style="font-size: 11px; color: var(--gray-600); line-height: 1.6;">
                - ìƒí’ˆ DBì—ì„œ ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°<br>
                - ì…€ëŸ¬ ë§ˆì§„ìœ¨ ì¡°ì •í•˜ë©° ì‹œë®¬ë ˆì´ì…˜<br>
                - ì…€ëŸ¬ ì œì•ˆì„œ PDF ë‹¤ìš´ë¡œë“œ
              </div>
            </div>
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-weight: 600; color: var(--primary); font-size: 13px; margin-bottom: 6px;">ê³µê¸‰ì‚¬ í˜‘ìƒìš©</div>
              <div style="font-size: 11px; color: var(--gray-600); line-height: 1.6;">
                - ê³µê¸‰ë‹¨ê°€/íŒë§¤ê°€ ì…ë ¥<br>
                - ìˆ˜ìµì„± íŒì • í™•ì¸<br>
                - í˜‘ìƒ ê²€í† ì„œ PDF ë‹¤ìš´ë¡œë“œ
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ì¹´í˜24 ì •ì‚° ë°©ë²• -->
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;">
        <div style="background: #10b981; color: white; padding: 12px 16px; font-weight: 700; font-size: 14px;">
          ì¹´í˜24 ì •ì‚° ë°©ë²•
        </div>
        <div style="padding: 16px;">
          <p style="font-size: 12px; color: var(--gray-600); margin: 0 0 12px 0;">
            ì¹´í˜24ì—ì„œ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ì•„ì„œ ì •ì‚°ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì´ì—ìš”.
          </p>
          <div style="background: var(--gray-50); border-radius: 8px; padding: 14px;">
            <div style="font-weight: 600; color: var(--primary); font-size: 12px; margin-bottom: 10px;">ğŸ“‹ ì •ì‚° ìˆœì„œ</div>
            <div style="font-size: 11px; color: var(--gray-600); line-height: 2;">
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: var(--primary); color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">1</span>
                <span>ì¹´í˜24 ê´€ë¦¬ì â†’ ì£¼ë¬¸ê´€ë¦¬ â†’ ì „ì²´ì£¼ë¬¸ì¡°íšŒ</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: var(--primary); color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">2</span>
                <span>ê³µêµ¬ ê¸°ê°„ìœ¼ë¡œ ë‚ ì§œ í•„í„° ì„¤ì •</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: var(--primary); color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">3</span>
                <span>"ì—‘ì…€ ë‹¤ìš´ë¡œë“œ" í´ë¦­í•˜ì—¬ ì£¼ë¬¸ ë°ì´í„° ë‹¤ìš´ë¡œë“œ</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: var(--primary); color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">4</span>
                <span>ì •ì‚° ê´€ë¦¬ â†’ ì—‘ì…€ ì—…ë¡œë“œ & ë§¤í•‘ìœ¼ë¡œ ê³µêµ¬ì™€ ì—°ë™</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: var(--primary); color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">5</span>
                <span>ê³µê¸‰ì‚¬/ì…€ëŸ¬ë³„ ì •ì‚° ê¸ˆì•¡ ìë™ ê³„ì‚°</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start;">
                <span style="background: var(--primary); color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">6</span>
                <span>ì •ì‚° ì™„ë£Œ ì²˜ë¦¬</span>
              </div>
            </div>
          </div>
          <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 11px; color: #92400e;">
            ğŸ’¡ ì—‘ì…€ íŒŒì¼ í˜•ì‹ì€ ì¹´í˜24 ê¸°ë³¸ ì–‘ì‹ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë¼ìš”!
          </div>
        </div>
      </div>
      
      <!-- PC ì–´í”Œ ë“±ë¡ ë°©ë²• -->
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;">
        <div style="background: #6366f1; color: white; padding: 12px 16px; font-weight: 700; font-size: 14px;">
          ğŸ’» PC ì–´í”Œë¡œ ë“±ë¡í•˜ê¸°
        </div>
        <div style="padding: 16px;">
          <p style="font-size: 12px; color: var(--gray-600); margin: 0 0 12px 0;">
            ê´€ë¦¬ì‹œìŠ¤í…œì„ PC ì–´í”Œì²˜ëŸ¼ ì‚¬ìš©í•˜ë©´ ë” í¸ë¦¬í•´ìš”! ë¸Œë¼ìš°ì € íƒ­ ì—†ì´ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ìš”.
          </p>
          <div style="background: var(--gray-50); border-radius: 8px; padding: 14px;">
            <div style="font-weight: 600; color: #6366f1; font-size: 12px; margin-bottom: 10px;">ğŸŒ Chrome / Edge ë¸Œë¼ìš°ì €</div>
            <div style="font-size: 11px; color: var(--gray-600); line-height: 2;">
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: #6366f1; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">1</span>
                <span>ê´€ë¦¬ì‹œìŠ¤í…œ í˜ì´ì§€ì— ì ‘ì†</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: #6366f1; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">2</span>
                <span>ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ì˜ <strong>ì„¤ì¹˜ ì•„ì´ì½˜(âŠ•)</strong> í´ë¦­</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: #6366f1; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">3</span>
                <span>"ì•± ì„¤ì¹˜" ë˜ëŠ” "ì„¤ì¹˜" ë²„íŠ¼ í´ë¦­</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start;">
                <span style="background: #6366f1; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">4</span>
                <span>ë°”íƒ•í™”ë©´/ì‹œì‘ë©”ë‰´ì—ì„œ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥!</span>
              </div>
            </div>
          </div>
          <div style="margin-top: 12px; background: var(--gray-50); border-radius: 8px; padding: 14px;">
            <div style="font-weight: 600; color: #6366f1; font-size: 12px; margin-bottom: 10px;">ğŸ“± ì„¤ì¹˜ ì•„ì´ì½˜ì´ ì•ˆ ë³´ì¼ ë•Œ</div>
            <div style="font-size: 11px; color: var(--gray-600); line-height: 2;">
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: #6366f1; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">1</span>
                <span>ë¸Œë¼ìš°ì € ìš°ì¸¡ ìƒë‹¨ <strong>â‹® (ë”ë³´ê¸°)</strong> ë©”ë‰´ í´ë¦­</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start; margin-bottom: 4px;">
                <span style="background: #6366f1; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">2</span>
                <span>"ì•± ì„¤ì¹˜" ë˜ëŠ” "ëª¨ì—¬ë¼ë”œ ê´€ë¦¬ì‹œìŠ¤í…œ ì„¤ì¹˜" ì„ íƒ</span>
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-start;">
                <span style="background: #6366f1; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px;">3</span>
                <span>ì„¤ì¹˜ ì™„ë£Œ í›„ ë°”íƒ•í™”ë©´ì—ì„œ ì‹¤í–‰!</span>
              </div>
            </div>
          </div>
          <div style="margin-top: 12px; padding: 10px; background: #ede9fe; border-radius: 6px; font-size: 11px; color: #5b21b6;">
            ğŸ’¡ ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ë©´ ì‘ì—…í‘œì‹œì¤„ì— ê³ ì •í•  ìˆ˜ ìˆì–´ì„œ ë” ë¹ ë¥´ê²Œ ì ‘ì†í•  ìˆ˜ ìˆì–´ìš”!
          </div>
        </div>
      </div>

      <!-- ê¸°ëŠ¥ ì¶”ê°€ ìš”ì²­ -->
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;">
        <div style="background: #ec4899; color: white; padding: 12px 16px; font-weight: 700; font-size: 14px;">
          ğŸ’¡ ê¸°ëŠ¥ ì¶”ê°€ ìš”ì²­
        </div>
        <div style="padding: 16px;">
          <p style="font-size: 12px; color: var(--gray-600); margin: 0 0 12px 0;">
            ë¶ˆí¸í•œ ì ì´ë‚˜ ì¶”ê°€ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ê¸°ëŠ¥ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”!
          </p>
          <div id="feature-request-form">
            <div style="margin-bottom: 12px;">
              <label style="font-size: 12px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ìš”ì²­ ìœ í˜•</label>
              <select id="feature-request-type" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 13px; background: white;">
                <option value="feature">âœ¨ ìƒˆ ê¸°ëŠ¥ ì¶”ê°€</option>
                <option value="improve">ğŸ”§ ê¸°ì¡´ ê¸°ëŠ¥ ê°œì„ </option>
                <option value="bug">ğŸ› ë²„ê·¸/ì˜¤ë¥˜ ì‹ ê³ </option>
                <option value="inconvenient">ğŸ˜¤ ë¶ˆí¸í•œ ì </option>
                <option value="other">ğŸ’¬ ê¸°íƒ€ ì˜ê²¬</option>
              </select>
            </div>
            <div style="margin-bottom: 12px;">
              <label style="font-size: 12px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ë‚´ìš©</label>
              <textarea id="feature-request-content" placeholder="ì–´ë–¤ ê¸°ëŠ¥ì´ í•„ìš”í•˜ì‹ ê°€ìš”? ë¶ˆí¸í•œ ì ì´ ìˆìœ¼ì‹ ê°€ìš”?" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 13px; min-height: 100px; resize: vertical; font-family: inherit;"></textarea>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="font-size: 12px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì‘ì„±ì (ì„ íƒ)</label>
              <input type="text" id="feature-request-author" placeholder="ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 13px;">
            </div>
            <button onclick="submitFeatureRequest()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #ec4899, #db2777); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
              ğŸ“® ìš”ì²­ ì œì¶œí•˜ê¸°
            </button>
          </div>
          <div id="feature-request-success" style="display: none; text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ‰</div>
            <div style="font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆì–´ìš”!</div>
            <div style="font-size: 12px; color: var(--gray-500);">ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤. ê²€í†  í›„ ë°˜ì˜í• ê²Œìš”.</div>
            <button onclick="resetFeatureRequestForm()" style="margin-top: 16px; padding: 10px 20px; background: var(--gray-100); color: var(--gray-700); border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
              âœï¸ ë‹¤ë¥¸ ìš”ì²­ ì‘ì„±í•˜ê¸°
            </button>
          </div>
        </div>
      </div>

      <!-- ê¸°ëŠ¥ ìš”ì²­ ëª©ë¡ -->
      <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;">
        <div style="background: var(--gray-100); padding: 12px 16px; font-weight: 700; font-size: 14px; color: var(--gray-700); display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ“‹ ì ‘ìˆ˜ëœ ìš”ì²­ ëª©ë¡</span>
          <button onclick="loadFeatureRequests()" style="background: white; border: 1px solid var(--gray-300); padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="feature-requests-list" style="padding: 16px; max-height: 300px; overflow-y: auto;">
          <div style="text-align: center; color: var(--gray-400); font-size: 13px; padding: 20px;">
            ë¡œë”© ì¤‘...
          </div>
        </div>
      </div>

      <!-- ìš©ì–´ ì„¤ëª… -->
      <div style="background: var(--gray-50); border-radius: 10px; padding: 16px; border: 1px solid var(--gray-200);">
        <div style="font-size: 13px; font-weight: 700; color: var(--gray-700); margin-bottom: 10px;">ìš©ì–´ ì„¤ëª…</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px; color: var(--gray-600);">
          <div><strong>ê³µê¸‰ì‚¬</strong> = ë¬¼ê±´ íŒŒëŠ” íšŒì‚¬</div>
          <div><strong>ì…€ëŸ¬</strong> = ì¸í”Œë£¨ì–¸ì„œ/ë¸”ë¡œê±°</div>
          <div><strong>ê³µêµ¬</strong> = ê³µë™êµ¬ë§¤</div>
          <div><strong>ë§ˆì§„</strong> = ë‚¨ëŠ” ëˆ (ì´ìµ)</div>
          <div><strong>PG</strong> = ì¹´ë“œê²°ì œ ìˆ˜ìˆ˜ë£Œ</div>
          <div><strong>ì •ì‚°</strong> = ëˆ ë‚˜ëˆ ì£¼ê¸°</div>
        </div>
      </div>
    </div>
  `;
}

// ========================================
// ê¸°ëŠ¥ ìš”ì²­ ì‹œìŠ¤í…œ
// ========================================

// ê¸°ëŠ¥ ìš”ì²­ ì œì¶œ
async function submitFeatureRequest() {
  const type = document.getElementById('feature-request-type').value;
  const content = document.getElementById('feature-request-content').value.trim();
  const author = document.getElementById('feature-request-author').value.trim();

  if (!content) {
    alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
    return;
  }

  try {
    await db.collection('feature_requests').add({
      type: type,
      content: content,
      author: author || 'ìµëª…',
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById('feature-request-form').style.display = 'none';
    document.getElementById('feature-request-success').style.display = 'block';
    loadFeatureRequests();
  } catch (e) {
    console.error('ê¸°ëŠ¥ ìš”ì²­ ì €ì¥ ì˜¤ë¥˜:', e);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

// í¼ ì´ˆê¸°í™”
function resetFeatureRequestForm() {
  document.getElementById('feature-request-type').value = 'feature';
  document.getElementById('feature-request-content').value = '';
  document.getElementById('feature-request-author').value = '';
  document.getElementById('feature-request-form').style.display = 'block';
  document.getElementById('feature-request-success').style.display = 'none';
}

// ê¸°ëŠ¥ ìš”ì²­ ëª©ë¡ ë¡œë“œ
async function loadFeatureRequests() {
  const listEl = document.getElementById('feature-requests-list');
  if (!listEl) return;

  try {
    const snapshot = await db.collection('feature_requests')
      .orderBy('createdAt', 'desc')
      .limit(20)
      .get();

    if (snapshot.empty) {
      listEl.innerHTML = `
        <div style="text-align: center; color: var(--gray-400); font-size: 13px; padding: 20px;">
          ì•„ì§ ì ‘ìˆ˜ëœ ìš”ì²­ì´ ì—†ì–´ìš”. ì²« ë²ˆì§¸ ìš”ì²­ì„ ë‚¨ê²¨ì£¼ì„¸ìš”! ğŸ™Œ
        </div>
      `;
      return;
    }

    const typeLabels = {
      feature: 'âœ¨ ìƒˆ ê¸°ëŠ¥',
      improve: 'ğŸ”§ ê°œì„ ',
      bug: 'ğŸ› ë²„ê·¸',
      inconvenient: 'ğŸ˜¤ ë¶ˆí¸',
      other: 'ğŸ’¬ ê¸°íƒ€'
    };

    const statusLabels = {
      pending: { text: 'ê²€í† ì¤‘', color: '#f59e0b', bg: '#fef3c7' },
      planned: { text: 'ì˜ˆì •ë¨', color: '#3b82f6', bg: '#dbeafe' },
      done: { text: 'ì™„ë£Œ', color: '#10b981', bg: '#d1fae5' },
      rejected: { text: 'ë³´ë¥˜', color: '#6b7280', bg: '#f3f4f6' }
    };

    let html = '';
    snapshot.forEach(doc => {
      const req = doc.data();
      const status = statusLabels[req.status] || statusLabels.pending;
      const date = req.createdAt ? new Date(req.createdAt.toDate()).toLocaleDateString('ko-KR') : '-';

      html += `
        <div style="background: var(--gray-50); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="display: flex; gap: 6px; align-items: center;">
              <span style="font-size: 11px; background: white; padding: 2px 8px; border-radius: 4px; color: var(--gray-600);">${typeLabels[req.type] || 'ğŸ’¬ ê¸°íƒ€'}</span>
              <span style="font-size: 11px; background: ${status.bg}; color: ${status.color}; padding: 2px 8px; border-radius: 4px; font-weight: 600;">${status.text}</span>
            </div>
            <span style="font-size: 10px; color: var(--gray-400);">${date}</span>
          </div>
          <div style="font-size: 13px; color: var(--gray-700); line-height: 1.5; white-space: pre-wrap;">${req.content}</div>
          <div style="font-size: 11px; color: var(--gray-400); margin-top: 8px;">by ${req.author || 'ìµëª…'}</div>
        </div>
      `;
    });

    listEl.innerHTML = html;
  } catch (e) {
    console.error('ê¸°ëŠ¥ ìš”ì²­ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', e);
    listEl.innerHTML = `
      <div style="text-align: center; color: var(--gray-400); font-size: 13px; padding: 20px;">
        ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆì–´ìš”. ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
    `;
  }
}

// ========================================
// OKR ê´€ë¦¬ ì‹œìŠ¤í…œ
// ========================================

// OKR ë¶„ê¸° ê³„ì‚° í•¨ìˆ˜
// OKR ë¶„ê¸° ê³„ì‚° (ì—° 3ë¶„ê¸° ê¸°ì¤€)
// 1ë¶„ê¸°: 1-4ì›”, 2ë¶„ê¸°: 5-8ì›”, 3ë¶„ê¸°: 9-12ì›”
function getQuarter(date = new Date()) {
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  let quarter;
  if (month <= 4) quarter = 1;
  else if (month <= 8) quarter = 2;
  else quarter = 3;
  return { year, quarter, label: `${year}ë…„ ${quarter}ë¶„ê¸°` };
}

function getQuarterOptions() {
  const options = [];
  const currentYear = new Date().getFullYear();

  // ì—° 3ë¶„ê¸° (1ë¶„ê¸°: 1-4ì›”, 2ë¶„ê¸°: 5-8ì›”, 3ë¶„ê¸°: 9-12ì›”)
  for (let year = currentYear - 1; year <= currentYear + 1; year++) {
    for (let quarter = 1; quarter <= 3; quarter++) {
      const quarterLabels = ['1-4ì›”', '5-8ì›”', '9-12ì›”'];
      options.push({
        value: `${year}-Q${quarter}`,
        label: `${year}ë…„ ${quarter}ë¶„ê¸° (${quarterLabels[quarter - 1]})`
      });
    }
  }

  return options;
}

// OKR ëŒ€ì‹œë³´ë“œ ë Œë”ë§
function renderOKRDashboard() {
  const app = document.getElementById('app');
  const currentQuarter = getQuarter();

  app.innerHTML = `
    <div class="page-header">
      <h1 style="font-size: 24px; font-weight: 700; color: var(--gray-900);">ğŸ¯ ê·¸ë¡œìŠ¤ë³´ë“œ OKR ëŒ€ì‹œë³´ë“œ</h1>
      <p style="color: var(--gray-600); margin-top: 8px;">${currentQuarter.label} - íŒ€ì›ë“¤ì˜ ì„±ì¥ê³¼ ê°œì„ ì„ í•¨ê»˜ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <div class="content">
      <div id="okr-dashboard-content">
        <div class="loading" style="text-align: center; padding: 40px;">
          <div class="loading-spinner"></div>
          <p style="margin-top: 16px; color: var(--gray-600);">OKR ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    </div>
  `;

  loadOKRDashboard();
}

async function loadOKRDashboard() {
  try {
    const currentQuarter = getQuarter();
    const quarterKey = `${currentQuarter.year}-Q${currentQuarter.quarter}`;

    // Firebaseì—ì„œ í˜„ì¬ ë¶„ê¸° OKR ë°ì´í„° ë¡œë“œ
    const okrSnapshot = await db.collection('okrs').where('quarter', '==', quarterKey).get();
    const teamSnapshot = await db.collection('teamMembers').get();

    const okrs = [];
    okrSnapshot.forEach(doc => {
      okrs.push({ id: doc.id, ...doc.data() });
    });

    const teamMembers = [];
    teamSnapshot.forEach(doc => {
      teamMembers.push({ id: doc.id, ...doc.data() });
    });

    renderOKRDashboardContent(okrs, teamMembers, quarterKey);
  } catch (error) {
    console.error('OKR ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    document.getElementById('okr-dashboard-content').innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--danger);">
        ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
      </div>
    `;
  }
}

function renderOKRDashboardContent(okrs, teamMembers, quarterKey) {
  const content = document.getElementById('okr-dashboard-content');

  if (okrs.length === 0) {
    content.innerHTML = `
      <div style="text-align: center; padding: 60px; background: var(--gray-50); border-radius: 12px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
        <p style="font-size: 16px; color: var(--gray-700); margin-bottom: 8px;">ì•„ì§ ë“±ë¡ëœ OKRì´ ì—†ìŠµë‹ˆë‹¤</p>
        <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 24px;">OKR ê´€ë¦¬ ë©”ë‰´ì—ì„œ ëª©í‘œë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”</p>
        <button onclick="switchTab('okrManagement')" style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
          OKR ë“±ë¡í•˜ê¸°
        </button>
      </div>
    `;
    return;
  }

  // íŒ€ì›ë³„ë¡œ OKR ê·¸ë£¹í™”
  const okrByMember = {};
  teamMembers.forEach(member => {
    okrByMember[member.id] = {
      member: member,
      okrs: okrs.filter(okr => okr.memberId === member.id)
    };
  });

  let html = `
    <div style="display: grid; gap: 20px;">
  `;

  Object.values(okrByMember).forEach(({ member, okrs: memberOkrs }) => {
    if (memberOkrs.length === 0) return;

    const avgProgress = memberOkrs.reduce((sum, okr) => sum + (okr.progress || 0), 0) / memberOkrs.length;
    const progressColor = avgProgress >= 70 ? 'var(--success)' : avgProgress >= 40 ? 'var(--warning)' : 'var(--danger)';

    html += `
      <div style="background: white; border-radius: 12px; padding: 24px; border: 1px solid var(--gray-200);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <h3 style="font-size: 18px; font-weight: 700; color: var(--gray-900);">${member.name}</h3>
            <p style="font-size: 14px; color: var(--gray-600); margin-top: 4px;">${member.position || 'íŒ€ì›'}</p>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 32px; font-weight: 700; color: ${progressColor};">${avgProgress.toFixed(0)}%</div>
            <div style="font-size: 12px; color: var(--gray-500);">í‰ê·  ë‹¬ì„±ë¥ </div>
          </div>
        </div>

        <div style="display: grid; gap: 12px;">
          ${memberOkrs.map(okr => `
            <div style="background: var(--gray-50); border-radius: 8px; padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div style="font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">
                    ${okr.objective}
                  </div>
                  ${okr.keyResults ? `
                    <div style="margin-top: 8px; padding-left: 12px; border-left: 2px solid var(--gray-300);">
                      ${okr.keyResults.map(kr => `
                        <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">
                          â€¢ ${kr.description} (ëª©í‘œ: ${kr.target})
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
                <div style="text-align: right; margin-left: 16px;">
                  <div style="font-size: 20px; font-weight: 700; color: ${okr.progress >= 70 ? 'var(--success)' : okr.progress >= 40 ? 'var(--warning)' : 'var(--danger)'};">
                    ${okr.progress || 0}%
                  </div>
                </div>
              </div>

              <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 8px;">
                <div style="background: ${okr.progress >= 70 ? 'var(--success)' : okr.progress >= 40 ? 'var(--warning)' : 'var(--danger)'}; height: 100%; width: ${okr.progress || 0}%; transition: width 0.3s;"></div>
              </div>

              ${okr.improvements ? `
                <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid var(--primary);">
                  <div style="font-size: 11px; font-weight: 600; color: var(--primary); margin-bottom: 4px;">ğŸ’¡ ê°œì„  ë…¸ë ¥</div>
                  <div style="font-size: 12px; color: var(--gray-700);">${okr.improvements}</div>
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  });

  html += `
      <div style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; padding: 24px; color: white; text-align: center;">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">ê·¸ë¡œìŠ¤ë³´ë“œëŠ” í¬ê¸°í•˜ì§€ ì•Šê³  ê°œì„ í•œ ë…¸ë ¥ì„ ì¤‘ìš”í•˜ê²Œ ë´…ë‹ˆë‹¤</h3>
        <p style="font-size: 14px; opacity: 0.9;">ê²°ê³¼ë³´ë‹¤ ê³¼ì •, ì™„ë²½í•¨ë³´ë‹¤ ì„±ì¥ì„ ì‘ì›í•©ë‹ˆë‹¤! ğŸ‰</p>
      </div>
    </div>
  `;

  content.innerHTML = html;
}

// OKR ê´€ë¦¬ í˜ì´ì§€ ë Œë”ë§
function renderOKRManagement() {
  const app = document.getElementById('app');
  const currentUser = state.currentUser || state.currentAdmin || {};
  const members = state.teamMembers || [];
  const isAdmin = currentUser.role === 'admin';

  app.innerHTML = `
    <div class="page-header">
      <h1 style="font-size: 24px; font-weight: 700; color: var(--gray-900);">âœï¸ OKR ê´€ë¦¬</h1>
      <p style="color: var(--gray-600); margin-top: 8px;">íŒ€ì›ë³„ ëª©í‘œë¥¼ ì„¤ì •í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>

    <div class="content">
      <!-- ë‹¬ì„±ë¥  ê³„ì‚° ë°©ì‹ ì•ˆë‚´ -->
      <div style="background: linear-gradient(135deg, #E8F3FF, #DBEAFE); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #93C5FD;">
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <div style="font-size: 28px;">ğŸ“Š</div>
          <div style="flex: 1;">
            <div style="font-size: 15px; font-weight: 700; color: #1E40AF; margin-bottom: 8px;">ë‹¬ì„±ë¥  ìë™ ê³„ì‚° ë°©ì‹</div>
            <div style="font-size: 13px; color: #1E3A8A; line-height: 1.6;">
              <p style="margin: 0 0 8px 0;">
                <strong>ë‹¬ì„±ë¥  = (ì™„ë£Œëœ ì—…ë¬´ ìˆ˜ Ã· ì „ì²´ ì—…ë¬´ ìˆ˜) Ã— 100%</strong>
              </p>
              <p style="margin: 0; opacity: 0.9;">
                ì—…ë¬´ì¼ì§€ì—ì„œ ì´ OKRê³¼ ì—°ê²°ëœ ì—…ë¬´ì˜ ìƒíƒœ(â³ëŒ€ê¸° / ğŸ”„ì§„í–‰ì¤‘ / âœ…ì™„ë£Œ / â¸ï¸ë³´ë¥˜)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
                ë§ì€ ì—…ë¬´ë¥¼ ì§„í–‰í•˜ê³ , ì™„ë£Œ ì²˜ë¦¬í•˜ë©´ ë‹¬ì„±ë¥ ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤!
              </p>
            </div>
          </div>
        </div>
      </div>

      <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
        <button onclick="openOKRModal()" style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
          + ìƒˆ OKR ë“±ë¡
        </button>

        <div style="flex: 1; min-width: 200px;">
          <select id="okr-member-filter" onchange="loadOKRList()" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; background: white;">
            <option value="mine" ${!isAdmin ? 'selected' : ''}>ğŸ¯ ë‚´ OKR</option>
            <option value="all" ${isAdmin ? 'selected' : ''}>ğŸ‘¥ ì „ì²´ íŒ€ì›</option>
            ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
          </select>
        </div>
      </div>

      <div id="okr-list-content">
        <div class="loading" style="text-align: center; padding: 40px;">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  `;

  loadOKRList();
}

async function loadOKRList() {
  try {
    const okrSnapshot = await db.collection('okrs').orderBy('createdAt', 'desc').get();
    const teamSnapshot = await db.collection('teamMembers').get();
    const taskSnapshot = await db.collection('tasks').get();

    let okrs = [];
    okrSnapshot.forEach(doc => {
      okrs.push({ id: doc.id, ...doc.data() });
    });

    const teamMembers = {};
    teamSnapshot.forEach(doc => {
      teamMembers[doc.id] = doc.data();
    });

    // ì—…ë¬´ ë°ì´í„° ìˆ˜ì§‘ (ë‹¬ì„±ë¥  ê³„ì‚°ìš©)
    const allTasks = [];
    taskSnapshot.forEach(doc => {
      allTasks.push({ id: doc.id, ...doc.data() });
    });

    // í•„í„° ì ìš©
    const filterEl = document.getElementById('okr-member-filter');
    const filterValue = filterEl ? filterEl.value : 'mine';
    const currentUser = state.currentUser || state.currentAdmin || {};

    if (filterValue === 'mine') {
      // ë‚´ OKRë§Œ í‘œì‹œ (memberIdê°€ í˜„ì¬ ì‚¬ìš©ì idì™€ ì¼ì¹˜í•˜ëŠ” ê²ƒ)
      okrs = okrs.filter(okr => okr.memberId === currentUser.id);
    } else if (filterValue !== 'all') {
      // íŠ¹ì • íŒ€ì› ì„ íƒ
      okrs = okrs.filter(okr => okr.memberId === filterValue);
    }

    // OKRë³„ ë‹¬ì„±ë¥ ì„ ì—°ê²°ëœ ì—…ë¬´ ìƒíƒœë¡œ ê³„ì‚°
    okrs = okrs.map(okr => {
      const linkedTasks = allTasks.filter(t => t.linkedOkrId === okr.id || t.okrId === okr.id);
      const totalTasks = linkedTasks.length;
      const completedTasks = linkedTasks.filter(t => t.status === 'ì™„ë£Œ').length;

      // ë‹¬ì„±ë¥  = ì™„ë£Œ ì—…ë¬´ / ì „ì²´ ì—…ë¬´ * 100
      const taskBasedProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

      return {
        ...okr,
        progress: taskBasedProgress,
        taskStats: {
          total: totalTasks,
          completed: completedTasks,
          inProgress: linkedTasks.filter(t => t.status === 'ì§„í–‰ì¤‘').length,
          pending: linkedTasks.filter(t => t.status === 'ëŒ€ê¸°').length,
          onHold: linkedTasks.filter(t => t.status === 'ë³´ë¥˜').length
        }
      };
    });

    renderOKRList(okrs, teamMembers);
  } catch (error) {
    console.error('OKR ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

function renderOKRList(okrs, teamMembers) {
  const content = document.getElementById('okr-list-content');

  if (okrs.length === 0) {
    content.innerHTML = `
      <div style="text-align: center; padding: 60px; background: var(--gray-50); border-radius: 12px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
        <p style="font-size: 16px; color: var(--gray-700);">ë“±ë¡ëœ OKRì´ ì—†ìŠµë‹ˆë‹¤</p>
        <p style="font-size: 14px; color: var(--gray-500); margin-top: 8px;">ìƒˆ OKRì„ ë“±ë¡í•´ë³´ì„¸ìš”</p>
      </div>
    `;
    return;
  }

  let html = '<div style="display: grid; gap: 16px;">';

  okrs.forEach(okr => {
    const member = teamMembers[okr.memberId] || { name: 'ì•Œ ìˆ˜ ì—†ìŒ' };
    const progressColor = okr.progress >= 70 ? 'var(--success)' : okr.progress >= 40 ? 'var(--warning)' : 'var(--danger)';

    html += `
      <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--gray-200);">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="background: var(--primary-light); color: var(--primary); padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                ${okr.quarter}
              </span>
              <span style="font-size: 14px; font-weight: 600; color: var(--gray-900);">${member.name}</span>
            </div>
            <div style="font-size: 16px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px;">
              ${okr.objective}
            </div>
            ${okr.keyResults ? `
              <div style="margin-top: 8px; padding-left: 12px; border-left: 2px solid var(--gray-300);">
                ${okr.keyResults.map((kr, idx) => `
                  <div style="font-size: 13px; color: var(--gray-700); margin-bottom: 4px;">
                    KR${idx + 1}: ${kr.description}
                    <span style="color: var(--gray-500);">ëª©í‘œ: ${kr.target}</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          <div style="text-align: right; margin-left: 20px;">
            <div style="font-size: 24px; font-weight: 700; color: ${progressColor}; margin-bottom: 4px;">
              ${okr.progress || 0}%
            </div>
            <div style="font-size: 11px; color: var(--gray-500);">ë‹¬ì„±ë¥ </div>
          </div>
        </div>

        <div style="background: var(--gray-200); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 12px;">
          <div style="background: ${progressColor}; height: 100%; width: ${okr.progress || 0}%; transition: width 0.3s;"></div>
        </div>

        ${okr.taskStats ? `
          <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
            <span style="background: #E5E7EB; color: #6B7280; padding: 4px 10px; border-radius: 6px; font-size: 11px;">
              ğŸ“‹ ì „ì²´ ${okr.taskStats.total}
            </span>
            <span style="background: #FEF3C7; color: #92400E; padding: 4px 10px; border-radius: 6px; font-size: 11px;">
              â³ ëŒ€ê¸° ${okr.taskStats.pending}
            </span>
            <span style="background: #DBEAFE; color: #1D4ED8; padding: 4px 10px; border-radius: 6px; font-size: 11px;">
              ğŸ”„ ì§„í–‰ì¤‘ ${okr.taskStats.inProgress}
            </span>
            <span style="background: #D1FAE5; color: #047857; padding: 4px 10px; border-radius: 6px; font-size: 11px;">
              âœ… ì™„ë£Œ ${okr.taskStats.completed}
            </span>
            <span style="background: #F3F4F6; color: #6B7684; padding: 4px 10px; border-radius: 6px; font-size: 11px;">
              â¸ï¸ ë³´ë¥˜ ${okr.taskStats.onHold}
            </span>
          </div>
        ` : ''}

        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="editOKR('${okr.id}')" style="background: var(--gray-100); color: var(--gray-700); border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
            ìˆ˜ì •
          </button>
          <button onclick="showLinkedTasks('${okr.id}', '${okr.objective.replace(/'/g, "\\'")}')" style="background: #E8F3FF; color: #0064FF; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
            ğŸ“‹ ì—°ê²°ëœ ì—…ë¬´
          </button>
          <button onclick="deleteOKR('${okr.id}')" style="background: var(--danger-light); color: var(--danger); border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
            ì‚­ì œ
          </button>
        </div>
      </div>
    `;
  });

  html += '</div>';
  content.innerHTML = html;
}

// OKRì— ì—°ê²°ëœ ì—…ë¬´ ë³´ê¸° ëª¨ë‹¬
async function showLinkedTasks(okrId, okrTitle) {
  try {
    // linkedOkrIdì™€ ê¸°ì¡´ okrId í•„ë“œ ëª¨ë‘ ì¡°íšŒ (í•˜ìœ„ í˜¸í™˜ì„±)
    var snapshot1 = await db.collection('tasks').where('linkedOkrId', '==', okrId).get();
    var snapshot2 = await db.collection('tasks').where('okrId', '==', okrId).get();

    var tasksMap = {};
    snapshot1.forEach(doc => tasksMap[doc.id] = { id: doc.id, ...doc.data() });
    snapshot2.forEach(doc => tasksMap[doc.id] = { id: doc.id, ...doc.data() });
    var tasks = Object.values(tasksMap);
    
    var modal = document.getElementById('modal');
    modal.className = 'modal active';
    
    var html = `
      <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="font-size: 18px; font-weight: 700;">ğŸ“‹ ì—°ê²°ëœ ì—…ë¬´</h2>
          <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button>
        </div>
        
        <div style="background: #E8F3FF; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
          <div style="font-size: 12px; color: #0064FF; margin-bottom: 4px;">ğŸ¯ ê´€ë ¨ OKR</div>
          <div style="font-size: 15px; font-weight: 600; color: #191F28;">${okrTitle}</div>
        </div>
        
        ${tasks.length === 0 ? `
          <div style="text-align: center; padding: 40px; background: #F2F4F6; border-radius: 12px;">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“</div>
            <div style="font-size: 14px; color: #6B7684;">ì•„ì§ ì—°ê²°ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 13px; color: #8B95A1; margin-top: 8px;">ì—…ë¬´ì¼ì§€ì—ì„œ ìƒˆ ì—…ë¬´ ì¶”ê°€ ì‹œ ì´ OKRì„ ì„ íƒí•˜ì„¸ìš”</div>
          </div>
        ` : `
          <div style="display: grid; gap: 12px;">
            ${tasks.map(task => {
              var statusColors = { 'ëŒ€ê¸°': '#F59E0B', 'ì§„í–‰ì¤‘': '#0064FF', 'ì™„ë£Œ': '#10B981', 'ë³´ë¥˜': '#6B7684' };
              var statusColor = statusColors[task.status] || '#6B7684';
              return `
                <div style="background: #F9FAFB; border-radius: 10px; padding: 14px; border-left: 3px solid ${statusColor};">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div style="font-size: 14px; font-weight: 600; color: #191F28;">${task.title}</div>
                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">${task.status}</span>
                  </div>
                  ${task.linkedKrTitle ? `<div style="font-size: 12px; color: #0064FF; margin-bottom: 6px;">â†’ ${task.linkedKrTitle}</div>` : ''}
                  <div style="display: flex; gap: 12px; font-size: 12px; color: #6B7684;">
                    <span>ğŸ‘¤ ${task.assignee || 'ë¯¸ì§€ì •'}</span>
                    ${task.dueDate ? `<span>ğŸ“… ${task.dueDate}</span>` : ''}
                    ${task.completedAt ? `<span style="color: #10B981;">âœ… ${task.completedAt.split('T')[0]} ì™„ë£Œ</span>` : ''}
                  </div>
                  ${task.note ? `<div style="font-size: 12px; color: #8B95A1; margin-top: 8px; background: white; padding: 8px; border-radius: 6px;">ğŸ“ ${task.note}</div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="margin-top: 20px; padding: 14px; background: #DCFCE7; border-radius: 10px; text-align: center;">
            <div style="font-size: 14px; color: #166534;">
              ì´ <strong>${tasks.length}</strong>ê°œ ì—…ë¬´ | 
              ì™„ë£Œ <strong>${tasks.filter(t => t.status === 'ì™„ë£Œ').length}</strong>ê°œ | 
              ì§„í–‰ì¤‘ <strong>${tasks.filter(t => t.status === 'ì§„í–‰ì¤‘').length}</strong>ê°œ
            </div>
          </div>
        `}
        
        <button onclick="closeModal()" style="width: 100%; margin-top: 20px; background: #F2F4F6; color: #333D4B; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600;">ë‹«ê¸°</button>
      </div>
    `;
    
    modal.innerHTML = html;
  } catch (error) {
    console.error('ì—°ê²°ëœ ì—…ë¬´ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// OKR ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬
async function openOKRModal(okrId = null) {
  try {
    // Firebase ì—°ê²° í™•ì¸
    if (!db) {
      alert('âŒ Firebase ì—°ê²° ì˜¤ë¥˜ì…ë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }

    const teamSnapshot = await db.collection('teamMembers').get();
    const teamMembers = [];
    teamSnapshot.forEach(doc => {
      teamMembers.push({ id: doc.id, ...doc.data() });
    });

    // íŒ€ì›ì´ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    if (teamMembers.length === 0) {
      alert('âŒ ë¨¼ì € íŒ€ì›ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.\n\nğŸ“ ê´€ë¦¬ì ë©”ë‰´ â†’ íŒ€ì› ê´€ë¦¬\nì—ì„œ íŒ€ì›ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return;
    }

    let okr = {
      memberId: '',
      quarter: `${getQuarter().year}-Q${getQuarter().quarter}`,
      objective: '',
      keyResults: [
        { description: '', target: '', current: 0 }
      ],
      progress: 0,
      improvements: ''
    };

    if (okrId) {
      const doc = await db.collection('okrs').doc(okrId).get();
      if (doc.exists) {
        okr = { id: doc.id, ...doc.data() };
      }
    }

    const quarterOptions = getQuarterOptions();

    const modal = document.getElementById('modal');
    modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <h2 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-bottom: 20px;">
        ${okrId ? 'OKR ìˆ˜ì •' : 'ìƒˆ OKR ë“±ë¡'}
      </h2>

      <div style="display: grid; gap: 16px;">
        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
            ë¶„ê¸° ì„ íƒ *
          </label>
          <select id="okr-quarter" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
            ${quarterOptions.map(opt => `
              <option value="${opt.value}" ${opt.value === okr.quarter ? 'selected' : ''}>
                ${opt.label}
              </option>
            `).join('')}
          </select>
        </div>

        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
            íŒ€ì› ì„ íƒ *
          </label>
          <select id="okr-member" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
            <option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
            ${teamMembers.map(member => `
              <option value="${member.id}" ${member.id === okr.memberId ? 'selected' : ''}>
                ${member.name} - ${member.position || 'íŒ€ì›'}
              </option>
            `).join('')}
          </select>
        </div>

        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
            Objective (ëª©í‘œ) *
          </label>
          <input type="text" id="okr-objective" value="${okr.objective}" placeholder="ì˜ˆ: Q4 ë§¤ì¶œ 1ì–µ ë‹¬ì„±" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" />
        </div>

        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
            Key Results (í•µì‹¬ ê²°ê³¼)
          </label>
          <div style="background: #E8F3FF; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 12px; color: #0064FF;">
            ğŸ’¡ <strong>ì—…ë¬´ì¼ì§€ì™€ ì—°ë™:</strong> ì—…ë¬´ ë“±ë¡ ì‹œ ê´€ë ¨ KRì„ ì„ íƒí•˜ë©´ ì´ ëª©í‘œë¥¼ ìœ„í•´ ì–´ë–¤ í™œë™ì„ í–ˆëŠ”ì§€ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
          </div>
          <div id="key-results-container">
            ${okr.keyResults.map((kr, idx) => `
              <div class="key-result-item" style="background: var(--gray-50); padding: 14px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #E5E8EB;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <span style="font-size: 13px; font-weight: 700; color: #0064FF;">KR ${idx + 1}</span>
                  <button onclick="removeKeyResult(this)" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                </div>
                <input type="text" class="kr-description" value="${kr.description}" placeholder="ì˜ˆ: ì‹ ê·œ ì…€ëŸ¬ 50ëª… ê³„ì•½" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; margin-bottom: 10px;" />
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <div>
                    <label style="font-size: 11px; color: #6B7684; margin-bottom: 4px; display: block;">ğŸ¯ ëª©í‘œ</label>
                    <input type="text" class="kr-target" value="${kr.target}" placeholder="50" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" />
                  </div>
                  <div>
                    <label style="font-size: 11px; color: #6B7684; margin-bottom: 4px; display: block;">ğŸ“Š í˜„ì¬ ì‹¤ì </label>
                    <input type="text" class="kr-actual" value="${kr.actual || ''}" placeholder="32" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" />
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          <button onclick="addKeyResult()" style="width: 100%; background: #F2F4F6; color: #333D4B; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; margin-top: 8px;">
            + Key Result ì¶”ê°€
          </button>
        </div>

        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
            ê°œì„  ë…¸ë ¥ ë° ì‹œë„í•œ ê²ƒë“¤
          </label>
          <textarea id="okr-improvements" placeholder="í¬ê¸°í•˜ì§€ ì•Šê³  ê°œì„ ì„ ìœ„í•´ ì–´ë–¤ ë…¸ë ¥ì„ í–ˆë‚˜ìš”?" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; min-height: 100px; resize: vertical;">${okr.improvements || ''}</textarea>
        </div>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button onclick="closeModal()" style="flex: 1; background: var(--gray-200); color: var(--gray-700); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
          ì·¨ì†Œ
        </button>
        <button onclick="saveOKR('${okrId || ''}')" style="flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
          ì €ì¥
        </button>
      </div>
    </div>
  `;
  } catch (error) {
    console.error('OKR ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
    alert('OKR ë“±ë¡ ëª¨ë‹¬ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
  }
}

function addKeyResult() {
  const container = document.getElementById('key-results-container');
  const count = container.children.length + 1;

  const div = document.createElement('div');
  div.className = 'key-result-item';
  div.style.cssText = 'background: var(--gray-50); padding: 14px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #E5E8EB;';
  div.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <span style="font-size: 13px; font-weight: 700; color: #0064FF;">KR ${count}</span>
      <button onclick="removeKeyResult(this)" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
    </div>
    <input type="text" class="kr-description" placeholder="ì˜ˆ: ì‹ ê·œ ì…€ëŸ¬ 50ëª… ê³„ì•½" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; margin-bottom: 10px;" />
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <div>
        <label style="font-size: 11px; color: #6B7684; margin-bottom: 4px; display: block;">ğŸ¯ ëª©í‘œ</label>
        <input type="text" class="kr-target" placeholder="50" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" />
      </div>
      <div>
        <label style="font-size: 11px; color: #6B7684; margin-bottom: 4px; display: block;">ğŸ“Š í˜„ì¬ ì‹¤ì </label>
        <input type="text" class="kr-actual" placeholder="32" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" />
      </div>
    </div>
  `;

  container.appendChild(div);
}

function removeKeyResult(btn) {
  btn.closest('.key-result-item').remove();
  // KR ë²ˆí˜¸ ì¬ì •ë ¬
  const items = document.querySelectorAll('.key-result-item');
  items.forEach((item, idx) => {
    const label = item.querySelector('span');
    if (label) label.textContent = 'KR ' + (idx + 1);
  });
}

async function saveOKR(okrId) {
  const quarter = document.getElementById('okr-quarter').value;
  const memberId = document.getElementById('okr-member').value;
  const objective = document.getElementById('okr-objective').value.trim();
  const improvements = document.getElementById('okr-improvements').value.trim();

  if (!memberId || !objective) {
    alert('íŒ€ì›ê³¼ ëª©í‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const keyResults = [];
  const krItems = document.querySelectorAll('.key-result-item');
  krItems.forEach(item => {
    const description = item.querySelector('.kr-description').value.trim();
    const target = item.querySelector('.kr-target').value.trim();
    const actual = item.querySelector('.kr-actual')?.value.trim() || '0';
    if (description && target) {
      const targetNum = parseFloat(target.replace(/[^0-9.]/g, '')) || 0;
      const actualNum = parseFloat(actual.replace(/[^0-9.]/g, '')) || 0;
      const progress = targetNum > 0 ? Math.min(100, Math.round((actualNum / targetNum) * 100)) : 0;
      keyResults.push({ description, target, actual: actualNum, progress });
    }
  });

  // ì „ì²´ ì§„í–‰ë¥  ê³„ì‚°
  const totalProgress = keyResults.length > 0 
    ? Math.round(keyResults.reduce((s, kr) => s + kr.progress, 0) / keyResults.length) 
    : 0;

  const okrData = {
    quarter,
    memberId,
    objective,
    keyResults,
    improvements,
    progress: totalProgress,
    updatedAt: new Date().toISOString()
  };

  try {
    if (okrId) {
      await db.collection('okrs').doc(okrId).update(okrData);
      showToast('OKRì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      okrData.createdAt = new Date().toISOString();
      await db.collection('okrs').add(okrData);
      showToast('OKRì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    closeModal();
    loadOKRList();
  } catch (error) {
    console.error('OKR ì €ì¥ ì˜¤ë¥˜:', error);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function editOKR(okrId) {
  await openOKRModal(okrId);
}

async function deleteOKR(okrId) {
  if (!confirm('ì´ OKRì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  try {
    await db.collection('okrs').doc(okrId).delete();
    showToast('OKRì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    loadOKRList();
  } catch (error) {
    console.error('OKR ì‚­ì œ ì˜¤ë¥˜:', error);
    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function updateOKRProgress(okrId) {
  const doc = await db.collection('okrs').doc(okrId).get();
  if (!doc.exists) return;

  const okr = doc.data();

  const modal = document.getElementById('modal');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <h2 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-bottom: 20px;">
        ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      </h2>

      <div style="background: var(--gray-50); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">
          ${okr.objective}
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
          í˜„ì¬ ë‹¬ì„±ë¥  (%)
        </label>
        <input type="number" id="okr-progress" value="${okr.progress || 0}" min="0" max="100" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" />
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
          ê°œì„  ë…¸ë ¥ ì—…ë°ì´íŠ¸
        </label>
        <textarea id="okr-improvements-update" placeholder="ì´ë²ˆ ê¸°ê°„ ë™ì•ˆ ì–´ë–¤ ê°œì„  ë…¸ë ¥ì„ í–ˆë‚˜ìš”?" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; min-height: 100px; resize: vertical;">${okr.improvements || ''}</textarea>
      </div>

      <div style="display: flex; gap: 12px;">
        <button onclick="closeModal()" style="flex: 1; background: var(--gray-200); color: var(--gray-700); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
          ì·¨ì†Œ
        </button>
        <button onclick="saveOKRProgress('${okrId}')" style="flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
          ì €ì¥
        </button>
      </div>
    </div>
  `;
}

async function saveOKRProgress(okrId) {
  const progress = parseInt(document.getElementById('okr-progress').value);
  const improvements = document.getElementById('okr-improvements-update').value.trim();

  if (isNaN(progress) || progress < 0 || progress > 100) {
    alert('ì§„í–‰ë¥ ì€ 0~100 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
    return;
  }

  try {
    await db.collection('okrs').doc(okrId).update({
      progress,
      improvements,
      updatedAt: new Date().toISOString()
    });

    showToast('ì§„í–‰ë¥ ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    loadOKRList();
  } catch (error) {
    console.error('ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ë¶„ê¸°ë³„ ë¦¬ë·° í˜ì´ì§€
function renderOKRReview() {
  const app = document.getElementById('app');
  const quarterOptions = getQuarterOptions();
  const currentQuarter = getQuarter();
  const currentQuarterKey = `${currentQuarter.year}-Q${currentQuarter.quarter}`;

  app.innerHTML = `
    <div class="page-header">
      <h1 style="font-size: 24px; font-weight: 700; color: var(--gray-900);">ğŸ“ˆ ë¶„ê¸°ë³„ OKR ë¦¬ë·°</h1>
      <p style="color: var(--gray-600); margin-top: 8px;">ê·¸ë¡œìŠ¤ë³´ë“œ ë°œí‘œ ìë£Œë¥¼ í™•ì¸í•˜ê³  PPTë¡œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”</p>
    </div>

    <div class="content">
      <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <select id="quarter-select" style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
            ${quarterOptions.map(opt => `
              <option value="${opt.value}" ${opt.value === currentQuarterKey ? 'selected' : ''}>
                ${opt.label}
              </option>
            `).join('')}
          </select>
          <button onclick="loadQuarterReview()" style="background: var(--primary); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
            ì¡°íšŒ
          </button>
          <button onclick="downloadOKRPPT()" style="background: var(--success); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
            ğŸ“¥ PPT ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
      </div>

      <div id="quarter-review-content">
        <div class="loading" style="text-align: center; padding: 40px;">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  `;

  loadQuarterReview();
}

async function loadQuarterReview() {
  const quarterSelect = document.getElementById('quarter-select');
  const quarter = quarterSelect ? quarterSelect.value : `${getQuarter().year}-Q${getQuarter().quarter}`;

  try {
    const okrSnapshot = await db.collection('okrs').where('quarter', '==', quarter).get();
    const teamSnapshot = await db.collection('teamMembers').get();

    const okrs = [];
    okrSnapshot.forEach(doc => {
      okrs.push({ id: doc.id, ...doc.data() });
    });

    const teamMembers = {};
    teamSnapshot.forEach(doc => {
      teamMembers[doc.id] = doc.data();
    });

    renderQuarterReview(okrs, teamMembers, quarter);
  } catch (error) {
    console.error('ë¶„ê¸° ë¦¬ë·° ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

function renderQuarterReview(okrs, teamMembers, quarter) {
  const content = document.getElementById('quarter-review-content');

  if (okrs.length === 0) {
    content.innerHTML = `
      <div style="text-align: center; padding: 60px; background: var(--gray-50); border-radius: 12px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
        <p style="font-size: 16px; color: var(--gray-700);">í•´ë‹¹ ë¶„ê¸°ì— ë“±ë¡ëœ OKRì´ ì—†ìŠµë‹ˆë‹¤</p>
      </div>
    `;
    return;
  }

  // íŒ€ì›ë³„ë¡œ ê·¸ë£¹í™”
  const okrByMember = {};
  Object.keys(teamMembers).forEach(memberId => {
    const memberOkrs = okrs.filter(okr => okr.memberId === memberId);
    if (memberOkrs.length > 0) {
      okrByMember[memberId] = {
        member: teamMembers[memberId],
        okrs: memberOkrs
      };
    }
  });

  let html = `
    <div style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; padding: 40px; color: white; text-align: center; margin-bottom: 24px;">
      <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 12px;">ğŸ¯ ${quarter} ê·¸ë¡œìŠ¤ë³´ë“œ</h2>
      <p style="font-size: 16px; opacity: 0.95;">ë„·í¼ì•Œì•¤ë”” - ëª¨ì—¬ë¼ë”œ íŒ€ OKR ë¦¬ë·°</p>
    </div>

    <div style="display: grid; gap: 24px;">
  `;

  Object.values(okrByMember).forEach(({ member, okrs: memberOkrs }) => {
    const avgProgress = memberOkrs.reduce((sum, okr) => sum + (okr.progress || 0), 0) / memberOkrs.length;

    html += `
      <div style="background: white; border-radius: 12px; padding: 32px; border: 2px solid var(--gray-200); page-break-inside: avoid;">
        <div style="text-align: center; margin-bottom: 32px;">
          <h3 style="font-size: 24px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px;">${member.name}</h3>
          <p style="font-size: 16px; color: var(--gray-600);">${member.position || 'íŒ€ì›'}</p>
          <div style="font-size: 48px; font-weight: 700; color: ${avgProgress >= 70 ? 'var(--success)' : avgProgress >= 40 ? 'var(--warning)' : 'var(--danger)'}; margin-top: 16px;">
            ${avgProgress.toFixed(0)}%
          </div>
          <div style="font-size: 14px; color: var(--gray-600); margin-top: 4px;">í‰ê·  ëª©í‘œ ë‹¬ì„±ë¥ </div>
        </div>

        ${memberOkrs.map((okr, idx) => `
          <div style="background: var(--gray-50); border-radius: 12px; padding: 24px; margin-bottom: ${idx < memberOkrs.length - 1 ? '20px' : '0'};">
            <div style="margin-bottom: 16px;">
              <div style="font-size: 12px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">ëª©í‘œ ${idx + 1}</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--gray-900);">${okr.objective}</div>
            </div>

            ${okr.keyResults && okr.keyResults.length > 0 ? `
              <div style="margin-bottom: 16px;">
                <div style="font-size: 12px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">í•µì‹¬ ê²°ê³¼ (Key Results)</div>
                ${okr.keyResults.map((kr, krIdx) => `
                  <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                    <div style="font-size: 14px; color: var(--gray-800);">
                      <strong>KR${krIdx + 1}:</strong> ${kr.description}
                    </div>
                    <div style="font-size: 13px; color: var(--primary); margin-top: 4px;">
                      ëª©í‘œ: ${kr.target}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}

            <div style="margin-bottom: 16px;">
              <div style="font-size: 12px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë‹¬ì„±ë¥ </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="flex: 1; background: var(--gray-200); height: 12px; border-radius: 6px; overflow: hidden;">
                  <div style="background: ${okr.progress >= 70 ? 'var(--success)' : okr.progress >= 40 ? 'var(--warning)' : 'var(--danger)'}; height: 100%; width: ${okr.progress || 0}%;"></div>
                </div>
                <div style="font-size: 20px; font-weight: 700; color: ${okr.progress >= 70 ? 'var(--success)' : okr.progress >= 40 ? 'var(--warning)' : 'var(--danger)'}; min-width: 60px; text-align: right;">
                  ${okr.progress || 0}%
                </div>
              </div>
            </div>

            ${okr.improvements ? `
              <div style="background: white; border-left: 4px solid var(--primary); padding: 16px; border-radius: 8px;">
                <div style="font-size: 12px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">ğŸ’¡ ê°œì„  ë…¸ë ¥ & ì‹œë„í•œ ê²ƒë“¤</div>
                <div style="font-size: 14px; color: var(--gray-800); line-height: 1.6; white-space: pre-wrap;">${okr.improvements}</div>
              </div>
            ` : ''}
          </div>
        `).join('')}
      </div>
    `;
  });

  html += `
      <div style="background: linear-gradient(135deg, #fc9600, #e08600); border-radius: 12px; padding: 32px; color: white; text-align: center;">
        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 12px;">ğŸŒŸ ê·¸ë¡œìŠ¤ë³´ë“œì˜ í•µì‹¬ ê°€ì¹˜</h3>
        <p style="font-size: 16px; opacity: 0.95; line-height: 1.6;">
          ìš°ë¦¬ëŠ” ê²°ê³¼ë³´ë‹¤ <strong>ê³¼ì •</strong>ì„ ì¤‘ìš”í•˜ê²Œ ë´…ë‹ˆë‹¤.<br/>
          ì™„ë²½í•¨ë³´ë‹¤ <strong>ì„±ì¥</strong>ì„ ì‘ì›í•©ë‹ˆë‹¤.<br/>
          í¬ê¸°í•˜ì§€ ì•Šê³  <strong>ê°œì„ </strong>ì„ ìœ„í•´ ë…¸ë ¥í•˜ëŠ” ëª¨ë“  ë¶„ë“¤ì„ ì‘ì›í•©ë‹ˆë‹¤! ğŸ‰
        </p>
      </div>
    </div>
  `;

  content.innerHTML = html;
}

// PPT ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
async function downloadOKRPPT() {
  const quarterSelect = document.getElementById('quarter-select');
  const quarter = quarterSelect ? quarterSelect.value : `${getQuarter().year}-Q${getQuarter().quarter}`;

  try {
    showToast('PPTë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');

    const okrSnapshot = await db.collection('okrs').where('quarter', '==', quarter).get();
    const teamSnapshot = await db.collection('teamMembers').get();

    const okrs = [];
    okrSnapshot.forEach(doc => {
      okrs.push({ id: doc.id, ...doc.data() });
    });

    const teamMembers = {};
    teamSnapshot.forEach(doc => {
      teamMembers[doc.id] = doc.data();
    });

    if (okrs.length === 0) {
      alert('í•´ë‹¹ ë¶„ê¸°ì— ë“±ë¡ëœ OKRì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const pptx = new PptxGenJS();

    // í‘œì§€ ìŠ¬ë¼ì´ë“œ
    let slide = pptx.addSlide();
    slide.background = { color: '10b981' };
    slide.addText('ğŸ¯ ê·¸ë¡œìŠ¤ë³´ë“œ', {
      x: 0.5, y: 1.5, w: 9, h: 1,
      fontSize: 44, bold: true, color: 'FFFFFF', align: 'center'
    });
    slide.addText(`${quarter} OKR ë¦¬ë·°`, {
      x: 0.5, y: 2.5, w: 9, h: 0.6,
      fontSize: 28, color: 'FFFFFF', align: 'center'
    });
    slide.addText('ë„·í¼ì•Œì•¤ë”” - ëª¨ì—¬ë¼ë”œ íŒ€', {
      x: 0.5, y: 3.5, w: 9, h: 0.5,
      fontSize: 20, color: 'FFFFFF', align: 'center'
    });

    // íŒ€ì›ë³„ ìŠ¬ë¼ì´ë“œ
    const okrByMember = {};
    Object.keys(teamMembers).forEach(memberId => {
      const memberOkrs = okrs.filter(okr => okr.memberId === memberId);
      if (memberOkrs.length > 0) {
        okrByMember[memberId] = {
          member: teamMembers[memberId],
          okrs: memberOkrs
        };
      }
    });

    Object.values(okrByMember).forEach(({ member, okrs: memberOkrs }) => {
      const avgProgress = memberOkrs.reduce((sum, okr) => sum + (okr.progress || 0), 0) / memberOkrs.length;

      // íŒ€ì› ê°œìš” ìŠ¬ë¼ì´ë“œ
      slide = pptx.addSlide();
      slide.addText(member.name, {
        x: 0.5, y: 0.5, w: 9, h: 0.6,
        fontSize: 36, bold: true, color: '1f2937'
      });
      slide.addText(member.position || 'íŒ€ì›', {
        x: 0.5, y: 1.2, w: 9, h: 0.4,
        fontSize: 20, color: '6b7280'
      });
      slide.addText(`í‰ê·  ë‹¬ì„±ë¥ : ${avgProgress.toFixed(0)}%`, {
        x: 0.5, y: 2.0, w: 9, h: 0.8,
        fontSize: 48, bold: true, color: avgProgress >= 70 ? '10b981' : avgProgress >= 40 ? 'fc9600' : 'f04452'
      });

      // ê° OKRë³„ ìŠ¬ë¼ì´ë“œ
      memberOkrs.forEach((okr, idx) => {
        slide = pptx.addSlide();

        slide.addText(`${member.name} - ëª©í‘œ ${idx + 1}`, {
          x: 0.5, y: 0.3, w: 9, h: 0.4,
          fontSize: 20, color: '6b7280'
        });

        slide.addText(okr.objective, {
          x: 0.5, y: 0.8, w: 9, h: 0.6,
          fontSize: 28, bold: true, color: '1f2937'
        });

        let yPos = 1.6;

        if (okr.keyResults && okr.keyResults.length > 0) {
          slide.addText('í•µì‹¬ ê²°ê³¼ (Key Results)', {
            x: 0.5, y: yPos, w: 9, h: 0.3,
            fontSize: 16, bold: true, color: '4b5563'
          });
          yPos += 0.4;

          okr.keyResults.forEach((kr, krIdx) => {
            slide.addText(`KR${krIdx + 1}: ${kr.description}`, {
              x: 0.7, y: yPos, w: 8.8, h: 0.3,
              fontSize: 14, color: '374151'
            });
            slide.addText(`ëª©í‘œ: ${kr.target}`, {
              x: 0.7, y: yPos + 0.25, w: 8.8, h: 0.25,
              fontSize: 12, color: 'fc9600'
            });
            yPos += 0.6;
          });
        }

        yPos += 0.2;
        slide.addText(`ë‹¬ì„±ë¥ : ${okr.progress || 0}%`, {
          x: 0.5, y: yPos, w: 9, h: 0.5,
          fontSize: 32, bold: true, color: okr.progress >= 70 ? '10b981' : okr.progress >= 40 ? 'fc9600' : 'f04452'
        });

        yPos += 0.7;
        if (okr.improvements) {
          slide.addText('ğŸ’¡ ê°œì„  ë…¸ë ¥ & ì‹œë„í•œ ê²ƒë“¤', {
            x: 0.5, y: yPos, w: 9, h: 0.3,
            fontSize: 16, bold: true, color: 'fc9600'
          });
          yPos += 0.4;
          slide.addText(okr.improvements, {
            x: 0.5, y: yPos, w: 9, h: 2,
            fontSize: 14, color: '374151', valign: 'top'
          });
        }
      });
    });

    // ë§ˆë¬´ë¦¬ ìŠ¬ë¼ì´ë“œ
    slide = pptx.addSlide();
    slide.background = { color: 'fc9600' };
    slide.addText('ğŸŒŸ ê·¸ë¡œìŠ¤ë³´ë“œì˜ í•µì‹¬ ê°€ì¹˜', {
      x: 0.5, y: 1.5, w: 9, h: 0.6,
      fontSize: 28, bold: true, color: 'FFFFFF', align: 'center'
    });
    slide.addText('ìš°ë¦¬ëŠ” ê²°ê³¼ë³´ë‹¤ ê³¼ì •ì„ ì¤‘ìš”í•˜ê²Œ ë´…ë‹ˆë‹¤.\nì™„ë²½í•¨ë³´ë‹¤ ì„±ì¥ì„ ì‘ì›í•©ë‹ˆë‹¤.\ní¬ê¸°í•˜ì§€ ì•Šê³  ê°œì„ ì„ ìœ„í•´ ë…¸ë ¥í•˜ëŠ” ëª¨ë“  ë¶„ë“¤ì„ ì‘ì›í•©ë‹ˆë‹¤! ğŸ‰', {
      x: 0.5, y: 2.5, w: 9, h: 1.5,
      fontSize: 18, color: 'FFFFFF', align: 'center', lineSpacing: 32
    });

    await pptx.writeFile({ fileName: `ê·¸ë¡œìŠ¤ë³´ë“œ_${quarter}_OKRë¦¬ë·°.pptx` });
    showToast('PPT ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
  } catch (error) {
    console.error('PPT ìƒì„± ì˜¤ë¥˜:', error);
    alert('PPT ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

// ========================================
// ê³µêµ¬ë³„ ìë™ ì—…ë¬´ í…œí”Œë¦¿
// ========================================
var DEAL_TASK_TEMPLATES = {
  negotiating: [
    { title: 'ê³µê¸‰ì‚¬ ë¯¸íŒ…/í˜‘ì˜', category: 'í˜‘ì˜' },
    { title: 'ê³µêµ¬ ë‹¨ê°€ í˜‘ì˜', category: 'í˜‘ì˜' },
    { title: 'ì…€ëŸ¬ ì„­ì™¸/í™•ì •', category: 'ì…€ëŸ¬ê´€ë¦¬' }
  ],
  confirmed: [
    { title: 'ì½˜í…ì¸  ì œì‘ (ë¦´ìŠ¤/í”¼ë“œ)', category: 'ì½˜í…ì¸ ' },
    { title: 'ìƒì„¸í˜ì´ì§€ ì¤€ë¹„', category: 'ì½˜í…ì¸ ' },
    { title: 'ê´‘ê³  ì„¸íŒ…', category: 'ë§ˆì¼€íŒ…' },
    { title: 'ì…€ëŸ¬ ê°€ì´ë“œ ì „ë‹¬', category: 'ì…€ëŸ¬ê´€ë¦¬' }
  ],
  active: [
    { title: 'ì£¼ë¬¸ í˜„í™© ëª¨ë‹ˆí„°ë§', category: 'ìš´ì˜' },
    { title: 'ê³ ê° ë¬¸ì˜ ëŒ€ì‘', category: 'ìš´ì˜' },
    { title: 'ì¬ê³  í™•ì¸', category: 'ìš´ì˜' },
    { title: 'ì…€ëŸ¬ ê´‘ê³  ì§‘í–‰ í™•ì¸', category: 'ë§ˆì¼€íŒ…' }
  ],
  completed: [
    { title: 'ë°œì£¼ì„œ ì „ë‹¬ (ê·¸ë¡œí™ˆ)', category: 'ì •ì‚°' },
    { title: 'ì •ì‚°ì„œ ì œì‘ (ì…€ëŸ¬)', category: 'ì •ì‚°' },
    { title: 'ì •ì‚°ì„œ ì œì‘ (ê³µê¸‰ì‚¬)', category: 'ì •ì‚°' },
    { title: 'ì •ì‚° ì™„ë£Œ', category: 'ì •ì‚°' }
  ]
};

// ========================================
// ê·¸ë¡œìŠ¤ ëŒ€ì‹œë³´ë“œ - ëª©í‘œ + OKR í†µí•©
// ========================================

// ========================================
// ê·¸ë¡œìŠ¤ë³´ë“œ ì „ëµ ëª©í‘œ
// ========================================
// ê·¸ë¡œìŠ¤ë³´ë“œ í•µì‹¬ ëª©ì : ë§¤ì¶œ ìƒìŠ¹ì„ ìœ„í•œ ë‘ ê°€ì§€ ì¶•ì˜ ë¹„ìœ¨ ë°°ë¶„
// 1. ê³ ê°ê³¼ ëª¨ì—¬ë¼ë”œ íŒ€ì› ì—¬ì • ê³ ë„í™” (ê·¸ë¡œìŠ¤)
// 2. ì˜ì—…í™œë™ (ì„¸ì¼ì¦ˆ)
//
// 25ë…„ë„: MVP ì¡ê¸° ìœ„í•´ ê³ ê°/ëª¨ì—¬ë¼ë”œ ì—¬ì • ê³ ë„í™” 90%
// 26ë…„ë„~: ì˜ì—…í™œë™ 70%, ê³ ê°/ëª¨ì—¬ë¼ë”œ ì—¬ì • ê³ ë„í™” 30%

var YEARLY_GOALS = {
  2025: { target: 100000000, growth: 90, sales: 10, label: '2025ë…„', description: 'MVP ì™„ì„± - ê³ ê°/íŒ€ì› ì—¬ì • ê³ ë„í™” ì§‘ì¤‘' },  // 1ì–µ
  2026: { target: 300000000, growth: 30, sales: 70, label: '2026ë…„', description: 'ì˜ì—… ë³¸ê²©í™” - ì…€ëŸ¬/ê³µê¸‰ì‚¬ í™•ëŒ€' },  // 3ì–µ
  2027: { target: 1000000000, growth: 30, sales: 70, label: '2027ë…„', description: 'ìŠ¤ì¼€ì¼ì—… - ì§€ì†ì  ì˜ì—… í™•ëŒ€' }, // 10ì–µ
  2028: { target: 3000000000, growth: 25, sales: 75, label: '2028ë…„', description: 'ì•ˆì •ì  ì„±ì¥ ê¶¤ë„' }, // 30ì–µ
  ultimate: { target: 5000000000, label: 'ìµœì¢… ëª©í‘œ', description: 'ì—° ë§¤ì¶œ 50ì–µ ë‹¬ì„±' }  // 50ì–µ
};

function renderGrowthDashboard() {
  var app = document.getElementById('app');
  var currentYear = new Date().getFullYear();
  var currentQuarter = getQuarter();

  app.innerHTML = `
    <div class="page-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1 style="font-size: 24px; font-weight: 700; color: var(--gray-900);">ğŸ¯ ê·¸ë¡œìŠ¤ ëŒ€ì‹œë³´ë“œ</h1>
          <p style="color: var(--gray-600); margin-top: 8px;">ì„±ì¥ ëª©í‘œì™€ ë…¸ë ¥ì„ ê¸°ë¡í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤</p>
        </div>
        <div style="display: flex; gap: 12px;">
          <button onclick="syncAllOKRProgress()" style="background: var(--info); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ”„ ì‹¤ì  ë™ê¸°í™”</button>
          <button onclick="switchTab('okrManagement')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">+ OKR ë“±ë¡</button>
        </div>
      </div>
    </div>
    <div class="content">
      <div id="growth-dashboard-content">
        <div style="text-align: center; padding: 60px;"><div class="loading-spinner"></div></div>
      </div>
    </div>
  `;

  loadGrowthDashboard();
}

async function loadGrowthDashboard() {
  try {
    var currentYear = new Date().getFullYear();
    var currentQuarter = getQuarter();
    var quarterKey = currentQuarter.year + '-Q' + currentQuarter.quarter;

    var results = await Promise.all([
      db.collection('okrs').get(),
      db.collection('tasks').get(),
      db.collection('teamMembers').get(),
      db.collection('deals').get(),
      db.collection('sellerSettlements').get(),
      db.collection('sellers').get()
    ]);

    var allOkrs = [];
    results[0].forEach(function(doc) { allOkrs.push({ id: doc.id, ...doc.data() }); });

    var tasks = [];
    results[1].forEach(function(doc) { tasks.push({ id: doc.id, ...doc.data() }); });

    var teamMembers = {};
    results[2].forEach(function(doc) { teamMembers[doc.id] = doc.data(); });

    var deals = [];
    results[3].forEach(function(doc) { deals.push({ id: doc.id, ...doc.data() }); });

    var settlements = [];
    results[4].forEach(function(doc) { settlements.push({ id: doc.id, ...doc.data() }); });

    var sellers = [];
    results[5].forEach(function(doc) { sellers.push({ id: doc.id, ...doc.data() }); });

    // í˜„ì¬ ë¶„ê¸° OKR
    var currentOkrs = allOkrs.filter(function(o) { return o.quarter === quarterKey; });

    // ì‹¤ì  ê³„ì‚°
    var totalSales = settlements.reduce(function(s, d) { return s + (Number(d.totalSales) || 0); }, 0);

    renderGrowthDashboardContent(currentOkrs, allOkrs, tasks, teamMembers, deals, settlements, sellers, totalSales, currentYear, quarterKey);
  } catch (error) {
    console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
    document.getElementById('growth-dashboard-content').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
  }
}

function renderGrowthDashboardContent(currentOkrs, allOkrs, tasks, teamMembers, deals, settlements, sellers, totalSales, currentYear, quarterKey) {
  var content = document.getElementById('growth-dashboard-content');
  var yearGoal = YEARLY_GOALS[currentYear] || YEARLY_GOALS[2026];
  var ultimateGoal = YEARLY_GOALS.ultimate.target;

  var html = '';

  // ===== 0. ê·¸ë¡œìŠ¤ë³´ë“œ í•µì‹¬ ëª©ì  =====
  html += '<div style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 20px; padding: 24px; margin-bottom: 24px; color: white;">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start;">';
  html += '<div style="flex: 1;">';
  html += '<div style="font-size: 22px; font-weight: 800; margin-bottom: 12px;">ê·¸ë¡œìŠ¤ë³´ë“œê°€ ì™œ í•„ìš”í•œê°€?</div>';
  html += '<div style="font-size: 15px; line-height: 1.8; opacity: 0.95;">';
  html += '<p style="margin-bottom: 8px;"><strong>ìµœì¢… ëª©í‘œëŠ” ë§¤ì¶œ ìƒìŠ¹</strong>ì…ë‹ˆë‹¤.</p>';
  html += '<p style="margin-bottom: 8px;">ì´ë¥¼ ìœ„í•´ <strong>ë‘ ê°€ì§€ ì¶•ì˜ ë¹„ìœ¨ì„ ì˜ ë°°ë¶„</strong>í•´ì•¼ í•©ë‹ˆë‹¤:</p>';
  html += '<div style="display: flex; gap: 16px; margin-top: 12px;">';
  html += '<div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 12px; flex: 1;">';
  html += '<div style="font-weight: 700;">1. ê³ ê°ê³¼ ëª¨ì—¬ë¼ë”œ íŒ€ì› ì—¬ì • ê³ ë„í™”</div>';
  html += '<div style="font-size: 13px; opacity: 0.9;">MVP ì™„ì„±, UX ê°œì„ , í”„ë¡œì„¸ìŠ¤ ìµœì í™”</div>';
  html += '</div>';
  html += '<div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 12px; flex: 1;">';
  html += '<div style="font-weight: 700;">2. ì˜ì—…í™œë™</div>';
  html += '<div style="font-size: 13px; opacity: 0.9;">ì…€ëŸ¬/ê³µê¸‰ì‚¬ í™•ë³´, ê³µêµ¬ ì§„í–‰, ì •ì‚° ê´€ë¦¬</div>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  html += '<div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; min-width: 200px; margin-left: 20px;">';
  html += '<div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">ğŸ“… ì—°ë„ë³„ ë¹„ìœ¨ ì „ëµ</div>';
  html += '<div style="font-size: 13px; line-height: 2;">';
  html += '<div><strong>25ë…„</strong>: ì—¬ì •ê³ ë„í™” 90% / ì˜ì—… 10%</div>';
  html += '<div><strong>26ë…„~</strong>: ì—¬ì •ê³ ë„í™” 30% / ì˜ì—… 70%</div>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  html += '</div>';

  // ===== 1. ìµœì¢… ëª©í‘œ íŠ¸ë˜ì»¤ (50ì–µ) =====
  html += '<div style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); border-radius: 20px; padding: 28px; margin-bottom: 24px; color: white;">';
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
  html += '<div>';
  html += '<div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">ğŸš€ ìµœì¢… ëª©í‘œ</div>';
  html += '<div style="font-size: 36px; font-weight: 800;">ì—° ë§¤ì¶œ 50ì–µ</div>';
  html += '<div style="font-size: 14px; opacity: 0.8; margin-top: 4px;">2~3ë…„ ë‚´ ë‹¬ì„± ëª©í‘œ</div>';
  html += '</div>';
  html += '<div style="text-align: right;">';
  html += '<div style="font-size: 14px; opacity: 0.9;">í˜„ì¬ ëˆ„ì  ë§¤ì¶œ</div>';
  html += '<div style="font-size: 32px; font-weight: 700;">' + (totalSales / 100000000).toFixed(2) + 'ì–µ</div>';
  html += '<div style="font-size: 13px; opacity: 0.8;">' + totalSales.toLocaleString() + 'ì›</div>';
  html += '</div>';
  html += '</div>';

  // 50ì–µ í”„ë¡œê·¸ë ˆìŠ¤
  var ultimate50Progress = Math.min(100, (totalSales / ultimateGoal) * 100);
  html += '<div style="background: rgba(255,255,255,0.2); height: 16px; border-radius: 8px; overflow: hidden; margin-bottom: 12px;">';
  html += '<div style="background: linear-gradient(90deg, #fbbf24, #f59e0b); height: 100%; width: ' + ultimate50Progress + '%; border-radius: 8px; transition: width 0.5s;"></div>';
  html += '</div>';
  html += '<div style="display: flex; justify-content: space-between; font-size: 13px; opacity: 0.9;">';
  html += '<span>ë‹¬ì„±ë¥ : ' + ultimate50Progress.toFixed(1) + '%</span>';
  html += '<span>ë‚¨ì€ ê¸ˆì•¡: ' + ((ultimateGoal - totalSales) / 100000000).toFixed(2) + 'ì–µ</span>';
  html += '</div>';
  html += '</div>';

  // ===== 2. ì—°ë„ë³„ ëª©í‘œ ì¹´ë“œ =====
  html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">';
  
  [2025, 2026, 2027, 2028].forEach(function(year) {
    var goal = YEARLY_GOALS[year];
    var isCurrentYear = year === currentYear;
    var yearProgress = Math.min(100, (totalSales / goal.target) * 100);
    if (year > currentYear) yearProgress = 0; // ë¯¸ë˜ì—°ë„ëŠ” 0%
    
    html += '<div style="background: white; border-radius: 16px; padding: 20px; border: ' + (isCurrentYear ? '3px solid var(--primary)' : '1px solid var(--gray-200)') + '; position: relative;">';
    if (isCurrentYear) html += '<div style="position: absolute; top: -10px; right: 16px; background: var(--primary); color: white; font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600;">ì˜¬í•´</div>';
    html += '<div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px;">' + goal.label + '</div>';
    html += '<div style="font-size: 28px; font-weight: 800; color: var(--primary); margin-bottom: 4px;">' + (goal.target / 100000000) + 'ì–µ</div>';
    html += '<div style="display: flex; gap: 6px; margin-bottom: 12px;">';
    html += '<span style="font-size: 11px; padding: 3px 8px; background: #dcfce7; color: #16a34a; border-radius: 4px;">ê·¸ë¡œìŠ¤ ' + goal.growth + '%</span>';
    html += '<span style="font-size: 11px; padding: 3px 8px; background: #dbeafe; color: #2563eb; border-radius: 4px;">ì˜ì—… ' + goal.sales + '%</span>';
    html += '</div>';
    html += '<div style="background: var(--gray-200); height: 6px; border-radius: 3px;">';
    html += '<div style="background: ' + (isCurrentYear ? 'var(--primary)' : 'var(--gray-400)') + '; height: 100%; width: ' + yearProgress + '%; border-radius: 3px;"></div>';
    html += '</div>';
    html += '<div style="font-size: 11px; color: var(--gray-500); margin-top: 6px; text-align: right;">' + yearProgress.toFixed(0) + '% ë‹¬ì„±</div>';
    html += '</div>';
  });
  html += '</div>';

  // ===== 3. ê·¸ë¡œìŠ¤ vs ì˜ì—… ë¹„ìœ¨ (íŒ€ì› ì‹¤ì²œ ê°€ì´ë“œ í¬í•¨) =====
  html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">';

  // ê·¸ë¡œìŠ¤ (ì„±ì¥) - ê³ ê°/íŒ€ì› ì—¬ì • ê³ ë„í™”
  html += '<div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 16px; padding: 24px;">';
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
  html += '<div><div style="font-size: 20px; font-weight: 700; color: #16a34a;">ğŸŒ± ê³ ê°/íŒ€ì› ì—¬ì • ê³ ë„í™”</div>';
  html += '<div style="font-size: 13px; color: #15803d; margin-top: 4px;">MVP ì™„ì„±, í”„ë¡œì„¸ìŠ¤ ìµœì í™”, UX ê°œì„ </div></div>';
  html += '<div style="font-size: 36px; font-weight: 800; color: #16a34a;">' + yearGoal.growth + '%</div>';
  html += '</div>';
  html += '<div style="background: white; border-radius: 10px; padding: 14px; margin-bottom: 12px;">';
  html += '<div style="font-size: 13px; font-weight: 600; color: #16a34a; margin-bottom: 10px;">ğŸ’¡ íŒ€ì› ì‹¤ì²œ ê°€ì´ë“œ</div>';
  html += '<ul style="margin: 0; padding-left: 18px; font-size: 13px; color: #15803d; line-height: 1.8;">';
  html += '<li>ê³µêµ¬ ì§„í–‰ ì¤‘ ë¶ˆí¸í•œ ì  ë°œê²¬ ì‹œ ì¦‰ì‹œ ê¸°ë¡</li>';
  html += '<li>ë°˜ë³µ ì‘ì—…ì€ ìë™í™” ê°€ëŠ¥í•œì§€ ê²€í† </li>';
  html += '<li>ì…€ëŸ¬/ê³µê¸‰ì‚¬ í”¼ë“œë°± ìˆ˜ì§‘ ë° ê³µìœ </li>';
  html += '<li>ì–´ë“œë¯¼ ì‚¬ìš©ì„± ê°œì„  ì•„ì´ë””ì–´ ì œì•ˆ</li>';
  html += '</ul>';
  html += '</div>';
  html += '<div style="background: white; border-radius: 10px; padding: 14px;">';
  html += '<div style="font-size: 12px; color: var(--gray-500); margin-bottom: 6px;">í˜„ì¬ ìƒíƒœ</div>';
  html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
  html += '<span style="font-size: 11px; padding: 4px 10px; background: #dcfce7; color: #16a34a; border-radius: 4px;">ğŸ“ˆ ë¸Œëœë“œ ì¸ì§€ë„</span>';
  html += '<span style="font-size: 11px; padding: 4px 10px; background: #dcfce7; color: #16a34a; border-radius: 4px;">ğŸ¬ ì½˜í…ì¸  í’ˆì§ˆ</span>';
  html += '<span style="font-size: 11px; padding: 4px 10px; background: #dcfce7; color: #16a34a; border-radius: 4px;">ğŸ”„ ì¬êµ¬ë§¤ìœ¨</span>';
  html += '</div></div></div>';

  // ì˜ì—…í™œë™
  html += '<div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 16px; padding: 24px;">';
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
  html += '<div><div style="font-size: 20px; font-weight: 700; color: #2563eb;">ğŸ’¼ ì˜ì—…í™œë™</div>';
  html += '<div style="font-size: 13px; color: #1d4ed8; margin-top: 4px;">ì…€ëŸ¬/ê³µê¸‰ì‚¬ í™•ë³´, ê³µêµ¬ ì§„í–‰, ì •ì‚° ê´€ë¦¬</div></div>';
  html += '<div style="font-size: 36px; font-weight: 800; color: #2563eb;">' + yearGoal.sales + '%</div>';
  html += '</div>';
  html += '<div style="background: white; border-radius: 10px; padding: 14px; margin-bottom: 12px;">';
  html += '<div style="font-size: 13px; font-weight: 600; color: #2563eb; margin-bottom: 10px;">ğŸ’¡ íŒ€ì› ì‹¤ì²œ ê°€ì´ë“œ</div>';
  html += '<ul style="margin: 0; padding-left: 18px; font-size: 13px; color: #1d4ed8; line-height: 1.8;">';
  html += '<li>ì£¼ NíšŒ ì‹ ê·œ ì…€ëŸ¬/ê³µê¸‰ì‚¬ ë°œêµ´ í™œë™</li>';
  html += '<li>ê¸°ì¡´ ì…€ëŸ¬ ì¬ì°¸ì—¬ ìœ ë„ ì—°ë½</li>';
  html += '<li>ê³µêµ¬ ì™„ë£Œ í›„ 7ì¼ ë‚´ ì •ì‚° ì²˜ë¦¬</li>';
  html += '<li>ê³µêµ¬ ì§„í–‰ ì¤‘ ë§¤ì¶œ í˜„í™© ì£¼ê°„ ì²´í¬</li>';
  html += '</ul>';
  html += '</div>';
  html += '<div style="background: white; border-radius: 10px; padding: 14px;">';
  html += '<div style="font-size: 12px; color: var(--gray-500); margin-bottom: 6px;">í˜„ì¬ ì‹¤ì </div>';
  html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
  html += '<span style="font-size: 11px; padding: 4px 10px; background: #dbeafe; color: #2563eb; border-radius: 4px;">ğŸ‘¥ ì…€ëŸ¬ ' + sellers.length + 'ëª…</span>';
  html += '<span style="font-size: 11px; padding: 4px 10px; background: #dbeafe; color: #2563eb; border-radius: 4px;">ğŸ“¦ ê³µêµ¬ ' + deals.length + 'ê±´</span>';
  html += '<span style="font-size: 11px; padding: 4px 10px; background: #dbeafe; color: #2563eb; border-radius: 4px;">ğŸ’° ì •ì‚° ' + settlements.length + 'ê±´</span>';
  html += '</div></div></div>';
  html += '</div>';

  // ===== 4. ë¶„ê¸° OKR í˜„í™© =====
  var avgOKR = currentOkrs.length > 0 ? currentOkrs.reduce(function(s, o) { return s + (o.progress || 0); }, 0) / currentOkrs.length : 0;
  
  html += '<div style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px;">';
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
  html += '<div>';
  html += '<h3 style="font-size: 18px; font-weight: 700; margin: 0;">ğŸ“Š ' + quarterKey + ' OKR í˜„í™©</h3>';
  html += '<p style="font-size: 13px; color: var(--gray-500); margin-top: 4px;">í¬ê¸°í•˜ì§€ ì•Šê³  ê°œì„ í•œ ë…¸ë ¥ì„ ê¸°ë¡í•©ë‹ˆë‹¤</p>';
  html += '</div>';
  html += '<div style="text-align: right;">';
  html += '<div style="font-size: 12px; color: var(--gray-500);">í‰ê·  ë‹¬ì„±ë¥ </div>';
  html += '<div style="font-size: 28px; font-weight: 800; color: ' + (avgOKR >= 70 ? 'var(--success)' : avgOKR >= 40 ? 'var(--warning)' : 'var(--danger)') + ';">' + avgOKR.toFixed(0) + '%</div>';
  html += '</div></div>';

  if (currentOkrs.length === 0) {
    html += '<div style="text-align: center; padding: 40px; background: var(--gray-50); border-radius: 12px;">';
    html += '<div style="font-size: 48px; margin-bottom: 12px;">ğŸ“</div>';
    html += '<div style="font-size: 16px; color: var(--gray-600); margin-bottom: 16px;">ë“±ë¡ëœ OKRì´ ì—†ìŠµë‹ˆë‹¤</div>';
    html += '<button onclick="switchTab(\'okrManagement\')" style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">+ OKR ë“±ë¡í•˜ê¸°</button>';
    html += '</div>';
  } else {
    html += '<div style="display: grid; gap: 16px;">';
    currentOkrs.forEach(function(okr) {
      var member = teamMembers[okr.memberId] || { name: 'ë¯¸ì§€ì •' };
      var pColor = okr.progress >= 70 ? 'var(--success)' : okr.progress >= 40 ? 'var(--warning)' : 'var(--danger)';
      
      html += '<div style="background: var(--gray-50); border-radius: 12px; padding: 20px;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">';
      html += '<div>';
      html += '<span style="font-size: 13px; font-weight: 600; color: var(--primary); background: var(--primary-light); padding: 4px 10px; border-radius: 6px;">' + member.name + '</span>';
      html += '<div style="font-size: 16px; font-weight: 700; color: var(--gray-900); margin-top: 8px;">' + okr.objective + '</div>';
      html += '</div>';
      html += '<div style="text-align: right;">';
      html += '<div style="font-size: 28px; font-weight: 800; color: ' + pColor + ';">' + (okr.progress || 0) + '%</div>';
      html += '</div></div>';
      
      // KR ëª©ë¡
      if (okr.keyResults && okr.keyResults.length > 0) {
        html += '<div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200);">';
        okr.keyResults.forEach(function(kr, idx) {
          var krColor = (kr.progress || 0) >= 70 ? 'var(--success)' : (kr.progress || 0) >= 40 ? 'var(--warning)' : 'var(--danger)';
          html += '<div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px;">';
          html += '<span style="color: var(--gray-600);">KR' + (idx + 1) + ': ' + kr.description + '</span>';
          html += '<span style="font-weight: 600; color: ' + krColor + ';">' + (kr.actual || 0) + ' / ' + kr.target + '</span>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      // ê°œì„  ë…¸ë ¥
      if (okr.improvements) {
        html += '<div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 8px;">';
        html += '<div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 4px;">ğŸ’ª ê°œì„  ë…¸ë ¥</div>';
        html += '<div style="font-size: 13px; color: #78350f;">' + okr.improvements + '</div>';
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';
  }
  html += '</div>';

  // ===== 5. í•˜ë‹¨: ì—…ë¬´ ì™„ë£Œìœ¨ + ë¹ ë¥¸ ì•¡ì…˜ =====
  var taskDone = tasks.filter(function(t) { return t.status === 'ì™„ë£Œ'; }).length;
  var taskRate = tasks.length > 0 ? Math.round((taskDone / tasks.length) * 100) : 0;

  html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
  
  // ì—…ë¬´ ì™„ë£Œìœ¨
  html += '<div style="background: white; border-radius: 16px; padding: 24px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">ğŸ“‹ ì—…ë¬´ í˜„í™©</h3>';
  html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">';
  html += '<div style="text-align: center; padding: 12px; background: var(--gray-50); border-radius: 8px;"><div style="font-size: 24px; font-weight: 700;">' + tasks.length + '</div><div style="font-size: 11px; color: var(--gray-500);">ì „ì²´</div></div>';
  html += '<div style="text-align: center; padding: 12px; background: var(--warning-light); border-radius: 8px;"><div style="font-size: 24px; font-weight: 700; color: var(--warning);">' + tasks.filter(function(t){ return t.status === 'ëŒ€ê¸°'; }).length + '</div><div style="font-size: 11px; color: var(--warning);">ëŒ€ê¸°</div></div>';
  html += '<div style="text-align: center; padding: 12px; background: var(--info-light); border-radius: 8px;"><div style="font-size: 24px; font-weight: 700; color: var(--info);">' + tasks.filter(function(t){ return t.status === 'ì§„í–‰ì¤‘'; }).length + '</div><div style="font-size: 11px; color: var(--info);">ì§„í–‰ì¤‘</div></div>';
  html += '<div style="text-align: center; padding: 12px; background: var(--success-light); border-radius: 8px;"><div style="font-size: 24px; font-weight: 700; color: var(--success);">' + taskDone + '</div><div style="font-size: 11px; color: var(--success);">ì™„ë£Œ</div></div>';
  html += '</div>';
  html += '<button onclick="switchTab(\'workLog\')" style="width: 100%; background: var(--gray-100); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">ì—…ë¬´ì¼ì§€ ë°”ë¡œê°€ê¸° â†’</button>';
  html += '</div>';
  
  // ë¹ ë¥¸ ì•¡ì…˜
  html += '<div style="background: white; border-radius: 16px; padding: 24px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">âš¡ ë¹ ë¥¸ ì•¡ì…˜</h3>';
  html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
  html += '<button onclick="switchTab(\'okrManagement\')" style="width: 100%; background: var(--primary-light); color: var(--primary); border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: left;">âœï¸ OKR ë“±ë¡/ìˆ˜ì •</button>';
  html += '<button onclick="switchTab(\'okrReview\')" style="width: 100%; background: var(--success-light); color: var(--success); border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: left;">ğŸ“ˆ ë¶„ê¸°ë³„ ë¦¬ë·° ë³´ê¸°</button>';
  html += '<button onclick="toggleGrowthGuide()" style="width: 100%; background: var(--info-light); color: var(--info); border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: left;">ğŸ“– ì—…ë¬´ê°€ì´ë“œ ë³´ê¸°</button>';
  html += '<button onclick="switchTab(\'calendar\')" style="width: 100%; background: var(--warning-light); color: var(--warning); border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: left;">ğŸ“… ê³µêµ¬ ìº˜ë¦°ë”</button>';
  html += '</div>';
  html += '</div>';
  
  html += '</div>';

  // ===== 6. ì—…ë¬´ê°€ì´ë“œ ì„¹ì…˜ (ì ‘íŒ ìƒíƒœ) =====
  html += '<div id="growth-guide-section" style="display: none; margin-top: 24px;">';

  // ê·¸ë¡œìŠ¤ë³´ë“œ í•µì‹¬ ëª©ì  (ì¬í™•ì¸)
  html += '<div style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 20px; padding: 32px; margin-bottom: 24px; color: white;">';
  html += '<h2 style="font-size: 24px; font-weight: 800; margin-bottom: 16px;">ê·¸ë¡œìŠ¤ë³´ë“œì˜ í•µì‹¬ ëª©ì </h2>';
  html += '<div style="font-size: 16px; line-height: 1.8; opacity: 0.95;">';
  html += '<p style="margin-bottom: 12px;"><strong>ë§¤ì¶œ ìƒìŠ¹</strong>ì„ ìœ„í•´ ë‘ ê°€ì§€ ì¶•ì˜ ë¹„ìœ¨ì„ ì˜ ë°°ë¶„í•©ë‹ˆë‹¤:</p>';
  html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">';
  html += '<div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px;">';
  html += '<div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">1. ê³ ê°/íŒ€ì› ì—¬ì • ê³ ë„í™”</div>';
  html += '<div style="font-size: 14px; opacity: 0.9;">MVP ì™„ì„±, UX ê°œì„ , í”„ë¡œì„¸ìŠ¤ ìµœì í™”</div>';
  html += '</div>';
  html += '<div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px;">';
  html += '<div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">2. ì˜ì—…í™œë™</div>';
  html += '<div style="font-size: 14px; opacity: 0.9;">ì…€ëŸ¬/ê³µê¸‰ì‚¬ í™•ë³´, ê³µêµ¬ ì§„í–‰, ë§¤ì¶œ ì‹¤í˜„</div>';
  html += '</div>';
  html += '</div>';
  html += '</div></div>';

  // ì—°ë„ë³„ ì „ëµ ë¹„ìœ¨
  html += '<div style="background: white; border-radius: 16px; padding: 28px; margin-bottom: 24px;">';
  html += '<h3 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">ğŸ“… ì—°ë„ë³„ ì „ëµ ë¹„ìœ¨</h3>';
  html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">';

  // 2025ë…„
  html += '<div style="background: #fef3c7; border-radius: 12px; padding: 20px; border: 2px solid #fbbf24;">';
  html += '<div style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 8px;">2025ë…„ (í˜„ì¬)</div>';
  html += '<div style="font-size: 18px; font-weight: 700; color: #78350f; margin-bottom: 12px;">MVP ì™„ì„± ì§‘ì¤‘</div>';
  html += '<div style="display: flex; gap: 12px;">';
  html += '<div style="flex: 1; background: #dcfce7; padding: 12px; border-radius: 8px; text-align: center;">';
  html += '<div style="font-size: 28px; font-weight: 800; color: #16a34a;">90%</div>';
  html += '<div style="font-size: 12px; color: #15803d;">ì—¬ì • ê³ ë„í™”</div></div>';
  html += '<div style="flex: 1; background: #dbeafe; padding: 12px; border-radius: 8px; text-align: center;">';
  html += '<div style="font-size: 28px; font-weight: 800; color: #2563eb;">10%</div>';
  html += '<div style="font-size: 12px; color: #1d4ed8;">ì˜ì—…í™œë™</div></div>';
  html += '</div></div>';

  // 2026ë…„~
  html += '<div style="background: #dbeafe; border-radius: 12px; padding: 20px; border: 2px solid #3b82f6;">';
  html += '<div style="font-size: 14px; font-weight: 600; color: #1d4ed8; margin-bottom: 8px;">2026ë…„~</div>';
  html += '<div style="font-size: 18px; font-weight: 700; color: #1e3a8a; margin-bottom: 12px;">ì˜ì—… ë³¸ê²©í™”</div>';
  html += '<div style="display: flex; gap: 12px;">';
  html += '<div style="flex: 1; background: #dcfce7; padding: 12px; border-radius: 8px; text-align: center;">';
  html += '<div style="font-size: 28px; font-weight: 800; color: #16a34a;">30%</div>';
  html += '<div style="font-size: 12px; color: #15803d;">ì—¬ì • ê³ ë„í™”</div></div>';
  html += '<div style="flex: 1; background: white; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #3b82f6;">';
  html += '<div style="font-size: 28px; font-weight: 800; color: #2563eb;">70%</div>';
  html += '<div style="font-size: 12px; color: #1d4ed8;">ì˜ì—…í™œë™</div></div>';
  html += '</div></div>';
  html += '</div>';

  // ë§¤ì¶œ ë¡œë“œë§µ
  html += '<div style="background: var(--gray-50); border-radius: 12px; padding: 20px;">';
  html += '<h4 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">ğŸ“ˆ ë§¤ì¶œ ë¡œë“œë§µ</h4>';
  html += '<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">';
  html += '<div style="background: #fef3c7; padding: 12px 16px; border-radius: 8px; text-align: center; border: 2px solid #fbbf24;"><div style="font-size: 11px; color: #92400e;">2025ë…„</div><div style="font-size: 18px; font-weight: 700; color: #78350f;">1ì–µ</div></div>';
  html += '<span style="font-size: 18px; color: var(--gray-400);">â†’</span>';
  html += '<div style="background: white; padding: 12px 16px; border-radius: 8px; text-align: center; border: 2px solid var(--gray-200);"><div style="font-size: 11px; color: var(--gray-500);">2026ë…„</div><div style="font-size: 18px; font-weight: 700;">3ì–µ</div></div>';
  html += '<span style="font-size: 18px; color: var(--gray-400);">â†’</span>';
  html += '<div style="background: white; padding: 12px 16px; border-radius: 8px; text-align: center; border: 2px solid var(--gray-200);"><div style="font-size: 11px; color: var(--gray-500);">2027ë…„</div><div style="font-size: 18px; font-weight: 700;">10ì–µ</div></div>';
  html += '<span style="font-size: 18px; color: var(--gray-400);">â†’</span>';
  html += '<div style="background: white; padding: 12px 16px; border-radius: 8px; text-align: center; border: 2px solid var(--gray-200);"><div style="font-size: 11px; color: var(--gray-500);">2028ë…„</div><div style="font-size: 18px; font-weight: 700;">30ì–µ</div></div>';
  html += '<span style="font-size: 18px; color: var(--gray-400);">â†’</span>';
  html += '<div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 12px 16px; border-radius: 8px; text-align: center; color: white;"><div style="font-size: 11px; opacity: 0.9;">ìµœì¢…</div><div style="font-size: 20px; font-weight: 800;">50ì–µ</div></div>';
  html += '</div></div>';
  html += '</div>';

  // íŒ€ì› ì‹¤ì²œ ì²´í¬ë¦¬ìŠ¤íŠ¸
  html += '<div style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); border-radius: 16px; padding: 28px; margin-bottom: 24px;">';
  html += '<h3 style="font-size: 20px; font-weight: 700; color: #1e3a8a; margin-bottom: 20px;">âœ… íŒ€ì› ì‹¤ì²œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>';
  html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';

  // ì—¬ì • ê³ ë„í™” ì‹¤ì²œ
  html += '<div style="background: white; border-radius: 12px; padding: 20px;">';
  html += '<div style="font-size: 16px; font-weight: 700; color: #16a34a; margin-bottom: 12px;">ğŸŒ± ì—¬ì • ê³ ë„í™” ì‹¤ì²œ</div>';
  html += '<ul style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--gray-700); line-height: 2;">';
  html += '<li>ê³µêµ¬ ì§„í–‰ ì¤‘ ë¶ˆí¸í•œ ì  ì¦‰ì‹œ ê¸°ë¡</li>';
  html += '<li>ë°˜ë³µ ì‘ì—… ìë™í™” ì•„ì´ë””ì–´ ì œì•ˆ</li>';
  html += '<li>ì…€ëŸ¬/ê³µê¸‰ì‚¬ í”¼ë“œë°± ìˆ˜ì§‘ ë° ê³µìœ </li>';
  html += '<li>ì–´ë“œë¯¼ ì‚¬ìš©ì„± ê°œì„  ì˜ê²¬ ì œì‹œ</li>';
  html += '<li>ì‹ ê·œ ê¸°ëŠ¥ ìš”ì²­ì‚¬í•­ ì •ë¦¬</li>';
  html += '</ul></div>';

  // ì˜ì—…í™œë™ ì‹¤ì²œ
  html += '<div style="background: white; border-radius: 12px; padding: 20px;">';
  html += '<div style="font-size: 16px; font-weight: 700; color: #2563eb; margin-bottom: 12px;">ğŸ’¼ ì˜ì—…í™œë™ ì‹¤ì²œ</div>';
  html += '<ul style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--gray-700); line-height: 2;">';
  html += '<li>ì£¼ê°„ ì‹ ê·œ ì…€ëŸ¬/ê³µê¸‰ì‚¬ ë°œêµ´</li>';
  html += '<li>ê¸°ì¡´ ì…€ëŸ¬ ì¬ì°¸ì—¬ ìœ ë„ ì—°ë½</li>';
  html += '<li>ê³µêµ¬ ì™„ë£Œ í›„ 7ì¼ ë‚´ ì •ì‚° ì²˜ë¦¬</li>';
  html += '<li>ë§¤ì¶œ í˜„í™© ì£¼ê°„ ì²´í¬ ë° ë³´ê³ </li>';
  html += '<li>ì‹œì¥/ê²½ìŸì‚¬ ë™í–¥ íŒŒì•…</li>';
  html += '</ul></div>';
  html += '</div></div>';

  // OKR ì‘ì„± ê°€ì´ë“œ
  html += '<div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px; padding: 28px;">';
  html += '<h3 style="font-size: 20px; font-weight: 700; color: #92400e; margin-bottom: 20px;">ğŸ’¡ ì¢‹ì€ OKR ì‘ì„±ë²•</h3>';
  html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
  html += '<div style="background: white; border-radius: 12px; padding: 20px;">';
  html += '<div style="font-size: 16px; font-weight: 700; color: #16a34a; margin-bottom: 12px;">âœ… ì¢‹ì€ ì˜ˆì‹œ</div>';
  html += '<div style="font-size: 14px; color: var(--gray-700); line-height: 1.8;">';
  html += '<p><strong>O:</strong> ëª¨ì—¬ë¼ë”œ ì…€ëŸ¬ ìƒíƒœê³„ ê°•í™”</p>';
  html += '<p><strong>KR1:</strong> ì‹ ê·œ ì…€ëŸ¬ 20ëª… í™•ë³´</p>';
  html += '<p><strong>KR2:</strong> ì…€ëŸ¬ ì¬ì°¸ì—¬ìœ¨ 60% ë‹¬ì„±</p>';
  html += '</div></div>';
  html += '<div style="background: white; border-radius: 12px; padding: 20px;">';
  html += '<div style="font-size: 16px; font-weight: 700; color: #dc2626; margin-bottom: 12px;">âŒ ë‚˜ìœ ì˜ˆì‹œ</div>';
  html += '<div style="font-size: 14px; color: var(--gray-700); line-height: 1.8;">';
  html += '<p><strong>O:</strong> ì—´ì‹¬íˆ ì¼í•˜ê¸° (ëª¨í˜¸í•¨)</p>';
  html += '<p><strong>KR1:</strong> ì…€ëŸ¬ ë§ì´ ëª¨ìœ¼ê¸° (ì¸¡ì • ë¶ˆê°€)</p>';
  html += '</div></div>';
  html += '</div></div>';
  html += '</div>';

  content.innerHTML = html;
}

// ì—…ë¬´ê°€ì´ë“œ í† ê¸€
function toggleGrowthGuide() {
  var section = document.getElementById('growth-guide-section');
  if (section) {
    var isHidden = section.style.display === 'none';
    section.style.display = isHidden ? 'block' : 'none';
    if (isHidden) section.scrollIntoView({ behavior: 'smooth' });
  }
}

// ========================================
// ì—…ë¬´ê°€ì´ë“œ í˜ì´ì§€
// ========================================
function renderGrowthGuide() {
  var app = document.getElementById('app');

  app.innerHTML = `
    <div class="page-header">
      <h1 style="font-size: 24px; font-weight: 700;">ğŸ“– ê·¸ë¡œìŠ¤ë³´ë“œ ì—…ë¬´ê°€ì´ë“œ</h1>
      <p style="color: var(--gray-600); margin-top: 8px;">ë§¤ì¶œ ìƒìŠ¹ì„ ìœ„í•œ ë‘ ê°€ì§€ ì¶•ì˜ ë¹„ìœ¨ ë°°ë¶„ ì „ëµ</p>
    </div>

    <div class="content">
      <!-- í•µì‹¬ ëª©ì  -->
      <div style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 20px; padding: 32px; margin-bottom: 24px; color: white;">
        <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 16px;">ê·¸ë¡œìŠ¤ë³´ë“œê°€ ì™œ í•„ìš”í•œê°€?</h2>
        <div style="font-size: 16px; line-height: 1.8; opacity: 0.95;">
          <p style="margin-bottom: 12px;"><strong>ìµœì¢… ëª©í‘œëŠ” ë§¤ì¶œ ìƒìŠ¹</strong>ì…ë‹ˆë‹¤.</p>
          <p style="margin-bottom: 16px;">ì´ë¥¼ ìœ„í•´ <strong>ë‘ ê°€ì§€ ì¶•ì˜ ë¹„ìœ¨ì„ ì˜ ë°°ë¶„</strong>í•´ì•¼ í•©ë‹ˆë‹¤:</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px;">
              <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">1. ê³ ê°/íŒ€ì› ì—¬ì • ê³ ë„í™”</div>
              <div style="font-size: 14px; opacity: 0.9;">MVP ì™„ì„±, UX ê°œì„ , í”„ë¡œì„¸ìŠ¤ ìµœì í™”</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px;">
              <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">2. ì˜ì—…í™œë™</div>
              <div style="font-size: 14px; opacity: 0.9;">ì…€ëŸ¬/ê³µê¸‰ì‚¬ í™•ë³´, ê³µêµ¬ ì§„í–‰, ë§¤ì¶œ ì‹¤í˜„</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì—°ë„ë³„ ì „ëµ ë¹„ìœ¨ -->
      <div style="background: white; border-radius: 16px; padding: 28px; margin-bottom: 24px;">
        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">ğŸ“… ì—°ë„ë³„ ì „ëµ ë¹„ìœ¨</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
          <!-- 2025ë…„ -->
          <div style="background: #fef3c7; border-radius: 12px; padding: 20px; border: 2px solid #fbbf24;">
            <div style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 8px;">2025ë…„ (í˜„ì¬)</div>
            <div style="font-size: 18px; font-weight: 700; color: #78350f; margin-bottom: 12px;">MVP ì™„ì„± ì§‘ì¤‘</div>
            <div style="display: flex; gap: 12px;">
              <div style="flex: 1; background: #dcfce7; padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 28px; font-weight: 800; color: #16a34a;">90%</div>
                <div style="font-size: 12px; color: #15803d;">ì—¬ì • ê³ ë„í™”</div>
              </div>
              <div style="flex: 1; background: #dbeafe; padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 28px; font-weight: 800; color: #2563eb;">10%</div>
                <div style="font-size: 12px; color: #1d4ed8;">ì˜ì—…í™œë™</div>
              </div>
            </div>
          </div>

          <!-- 2026ë…„~ -->
          <div style="background: #dbeafe; border-radius: 12px; padding: 20px; border: 2px solid #3b82f6;">
            <div style="font-size: 14px; font-weight: 600; color: #1d4ed8; margin-bottom: 8px;">2026ë…„~</div>
            <div style="font-size: 18px; font-weight: 700; color: #1e3a8a; margin-bottom: 12px;">ì˜ì—… ë³¸ê²©í™”</div>
            <div style="display: flex; gap: 12px;">
              <div style="flex: 1; background: #dcfce7; padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 28px; font-weight: 800; color: #16a34a;">30%</div>
                <div style="font-size: 12px; color: #15803d;">ì—¬ì • ê³ ë„í™”</div>
              </div>
              <div style="flex: 1; background: white; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #3b82f6;">
                <div style="font-size: 28px; font-weight: 800; color: #2563eb;">70%</div>
                <div style="font-size: 12px; color: #1d4ed8;">ì˜ì—…í™œë™</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë§¤ì¶œ ë¡œë“œë§µ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 20px;">
          <h4 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">ğŸ“ˆ ë§¤ì¶œ ë¡œë“œë§µ</h4>
          <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
            <div style="background: #fef3c7; padding: 12px 16px; border-radius: 8px; text-align: center; border: 2px solid #fbbf24;">
              <div style="font-size: 11px; color: #92400e;">2025ë…„</div>
              <div style="font-size: 18px; font-weight: 700; color: #78350f;">1ì–µ</div>
            </div>
            <span style="font-size: 18px; color: var(--gray-400);">â†’</span>
            <div style="background: white; padding: 12px 16px; border-radius: 8px; text-align: center; border: 2px solid var(--gray-200);">
              <div style="font-size: 11px; color: var(--gray-500);">2026ë…„</div>
              <div style="font-size: 18px; font-weight: 700;">3ì–µ</div>
            </div>
            <span style="font-size: 18px; color: var(--gray-400);">â†’</span>
            <div style="background: white; padding: 12px 16px; border-radius: 8px; text-align: center; border: 2px solid var(--gray-200);">
              <div style="font-size: 11px; color: var(--gray-500);">2027ë…„</div>
              <div style="font-size: 18px; font-weight: 700;">10ì–µ</div>
            </div>
            <span style="font-size: 18px; color: var(--gray-400);">â†’</span>
            <div style="background: white; padding: 12px 16px; border-radius: 8px; text-align: center; border: 2px solid var(--gray-200);">
              <div style="font-size: 11px; color: var(--gray-500);">2028ë…„</div>
              <div style="font-size: 18px; font-weight: 700;">30ì–µ</div>
            </div>
            <span style="font-size: 18px; color: var(--gray-400);">â†’</span>
            <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 12px 16px; border-radius: 8px; text-align: center; color: white;">
              <div style="font-size: 11px; opacity: 0.9;">ìµœì¢…</div>
              <div style="font-size: 24px; font-weight: 800;">50ì–µ</div>
            </div>
          </div>
        </div>
      </div>

      <!-- íŒ€ì› ì‹¤ì²œ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
      <div style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); border-radius: 16px; padding: 28px; margin-bottom: 24px;">
        <h3 style="font-size: 20px; font-weight: 700; color: #1e3a8a; margin-bottom: 20px;">âœ… íŒ€ì› ì‹¤ì²œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
        <p style="font-size: 14px; color: #1d4ed8; margin-bottom: 20px;">íŒ€ì› ëª¨ë‘ê°€ ì•„ë˜ ë‚´ìš©ì„ ì•Œê³  í–‰ë™ê³¼ ì‹¤ì²œì„ í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="font-size: 16px; font-weight: 700; color: #16a34a; margin-bottom: 12px;">ğŸŒ± ì—¬ì • ê³ ë„í™” ì‹¤ì²œ</div>
            <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--gray-700); line-height: 2;">
              <li>ê³µêµ¬ ì§„í–‰ ì¤‘ ë¶ˆí¸í•œ ì  ì¦‰ì‹œ ê¸°ë¡</li>
              <li>ë°˜ë³µ ì‘ì—… ìë™í™” ì•„ì´ë””ì–´ ì œì•ˆ</li>
              <li>ì…€ëŸ¬/ê³µê¸‰ì‚¬ í”¼ë“œë°± ìˆ˜ì§‘ ë° ê³µìœ </li>
              <li>ì–´ë“œë¯¼ ì‚¬ìš©ì„± ê°œì„  ì˜ê²¬ ì œì‹œ</li>
              <li>ì‹ ê·œ ê¸°ëŠ¥ ìš”ì²­ì‚¬í•­ ì •ë¦¬</li>
            </ul>
          </div>

          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="font-size: 16px; font-weight: 700; color: #2563eb; margin-bottom: 12px;">ğŸ’¼ ì˜ì—…í™œë™ ì‹¤ì²œ</div>
            <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--gray-700); line-height: 2;">
              <li>ì£¼ê°„ ì‹ ê·œ ì…€ëŸ¬/ê³µê¸‰ì‚¬ ë°œêµ´</li>
              <li>ê¸°ì¡´ ì…€ëŸ¬ ì¬ì°¸ì—¬ ìœ ë„ ì—°ë½</li>
              <li>ê³µêµ¬ ì™„ë£Œ í›„ 7ì¼ ë‚´ ì •ì‚° ì²˜ë¦¬</li>
              <li>ë§¤ì¶œ í˜„í™© ì£¼ê°„ ì²´í¬ ë° ë³´ê³ </li>
              <li>ì‹œì¥/ê²½ìŸì‚¬ ë™í–¥ íŒŒì•…</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- ì‚¬ìš©ë²• ê°€ì´ë“œ -->
      <div style="background: white; border-radius: 16px; padding: 28px; margin-bottom: 24px;">
        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">ğŸ“‹ ë©”ë‰´ë³„ ì‚¬ìš©ë²•</h3>
        
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <!-- ê·¸ë¡œìŠ¤ ëŒ€ì‹œë³´ë“œ -->
          <div style="background: var(--gray-50); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">ğŸ </span>
              <div>
                <div style="font-size: 16px; font-weight: 700;">ê·¸ë¡œìŠ¤ ëŒ€ì‹œë³´ë“œ</div>
                <div style="font-size: 13px; color: var(--gray-500);">ì„±ì¥ í˜„í™©ì„ í•œëˆˆì— íŒŒì•…</div>
              </div>
            </div>
            <ul style="margin: 0; padding-left: 20px; color: var(--gray-700); line-height: 1.8;">
              <li>50ì–µ ìµœì¢… ëª©í‘œ ë‹¬ì„±ë¥  í™•ì¸</li>
              <li>ì—°ë„ë³„ ë§¤ì¶œ ëª©í‘œ íŠ¸ë˜í‚¹</li>
              <li>ê·¸ë¡œìŠ¤ vs ì˜ì—… ë¹„ìœ¨ í™•ì¸</li>
              <li>ë¶„ê¸° OKR ì§„í–‰ë¥  í™•ì¸</li>
            </ul>
          </div>

          <!-- OKR ê´€ë¦¬ -->
          <div style="background: var(--gray-50); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">âœï¸</span>
              <div>
                <div style="font-size: 16px; font-weight: 700;">OKR ê´€ë¦¬</div>
                <div style="font-size: 13px; color: var(--gray-500);">ë¶„ê¸°ë³„ ëª©í‘œ ì„¤ì • ë° ê´€ë¦¬</div>
              </div>
            </div>
            <ul style="margin: 0; padding-left: 20px; color: var(--gray-700); line-height: 1.8;">
              <li><strong>Objective</strong>: ì˜ê°ì„ ì£¼ëŠ” ì •ì„±ì  ëª©í‘œ (ì˜ˆ: "ì…€ëŸ¬ ìƒíƒœê³„ ê°•í™”")</li>
              <li><strong>Key Results</strong>: ì¸¡ì • ê°€ëŠ¥í•œ ì •ëŸ‰ ì§€í‘œ (ì˜ˆ: "ì‹ ê·œ ì…€ëŸ¬ 20ëª… í™•ë³´")</li>
              <li><strong>ìë™ ì—°ë™</strong>: ë§¤ì¶œì•¡, ê³µêµ¬ ìˆ˜, ì…€ëŸ¬ ìˆ˜ ìë™ ê³„ì‚°</li>
              <li><strong>ê°œì„  ë…¸ë ¥</strong>: í¬ê¸°í•˜ì§€ ì•Šê³  ì‹œë„í•œ ê²ƒë“¤ ê¸°ë¡</li>
            </ul>
          </div>

          <!-- ë¶„ê¸°ë³„ ë¦¬ë·° -->
          <div style="background: var(--gray-50); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">ğŸ“ˆ</span>
              <div>
                <div style="font-size: 16px; font-weight: 700;">ë¶„ê¸°ë³„ ë¦¬ë·°</div>
                <div style="font-size: 13px; color: var(--gray-500);">ì„±ê³¼ ë¶„ì„ ë° ë‹¤ìŒ ë¶„ê¸° ê³„íš</div>
              </div>
            </div>
            <ul style="margin: 0; padding-left: 20px; color: var(--gray-700); line-height: 1.8;">
              <li>ë¶„ê¸°ë³„ OKR ë‹¬ì„±ë¥  ë¹„êµ</li>
              <li>íŒ€ì›ë³„ ì„±ê³¼ ë¶„ì„</li>
              <li>ì „ë¶„ê¸° ëŒ€ë¹„ ì„±ì¥ë¥  í™•ì¸</li>
              <li>ë‹¤ìŒ ë¶„ê¸° ëª©í‘œ ì„¤ì • ê°€ì´ë“œ</li>
            </ul>
          </div>

          <!-- ì—…ë¬´ì¼ì§€ -->
          <div style="background: var(--gray-50); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">ğŸ““</span>
              <div>
                <div style="font-size: 16px; font-weight: 700;">ì—…ë¬´ì¼ì§€</div>
                <div style="font-size: 13px; color: var(--gray-500);">ì¹¸ë°˜ë³´ë“œ + ì›”ë³„ ìº˜ë¦°ë” ë·°</div>
              </div>
            </div>
            <ul style="margin: 0; padding-left: 20px; color: var(--gray-700); line-height: 1.8;">
              <li><strong>ë“œë˜ê·¸ì•¤ë“œë¡­</strong>: ì—…ë¬´ë¥¼ ëŒì–´ì„œ ìƒíƒœ ë³€ê²½ (ëŒ€ê¸°â†’ì§„í–‰ì¤‘â†’ì™„ë£Œ)</li>
              <li><strong>ì›”ë³„ ë·°</strong>: ìº˜ë¦°ë”ì—ì„œ í•œ ë‹¬ ì—…ë¬´ í™•ì¸</li>
              <li><strong>ë£¨í‹´ ì—…ë¬´</strong>: ë§¤ì¼/ë§¤ì£¼/ë§¤ì›” ë°˜ë³µ ì—…ë¬´ ê´€ë¦¬</li>
              <li><strong>ë¶ë§ˆí¬</strong>: ì¤‘ìš” ì—…ë¬´ ìƒë‹¨ ê³ ì •</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- OKR ì‘ì„± íŒ -->
      <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px; padding: 28px;">
        <h3 style="font-size: 20px; font-weight: 700; color: #92400e; margin-bottom: 20px;">ğŸ’¡ ì¢‹ì€ OKR ì‘ì„± íŒ</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="font-size: 16px; font-weight: 700; color: #16a34a; margin-bottom: 12px;">âœ… ì¢‹ì€ ì˜ˆì‹œ</div>
            <div style="font-size: 14px; color: var(--gray-700); line-height: 1.8;">
              <p><strong>O:</strong> ëª¨ì—¬ë¼ë”œ ì…€ëŸ¬ ìƒíƒœê³„ ê°•í™”</p>
              <p><strong>KR1:</strong> ì‹ ê·œ ì…€ëŸ¬ 20ëª… í™•ë³´</p>
              <p><strong>KR2:</strong> ì…€ëŸ¬ ì¬ì°¸ì—¬ìœ¨ 60% ë‹¬ì„±</p>
              <p><strong>KR3:</strong> Së“±ê¸‰ ì…€ëŸ¬ 5ëª… ìœ¡ì„±</p>
            </div>
          </div>
          
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="font-size: 16px; font-weight: 700; color: #dc2626; margin-bottom: 12px;">âŒ ë‚˜ìœ ì˜ˆì‹œ</div>
            <div style="font-size: 14px; color: var(--gray-700); line-height: 1.8;">
              <p><strong>O:</strong> ì—´ì‹¬íˆ ì¼í•˜ê¸° (ëª¨í˜¸í•¨)</p>
              <p><strong>KR1:</strong> ì…€ëŸ¬ ë§ì´ ëª¨ìœ¼ê¸° (ì¸¡ì • ë¶ˆê°€)</p>
              <p><strong>KR2:</strong> ë§¤ì¶œ ëŠ˜ë¦¬ê¸° (êµ¬ì²´ì  ìˆ«ì ì—†ìŒ)</p>
            </div>
          </div>
        </div>

        <div style="margin-top: 20px; padding: 16px; background: white; border-radius: 10px;">
          <div style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 8px;">ğŸ“Œ í•µì‹¬ ì›ì¹™</div>
          <ul style="margin: 0; padding-left: 20px; color: var(--gray-700); line-height: 1.8;">
            <li>ëª©í‘œëŠ” <strong>ë„ì „ì ì´ì§€ë§Œ ë‹¬ì„± ê°€ëŠ¥</strong>í•˜ê²Œ</li>
            <li><strong>70% ë‹¬ì„±</strong>ì´ë©´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼</li>
            <li>ê²°ê³¼ë³´ë‹¤ <strong>ê³¼ì •(ë…¸ë ¥)</strong>ì„ ì¤‘ìš”ì‹œ</li>
            <li>ë§¤ ë¶„ê¸° <strong>íšŒê³ í•˜ê³  ê°œì„ </strong></li>
          </ul>
        </div>
      </div>
    </div>
  `;
}

// ========================================
// ê³µêµ¬ë³„ í•  ì¼ ëª¨ë‹¬
// ========================================
async function openDealTasksModal(dealId) {
  try {
    var dealDoc = await db.collection('deals').doc(dealId).get();
    if (!dealDoc.exists) { alert('ê³µêµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
    var deal = { id: dealDoc.id, ...dealDoc.data() };
    
    var taskSnap = await db.collection('tasks').where('linkedDealId', '==', dealId).get();
    var dealTasks = [];
    taskSnap.forEach(function(doc) { dealTasks.push({ id: doc.id, ...doc.data() }); });

    var modal = document.getElementById('modal');
    modal.className = 'modal active';
    
    var html = '<div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">';
    html += '<h2 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">ğŸ“‹ ' + (deal.title || 'ê³µêµ¬') + '</h2>';
    html += '<p style="font-size: 12px; color: var(--gray-500); margin-bottom: 20px;">ğŸ“… ' + (deal.startDate || '') + ' ~ ' + (deal.endDate || '') + '</p>';
    
    // ìë™ ìƒì„± ë²„íŠ¼
    html += '<div style="background: var(--info-light); border-radius: 8px; padding: 12px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">';
    html += '<span style="font-size: 13px; color: var(--info);">ğŸ’¡ ìƒíƒœë³„ ì—…ë¬´ ìë™ ìƒì„±</span>';
    html += '<button onclick="generateDealTasks(\'' + dealId + '\', \'' + (deal.status || 'confirmed') + '\')" style="background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">ìë™ ìƒì„±</button>';
    html += '</div>';
    
    // í•  ì¼ ëª©ë¡
    html += '<div id="deal-tasks-list">';
    if (dealTasks.length === 0) {
      html += '<div style="text-align: center; padding: 30px; color: var(--gray-500);">ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
      html += '<div style="display: flex; flex-direction: column; gap: 8px;">';
      dealTasks.forEach(function(t) {
        var done = t.status === 'ì™„ë£Œ';
        html += '<div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: ' + (done ? 'var(--success-light)' : 'var(--gray-50)') + '; border-radius: 6px;">';
        html += '<input type="checkbox" ' + (done ? 'checked' : '') + ' onchange="toggleDealTask(\'' + t.id + '\', this.checked, \'' + dealId + '\')" style="width: 18px; height: 18px; cursor: pointer;" />';
        html += '<span style="flex: 1; font-size: 13px; ' + (done ? 'text-decoration: line-through; color: var(--gray-500);' : '') + '">' + t.title + '</span>';
        if (t.category) html += '<span style="background: var(--gray-200); padding: 2px 6px; border-radius: 4px; font-size: 10px;">' + t.category + '</span>';
        html += '<button onclick="deleteDealTask(\'' + t.id + '\', \'' + dealId + '\')" style="background: none; border: none; color: var(--gray-400); cursor: pointer;">Ã—</button>';
        html += '</div>';
      });
      html += '</div>';
    }
    html += '</div>';
    
    // ìƒˆ í•  ì¼ ì¶”ê°€
    html += '<div style="margin-top: 16px; display: flex; gap: 8px;">';
    html += '<input type="text" id="new-deal-task" placeholder="ìƒˆ í•  ì¼..." style="flex: 1; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;" />';
    html += '<button onclick="addDealTask(\'' + dealId + '\')" style="background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">ì¶”ê°€</button>';
    html += '</div>';
    
    html += '<button onclick="closeModal()" style="width: 100%; margin-top: 20px; background: var(--gray-200); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">ë‹«ê¸°</button>';
    html += '</div>';
    
    modal.innerHTML = html;
  } catch (error) {
    console.error('ëª¨ë‹¬ ì˜¤ë¥˜:', error);
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function generateDealTasks(dealId, status) {
  var templates = DEAL_TASK_TEMPLATES[status] || DEAL_TASK_TEMPLATES.confirmed;
  if (!confirm(templates.length + 'ê°œì˜ ì—…ë¬´ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    var batch = db.batch();
    templates.forEach(function(t) {
      var ref = db.collection('tasks').doc();
      batch.set(ref, {
        title: t.title,
        category: t.category,
        status: 'ëŒ€ê¸°',
        linkedDealId: dealId,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
    });
    await batch.commit();
    showToast(templates.length + 'ê°œ ì—…ë¬´ ìƒì„±ë¨!');
    openDealTasksModal(dealId);
  } catch (error) {
    console.error('ìƒì„± ì˜¤ë¥˜:', error);
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function toggleDealTask(taskId, done, dealId) {
  try {
    await db.collection('tasks').doc(taskId).update({ status: done ? 'ì™„ë£Œ' : 'ëŒ€ê¸°', updatedAt: new Date().toISOString() });
    openDealTasksModal(dealId);
  } catch (error) { console.error('í† ê¸€ ì˜¤ë¥˜:', error); }
}

async function deleteDealTask(taskId, dealId) {
  if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('tasks').doc(taskId).delete();
    showToast('ì‚­ì œë¨');
    openDealTasksModal(dealId);
  } catch (error) { console.error('ì‚­ì œ ì˜¤ë¥˜:', error); }
}

async function addDealTask(dealId) {
  var input = document.getElementById('new-deal-task');
  var title = input.value.trim();
  if (!title) { alert('í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  
  try {
    await db.collection('tasks').add({
      title: title,
      status: 'ëŒ€ê¸°',
      linkedDealId: dealId,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
    showToast('ì¶”ê°€ë¨');
    openDealTasksModal(dealId);
  } catch (error) { console.error('ì¶”ê°€ ì˜¤ë¥˜:', error); }
}

// ========================================
// ì—…ë¬´ê´€ë¦¬
// ========================================
function renderTaskManagement() {
  var app = document.getElementById('app');
  app.innerHTML = '<div class="page-header"><h1 style="font-size: 24px; font-weight: 700;">ğŸ“‹ ì—…ë¬´ê´€ë¦¬</h1><p style="color: var(--gray-600); margin-top: 8px;">íŒ€ ì—…ë¬´ë¥¼ ë“±ë¡í•˜ê³  ì§„í–‰ ìƒí™©ì„ ê´€ë¦¬í•˜ì„¸ìš”</p></div><div class="content"><div id="task-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;"><div style="background: white; border-radius: 10px; padding: 16px; text-align: center;"><div style="font-size: 12px; color: var(--gray-500);">ì „ì²´</div><div id="stat-total" style="font-size: 28px; font-weight: 700;">-</div></div><div style="background: var(--info-light); border-radius: 10px; padding: 16px; text-align: center;"><div style="font-size: 12px; color: var(--info);">ì§„í–‰ì¤‘</div><div id="stat-inprogress" style="font-size: 28px; font-weight: 700; color: var(--info);">-</div></div><div style="background: var(--warning-light); border-radius: 10px; padding: 16px; text-align: center;"><div style="font-size: 12px; color: var(--warning);">ëŒ€ê¸°</div><div id="stat-waiting" style="font-size: 28px; font-weight: 700; color: var(--warning);">-</div></div><div style="background: var(--success-light); border-radius: 10px; padding: 16px; text-align: center;"><div style="font-size: 12px; color: var(--success);">ì™„ë£Œ</div><div id="stat-completed" style="font-size: 28px; font-weight: 700; color: var(--success);">-</div></div></div><div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;"><select id="task-filter-status" onchange="loadTasks()" style="padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 6px;"><option value="">ì „ì²´ ìƒíƒœ</option><option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option><option value="ëŒ€ê¸°">ëŒ€ê¸°</option><option value="ì™„ë£Œ">ì™„ë£Œ</option><option value="ë³´ë¥˜">ë³´ë¥˜</option></select><select id="task-filter-category" onchange="loadTasks()" style="padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 6px;"><option value="">ì „ì²´ êµ¬ë¶„</option><option value="í˜‘ì˜">í˜‘ì˜</option><option value="ì½˜í…ì¸ ">ì½˜í…ì¸ </option><option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option><option value="ìš´ì˜">ìš´ì˜</option><option value="ì •ì‚°">ì •ì‚°</option><option value="ì…€ëŸ¬ê´€ë¦¬">ì…€ëŸ¬ê´€ë¦¬</option></select><div style="flex: 1;"></div><button onclick="openTaskImportModal()" style="background: var(--gray-100); border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“¥ CSV ê°€ì ¸ì˜¤ê¸°</button><button onclick="openTaskModal()" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">+ ìƒˆ ì—…ë¬´</button></div><div id="task-list-content"><div class="loading" style="text-align: center; padding: 40px;"><div class="loading-spinner"></div></div></div></div>';
  loadTasks();
}

async function loadTasks() {
  try {
    var fStatus = document.getElementById('task-filter-status');
    var fCat = document.getElementById('task-filter-category');
    var filterStatus = fStatus ? fStatus.value : '';
    var filterCat = fCat ? fCat.value : '';

    var snap = await db.collection('tasks').orderBy('createdAt', 'desc').get();
    var tasks = [];
    snap.forEach(function(doc) {
      var t = { id: doc.id, ...doc.data() };
      if (filterStatus && t.status !== filterStatus) return;
      if (filterCat && t.category !== filterCat) return;
      tasks.push(t);
    });

    // í†µê³„
    var el = document.getElementById('stat-total');
    if (el) el.textContent = tasks.length;
    el = document.getElementById('stat-inprogress');
    if (el) el.textContent = tasks.filter(function(t) { return t.status === 'ì§„í–‰ì¤‘'; }).length;
    el = document.getElementById('stat-waiting');
    if (el) el.textContent = tasks.filter(function(t) { return t.status === 'ëŒ€ê¸°'; }).length;
    el = document.getElementById('stat-completed');
    if (el) el.textContent = tasks.filter(function(t) { return t.status === 'ì™„ë£Œ'; }).length;

    renderTaskList(tasks);
  } catch (error) {
    console.error('ì—…ë¬´ ë¡œë“œ ì˜¤ë¥˜:', error);
    document.getElementById('task-list-content').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">ì˜¤ë¥˜ ë°œìƒ</div>';
  }
}

function renderTaskList(tasks) {
  var content = document.getElementById('task-list-content');
  if (tasks.length === 0) {
    content.innerHTML = '<div style="text-align: center; padding: 60px; background: var(--gray-50); border-radius: 12px;"><div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div><p style="color: var(--gray-700);">ë“±ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
    return;
  }

  var colors = {
    'ì™„ë£Œ': { bg: 'var(--success-light)', c: 'var(--success)', i: 'âœ…' },
    'ì§„í–‰ì¤‘': { bg: 'var(--info-light)', c: 'var(--info)', i: 'ğŸ”„' },
    'ëŒ€ê¸°': { bg: 'var(--warning-light)', c: 'var(--warning)', i: 'â³' },
    'ë³´ë¥˜': { bg: 'var(--gray-100)', c: 'var(--gray-600)', i: 'â¸ï¸' }
  };

  var html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
  tasks.forEach(function(t) {
    var s = colors[t.status] || colors['ëŒ€ê¸°'];
    html += '<div style="background: white; border-radius: 8px; padding: 14px; display: flex; align-items: center; gap: 12px;">';
    html += '<div style="background: ' + s.bg + '; color: ' + s.c + '; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; white-space: nowrap;">' + s.i + ' ' + t.status + '</div>';
    html += '<div style="flex: 1; min-width: 0;"><div style="font-size: 14px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + t.title + '</div>';
    html += '<div style="font-size: 12px; color: var(--gray-500); margin-top: 2px;">';
    if (t.category) html += '<span style="margin-right: 10px;">ğŸ“ ' + t.category + '</span>';
    if (t.dueDate) html += '<span>ğŸ“… ' + t.dueDate + '</span>';
    if (t.linkedDealId) html += '<span style="margin-left: 10px; color: var(--primary);">ğŸ”— ê³µêµ¬ì—°ê²°</span>';
    html += '</div></div>';
    html += '<button onclick="changeTaskStatus(\'' + t.id + '\', \'' + t.status + '\')" style="background: var(--gray-100); border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">ìƒíƒœë³€ê²½</button>';
    html += '<button onclick="deleteTask(\'' + t.id + '\')" style="background: var(--danger-light); color: var(--danger); border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>';
    html += '</div>';
  });
  html += '</div>';
  content.innerHTML = html;
}

async function changeTaskStatus(taskId, current) {
  var arr = ['ëŒ€ê¸°', 'ì§„í–‰ì¤‘', 'ì™„ë£Œ', 'ë³´ë¥˜'];
  var next = arr[(arr.indexOf(current) + 1) % arr.length];
  if (!confirm('"' + next + '"(ìœ¼)ë¡œ ë³€ê²½?')) return;
  try {
    await db.collection('tasks').doc(taskId).update({ status: next, updatedAt: new Date().toISOString() });
    showToast('ë³€ê²½ë¨');
    loadTasks();
  } catch (error) { console.error('ë³€ê²½ ì˜¤ë¥˜:', error); }
}

function openTaskModal() {
  var modal = document.getElementById('modal');
  modal.className = 'modal active';
  modal.innerHTML = '<div class="modal-content" style="max-width: 500px;"><h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ìƒˆ ì—…ë¬´ ë“±ë¡</h2><div style="display: grid; gap: 16px;"><div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ì—…ë¬´ëª… *</label><input type="text" id="task-title" placeholder="ì—…ë¬´ ì œëª©" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;" /></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"><div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ìƒíƒœ</label><select id="task-status" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;"><option value="ëŒ€ê¸°">ëŒ€ê¸°</option><option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option><option value="ì™„ë£Œ">ì™„ë£Œ</option></select></div><div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">êµ¬ë¶„</label><select id="task-category" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;"><option value="">ì„ íƒ</option><option value="í˜‘ì˜">í˜‘ì˜</option><option value="ì½˜í…ì¸ ">ì½˜í…ì¸ </option><option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option><option value="ìš´ì˜">ìš´ì˜</option><option value="ì •ì‚°">ì •ì‚°</option><option value="ì…€ëŸ¬ê´€ë¦¬">ì…€ëŸ¬ê´€ë¦¬</option></select></div></div><div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ì™„ë£Œê¸°í•œ</label><input type="date" id="task-due" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px;" /></div></div><div style="display: flex; gap: 12px; margin-top: 24px;"><button onclick="closeModal()" style="flex: 1; background: var(--gray-200); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button><button onclick="saveTask()" style="flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">ì €ì¥</button></div></div>';
}

async function saveTask() {
  var title = document.getElementById('task-title').value.trim();
  if (!title) { alert('ì—…ë¬´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  try {
    await db.collection('tasks').add({
      title: title,
      status: document.getElementById('task-status').value,
      category: document.getElementById('task-category').value,
      dueDate: document.getElementById('task-due').value,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
    showToast('ë“±ë¡ë¨');
    closeModal();
    loadTasks();
  } catch (error) { console.error('ì €ì¥ ì˜¤ë¥˜:', error); alert('ì˜¤ë¥˜ ë°œìƒ'); }
}

async function deleteTask(taskId) {
  if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('tasks').doc(taskId).delete();
    showToast('ì‚­ì œë¨');
    loadTasks();
  } catch (error) { console.error('ì‚­ì œ ì˜¤ë¥˜:', error); }
}

function openTaskImportModal() {
  var modal = document.getElementById('modal');
  modal.className = 'modal active';
  modal.innerHTML = '<div class="modal-content" style="max-width: 600px;"><h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ“¥ Hiworks CSV ê°€ì ¸ì˜¤ê¸°</h2><div style="background: var(--info-light); border-radius: 8px; padding: 16px; margin-bottom: 20px;"><div style="font-size: 13px; font-weight: 600; color: var(--info); margin-bottom: 4px;">ğŸ“‹ ì§€ì› í˜•ì‹</div><div style="font-size: 12px; color: var(--gray-700);">Hiworks ì—…ë¬´ CSV (ì´ë²¤íŠ¸ ì´ë¦„, ìƒíƒœ, êµ¬ë¶„, ì™„ë£Œê¸°í•œ)</div></div><input type="file" id="csv-file" accept=".csv" style="width: 100%; padding: 12px; border: 2px dashed var(--gray-300); border-radius: 8px; margin-bottom: 16px;" /><div id="csv-preview" style="display: none; background: var(--gray-50); border-radius: 8px; padding: 12px; margin-bottom: 16px; max-height: 150px; overflow-y: auto;"></div><div style="display: flex; gap: 12px;"><button onclick="closeModal()" style="flex: 1; background: var(--gray-200); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button><button onclick="importCSV()" id="import-btn" style="flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;" disabled>ê°€ì ¸ì˜¤ê¸°</button></div></div>';
  
  document.getElementById('csv-file').addEventListener('change', function(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      window.csvData = parseCSV(ev.target.result);
      if (window.csvData.length > 0) {
        document.getElementById('csv-preview').style.display = 'block';
        document.getElementById('csv-preview').innerHTML = '<div style="color: var(--success); font-weight: 600; margin-bottom: 8px;">âœ… ' + window.csvData.length + 'ê°œ ë°œê²¬</div>' + window.csvData.slice(0, 3).map(function(t) { return '<div style="font-size: 12px; padding: 4px 0;">' + t.title + ' - ' + t.status + '</div>'; }).join('');
        document.getElementById('import-btn').disabled = false;
      }
    };
    reader.readAsText(file, 'UTF-8');
  });
}

function parseCSV(csv) {
  var lines = csv.split('\n').filter(function(l) { return l.trim(); });
  if (lines.length < 2) return [];
  var tasks = [];
  for (var i = 1; i < lines.length; i++) {
    var vals = [];
    var current = '';
    var inQ = false;
    for (var j = 0; j < lines[i].length; j++) {
      var c = lines[i][j];
      if (c === '"') inQ = !inQ;
      else if (c === ',' && !inQ) { vals.push(current.trim()); current = ''; }
      else current += c;
    }
    vals.push(current.trim());
    if (vals.length >= 4 && vals[0]) {
      var pri = 0;
      if (vals.length > 11 && vals[11]) pri = (vals[11].match(/â­/g) || []).length;
      tasks.push({
        title: vals[0].replace(/"/g, ''),
        status: vals[1].replace(/"/g, '') || 'ëŒ€ê¸°',
        category: vals[2].replace(/"/g, '') || 'ê¸°íƒ€',
        dueDate: vals[3].replace(/"/g, '') || '',
        priority: pri,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
    }
  }
  return tasks;
}

async function importCSV() {
  if (!window.csvData || window.csvData.length === 0) { alert('ë°ì´í„° ì—†ìŒ'); return; }
  document.getElementById('import-btn').disabled = true;
  document.getElementById('import-btn').textContent = 'ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
  try {
    var batch = db.batch();
    window.csvData.forEach(function(t) { batch.set(db.collection('tasks').doc(), t); });
    await batch.commit();
    showToast(window.csvData.length + 'ê°œ ê°€ì ¸ì˜´!');
    closeModal();
    loadTasks();
  } catch (error) {
    console.error('ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
    alert('ì˜¤ë¥˜ ë°œìƒ');
    document.getElementById('import-btn').disabled = false;
    document.getElementById('import-btn').textContent = 'ê°€ì ¸ì˜¤ê¸°';
  }
}

// ========================================
// ê³µêµ¬ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ â†” ì—…ë¬´ ì—°ë™
// ========================================

// ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
function updateDealJourneyProgress() {
  var checkboxes = document.querySelectorAll('.journey-checklist-item input[type="checkbox"]');
  var total = checkboxes.length;
  var checked = 0;
  checkboxes.forEach(function(cb) {
    if (cb.checked) checked++;
    // ì²´í¬ëœ í•­ëª© ìŠ¤íƒ€ì¼ ë³€ê²½
    var label = cb.closest('.journey-checklist-item');
    if (label) {
      if (cb.checked) {
        label.style.background = 'var(--success-light)';
        label.style.borderColor = 'var(--success)';
        label.querySelector('span').style.textDecoration = 'line-through';
        label.querySelector('span').style.color = 'var(--gray-500)';
      } else {
        label.style.background = 'white';
        label.style.borderColor = 'var(--gray-200)';
        label.querySelector('span').style.textDecoration = 'none';
        label.querySelector('span').style.color = 'var(--gray-900)';
      }
    }
  });
  var progressEl = document.getElementById('deal-journey-progress');
  if (progressEl) {
    var percent = total > 0 ? Math.round((checked / total) * 100) : 0;
    progressEl.textContent = checked + '/' + total + ' ì™„ë£Œ (' + percent + '%)';
    progressEl.style.color = percent === 100 ? 'var(--success)' : 'var(--primary)';
  }
}

// ì²´í¬ë¦¬ìŠ¤íŠ¸ ì²´í¬ ì‹œ â†’ ì—°ê²°ëœ ì—…ë¬´ ìƒíƒœ ë™ê¸°í™”
async function syncJourneyToTask(dealId, journeyKey, taskTitle, isChecked) {
  if (!dealId) return; // ìƒˆ ê³µêµ¬ ë“±ë¡ ì‹œì—ëŠ” ìŠ¤í‚µ
  
  try {
    // ê³µêµ¬ ì œëª© ê°€ì ¸ì˜¤ê¸°
    var dealTitle = document.getElementById('deal-title')?.value || 'ê³µêµ¬';
    
    // í•´ë‹¹ ê³µêµ¬ì— ì—°ê²°ëœ ì—…ë¬´ ì¤‘ ì œëª©ì´ ì¼ì¹˜í•˜ëŠ” ê²ƒ ì°¾ê¸°
    var snapshot = await db.collection('tasks')
      .where('linkedDealId', '==', dealId)
      .where('journeyKey', '==', journeyKey)
      .get();
    
    if (!snapshot.empty) {
      // ì—…ë¬´ê°€ ìˆìœ¼ë©´ ìƒíƒœ ì—…ë°ì´íŠ¸
      snapshot.forEach(function(doc) {
        db.collection('tasks').doc(doc.id).update({
          status: isChecked ? 'ì™„ë£Œ' : 'ëŒ€ê¸°',
          completedAt: isChecked ? new Date().toISOString() : null,
          updatedAt: new Date().toISOString()
        });
      });
    }
    
    // âœ… ì²´í¬ ì‹œ ìë™ìœ¼ë¡œ í™œë™ ë¡œê·¸ì— ê¸°ë¡
    if (isChecked) {
      var currentMember = getCurrentMember ? getCurrentMember() : { id: 'unknown', name: state.currentUser?.name || 'ë¯¸ì§€ì •' };
      var today = new Date();
      
      await db.collection('activityLogs').add({
        action: taskTitle + ' ì™„ë£Œ',
        dealId: dealId,
        dealTitle: dealTitle,
        journeyKey: journeyKey,
        memberId: currentMember.id,
        memberName: currentMember.name,
        date: today.toISOString().split('T')[0],
        time: today.toTimeString().substring(0, 5),
        type: 'journey_check',
        createdAt: today.toISOString()
      });
      
      showToast('âœ… ' + taskTitle + ' ì™„ë£Œ! (ìë™ ê¸°ë¡ë¨)');
    }
  } catch (error) {
    console.error('ì—…ë¬´ ë™ê¸°í™” ì˜¤ë¥˜:', error);
  }
}

// ë¯¸ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© â†’ ì—…ë¬´ë¡œ ìƒì„±
async function generateDealTasksFromJourney(dealId) {
  if (!dealId) {
    alert('ê³µêµ¬ë¥¼ ë¨¼ì € ì €ì¥í•œ í›„ ì—…ë¬´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì •ì˜
  var journeyItems = [
    { key: 'journeySample', id: 'journey-sample', title: 'ìƒ˜í”Œ ì „ë‹¬', category: 'ì¤€ë¹„' },
    { key: 'journeyPaymentLink', id: 'journey-payment-link', title: 'ê²°ì œë§í¬ ì „ë‹¬', category: 'ì¤€ë¹„' },
    { key: 'journeyContent', id: 'journey-content', title: 'ì½˜í…ì¸  ì „ë‹¬', category: 'ì¤€ë¹„' },
    { key: 'journeyAdSetup', id: 'journey-ad-setup', title: 'ê´‘ê³  ì„¸íŒ…', category: 'ë§ˆì¼€íŒ…' },
    { key: 'journeySellerGuide', id: 'journey-seller-guide', title: 'ì…€ëŸ¬ ê°€ì´ë“œ ì „ë‹¬', category: 'ì…€ëŸ¬ê´€ë¦¬' },
    { key: 'journeyMonitoring', id: 'journey-monitoring', title: 'ì£¼ë¬¸ í˜„í™© ëª¨ë‹ˆí„°ë§', category: 'ìš´ì˜' },
    { key: 'journeyCs', id: 'journey-cs', title: 'ê³ ê° ë¬¸ì˜ ëŒ€ì‘', category: 'ìš´ì˜' },
    { key: 'journeyOrderSend', id: 'journey-order-send', title: 'ë°œì£¼ì„œ ì „ë‹¬ (ê·¸ë¡œí™ˆ)', category: 'ì •ì‚°' },
    { key: 'journeySellerSettle', id: 'journey-seller-settle', title: 'ì…€ëŸ¬ ì •ì‚°ì„œ ì œì‘', category: 'ì •ì‚°' },
    { key: 'journeySupplierSettle', id: 'journey-supplier-settle', title: 'ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì œì‘', category: 'ì •ì‚°' },
    { key: 'journeyComplete', id: 'journey-complete', title: 'ì •ì‚° ì™„ë£Œ', category: 'ì •ì‚°' }
  ];
  
  // ê³µêµ¬ ì œëª© ê°€ì ¸ì˜¤ê¸°
  var dealTitle = document.getElementById('deal-title')?.value || 'ê³µêµ¬';
  
  // ë¯¸ì™„ë£Œ í•­ëª© ì°¾ê¸°
  var uncheckedItems = journeyItems.filter(function(item) {
    var cb = document.getElementById(item.id);
    return cb && !cb.checked;
  });
  
  if (uncheckedItems.length === 0) {
    alert('ëª¨ë“  ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    return;
  }
  
  if (!confirm(uncheckedItems.length + 'ê°œì˜ ë¯¸ì™„ë£Œ í•­ëª©ì„ ì—…ë¬´ë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    // ì´ë¯¸ ìƒì„±ëœ ì—…ë¬´ í™•ì¸
    var existingSnap = await db.collection('tasks').where('linkedDealId', '==', dealId).get();
    var existingKeys = [];
    existingSnap.forEach(function(doc) {
      var data = doc.data();
      if (data.journeyKey) existingKeys.push(data.journeyKey);
    });
    
    // ìƒˆë¡œ ìƒì„±í•  í•­ëª©ë§Œ í•„í„°ë§
    var newItems = uncheckedItems.filter(function(item) {
      return existingKeys.indexOf(item.key) === -1;
    });
    
    if (newItems.length === 0) {
      alert('ëª¨ë“  ë¯¸ì™„ë£Œ í•­ëª©ì´ ì´ë¯¸ ì—…ë¬´ë¡œ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    var batch = db.batch();
    newItems.forEach(function(item) {
      var ref = db.collection('tasks').doc();
      batch.set(ref, {
        title: '[' + dealTitle + '] ' + item.title,
        category: item.category,
        status: 'ëŒ€ê¸°',
        linkedDealId: dealId,
        journeyKey: item.key,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
    });
    await batch.commit();
    
    showToast(newItems.length + 'ê°œì˜ ì—…ë¬´ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
  } catch (error) {
    console.error('ì—…ë¬´ ìƒì„± ì˜¤ë¥˜:', error);
    alert('ì—…ë¬´ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  ì´ˆê¸°í™”
function initDealJourneyProgress() {
  setTimeout(function() {
    updateDealJourneyProgress();
  }, 100);
}

// ========================================
// ì…€ëŸ¬ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ â†” ì—…ë¬´ ì—°ë™
// ========================================

// ì…€ëŸ¬ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ì •ì˜
var SELLER_JOURNEY_ITEMS = [
  { key: 'sellerFirstContact', title: 'ì²« ë¯¸íŒ…/ì—°ë½', category: 'ì…€ëŸ¬ê´€ë¦¬' },
  { key: 'sellerOnboarding', title: 'ì˜¨ë³´ë”© ê°€ì´ë“œ ì „ë‹¬', category: 'ì…€ëŸ¬ê´€ë¦¬' },
  { key: 'sellerDocuments', title: 'ì„œë¥˜ ìˆ˜ë ¹ ì™„ë£Œ', category: 'ì…€ëŸ¬ê´€ë¦¬' },
  { key: 'sellerFirstDeal', title: 'ì²« ê³µêµ¬ ì§„í–‰', category: 'ì…€ëŸ¬ê´€ë¦¬' },
  { key: 'sellerFeedback', title: 'ì„±ê³¼ í”¼ë“œë°±', category: 'ì…€ëŸ¬ê´€ë¦¬' }
];

// ì…€ëŸ¬ ì—¬ì •ì—ì„œ ì—…ë¬´ ìƒì„±
async function generateSellerTasksFromJourney(sellerId, sellerName) {
  if (!sellerId) {
    alert('ì…€ëŸ¬ë¥¼ ë¨¼ì € ì €ì¥í•œ í›„ ì—…ë¬´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!confirm('ì…€ëŸ¬ ê´€ë¦¬ ì—…ë¬´ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    var existingSnap = await db.collection('tasks').where('linkedSellerId', '==', sellerId).get();
    var existingKeys = [];
    existingSnap.forEach(function(doc) {
      var data = doc.data();
      if (data.sellerJourneyKey) existingKeys.push(data.sellerJourneyKey);
    });
    
    var newItems = SELLER_JOURNEY_ITEMS.filter(function(item) {
      return existingKeys.indexOf(item.key) === -1;
    });
    
    if (newItems.length === 0) {
      alert('ëª¨ë“  ì…€ëŸ¬ ê´€ë¦¬ ì—…ë¬´ê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    var batch = db.batch();
    newItems.forEach(function(item) {
      var ref = db.collection('tasks').doc();
      batch.set(ref, {
        title: '[ì…€ëŸ¬:' + sellerName + '] ' + item.title,
        category: item.category,
        status: 'ëŒ€ê¸°',
        linkedSellerId: sellerId,
        sellerJourneyKey: item.key,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
    });
    await batch.commit();
    
    showToast(newItems.length + 'ê°œì˜ ì…€ëŸ¬ ê´€ë¦¬ ì—…ë¬´ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
  } catch (error) {
    console.error('ì…€ëŸ¬ ì—…ë¬´ ìƒì„± ì˜¤ë¥˜:', error);
    alert('ì—…ë¬´ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì…€ëŸ¬ ì—¬ì • ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
function updateSellerJourneyProgress() {
  var checkboxes = document.querySelectorAll('.seller-journey-item input[type="checkbox"]');
  var total = checkboxes.length;
  var checked = 0;
  checkboxes.forEach(function(cb) {
    if (cb.checked) checked++;
    var label = cb.closest('.seller-journey-item');
    if (label) {
      if (cb.checked) {
        label.style.background = 'var(--success-light)';
        label.style.borderColor = 'var(--success)';
        label.querySelector('span').style.textDecoration = 'line-through';
        label.querySelector('span').style.color = 'var(--gray-500)';
      } else {
        label.style.background = 'white';
        label.style.borderColor = 'var(--gray-200)';
        label.querySelector('span').style.textDecoration = 'none';
        label.querySelector('span').style.color = 'var(--gray-900)';
      }
    }
  });
  var progressEl = document.getElementById('seller-journey-progress');
  if (progressEl) {
    progressEl.textContent = checked + '/' + total + ' ì™„ë£Œ';
    progressEl.style.color = checked === total ? 'var(--success)' : 'var(--primary)';
  }
}

// ========================================
// Phase 2: OKR-ì‹¤ì  ìë™ ì—°ë™ ì‹œìŠ¤í…œ
// ========================================

// KR íƒ€ì… ì •ì˜ (ì‹¤ì  ì—°ë™ìš©)
var KR_TYPES = {
  manual: { label: 'ìˆ˜ë™ ì…ë ¥', icon: 'âœï¸', unit: '' }
};

// KR ì‹¤ì  ìë™ ê³„ì‚°
async function calculateKRActual(krType, quarter, memberId) {
  try {
    var quarterParts = quarter.split('-Q');
    var year = parseInt(quarterParts[0]);
    var q = parseInt(quarterParts[1]);
    
    // ë¶„ê¸° ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
    var startMonth = (q - 1) * 3;
    var startDate = new Date(year, startMonth, 1);
    var endDate = new Date(year, startMonth + 3, 0);
    var startStr = startDate.toISOString().split('T')[0];
    var endStr = endDate.toISOString().split('T')[0];
    
    switch(krType) {
      case 'sales':
        // ì •ì‚° ë°ì´í„°ì—ì„œ ë§¤ì¶œ í•©ê³„
        var settleSnap = await db.collection('sellerSettlements').get();
        var totalSales = 0;
        settleSnap.forEach(function(doc) {
          var d = doc.data();
          if (d.createdAt >= startStr && d.createdAt <= endStr) {
            totalSales += Number(d.totalSales) || 0;
          }
        });
        return totalSales;
        
      case 'dealCount':
        // í•´ë‹¹ ë¶„ê¸° ì™„ë£Œëœ ê³µêµ¬ ìˆ˜
        var dealSnap = await db.collection('deals').get();
        var dealCount = 0;
        dealSnap.forEach(function(doc) {
          var d = doc.data();
          if (d.endDate >= startStr && d.endDate <= endStr) {
            dealCount++;
          }
        });
        return dealCount;
        
      case 'sellerCount':
        // í•´ë‹¹ ë¶„ê¸° ì‹ ê·œ ì…€ëŸ¬ ìˆ˜
        var sellerSnap = await db.collection('sellers').get();
        var sellerCount = 0;
        sellerSnap.forEach(function(doc) {
          var d = doc.data();
          var createdAt = d.createdAt || '';
          if (createdAt >= startStr && createdAt <= endStr) {
            sellerCount++;
          }
        });
        return sellerCount;
        
      case 'supplierCount':
        // í•´ë‹¹ ë¶„ê¸° ê³µê¸‰ì‚¬ ìˆ˜
        var supplierSnap = await db.collection('suppliers').get();
        var supplierCount = 0;
        supplierSnap.forEach(function(doc) {
          var d = doc.data();
          var createdAt = d.createdAt || '';
          if (createdAt >= startStr && createdAt <= endStr) {
            supplierCount++;
          }
        });
        return supplierCount;
        
      case 'orderCount':
        var settleSnap2 = await db.collection('sellerSettlements').get();
        var totalOrders = 0;
        settleSnap2.forEach(function(doc) {
          var d = doc.data();
          if (d.createdAt >= startStr && d.createdAt <= endStr) {
            totalOrders += Number(d.salesCount) || 0;
          }
        });
        return totalOrders;
        
      case 'profit':
        // ìˆœì´ìµ ê³„ì‚° (ì •ì‚° ë°ì´í„°ì—ì„œ)
        var profitSnap = await db.collection('sellerSettlements').get();
        var totalProfit = 0;
        profitSnap.forEach(function(doc) {
          var d = doc.data();
          if (d.createdAt >= startStr && d.createdAt <= endStr) {
            totalProfit += Number(d.netProfit) || Number(d.profit) || 0;
          }
        });
        return totalProfit;
        
      case 'taskCount':
        // ì—…ë¬´ì¼ì§€ì—ì„œ ì™„ë£Œëœ ì—…ë¬´ ìˆ˜ (ë‹´ë‹¹ìë³„)
        var taskSnap = await db.collection('tasks').get();
        var taskCount = 0;
        taskSnap.forEach(function(doc) {
          var d = doc.data();
          var completedAt = d.completedAt || '';
          // í•´ë‹¹ ë¶„ê¸°ì— ì™„ë£Œëœ ì—…ë¬´
          if (completedAt >= startStr && completedAt <= endStr + 'T23:59:59') {
            // memberIdê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‹´ë‹¹ì ì—…ë¬´ë§Œ
            if (memberId) {
              if (d.assigneeId === memberId || d.assignee === memberId) {
                taskCount++;
              }
            } else {
              taskCount++;
            }
          }
        });
        return taskCount;
        
      default:
        return 0;
    }
  } catch (error) {
    console.error('KR ì‹¤ì  ê³„ì‚° ì˜¤ë¥˜:', error);
    return 0;
  }
}

// OKR ì§„í–‰ë¥  ìë™ ì—…ë°ì´íŠ¸
async function autoUpdateOKRProgress(okrId) {
  try {
    var okrDoc = await db.collection('okrs').doc(okrId).get();
    if (!okrDoc.exists) return;
    
    var okr = okrDoc.data();
    var keyResults = okr.keyResults || [];
    
    if (keyResults.length === 0) return;
    
    var totalProgress = 0;
    var updatedKRs = [];
    
    for (var i = 0; i < keyResults.length; i++) {
      var kr = keyResults[i];
      var actual = kr.actual || 0;
      
      // ìë™ ê³„ì‚° íƒ€ì…ì´ë©´ ì‹¤ì  ê³„ì‚° (memberId ì „ë‹¬)
      if (kr.type && KR_TYPES[kr.type] && KR_TYPES[kr.type].autoCalc) {
        actual = await calculateKRActual(kr.type, okr.quarter, okr.memberId);
      }
      
      var target = Number(kr.target) || 1;
      var progress = Math.min(100, Math.round((actual / target) * 100));
      
      updatedKRs.push({
        ...kr,
        actual: actual,
        progress: progress
      });
      
      totalProgress += progress;
    }
    
    var avgProgress = Math.round(totalProgress / keyResults.length);
    
    await db.collection('okrs').doc(okrId).update({
      keyResults: updatedKRs,
      progress: avgProgress,
      updatedAt: new Date().toISOString()
    });
    
    return avgProgress;
  } catch (error) {
    console.error('OKR ìë™ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
  }
}

// ì „ì²´ OKR ì‹¤ì  ë™ê¸°í™”
async function syncAllOKRProgress() {
  try {
    showToast('OKR ì‹¤ì  ë™ê¸°í™” ì¤‘...');
    var snapshot = await db.collection('okrs').get();
    var promises = [];
    snapshot.forEach(function(doc) {
      promises.push(autoUpdateOKRProgress(doc.id));
    });
    await Promise.all(promises);
    showToast('OKR ì‹¤ì ì´ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
    
    // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    if (state.currentTab === 'okrDashboard') renderOKRDashboard();
    if (state.currentTab === 'okrManagement') loadOKRList();
  } catch (error) {
    console.error('ì „ì²´ ë™ê¸°í™” ì˜¤ë¥˜:', error);
  }
}

// ========================================
// Phase 3: ì—…ë¬´ì¼ì§€ - íŒ€ì›ë³„ ê´€ë¦¬ + ìë™ê¸°ì…
// ========================================

// ìƒíƒœ ì»¬ëŸ¼ ì •ì˜
var TASK_COLUMNS = [
  { id: 'waiting', label: 'ëŒ€ê¸°', color: '#f59e0b', bg: '#fef3c7', icon: 'â³' },
  { id: 'progress', label: 'ì§„í–‰ì¤‘', color: '#3b82f6', bg: '#dbeafe', icon: 'ğŸ”„' },
  { id: 'complete', label: 'ì™„ë£Œ', color: '#10b981', bg: '#d1fae5', icon: 'âœ…' },
  { id: 'hold', label: 'ë³´ë¥˜', color: '#6b7280', bg: '#f3f4f6', icon: 'â¸ï¸' }
];

var STATUS_MAP = { 'ëŒ€ê¸°': 'waiting', 'ì§„í–‰ì¤‘': 'progress', 'ì™„ë£Œ': 'complete', 'ë³´ë¥˜': 'hold' };
var REVERSE_STATUS_MAP = { 'waiting': 'ëŒ€ê¸°', 'progress': 'ì§„í–‰ì¤‘', 'complete': 'ì™„ë£Œ', 'hold': 'ë³´ë¥˜' };

// í˜„ì¬ íŒ€ì› ì •ë³´
function getCurrentMember() {
  return {
    id: state.currentUser?.odooId || 'unknown',
    name: state.currentUser?.name || 'ë¯¸ì§€ì •'
  };
}

// ì—…ë¬´ì¼ì§€ í˜ì´ì§€ ë Œë”ë§
function renderWorkLog() {
  var app = document.getElementById('app');
  var now = new Date();
  var currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  var currentMember = getCurrentMember();
  var isAdmin = state.currentUser?.role === 'admin';
  var teamMembers = state.teamMembers || [];
  
  // í† ìŠ¤ ìŠ¤íƒ€ì¼ ì»¬ëŸ¬
  var colors = {
    blue: '#0064FF',
    blueLight: '#E8F3FF',
    gray50: '#F2F4F6',
    gray100: '#E5E8EB',
    gray500: '#6B7684',
    gray700: '#333D4B',
    black: '#191F28',
    white: '#FFFFFF'
  };
  
  app.innerHTML = `
    <div style="background: ${colors.gray50}; min-height: 100vh; margin: -24px; padding: 24px;">
      <!-- í—¤ë” -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h1 style="font-size: 26px; font-weight: 700; color: ${colors.black}; margin: 0;">ğŸ““ ì—…ë¬´ì¼ì§€</h1>
          <p style="color: ${colors.gray500}; margin-top: 8px; font-size: 15px;">íŒ€ì›ë³„ ì—…ë¬´ ê´€ë¦¬ ë° ìë™ ê¸°ë¡</p>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="openQuickTaskModal()" style="padding: 12px 20px; font-size: 14px; font-weight: 600; background: ${colors.blue}; color: white; border: none; border-radius: 12px; cursor: pointer;">
            â• ìƒˆ ì—…ë¬´
          </button>
          <button onclick="openRoutineModal()" style="padding: 12px 20px; font-size: 14px; font-weight: 600; background: ${colors.white}; color: ${colors.gray700}; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            â° ë£¨í‹´ ê´€ë¦¬
          </button>
          ${isAdmin ? `
          <button onclick="openCategoryManageModal()" style="padding: 12px 20px; font-size: 14px; font-weight: 600; background: ${colors.white}; color: ${colors.gray700}; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            âš™ï¸ êµ¬ë¶„ ê´€ë¦¬
          </button>
          ` : ''}
        </div>
      </div>
      
      <!-- ì»¨íŠ¸ë¡¤ ë°” -->
      <div style="background: ${colors.white}; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
          <!-- ì›” ì„ íƒ -->
          <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="changeWorkLogMonth(-1)" style="background: ${colors.gray100}; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 18px;">â†</button>
            <input type="month" id="worklog-month" value="${currentMonth}" onchange="loadWorkLogByMonth()" style="padding: 10px 16px; border: 1px solid ${colors.gray100}; border-radius: 10px; font-size: 15px; font-weight: 600;" />
            <button onclick="changeWorkLogMonth(1)" style="background: ${colors.gray100}; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 18px;">â†’</button>
            <button onclick="goToCurrentMonth()" style="background: ${colors.blueLight}; color: ${colors.blue}; border: none; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600;">ì´ë²ˆë‹¬</button>
          </div>
          
          <!-- íŒ€ì› í•„í„° (ë“œë¡­ë‹¤ìš´) -->
          <div style="display: flex; align-items: center; gap: 10px;">
            <select id="member-filter-select" onchange="setMemberFilterBySelect(this.value)" style="padding: 10px 16px; border: 1px solid ${colors.gray100}; border-radius: 10px; font-size: 14px; font-weight: 500; min-width: 160px; cursor: pointer;">
              <option value="my">ğŸ‘¤ ë‚´ ì—…ë¬´</option>
              <option value="all" ${isAdmin ? '' : 'disabled'}>ğŸ‘¥ íŒ€ ì „ì²´ ${isAdmin ? '' : '(ê´€ë¦¬ìë§Œ)'}</option>
              <optgroup label="íŒ€ì›ë³„ ë³´ê¸°">
                ${teamMembers.map(m => `<option value="member_${m.id}">${m.name}</option>`).join('')}
              </optgroup>
            </select>
          </div>
          
          <!-- ë·° ì „í™˜ -->
          <div style="display: flex; gap: 8px; background: ${colors.gray50}; padding: 4px; border-radius: 10px;">
            <button id="view-kanban-btn" onclick="setWorkLogView('kanban')" style="background: ${colors.blue}; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“‹ ì¹¸ë°˜</button>
            <button id="view-calendar-btn" onclick="setWorkLogView('calendar')" style="background: transparent; color: ${colors.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“… ìº˜ë¦°ë”</button>
            <button id="view-timeline-btn" onclick="setWorkLogView('timeline')" style="background: transparent; color: ${colors.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“ íƒ€ì„ë¼ì¸</button>
          </div>
        </div>
      </div>
      
      <!-- í˜„ì¬ ì‚¬ìš©ì/ì„ íƒëœ íŒ€ì› í‘œì‹œ -->
      <div id="worklog-user-card" style="background: ${colors.white}; border-radius: 16px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; align-items: center; gap: 14px;">
          <div style="width: 48px; height: 48px; background: ${colors.blueLight}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: ${colors.blue};">ğŸ‘¤</div>
          <div>
            <div style="font-size: 18px; font-weight: 700; color: ${colors.black};">${currentMember.name}</div>
            <div style="font-size: 13px; color: ${colors.gray500};" id="today-summary">ì˜¤ëŠ˜ ì™„ë£Œí•œ ì—…ë¬´: ë¡œë”©ì¤‘...</div>
          </div>
        </div>
        <button onclick="showTodayActivities()" style="background: ${colors.blue}; color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600;">
          ğŸ“Š ì˜¤ëŠ˜ í™œë™ ë³´ê¸°
        </button>
      </div>
      
      <!-- í†µê³„ ì¹´ë“œ (ì‹¬í”Œí•œ ì»¬ëŸ¬) -->
      <div id="worklog-stats" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;"></div>
      
      <!-- ì˜¤ëŠ˜ ìë™ ê¸°ë¡ -->
      <div id="auto-log-section"></div>
      
      <!-- ë£¨í‹´ ì—…ë¬´ -->
      <div id="routine-section"></div>
      
      <!-- ë©”ì¸ ì»¨í…ì¸  -->
      <div id="worklog-main-content">
        <div style="text-align: center; padding: 60px;"><div class="loading-spinner"></div></div>
      </div>
    </div>
  `;
  
  window.workLogView = 'kanban';
  window.memberFilter = 'my';
  window.selectedMemberId = null;
  loadWorkLogByMonth();
}

// íŒ€ì› ì„ íƒ í•„í„° (ë“œë¡­ë‹¤ìš´) - ë³¸ì¸ ì„ íƒ ì‹œ ë‚´ ì—…ë¬´ì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
function setMemberFilterBySelect(value) {
  var isAdmin = state.currentUser?.role === 'admin';
  var currentMember = getCurrentMember();

  if (value === 'my') {
    window.memberFilter = 'my';
    window.selectedMemberId = null;
  } else if (value === 'all') {
    if (!isAdmin) {
      showToast('íŒ€ ì „ì²´ ë³´ê¸°ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
      document.getElementById('member-filter-select').value = 'my';
      return;
    }
    window.memberFilter = 'all';
    window.selectedMemberId = null;
  } else if (value.startsWith('member_')) {
    var selectedId = value.replace('member_', '');

    // ë³¸ì¸ ì„ íƒ ì‹œ 'ë‚´ ì—…ë¬´'ì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
    var teamMembers = state.teamMembers || [];
    var selectedMember = teamMembers.find(function(m) { return m.id === selectedId; });

    if (selectedMember && (
      selectedId === currentMember.id ||
      selectedMember.name === currentMember.name ||
      selectedMember.odooId === currentMember.id
    )) {
      // ë³¸ì¸ ì„ íƒ â†’ ë‚´ ì—…ë¬´ë¡œ ì „í™˜
      window.memberFilter = 'my';
      window.selectedMemberId = null;
      document.getElementById('member-filter-select').value = 'my';
      showToast('ë‚´ ì—…ë¬´ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
      window.memberFilter = 'member';
      window.selectedMemberId = selectedId;
    }
  }

  loadWorkLogByMonth();
}

// íŒ€ì› í•„í„° ì„¤ì • (ê¸°ì¡´ í˜¸í™˜)
function setMemberFilter(filter) {
  window.memberFilter = filter;
  window.selectedMemberId = null;
  
  var select = document.getElementById('member-filter-select');
  if (select) select.value = filter;
  
  loadWorkLogByMonth();
}

// ë·° ì „í™˜
function setWorkLogView(view) {
  window.workLogView = view;
  
  ['kanban', 'calendar', 'timeline'].forEach(function(v) {
    var btn = document.getElementById('view-' + v + '-btn');
    if (btn) {
      btn.style.background = view === v ? '#0064FF' : 'transparent';
      btn.style.color = view === v ? 'white' : '#6B7684';
    }
  });
  
  loadWorkLogByMonth();
}

// ì›” ë³€ê²½
function changeWorkLogMonth(delta) {
  var input = document.getElementById('worklog-month');
  var parts = input.value.split('-');
  var year = parseInt(parts[0]);
  var month = parseInt(parts[1]) + delta;
  
  if (month > 12) { month = 1; year++; }
  if (month < 1) { month = 12; year--; }
  
  input.value = year + '-' + String(month).padStart(2, '0');
  loadWorkLogByMonth();
}

function goToCurrentMonth() {
  var now = new Date();
  document.getElementById('worklog-month').value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  loadWorkLogByMonth();
}

// ë°ì´í„° ë¡œë“œ
async function loadWorkLogByMonth() {
  try {
    var monthStr = document.getElementById('worklog-month')?.value;
    if (!monthStr) return;
    
    var parts = monthStr.split('-');
    var year = parseInt(parts[0]);
    var month = parseInt(parts[1]) - 1;
    
    var startDate = new Date(year, month, 1).toISOString().split('T')[0];
    var endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
    var today = new Date().toISOString().split('T')[0];
    var currentMember = getCurrentMember();
    
    var results = await Promise.all([
      db.collection('tasks').get(),
      db.collection('routineTasks').get(),
      db.collection('activityLogs').where('date', '==', today).get(),
      db.collection('teamMembers').get()
    ]);
    
    var allTasks = [];
    results[0].forEach(function(doc) { allTasks.push({ id: doc.id, ...doc.data() }); });
    
    var routineTasks = [];
    results[1].forEach(function(doc) { routineTasks.push({ id: doc.id, ...doc.data() }); });
    
    var todayLogs = [];
    results[2].forEach(function(doc) { todayLogs.push({ id: doc.id, ...doc.data() }); });
    
    var teamMembers = {};
    results[3].forEach(function(doc) { teamMembers[doc.id] = { id: doc.id, ...doc.data() }; });
    
    // ë³¸ì¸ ì„ íƒ ì—¬ë¶€ í™•ì¸ (íŒ€ì›ë³„ì—ì„œ ë³¸ì¸ ì„ íƒ = ë‚´ ì—…ë¬´ì™€ ë™ì¼)
    var isSelectingSelf = window.memberFilter === 'member' && window.selectedMemberId === currentMember.id;
    var effectiveFilter = isSelectingSelf ? 'my' : window.memberFilter;
    var effectiveMemberId = isSelectingSelf ? currentMember.id : window.selectedMemberId;
    
    // í•„í„°ë§ (íŒ€ì›ë³„ ì¶”ê°€) - ë¯¸ì§€ì • ì—…ë¬´ëŠ” "ë‚´ ì—…ë¬´"ì—ë§Œ í¬í•¨
    var monthTasks = allTasks.filter(function(t) {
      var inMonth = t.dueDate && t.dueDate >= startDate && t.dueDate <= endDate;
      
      if (effectiveFilter === 'my') {
        // ë‚´ ì—…ë¬´: ë‚´ê°€ ë‹´ë‹¹ìì´ê±°ë‚˜, ë‹´ë‹¹ìê°€ ì—†ëŠ” ì—…ë¬´
        return inMonth && (t.assignee === currentMember.name || t.assigneeId === currentMember.id || (!t.assignee && !t.assigneeId));
      } else if (effectiveFilter === 'member' && effectiveMemberId) {
        var selectedMember = teamMembers[effectiveMemberId];
        if (selectedMember) {
          return inMonth && (t.assignee === selectedMember.name || t.assigneeId === effectiveMemberId);
        }
      }
      // 'all' ë˜ëŠ” ê¸°íƒ€
      return inMonth;
    });
    
    // í™œë™ ë¡œê·¸ í•„í„°ë§ + ì‹œê°„ìˆœ ì •ë ¬
    var filteredTodayLogs = todayLogs.filter(function(log) {
      if (effectiveFilter === 'my') {
        return log.memberId === currentMember.id;
      } else if (effectiveFilter === 'member' && effectiveMemberId) {
        return log.memberId === effectiveMemberId;
      }
      return true; // all
    }).sort(function(a, b) {
      // ì‹œê°„ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
      var timeA = a.time || a.createdAt || '';
      var timeB = b.time || b.createdAt || '';
      return timeB.localeCompare(timeA);
    });
    
    // ì‚¬ìš©ì ì¹´ë“œ ì—…ë°ì´íŠ¸
    var displayMember = currentMember;
    var isViewingOther = effectiveFilter === 'member' && effectiveMemberId && effectiveMemberId !== currentMember.id;
    if (isViewingOther) {
      displayMember = teamMembers[effectiveMemberId] || currentMember;
    }
    
    var userCard = document.getElementById('worklog-user-card');
    if (userCard) {
      var cardBg = isViewingOther ? '#FFF7ED' : '#FFFFFF';
      var cardBorder = isViewingOther ? '2px solid #FDBA74' : 'none';
      userCard.style.background = cardBg;
      userCard.style.border = cardBorder;
      userCard.innerHTML = `
        <div style="display: flex; align-items: center; gap: 14px;">
          <div style="width: 48px; height: 48px; background: ${isViewingOther ? '#FED7AA' : '#E8F3FF'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: ${isViewingOther ? '#EA580C' : '#0064FF'};">
            ${isViewingOther ? 'ğŸ‘€' : 'ğŸ‘¤'}
          </div>
          <div>
            <div style="font-size: 18px; font-weight: 700; color: #191F28;">
              ${displayMember.name}
              ${isViewingOther ? '<span style="font-size: 12px; color: #EA580C; margin-left: 8px;">(ì—´ëŒ ì¤‘)</span>' : ''}
            </div>
            <div style="font-size: 13px; color: #6B7684;" id="today-summary">ë¡œë”©ì¤‘...</div>
          </div>
        </div>
        <button onclick="showTodayActivities()" style="background: #0064FF; color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600;">
          ğŸ“Š ì˜¤ëŠ˜ í™œë™ ë³´ê¸°
        </button>
      `;
    }
    
    // ì˜¤ëŠ˜ ì™„ë£Œ ì—…ë¬´ ìˆ˜
    var todayDone = allTasks.filter(function(t) { 
      var matchMember = true;
      if (effectiveFilter === 'my') {
        matchMember = t.assignee === currentMember.name || t.assigneeId === currentMember.id || (!t.assignee && !t.assigneeId);
      } else if (effectiveFilter === 'member' && effectiveMemberId) {
        var selectedMember = teamMembers[effectiveMemberId];
        matchMember = t.assignee === selectedMember?.name || t.assigneeId === effectiveMemberId;
      }
      return t.completedAt && t.completedAt.startsWith(today) && matchMember;
    }).length;
    
    var summaryEl = document.getElementById('today-summary');
    if (summaryEl) summaryEl.textContent = 'ì˜¤ëŠ˜ ì™„ë£Œí•œ ì—…ë¬´: ' + todayDone + 'ê±´';
    
    // í†µê³„, ë£¨í‹´, ìë™ê¸°ë¡ ë Œë”ë§
    renderWorkLogStats(monthTasks);
    renderRoutineSection(routineTasks);
    renderAutoLogSection(filteredTodayLogs, displayMember);
    
    // ë·°ì— ë”°ë¼ ë Œë”ë§
    if (window.workLogView === 'kanban') {
      renderKanbanBoard(monthTasks, teamMembers);
    } else if (window.workLogView === 'calendar') {
      renderCalendarView(monthTasks, year, month);
    } else {
      renderTimelineView(monthTasks, teamMembers);
    }
  } catch (error) {
    console.error('ì—…ë¬´ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// ìë™ ê¸°ë¡ ì„¹ì…˜ (ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—°ë™) - ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ ì¶”ê°€
function renderAutoLogSection(todayLogs, currentMember) {
  var section = document.getElementById('auto-log-section');
  if (!section) return;

  // ìë™ ê¸°ë¡ / ìˆ˜ë™ ê¸°ë¡ ë¶„ë¦¬
  var autoLogs = todayLogs.filter(function(log) { return log.source !== 'manual'; });
  var manualLogs = todayLogs.filter(function(log) { return log.source === 'manual'; });

  // ì ‘ê¸° ìƒíƒœ ìœ ì§€ (ê¸°ë³¸: ì ‘íŒ ìƒíƒœ)
  var isExpanded = window.autoLogExpanded || false;

  var html = '<div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">';

  // í—¤ë”
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
  html += '<div style="display: flex; align-items: center; gap: 10px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; color: #191F28; margin: 0;">ğŸ“ ì˜¤ëŠ˜ì˜ í™œë™ ê¸°ë¡</h3>';
  html += '<span style="font-size: 12px; color: #0064FF; background: #E8F3FF; padding: 4px 10px; border-radius: 6px; font-weight: 600;">' + todayLogs.length + 'ê±´</span>';
  html += '</div>';
  html += '<button onclick="openManualActivityModal()" style="background: #0064FF; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">+ í™œë™ ì¶”ê°€</button>';
  html += '</div>';

  // ìˆ˜ë™ ê¸°ë¡ (í•­ìƒ í‘œì‹œ)
  if (manualLogs.length > 0) {
    html += '<div style="margin-bottom: 16px;">';
    html += '<div style="font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;"><span style="color: #EA580C;">ğŸ“Œ</span> ì§ì ‘ ê¸°ë¡í•œ í™œë™</div>';
    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
    manualLogs.forEach(function(log) {
      html += '<div onclick="openActivityDetailModal(\'' + (log.id || '') + '\')" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #FFF7ED; border: 1px solid #FDBA74; border-radius: 10px; cursor: pointer; transition: all 0.15s;" onmouseover="this.style.background=\'#FFEDD5\'" onmouseout="this.style.background=\'#FFF7ED\'">';
      html += '<span style="font-size: 14px; color: #EA580C;">â—</span>';
      html += '<span style="font-size: 13px; color: #191F28; font-weight: 500;">' + log.action + '</span>';
      if (log.taskTitle) html += '<span style="font-size: 10px; padding: 2px 6px; background: #E0E7FF; color: #4338CA; border-radius: 4px;">ğŸ“Œ ' + log.taskTitle + '</span>';
      if (log.memberName && currentMember.name !== log.memberName) html += '<span style="font-size: 10px; padding: 2px 6px; background: #E8F3FF; color: #0064FF; border-radius: 4px;">ğŸ‘¤ ' + log.memberName + '</span>';
      html += '<span style="font-size: 11px; color: #8B95A1;">' + (log.time || '') + '</span>';
      html += '</div>';
    });
    html += '</div></div>';
  }

  // ìë™ ê¸°ë¡ (ì ‘ê¸°/í¼ì¹˜ê¸°)
  if (autoLogs.length > 0) {
    html += '<div style="border-top: 1px solid #E5E8EB; padding-top: 16px;">';
    html += '<div onclick="toggleAutoLogSection()" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 10px 0;">';
    html += '<div style="display: flex; align-items: center; gap: 8px;">';
    html += '<span style="font-size: 13px; font-weight: 600; color: #6B7684;">ğŸ”„ ìë™ ê¸°ë¡ëœ í™œë™</span>';
    html += '<span style="font-size: 12px; color: #8B95A1; background: #F2F4F6; padding: 3px 8px; border-radius: 4px;">' + autoLogs.length + 'ê±´</span>';
    html += '</div>';
    html += '<span style="font-size: 16px; color: #6B7684; transition: transform 0.2s; transform: rotate(' + (isExpanded ? '180' : '0') + 'deg);">â–¼</span>';
    html += '</div>';

    html += '<div id="auto-log-content" style="display: ' + (isExpanded ? 'flex' : 'none') + '; flex-wrap: wrap; gap: 10px; margin-top: 12px;">';
    autoLogs.forEach(function(log) {
      html += '<div onclick="event.stopPropagation(); openActivityDetailModal(\'' + (log.id || '') + '\')" style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: #F2F4F6; border-radius: 10px; cursor: pointer; transition: all 0.15s;" onmouseover="this.style.background=\'#E8F3FF\'" onmouseout="this.style.background=\'#F2F4F6\'">';
      html += '<span style="font-size: 13px; color: #00C471;">âœ“</span>';
      html += '<span style="font-size: 12px; color: #333D4B;">' + log.action + '</span>';
      if (log.taskTitle) html += '<span style="font-size: 10px; padding: 2px 6px; background: #E0E7FF; color: #4338CA; border-radius: 4px;">ğŸ“Œ ' + log.taskTitle + '</span>';
      if (log.dealTitle) html += '<span style="font-size: 10px; padding: 2px 6px; background: white; color: #6B7684; border-radius: 4px;">' + log.dealTitle + '</span>';
      if (log.memberName && currentMember.name !== log.memberName) html += '<span style="font-size: 10px; padding: 2px 6px; background: #E8F3FF; color: #0064FF; border-radius: 4px;">ğŸ‘¤ ' + log.memberName + '</span>';
      html += '<span style="font-size: 10px; color: #8B95A1;">' + (log.time || '') + '</span>';
      html += '</div>';
    });
    html += '</div></div>';
  }

  // í™œë™ì´ ì—†ì„ ë•Œ
  if (todayLogs.length === 0) {
    html += '<div style="text-align: center; padding: 30px; color: #6B7684; background: #F2F4F6; border-radius: 10px;">ì˜¤ëŠ˜ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</div>';
  }

  html += '</div>';
  section.innerHTML = html;
}

// ìë™ ê¸°ë¡ ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€
function toggleAutoLogSection() {
  window.autoLogExpanded = !window.autoLogExpanded;
  var content = document.getElementById('auto-log-content');
  if (content) {
    content.style.display = window.autoLogExpanded ? 'flex' : 'none';
  }
  loadWorkLogByMonth();
}

// ìˆ˜ë™ í™œë™ ì¶”ê°€ ëª¨ë‹¬
async function openManualActivityModal() {
  var currentMember = getCurrentMember();
  var modal = document.getElementById('modal');
  modal.className = 'modal active';

  // ì—…ë¬´ ëª©ë¡ ë¡œë“œ
  var tasks = [];
  try {
    var tasksSnapshot = await db.collection('tasks').get();
    tasksSnapshot.forEach(function(doc) {
      var task = { id: doc.id, ...doc.data() };
      if (task.status !== 'done') {
        tasks.push(task);
      }
    });
    tasks.sort(function(a, b) {
      return (b.createdAt || '').localeCompare(a.createdAt || '');
    });
  } catch (error) {
    console.error('ì—…ë¬´ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
  }

  // ì¶”ì²œ ì—…ë¬´: ë‚´ ì—…ë¬´ ì¤‘ ì§„í–‰ì¤‘ì¸ ê²ƒ ìš°ì„ 
  var myTasks = tasks.filter(function(t) {
    return t.assigneeId === currentMember.id || t.assignee === currentMember.name;
  });
  var recommendedTasks = myTasks.filter(function(t) { return t.status === 'in_progress'; }).slice(0, 3);
  if (recommendedTasks.length < 3) {
    var pending = myTasks.filter(function(t) { return t.status !== 'in_progress'; }).slice(0, 3 - recommendedTasks.length);
    recommendedTasks = recommendedTasks.concat(pending);
  }

  // ì¶”ì²œ ê³µêµ¬: ìµœê·¼ ê³µêµ¬
  var deals = state.deals || [];
  var recommendedDeals = deals.slice(0, 3);

  modal.innerHTML = `
    <div class="modal-content" style="max-width: 520px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="font-size: 20px; font-weight: 700;">ğŸ“ í™œë™ ìˆ˜ë™ ì¶”ê°€</h2>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button>
      </div>

      <div style="margin-bottom: 16px;">
        <label style="font-size: 14px; font-weight: 600; color: #333D4B; display: block; margin-bottom: 8px;">í™œë™ ë‚´ìš© *</label>
        <input type="text" id="manual-activity-action" placeholder="ì˜ˆ: ì…€ëŸ¬ ë¯¸íŒ… ì™„ë£Œ" style="width: 100%; padding: 14px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;" />
      </div>

      <!-- ê´€ë ¨ ì—…ë¬´ (ê²€ìƒ‰ + ì¶”ì²œ) -->
      <div style="margin-bottom: 16px;">
        <label style="font-size: 14px; font-weight: 600; color: #333D4B; display: block; margin-bottom: 8px;">ê´€ë ¨ ì—…ë¬´ (ì„ íƒ)</label>
        <div style="position: relative;">
          <input type="text" id="task-search-input" placeholder="ğŸ” ì—…ë¬´ ê²€ìƒ‰..."
            style="width: 100%; padding: 14px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;"
            oninput="filterTaskList(this.value)" onfocus="showTaskDropdown()" />
          <input type="hidden" id="manual-activity-task" value="" />
          <div id="selected-task-badge" style="display: none; margin-top: 8px;"></div>
          <div id="task-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #E5E8EB; border-radius: 10px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 4px;"></div>
        </div>
        ${recommendedTasks.length > 0 ? `
        <div style="margin-top: 10px;">
          <span style="font-size: 12px; color: #6B7684;">âš¡ ì¶”ì²œ:</span>
          <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
            ${recommendedTasks.map(t => `
              <button type="button" onclick="selectTask('${t.id}', '${(t.title || '').replace(/'/g, "\\'")}', '${(t.category || '').replace(/'/g, "\\'")}')"
                style="background: #F0F9FF; border: 1px solid #BAE6FD; color: #0369A1; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.15s;"
                onmouseover="this.style.background='#E0F2FE'" onmouseout="this.style.background='#F0F9FF'">
                ğŸ“Œ ${(t.title || '').length > 15 ? (t.title || '').substring(0, 15) + '...' : (t.title || '')}
              </button>
            `).join('')}
          </div>
        </div>
        ` : ''}
      </div>

      <!-- ê´€ë ¨ ê³µêµ¬ (ê²€ìƒ‰ + ì¶”ì²œ) -->
      <div style="margin-bottom: 16px;">
        <label style="font-size: 14px; font-weight: 600; color: #333D4B; display: block; margin-bottom: 8px;">ê´€ë ¨ ê³µêµ¬ (ì„ íƒ)</label>
        <div style="position: relative;">
          <input type="text" id="deal-search-input" placeholder="ğŸ” ê³µêµ¬ ê²€ìƒ‰..."
            style="width: 100%; padding: 14px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;"
            oninput="filterDealList(this.value)" onfocus="showDealDropdown()" />
          <input type="hidden" id="manual-activity-deal" value="" />
          <div id="selected-deal-badge" style="display: none; margin-top: 8px;"></div>
          <div id="deal-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #E5E8EB; border-radius: 10px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 4px;"></div>
        </div>
        ${recommendedDeals.length > 0 ? `
        <div style="margin-top: 10px;">
          <span style="font-size: 12px; color: #6B7684;">âš¡ ìµœê·¼:</span>
          <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
            ${recommendedDeals.map(d => `
              <button type="button" onclick="selectDeal('${d.id}', '${(d.title || '').replace(/'/g, "\\'")}')"
                style="background: #FFF7ED; border: 1px solid #FDBA74; color: #C2410C; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.15s;"
                onmouseover="this.style.background='#FFEDD5'" onmouseout="this.style.background='#FFF7ED'">
                ğŸ›’ ${(d.title || '').length > 15 ? (d.title || '').substring(0, 15) + '...' : (d.title || '')}
              </button>
            `).join('')}
          </div>
        </div>
        ` : ''}
      </div>

      <div style="margin-bottom: 24px;">
        <label style="font-size: 14px; font-weight: 600; color: #333D4B; display: block; margin-bottom: 8px;">ë©”ëª¨</label>
        <textarea id="manual-activity-memo" placeholder="ì¶”ê°€ ì„¤ëª… (ì„ íƒ)" style="width: 100%; padding: 14px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px; min-height: 80px; resize: vertical;"></textarea>
      </div>

      <button onclick="saveManualActivity()" style="width: 100%; background: #0064FF; color: white; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
        ì €ì¥í•˜ê¸°
      </button>
    </div>
  `;

  // ì „ì—­ì— ì €ì¥
  window._manualActivityTasks = tasks;
  window._manualActivityDeals = deals;

  // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  setTimeout(function() {
    document.addEventListener('click', handleActivityDropdownClose);
  }, 100);
}

// ì—…ë¬´ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
function showTaskDropdown() {
  var dropdown = document.getElementById('task-dropdown');
  if (dropdown) {
    filterTaskList('');
    dropdown.style.display = 'block';
  }
}

// ì—…ë¬´ í•„í„°ë§
function filterTaskList(query) {
  var dropdown = document.getElementById('task-dropdown');
  if (!dropdown) return;
  var tasks = window._manualActivityTasks || [];
  var filtered = tasks.filter(function(t) {
    var searchStr = ((t.title || '') + ' ' + (t.category || '')).toLowerCase();
    return searchStr.includes(query.toLowerCase());
  }).slice(0, 20);

  if (filtered.length === 0) {
    dropdown.innerHTML = '<div style="padding: 14px; color: #6B7684; text-align: center; font-size: 13px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    dropdown.innerHTML = filtered.map(function(t) {
      return '<div onclick="selectTask(\'' + t.id + '\', \'' + (t.title || '').replace(/'/g, "\\'") + '\', \'' + (t.category || '').replace(/'/g, "\\'") + '\')" style="padding: 12px 14px; cursor: pointer; border-bottom: 1px solid #F2F4F6; font-size: 14px;" onmouseover="this.style.background=\'#F8FAFC\'" onmouseout="this.style.background=\'white\'">' +
        '<div style="font-weight: 500; color: #191F28;">' + (t.title || '') + '</div>' +
        (t.category ? '<div style="font-size: 12px; color: #6B7684; margin-top: 2px;">' + t.category + '</div>' : '') +
      '</div>';
    }).join('');
  }
  dropdown.style.display = 'block';
}

// ì—…ë¬´ ì„ íƒ
function selectTask(id, title, category) {
  document.getElementById('manual-activity-task').value = id;
  document.getElementById('task-search-input').value = '';
  document.getElementById('task-dropdown').style.display = 'none';

  var badge = document.getElementById('selected-task-badge');
  badge.style.display = 'block';
  badge.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 6px; background: #E0E7FF; color: #4338CA; padding: 8px 12px; border-radius: 8px; font-size: 13px;">' +
    'ğŸ“Œ ' + title + (category ? ' [' + category + ']' : '') +
    '<button type="button" onclick="clearTaskSelection()" style="background: none; border: none; color: #4338CA; cursor: pointer; font-size: 16px; padding: 0; margin-left: 4px;">Ã—</button>' +
  '</span>';
}

// ì—…ë¬´ ì„ íƒ í•´ì œ
function clearTaskSelection() {
  document.getElementById('manual-activity-task').value = '';
  document.getElementById('selected-task-badge').style.display = 'none';
  document.getElementById('selected-task-badge').innerHTML = '';
}

// ê³µêµ¬ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
function showDealDropdown() {
  var dropdown = document.getElementById('deal-dropdown');
  if (dropdown) {
    filterDealList('');
    dropdown.style.display = 'block';
  }
}

// ê³µêµ¬ í•„í„°ë§
function filterDealList(query) {
  var dropdown = document.getElementById('deal-dropdown');
  if (!dropdown) return;
  var deals = window._manualActivityDeals || [];
  var filtered = deals.filter(function(d) {
    return (d.title || '').toLowerCase().includes(query.toLowerCase());
  }).slice(0, 20);

  if (filtered.length === 0) {
    dropdown.innerHTML = '<div style="padding: 14px; color: #6B7684; text-align: center; font-size: 13px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    dropdown.innerHTML = filtered.map(function(d) {
      return '<div onclick="selectDeal(\'' + d.id + '\', \'' + (d.title || '').replace(/'/g, "\\'") + '\')" style="padding: 12px 14px; cursor: pointer; border-bottom: 1px solid #F2F4F6; font-size: 14px;" onmouseover="this.style.background=\'#F8FAFC\'" onmouseout="this.style.background=\'white\'">' +
        '<div style="font-weight: 500; color: #191F28;">ğŸ›’ ' + (d.title || '') + '</div>' +
      '</div>';
    }).join('');
  }
  dropdown.style.display = 'block';
}

// ê³µêµ¬ ì„ íƒ
function selectDeal(id, title) {
  document.getElementById('manual-activity-deal').value = id;
  document.getElementById('deal-search-input').value = '';
  document.getElementById('deal-dropdown').style.display = 'none';

  var badge = document.getElementById('selected-deal-badge');
  badge.style.display = 'block';
  badge.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 6px; background: #FFF7ED; color: #C2410C; padding: 8px 12px; border-radius: 8px; font-size: 13px;">' +
    'ğŸ›’ ' + title +
    '<button type="button" onclick="clearDealSelection()" style="background: none; border: none; color: #C2410C; cursor: pointer; font-size: 16px; padding: 0; margin-left: 4px;">Ã—</button>' +
  '</span>';
}

// ê³µêµ¬ ì„ íƒ í•´ì œ
function clearDealSelection() {
  document.getElementById('manual-activity-deal').value = '';
  document.getElementById('selected-deal-badge').style.display = 'none';
  document.getElementById('selected-deal-badge').innerHTML = '';
}

// ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
function handleActivityDropdownClose(e) {
  var taskDropdown = document.getElementById('task-dropdown');
  var dealDropdown = document.getElementById('deal-dropdown');
  if (taskDropdown && !e.target.closest('#task-search-input') && !e.target.closest('#task-dropdown')) {
    taskDropdown.style.display = 'none';
  }
  if (dealDropdown && !e.target.closest('#deal-search-input') && !e.target.closest('#deal-dropdown')) {
    dealDropdown.style.display = 'none';
  }
}

// ìˆ˜ë™ í™œë™ ì €ì¥
async function saveManualActivity() {
  var action = document.getElementById('manual-activity-action').value.trim();
  var taskId = document.getElementById('manual-activity-task').value;
  var dealId = document.getElementById('manual-activity-deal').value;
  var memo = document.getElementById('manual-activity-memo').value.trim();

  if (!action) {
    showToast('í™œë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }

  var currentMember = getCurrentMember();
  var deal = dealId ? state.deals.find(d => d.id === dealId) : null;
  var task = taskId ? (window._manualActivityTasks || []).find(t => t.id === taskId) : null;
  var now = new Date();

  try {
    await db.collection('activityLogs').add({
      action: action,
      taskId: taskId || null,
      taskTitle: task ? task.title : null,
      taskCategory: task ? task.category : null,
      dealId: dealId || null,
      dealTitle: deal ? deal.title : null,
      memo: memo,
      memberId: currentMember.id,
      memberName: currentMember.name,
      source: 'manual',
      date: now.toISOString().split('T')[0],
      time: now.toTimeString().slice(0, 5),
      createdAt: now.toISOString(),
      createdBy: currentMember.id,
      createdByName: currentMember.name
    });

    showToast('âœ… í™œë™ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    loadWorkLogByMonth();
  } catch (error) {
    console.error('í™œë™ ì €ì¥ ì˜¤ë¥˜:', error);
    showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// í™œë™ ìƒì„¸ ë³´ê¸°/ìˆ˜ì • ëª¨ë‹¬
async function openActivityDetailModal(logId) {
  if (!logId) return;
  
  try {
    var doc = await db.collection('activityLogs').doc(logId).get();
    if (!doc.exists) {
      showToast('í™œë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    var log = { id: doc.id, ...doc.data() };
    var currentMember = getCurrentMember();
    var isAdmin = state.currentUser?.role === 'admin';
    var canEdit = isAdmin || log.memberId === currentMember.id;
    
    var modal = document.getElementById('modal');
    modal.className = 'modal active';
    
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="font-size: 20px; font-weight: 700;">ğŸ“‹ í™œë™ ìƒì„¸</h2>
          <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button>
        </div>
        
        <div style="background: #F2F4F6; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 12px;">${log.action}</div>
          ${log.taskTitle ? `<div style="font-size: 14px; color: #6B7684; margin-bottom: 8px;">ğŸ“Œ ê´€ë ¨ ì—…ë¬´: ${log.taskTitle}${log.taskCategory ? ' [' + log.taskCategory + ']' : ''}</div>` : ''}
          ${log.dealTitle ? `<div style="font-size: 14px; color: #6B7684; margin-bottom: 8px;">ğŸ›’ ê´€ë ¨ ê³µêµ¬: ${log.dealTitle}</div>` : ''}
          ${log.memo ? `<div style="font-size: 14px; color: #6B7684; margin-bottom: 8px;">ğŸ“ ë©”ëª¨: ${log.memo}</div>` : ''}
          <div style="font-size: 13px; color: #8B95A1; margin-top: 12px;">
            ğŸ‘¤ ${log.memberName || 'ì•Œ ìˆ˜ ì—†ìŒ'} Â· ${log.date} ${log.time || ''}
          </div>
          ${log.source === 'manual' ? '<div style="display: inline-block; font-size: 11px; padding: 4px 10px; background: #FFF7ED; color: #EA580C; border-radius: 6px; margin-top: 8px;">ìˆ˜ë™ ì…ë ¥</div>' : '<div style="display: inline-block; font-size: 11px; padding: 4px 10px; background: #DCFCE7; color: #16A34A; border-radius: 6px; margin-top: 8px;">ìë™ ê¸°ë¡</div>'}
        </div>
        
        <!-- ë³€ê²½ ì´ë ¥ -->
        ${log.editHistory && log.editHistory.length > 0 ? `
          <div style="margin-bottom: 20px;">
            <div style="font-size: 14px; font-weight: 600; color: #333D4B; margin-bottom: 10px;">ğŸ“œ ë³€ê²½ ì´ë ¥</div>
            <div style="background: #FAFAFA; border-radius: 10px; padding: 12px; max-height: 150px; overflow-y: auto;">
              ${log.editHistory.map(h => `
                <div style="font-size: 12px; color: #6B7684; padding: 6px 0; border-bottom: 1px solid #E5E8EB;">
                  ${h.editedByName}ë‹˜ì´ ${h.editedAt?.slice(0, 16).replace('T', ' ')}ì— ìˆ˜ì •
                  ${h.changes ? ` (${h.changes})` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${canEdit ? `
          <div style="display: flex; gap: 10px;">
            <button onclick="editActivityLog('${log.id}')" style="flex: 1; background: #0064FF; color: white; border: none; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer;">
              âœï¸ ìˆ˜ì •í•˜ê¸°
            </button>
            <button onclick="deleteActivityLog('${log.id}')" style="flex: 1; background: #F2F4F6; color: #EF4444; border: none; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer;">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </div>
        ` : '<div style="text-align: center; padding: 12px; background: #F2F4F6; border-radius: 10px; color: #6B7684; font-size: 13px;">ë³´ê¸° ê¶Œí•œë§Œ ìˆìŠµë‹ˆë‹¤</div>'}
      </div>
    `;
  } catch (error) {
    console.error('í™œë™ ì¡°íšŒ ì˜¤ë¥˜:', error);
  }
}

// í™œë™ ìˆ˜ì •
async function editActivityLog(logId) {
  var doc = await db.collection('activityLogs').doc(logId).get();
  var log = { id: doc.id, ...doc.data() };
  
  var modal = document.getElementById('modal');
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="font-size: 20px; font-weight: 700;">âœï¸ í™œë™ ìˆ˜ì •</h2>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="font-size: 14px; font-weight: 600; color: #333D4B; display: block; margin-bottom: 8px;">í™œë™ ë‚´ìš© *</label>
        <input type="text" id="edit-activity-action" value="${log.action || ''}" style="width: 100%; padding: 14px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;" />
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="font-size: 14px; font-weight: 600; color: #333D4B; display: block; margin-bottom: 8px;">ë©”ëª¨</label>
        <textarea id="edit-activity-memo" style="width: 100%; padding: 14px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px; min-height: 80px; resize: vertical;">${log.memo || ''}</textarea>
      </div>
      
      <button onclick="saveActivityEdit('${logId}')" style="width: 100%; background: #0064FF; color: white; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
        ì €ì¥í•˜ê¸°
      </button>
    </div>
  `;
}

// í™œë™ ìˆ˜ì • ì €ì¥
async function saveActivityEdit(logId) {
  var action = document.getElementById('edit-activity-action').value.trim();
  var memo = document.getElementById('edit-activity-memo').value.trim();
  
  if (!action) {
    showToast('í™œë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }
  
  var currentMember = getCurrentMember();
  var doc = await db.collection('activityLogs').doc(logId).get();
  var oldData = doc.data();
  
  var editHistory = oldData.editHistory || [];
  editHistory.push({
    editedAt: new Date().toISOString(),
    editedBy: currentMember.id,
    editedByName: currentMember.name,
    changes: oldData.action !== action ? 'ë‚´ìš© ë³€ê²½' : 'ë©”ëª¨ ë³€ê²½'
  });
  
  try {
    await db.collection('activityLogs').doc(logId).update({
      action: action,
      memo: memo,
      editHistory: editHistory,
      lastEditedAt: new Date().toISOString(),
      lastEditedBy: currentMember.id,
      lastEditedByName: currentMember.name
    });
    
    showToast('âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    loadWorkLogByMonth();
  } catch (error) {
    console.error('ìˆ˜ì • ì˜¤ë¥˜:', error);
    showToast('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// í™œë™ ì‚­ì œ
async function deleteActivityLog(logId) {
  if (!confirm('ì´ í™œë™ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('activityLogs').doc(logId).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    loadWorkLogByMonth();
  } catch (error) {
    console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
    showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// íƒ€ì„ë¼ì¸ ë·° (íŒ€ ì „ì²´ ì—…ë¬´)
function renderTimelineView(tasks, teamMembers) {
  var container = document.getElementById('worklog-main-content');
  
  // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
  var tasksByDate = {};
  tasks.forEach(function(t) {
    var date = t.dueDate || 'no-date';
    if (!tasksByDate[date]) tasksByDate[date] = [];
    tasksByDate[date].push(t);
  });
  
  var dates = Object.keys(tasksByDate).sort().reverse();
  var today = new Date().toISOString().split('T')[0];
  
  var html = '<div style="background: white; border-radius: 16px; padding: 24px;">';
  html += '<h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ“ ì—…ë¬´ íƒ€ì„ë¼ì¸</h3>';
  
  if (dates.length === 0) {
    html += '<div style="text-align: center; padding: 40px; color: var(--gray-500);">ë“±ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    html += '<div style="display: flex; flex-direction: column; gap: 24px;">';
    
    dates.forEach(function(date) {
      var isToday = date === today;
      var dateTasks = tasksByDate[date];
      var dateObj = new Date(date);
      var dateLabel = date === 'no-date' ? 'ë‚ ì§œ ë¯¸ì§€ì •' : (dateObj.getMonth() + 1) + '/' + dateObj.getDate() + ' (' + ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dateObj.getDay()] + ')';
      
      html += '<div>';
      html += '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">';
      html += '<div style="width: 12px; height: 12px; border-radius: 50%; background: ' + (isToday ? 'var(--primary)' : 'var(--gray-400)') + ';"></div>';
      html += '<div style="font-size: 16px; font-weight: 700; color: ' + (isToday ? 'var(--primary)' : 'var(--gray-700)') + ';">' + dateLabel + (isToday ? ' (ì˜¤ëŠ˜)' : '') + '</div>';
      html += '<div style="flex: 1; height: 1px; background: var(--gray-200);"></div>';
      html += '<span style="font-size: 12px; color: var(--gray-500);">' + dateTasks.length + 'ê±´</span>';
      html += '</div>';
      
      html += '<div style="margin-left: 24px; padding-left: 20px; border-left: 2px solid var(--gray-200); display: flex; flex-direction: column; gap: 8px;">';
      
      dateTasks.forEach(function(task) {
        var statusCol = TASK_COLUMNS.find(function(c) { return c.id === (STATUS_MAP[task.status] || 'waiting'); });
        var assignee = task.assignee || 'ë¯¸ì§€ì •';
        
        html += '<div onclick="openTaskDetailModal(\'' + task.id + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: 10px; cursor: pointer; transition: all 0.15s;" onmouseover="this.style.background=\'var(--gray-100)\'" onmouseout="this.style.background=\'var(--gray-50)\'">';
        html += '<span style="font-size: 12px; padding: 4px 10px; background: ' + (statusCol ? statusCol.bg : '#f3f4f6') + '; color: ' + (statusCol ? statusCol.color : '#6b7280') + '; border-radius: 6px; font-weight: 600;">' + (statusCol ? statusCol.icon + ' ' + statusCol.label : task.status) + '</span>';
        html += '<div style="flex: 1; min-width: 0;">';
        html += '<div style="font-size: 14px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + (task.bookmark ? 'â­ ' : '') + task.title + '</div>';
        if (task.category) html += '<span style="font-size: 11px; color: var(--gray-500);">ğŸ“ ' + task.category + '</span>';
        html += '</div>';
        html += '<span style="font-size: 12px; padding: 4px 10px; background: var(--primary-light); color: var(--primary); border-radius: 6px;">ğŸ‘¤ ' + assignee + '</span>';
        html += '</div>';
      });
      
      html += '</div></div>';
    });
    
    html += '</div>';
  }
  
  html += '</div>';
  container.innerHTML = html;
}

// í†µê³„ ë Œë”ë§ (ì‹¬í”Œ ë””ìì¸)
function renderWorkLogStats(tasks) {
  var total = tasks.length;
  var waiting = tasks.filter(function(t) { return t.status === 'ëŒ€ê¸°'; }).length;
  var progress = tasks.filter(function(t) { return t.status === 'ì§„í–‰ì¤‘'; }).length;
  var complete = tasks.filter(function(t) { return t.status === 'ì™„ë£Œ'; }).length;
  var completionRate = total > 0 ? Math.round((complete / total) * 100) : 0;
  
  document.getElementById('worklog-stats').innerHTML = `
    <div style="background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
      <div style="font-size: 13px; color: #6B7684; margin-bottom: 8px;">ì „ì²´</div>
      <div style="font-size: 32px; font-weight: 700; color: #191F28;">${total}</div>
    </div>
    <div style="background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
      <div style="font-size: 13px; color: #6B7684; margin-bottom: 8px;">ëŒ€ê¸°</div>
      <div style="font-size: 32px; font-weight: 700; color: #F59E0B;">${waiting}</div>
    </div>
    <div style="background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
      <div style="font-size: 13px; color: #6B7684; margin-bottom: 8px;">ì§„í–‰ì¤‘</div>
      <div style="font-size: 32px; font-weight: 700; color: #0064FF;">${progress}</div>
    </div>
    <div style="background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
      <div style="font-size: 13px; color: #6B7684; margin-bottom: 8px;">ì™„ë£Œ</div>
      <div style="font-size: 32px; font-weight: 700; color: #00C471;">${complete}</div>
    </div>
    <div style="background: #E8F3FF; border-radius: 16px; padding: 20px; text-align: center;">
      <div style="font-size: 13px; color: #0064FF; margin-bottom: 8px;">ì™„ë£Œìœ¨</div>
      <div style="font-size: 32px; font-weight: 700; color: #0064FF;">${completionRate}%</div>
    </div>
  `;
}

// ë£¨í‹´ ì„¹ì…˜ ë Œë”ë§ (ì‹¬í”Œ ë””ìì¸)
function renderRoutineSection(routineTasks) {
  var section = document.getElementById('routine-section');
  if (!section) return;
  
  var today = new Date().toISOString().split('T')[0];
  
  if (routineTasks.length === 0) {
    section.innerHTML = '';
    return;
  }
  
  var html = '<div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; color: #191F28; margin: 0;">â° ì˜¤ëŠ˜ì˜ ë£¨í‹´</h3>';
  html += '</div>';
  html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
  
  routineTasks.forEach(function(rt) {
    var isCompleted = rt.completedDates && rt.completedDates.indexOf(today) !== -1;
    var typeLabel = rt.routineType === 'daily' ? 'ë§¤ì¼' : rt.routineType === 'weekly' ? 'ë§¤ì£¼' : 'ë§¤ì›”';
    
    html += '<label style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: ' + (isCompleted ? '#E8F3FF' : '#F2F4F6') + '; border-radius: 10px; cursor: pointer; border: 1px solid ' + (isCompleted ? '#0064FF' : 'transparent') + ';">';
    html += '<input type="checkbox" ' + (isCompleted ? 'checked' : '') + ' onchange="toggleRoutineComplete(\'' + rt.id + '\', \'' + today + '\', this.checked)" style="width: 18px; height: 18px; accent-color: #0064FF;" />';
    html += '<span style="font-size: 14px; font-weight: 500; ' + (isCompleted ? 'text-decoration: line-through; color: #6B7684;' : 'color: #191F28;') + '">' + rt.title + '</span>';
    html += '<span style="font-size: 11px; padding: 3px 8px; background: white; color: #6B7684; border-radius: 4px;">' + typeLabel + '</span>';
    html += '</label>';
  });
  
  html += '</div></div>';
  section.innerHTML = html;
}

// ì¹¸ë°˜ ë³´ë“œ ë Œë”ë§
function renderKanbanBoard(tasks, teamMembers) {
  var container = document.getElementById('worklog-main-content');
  
  // ì‹¬í”Œí•œ ì»¬ëŸ¼ ì •ì˜ (STATUS_MAPê³¼ ì¼ì¹˜)
  var simpleColumns = [
    { id: 'waiting', label: 'ëŒ€ê¸°', icon: 'â³', color: '#F59E0B', bg: '#FFFBEB' },
    { id: 'progress', label: 'ì§„í–‰ì¤‘', icon: 'ğŸ”„', color: '#0064FF', bg: '#E8F3FF' },
    { id: 'complete', label: 'ì™„ë£Œ', icon: 'âœ…', color: '#00C471', bg: '#ECFDF5' },
    { id: 'hold', label: 'ë³´ë¥˜', icon: 'â¸ï¸', color: '#6B7684', bg: '#F2F4F6' }
  ];
  
  var html = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; min-height: 500px;">';
  
  simpleColumns.forEach(function(col) {
    var columnTasks = tasks.filter(function(t) {
      return (STATUS_MAP[t.status] || 'waiting') === col.id;
    }).sort(function(a, b) {
      var priorityOrder = { 'ë†’ìŒ': 0, 'ì¤‘ê°„': 1, 'ë‚®ìŒ': 2, '': 3 };
      return (priorityOrder[a.priority] || 3) - (priorityOrder[b.priority] || 3);
    });
    
    html += '<div class="kanban-column" data-status="' + col.id + '" ondragover="handleDragOver(event)" ondrop="handleDrop(event, \'' + col.id + '\')" style="background: white; border-radius: 16px; padding: 16px; min-height: 400px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ' + col.bg + ';">';
    html += '<div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">' + col.icon + '</span><span style="font-size: 15px; font-weight: 700; color: #191F28;">' + col.label + '</span></div>';
    html += '<span style="background: ' + col.bg + '; color: ' + col.color + '; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 700;">' + columnTasks.length + '</span>';
    html += '</div>';
    html += '<div class="kanban-tasks" style="display: flex; flex-direction: column; gap: 10px;">';
    
    columnTasks.forEach(function(task) {
      html += renderKanbanCard(task, teamMembers);
    });
    
    html += '</div></div>';
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// ì¹¸ë°˜ ì¹´ë“œ ë Œë”ë§ (ì‹¬í”Œ ë””ìì¸)
function renderKanbanCard(task, teamMembers) {
  var priorityStyles = { 'ë†’ìŒ': '#EF4444', 'ì¤‘ê°„': '#F59E0B', 'ë‚®ìŒ': '#0064FF' };
  var priorityColor = priorityStyles[task.priority] || '#6B7684';
  var assignee = task.assignee || 'ë¯¸ì§€ì •';
  
  var html = '<div class="kanban-card" draggable="true" ondragstart="handleDragStart(event, \'' + task.id + '\')" ondragend="handleDragEnd(event)" data-task-id="' + task.id + '" onclick="openTaskDetailModal(\'' + task.id + '\')" style="background: #F9FAFB; border-radius: 12px; padding: 14px; cursor: pointer; border: 1px solid #E5E8EB; transition: all 0.15s;" onmouseover="this.style.background=\'#F2F4F6\';this.style.borderColor=\'#0064FF\'" onmouseout="this.style.background=\'#F9FAFB\';this.style.borderColor=\'#E5E8EB\'">';
  
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">';
  html += '<div style="font-size: 14px; font-weight: 600; color: #191F28; line-height: 1.4; flex: 1;">' + (task.bookmark ? 'â­ ' : '') + task.title + '</div>';
  if (task.priority) html += '<span style="width: 8px; height: 8px; border-radius: 50%; background: ' + priorityColor + '; flex-shrink: 0; margin-left: 8px; margin-top: 4px;"></span>';
  html += '</div>';
  
  html += '<div style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 12px;">';
  html += '<span style="padding: 4px 8px; background: #E8F3FF; border-radius: 6px; color: #0064FF;">ğŸ‘¤ ' + assignee + '</span>';
  if (task.dueDate) html += '<span style="padding: 4px 8px; background: #F2F4F6; border-radius: 6px; color: #6B7684;">ğŸ“… ' + task.dueDate.substring(5) + '</span>';
  if (task.category) html += '<span style="padding: 4px 8px; background: #F2F4F6; border-radius: 6px; color: #6B7684;">ğŸ“ ' + task.category + '</span>';
  html += '</div></div>';
  
  return html;
}

// ë“œë˜ê·¸ì•¤ë“œë¡­ í•¸ë“¤ëŸ¬
var draggedTaskId = null;

function handleDragStart(e, taskId) {
  draggedTaskId = taskId;
  e.target.style.opacity = '0.5';
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
  e.target.style.opacity = '1';
  draggedTaskId = null;
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

async function handleDrop(e, newStatus) {
  e.preventDefault();
  if (!draggedTaskId) return;
  
  try {
    // í˜„ì¬ ìƒíƒœ í™•ì¸
    var taskDoc = await db.collection('tasks').doc(draggedTaskId).get();
    var currentTask = taskDoc.data();
    var oldStatus = currentTask?.status || 'ëŒ€ê¸°';
    
    var newStatusKr = REVERSE_STATUS_MAP[newStatus];
    var updateData = { status: newStatusKr, updatedAt: new Date().toISOString() };
    
    // ì™„ë£Œ ì‹œ completedAt ê¸°ë¡
    if (newStatus === 'complete') {
      updateData.completedAt = new Date().toISOString();
    }
    
    await db.collection('tasks').doc(draggedTaskId).update(updateData);
    
    // ëª¨ë“  ìƒíƒœ ë³€ê²½ ì‹œ í™œë™ ë¡œê·¸ ê¸°ë¡
    if (oldStatus !== newStatusKr) {
      var actionText = 'ì—…ë¬´ ìƒíƒœ ë³€ê²½: ' + oldStatus + ' â†’ ' + newStatusKr;
      if (newStatus === 'complete') actionText = 'âœ… ì—…ë¬´ ì™„ë£Œ: ' + (currentTask?.title || '');
      else if (newStatus === 'progress') actionText = 'ğŸ”„ ì—…ë¬´ ì‹œì‘: ' + (currentTask?.title || '');
      else if (newStatus === 'hold') actionText = 'â¸ï¸ ì—…ë¬´ ë³´ë¥˜: ' + (currentTask?.title || '');
      else if (newStatus === 'waiting') actionText = 'â³ ì—…ë¬´ ëŒ€ê¸°: ' + (currentTask?.title || '');
      
      await logActivity(actionText, draggedTaskId);
    }
    
    showToast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
    loadWorkLogByMonth();
  } catch (error) {
    console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
  }
}

// í™œë™ ê¸°ë¡ í•¨ìˆ˜
async function logActivity(action, taskId, dealId, dealTitle) {
  try {
    var today = new Date();
    var currentMember = getCurrentMember();
    
    await db.collection('activityLogs').add({
      action: action,
      taskId: taskId || null,
      dealId: dealId || null,
      dealTitle: dealTitle || null,
      memberId: currentMember.id,
      memberName: currentMember.name,
      date: today.toISOString().split('T')[0],
      time: today.toTimeString().substring(0, 5),
      createdAt: today.toISOString()
    });
  } catch (error) {
    console.error('í™œë™ ê¸°ë¡ ì˜¤ë¥˜:', error);
  }
}

// ì˜¤ëŠ˜ í™œë™ ë³´ê¸° ëª¨ë‹¬ - í™œë™ì í‘œì‹œ ë° ì‹œê°„ìˆœ ì •ë ¬
async function showTodayActivities() {
  try {
    var today = new Date().toISOString().split('T')[0];
    var currentMember = getCurrentMember();
    var isAdmin = state.currentUser?.role === 'admin';
    var viewingMemberId = window.selectedMemberId || currentMember.id;
    var viewingAll = window.memberFilter === 'all';

    var results = await Promise.all([
      db.collection('activityLogs').where('date', '==', today).get(),
      db.collection('tasks').where('completedAt', '>=', today + 'T00:00:00').get(),
      db.collection('teamMembers').get()
    ]);

    var allLogs = [];
    results[0].forEach(function(doc) { allLogs.push({ id: doc.id, ...doc.data() }); });

    var allCompletedTasks = [];
    results[1].forEach(function(doc) { allCompletedTasks.push({ id: doc.id, ...doc.data() }); });

    var teamMembers = {};
    results[2].forEach(function(doc) { teamMembers[doc.id] = { id: doc.id, ...doc.data() }; });

    // ì‹œê°„ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
    allLogs.sort(function(a, b) {
      var timeA = a.time || a.createdAt || '';
      var timeB = b.time || b.createdAt || '';
      return timeB.localeCompare(timeA);
    });

    // íŒ€ì›ë³„ ê·¸ë£¹í™”
    var logsByMember = {};
    var tasksByMember = {};

    allLogs.forEach(function(log) {
      var mid = log.memberId || 'unknown';
      if (!logsByMember[mid]) logsByMember[mid] = [];
      logsByMember[mid].push(log);
    });

    allCompletedTasks.forEach(function(t) {
      var mid = t.assigneeId || 'unknown';
      if (!tasksByMember[mid]) tasksByMember[mid] = [];
      tasksByMember[mid].push(t);
    });

    var modal = document.getElementById('modal');
    modal.className = 'modal active';

    var html = '<div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
    html += '<h2 style="font-size: 20px; font-weight: 700; margin: 0;">ğŸ“Š ì˜¤ëŠ˜ì˜ í™œë™ <span style="font-size: 14px; color: #6B7684;">(' + today + ')</span></h2>';
    html += '<button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button>';
    html += '</div>';

    // ì „ì²´ í†µê³„
    html += '<div style="background: linear-gradient(135deg, #0064FF, #3B82F6); border-radius: 16px; padding: 24px; margin-bottom: 20px; color: white;">';
    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">';
    html += '<div><div style="font-size: 36px; font-weight: 700;">' + Object.keys(logsByMember).length + '</div><div style="font-size: 13px; opacity: 0.9;">í™œë™í•œ íŒ€ì›</div></div>';
    html += '<div><div style="font-size: 36px; font-weight: 700;">' + allCompletedTasks.length + '</div><div style="font-size: 13px; opacity: 0.9;">ì™„ë£Œí•œ ì—…ë¬´</div></div>';
    html += '<div><div style="font-size: 36px; font-weight: 700;">' + allLogs.length + '</div><div style="font-size: 13px; opacity: 0.9;">ì „ì²´ í™œë™</div></div>';
    html += '</div></div>';

    // íŒ€ì›ë³„ í™œë™ í‘œì‹œ
    var memberIds = Object.keys(logsByMember);
    if (memberIds.length === 0 && Object.keys(tasksByMember).length === 0) {
      html += '<div style="text-align: center; padding: 40px; color: #6B7684; background: #F2F4F6; border-radius: 12px;">ì˜¤ëŠ˜ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
      // í™œë™ì´ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬
      memberIds.sort(function(a, b) {
        return (logsByMember[b]?.length || 0) - (logsByMember[a]?.length || 0);
      });

      memberIds.forEach(function(memberId) {
        var member = teamMembers[memberId] || { name: 'ì•Œ ìˆ˜ ì—†ìŒ' };
        var memberLogs = logsByMember[memberId] || [];
        var memberTasks = tasksByMember[memberId] || [];

        html += '<div style="background: #FFFFFF; border: 1px solid #E5E8EB; border-radius: 12px; padding: 16px; margin-bottom: 12px;">';

        // íŒ€ì› í—¤ë”
        html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #E5E8EB;">';
        html += '<div style="display: flex; align-items: center; gap: 10px;">';
        html += '<div style="width: 36px; height: 36px; background: #E8F3FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px;">ğŸ‘¤</div>';
        html += '<div>';
        html += '<div style="font-size: 15px; font-weight: 700; color: #191F28;">' + member.name + '</div>';
        html += '<div style="font-size: 12px; color: #6B7684;">í™œë™ ' + memberLogs.length + 'ê±´ Â· ì™„ë£Œ ' + memberTasks.length + 'ê±´</div>';
        html += '</div></div>';
        html += '<div style="display: flex; gap: 6px;">';
        html += '<span style="font-size: 11px; padding: 4px 10px; background: #DCFCE7; color: #16A34A; border-radius: 6px; font-weight: 600;">' + memberTasks.length + ' ì™„ë£Œ</span>';
        html += '<span style="font-size: 11px; padding: 4px 10px; background: #E8F3FF; color: #0064FF; border-radius: 6px; font-weight: 600;">' + memberLogs.length + ' í™œë™</span>';
        html += '</div></div>';

        // í™œë™ ëª©ë¡ (ìµœê·¼ 5ê°œë§Œ)
        html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
        memberLogs.slice(0, 5).forEach(function(log) {
          var isManual = log.source === 'manual';
          html += '<div style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: ' + (isManual ? '#FFF7ED' : '#F2F4F6') + '; border-radius: 8px; font-size: 12px;">';
          html += '<span style="color: ' + (isManual ? '#EA580C' : '#00C471') + ';">' + (isManual ? 'ğŸ“Œ' : 'âœ“') + '</span>';
          html += '<span style="color: #333D4B;">' + log.action + '</span>';
          html += '<span style="color: #8B95A1; font-size: 11px;">' + (log.time || '') + '</span>';
          html += '</div>';
        });
        if (memberLogs.length > 5) {
          html += '<div style="padding: 8px 12px; background: #E5E8EB; border-radius: 8px; font-size: 11px; color: #6B7684;">+' + (memberLogs.length - 5) + 'ê°œ ë”</div>';
        }
        html += '</div></div>';
      });
    }

    html += '<button onclick="closeModal()" style="width: 100%; margin-top: 20px; background: #0064FF; color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px;">ë‹«ê¸°</button>';
    html += '</div>';

    modal.innerHTML = html;
  } catch (error) {
    console.error('í™œë™ ë³´ê¸° ì˜¤ë¥˜:', error);
  }
}

// ìº˜ë¦°ë” ë·° ë Œë”ë§
function renderCalendarView(tasks, year, month) {
  var container = document.getElementById('worklog-main-content');
  
  var firstDay = new Date(year, month, 1);
  var lastDay = new Date(year, month + 1, 0);
  var startPadding = (firstDay.getDay() + 6) % 7;
  var today = new Date().toISOString().split('T')[0];
  
  var html = '<div style="background: white; border-radius: 16px; padding: 20px;">';
  html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">';
  ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'].forEach(function(day, idx) {
    var color = idx === 5 ? '#3b82f6' : idx === 6 ? '#ef4444' : '#6b7280';
    html += '<div style="text-align: center; font-size: 13px; font-weight: 600; color: ' + color + '; padding: 8px;">' + day + '</div>';
  });
  html += '</div><div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">';
  
  for (var i = 0; i < startPadding; i++) {
    html += '<div style="min-height: 100px; background: #f9fafb; border-radius: 8px; padding: 8px; opacity: 0.5;"></div>';
  }
  
  for (var d = 1; d <= lastDay.getDate(); d++) {
    var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    var dayOfWeek = new Date(year, month, d).getDay();
    var isToday = dateStr === today;
    var isSat = dayOfWeek === 6;
    var isSun = dayOfWeek === 0;
    var dayTasks = tasks.filter(function(t) { return t.dueDate === dateStr; });
    
    html += '<div onclick="openDayTasksModal(\'' + dateStr + '\')" style="min-height: 100px; background: ' + (isToday ? '#eff6ff' : 'white') + '; border: ' + (isToday ? '2px solid #3b82f6' : '1px solid #e5e7eb') + '; border-radius: 8px; padding: 8px; cursor: pointer;">';
    html += '<div style="font-size: 14px; font-weight: ' + (isToday ? '700' : '500') + '; color: ' + (isSun ? '#ef4444' : isSat ? '#3b82f6' : '#1f2937') + '; margin-bottom: 6px;">' + d + '</div>';
    
    dayTasks.slice(0, 3).forEach(function(t) {
      var statusCol = TASK_COLUMNS.find(function(c) { return c.id === (STATUS_MAP[t.status] || 'waiting'); });
      html += '<div style="font-size: 11px; padding: 3px 6px; background: ' + (statusCol ? statusCol.bg : '#f3f4f6') + '; color: ' + (statusCol ? statusCol.color : '#6b7280') + '; border-radius: 4px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + t.title + '</div>';
    });
    
    if (dayTasks.length > 3) html += '<div style="font-size: 11px; color: #6b7280; text-align: center;">+' + (dayTasks.length - 3) + 'ê°œ</div>';
    html += '</div>';
  }
  
  html += '</div></div>';
  container.innerHTML = html;
}

// ë·° ì „í™˜
function setWorkLogView(view) {
  window.workLogView = view;
  
  document.getElementById('view-kanban-btn').style.background = view === 'kanban' ? 'var(--primary)' : 'var(--gray-100)';
  document.getElementById('view-kanban-btn').style.color = view === 'kanban' ? 'white' : 'var(--gray-700)';
  document.getElementById('view-calendar-btn').style.background = view === 'calendar' ? 'var(--primary)' : 'var(--gray-100)';
  document.getElementById('view-calendar-btn').style.color = view === 'calendar' ? 'white' : 'var(--gray-700)';
  
  var month = document.getElementById('worklog-month').value;
  loadWorkLogByMonth(month);
}

// íŠ¹ì • ë‚ ì§œ ì—…ë¬´ ëª¨ë‹¬
async function openDayTasksModal(dateStr) {
  try {
    var snapshot = await db.collection('tasks').where('dueDate', '==', dateStr).get();
    var tasks = [];
    snapshot.forEach(function(doc) { tasks.push({ id: doc.id, ...doc.data() }); });
    
    var modal = document.getElementById('modal');
    modal.className = 'modal active';
    
    var html = '<div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
    html += '<h2 style="font-size: 18px; font-weight: 700;">ğŸ“… ' + dateStr + ' ì—…ë¬´</h2>';
    html += '<button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>';
    html += '</div>';
    
    html += '<button onclick="closeModal(); openQuickTaskModal(\'' + dateStr + '\')" style="width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 16px;">+ ì´ ë‚ ì§œì— ì—…ë¬´ ì¶”ê°€</button>';
    
    if (tasks.length === 0) {
      html += '<div style="text-align: center; padding: 40px; color: var(--gray-500);">ë“±ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
      tasks.forEach(function(task) {
        var statusCol = TASK_COLUMNS.find(function(c) { return c.id === (STATUS_MAP[task.status] || 'waiting'); });
        html += '<div style="background: var(--gray-50); border-radius: 10px; padding: 14px; margin-bottom: 10px; cursor: pointer;" onclick="closeModal(); openTaskDetailModal(\'' + task.id + '\')">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
        html += '<div style="font-size: 14px; font-weight: 600;">' + (task.bookmark ? 'â­ ' : '') + task.title + '</div>';
        html += '<span style="font-size: 12px; padding: 4px 10px; background: ' + (statusCol ? statusCol.bg : '#f3f4f6') + '; color: ' + (statusCol ? statusCol.color : '#6b7280') + '; border-radius: 6px;">' + (statusCol ? statusCol.icon + ' ' + statusCol.label : task.status) + '</span>';
        html += '</div>';
        if (task.category || task.priority) {
          html += '<div style="margin-top: 8px; display: flex; gap: 6px;">';
          if (task.category) html += '<span style="font-size: 11px; padding: 2px 8px; background: var(--gray-200); border-radius: 4px;">' + task.category + '</span>';
          if (task.priority) html += '<span style="font-size: 11px; padding: 2px 8px; background: var(--warning-light); color: var(--warning); border-radius: 4px;">' + task.priority + '</span>';
          html += '</div>';
        }
        html += '</div>';
      });
    }
    
    html += '</div>';
    modal.innerHTML = html;
  } catch (error) {
    console.error('ë‚ ì§œ ì—…ë¬´ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// ë¹ ë¥¸ ì—…ë¬´ ì¶”ê°€ ëª¨ë‹¬
async function openQuickTaskModal(dueDate) {
  dueDate = dueDate || new Date().toISOString().split('T')[0];

  // íŒ€ì› ëª©ë¡ + ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
  var teamMembers = state.teamMembers || [];
  var categories = await loadTaskCategories();
  var currentMember = getCurrentMember();

  // ëª¨ë“  OKR ë¡œë“œ (ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”)
  var currentYear = new Date().getFullYear();
  var allOkrSnapshot = await db.collection('okrs').get();
  var allOkrs = [];
  allOkrSnapshot.forEach(doc => allOkrs.push({ id: doc.id, ...doc.data() }));

  // ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”
  var okrsByYear = {};
  allOkrs.forEach(function(o) {
    var year = o.quarter ? parseInt(o.quarter.split('-')[0]) : currentYear;
    if (!okrsByYear[year]) okrsByYear[year] = [];
    okrsByYear[year].push(o);
  });

  // ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ë„ ëª©ë¡ (í˜„ì¬ ì—°ë„ì™€ ë‹¤ìŒ ì—°ë„)
  var availableYears = [currentYear, currentYear + 1].filter(y => okrsByYear[y] && okrsByYear[y].length > 0);
  if (availableYears.length === 0) availableYears = [currentYear];

  // í˜„ì¬ ì—°ë„ OKR (ê¸°ë³¸ê°’)
  var defaultYear = availableYears.includes(currentYear) ? currentYear : availableYears[0];
  var okrs = okrsByYear[defaultYear] || [];

  // ì „ì—­ì— ì €ì¥ (ì—°ë„ ë³€ê²½ ì‹œ ì‚¬ìš©)
  window._taskModalOkrsByYear = okrsByYear;

  var modal = document.getElementById('modal');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 540px;">
      <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ“ ìƒˆ ì—…ë¬´ ì¶”ê°€</h2>

      <div style="display: grid; gap: 16px;">
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ì—…ë¬´ëª… *</label>
          <input type="text" id="quick-task-title" placeholder="ì—…ë¬´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;" />
        </div>

        <!-- ê´€ë ¨ OKR ì„ íƒ -->
        <div style="background: #E8F3FF; border-radius: 10px; padding: 14px;">
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #0064FF;">ğŸ¯ ê´€ë ¨ OKR (ì„ íƒ)</label>

          <!-- ì—°ë„ ì„ íƒ -->
          <div style="display: flex; gap: 8px; margin-bottom: 10px;">
            <select id="quick-task-okr-year" onchange="updateQuickTaskOkrList()" style="width: 100px; padding: 10px; border: 1px solid #C7D2FE; border-radius: 8px; background: white; font-weight: 600;">
              ${[currentYear, currentYear + 1].map(y => `<option value="${y}" ${y === defaultYear ? 'selected' : ''}>${y}ë…„</option>`).join('')}
            </select>
            <select id="quick-task-okr" onchange="updateKROptions()" style="flex: 1; padding: 10px; border: 1px solid #C7D2FE; border-radius: 8px; background: white;">
              <option value="">OKR ì—†ìŒ (ì¼ë°˜ ì—…ë¬´)</option>
              ${okrs.map(o => `<option value="${o.id}" data-krs='${JSON.stringify(o.keyResults || []).replace(/'/g, "&#39;")}'>[${o.quarter || ''}] ${o.objective || ''}</option>`).join('')}
            </select>
          </div>
          <select id="quick-task-kr" style="width: 100%; padding: 12px; border: 1px solid #C7D2FE; border-radius: 10px; background: white; display: none;">
            <option value="">KR ì„ íƒ</option>
          </select>
          <div style="font-size: 11px; color: #6B7684; margin-top: 6px;">ì—°ë„ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì—°ë„ì˜ OKR ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ë‹´ë‹¹ì *</label>
            <select id="quick-task-assignee" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;">
              <option value="">ì„ íƒ</option>
              ${teamMembers.map(m => `<option value="${m.id}" data-name="${m.name}" ${m.id === currentMember.id ? 'selected' : ''}>${m.name}</option>`).join('')}
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ì™„ë£Œ ê¸°í•œ</label>
            <input type="date" id="quick-task-date" value="${dueDate}" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;" />
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ìƒíƒœ</label>
            <select id="quick-task-status" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;">
              <option value="ëŒ€ê¸°">â³ ëŒ€ê¸°</option>
              <option value="ì§„í–‰ì¤‘">ğŸ”„ ì§„í–‰ì¤‘</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ìš°ì„ ìˆœìœ„</label>
            <select id="quick-task-priority" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;">
              <option value="">ì„ íƒ</option>
              <option value="ë†’ìŒ">ğŸ”´ ë†’ìŒ</option>
              <option value="ì¤‘ê°„">ğŸŸ¡ ì¤‘ê°„</option>
              <option value="ë‚®ìŒ">ğŸ”µ ë‚®ìŒ</option>
            </select>
          </div>
        </div>
        
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ë©”ëª¨</label>
          <textarea id="quick-task-note" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="width: 100%; height: 80px; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; resize: none;"></textarea>
        </div>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button onclick="closeModal()" style="flex: 1; background: #F2F4F6; color: #333D4B; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button>
        <button onclick="saveQuickTask()" style="flex: 1; background: #0064FF; color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600;">ì €ì¥</button>
      </div>
    </div>
  `;
}

// OKR ì„ íƒ ì‹œ KR ì˜µì…˜ ì—…ë°ì´íŠ¸
function updateKROptions() {
  var okrSelect = document.getElementById('quick-task-okr');
  var krSelect = document.getElementById('quick-task-kr');
  var selectedOption = okrSelect.options[okrSelect.selectedIndex];
  
  if (!okrSelect.value) {
    krSelect.style.display = 'none';
    return;
  }
  
  try {
    var krs = JSON.parse(selectedOption.dataset.krs || '[]');
    if (krs.length > 0) {
      krSelect.innerHTML = '<option value="">KR ì„ íƒ (ì„ íƒì‚¬í•­)</option>';
      krs.forEach((kr, idx) => {
        krSelect.innerHTML += `<option value="${idx}">${kr.description || 'KR ' + (idx + 1)}</option>`;
      });
      krSelect.style.display = 'block';
    } else {
      krSelect.style.display = 'none';
    }
  } catch (e) {
    krSelect.style.display = 'none';
  }
}

// ì—°ë„ ë³€ê²½ ì‹œ OKR ëª©ë¡ ì—…ë°ì´íŠ¸ (ì—…ë¬´ ì¶”ê°€ ëª¨ë‹¬)
function updateQuickTaskOkrList() {
  var yearSelect = document.getElementById('quick-task-okr-year');
  var okrSelect = document.getElementById('quick-task-okr');
  var krSelect = document.getElementById('quick-task-kr');

  if (!yearSelect || !okrSelect) return;

  var selectedYear = parseInt(yearSelect.value);
  var okrs = window._taskModalOkrsByYear ? (window._taskModalOkrsByYear[selectedYear] || []) : [];

  okrSelect.innerHTML = '<option value="">OKR ì—†ìŒ (ì¼ë°˜ ì—…ë¬´)</option>';
  okrs.forEach(function(o) {
    var krsJson = JSON.stringify(o.keyResults || []).replace(/'/g, "&#39;");
    okrSelect.innerHTML += '<option value="' + o.id + '" data-krs=\'' + krsJson + '\'>[' + (o.quarter || '') + '] ' + (o.objective || '') + '</option>';
  });

  // KR ì„ íƒ ìˆ¨ê¸°ê¸°
  if (krSelect) krSelect.style.display = 'none';
}

// ì—°ë„ ë³€ê²½ ì‹œ OKR ëª©ë¡ ì—…ë°ì´íŠ¸ (ì—…ë¬´ ìƒì„¸ ëª¨ë‹¬)
function updateDetailTaskOkrList() {
  var yearSelect = document.getElementById('detail-task-okr-year');
  var okrSelect = document.getElementById('detail-task-okr');
  var krSelect = document.getElementById('detail-task-kr');

  if (!yearSelect || !okrSelect) return;

  var selectedYear = parseInt(yearSelect.value);
  var okrs = window._taskModalOkrsByYear ? (window._taskModalOkrsByYear[selectedYear] || []) : [];

  okrSelect.innerHTML = '<option value="">OKR ì—†ìŒ (ì¼ë°˜ ì—…ë¬´)</option>';
  okrs.forEach(function(o) {
    var krsJson = JSON.stringify(o.keyResults || []).replace(/'/g, "&#39;");
    okrSelect.innerHTML += '<option value="' + o.id + '" data-krs=\'' + krsJson + '\'>[' + (o.quarter || '') + '] ' + (o.objective || '') + '</option>';
  });

  // KR ì„ íƒ ìˆ¨ê¸°ê¸°
  if (krSelect) krSelect.style.display = 'none';
}

// ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
async function loadTaskCategories() {
  try {
    var doc = await db.collection('settings').doc('taskCategories').get();
    if (doc.exists && doc.data().categories) {
      return doc.data().categories;
    }
  } catch (e) {
    console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', e);
  }
  // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬
  return ['MVP í˜•ì„±', 'ì´ë²ˆì£¼ ê³µêµ¬ì˜ˆì • - ì¤€ë¹„', 'í•´ì™¸ ìˆ˜ì¶œ ì§€ì› ì‚¬ì—…', 'ì—…ë¬´ê´€ë¦¬ ê³ ë„í™”', 'ìš´ì˜', 'ë§ˆì¼€íŒ…', 'ì •ì‚°', 'ì…€ëŸ¬ê´€ë¦¬'];
}

// êµ¬ë¶„(ì¹´í…Œê³ ë¦¬) ê´€ë¦¬ ëª¨ë‹¬ (ê´€ë¦¬ì ì „ìš©)
async function openCategoryManageModal() {
  var categories = await loadTaskCategories();
  
  var modal = document.getElementById('modal');
  modal.className = 'modal active';
  
  var html = `
    <div class="modal-content" style="max-width: 500px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 18px; font-weight: 700;">âš™ï¸ ì—…ë¬´ êµ¬ë¶„ ê´€ë¦¬</h2>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button>
      </div>
      
      <p style="color: #6B7684; font-size: 13px; margin-bottom: 20px;">ì—…ë¬´ ë“±ë¡/ìˆ˜ì • ì‹œ ì„ íƒí•  ìˆ˜ ìˆëŠ” êµ¬ë¶„(ì¹´í…Œê³ ë¦¬)ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      
      <div style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; margin-bottom: 16px;">
          <input type="text" id="new-category-input" placeholder="ìƒˆ êµ¬ë¶„ ì…ë ¥" style="flex: 1; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;" />
          <button onclick="addNewCategory()" style="background: #0064FF; color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; white-space: nowrap;">ì¶”ê°€</button>
        </div>
        
        <div id="category-list" style="display: flex; flex-direction: column; gap: 8px; max-height: 350px; overflow-y: auto;">
          ${categories.map((c, idx) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #F2F4F6; border-radius: 10px;">
              <span style="font-size: 14px; color: #191F28;">${c}</span>
              <button onclick="removeCategory('${c}')" style="background: none; border: none; color: #EF4444; cursor: pointer; font-size: 18px; padding: 4px;">Ã—</button>
            </div>
          `).join('')}
        </div>
        
        ${categories.length === 0 ? '<div style="text-align: center; padding: 30px; color: #6B7684;">ë“±ë¡ëœ êµ¬ë¶„ì´ ì—†ìŠµë‹ˆë‹¤</div>' : ''}
      </div>
      
      <div style="display: flex; gap: 12px;">
        <button onclick="resetDefaultCategories()" style="flex: 1; background: #FEF3C7; color: #92400E; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600;">ê¸°ë³¸ê°’ ë³µì›</button>
        <button onclick="closeModal()" style="flex: 1; background: #0064FF; color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600;">ì™„ë£Œ</button>
      </div>
    </div>
  `;
  
  modal.innerHTML = html;
}

// ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
async function addNewCategory() {
  var input = document.getElementById('new-category-input');
  var newCategory = input.value.trim();
  
  if (!newCategory) {
    showToast('êµ¬ë¶„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }
  
  try {
    var categories = await loadTaskCategories();
    
    if (categories.includes(newCategory)) {
      showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” êµ¬ë¶„ì…ë‹ˆë‹¤');
      return;
    }
    
    categories.push(newCategory);
    
    await db.collection('settings').doc('taskCategories').set({
      categories: categories,
      updatedAt: new Date().toISOString()
    });
    
    showToast('âœ… êµ¬ë¶„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    openCategoryManageModal(); // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
  } catch (error) {
    console.error('ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì˜¤ë¥˜:', error);
    showToast('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// ì¹´í…Œê³ ë¦¬ ì‚­ì œ
async function removeCategory(categoryToRemove) {
  if (!confirm(`'${categoryToRemove}' êµ¬ë¶„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  try {
    var categories = await loadTaskCategories();
    categories = categories.filter(c => c !== categoryToRemove);
    
    await db.collection('settings').doc('taskCategories').set({
      categories: categories,
      updatedAt: new Date().toISOString()
    });
    
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    openCategoryManageModal(); // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
  } catch (error) {
    console.error('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì˜¤ë¥˜:', error);
    showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ë¡œ ë³µì›
async function resetDefaultCategories() {
  if (!confirm('ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ëª©ë¡ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) return;
  
  var defaultCategories = ['MVP í˜•ì„±', 'ì´ë²ˆì£¼ ê³µêµ¬ì˜ˆì • - ì¤€ë¹„', 'í•´ì™¸ ìˆ˜ì¶œ ì§€ì› ì‚¬ì—…', 'ì—…ë¬´ê´€ë¦¬ ê³ ë„í™”', 'ìš´ì˜', 'ë§ˆì¼€íŒ…', 'ì •ì‚°', 'ì…€ëŸ¬ê´€ë¦¬'];
  
  try {
    await db.collection('settings').doc('taskCategories').set({
      categories: defaultCategories,
      updatedAt: new Date().toISOString()
    });
    
    showToast('ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤');
    openCategoryManageModal();
  } catch (error) {
    console.error('ë³µì› ì˜¤ë¥˜:', error);
  }
}

async function saveQuickTask() {
  var title = document.getElementById('quick-task-title').value.trim();
  if (!title) { alert('ì—…ë¬´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  
  var assigneeSelect = document.getElementById('quick-task-assignee');
  var assigneeId = assigneeSelect.value;
  var assigneeName = assigneeSelect.options[assigneeSelect.selectedIndex]?.dataset?.name || '';
  var status = document.getElementById('quick-task-status').value;
  
  // OKR/KR ì •ë³´
  var okrSelect = document.getElementById('quick-task-okr');
  var krSelect = document.getElementById('quick-task-kr');
  var linkedOkrId = okrSelect?.value || '';
  var linkedKrIndex = krSelect?.value || '';
  var linkedOkrTitle = '';
  var linkedKrTitle = '';
  
  if (linkedOkrId && okrSelect.selectedIndex > 0) {
    linkedOkrTitle = okrSelect.options[okrSelect.selectedIndex].text;
    if (linkedKrIndex !== '' && krSelect.selectedIndex > 0) {
      linkedKrTitle = krSelect.options[krSelect.selectedIndex].text;
    }
  }
  
  try {
    var now = new Date().toISOString();
    var taskData = {
      title: title,
      status: status,
      priority: document.getElementById('quick-task-priority').value,
      note: document.getElementById('quick-task-note').value,
      dueDate: document.getElementById('quick-task-date').value,
      assigneeId: assigneeId,
      assignee: assigneeName,
      linkedOkrId: linkedOkrId,
      linkedKrIndex: linkedKrIndex !== '' ? parseInt(linkedKrIndex) : null,
      linkedOkrTitle: linkedOkrTitle,
      linkedKrTitle: linkedKrTitle,
      bookmark: false,
      createdAt: now,
      updatedAt: now
    };
    // ì§„í–‰ì¤‘ìœ¼ë¡œ ì‹œì‘í•˜ë©´ ì§„í–‰ì‹œì‘ì¼ì‹œ ê¸°ë¡
    if (status === 'ì§„í–‰ì¤‘') {
      taskData.startedAt = now;
    }
    var docRef = await db.collection('tasks').add(taskData);
    
    // ìƒˆ ì—…ë¬´ ì¶”ê°€ ì‹œ í™œë™ ë¡œê·¸ ê¸°ë¡
    var statusIcon = status === 'ì§„í–‰ì¤‘' ? 'ğŸ”„' : 'â³';
    var logText = statusIcon + ' ìƒˆ ì—…ë¬´ ë“±ë¡: ' + title;
    if (linkedOkrTitle) logText += ' (ê´€ë ¨ OKR: ' + linkedOkrTitle + ')';
    await logActivity(logText, docRef.id);
    
    showToast('ì—…ë¬´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
    closeModal();
    loadWorkLogByMonth();
  } catch (error) {
    console.error('ì—…ë¬´ ì €ì¥ ì˜¤ë¥˜:', error);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì—…ë¬´ ìƒì„¸ ëª¨ë‹¬
async function openTaskDetailModal(taskId) {
  try {
    var doc = await db.collection('tasks').doc(taskId).get();
    if (!doc.exists) { alert('ì—…ë¬´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
    var task = { id: doc.id, ...doc.data() };

    // íŒ€ì› ëª©ë¡ ë¡œë“œ
    var teamMembers = state.teamMembers || [];

    // ì—°ê²°ëœ í™œë™ ê¸°ë¡ ë¡œë“œ
    var activityLogs = [];
    try {
      var logsSnapshot = await db.collection('activityLogs').where('taskId', '==', taskId).get();
      logsSnapshot.forEach(function(d) { activityLogs.push({ id: d.id, ...d.data() }); });
      activityLogs.sort(function(a, b) { return (b.createdAt || '').localeCompare(a.createdAt || ''); });
    } catch (e) { console.error('í™œë™ ë¡œê·¸ ë¡œë“œ ì˜¤ë¥˜:', e); }

    // ëª¨ë“  OKR ë¡œë“œ (ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”)
    var currentYear = new Date().getFullYear();
    var allOkrSnapshot = await db.collection('okrs').get();
    var allOkrs = [];
    allOkrSnapshot.forEach(d => allOkrs.push({ id: d.id, ...d.data() }));

    // ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”
    var okrsByYear = {};
    allOkrs.forEach(function(o) {
      var year = o.quarter ? parseInt(o.quarter.split('-')[0]) : currentYear;
      if (!okrsByYear[year]) okrsByYear[year] = [];
      okrsByYear[year].push(o);
    });

    // ì „ì—­ì— ì €ì¥ (ì—°ë„ ë³€ê²½ ì‹œ ì‚¬ìš©)
    window._taskModalOkrsByYear = okrsByYear;

    // ê¸°ì¡´ ì—°ê²°ëœ OKRì˜ ì—°ë„ í™•ì¸
    var taskOkrId = task.linkedOkrId || task.okrId || '';
    var taskKrIndex = task.linkedKrIndex ?? task.krIndex ?? null;
    var taskOkrYear = currentYear;
    if (taskOkrId) {
      var linkedOkr = allOkrs.find(function(o) { return o.id === taskOkrId; });
      if (linkedOkr && linkedOkr.quarter) {
        taskOkrYear = parseInt(linkedOkr.quarter.split('-')[0]);
      }
    }

    var okrs = okrsByYear[taskOkrYear] || [];

    // ì„±ê³µë¥  ê³„ì‚°
    var successInfo = '';
    if (task.status === 'ì™„ë£Œ' && task.dueDate && task.completedAt) {
      var dueDate = new Date(task.dueDate + 'T23:59:59');
      var completedDate = new Date(task.completedAt);
      var isOnTime = completedDate <= dueDate;
      var diffDays = Math.ceil((completedDate - dueDate) / (1000 * 60 * 60 * 24));
      if (isOnTime) {
        successInfo = '<span style="color: #16A34A; font-weight: 600;">âœ… ê¸°í•œ ë‚´ ì™„ë£Œ</span>';
        if (diffDays < 0) successInfo += ' <span style="color: #6B7684; font-size: 11px;">(' + Math.abs(diffDays) + 'ì¼ ì•ë‹¹ê²¨ ì™„ë£Œ)</span>';
      } else {
        successInfo = '<span style="color: #DC2626; font-weight: 600;">âš ï¸ ê¸°í•œ ì´ˆê³¼</span> <span style="color: #6B7684; font-size: 11px;">(' + diffDays + 'ì¼ ì§€ì—°)</span>';
      }
    }

    var modal = document.getElementById('modal');
    modal.className = 'modal active';

    var html = '<div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">';
    html += '<h2 style="font-size: 18px; font-weight: 700;">ğŸ“ ì—…ë¬´ ìƒì„¸</h2>';
    html += '<button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button>';
    html += '</div>';

    // ì¼ì‹œ ì •ë³´ ë° ì„±ê³µë¥  í‘œì‹œ
    html += '<div style="background: #F8FAFC; border-radius: 10px; padding: 14px; margin-bottom: 16px;">';
    html += '<div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 12px; color: #6B7684;">';
    if (task.createdAt) html += '<div>ğŸ“… ë“±ë¡: <span style="color: #191F28; font-weight: 500;">' + task.createdAt.slice(0, 16).replace('T', ' ') + '</span></div>';
    if (task.startedAt) html += '<div>â–¶ï¸ ì‹œì‘: <span style="color: #191F28; font-weight: 500;">' + task.startedAt.slice(0, 16).replace('T', ' ') + '</span></div>';
    if (task.completedAt) html += '<div>âœ… ì™„ë£Œ: <span style="color: #191F28; font-weight: 500;">' + task.completedAt.slice(0, 16).replace('T', ' ') + '</span></div>';
    html += '</div>';
    if (successInfo) html += '<div style="margin-top: 10px; font-size: 13px;">' + successInfo + '</div>';
    html += '</div>';

    html += '<div style="display: grid; gap: 16px;">';

    // ì œëª©
    html += '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ì—…ë¬´ëª…</label>';
    html += '<input type="text" id="detail-task-title" value="' + (task.title || '').replace(/"/g, '&quot;') + '" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;" /></div>';

    // ê´€ë ¨ OKR ì„ íƒ ì„¹ì…˜
    html += '<div style="background: #E8F3FF; border-radius: 10px; padding: 14px;">';
    html += '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #0064FF;">ğŸ¯ ê´€ë ¨ OKR</label>';
    html += '<div style="display: flex; gap: 8px; margin-bottom: 10px;">';
    html += '<select id="detail-task-okr-year" onchange="updateDetailTaskOkrList()" style="width: 100px; padding: 10px; border: 1px solid #C7D2FE; border-radius: 8px; background: white; font-weight: 600;">';
    [currentYear, currentYear + 1].forEach(function(y) {
      html += '<option value="' + y + '" ' + (y === taskOkrYear ? 'selected' : '') + '>' + y + 'ë…„</option>';
    });
    html += '</select>';
    html += '<select id="detail-task-okr" onchange="updateDetailKROptions()" style="flex: 1; padding: 10px; border: 1px solid #C7D2FE; border-radius: 8px; background: white;">';
    html += '<option value="">OKR ì—†ìŒ (ì¼ë°˜ ì—…ë¬´)</option>';
    okrs.forEach(function(o) {
      var isSelected = taskOkrId === o.id;
      var krsJson = JSON.stringify(o.keyResults || []).replace(/'/g, "&#39;");
      html += '<option value="' + o.id + '" data-krs=\'' + krsJson + '\' ' + (isSelected ? 'selected' : '') + '>[' + (o.quarter || '') + '] ' + (o.objective || '') + '</option>';
    });
    html += '</select></div>';
    var showKr = taskOkrId ? 'block' : 'none';
    var selectedOkr = okrs.find(function(o) { return o.id === taskOkrId; });
    var krs = selectedOkr ? (selectedOkr.keyResults || []) : [];
    html += '<select id="detail-task-kr" style="width: 100%; padding: 12px; border: 1px solid #C7D2FE; border-radius: 10px; background: white; display: ' + showKr + ';">';
    html += '<option value="">KR ì„ íƒ (ì„ íƒì‚¬í•­)</option>';
    krs.forEach(function(kr, idx) {
      var isKrSelected = taskKrIndex === idx || taskKrIndex === String(idx);
      html += '<option value="' + idx + '" ' + (isKrSelected ? 'selected' : '') + '>' + (kr.description || 'KR ' + (idx + 1)) + '</option>';
    });
    html += '</select></div>';

    // ìƒíƒœ, ìš°ì„ ìˆœìœ„
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
    html += '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ìƒíƒœ</label><select id="detail-task-status" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;">';
    ['ëŒ€ê¸°', 'ì§„í–‰ì¤‘', 'ì™„ë£Œ', 'ë³´ë¥˜'].forEach(function(s) {
      html += '<option value="' + s + '" ' + (task.status === s ? 'selected' : '') + '>' + s + '</option>';
    });
    html += '</select></div>';
    html += '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ìš°ì„ ìˆœìœ„</label><select id="detail-task-priority" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;">';
    html += '<option value="">ì„ íƒ</option>';
    ['ë†’ìŒ', 'ì¤‘ê°„', 'ë‚®ìŒ'].forEach(function(p) {
      html += '<option value="' + p + '" ' + (task.priority === p ? 'selected' : '') + '>' + p + '</option>';
    });
    html += '</select></div></div>';

    // ë‹´ë‹¹ì, ë‚ ì§œ
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
    html += '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ë‹´ë‹¹ì</label>';
    html += '<select id="detail-task-assignee" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;">';
    html += '<option value="">ë¯¸ì§€ì •</option>';
    teamMembers.forEach(function(m) {
      var isSelected = task.assigneeId === m.id || task.assignee === m.name;
      html += '<option value="' + m.id + '" data-name="' + m.name + '" ' + (isSelected ? 'selected' : '') + '>' + m.name + '</option>';
    });
    html += '</select></div>';
    html += '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ì™„ë£Œ ê¸°í•œ</label>';
    html += '<input type="date" id="detail-task-date" value="' + (task.dueDate || '') + '" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px;" /></div>';
    html += '</div>';

    // ë©”ëª¨
    html += '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">ë©”ëª¨</label>';
    html += '<textarea id="detail-task-note" style="width: 100%; height: 80px; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; resize: none;">' + (task.note || '') + '</textarea></div>';

    // ì—°ê²°ëœ í™œë™ ê¸°ë¡ (ì ‘ì€ ìƒíƒœ)
    html += '<div style="border: 1px solid #E5E8EB; border-radius: 10px; overflow: hidden;">';
    html += '<div onclick="toggleTaskActivityLogs()" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: #F8FAFC; cursor: pointer;">';
    html += '<span style="font-size: 13px; font-weight: 600; color: #333D4B;">ğŸ“‹ ì—°ê²°ëœ í™œë™ ê¸°ë¡ <span style="color: #0064FF; font-weight: 700;">(' + activityLogs.length + 'ê±´)</span></span>';
    html += '<span id="task-activity-toggle-icon" style="font-size: 14px; color: #6B7684; transition: transform 0.2s;">â–¼</span>';
    html += '</div>';
    html += '<div id="task-activity-logs" style="display: none; padding: 12px; background: white; max-height: 200px; overflow-y: auto;">';
    if (activityLogs.length === 0) {
      html += '<div style="color: #6B7684; font-size: 13px; text-align: center; padding: 16px;">ì—°ê²°ëœ í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
      activityLogs.forEach(function(log) {
        html += '<div style="padding: 10px; border-bottom: 1px solid #F2F4F6; font-size: 13px;">';
        html += '<div style="color: #191F28; font-weight: 500;">' + (log.action || '') + '</div>';
        html += '<div style="color: #6B7684; font-size: 11px; margin-top: 4px;">' + (log.memberName || '') + ' Â· ' + (log.date || '') + ' ' + (log.time || '') + '</div>';
        html += '</div>';
      });
    }
    html += '</div></div>';

    html += '</div>';

    html += '<div style="display: flex; gap: 12px; margin-top: 24px;">';
    html += '<button onclick="deleteTaskFromDetail(\'' + taskId + '\')" style="background: #FEE2E2; color: #DC2626; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600;">ì‚­ì œ</button>';
    html += '<div style="flex: 1;"></div>';
    html += '<button onclick="closeModal()" style="background: #F2F4F6; color: #333D4B; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button>';
    html += '<button onclick="saveTaskDetail(\'' + taskId + '\')" style="background: #0064FF; color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600;">ì €ì¥</button>';
    html += '</div></div>';

    modal.innerHTML = html;
  } catch (error) {
    console.error('ì—…ë¬´ ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// ì—…ë¬´ ìƒì„¸ - í™œë™ ê¸°ë¡ í† ê¸€
function toggleTaskActivityLogs() {
  var logsDiv = document.getElementById('task-activity-logs');
  var icon = document.getElementById('task-activity-toggle-icon');
  if (logsDiv.style.display === 'none') {
    logsDiv.style.display = 'block';
    icon.style.transform = 'rotate(180deg)';
  } else {
    logsDiv.style.display = 'none';
    icon.style.transform = 'rotate(0deg)';
  }
}

// ì—…ë¬´ ìƒì„¸ ëª¨ë‹¬ì—ì„œ KR ì˜µì…˜ ì—…ë°ì´íŠ¸
function updateDetailKROptions() {
  var okrSelect = document.getElementById('detail-task-okr');
  var krSelect = document.getElementById('detail-task-kr');
  var selectedOption = okrSelect.options[okrSelect.selectedIndex];

  if (!okrSelect.value) {
    krSelect.style.display = 'none';
    return;
  }

  try {
    var krs = JSON.parse(selectedOption.dataset.krs || '[]');
    if (krs.length > 0) {
      krSelect.innerHTML = '<option value="">KR ì„ íƒ (ì„ íƒì‚¬í•­)</option>';
      krs.forEach(function(kr, idx) {
        krSelect.innerHTML += '<option value="' + idx + '">' + (kr.description || 'KR ' + (idx + 1)) + '</option>';
      });
      krSelect.style.display = 'block';
    } else {
      krSelect.style.display = 'none';
    }
  } catch (e) {
    krSelect.style.display = 'none';
  }
}

async function saveTaskDetail(taskId) {
  try {
    // ê¸°ì¡´ ìƒíƒœ í™•ì¸
    var taskDoc = await db.collection('tasks').doc(taskId).get();
    var oldTask = taskDoc.data();
    var oldStatus = oldTask?.status || 'ëŒ€ê¸°';

    var assigneeSelect = document.getElementById('detail-task-assignee');
    var assigneeId = assigneeSelect.value;
    var assigneeName = assigneeSelect.options[assigneeSelect.selectedIndex]?.dataset?.name || '';

    var newStatus = document.getElementById('detail-task-status').value;
    var newTitle = document.getElementById('detail-task-title').value;

    // OKR ì—°ê²° ì •ë³´ (linkedOkrIdë¡œ í†µì¼ - showLinkedTasksì™€ í˜¸í™˜)
    var okrSelect = document.getElementById('detail-task-okr');
    var krSelect = document.getElementById('detail-task-kr');
    var linkedOkrId = okrSelect ? okrSelect.value : '';
    var linkedKrIndex = krSelect && krSelect.value !== '' ? parseInt(krSelect.value) : null;

    // OKR/KR ì´ë¦„ë„ ì €ì¥ (í‘œì‹œìš©)
    var linkedOkrTitle = '';
    var linkedKrTitle = '';
    if (okrSelect && okrSelect.value) {
      linkedOkrTitle = okrSelect.options[okrSelect.selectedIndex]?.textContent || '';
    }
    if (krSelect && krSelect.value !== '') {
      linkedKrTitle = krSelect.options[krSelect.selectedIndex]?.textContent || '';
    }

    var now = new Date().toISOString();
    var updateData = {
      title: newTitle,
      status: newStatus,
      priority: document.getElementById('detail-task-priority').value,
      dueDate: document.getElementById('detail-task-date').value,
      note: document.getElementById('detail-task-note').value,
      assigneeId: assigneeId,
      assignee: assigneeName,
      linkedOkrId: linkedOkrId,
      linkedKrIndex: linkedKrIndex,
      linkedOkrTitle: linkedOkrTitle,
      linkedKrTitle: linkedKrTitle,
      updatedAt: now
    };

    // ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½ ì‹œ startedAt ê¸°ë¡ (ì²˜ìŒ ì§„í–‰ ì‹œì‘í•œ ê²½ìš°ë§Œ)
    if (newStatus === 'ì§„í–‰ì¤‘' && oldStatus !== 'ì§„í–‰ì¤‘' && !oldTask.startedAt) {
      updateData.startedAt = now;
    }

    // ì™„ë£Œë¡œ ë³€ê²½ ì‹œ completedAt ê¸°ë¡
    if (newStatus === 'ì™„ë£Œ' && oldStatus !== 'ì™„ë£Œ') {
      updateData.completedAt = now;
    }

    await db.collection('tasks').doc(taskId).update(updateData);
    
    // ìƒíƒœ ë³€ê²½ ì‹œ í™œë™ ë¡œê·¸ ê¸°ë¡
    if (oldStatus !== newStatus) {
      var actionText = '';
      if (newStatus === 'ì™„ë£Œ') actionText = 'âœ… ì—…ë¬´ ì™„ë£Œ: ' + newTitle;
      else if (newStatus === 'ì§„í–‰ì¤‘') actionText = 'ğŸ”„ ì—…ë¬´ ì‹œì‘: ' + newTitle;
      else if (newStatus === 'ë³´ë¥˜') actionText = 'â¸ï¸ ì—…ë¬´ ë³´ë¥˜: ' + newTitle;
      else if (newStatus === 'ëŒ€ê¸°') actionText = 'â³ ì—…ë¬´ ëŒ€ê¸°: ' + newTitle;
      
      if (actionText) await logActivity(actionText, taskId);
    }
    
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    closeModal();
    loadWorkLogByMonth();
  } catch (error) {
    console.error('ì—…ë¬´ ì €ì¥ ì˜¤ë¥˜:', error);
  }
}

async function deleteTaskFromDetail(taskId) {
  if (!confirm('ì´ ì—…ë¬´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('tasks').doc(taskId).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    var dateEl = document.getElementById('worklog-date');
    if (dateEl) loadWorkLog(dateEl.value);
    else if (state.currentTab === 'taskManagement') loadTasks();
  } catch (error) {
    console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
  }
}

// ë£¨í‹´ ê´€ë¦¬ ëª¨ë‹¬
async function openRoutineModal() {
  try {
    var snapshot = await db.collection('routineTasks').get();
    var routines = [];
    snapshot.forEach(function(doc) { routines.push({ id: doc.id, ...doc.data() }); });
    
    var modal = document.getElementById('modal');
    modal.className = 'modal active';
    
    var html = '<div class="modal-content" style="max-width: 600px;">';
    html += '<h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">â° ë£¨í‹´ ì—…ë¬´ ê´€ë¦¬</h2>';
    
    // ìƒˆ ë£¨í‹´ ì¶”ê°€
    html += '<div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">';
    html += '<div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ìƒˆ ë£¨í‹´ ì¶”ê°€</div>';
    html += '<div style="display: flex; gap: 8px;">';
    html += '<input type="text" id="new-routine-title" placeholder="ë£¨í‹´ ì—…ë¬´ëª…" style="flex: 1; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;" />';
    html += '<select id="new-routine-type" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">';
    html += '<option value="daily">ë§¤ì¼</option><option value="weekly">ë§¤ì£¼</option><option value="monthly">ë§¤ì›”</option>';
    html += '</select>';
    html += '<button onclick="addRoutine()" style="background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">ì¶”ê°€</button>';
    html += '</div></div>';
    
    // ê¸°ì¡´ ë£¨í‹´ ëª©ë¡
    html += '<div style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">';
    if (routines.length === 0) {
      html += '<div style="text-align: center; padding: 30px; color: var(--gray-500);">ë“±ë¡ëœ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
      routines.forEach(function(r) {
        var type = ROUTINE_TYPES[r.routineType] || ROUTINE_TYPES.daily;
        html += '<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);">';
        html += '<span style="font-size: 20px;">' + type.icon + '</span>';
        html += '<span style="flex: 1; font-size: 14px;">' + r.title + '</span>';
        html += '<span style="font-size: 12px; padding: 4px 8px; background: ' + type.color + '; color: white; border-radius: 4px;">' + type.label + '</span>';
        html += '<button onclick="deleteRoutine(\'' + r.id + '\')" style="background: var(--danger-light); color: var(--danger); border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>';
        html += '</div>';
      });
    }
    html += '</div>';
    
    html += '<button onclick="closeModal()" style="width: 100%; margin-top: 20px; background: var(--gray-200); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">ë‹«ê¸°</button>';
    html += '</div>';
    
    modal.innerHTML = html;
  } catch (error) {
    console.error('ë£¨í‹´ ëª¨ë‹¬ ì˜¤ë¥˜:', error);
  }
}

async function addRoutine() {
  var title = document.getElementById('new-routine-title').value.trim();
  if (!title) { alert('ë£¨í‹´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  
  try {
    await db.collection('routineTasks').add({
      title: title,
      routineType: document.getElementById('new-routine-type').value,
      completedDates: [],
      createdAt: new Date().toISOString()
    });
    showToast('ë£¨í‹´ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
    openRoutineModal();
  } catch (error) {
    console.error('ë£¨í‹´ ì¶”ê°€ ì˜¤ë¥˜:', error);
  }
}

async function deleteRoutine(routineId) {
  if (!confirm('ì´ ë£¨í‹´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('routineTasks').doc(routineId).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    openRoutineModal();
  } catch (error) {
    console.error('ë£¨í‹´ ì‚­ì œ ì˜¤ë¥˜:', error);
  }
}

// ========================================
// Phase 4: ë¶„ê¸° ë¦¬ë·° ëŒ€ì‹œë³´ë“œ
// ========================================

function renderOKRReviewDashboard() {
  var app = document.getElementById('app');
  var currentQuarter = getQuarter();
  
  app.innerHTML = '<div class="page-header"><h1 style="font-size: 24px; font-weight: 700;">ğŸ“ˆ ë¶„ê¸° ë¦¬ë·° ëŒ€ì‹œë³´ë“œ</h1><p style="color: var(--gray-600); margin-top: 8px;">OKR ì„±ê³¼ë¥¼ ë¶„ì„í•˜ê³  ë‹¤ìŒ ë¶„ê¸° ëª©í‘œë¥¼ ì„¤ì •í•˜ì„¸ìš”</p></div><div class="content"><div id="review-dashboard-content"><div class="loading" style="text-align: center; padding: 40px;"><div class="loading-spinner"></div></div></div></div>';
  
  loadOKRReviewDashboard();
}

async function loadOKRReviewDashboard() {
  try {
    var currentQuarter = getQuarter();
    var quarterKey = currentQuarter.year + '-Q' + currentQuarter.quarter;
    var prevQuarterKey = getPrevQuarter(currentQuarter);
    
    var results = await Promise.all([
      db.collection('okrs').get(),
      db.collection('teamMembers').get(),
      db.collection('deals').get(),
      db.collection('sellerSettlements').get(),
      db.collection('sellers').get()
    ]);
    
    var allOkrs = [];
    results[0].forEach(function(doc) { allOkrs.push({ id: doc.id, ...doc.data() }); });
    
    var teamMembers = {};
    results[1].forEach(function(doc) { teamMembers[doc.id] = doc.data(); });
    
    var deals = [];
    results[2].forEach(function(doc) { deals.push({ id: doc.id, ...doc.data() }); });
    
    var settlements = [];
    results[3].forEach(function(doc) { settlements.push({ id: doc.id, ...doc.data() }); });
    
    var sellers = [];
    results[4].forEach(function(doc) { sellers.push({ id: doc.id, ...doc.data() }); });
    
    var currentOkrs = allOkrs.filter(function(o) { return o.quarter === quarterKey; });
    var prevOkrs = allOkrs.filter(function(o) { return o.quarter === prevQuarterKey; });
    
    renderOKRReviewContent(currentOkrs, prevOkrs, teamMembers, deals, settlements, sellers, quarterKey, prevQuarterKey);
  } catch (error) {
    console.error('ë¦¬ë·° ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

function getPrevQuarter(current) {
  var q = current.quarter - 1;
  var y = current.year;
  if (q < 1) { q = 4; y--; }
  return y + '-Q' + q;
}

function renderOKRReviewContent(currentOkrs, prevOkrs, teamMembers, deals, settlements, sellers, quarterKey, prevQuarterKey) {
  var content = document.getElementById('review-dashboard-content');
  
  // í˜„ì¬ ë¶„ê¸° í†µê³„
  var avgProgress = currentOkrs.length > 0 ? currentOkrs.reduce(function(s, o) { return s + (o.progress || 0); }, 0) / currentOkrs.length : 0;
  var prevAvgProgress = prevOkrs.length > 0 ? prevOkrs.reduce(function(s, o) { return s + (o.progress || 0); }, 0) / prevOkrs.length : 0;
  var progressChange = avgProgress - prevAvgProgress;
  
  // ì‹¤ì  ê³„ì‚°
  var totalSales = settlements.reduce(function(s, d) { return s + (Number(d.totalSales) || 0); }, 0);
  var dealCount = deals.length;
  var sellerCount = sellers.length;
  
  var html = '';
  
  // ë¶„ê¸° ì„ íƒ
  html += '<div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">';
  html += '<span style="font-size: 14px; font-weight: 600;">ë¶„ê¸° ì„ íƒ:</span>';
  html += '<select id="review-quarter-select" onchange="changeReviewQuarter(this.value)" style="padding: 10px 16px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">';
  for (var y = 2025; y >= 2024; y--) {
    for (var q = 4; q >= 1; q--) {
      var qk = y + '-Q' + q;
      html += '<option value="' + qk + '" ' + (qk === quarterKey ? 'selected' : '') + '>' + y + 'ë…„ Q' + q + '</option>';
    }
  }
  html += '</select>';
  html += '<button onclick="syncAllOKRProgress()" style="background: var(--info); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ”„ ì‹¤ì  ë™ê¸°í™”</button>';
  html += '<button onclick="openNextQuarterGuide()" style="background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ¯ ë‹¤ìŒ ë¶„ê¸° ëª©í‘œ ì„¤ì •</button>';
  html += '</div>';
  
  // ìš”ì•½ ì¹´ë“œ
  html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">';
  
  // OKR ë‹¬ì„±ë¥ 
  html += '<div style="background: linear-gradient(135deg, ' + (avgProgress >= 70 ? '#10b981, #059669' : avgProgress >= 40 ? '#f59e0b, #d97706' : '#ef4444, #dc2626') + '); border-radius: 12px; padding: 20px; color: white;">';
  html += '<div style="font-size: 13px; opacity: 0.9;">OKR í‰ê·  ë‹¬ì„±ë¥ </div>';
  html += '<div style="font-size: 32px; font-weight: 700;">' + avgProgress.toFixed(0) + '%</div>';
  html += '<div style="font-size: 12px; opacity: 0.8;">';
  if (progressChange > 0) html += 'â†‘ ì „ë¶„ê¸° ëŒ€ë¹„ +' + progressChange.toFixed(0) + '%';
  else if (progressChange < 0) html += 'â†“ ì „ë¶„ê¸° ëŒ€ë¹„ ' + progressChange.toFixed(0) + '%';
  else html += 'ì „ë¶„ê¸° ë™ì¼';
  html += '</div></div>';
  
  // ì´ ë§¤ì¶œ
  html += '<div style="background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; padding: 20px; color: white;">';
  html += '<div style="font-size: 13px; opacity: 0.9;">ì´ ë§¤ì¶œ</div>';
  html += '<div style="font-size: 32px; font-weight: 700;">' + (totalSales / 100000000).toFixed(1) + 'ì–µ</div>';
  html += '<div style="font-size: 12px; opacity: 0.8;">' + totalSales.toLocaleString() + 'ì›</div></div>';
  
  // ê³µêµ¬ ìˆ˜
  html += '<div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; padding: 20px; color: white;">';
  html += '<div style="font-size: 13px; opacity: 0.9;">ì´ ê³µêµ¬</div>';
  html += '<div style="font-size: 32px; font-weight: 700;">' + dealCount + 'ê±´</div>';
  html += '<div style="font-size: 12px; opacity: 0.8;">ì™„ë£Œ ' + deals.filter(function(d) { return d.status === 'completed'; }).length + 'ê±´</div></div>';
  
  // ì…€ëŸ¬ ìˆ˜
  html += '<div style="background: linear-gradient(135deg, #ec4899, #db2777); border-radius: 12px; padding: 20px; color: white;">';
  html += '<div style="font-size: 13px; opacity: 0.9;">í™œì„± ì…€ëŸ¬</div>';
  html += '<div style="font-size: 32px; font-weight: 700;">' + sellerCount + 'ëª…</div>';
  html += '<div style="font-size: 12px; opacity: 0.8;">ì‹ ê·œ ' + sellers.filter(function(s) { return s.sellerStatus === 'active'; }).length + 'ëª…</div></div>';
  
  html += '</div>';
  
  // OKR ìƒì„¸ ë¶„ì„
  html += '<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px;">';
  
  // íŒ€ì›ë³„ OKR í˜„í™©
  html += '<div style="background: white; border-radius: 12px; padding: 24px;">';
  html += '<h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ‘¥ íŒ€ì›ë³„ OKR í˜„í™©</h3>';
  
  if (currentOkrs.length === 0) {
    html += '<div style="text-align: center; padding: 40px; color: var(--gray-500);">ë“±ë¡ëœ OKRì´ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    html += '<div style="display: flex; flex-direction: column; gap: 16px;">';
    currentOkrs.forEach(function(okr) {
      var member = teamMembers[okr.memberId] || { name: 'ë¯¸ì§€ì •' };
      var pColor = okr.progress >= 70 ? 'var(--success)' : okr.progress >= 40 ? 'var(--warning)' : 'var(--danger)';
      
      html += '<div style="border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
      html += '<div><span style="font-size: 14px; font-weight: 700; color: var(--primary);">' + member.name + '</span></div>';
      html += '<span style="font-size: 20px; font-weight: 700; color: ' + pColor + ';">' + (okr.progress || 0) + '%</span>';
      html += '</div>';
      html += '<div style="font-size: 14px; color: var(--gray-800); margin-bottom: 8px;">' + okr.objective + '</div>';
      html += '<div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">';
      html += '<div style="background: ' + pColor + '; height: 100%; width: ' + (okr.progress || 0) + '%;"></div></div>';
      
      // KR ìƒì„¸
      if (okr.keyResults && okr.keyResults.length > 0) {
        html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200);">';
        okr.keyResults.forEach(function(kr, idx) {
          var krProgress = kr.progress || 0;
          var krColor = krProgress >= 70 ? 'var(--success)' : krProgress >= 40 ? 'var(--warning)' : 'var(--danger)';
          html += '<div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; margin-bottom: 6px;">';
          html += '<span style="color: var(--gray-600);">KR' + (idx + 1) + ': ' + kr.description + '</span>';
          html += '<span style="font-weight: 600; color: ' + krColor + ';">' + (kr.actual || 0) + ' / ' + kr.target + '</span>';
          html += '</div>';
        });
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';
  }
  html += '</div>';
  
  // ë¶„ì„ ì¸ì‚¬ì´íŠ¸
  html += '<div style="display: flex; flex-direction: column; gap: 16px;">';
  
  // ë‹¬ì„±/ë¯¸ë‹¬ì„± ë¶„ì„
  var achieved = currentOkrs.filter(function(o) { return o.progress >= 70; }).length;
  var partial = currentOkrs.filter(function(o) { return o.progress >= 40 && o.progress < 70; }).length;
  var underperformed = currentOkrs.filter(function(o) { return o.progress < 40; }).length;
  
  html += '<div style="background: white; border-radius: 12px; padding: 20px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">ğŸ“Š ë‹¬ì„±ë¥  ë¶„í¬</h3>';
  html += '<div style="display: flex; flex-direction: column; gap: 8px;">';
  html += '<div style="display: flex; align-items: center; gap: 8px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: var(--success);"></span><span style="flex: 1;">ë‹¬ì„± (70%+)</span><span style="font-weight: 700;">' + achieved + 'ê°œ</span></div>';
  html += '<div style="display: flex; align-items: center; gap: 8px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: var(--warning);"></span><span style="flex: 1;">ë¶€ë¶„ë‹¬ì„± (40-70%)</span><span style="font-weight: 700;">' + partial + 'ê°œ</span></div>';
  html += '<div style="display: flex; align-items: center; gap: 8px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: var(--danger);"></span><span style="flex: 1;">ë¯¸ë‹¬ì„± (40%-)</span><span style="font-weight: 700;">' + underperformed + 'ê°œ</span></div>';
  html += '</div></div>';
  
  // í•µì‹¬ ì¸ì‚¬ì´íŠ¸
  html += '<div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; padding: 20px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; color: var(--warning); margin-bottom: 12px;">ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h3>';
  html += '<ul style="list-style: none; padding: 0; margin: 0; font-size: 13px; color: var(--gray-700);">';
  if (avgProgress >= 70) {
    html += '<li style="margin-bottom: 8px;">âœ… ì „ì²´ì ìœ¼ë¡œ ì¢‹ì€ ì„±ê³¼ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤!</li>';
  } else if (avgProgress >= 40) {
    html += '<li style="margin-bottom: 8px;">âš ï¸ ë¶€ë¶„ì ì¸ ì„±ê³¼ ë‹¬ì„± - ì¶”ê°€ ë…¸ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤</li>';
  } else {
    html += '<li style="margin-bottom: 8px;">ğŸš¨ ëª©í‘œ ì¬ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤</li>';
  }
  if (underperformed > 0) {
    html += '<li style="margin-bottom: 8px;">ğŸ” ' + underperformed + 'ê°œ OKRì´ ë¯¸ë‹¬ì„± ìƒíƒœì…ë‹ˆë‹¤</li>';
  }
  html += '</ul></div>';
  
  // 50ì–µ ëª©í‘œ íŠ¸ë˜ì»¤
  html += '<div style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; padding: 20px; color: white;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px;">ğŸ¯ 50ì–µ ëª©í‘œ íŠ¸ë˜ì»¤</h3>';
  var target50 = 5000000000;
  var progress50 = Math.min(100, (totalSales / target50) * 100);
  html += '<div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">' + (totalSales / 100000000).toFixed(2) + 'ì–µ / 50ì–µ</div>';
  html += '<div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; overflow: hidden;">';
  html += '<div style="background: white; height: 100%; width: ' + progress50 + '%;"></div></div>';
  html += '<div style="font-size: 12px; opacity: 0.9; margin-top: 8px;">' + progress50.toFixed(1) + '% ë‹¬ì„±</div>';
  html += '</div>';
  
  html += '</div></div>';
  
  // ì „ë¶„ê¸° ë¹„êµ
  if (prevOkrs.length > 0) {
    html += '<div style="background: white; border-radius: 12px; padding: 24px;">';
    html += '<h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ“ˆ ì „ë¶„ê¸° ë¹„êµ (' + prevQuarterKey + ' vs ' + quarterKey + ')</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">';
    html += '<div style="text-align: center; padding: 20px; background: var(--gray-50); border-radius: 10px;">';
    html += '<div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì „ë¶„ê¸° í‰ê· </div>';
    html += '<div style="font-size: 28px; font-weight: 700; color: var(--gray-600);">' + prevAvgProgress.toFixed(0) + '%</div></div>';
    html += '<div style="text-align: center; padding: 20px; background: var(--primary-light); border-radius: 10px;">';
    html += '<div style="font-size: 12px; color: var(--primary); margin-bottom: 4px;">í˜„ì¬ ë¶„ê¸°</div>';
    html += '<div style="font-size: 28px; font-weight: 700; color: var(--primary);">' + avgProgress.toFixed(0) + '%</div></div>';
    html += '<div style="text-align: center; padding: 20px; background: ' + (progressChange >= 0 ? 'var(--success-light)' : 'var(--danger-light)') + '; border-radius: 10px;">';
    html += '<div style="font-size: 12px; color: ' + (progressChange >= 0 ? 'var(--success)' : 'var(--danger)') + '; margin-bottom: 4px;">ë³€í™”</div>';
    html += '<div style="font-size: 28px; font-weight: 700; color: ' + (progressChange >= 0 ? 'var(--success)' : 'var(--danger)') + ';">' + (progressChange >= 0 ? '+' : '') + progressChange.toFixed(0) + '%</div></div>';
    html += '</div></div>';
  }
  
  content.innerHTML = html;
}

// ë‹¤ìŒ ë¶„ê¸° ëª©í‘œ ì„¤ì • ê°€ì´ë“œ
function openNextQuarterGuide() {
  var current = getQuarter();
  var nextQ = current.quarter + 1;
  var nextY = current.year;
  if (nextQ > 4) { nextQ = 1; nextY++; }
  var nextQuarter = nextY + '-Q' + nextQ;
  
  var modal = document.getElementById('modal');
  modal.className = 'modal active';
  
  var html = '<div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">';
  html += '<h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">ğŸ¯ ' + nextQuarter + ' ëª©í‘œ ì„¤ì • ê°€ì´ë“œ</h2>';
  
  html += '<div style="background: var(--info-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; color: var(--info); margin-bottom: 12px;">ğŸ“‹ OKR ì„¤ì • ì›ì¹™</h3>';
  html += '<ul style="margin: 0; padding-left: 20px; color: var(--gray-700); line-height: 1.8;">';
  html += '<li><strong>Objective(ëª©í‘œ)</strong>: ì˜ê°ì„ ì£¼ëŠ” ì •ì„±ì  ëª©í‘œ</li>';
  html += '<li><strong>Key Results(í•µì‹¬ ê²°ê³¼)</strong>: ì¸¡ì • ê°€ëŠ¥í•œ ì •ëŸ‰ì  ì§€í‘œ</li>';
  html += '<li>ëª©í‘œëŠ” <strong>ë„ì „ì ì´ì§€ë§Œ ë‹¬ì„± ê°€ëŠ¥</strong>í•˜ê²Œ</li>';
  html += '<li>70% ë‹¬ì„±ì´ë©´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼</li>';
  html += '</ul></div>';
  
  html += '<div style="background: var(--warning-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; color: var(--warning); margin-bottom: 12px;">ğŸ’° 50ì–µ ëª©í‘œ ë¶„ê¸°ë³„ ë§ˆì¼ìŠ¤í†¤</h3>';
  html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">';
  html += '<div style="background: white; padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: var(--gray-500);">2025 Q1</div><div style="font-size: 18px; font-weight: 700;">3ì–µ</div></div>';
  html += '<div style="background: white; padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: var(--gray-500);">2025 Q2</div><div style="font-size: 18px; font-weight: 700;">5ì–µ</div></div>';
  html += '<div style="background: white; padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: var(--gray-500);">2025 Q3</div><div style="font-size: 18px; font-weight: 700;">8ì–µ</div></div>';
  html += '<div style="background: white; padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: var(--gray-500);">2025 Q4</div><div style="font-size: 18px; font-weight: 700;">12ì–µ</div></div>';
  html += '</div>';
  html += '<p style="font-size: 12px; color: var(--gray-600); margin-top: 12px;">* ì—°ê°„ ëˆ„ì  28ì–µ â†’ 2026ë…„ 22ì–µ ì¶”ê°€ = 50ì–µ ë‹¬ì„±</p>';
  html += '</div>';
  
  html += '<div style="background: var(--success-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
  html += '<h3 style="font-size: 16px; font-weight: 700; color: var(--success); margin-bottom: 12px;">ğŸ“ ì¶”ì²œ OKR í…œí”Œë¦¿</h3>';
  html += '<div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">';
  html += '<div style="font-weight: 700; margin-bottom: 8px;">ğŸ¯ Objective: ëª¨ì—¬ë¼ë”œ í•µì‹¬ ì§€í‘œ ì„±ì¥</div>';
  html += '<div style="padding-left: 16px; color: var(--gray-700); font-size: 14px;">';
  html += '<div style="margin-bottom: 4px;">â€¢ KR1: ë¶„ê¸° ë§¤ì¶œ [X]ì–µ ë‹¬ì„±</div>';
  html += '<div style="margin-bottom: 4px;">â€¢ KR2: ì‹ ê·œ ì…€ëŸ¬ [X]ëª… í™•ë³´</div>';
  html += '<div style="margin-bottom: 4px;">â€¢ KR3: ì™„ë£Œ ê³µêµ¬ [X]ê±´ ë‹¬ì„±</div>';
  html += '</div></div>';
  html += '<div style="background: white; padding: 16px; border-radius: 8px;">';
  html += '<div style="font-weight: 700; margin-bottom: 8px;">ğŸ¯ Objective: ì…€ëŸ¬ ìƒíƒœê³„ ê°•í™”</div>';
  html += '<div style="padding-left: 16px; color: var(--gray-700); font-size: 14px;">';
  html += '<div style="margin-bottom: 4px;">â€¢ KR1: ì…€ëŸ¬ ì¬ì°¸ì—¬ìœ¨ [X]% ë‹¬ì„±</div>';
  html += '<div style="margin-bottom: 4px;">â€¢ KR2: Së“±ê¸‰ ì…€ëŸ¬ [X]ëª… ìœ¡ì„±</div>';
  html += '<div style="margin-bottom: 4px;">â€¢ KR3: ì…€ëŸ¬ ë§Œì¡±ë„ [X]ì  ì´ìƒ</div>';
  html += '</div></div></div>';
  
  html += '<div style="display: flex; gap: 12px;">';
  html += '<button onclick="closeModal()" style="flex: 1; background: var(--gray-200); border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">ë‹«ê¸°</button>';
  html += '<button onclick="closeModal(); switchTab(\'okrManagement\')" style="flex: 1; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">OKR ë“±ë¡í•˜ëŸ¬ ê°€ê¸°</button>';
  html += '</div></div>';
  
  modal.innerHTML = html;
}

// ë¶„ê¸° ë³€ê²½
function changeReviewQuarter(quarter) {
  // ì„ íƒëœ ë¶„ê¸°ë¡œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
  loadOKRReviewDashboard();
}

// ========================================
// ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹œìŠ¤í…œ
// ========================================

// ë ˆí¼ëŸ°ìŠ¤ ì¹´í…Œê³ ë¦¬ ì •ì˜
var REFERENCE_CATEGORIES = [
  { id: 'event', label: 'ğŸ‰ ì´ë²¤íŠ¸', color: '#F59E0B', bg: '#FEF3C7' },
  { id: 'design', label: 'ğŸ¨ ë””ìì¸', color: '#EC4899', bg: '#FCE7F3' },
  { id: 'proposal', label: 'ğŸ“„ ì œì•ˆì„œ', color: '#3B82F6', bg: '#DBEAFE' },
  { id: 'shortform', label: 'ğŸ¬ ìˆí¼', color: '#EF4444', bg: '#FEE2E2' },
  { id: 'content', label: 'âœï¸ ì½˜í…ì¸ ', color: '#10B981', bg: '#D1FAE5' },
  { id: 'marketing', label: 'ğŸ“¢ ë§ˆì¼€íŒ…', color: '#8B5CF6', bg: '#EDE9FE' },
  { id: 'etc', label: 'ğŸ“ ê¸°íƒ€', color: '#6B7280', bg: '#F3F4F6' }
];

// ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜ì´ì§€ ë Œë”ë§
function renderReferenceLibrary() {
  var app = document.getElementById('app');
  var isAdmin = state.currentUser?.role === 'admin';

  app.innerHTML = `
    <div style="background: #F2F4F6; min-height: 100vh; margin: -24px; padding: 24px;">
      <!-- í—¤ë” -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h1 style="font-size: 26px; font-weight: 700; color: #191F28; margin: 0;">ğŸ“š ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬</h1>
          <p style="color: #6B7684; margin-top: 8px; font-size: 15px;">ì´ë²¤íŠ¸, ë””ìì¸, ì œì•ˆì„œ, ìˆí¼ ë“± ì—…ë¬´ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ëª¨ì•„ë‘ì„¸ìš”</p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="downloadReferenceTemplate()" style="padding: 12px 20px; font-size: 14px; font-weight: 600; background: white; color: #8B5CF6; border: 2px solid #8B5CF6; border-radius: 12px; cursor: pointer;">
            ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
          </button>
          <button onclick="openBulkReferenceModal()" style="padding: 12px 20px; font-size: 14px; font-weight: 600; background: #10B981; color: white; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
            ğŸ“¤ ì—‘ì…€ ì¼ê´„ë“±ë¡
          </button>
          <button onclick="openAddReferenceModal()" style="padding: 12px 24px; font-size: 14px; font-weight: 600; background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
            â• ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€
          </button>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ë° í•„í„° -->
      <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <input type="text" id="ref-search" placeholder="ğŸ” ë ˆí¼ëŸ°ìŠ¤ ê²€ìƒ‰..." oninput="filterReferences()" style="width: 100%; padding: 12px 16px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;" />
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="ref-category-filters">
            <button onclick="setRefCategoryFilter('all')" class="ref-cat-btn active" data-cat="all" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; background: #0064FF; color: white;">ì „ì²´</button>
            ${REFERENCE_CATEGORIES.map(c => '<button onclick="setRefCategoryFilter(&#39;'+c.id+'&#39;)" class="ref-cat-btn" data-cat="'+c.id+'" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; background: '+c.bg+'; color: '+c.color+';">'+c.label+'</button>').join('')}
          </div>
        </div>
      </div>

      <!-- ë ˆí¼ëŸ°ìŠ¤ ëª©ë¡ -->
      <div id="reference-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
        <div style="text-align: center; padding: 60px; grid-column: 1 / -1;">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  `;

  window.refCategoryFilter = 'all';
  window.refSearchQuery = '';
  loadReferences();
}

// ë ˆí¼ëŸ°ìŠ¤ ëª©ë¡ ë¡œë“œ
async function loadReferences() {
  try {
    var snapshot = await db.collection('references').orderBy('createdAt', 'desc').get();
    var references = [];
    snapshot.forEach(function(doc) {
      references.push({ id: doc.id, ...doc.data() });
    });
    window.allReferences = references;
    renderReferenceList(references);
  } catch (error) {
    console.error('ë ˆí¼ëŸ°ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
    document.getElementById('reference-list').innerHTML = '<div style="text-align: center; padding: 40px; color: #6B7684;">ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
  }
}

// ë ˆí¼ëŸ°ìŠ¤ í•„í„°ë§
function filterReferences() {
  var search = document.getElementById('ref-search')?.value.toLowerCase() || '';
  window.refSearchQuery = search;
  var filtered = (window.allReferences || []).filter(function(ref) {
    var matchCategory = window.refCategoryFilter === 'all' || ref.category === window.refCategoryFilter;
    var matchSearch = !search || ref.title.toLowerCase().includes(search) || (ref.description || '').toLowerCase().includes(search) || (ref.tags || []).some(function(t) { return t.toLowerCase().includes(search); });
    return matchCategory && matchSearch;
  });
  renderReferenceList(filtered);
}

// ì¹´í…Œê³ ë¦¬ í•„í„° ì„¤ì •
function setRefCategoryFilter(category) {
  window.refCategoryFilter = category;
  document.querySelectorAll('.ref-cat-btn').forEach(function(btn) {
    if (btn.dataset.cat === category) {
      btn.style.background = '#0064FF';
      btn.style.color = 'white';
    } else {
      var cat = REFERENCE_CATEGORIES.find(function(c) { return c.id === btn.dataset.cat; });
      if (cat) {
        btn.style.background = cat.bg;
        btn.style.color = cat.color;
      } else {
        btn.style.background = '#F2F4F6';
        btn.style.color = '#6B7684';
      }
    }
  });
  filterReferences();
}

// ë ˆí¼ëŸ°ìŠ¤ ëª©ë¡ ë Œë”ë§
function renderReferenceList(references) {
  var container = document.getElementById('reference-list');
  if (!container) return;

  if (references.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 60px; grid-column: 1 / -1; background: white; border-radius: 16px;"><div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div><div style="font-size: 18px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ë“±ë¡ëœ ë ˆí¼ëŸ°ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div><p style="color: #6B7684; margin-bottom: 20px;">ìƒˆë¡œìš´ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p><button onclick="openAddReferenceModal()" style="background: #8B5CF6; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600;">+ ì²« ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€</button></div>';
    return;
  }

  var html = '';
  references.forEach(function(ref) {
    var cat = REFERENCE_CATEGORIES.find(function(c) { return c.id === ref.category; }) || REFERENCE_CATEGORIES[6];
    var date = ref.createdAt ? ref.createdAt.substring(0, 10) : '';
    var tags = (ref.tags || []).slice(0, 3).map(function(tag) { return '<span style="font-size: 11px; padding: 4px 8px; background: #F2F4F6; color: #6B7684; border-radius: 4px;">#' + tag + '</span>'; }).join('');

    html += '<div onclick="openReferenceDetail(\'' + ref.id + '\')" style="background: white; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #E5E8EB;" onmouseover="this.style.borderColor=\'#8B5CF6\'; this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.borderColor=\'#E5E8EB\'; this.style.transform=\'none\'">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
    html += '<span style="font-size: 12px; padding: 4px 12px; background: ' + cat.bg + '; color: ' + cat.color + '; border-radius: 6px; font-weight: 600;">' + cat.label + '</span>';
    html += '<span style="font-size: 11px; color: #8B95A1;">' + date + '</span></div>';
    html += '<div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 8px; line-height: 1.4;">' + ref.title + '</div>';
    if (ref.description) html += '<div style="font-size: 13px; color: #6B7684; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">' + ref.description + '</div>';
    html += '<div style="display: flex; gap: 8px; flex-wrap: wrap;">';
    if (ref.linkUrl) html += '<span style="font-size: 11px; padding: 4px 10px; background: #E8F3FF; color: #0064FF; border-radius: 4px;">ğŸ”— ë§í¬</span>';
    if (ref.fileUrl) html += '<span style="font-size: 11px; padding: 4px 10px; background: #DCFCE7; color: #16A34A; border-radius: 4px;">ğŸ“ íŒŒì¼</span>';
    html += tags + '</div>';
    html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E5E8EB; font-size: 12px; color: #8B95A1;">ğŸ‘¤ ' + (ref.createdByName || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</div></div>';
  });

  container.innerHTML = html;
}

// ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€ ëª¨ë‹¬
function openAddReferenceModal(refId) {
  refId = refId || null;
  var modal = document.getElementById('modal');
  modal.className = 'modal active';
  var currentMember = getCurrentMember();
  var isEdit = !!refId;
  var catOptions = REFERENCE_CATEGORIES.map(function(c) { return '<option value="' + c.id + '">' + c.label + '</option>'; }).join('');

  modal.innerHTML = '<div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">' +
    '<h2 style="font-size: 20px; font-weight: 700; margin: 0;">' + (isEdit ? 'âœï¸ ë ˆí¼ëŸ°ìŠ¤ ìˆ˜ì •' : 'ğŸ“š ìƒˆ ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€') + '</h2>' +
    '<button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button></div>' +
    '<div style="display: grid; gap: 16px;">' +
    '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #333D4B;">ì œëª© *</label>' +
    '<input type="text" id="ref-title" placeholder="ë ˆí¼ëŸ°ìŠ¤ ì œëª©" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;" /></div>' +
    '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #333D4B;">ì¹´í…Œê³ ë¦¬ *</label>' +
    '<select id="ref-category" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;">' + catOptions + '</select></div>' +
    '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #333D4B;">ì„¤ëª…</label>' +
    '<textarea id="ref-description" placeholder="ë ˆí¼ëŸ°ìŠ¤ì— ëŒ€í•œ ì„¤ëª…" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea></div>' +
    '<div style="background: #E8F3FF; padding: 16px; border-radius: 10px;">' +
    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #0064FF;">ğŸ”— ë§í¬ URL</label>' +
    '<input type="url" id="ref-link" placeholder="https://..." style="width: 100%; padding: 12px; border: 1px solid #C7D2FE; border-radius: 10px; font-size: 14px; background: white;" />' +
    '<div style="font-size: 11px; color: #6B7684; margin-top: 6px;">ìœ íŠœë¸Œ, ì¸ìŠ¤íƒ€ê·¸ë¨, ì›¹ì‚¬ì´íŠ¸ ë“± ì™¸ë¶€ ë§í¬</div></div>' +
    '<div style="background: #DCFCE7; padding: 16px; border-radius: 10px;">' +
    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #16A34A;">ğŸ“ íŒŒì¼ URL</label>' +
    '<input type="url" id="ref-file" placeholder="êµ¬ê¸€ ë“œë¼ì´ë¸Œ, Dropbox ë“± íŒŒì¼ ê³µìœ  ë§í¬" style="width: 100%; padding: 12px; border: 1px solid #86EFAC; border-radius: 10px; font-size: 14px; background: white;" />' +
    '<div style="font-size: 11px; color: #6B7684; margin-top: 6px;">êµ¬ê¸€ ë“œë¼ì´ë¸Œ, Dropbox ë“±ì˜ ê³µìœ  ë§í¬ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</div></div>' +
    '<div><label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #333D4B;">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>' +
    '<input type="text" id="ref-tags" placeholder="ì˜ˆ: ë´„ì‹ ìƒ, í• ì¸ì´ë²¤íŠ¸, ì¸ìŠ¤íƒ€" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;" /></div></div>' +
    '<div style="display: flex; gap: 12px; margin-top: 24px;">' +
    '<button onclick="closeModal()" style="flex: 1; background: #F2F4F6; color: #333D4B; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;">ì·¨ì†Œ</button>' +
    '<button onclick="saveReference(\'' + (refId || '') + '\')" style="flex: 1; background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;">ì €ì¥í•˜ê¸°</button></div></div>';

  if (refId) loadReferenceForEdit(refId);
}

// ë ˆí¼ëŸ°ìŠ¤ ìˆ˜ì • ë°ì´í„° ë¡œë“œ
async function loadReferenceForEdit(refId) {
  try {
    var doc = await db.collection('references').doc(refId).get();
    if (doc.exists) {
      var ref = doc.data();
      document.getElementById('ref-title').value = ref.title || '';
      document.getElementById('ref-category').value = ref.category || 'etc';
      document.getElementById('ref-description').value = ref.description || '';
      document.getElementById('ref-link').value = ref.linkUrl || '';
      document.getElementById('ref-file').value = ref.fileUrl || '';
      document.getElementById('ref-tags').value = (ref.tags || []).join(', ');
    }
  } catch (error) {
    console.error('ë ˆí¼ëŸ°ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// ë ˆí¼ëŸ°ìŠ¤ ì €ì¥
async function saveReference(refId) {
  var title = document.getElementById('ref-title').value.trim();
  var category = document.getElementById('ref-category').value;
  var description = document.getElementById('ref-description').value.trim();
  var linkUrl = document.getElementById('ref-link').value.trim();
  var fileUrl = document.getElementById('ref-file').value.trim();
  var tagsStr = document.getElementById('ref-tags').value.trim();
  var tags = tagsStr ? tagsStr.split(',').map(function(t) { return t.trim(); }).filter(Boolean) : [];

  if (!title) { showToast('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!linkUrl && !fileUrl) { showToast('ë§í¬ ë˜ëŠ” íŒŒì¼ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  var currentMember = getCurrentMember();
  var now = new Date().toISOString();
  var data = { title: title, category: category, description: description, linkUrl: linkUrl || null, fileUrl: fileUrl || null, tags: tags, updatedAt: now };

  try {
    if (refId) {
      await db.collection('references').doc(refId).update(data);
      showToast('âœ… ë ˆí¼ëŸ°ìŠ¤ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
      data.createdAt = now;
      data.createdBy = currentMember.id;
      data.createdByName = currentMember.name;
      await db.collection('references').add(data);
      showToast('âœ… ë ˆí¼ëŸ°ìŠ¤ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    closeModal();
    loadReferences();
  } catch (error) {
    console.error('ë ˆí¼ëŸ°ìŠ¤ ì €ì¥ ì˜¤ë¥˜:', error);
    showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ë³´ê¸°
async function openReferenceDetail(refId) {
  try {
    var doc = await db.collection('references').doc(refId).get();
    if (!doc.exists) { showToast('ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

    var ref = { id: doc.id, ...doc.data() };
    var cat = REFERENCE_CATEGORIES.find(function(c) { return c.id === ref.category; }) || REFERENCE_CATEGORIES[6];
    var currentMember = getCurrentMember();
    var isAdmin = state.currentUser?.role === 'admin';
    var canEdit = isAdmin || ref.createdBy === currentMember.id;
    var tagsHtml = (ref.tags && ref.tags.length > 0) ? '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">' + ref.tags.map(function(tag) { return '<span style="font-size: 12px; padding: 6px 12px; background: #F2F4F6; color: #6B7684; border-radius: 6px;">#' + tag + '</span>'; }).join('') + '</div>' : '';

    var modal = document.getElementById('modal');
    modal.className = 'modal active';

    var html = '<div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">';
    html += '<span style="font-size: 13px; padding: 6px 14px; background: ' + cat.bg + '; color: ' + cat.color + '; border-radius: 8px; font-weight: 600;">' + cat.label + '</span>';
    html += '<button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button></div>';
    html += '<h2 style="font-size: 22px; font-weight: 700; color: #191F28; margin-bottom: 16px; line-height: 1.4;">' + ref.title + '</h2>';
    if (ref.description) html += '<div style="font-size: 15px; color: #333D4B; line-height: 1.7; margin-bottom: 20px; padding: 16px; background: #F2F4F6; border-radius: 10px;">' + ref.description + '</div>';
    if (ref.linkUrl) html += '<a href="' + ref.linkUrl + '" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #E8F3FF; border-radius: 12px; margin-bottom: 12px; text-decoration: none;" onmouseover="this.style.background=\'#DBEAFE\'" onmouseout="this.style.background=\'#E8F3FF\'"><span style="font-size: 24px;">ğŸ”—</span><div style="flex: 1; min-width: 0;"><div style="font-size: 14px; font-weight: 600; color: #0064FF;">ì™¸ë¶€ ë§í¬ ì—´ê¸°</div><div style="font-size: 12px; color: #6B7684; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + ref.linkUrl + '</div></div><span style="color: #0064FF;">â†’</span></a>';
    if (ref.fileUrl) html += '<a href="' + ref.fileUrl + '" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #DCFCE7; border-radius: 12px; margin-bottom: 12px; text-decoration: none;" onmouseover="this.style.background=\'#BBF7D0\'" onmouseout="this.style.background=\'#DCFCE7\'"><span style="font-size: 24px;">ğŸ“</span><div style="flex: 1; min-width: 0;"><div style="font-size: 14px; font-weight: 600; color: #16A34A;">íŒŒì¼ ë‹¤ìš´ë¡œë“œ/ì—´ê¸°</div><div style="font-size: 12px; color: #6B7684; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + ref.fileUrl + '</div></div><span style="color: #16A34A;">â†’</span></a>';
    html += tagsHtml;
    html += '<div style="padding: 16px; background: #FAFAFA; border-radius: 10px; font-size: 13px; color: #6B7684;"><div style="display: flex; justify-content: space-between;"><span>ğŸ‘¤ ë“±ë¡ì: ' + (ref.createdByName || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</span><span>ğŸ“… ' + (ref.createdAt ? ref.createdAt.substring(0, 10) : '') + '</span></div></div>';
    html += '<div style="display: flex; gap: 12px; margin-top: 20px;">';
    if (canEdit) {
      html += '<button onclick="openAddReferenceModal(\'' + ref.id + '\')" style="flex: 1; background: #0064FF; color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;">âœï¸ ìˆ˜ì •</button>';
      html += '<button onclick="deleteReference(\'' + ref.id + '\')" style="flex: 1; background: #F2F4F6; color: #EF4444; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;">ğŸ—‘ï¸ ì‚­ì œ</button>';
    } else {
      html += '<button onclick="closeModal()" style="flex: 1; background: #F2F4F6; color: #333D4B; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;">ë‹«ê¸°</button>';
    }
    html += '</div></div>';
    modal.innerHTML = html;
  } catch (error) {
    console.error('ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ì˜¤ë¥˜:', error);
    showToast('ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// ë ˆí¼ëŸ°ìŠ¤ ì‚­ì œ
async function deleteReference(refId) {
  if (!confirm('ì´ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('references').doc(refId).delete();
    showToast('ë ˆí¼ëŸ°ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    loadReferences();
  } catch (error) {
    console.error('ë ˆí¼ëŸ°ìŠ¤ ì‚­ì œ ì˜¤ë¥˜:', error);
    showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// ë ˆí¼ëŸ°ìŠ¤ ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
function downloadReferenceTemplate() {
  var catList = REFERENCE_CATEGORIES.map(function(c) { return c.id; }).join(', ');
  var ws = XLSX.utils.aoa_to_sheet([
    ['ì œëª©', 'ì¹´í…Œê³ ë¦¬', 'ì„¤ëª…', 'ë§í¬URL', 'íŒŒì¼URL', 'íƒœê·¸(ì‰¼í‘œêµ¬ë¶„)'],
    ['2024 ë´„ ì´ë²¤íŠ¸ ê¸°íšì•ˆ', 'event', 'ë´„ì‹œì¦Œ í”„ë¡œëª¨ì…˜ ê¸°íšì•ˆì…ë‹ˆë‹¤', 'https://docs.google.com/presentation/...', '', 'ë´„ì‹œì¦Œ, í”„ë¡œëª¨ì…˜, ê¸°íš'],
    ['ìƒí’ˆ ìƒì„¸í˜ì´ì§€ ë””ìì¸ ê°€ì´ë“œ', 'design', 'ìƒì„¸í˜ì´ì§€ ë””ìì¸ ì°¸ê³ ìš©', '', 'https://drive.google.com/file/...', 'ë””ìì¸, ìƒì„¸í˜ì´ì§€'],
    ['ìˆí¼ ì½˜í…ì¸  ëª¨ìŒ', 'shortform', 'ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ ì°¸ê³  ì˜ìƒ', 'https://www.instagram.com/reel/...', '', 'ìˆí¼, ë¦´ìŠ¤, ì¸ìŠ¤íƒ€'],
    ['ê³ ê° ì œì•ˆì„œ í…œí”Œë¦¿', 'proposal', 'ì‹ ê·œ ê³ ê° ì œì•ˆì„œ ì–‘ì‹', '', 'https://drive.google.com/file/...', 'ì œì•ˆì„œ, í…œí”Œë¦¿'],
    ['â€» ì¹´í…Œê³ ë¦¬ ì˜µì…˜: ' + catList, '', '', '', '', '']
  ]);

  ws['!cols'] = [
    { wch: 30 },
    { wch: 12 },
    { wch: 35 },
    { wch: 40 },
    { wch: 40 },
    { wch: 25 }
  ];

  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ë ˆí¼ëŸ°ìŠ¤');
  XLSX.writeFile(wb, 'ë ˆí¼ëŸ°ìŠ¤_ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx');
  showToast('ğŸ“¥ ì–‘ì‹ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ë ˆí¼ëŸ°ìŠ¤ ì¼ê´„ ë“±ë¡ ëª¨ë‹¬
var referenceExcelData = [];

function openBulkReferenceModal() {
  referenceExcelData = [];
  var modal = document.getElementById('modal');
  modal.className = 'modal active';
  var catList = REFERENCE_CATEGORIES.map(function(c) { return c.id + '(' + c.label + ')'; }).join(', ');

  modal.innerHTML = '<div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">' +
    '<h2 style="font-size: 20px; font-weight: 700; margin: 0;">ğŸ“¤ ë ˆí¼ëŸ°ìŠ¤ ì¼ê´„ ë“±ë¡</h2>' +
    '<button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7684;">Ã—</button></div>' +

    '<div style="background: #F0FDF4; border: 1px solid #86EFAC; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
    '<div style="font-size: 14px; font-weight: 600; color: #16A34A; margin-bottom: 8px;">ğŸ“‹ ì—‘ì…€ íŒŒì¼ ì–‘ì‹ ì•ˆë‚´</div>' +
    '<div style="font-size: 13px; color: #166534; line-height: 1.6;">' +
    'ì—´ ìˆœì„œ: <strong>ì œëª©, ì¹´í…Œê³ ë¦¬, ì„¤ëª…, ë§í¬URL, íŒŒì¼URL, íƒœê·¸</strong><br>' +
    'ì¹´í…Œê³ ë¦¬ ì˜µì…˜: <code style="background: #DCFCE7; padding: 2px 6px; border-radius: 4px;">' + catList + '</code><br>' +
    'ë§í¬URL ë˜ëŠ” íŒŒì¼URL ì¤‘ í•˜ë‚˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.</div></div>' +

    '<div style="margin-bottom: 20px;">' +
    '<label style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; border: 2px dashed #D1D5DB; border-radius: 12px; cursor: pointer; transition: all 0.2s;" ' +
    'onmouseover="this.style.borderColor=\'#8B5CF6\'; this.style.background=\'#F5F3FF\'" onmouseout="this.style.borderColor=\'#D1D5DB\'; this.style.background=\'white\'">' +
    '<input type="file" accept=".xlsx,.xls" onchange="handleReferenceExcelFile(this.files[0])" style="display: none;" />' +
    '<div style="font-size: 48px; margin-bottom: 12px;">ğŸ“</div>' +
    '<div style="font-size: 15px; font-weight: 600; color: #333D4B;">ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>' +
    '<div style="font-size: 13px; color: #6B7684; margin-top: 4px;">.xlsx, .xls í˜•ì‹</div></label></div>' +

    '<div id="ref-excel-preview" style="display: none; margin-bottom: 20px;">' +
    '<div style="font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #333D4B;">ğŸ“Š ë¯¸ë¦¬ë³´ê¸° <span id="ref-preview-count" style="color: #8B5CF6;"></span></div>' +
    '<div style="overflow-x: auto; border: 1px solid #E5E8EB; border-radius: 10px;">' +
    '<table id="ref-preview-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">' +
    '<thead style="background: #F9FAFB;"></thead>' +
    '<tbody></tbody></table></div></div>' +

    '<div style="display: flex; gap: 12px;">' +
    '<button onclick="downloadReferenceTemplate()" style="flex: 1; background: white; color: #8B5CF6; border: 2px solid #8B5CF6; padding: 14px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>' +
    '<button onclick="submitBulkReferences()" id="btn-submit-bulk-refs" style="flex: 1; background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;" disabled>ì¼ê´„ ë“±ë¡í•˜ê¸°</button></div></div>';
}

// ë ˆí¼ëŸ°ìŠ¤ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
function handleReferenceExcelFile(file) {
  if (!file) return;

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, { type: 'array' });
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      var headers = jsonData[0].map(function(h) { return String(h || '').trim(); });
      var rows = jsonData.slice(1).filter(function(row) { return row.some(function(cell) { return cell; }); });

      // ì—´ ë§¤í•‘ (ìœ ì—°í•˜ê²Œ ë§¤í•‘)
      var colMap = {
        title: headers.findIndex(function(h) { return h.includes('ì œëª©') || h.toLowerCase().includes('title'); }),
        category: headers.findIndex(function(h) { return h.includes('ì¹´í…Œê³ ë¦¬') || h.toLowerCase().includes('category'); }),
        description: headers.findIndex(function(h) { return h.includes('ì„¤ëª…') || h.toLowerCase().includes('description') || h.toLowerCase().includes('desc'); }),
        linkUrl: headers.findIndex(function(h) { return h.includes('ë§í¬') || h.toLowerCase().includes('link'); }),
        fileUrl: headers.findIndex(function(h) { return h.includes('íŒŒì¼') || h.toLowerCase().includes('file'); }),
        tags: headers.findIndex(function(h) { return h.includes('íƒœê·¸') || h.toLowerCase().includes('tag'); })
      };

      // ì²« ë²ˆì§¸ ì—´ì´ ì œëª©ì´ë©´ ê¸°ë³¸ ìˆœì„œëŒ€ë¡œ ë§¤í•‘
      if (colMap.title < 0) colMap.title = 0;
      if (colMap.category < 0) colMap.category = 1;
      if (colMap.description < 0) colMap.description = 2;
      if (colMap.linkUrl < 0) colMap.linkUrl = 3;
      if (colMap.fileUrl < 0) colMap.fileUrl = 4;
      if (colMap.tags < 0) colMap.tags = 5;

      var validCategories = REFERENCE_CATEGORIES.map(function(c) { return c.id; });

      referenceExcelData = rows.map(function(row) {
        var title = colMap.title >= 0 ? String(row[colMap.title] || '').trim() : '';
        var category = colMap.category >= 0 ? String(row[colMap.category] || '').trim().toLowerCase() : '';
        var description = colMap.description >= 0 ? String(row[colMap.description] || '').trim() : '';
        var linkUrl = colMap.linkUrl >= 0 ? String(row[colMap.linkUrl] || '').trim() : '';
        var fileUrl = colMap.fileUrl >= 0 ? String(row[colMap.fileUrl] || '').trim() : '';
        var tagsStr = colMap.tags >= 0 ? String(row[colMap.tags] || '').trim() : '';

        // ì¹´í…Œê³ ë¦¬ê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ 'etc'ë¡œ ì„¤ì •
        if (!validCategories.includes(category)) category = 'etc';

        return {
          title: title,
          category: category,
          description: description,
          linkUrl: linkUrl,
          fileUrl: fileUrl,
          tags: tagsStr ? tagsStr.split(',').map(function(t) { return t.trim(); }).filter(Boolean) : []
        };
      }).filter(function(item) {
        // ì œëª©ì´ ìˆê³ , ë§í¬ ë˜ëŠ” íŒŒì¼URLì´ ìˆëŠ” í•­ëª©ë§Œ
        return item.title && (item.linkUrl || item.fileUrl);
      });

      // ì•ˆë‚´ í–‰ ì œì™¸ (ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì„¤ëª… í–‰)
      referenceExcelData = referenceExcelData.filter(function(item) {
        return !item.title.includes('â€»') && !item.title.includes('ì¹´í…Œê³ ë¦¬ ì˜µì…˜');
      });

      // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
      var previewDiv = document.getElementById('ref-excel-preview');
      var countSpan = document.getElementById('ref-preview-count');
      var thead = document.querySelector('#ref-preview-table thead');
      var tbody = document.querySelector('#ref-preview-table tbody');
      var submitBtn = document.getElementById('btn-submit-bulk-refs');

      if (referenceExcelData.length === 0) {
        showToast('ìœ íš¨í•œ ë ˆí¼ëŸ°ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì œëª©ê³¼ ë§í¬/íŒŒì¼URLì„ í™•ì¸í•˜ì„¸ìš”.');
        previewDiv.style.display = 'none';
        submitBtn.disabled = true;
        return;
      }

      countSpan.textContent = '(' + referenceExcelData.length + 'ê°œ)';
      thead.innerHTML = '<tr><th style="padding: 12px; text-align: left; border-bottom: 1px solid #E5E8EB;">ì œëª©</th><th style="padding: 12px; text-align: left; border-bottom: 1px solid #E5E8EB;">ì¹´í…Œê³ ë¦¬</th><th style="padding: 12px; text-align: left; border-bottom: 1px solid #E5E8EB;">ì„¤ëª…</th><th style="padding: 12px; text-align: left; border-bottom: 1px solid #E5E8EB;">ë§í¬</th><th style="padding: 12px; text-align: left; border-bottom: 1px solid #E5E8EB;">íŒŒì¼</th><th style="padding: 12px; text-align: left; border-bottom: 1px solid #E5E8EB;">íƒœê·¸</th></tr>';

      var previewRows = referenceExcelData.slice(0, 10).map(function(r) {
        var cat = REFERENCE_CATEGORIES.find(function(c) { return c.id === r.category; }) || REFERENCE_CATEGORIES[6];
        return '<tr>' +
          '<td style="padding: 10px; border-bottom: 1px solid #F2F4F6; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + r.title + '</td>' +
          '<td style="padding: 10px; border-bottom: 1px solid #F2F4F6;"><span style="font-size: 11px; padding: 3px 8px; background: ' + cat.bg + '; color: ' + cat.color + '; border-radius: 4px;">' + cat.label + '</span></td>' +
          '<td style="padding: 10px; border-bottom: 1px solid #F2F4F6; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + (r.description || '-') + '</td>' +
          '<td style="padding: 10px; border-bottom: 1px solid #F2F4F6;">' + (r.linkUrl ? 'ğŸ”—' : '-') + '</td>' +
          '<td style="padding: 10px; border-bottom: 1px solid #F2F4F6;">' + (r.fileUrl ? 'ğŸ“' : '-') + '</td>' +
          '<td style="padding: 10px; border-bottom: 1px solid #F2F4F6; font-size: 11px; color: #6B7684;">' + (r.tags.length > 0 ? r.tags.slice(0, 2).map(function(t) { return '#' + t; }).join(' ') : '-') + '</td>' +
          '</tr>';
      }).join('');

      if (referenceExcelData.length > 10) {
        previewRows += '<tr><td colspan="6" style="text-align: center; padding: 12px; color: #6B7684;">... ì™¸ ' + (referenceExcelData.length - 10) + 'ê°œ</td></tr>';
      }

      tbody.innerHTML = previewRows;
      previewDiv.style.display = 'block';
      submitBtn.disabled = false;

      showToast(referenceExcelData.length + 'ê°œì˜ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');

    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ë ˆí¼ëŸ°ìŠ¤ ì¼ê´„ ë“±ë¡ ì‹¤í–‰
async function submitBulkReferences() {
  if (referenceExcelData.length === 0) {
    showToast('ë“±ë¡í•  ë ˆí¼ëŸ°ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  var submitBtn = document.getElementById('btn-submit-bulk-refs');
  submitBtn.disabled = true;
  submitBtn.textContent = 'ë“±ë¡ ì¤‘...';

  var currentMember = getCurrentMember();
  var now = new Date().toISOString();
  var successCount = 0;
  var errorCount = 0;

  for (var i = 0; i < referenceExcelData.length; i++) {
    var item = referenceExcelData[i];
    try {
      await db.collection('references').add({
        title: item.title,
        category: item.category,
        description: item.description,
        linkUrl: item.linkUrl || null,
        fileUrl: item.fileUrl || null,
        tags: item.tags,
        createdAt: now,
        createdBy: currentMember.id,
        createdByName: currentMember.name,
        updatedAt: now
      });
      successCount++;
    } catch(e) {
      console.error('ë ˆí¼ëŸ°ìŠ¤ ë“±ë¡ ì˜¤ë¥˜:', e);
      errorCount++;
    }
  }

  referenceExcelData = [];

  if (errorCount > 0) {
    showToast(successCount + 'ê°œ ë“±ë¡ ì™„ë£Œ, ' + errorCount + 'ê°œ ì‹¤íŒ¨');
  } else {
    showToast('âœ… ' + successCount + 'ê°œì˜ ë ˆí¼ëŸ°ìŠ¤ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
  }

  closeModal();
  loadReferences();
}

</script>

</body>
</html>

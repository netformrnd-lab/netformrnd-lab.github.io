<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì—¬ë¼ë”œ - ê´€ë¦¬ì ì‹œìŠ¤í…œ</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      /* ëª¨ì—¬ë¼ë”œ ë©”ì¸ ì»¬ëŸ¬ */
      --primary: #fc9600;
      --primary-light: #fff8f0;
      --primary-dark: #e08600;
      --white: #ffffff;
      /* í† ìŠ¤ ìŠ¤íƒ€ì¼ - ì±„ë„ ë‚®ì€ ë°ì€ ê·¸ë ˆì´ */
      --gray-900: #191f28;
      --gray-800: #333d4b;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      /* ìƒíƒœ ìƒ‰ìƒ - ë¶€ë“œëŸ¬ìš´ í†¤ */
      --success: #00c073;
      --success-light: #e8f7f0;
      --warning: #fc9600;
      --warning-light: #fff8f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --info: #3182f6;
      --info-light: #eef4ff;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      min-height: 100vh; 
      background: var(--gray-100);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    /* ë¡œê·¸ì¸ í™”ë©´ */
    .login-screen {
      min-height: 100vh;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-container {
      width: 100%;
      max-width: 400px;
    }
    
    .login-logo {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .login-logo img {
      height: 48px;
    }
    
    .login-logo-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-top: 8px;
    }
    
    .login-card {
      background: var(--white);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    
    .login-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      color: var(--gray-900);
    }
    
    .login-error {
      background: var(--danger-light);
      border: 1px solid #fecaca;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }
    
    .login-error.show {
      display: block;
    }
    
    .login-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
      margin-bottom: 12px;
    }
    
    .login-input:focus {
      outline: none;
      border-color: var(--gray-400);
      box-shadow: 0 0 0 3px var(--gray-100);
    }
    
    .login-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: var(--gray-900);
      color: var(--white);
      font-family: inherit;
      transition: all 0.15s ease;
    }
    
    .login-btn:hover {
      background: var(--gray-800);
    }
    
    .login-btn.loading {
      position: relative;
      color: transparent;
      pointer-events: none;
    }
    
    .login-btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ë ˆì´ì•„ì›ƒ */
    .app-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 220px;
      background: var(--white);
      border-right: 1px solid var(--gray-200);
      padding: 20px 12px;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      margin-bottom: 24px;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .logo-text {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .nav-section {
      margin-bottom: 20px;
    }
    
    .nav-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 12px;
      margin-bottom: 6px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
    }
    
    .nav-item:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }
    
    .nav-item.active {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }
    
    .nav-item .icon {
      width: 18px;
      text-align: center;
      font-size: 14px;
    }
    
    .inquiry-badge {
      background: var(--danger);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: auto;
    }
    
    /* ë©”ì¸ ì»¨í…ì¸  */
    .main-content {
      flex: 1;
      margin-left: 220px;
      padding: 28px 32px;
      max-width: 1400px;
    }
    
    /* í—¤ë” */
    .page-header {
      margin-bottom: 24px;
    }
    
    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    
    .page-desc {
      font-size: 14px;
      color: var(--gray-500);
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    
    /* ë²„íŠ¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--white);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }
    
    .btn-secondary:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
    }
    
    .btn-ghost:hover {
      background: var(--gray-100);
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
    }
    
    /* ì¹´ë“œ */
    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
    }
    
    /* í†µê³„ ì¹´ë“œ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: 10px;
      padding: 16px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 6px;
    }
    
    .stat-value {
      font-size: 26px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .stat-card.highlight {
      background: var(--primary);
    }
    
    .stat-card.highlight .stat-label,
    .stat-card.highlight .stat-value {
      color: var(--white);
    }
    
    /* ì•Œë¦¼ ë°°ë„ˆ */
    .alert {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .alert-warning {
      background: var(--warning-light);
      color: #b45309;
    }
    
    .alert-danger {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .alert-info {
      background: var(--gray-100);
      color: var(--gray-700);
    }
    
    /* í•„í„° ë°” */
    .filter-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      background: var(--gray-100);
      border-radius: 6px;
      padding: 3px;
    }
    
    .filter-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    
    .filter-btn.active {
      background: var(--white);
      color: var(--gray-900);
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    
    /* ìº˜ë¦°ë” */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .calendar-nav button {
      width: 32px;
      height: 32px;
      border: 1px solid var(--gray-200);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      color: var(--gray-600);
      transition: all 0.15s ease;
    }
    
    .calendar-nav button:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }
    
    .calendar-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
      min-width: 140px;
      text-align: center;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    
    .calendar-weekday {
      text-align: center;
      padding: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-500);
    }
    
    .calendar-weekday:first-child { color: var(--danger); }
    .calendar-weekday:last-child { color: var(--info); }
    
    .calendar-day {
      min-height: 90px;
      padding: 8px;
      background: var(--white);
      border: 1px solid var(--gray-100);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }
    
    .calendar-day:hover {
      border-color: var(--gray-300);
    }
    
    .calendar-day.other-month {
      opacity: 0.4;
      background: var(--gray-50);
    }
    
    .calendar-day.today {
      border-color: var(--primary);
      background: var(--primary-light);
    }
    
    .calendar-day.today .day-number {
      background: var(--primary);
      color: var(--white);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .day-number {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    
    .calendar-day.sunday .day-number { color: var(--danger); }
    .calendar-day.saturday .day-number { color: var(--info); }
    .calendar-day.today .day-number { color: var(--white); }
    
    /* ê³µêµ¬ ë±ƒì§€ */
    .deal-badge {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 4px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    
    .deal-badge:hover {
      transform: translateX(2px);
    }
    
    .deal-badge.supplier {
      background: var(--info-light);
      color: var(--info);
    }
    
    .deal-badge.seller {
      background: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .deal-badge.both {
      background: var(--success-light);
      color: var(--success);
    }
    
    /* ë²”ë¡€ */
    .legend {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--gray-500);
    }
    
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
    }
    
    .legend-dot.supplier { background: var(--info); }
    .legend-dot.seller { background: var(--primary); }
    .legend-dot.both { background: var(--success); }
    
    /* ê³µêµ¬ ë¦¬ìŠ¤íŠ¸ */
    .deal-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .deal-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .deal-item:hover {
      border-color: var(--gray-300);
      background: var(--gray-50);
    }
    
    .deal-color {
      width: 3px;
      height: 40px;
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .deal-color.negotiating { background: var(--gray-400); }
    .deal-color.confirmed { background: var(--info); }
    .deal-color.ongoing { background: var(--success); }
    .deal-color.completed { background: var(--gray-300); }
    
    .deal-info {
      flex: 1;
      min-width: 0;
    }
    
    .deal-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 2px;
    }
    
    .deal-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--gray-500);
    }
    
    .deal-status {
      flex-shrink: 0;
    }
    
    /* ìƒíƒœ ë±ƒì§€ */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-negotiating { background: var(--gray-100); color: var(--gray-600); }
    .status-confirmed { background: var(--info-light); color: var(--info); }
    .status-ongoing { background: var(--success-light); color: var(--success); }
    .status-completed { background: var(--gray-100); color: var(--gray-400); }
    
    /* ì •ì‚° ì²´í¬ */
    .settlement-badges {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    
    .settlement-badge {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .settlement-badge.pending {
      background: var(--gray-100);
      color: var(--gray-500);
    }
    
    .settlement-badge.done {
      background: var(--success-light);
      color: var(--success);
    }
    
    /* í…Œì´ë¸” */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--gray-100);
      font-size: 13px;
    }
    
    .data-table th {
      font-weight: 600;
      color: var(--gray-500);
      font-size: 12px;
      background: var(--gray-50);
    }
    
    .data-table tr:hover td {
      background: var(--gray-50);
    }
    
    .data-table .actions {
      display: flex;
      gap: 6px;
    }
    
    /* í¼ */
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 6px;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      color: var(--gray-900);
      background: var(--white);
      transition: all 0.15s ease;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--gray-400);
      box-shadow: 0 0 0 3px var(--gray-100);
    }
    
    .form-input::placeholder {
      color: var(--gray-400);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    /* ëª¨ë‹¬ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--white);
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.2s ease;
    }
    
    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    
    .modal-close:hover {
      background: var(--gray-200);
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-100);
    }
    
    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background: var(--gray-900);
      color: var(--white);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 9999;
      display: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    /* ì²´í¬ë°•ìŠ¤ ì»¤ìŠ¤í…€ */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--gray-50);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid var(--gray-200);
    }
    
    .checkbox-wrapper:hover {
      background: var(--gray-100);
    }
    
    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--gray-900);
      cursor: pointer;
    }
    
    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 13px;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.15s ease;
      opacity: 0.5;
    }
    
    .btn-icon:hover {
      background: var(--gray-100);
      opacity: 1;
    }
    
    .btn-icon.has-notes {
      opacity: 1;
      background: var(--gray-100);
    }
    
    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--gray-500);
    }
    
    .empty-state .icon {
      font-size: 40px;
      margin-bottom: 12px;
    }
    
    .empty-state .text {
      font-size: 14px;
    }
    
    /* ë¡œë”© */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-100);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ì„ íƒ ë“œë¡­ë‹¤ìš´ */
    .select-wrapper {
      position: relative;
    }
    
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238b95a1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 44px;
    }
    
    /* ë„ì›€ë§ íˆ´íŒ */
    .help-tooltip-wrapper:hover .help-tooltip-content {
      display: block !important;
    }
    
    .help-tooltip-btn:hover {
      background: var(--gray-100) !important;
      border-color: var(--gray-400) !important;
      color: var(--gray-700) !important;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 1200px) {
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
      
      .main-content {
        margin-left: 0;
        padding: 20px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }
  </style>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-logo">
        <img src="logo-horizontal.png" alt="ëª¨ì—¬ë¼ë”œ">
        <div class="login-logo-desc">ê´€ë¦¬ì ì „ìš©</div>
      </div>
      
      <div class="login-card">
        <div class="login-title">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</div>
        
        <div id="admin-login-error" class="login-error">
          ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
        
        <form onsubmit="handleAdminLogin(event)">
          <input type="text" class="login-input" id="admin-login-id" placeholder="ì•„ì´ë””" required>
          <input type="password" class="login-input" id="admin-login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; cursor: pointer; font-size: 13px; color: var(--gray-600);">
            <input type="checkbox" id="admin-remember-me" style="width: 16px; height: 16px; cursor: pointer;">
            ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥
          </label>
          <button type="submit" class="login-btn" id="admin-login-btn">ë¡œê·¸ì¸</button>
        </form>
        
        <div style="text-align: center; margin-top: 16px; font-size: 12px; color: var(--gray-400);">
          íŒ€ì› ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”
        </div>
      </div>
    </div>
  </div>

  <!-- ë©”ì¸ ì•± (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
  <div id="app-wrapper" style="display: none;">
    <div class="app-container">
      <aside class="sidebar">
        <div class="logo">
          <img src="logo-horizontal.png" alt="ëª¨ì—¬ë¼ë”œ" style="height: 28px;">
        </div>
        
        <nav>
          <!-- ì˜ì—…í˜„í™© (ë§¨ ìœ„) -->
          <div class="nav-section" style="margin-bottom: 12px;">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #1e40af, #3b82f6); padding: 12px 14px; border-radius: 10px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);" onclick="switchTab('salesDashboard')">
              <span style="font-weight: 600; color: white;">ì˜ì—…í˜„í™©</span>
              <span style="color: rgba(255,255,255,0.7);">â†’</span>
            </div>
          </div>
          
          <!-- ê³µêµ¬ê´€ë¦¬ ì„¹ì…˜ (ê³µêµ¬ì„¼í„° í†µí•©) -->
          <div class="nav-section">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: #e5e7eb; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px;" onclick="toggleDealMenu()">
              <span style="font-weight: 600; color: var(--gray-700);">ê³µêµ¬ê´€ë¦¬</span>
              <span id="deal-menu-arrow" style="transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
            </div>
            <div id="deal-submenu" style="display: block; padding-left: 8px;">
              <div class="nav-item active" data-tab="calendar" onclick="switchTab('calendar')" style="font-size: 13px;">
                <span>ìº˜ë¦°ë”</span>
              </div>
              <div class="nav-item" data-tab="dealManagement" onclick="switchTab('dealManagement')" style="font-size: 13px;">
                <span>ì§„í–‰ ì¤‘ ê³µêµ¬</span>
              </div>
              <div class="nav-item" data-tab="dealCenter" onclick="switchTab('dealCenter')" style="font-size: 13px;">
                <span>ê³µêµ¬ì œì•ˆ/ê¸´ê¸‰ìš”ì²­</span>
              </div>
            </div>
          </div>
          
          <!-- íŒŒíŠ¸ë„ˆ ê´€ë¦¬ ì„¹ì…˜ (ì—´ë¦° ìƒíƒœ) -->
          <div class="nav-section">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: #e5e7eb; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px;" onclick="togglePartnerMenu()">
              <span style="font-weight: 600; color: var(--gray-700);">íŒŒíŠ¸ë„ˆ ê´€ë¦¬</span>
              <span id="partner-menu-arrow" style="transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
            </div>
            <div id="partner-submenu" style="display: block;">
              
              <!-- ê³µê¸‰ì‚¬ ê´€ë¦¬ (3ì¤‘ í•˜ìœ„, ì—´ë¦° ìƒíƒœ) -->
              <div style="padding-left: 8px;">
                <div class="nav-item" style="font-size: 13px; background: #f3f4f6; border-radius: 4px; margin-bottom: 2px;" onclick="toggleSupplierMenu(event)">
                  <span style="color: var(--gray-600); font-weight: 500;">ê³µê¸‰ì‚¬ ê´€ë¦¬</span>
                  <span id="supplier-menu-arrow" style="margin-left: auto; font-size: 10px; transition: transform 0.2s; transform: rotate(90deg);">â–¶</span>
                </div>
                <div id="supplier-submenu" style="display: block; padding-left: 20px;">
                  <div class="nav-item" data-tab="suppliers" onclick="switchTab('suppliers')" style="font-size: 13px;">
                    <span>ê³µê¸‰ì‚¬</span>
                  </div>
                  <div class="nav-item" data-tab="productDB" onclick="switchTab('productDB')" style="font-size: 13px;">
                    <span>ê³µê¸‰ì‚¬ ìƒí’ˆ DB</span>
                  </div>
                </div>
              </div>
              
              <!-- ì…€ëŸ¬ ê´€ë¦¬ (3ì¤‘ í•˜ìœ„, ì—´ë¦° ìƒíƒœ) -->
              <div style="padding-left: 8px;">
                <div class="nav-item" style="font-size: 13px; background: #f3f4f6; border-radius: 4px; margin-bottom: 2px;" onclick="toggleSellerMenu(event)">
                  <span style="color: var(--gray-600); font-weight: 500;">ì…€ëŸ¬ ê´€ë¦¬</span>
                  <span id="seller-menu-arrow" style="margin-left: auto; font-size: 10px; transition: transform 0.2s; transform: rotate(90deg);">â–¶</span>
                </div>
                <div id="seller-submenu" style="display: block; padding-left: 20px;">
                  <div class="nav-item" data-tab="sellers" onclick="switchTab('sellers')" style="font-size: 13px;">
                    <span>ì…€ëŸ¬</span>
                  </div>
                  <div class="nav-item" data-tab="sellerList" onclick="switchTab('sellerList')" style="font-size: 13px;">
                    <span>ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</span>
                  </div>
                </div>
              </div>
              
              <!-- íŒŒíŠ¸ë„ˆ ê³„ì • ê´€ë¦¬ -->
              <div style="padding-left: 8px;">
                <div class="nav-item" data-tab="shareLinks" onclick="switchTab('shareLinks')" style="font-size: 13px;">
                  <span>íŒŒíŠ¸ë„ˆ ê³„ì •ê´€ë¦¬</span>
                </div>
              </div>
              
              <!-- ê³µì§€ì‚¬í•­ ê´€ë¦¬ -->
              <div style="padding-left: 8px;">
                <div class="nav-item" data-tab="partnerNotices" onclick="switchTab('partnerNotices')" style="font-size: 13px;">
                  <span>ê³µì§€ì‚¬í•­ ê´€ë¦¬</span>
                </div>
              </div>
              
            </div>
          </div>
          
          <!-- ê´€ë¦¬ì ì„¹ì…˜ (ë‹«íŒ ìƒíƒœ, ë¹„ë°€ë²ˆí˜¸ í•„ìš”) -->
          <div class="nav-section" style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--gray-300);">
            <div class="nav-label" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #374151, #4b5563); padding: 10px 14px; border-radius: 8px; margin-bottom: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" onclick="toggleAdminMenu()">
              <span style="font-weight: 600; color: white;">ê´€ë¦¬ì ğŸ”</span>
              <span id="admin-menu-arrow" style="transition: transform 0.2s; color: white;">â–¼</span>
            </div>
            <div id="admin-submenu" style="display: none; padding-left: 8px; background: #f9fafb; border-radius: 8px; padding: 8px; margin-top: 4px;">
              <div class="nav-item" data-tab="teamMembers" onclick="switchTab('teamMembers')" style="font-size: 13px;">
                <span>íŒ€ì› ê´€ë¦¬</span>
              </div>
              <div class="nav-item" data-tab="salesReport" onclick="switchTab('salesReport')" style="font-size: 13px;">
                <span>ë§¤ì¶œê´€ë¦¬</span>
              </div>
              <div class="nav-item" data-tab="dataUsage" onclick="switchTab('dataUsage')" style="font-size: 13px;">
                <span>ë°ì´í„° ì‚¬ìš©ëŸ‰</span>
              </div>
              <div style="border-top: 1px dashed var(--gray-300); margin: 8px 0;"></div>
              <div class="nav-item" onclick="toggleAdvancedAdminMenu()" style="font-size: 12px; color: var(--gray-500); padding: 6px 12px;">
                <span>ê³ ê¸‰ ì„¤ì • â–¼</span>
              </div>
              <div id="advanced-admin-submenu" style="display: none; padding-left: 12px;">
                <div class="nav-item" onclick="openAdminSettings()" style="font-size: 12px; color: var(--gray-500);">
                  <span>ì‹œìŠ¤í…œ ì„¤ì •</span>
                </div>
                <div class="nav-item" onclick="exportAllData()" style="font-size: 12px; color: var(--gray-500);">
                  <span>ë°ì´í„° ë°±ì—…</span>
                </div>
                <div class="nav-item" onclick="openRestoreModal()" style="font-size: 12px; color: var(--gray-500);">
                  <span>ë°ì´í„° ë³µì›</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ë¡œê·¸ì•„ì›ƒ -->
          <div class="nav-section" style="margin-top: auto; padding-top: 12px;">
            <div class="nav-item" onclick="handleAdminLogout()" style="color: var(--gray-500);">
              <span>ë¡œê·¸ì•„ì›ƒ</span>
            </div>
          </div>
        </nav>
      </aside>
      
      <main class="main-content">
        <div id="app"></div>
      </main>
    </div>
  </div>
  
  <div class="toast" id="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>
  <div class="modal" id="modal"></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
// ========== ê´€ë¦¬ì ë¡œê·¸ì¸ ==========
// EmailJS ì„¤ì • (https://www.emailjs.com ì—ì„œ ë¬´ë£Œ ê°€ì… í›„ ì„¤ì •)
const EMAILJS_CONFIG = {
  publicKey: 'YOUR_PUBLIC_KEY',      // EmailJS Public Key
  serviceId: 'YOUR_SERVICE_ID',      // EmailJS Service ID  
  templateId: 'YOUR_TEMPLATE_ID'     // EmailJS Template ID
};

// ê´€ë¦¬ì ì´ë©”ì¼ (ì¸ì¦ë²ˆí˜¸ ë°›ì„ ì´ë©”ì¼)
const ADMIN_EMAIL = 'songhee44@netformrnd.com';

// ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ (Firebaseì— ì €ì¥ëœ ê°’ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
const DEFAULT_PASSWORD = 'ahdufk124!';
let adminPassword = DEFAULT_PASSWORD;
let verificationCode = '';

// Firebaseì—ì„œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë¡œë“œ
async function loadAdminPassword() {
  try {
    const doc = await db.collection('settings').doc('admin').get();
    if (doc.exists && doc.data().password) {
      adminPassword = doc.data().password;
      console.log('Firebase ë¹„ë°€ë²ˆí˜¸ ë¡œë“œë¨');
    } else {
      adminPassword = DEFAULT_PASSWORD;
      console.log('ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš© (Firebaseì— ì—†ìŒ)');
    }
  } catch (e) {
    adminPassword = DEFAULT_PASSWORD;
    console.log('ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš© (Firebase ì˜¤ë¥˜)');
  }
}

// ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
function checkLoginStatus() {
  const isLoggedIn = sessionStorage.getItem('moyeora_admin_logged_in') === 'true';
  if (isLoggedIn) {
    showApp();
  } else {
    showLogin();
  }
}

// ìˆ«ì í¬ë§· (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
function formatNumber(num) {
  if (num === null || num === undefined) return '0';
  return Number(num).toLocaleString('ko-KR');
}

function showLogin() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app-wrapper').style.display = 'none';
  
  // ë§ˆì§„ê³„ì‚°ê¸° FAB ìˆ¨ê¸°ê¸°
  const fab = document.getElementById('margin-calc-fab');
  const fabLabel = document.getElementById('margin-calc-label');
  if (fab) fab.style.display = 'none';
  if (fabLabel) fabLabel.style.display = 'none';
  
  // ì €ì¥ëœ ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ë³µì›
  setTimeout(() => {
    const savedId = localStorage.getItem('moyeora_admin_saved_id');
    const savedPw = localStorage.getItem('moyeora_admin_saved_pw');
    const remember = localStorage.getItem('moyeora_admin_remember');
    
    if (remember === 'true' && savedId && savedPw) {
      const idInput = document.getElementById('admin-login-id');
      const pwInput = document.getElementById('admin-login-pw');
      const rememberCheckbox = document.getElementById('admin-remember-me');
      
      if (idInput) idInput.value = savedId;
      if (pwInput) pwInput.value = savedPw;
      if (rememberCheckbox) rememberCheckbox.checked = true;
    }
  }, 100);
}

function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-wrapper').style.display = 'block';
  
  // ë§ˆì§„ê³„ì‚°ê¸° FAB ë³´ì´ê¸°
  const fab = document.getElementById('margin-calc-fab');
  const fabLabel = document.getElementById('margin-calc-label');
  if (fab) fab.style.display = 'flex';
  if (fabLabel) fabLabel.style.display = 'block';
  
  // ë¡œê·¸ì¸ ì‚¬ìš©ì ë³µì›
  const savedUser = sessionStorage.getItem('moyeora_admin_user');
  if (savedUser) {
    try {
      state.currentAdmin = JSON.parse(savedUser);
      state.currentUser = state.currentAdmin;
    } catch (e) {}
  }
}

async function handleAdminLogin(e) {
  e.preventDefault();
  
  const loginId = document.getElementById('admin-login-id').value.trim();
  const loginPw = document.getElementById('admin-login-pw').value;
  const rememberMe = document.getElementById('admin-remember-me').checked;
  const loginBtn = document.getElementById('admin-login-btn');
  const errorMsg = document.getElementById('admin-login-error');
  
  // ì—ëŸ¬ ìˆ¨ê¸°ê¸°
  errorMsg.classList.remove('show');
  
  // ë¡œë”© ìƒíƒœ
  loginBtn.classList.add('loading');
  
  // ì•½ê°„ì˜ ë”œë ˆì´ (UX)
  await new Promise(r => setTimeout(r, 300));
  
  // ë§ˆìŠ¤í„° ê³„ì • í™•ì¸
  if (loginId === 'admin' && loginPw === 'ahdufk124!') {
    // ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥
    if (rememberMe) {
      localStorage.setItem('moyeora_admin_saved_id', loginId);
      localStorage.setItem('moyeora_admin_saved_pw', loginPw);
      localStorage.setItem('moyeora_admin_remember', 'true');
    } else {
      localStorage.removeItem('moyeora_admin_saved_id');
      localStorage.removeItem('moyeora_admin_saved_pw');
      localStorage.removeItem('moyeora_admin_remember');
    }
    sessionStorage.setItem('moyeora_admin_logged_in', 'true');
    sessionStorage.setItem('moyeora_admin_user', JSON.stringify({ id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin' }));
    state.currentAdmin = { id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin' };
    state.currentUser = state.currentAdmin;
    showApp();
    return;
  }
  
  // íŒ€ì› ê³„ì • í™•ì¸
  const teamMember = state.teamMembers.find(m => m.loginId === loginId && m.loginPw === loginPw);
  
  if (teamMember) {
    // ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥
    if (rememberMe) {
      localStorage.setItem('moyeora_admin_saved_id', loginId);
      localStorage.setItem('moyeora_admin_saved_pw', loginPw);
      localStorage.setItem('moyeora_admin_remember', 'true');
    } else {
      localStorage.removeItem('moyeora_admin_saved_id');
      localStorage.removeItem('moyeora_admin_saved_pw');
      localStorage.removeItem('moyeora_admin_remember');
    }
    // ë¡œê·¸ì¸ ì„±ê³µ
    sessionStorage.setItem('moyeora_admin_logged_in', 'true');
    sessionStorage.setItem('moyeora_admin_user', JSON.stringify({ id: teamMember.id, name: teamMember.name, role: teamMember.role, loginId: teamMember.loginId }));
    state.currentAdmin = { id: teamMember.id, name: teamMember.name, role: teamMember.role, loginId: teamMember.loginId };
    state.currentUser = state.currentAdmin;
    showApp();
  } else {
    // ë¡œê·¸ì¸ ì‹¤íŒ¨
    loginBtn.classList.remove('loading');
    errorMsg.classList.add('show');
    document.getElementById('admin-login-pw').value = '';
  }
}

function handleAdminLogout() {
  if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    sessionStorage.removeItem('moyeora_admin_logged_in');
    sessionStorage.removeItem('moyeora_admin_user');
    state.currentAdmin = null;
    showLogin();
    document.getElementById('admin-login-id').value = '';
    document.getElementById('admin-login-pw').value = '';
  }
}

// 6ìë¦¬ ì¸ì¦ì½”ë“œ ìƒì„±
function generateVerificationCode() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬
function showChangePasswordModal() {
  const modal = document.getElementById('modal');
  modal.className = 'modal show';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 420px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
        <button class="modal-close" onclick="closeChangePasswordModal()">Ã—</button>
      </div>
      
      <!-- Step 1: ì´ë©”ì¼ ì¸ì¦ ìš”ì²­ -->
      <div id="pw-change-step1">
        <div style="padding: 20px;">
          <div style="background: var(--info-light); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <p style="font-size: 14px; color: var(--info);">
              ğŸ“§ ë“±ë¡ëœ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.
            </p>
            <p style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">
              ${ADMIN_EMAIL.replace(/(.{3}).*(@.*)/, '$1***$2')}
            </p>
          </div>
          
          <div id="send-error" style="color: var(--danger); font-size: 13px; margin-bottom: 12px; display: none;">
            ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="send-code-btn" onclick="sendVerificationEmail()">
            ğŸ“§ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
          </button>
        </div>
      </div>
      
      <!-- Step 2: ì¸ì¦ë²ˆí˜¸ ì…ë ¥ -->
      <div id="pw-change-step2" style="display: none;">
        <div style="padding: 20px;">
          <div style="background: var(--success-light); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
            <span style="font-size: 24px;">ğŸ“¬</span>
            <p style="color: var(--success); font-weight: 600; margin-top: 8px;">ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤</p>
            <p style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš” (ìŠ¤íŒ¸í•¨ë„ í™•ì¸)</p>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì¸ì¦ë²ˆí˜¸ 6ìë¦¬</label>
            <input type="text" class="form-input" id="verify-code-input" maxlength="6" placeholder="000000" style="text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: 700;">
          </div>
          
          <div id="verify-error" style="color: var(--danger); font-size: 13px; margin-bottom: 12px; display: none;">
            ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
          
          <div style="text-align: center; margin-top: 12px;">
            <button type="button" onclick="sendVerificationEmail()" style="background: none; border: none; color: var(--info); font-size: 13px; cursor: pointer; text-decoration: underline;">
              ì¸ì¦ë²ˆí˜¸ ì¬ë°œì†¡
            </button>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="verifyCode()">í™•ì¸</button>
        </div>
      </div>
      
      <!-- Step 3: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
      <div id="pw-change-step3" style="display: none;">
        <div style="padding: 20px;">
          <div style="background: var(--success-light); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
            <span style="font-size: 24px;">âœ…</span>
            <p style="color: var(--success); font-weight: 600; margin-top: 8px;">ì¸ì¦ ì™„ë£Œ</p>
          </div>
          
          <div class="form-group">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" class="form-input" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          </div>
          
          <div class="form-group">
            <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" class="form-input" id="new-password-confirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥">
          </div>
          
          <div id="pw-match-error" style="color: var(--danger); font-size: 13px; display: none;">
            ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="changePassword()">ë³€ê²½í•˜ê¸°</button>
        </div>
      </div>
    </div>
  `;
}

function closeChangePasswordModal() {
  document.getElementById('modal').className = 'modal';
  verificationCode = '';
}

// ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
async function sendVerificationEmail() {
  const sendBtn = document.getElementById('send-code-btn');
  const errorEl = document.getElementById('send-error');
  
  if (sendBtn) {
    sendBtn.disabled = true;
    sendBtn.innerHTML = 'ë°œì†¡ ì¤‘...';
  }
  
  // ì¸ì¦ë²ˆí˜¸ ìƒì„±
  verificationCode = generateVerificationCode();
  
  try {
    // EmailJS ì´ˆê¸°í™” í™•ì¸
    if (EMAILJS_CONFIG.publicKey === 'YOUR_PUBLIC_KEY') {
      // EmailJS ë¯¸ì„¤ì • ì‹œ - ì½˜ì†”ì— ì¸ì¦ë²ˆí˜¸ ì¶œë ¥ (ê°œë°œìš©)
      console.log('========================================');
      console.log('ğŸ“§ ì¸ì¦ë²ˆí˜¸:', verificationCode);
      console.log('(EmailJS ì„¤ì • í›„ ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ë©ë‹ˆë‹¤)');
      console.log('========================================');
      
      // ê°œë°œ ëª¨ë“œì—ì„œëŠ” ë°”ë¡œ step2ë¡œ ì´ë™
      document.getElementById('pw-change-step1').style.display = 'none';
      document.getElementById('pw-change-step2').style.display = 'block';
      return;
    }
    
    // EmailJSë¡œ ì´ë©”ì¼ ë°œì†¡
    emailjs.init(EMAILJS_CONFIG.publicKey);
    
    await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, {
      to_email: ADMIN_EMAIL,
      verification_code: verificationCode,
      message: `ëª¨ì—¬ë¼ë”œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¸ì¦ë²ˆí˜¸: ${verificationCode}`
    });
    
    // step2ë¡œ ì´ë™
    document.getElementById('pw-change-step1').style.display = 'none';
    document.getElementById('pw-change-step2').style.display = 'block';
    
  } catch (e) {
    console.error('ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:', e);
    if (errorEl) {
      errorEl.style.display = 'block';
    }
    if (sendBtn) {
      sendBtn.disabled = false;
      sendBtn.innerHTML = 'ğŸ“§ ì¸ì¦ë²ˆí˜¸ ë°œì†¡';
    }
  }
}

// ì¸ì¦ë²ˆí˜¸ í™•ì¸
function verifyCode() {
  const inputCode = document.getElementById('verify-code-input').value.trim();
  const errorEl = document.getElementById('verify-error');
  
  if (inputCode === verificationCode) {
    // ì¸ì¦ ì„±ê³µ
    document.getElementById('pw-change-step2').style.display = 'none';
    document.getElementById('pw-change-step3').style.display = 'block';
  } else {
    // ì¸ì¦ ì‹¤íŒ¨
    errorEl.style.display = 'block';
  }
}

async function changePassword() {
  const newPw = document.getElementById('new-password').value;
  const confirmPw = document.getElementById('new-password-confirm').value;
  const errorEl = document.getElementById('pw-match-error');
  
  if (newPw !== confirmPw) {
    errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }
  
  if (newPw.length < 4) {
    errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    errorEl.style.display = 'block';
    return;
  }
  
  try {
    // Firebaseì— ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì €ì¥
    await db.collection('settings').doc('admin').set({
      password: newPw,
      updatedAt: new Date().toISOString()
    }, { merge: true });
    
    adminPassword = newPw;
    verificationCode = '';
    
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
    closeChangePasswordModal();
    
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    sessionStorage.removeItem('moyeora_admin_logged_in');
    showLogin();
  } catch (e) {
    alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error(e);
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
document.addEventListener('DOMContentLoaded', () => {
  loadAdminPassword();
  checkLoginStatus();
});

// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
  authDomain: "moyeora-deal-manager.firebaseapp.com",
  projectId: "moyeora-deal-manager",
  storageBucket: "moyeora-deal-manager.firebasestorage.app",
  messagingSenderId: "527148187832",
  appId: "1:527148187832:web:dc35b0413a7157db34744d",
  measurementId: "G-XEGLCEG93R"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ìƒíƒœ ê´€ë¦¬
let state = {
  currentTab: 'calendar',
  currentDate: new Date(),
  deals: [],
  suppliers: [],
  sellers: [],
  sellerList: [],
  products: [],
  viewFilter: 'all',
  selectedSupplier: '',
  selectedSeller: '',
  loading: true,
  // ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œìš© ë°ì´í„°
  sellerSettlements: [],
  supplierSettlements: [],
  settlementBrands: [],
  supplierProducts: [],
  // íŒŒíŠ¸ë„ˆ ê´€ë¦¬ ë°ì´í„°
  partnerMessages: [],
  partnerNotices: [],
  dealSuggestions: [],
  adminProposals: [],
  sellerProposals: [],
  // íŒ€ì› ê´€ë¦¬
  teamMembers: [],
  // ê¸´ê¸‰íŒë§¤ìš”ì²­
  urgentSales: [],
  // ì˜ì—… ëª©í‘œ
  salesGoals: {},
  memberGoals: {},
  // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì
  currentAdmin: null,
  currentUser: null
};

// ìƒìˆ˜
const STATUS = {
  negotiating: { label: 'í˜‘ì˜ì¤‘', class: 'status-negotiating' },
  confirmed: { label: 'í˜‘ì˜ì™„ë£Œ', class: 'status-confirmed' },
  ongoing: { label: 'ì§„í–‰ì¤‘', class: 'status-ongoing' },
  completed: { label: 'ì§„í–‰ì™„ë£Œ', class: 'status-completed' }
};

// ë‚ ì§œ ê¸°ë°˜ ìë™ ìƒíƒœ ê³„ì‚° í•¨ìˆ˜
function getAutoStatus(deal) {
  // í˜‘ì˜ì¤‘ì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€
  if (deal.status === 'negotiating') return 'negotiating';
  
  // í˜‘ì˜ì™„ë£Œ ì´í›„ëŠ” ë‚ ì§œ ê¸°ë°˜ìœ¼ë¡œ ìë™ ê²°ì •
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const start = new Date(deal.startDate);
  start.setHours(0, 0, 0, 0);
  const end = new Date(deal.endDate);
  end.setHours(0, 0, 0, 0);
  
  if (today < start) {
    return 'confirmed'; // ì§„í–‰ì˜ˆì • (í˜‘ì˜ì™„ë£Œ ìƒíƒœë¡œ í‘œì‹œ, ì‹¤ì œ ë¼ë²¨ì€ ì§„í–‰ì˜ˆì •)
  } else if (today >= start && today <= end) {
    return 'ongoing'; // ì§„í–‰ì¤‘
  } else {
    return 'completed'; // ì§„í–‰ì™„ë£Œ
  }
}

// í‘œì‹œìš© ìƒíƒœ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
function getDisplayStatus(deal) {
  if (deal.status === 'negotiating') {
    return { label: 'í˜‘ì˜ì¤‘', class: 'status-negotiating' };
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const start = new Date(deal.startDate);
  start.setHours(0, 0, 0, 0);
  const end = new Date(deal.endDate);
  end.setHours(0, 0, 0, 0);
  
  if (today < start) {
    return { label: 'ì§„í–‰ì˜ˆì •', class: 'status-confirmed' };
  } else if (today >= start && today <= end) {
    return { label: 'ì§„í–‰ì¤‘', class: 'status-ongoing' };
  } else {
    return { label: 'ì§„í–‰ì™„ë£Œ', class: 'status-completed' };
  }
}

const MONTHS = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
const WEEKDAYS = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
const formatDate = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

const formatDateKR = (date) => {
  if (!date) return '';
  const d = date instanceof Date ? date : new Date(date);
  return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
};

const parseDate = (str) => str ? new Date(str + 'T00:00:00') : null;
const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

const showToast = (msg) => {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 2500);
};

// Firebase ë¦¬ìŠ¤ë„ˆ
function setupListeners() {
  db.collection('deals').orderBy('startDate', 'desc').onSnapshot(snapshot => {
    state.deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('suppliers').orderBy('name').onSnapshot(snapshot => {
    state.suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('sellers').orderBy('name').onSnapshot(snapshot => {
    state.sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('sellerList').orderBy('accountName').onSnapshot(snapshot => {
    state.sellerList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  db.collection('products').orderBy('order').onSnapshot(snapshot => {
    state.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    state.loading = false;
    render();
  });
  
  // ì…€ëŸ¬ ì •ì‚°ì„œ
  db.collection('sellerSettlements').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.sellerSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ê³µê¸‰ì‚¬ ì •ì‚°ì„œ
  db.collection('supplierSettlements').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.supplierSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ë¸Œëœë“œ(ê³µê¸‰ì‚¬) ëª©ë¡
  db.collection('settlementBrands').orderBy('name').onSnapshot(snapshot => {
    state.settlementBrands = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ê³µê¸‰ì‚¬ ìƒí’ˆ ëª©ë¡
  db.collection('supplierProducts').orderBy('brandName').onSnapshot(snapshot => {
    state.supplierProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // íŒŒíŠ¸ë„ˆ ë©”ì‹œì§€
  db.collection('partnerMessages').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.partnerMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    updateUnreadBadge();
    render();
  });
  
  // íŒŒíŠ¸ë„ˆ ê³µì§€ì‚¬í•­
  db.collection('partnerNotices').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.partnerNotices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ê³µêµ¬ ì œì•ˆ
  db.collection('dealSuggestions').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.dealSuggestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ì–´ë“œë¯¼ì´ ì…€ëŸ¬ì—ê²Œ ë³´ë‚¸ ì œì•ˆ
  db.collection('adminProposals').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.adminProposals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // íŒ€ì› ê´€ë¦¬
  db.collection('teamMembers').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ê¸´ê¸‰íŒë§¤ìš”ì²­
  db.collection('urgentSales').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.urgentSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ì…€ëŸ¬ ì œì•ˆ (sellerProposals)
  db.collection('sellerProposals').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    state.sellerProposals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
  });
  
  // ì˜ì—… ëª©í‘œ ì„¤ì •
  db.collection('settings').doc('salesGoals').onSnapshot(doc => {
    if (doc.exists) {
      state.salesGoals = doc.data();
    }
    render();
  });
  
  // íŒ€ì›ë³„ ëª©í‘œ ì„¤ì •
  db.collection('settings').doc('memberGoals').onSnapshot(doc => {
    if (doc.exists) {
      state.memberGoals = doc.data().goals || {};
    }
    render();
  });
}

// ì•ˆì½ì€ ë©”ì‹œì§€ ë±ƒì§€ ì—…ë°ì´íŠ¸
function updateUnreadBadge() {
  const unreadCount = state.partnerMessages.filter(m => !m.isAdmin && !m.isRead).length;
  const badge = document.getElementById('unread-badge');
  if (badge) {
    badge.textContent = unreadCount;
    badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
  }
}

// CRUD
async function saveDeal(data) {
  try {
    if (data.id) {
      await db.collection('deals').doc(data.id).update(data);
    } else {
      delete data.id;
      await db.collection('deals').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteDeal(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('deals').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function saveSupplier(data) {
  try {
    if (data.id) {
      await db.collection('suppliers').doc(data.id).update(data);
    } else {
      delete data.id;
      await db.collection('suppliers').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteSupplier(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('suppliers').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function saveSeller(data) {
  try {
    if (data.id) {
      await db.collection('sellers').doc(data.id).update(data);
    } else {
      delete data.id;
      await db.collection('sellers').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteSeller(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('sellers').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function updateSettlement(dealId, field, value) {
  try {
    await db.collection('deals').doc(dealId).update({ [field]: value });
    showToast('ì •ì‚° ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch(e) {
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ ì„¤ì •
let ADMIN_PASSWORD = localStorage.getItem('moyeora_admin_password') || 'elf124!';
const adminTabs = ['salesReport'];  // ê´€ë¦¬ì ë©”ë‰´ë§Œ ë¹„ë°€ë²ˆí˜¸ í•„ìš”
let isAdminUnlocked = sessionStorage.getItem('adminUnlocked') === 'true';
let adminMenuOpen = false;
let dealMenuOpen = true;  // ì´ˆê¸° ì—´ë¦° ìƒíƒœ
let partnerMenuOpen = true;  // ì´ˆê¸° ì—´ë¦° ìƒíƒœ
let supplierMenuOpen = true;  // ì´ˆê¸° ì—´ë¦° ìƒíƒœ
let sellerMenuOpen = true;  // ì´ˆê¸° ì—´ë¦° ìƒíƒœ

// ê³µêµ¬ê´€ë¦¬ ë©”ë‰´ í† ê¸€
function toggleDealMenu() {
  dealMenuOpen = !dealMenuOpen;
  const submenu = document.getElementById('deal-submenu');
  const arrow = document.getElementById('deal-menu-arrow');
  
  if (submenu) {
    submenu.style.display = dealMenuOpen ? 'block' : 'none';
    arrow.style.transform = dealMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

// íŒŒíŠ¸ë„ˆ ê´€ë¦¬ ë©”ë‰´ í† ê¸€
function togglePartnerMenu() {
  partnerMenuOpen = !partnerMenuOpen;
  const submenu = document.getElementById('partner-submenu');
  const arrow = document.getElementById('partner-menu-arrow');
  
  if (submenu) {
    submenu.style.display = partnerMenuOpen ? 'block' : 'none';
    arrow.style.transform = partnerMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

// ê³µê¸‰ì‚¬ ê´€ë¦¬ ë©”ë‰´ í† ê¸€ (3ì¤‘ í•˜ìœ„)
function toggleSupplierMenu(event) {
  if (event) event.stopPropagation();
  supplierMenuOpen = !supplierMenuOpen;
  const submenu = document.getElementById('supplier-submenu');
  const arrow = document.getElementById('supplier-menu-arrow');
  
  if (submenu) {
    submenu.style.display = supplierMenuOpen ? 'block' : 'none';
    arrow.style.transform = supplierMenuOpen ? 'rotate(90deg)' : 'rotate(0deg)';
  }
}

// ì…€ëŸ¬ ê´€ë¦¬ ë©”ë‰´ í† ê¸€ (3ì¤‘ í•˜ìœ„)
function toggleSellerMenu(event) {
  if (event) event.stopPropagation();
  sellerMenuOpen = !sellerMenuOpen;
  const submenu = document.getElementById('seller-submenu');
  const arrow = document.getElementById('seller-menu-arrow');
  
  if (submenu) {
    submenu.style.display = sellerMenuOpen ? 'block' : 'none';
    arrow.style.transform = sellerMenuOpen ? 'rotate(90deg)' : 'rotate(0deg)';
  }
}

// ê´€ë¦¬ì ë©”ë‰´ í† ê¸€ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„)
function toggleAdminMenu() {
  if (!isAdminUnlocked) {
    showAdminPasswordModal();
    return;
  }
  
  adminMenuOpen = !adminMenuOpen;
  const submenu = document.getElementById('admin-submenu');
  const arrow = document.getElementById('admin-menu-arrow');
  
  if (submenu) {
    submenu.style.display = adminMenuOpen ? 'block' : 'none';
    arrow.style.transform = adminMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

// ê³ ê¸‰ ì„¤ì • í† ê¸€
function toggleAdvancedAdminMenu() {
  const submenu = document.getElementById('advanced-admin-submenu');
  if (submenu) {
    const isHidden = submenu.style.display === 'none';
    submenu.style.display = isHidden ? 'block' : 'none';
  }
}

// ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬
function showAdminPasswordModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ” ê´€ë¦¬ì ì¸ì¦</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="background: var(--gray-100); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
        <p style="color: var(--gray-600); font-size: 13px; margin: 0;">ê´€ë¦¬ì ë©”ë‰´ì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      </div>
      <form onsubmit="checkAdminPassword(event)">
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" class="form-input" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required autofocus>
        </div>
        <div id="admin-password-error" style="color: var(--danger); font-size: 14px; margin-bottom: 12px; display: none;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">í™•ì¸</button>
        </div>
      </form>
    </div>
  `;
  
  setTimeout(() => document.getElementById('admin-password').focus(), 100);
}

// ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
function checkAdminPassword(e) {
  e.preventDefault();
  const password = document.getElementById('admin-password').value;
  
  if (password === ADMIN_PASSWORD) {
    isAdminUnlocked = true;
    sessionStorage.setItem('adminUnlocked', 'true');
    closeModal();
    showToast('âœ… ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ');
    
    // ë©”ë‰´ ì—´ê¸°
    adminMenuOpen = true;
    const submenu = document.getElementById('admin-submenu');
    const arrow = document.getElementById('admin-menu-arrow');
    if (submenu) {
      submenu.style.display = 'block';
      arrow.style.transform = 'rotate(180deg)';
    }
  } else {
    document.getElementById('admin-password-error').style.display = 'block';
    document.getElementById('admin-password').value = '';
    document.getElementById('admin-password').focus();
  }
}

// ê´€ë¦¬ì ì„¤ì • ëª¨ë‹¬ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¬í•¨)
function openAdminSettings() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="padding: 16px; background: var(--gray-50); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ“Š ì‹œìŠ¤í…œ í˜„í™©</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
            <div>ê³µê¸‰ì‚¬: <strong>${state.suppliers.length}</strong>ê°œ</div>
            <div>ì…€ëŸ¬: <strong>${state.sellers.length}</strong>ëª…</div>
            <div>ê³µêµ¬: <strong>${state.deals.length}</strong>ê±´</div>
            <div>ìƒí’ˆ DB: <strong>${state.productDB.length}</strong>ê°œ</div>
          </div>
        </div>
        
        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„¹ì…˜ -->
        <div style="padding: 16px; background: var(--white); border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="form-group" style="margin-bottom: 12px;">
            <label class="form-label" style="font-size: 13px;">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="current-password" class="form-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          </div>
          <div class="form-group" style="margin-bottom: 12px;">
            <label class="form-label" style="font-size: 13px;">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="new-password" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          </div>
          <div class="form-group" style="margin-bottom: 12px;">
            <label class="form-label" style="font-size: 13px;">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="confirm-password" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥">
          </div>
          <div id="password-error" style="display: none; color: var(--danger); font-size: 13px; margin-bottom: 12px;"></div>
          <button class="btn btn-primary" style="width: 100%;" onclick="changeAdminPassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>
        
        <div style="padding: 16px; background: var(--info-light); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--info);">ğŸ’¡ ë„ì›€ë§</div>
          <ul style="font-size: 13px; color: var(--gray-600); margin-left: 16px;">
            <li>ë°ì´í„°ëŠ” Firebaseì— ìë™ ì €ì¥ë©ë‹ˆë‹¤</li>
            <li>ë°±ì—…ì€ ì •ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ì„¸ìš”</li>
            <li>ë¹„ë°€ë²ˆí˜¸ëŠ” ì•ˆì „í•œ ê³³ì— ë³´ê´€í•˜ì„¸ìš”</li>
          </ul>
        </div>
        
        <button class="btn btn-secondary" style="width: 100%;" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•¨ìˆ˜
function changeAdminPassword() {
  const currentPw = document.getElementById('current-password').value;
  const newPw = document.getElementById('new-password').value;
  const confirmPw = document.getElementById('confirm-password').value;
  const errorDiv = document.getElementById('password-error');
  
  // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  if (currentPw !== ADMIN_PASSWORD) {
    errorDiv.textContent = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorDiv.style.display = 'block';
    return;
  }
  
  // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
  if (newPw.length < 4) {
    errorDiv.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    errorDiv.style.display = 'block';
    return;
  }
  
  if (newPw !== confirmPw) {
    errorDiv.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    errorDiv.style.display = 'block';
    return;
  }
  
  // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (localStorageì— ì €ì¥)
  localStorage.setItem('moyeora_admin_password', newPw);
  ADMIN_PASSWORD = newPw;
  
  closeModal();
  showToast('âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ë°ì´í„° ë°±ì—… (ë‚´ë³´ë‚´ê¸°)
function exportAllData() {
  const exportData = {
    exportDate: new Date().toISOString(),
    suppliers: state.suppliers,
    sellers: state.sellers,
    sellerList: state.sellerList,
    deals: state.deals,
    productDB: state.productDB,
    dealSuggestions: state.dealSuggestions
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `moyeoradeal_backup_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… ë°ì´í„° ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ë°ì´í„° ë³µì› ëª¨ë‹¬
function openRestoreModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‚ ë°ì´í„° ë³µì›</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="padding: 16px; background: var(--danger-light); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; color: var(--danger); margin-bottom: 8px;">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
          <ul style="font-size: 13px; color: var(--gray-700); margin-left: 16px;">
            <li>ë³µì› ì‹œ í˜„ì¬ ë°ì´í„°ê°€ <strong>ëª¨ë‘ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤</strong></li>
            <li>ë³µì› ì „ ë°˜ë“œì‹œ <strong>í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…</strong>í•˜ì„¸ìš”</li>
            <li>JSON í˜•ì‹ì˜ ë°±ì—… íŒŒì¼ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
          </ul>
        </div>
        
        <div class="form-group">
          <label class="form-label">ë°±ì—… íŒŒì¼ ì„ íƒ</label>
          <input type="file" id="restore-file" accept=".json" class="form-input" style="padding: 10px;">
        </div>
        
        <div id="restore-preview" style="display: none; padding: 16px; background: var(--gray-50); border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ“‹ ë³µì›í•  ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</div>
          <div id="restore-preview-content" style="font-size: 13px;"></div>
        </div>
        
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" style="flex: 1;" id="restore-btn" onclick="restoreData()" disabled>ë³µì›í•˜ê¸°</button>
        </div>
      </div>
    </div>
  `;
  
  // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
  document.getElementById('restore-file').addEventListener('change', previewRestoreFile);
}

// ë³µì› íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
function previewRestoreFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const data = JSON.parse(event.target.result);
      window.restoreData = data;
      
      const preview = document.getElementById('restore-preview');
      const content = document.getElementById('restore-preview-content');
      
      content.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div>ë°±ì—…ì¼ì‹œ: <strong>${new Date(data.exportDate).toLocaleString('ko-KR')}</strong></div>
          <div>ê³µê¸‰ì‚¬: <strong>${data.suppliers?.length || 0}</strong>ê°œ</div>
          <div>ì…€ëŸ¬: <strong>${data.sellers?.length || 0}</strong>ëª…</div>
          <div>ê³µêµ¬: <strong>${data.deals?.length || 0}</strong>ê±´</div>
          <div>ìƒí’ˆ DB: <strong>${data.productDB?.length || 0}</strong>ê°œ</div>
          <div>ì œì•ˆ: <strong>${data.dealSuggestions?.length || 0}</strong>ê±´</div>
        </div>
      `;
      
      preview.style.display = 'block';
      document.getElementById('restore-btn').disabled = false;
    } catch (err) {
      showToast('âŒ ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
      document.getElementById('restore-btn').disabled = true;
    }
  };
  reader.readAsText(file);
}

// ë°ì´í„° ë³µì› ì‹¤í–‰
async function restoreData() {
  if (!window.restoreData) {
    showToast('âŒ ë³µì›í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!confirm('ì •ë§ ë°ì´í„°ë¥¼ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\ní˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return;
  
  const data = window.restoreData;
  
  try {
    // Firebaseì— ë°ì´í„° ë³µì›
    const batch = db.batch();
    
    // ê³µê¸‰ì‚¬ ë³µì›
    if (data.suppliers) {
      for (const item of data.suppliers) {
        const ref = db.collection('suppliers').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    // ì…€ëŸ¬ ë³µì›
    if (data.sellers) {
      for (const item of data.sellers) {
        const ref = db.collection('sellers').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    // ê³µêµ¬ ë³µì›
    if (data.deals) {
      for (const item of data.deals) {
        const ref = db.collection('deals').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    // ìƒí’ˆ DB ë³µì›
    if (data.productDB) {
      for (const item of data.productDB) {
        const ref = db.collection('productDB').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    // ì œì•ˆ ë³µì›
    if (data.dealSuggestions) {
      for (const item of data.dealSuggestions) {
        const ref = db.collection('dealSuggestions').doc(item.id);
        batch.set(ref, item);
      }
    }
    
    await batch.commit();
    
    closeModal();
    showToast('âœ… ë°ì´í„°ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
    setTimeout(() => location.reload(), 1500);
    
  } catch (err) {
    console.error('ë³µì› ì‹¤íŒ¨:', err);
    showToast('âŒ ë³µì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
  }
}

// íƒ­ ì „í™˜
function switchTab(tab) {
  // ê´€ë¦¬ì íƒ­ì¸ì§€ í™•ì¸
  if (adminTabs.includes(tab) && !isAdminUnlocked) {
    showAdminPasswordModal();
    return;
  }
  
  state.currentTab = tab;
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.tab === tab);
  });
  render();
}

// ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜
function prevMonth() {
  state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1, 1);
  render();
}

function nextMonth() {
  state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1, 1);
  render();
}

function goToday() {
  state.currentDate = new Date();
  render();
}

// í•„í„°
function changeViewFilter(filter) {
  state.viewFilter = filter;
  render();
}

function changeSupplierFilter(supplierId) {
  state.selectedSupplier = supplierId;
  render();
}

function changeSellerFilter(sellerId) {
  state.selectedSeller = sellerId;
  render();
}

// ëª¨ë‹¬
function closeModal() {
  document.getElementById('modal').className = 'modal';
  // ì…€ëŸ¬ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
  document.removeEventListener('click', closeSellerDropdownOnOutsideClick);
}

function openDealModal(deal = null) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  const isEdit = deal !== null;
  const d = deal || {
    title: '', supplierId: '', sellerId: '', startDate: formatDate(new Date()),
    endDate: formatDate(new Date()), status: 'negotiating', notes: '',
    supplierSettled: false, sellerSettled: false,
    selectedProducts: [] // ì„ íƒëœ ìƒí’ˆ ë°°ì—´: [{productId, productName, marginRate}]
  };
  
  // ê¸°ì¡´ ì„ íƒëœ ìƒí’ˆ ë°ì´í„° (ê¸°ì¡´ ë°°ì—´ ë˜ëŠ” ìƒˆ ê°ì²´ ë°°ì—´ í˜•ì‹ ëª¨ë‘ ì§€ì›)
  const selectedProductsData = d.selectedProducts || [];
  const selectedProductIds = selectedProductsData.map(item => 
    typeof item === 'string' ? item : item.productId
  );
  
  // ê³µêµ¬ ê¸°ê°„ ê³„ì‚°
  const getDealDuration = (start, end) => {
    if (!start || !end) return '';
    const startDate = new Date(start);
    const endDate = new Date(end);
    const diff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    return diff > 0 ? `(${diff}ì¼)` : '';
  };
  
  const initialDuration = getDealDuration(d.startDate, d.endDate);
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ê³µêµ¬ ìˆ˜ì •' : 'ìƒˆ ê³µêµ¬ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitDealForm(event, '${d.id || ''}')">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ê³µê¸‰ì‚¬</label>
            <select class="form-select" id="deal-supplier" required onchange="updateProductList(); updateDealTitle();">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${state.suppliers.map(s => `<option value="${s.id}" ${d.supplierId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ì…€ëŸ¬</label>
            <select class="form-select" id="deal-seller" required onchange="updateDealTitle()">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${state.sellers.map(s => `<option value="${s.id}" ${d.sellerId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ê³µêµ¬ëª… <span id="deal-duration" style="color: var(--primary); font-weight: 600;">${initialDuration}</span></label>
          <input type="text" class="form-input" id="deal-title" value="${d.title}" required placeholder="ì…€ëŸ¬ ì„ íƒ ì‹œ ìë™ ìƒì„±ë©ë‹ˆë‹¤">
        </div>
        
        <!-- ë‚ ì§œ ì„ íƒ ì˜ì—­ -->
        <div class="form-group">
          <label class="form-label">ğŸ“… ê³µêµ¬ ê¸°ê°„</label>
          <button type="button" class="btn btn-secondary" id="date-range-btn" onclick="openDateRangePicker()" style="width: 100%; justify-content: space-between; padding: 14px 16px;">
            <span id="date-range-display">${d.startDate} ~ ${d.endDate}</span>
            <span style="color: var(--gray-500);">ğŸ“… ë‚ ì§œ ì„ íƒ</span>
          </button>
          <input type="hidden" id="deal-start" value="${d.startDate}">
          <input type="hidden" id="deal-end" value="${d.endDate}">
          <div id="date-range-picker" style="display: none; margin-top: 12px; border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <button type="button" class="btn btn-ghost btn-sm" onclick="changePickerMonth(-1)">â—€</button>
              <span id="picker-month-label" style="font-weight: 600;"></span>
              <button type="button" class="btn btn-ghost btn-sm" onclick="changePickerMonth(1)">â–¶</button>
            </div>
            <div id="picker-calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center;"></div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
              <div id="picker-status" style="font-size: 13px; color: var(--gray-500);">1. ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
              <button type="button" class="btn btn-primary btn-sm" onclick="closeDateRangePicker()">ì™„ë£Œ</button>
            </div>
          </div>
        </div>
        
        <!-- ìƒí’ˆ ì„ íƒ ì˜ì—­ -->
        <div class="form-group">
          <label class="form-label">ğŸ“¦ ê³µêµ¬ ìƒí’ˆ ì„ íƒ <span id="selected-product-count" style="color: var(--primary);">(${selectedProductIds.length}ê°œ ì„ íƒ)</span></label>
          
          <!-- ì„ íƒëœ ìƒí’ˆ í‘œì‹œ ì˜ì—­ -->
          <div id="selected-products-display" style="margin-bottom: 8px; ${selectedProductIds.length === 0 ? 'display:none;' : ''}">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${selectedProductIds.map(pid => {
                const product = (state.supplierProducts || []).find(p => p.id === pid);
                const productData = selectedProductsData.find(item => (typeof item === 'string' ? item : item.productId) === pid);
                const marginRate = productData && typeof productData === 'object' ? productData.marginRate : '';
                return product ? `
                  <div class="selected-product-tag" data-id="${pid}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); border: 1px solid var(--primary); border-radius: 20px; font-size: 13px;">
                    <span style="color: var(--primary); font-weight: 500;">${product.productName}</span>
                    ${marginRate ? `<span style="color: var(--gray-600); font-size: 11px;">(${marginRate}%)</span>` : ''}
                    <button type="button" onclick="removeSelectedProduct('${pid}')" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">Ã—</button>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
          
          <input type="text" class="form-input" id="product-search" placeholder="ğŸ” ìƒí’ˆëª… ê²€ìƒ‰..." style="margin-bottom: 8px;" oninput="filterProductList()">
          <div id="deal-product-list" style="border: 1px solid var(--gray-200); border-radius: 12px; padding: 12px; background: var(--gray-50); max-height: 200px; overflow-y: auto;">
            ${d.supplierId ? renderDealProductOptions(d.supplierId, selectedProductsData, '') : '<p style="color: var(--gray-500); text-align: center; padding: 20px;">ê³µê¸‰ì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>'}
          </div>
          <p style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">ğŸ’¡ ê³µê¸‰ì‚¬ ìƒí’ˆ DBì— ë“±ë¡ëœ ìƒí’ˆ ì¤‘ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        
        <!-- ìƒíƒœ ì„ íƒ - í˜‘ì˜ì¤‘/í˜‘ì˜ì™„ë£Œë§Œ ì„ íƒ ê°€ëŠ¥ -->
        <div class="form-group">
          <label class="form-label">ìƒíƒœ</label>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 20px; cursor: pointer; border: 2px solid ${d.status === 'negotiating' ? 'var(--primary)' : 'var(--gray-200)'}; background: ${d.status === 'negotiating' ? 'var(--primary-light)' : 'white'}; transition: all 0.15s;">
              <input type="radio" name="deal-status" value="negotiating" ${d.status === 'negotiating' ? 'checked' : ''} style="display: none;" onchange="updateStatusStyle()">
              <span style="font-size: 14px; font-weight: ${d.status === 'negotiating' ? '600' : '500'}; color: ${d.status === 'negotiating' ? 'var(--primary)' : 'var(--gray-700)'};">í˜‘ì˜ì¤‘</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 20px; cursor: pointer; border: 2px solid ${d.status !== 'negotiating' ? 'var(--primary)' : 'var(--gray-200)'}; background: ${d.status !== 'negotiating' ? 'var(--primary-light)' : 'white'}; transition: all 0.15s;">
              <input type="radio" name="deal-status" value="confirmed" ${d.status !== 'negotiating' ? 'checked' : ''} style="display: none;" onchange="updateStatusStyle()">
              <span style="font-size: 14px; font-weight: ${d.status !== 'negotiating' ? '600' : '500'}; color: ${d.status !== 'negotiating' ? 'var(--primary)' : 'var(--gray-700)'};">í˜‘ì˜ì™„ë£Œ</span>
            </label>
          </div>
          <p style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">ğŸ’¡ í˜‘ì˜ì™„ë£Œ í›„ì—ëŠ” ê³µêµ¬ ê¸°ê°„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì§„í–‰ì˜ˆì •/ì§„í–‰ì¤‘/ì§„í–‰ì™„ë£Œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        
        <!-- í˜‘ì˜ì™„ë£Œ ì‹œ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        ${d.status !== 'negotiating' ? `
          <div class="form-group">
            <label class="form-label">ğŸ“‹ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸</label>
            <div style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: var(--gray-50); border-radius: 12px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="journey-sample" ${d.journeySample ? 'checked' : ''} style="width: 18px; height: 18px;">
                <span>ğŸ“¦ ìƒ˜í”Œì „ë‹¬</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="journey-payment-link" ${d.journeyPaymentLink ? 'checked' : ''} style="width: 18px; height: 18px;">
                <span>ğŸ’³ ê²°ì œë§í¬ì „ë‹¬</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="journey-content" ${d.journeyContent ? 'checked' : ''} style="width: 18px; height: 18px;">
                <span>ğŸ¬ ì»¨í…ì¸ ì „ë‹¬</span>
              </label>
            </div>
          </div>
        ` : ''}
        
        <div class="form-group">
          <label class="form-label">ë©”ëª¨</label>
          <textarea class="form-textarea" id="deal-notes" rows="2" placeholder="ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">${d.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteDeal('${d.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  // ë‚ ì§œ í”¼ì»¤ ì´ˆê¸°í™”
  window.pickerMonth = new Date(d.startDate || new Date());
  window.pickerStartDate = d.startDate || null;
  window.pickerEndDate = d.endDate || null;
  window.pickerStep = 1; // 1: ì‹œì‘ì¼ ì„ íƒ, 2: ì¢…ë£Œì¼ ì„ íƒ
}

// ê³µêµ¬ëª… ìë™ ì—…ë°ì´íŠ¸
function updateDealTitle() {
  const sellerSelect = document.getElementById('deal-seller');
  const titleInput = document.getElementById('deal-title');
  
  if (sellerSelect.value) {
    const selectedOption = sellerSelect.options[sellerSelect.selectedIndex];
    const sellerName = selectedOption.text;
    titleInput.value = sellerName;
  }
  
  updateDealDuration();
}

// ê³µêµ¬ ê¸°ê°„(ì¼ìˆ˜) ì—…ë°ì´íŠ¸
function updateDealDuration() {
  const start = document.getElementById('deal-start').value;
  const end = document.getElementById('deal-end').value;
  const durationSpan = document.getElementById('deal-duration');
  
  if (start && end) {
    const startDate = new Date(start);
    const endDate = new Date(end);
    const diff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    durationSpan.textContent = diff > 0 ? `(${diff}ì¼)` : '';
  } else {
    durationSpan.textContent = '';
  }
}

// ë‚ ì§œ ë²”ìœ„ í”¼ì»¤ ì—´ê¸°
function openDateRangePicker() {
  const picker = document.getElementById('date-range-picker');
  picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
  if (picker.style.display === 'block') {
    window.pickerStep = 1;
    renderPickerCalendar();
  }
}

function closeDateRangePicker() {
  document.getElementById('date-range-picker').style.display = 'none';
}

// í”¼ì»¤ ì›” ë³€ê²½
function changePickerMonth(delta) {
  window.pickerMonth = new Date(window.pickerMonth.getFullYear(), window.pickerMonth.getMonth() + delta, 1);
  renderPickerCalendar();
}

// í”¼ì»¤ ìº˜ë¦°ë” ë Œë”ë§
function renderPickerCalendar() {
  const year = window.pickerMonth.getFullYear();
  const month = window.pickerMonth.getMonth();
  
  document.getElementById('picker-month-label').textContent = `${year}ë…„ ${month + 1}ì›”`;
  
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  let html = weekdays.map(w => `<div style="font-size: 12px; color: var(--gray-500); padding: 8px;">${w}</div>`).join('');
  
  // ë¹ˆ ì¹¸
  for (let i = 0; i < firstDay; i++) {
    html += '<div></div>';
  }
  
  // ë‚ ì§œ
  const today = formatDate(new Date());
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = formatDate(new Date(year, month, day));
    const isToday = dateStr === today;
    const isStart = dateStr === window.pickerStartDate;
    const isEnd = dateStr === window.pickerEndDate;
    const isInRange = window.pickerStartDate && window.pickerEndDate && 
                      dateStr > window.pickerStartDate && dateStr < window.pickerEndDate;
    
    let style = 'padding: 10px; border-radius: 8px; cursor: pointer; font-size: 14px;';
    if (isStart || isEnd) {
      style += 'background: var(--primary); color: white; font-weight: 600;';
    } else if (isInRange) {
      style += 'background: var(--primary-light); color: var(--primary);';
    } else if (isToday) {
      style += 'border: 2px solid var(--primary); font-weight: 600;';
    }
    
    html += `<div style="${style}" onclick="selectPickerDate('${dateStr}')" onmouseover="this.style.background=this.style.background||'var(--gray-100)'" onmouseout="this.style.background='${isStart || isEnd ? 'var(--primary)' : isInRange ? 'var(--primary-light)' : ''}'">${day}</div>`;
  }
  
  document.getElementById('picker-calendar').innerHTML = html;
  
  // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
  const statusEl = document.getElementById('picker-status');
  if (window.pickerStep === 1) {
    statusEl.innerHTML = '1ï¸âƒ£ <strong>ì‹œì‘ì¼</strong>ì„ ì„ íƒí•˜ì„¸ìš”';
  } else {
    statusEl.innerHTML = '2ï¸âƒ£ <strong>ì¢…ë£Œì¼</strong>ì„ ì„ íƒí•˜ì„¸ìš”';
  }
}

// ë‚ ì§œ ì„ íƒ
function selectPickerDate(dateStr) {
  if (window.pickerStep === 1) {
    // ì‹œì‘ì¼ ì„ íƒ
    window.pickerStartDate = dateStr;
    window.pickerEndDate = null;
    window.pickerStep = 2;
    document.getElementById('deal-start').value = dateStr;
  } else {
    // ì¢…ë£Œì¼ ì„ íƒ
    if (dateStr < window.pickerStartDate) {
      // ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì´ë©´ ì‹œì‘ì¼ë¡œ ì„¤ì •
      window.pickerEndDate = window.pickerStartDate;
      window.pickerStartDate = dateStr;
      document.getElementById('deal-start').value = dateStr;
      document.getElementById('deal-end').value = window.pickerEndDate;
    } else {
      window.pickerEndDate = dateStr;
      document.getElementById('deal-end').value = dateStr;
    }
    window.pickerStep = 1;
    
    // ë‚ ì§œ ë²”ìœ„ í‘œì‹œ ì—…ë°ì´íŠ¸
    document.getElementById('date-range-display').textContent = 
      `${window.pickerStartDate} ~ ${window.pickerEndDate}`;
    
    // ê¸°ê°„ ì—…ë°ì´íŠ¸
    updateDealDuration();
    
    // í”¼ì»¤ ë‹«ê¸°
    setTimeout(() => closeDateRangePicker(), 300);
  }
  
  renderPickerCalendar();
}

// ìƒíƒœ ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
function updateStatusStyle() {
  const radios = document.querySelectorAll('input[name="deal-status"]');
  radios.forEach(radio => {
    const label = radio.closest('label');
    const span = label.querySelector('span');
    if (radio.checked) {
      label.style.borderColor = 'var(--primary)';
      label.style.background = 'var(--primary-light)';
      span.style.fontWeight = '600';
      span.style.color = 'var(--primary)';
    } else {
      label.style.borderColor = 'var(--gray-200)';
      label.style.background = 'white';
      span.style.fontWeight = '500';
      span.style.color = 'var(--gray-700)';
    }
  });
}

// ê³µê¸‰ì‚¬ ì„ íƒ ì‹œ ìƒí’ˆ ëª©ë¡ ì—…ë°ì´íŠ¸
function updateProductList() {
  const supplierId = document.getElementById('deal-supplier').value;
  const container = document.getElementById('deal-product-list');
  const searchInput = document.getElementById('product-search');
  
  if (searchInput) searchInput.value = '';
  
  if (!supplierId) {
    container.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">ê³µê¸‰ì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>';
    return;
  }
  
  container.innerHTML = renderDealProductOptions(supplierId, [], '');
}

// ìƒí’ˆ ê²€ìƒ‰ í•„í„°
function filterProductList() {
  const supplierId = document.getElementById('deal-supplier').value;
  const searchQuery = document.getElementById('product-search').value;
  const container = document.getElementById('deal-product-list');
  
  // í˜„ì¬ ì²´í¬ëœ ìƒí’ˆ IDì™€ ë§ˆì§„ìœ¨ ì •ë³´ ì €ì¥
  const checkedProducts = Array.from(document.querySelectorAll('input[name="deal-products"]:checked'))
    .map(cb => {
      const marginInput = document.querySelector(`.product-margin-rate[data-product-id="${cb.value}"]`);
      return {
        productId: cb.value,
        productName: cb.dataset.name,
        marginRate: marginInput ? Number(marginInput.value) || 0 : 0
      };
    });
  
  if (!supplierId) {
    container.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">ê³µê¸‰ì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>';
    return;
  }
  
  container.innerHTML = renderDealProductOptions(supplierId, checkedProducts, searchQuery);
}

// ê³µê¸‰ì‚¬ë³„ ìƒí’ˆ ì˜µì…˜ ë Œë”ë§ (ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€)
function renderDealProductOptions(supplierId, selectedIds, searchQuery = '') {
  // ê³µê¸‰ì‚¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const supplier = state.suppliers.find(s => s.id === supplierId);
  const supplierName = supplier?.name || '';
  
  // selectedIdsê°€ ê°ì²´ ë°°ì—´ì¸ì§€ í™•ì¸ (ìƒˆ í˜•ì‹: [{productId, marginRate}])
  const selectedProductsData = Array.isArray(selectedIds) ? selectedIds : [];
  const selectedProductIds = selectedProductsData.map(item => 
    typeof item === 'string' ? item : item.productId
  );
  
  // supplierIdë¡œ ë§¤ì¹­í•˜ê±°ë‚˜, brandNameìœ¼ë¡œ ë§¤ì¹­
  let products = (state.supplierProducts || []).filter(p => 
    p.supplierId === supplierId || p.brandName === supplierName
  );
  
  // ê²€ìƒ‰ í•„í„° ì ìš©
  if (searchQuery) {
    const query = searchQuery.toLowerCase();
    products = products.filter(p => 
      (p.productName || '').toLowerCase().includes(query)
    );
  }
  
  if (products.length === 0) {
    if (searchQuery) {
      return `<p style="color: var(--gray-500); text-align: center; padding: 20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    }
    return `
      <p style="color: var(--gray-500); text-align: center; padding: 20px;">
        ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>
        <a href="#" onclick="closeModal(); switchTab('productDB');" style="color: var(--primary); font-weight: 600;">ê³µê¸‰ì‚¬ ìƒí’ˆ DB</a>ì—ì„œ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
      </p>
    `;
  }
  
  return products.map(p => {
    const isChecked = selectedProductIds.includes(p.id);
    // ê¸°ì¡´ ë§ˆì§„ìœ¨ ì°¾ê¸°
    const existingData = selectedProductsData.find(item => 
      (typeof item === 'string' ? item : item.productId) === p.id
    );
    const marginRate = existingData && typeof existingData === 'object' ? existingData.marginRate || '' : '';
    
    return `
      <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 2px solid ${isChecked ? 'var(--primary)' : 'var(--gray-200)'};" onclick="this.style.borderColor = this.querySelector('input[type=checkbox]').checked ? 'var(--gray-200)' : 'var(--primary)'">
        <input type="checkbox" name="deal-products" value="${p.id}" data-name="${p.productName}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px;" onchange="updateSelectedProductsDisplay()">
        <div style="flex: 1;">
          <div style="font-weight: 600;">${p.productName}</div>
        </div>
        <div style="display: ${isChecked ? 'flex' : 'none'}; align-items: center; gap: 6px;" class="margin-rate-input">
          <span style="font-size: 12px; color: var(--gray-500);">ë§ˆì§„ìœ¨</span>
          <input type="number" class="form-input product-margin-rate" data-product-id="${p.id}" value="${marginRate}" placeholder="0" step="0.1" min="0" max="100" style="width: 60px; padding: 4px 8px; text-align: center; font-size: 13px;" onclick="event.stopPropagation()">
          <span style="font-size: 12px; color: var(--gray-500);">%</span>
        </div>
      </label>
    `;
  }).join('');
}

// ì„ íƒëœ ìƒí’ˆ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSelectedProductsDisplay() {
  const checkedBoxes = document.querySelectorAll('input[name="deal-products"]:checked');
  const displayContainer = document.getElementById('selected-products-display');
  const countSpan = document.getElementById('selected-product-count');
  
  const selectedProducts = Array.from(checkedBoxes).map(cb => ({
    id: cb.value,
    name: cb.dataset.name
  }));
  
  // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  countSpan.textContent = `(${selectedProducts.length}ê°œ ì„ íƒ)`;
  
  // ë§ˆì§„ìœ¨ ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
  document.querySelectorAll('input[name="deal-products"]').forEach(cb => {
    const marginInput = cb.closest('label').querySelector('.margin-rate-input');
    if (marginInput) {
      marginInput.style.display = cb.checked ? 'flex' : 'none';
    }
    // ì²´í¬ë°•ìŠ¤ border ì—…ë°ì´íŠ¸
    cb.closest('label').style.borderColor = cb.checked ? 'var(--primary)' : 'var(--gray-200)';
  });
  
  // íƒœê·¸ í‘œì‹œ ì—…ë°ì´íŠ¸
  if (selectedProducts.length === 0) {
    displayContainer.style.display = 'none';
  } else {
    displayContainer.style.display = 'block';
    displayContainer.innerHTML = `
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${selectedProducts.map(p => {
          const marginInput = document.querySelector(`.product-margin-rate[data-product-id="${p.id}"]`);
          const marginRate = marginInput ? marginInput.value : '';
          return `
          <div class="selected-product-tag" data-id="${p.id}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); border: 1px solid var(--primary); border-radius: 20px; font-size: 13px;">
            <span style="color: var(--primary); font-weight: 500;">${p.name}</span>
            ${marginRate ? `<span style="color: var(--gray-600); font-size: 11px;">(${marginRate}%)</span>` : ''}
            <button type="button" onclick="removeSelectedProduct('${p.id}')" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">Ã—</button>
          </div>
        `}).join('')}
      </div>
    `;
  }
}

// ì„ íƒëœ ìƒí’ˆ íƒœê·¸ì—ì„œ ì œê±°
function removeSelectedProduct(productId) {
  const checkbox = document.querySelector(`input[name="deal-products"][value="${productId}"]`);
  if (checkbox) {
    checkbox.checked = false;
    // ì²´í¬ë°•ìŠ¤ì˜ ë¶€ëª¨ label ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    const label = checkbox.closest('label');
    if (label) {
      label.style.borderColor = 'var(--gray-200)';
    }
  }
  updateSelectedProductsDisplay();
}

function submitDealForm(e, id) {
  e.preventDefault();
  
  // ì„ íƒëœ ìƒí’ˆ IDì™€ ë§ˆì§„ìœ¨ ìˆ˜ì§‘
  const selectedProducts = Array.from(document.querySelectorAll('input[name="deal-products"]:checked'))
    .map(cb => {
      const marginInput = document.querySelector(`.product-margin-rate[data-product-id="${cb.value}"]`);
      return {
        productId: cb.value,
        productName: cb.dataset.name,
        marginRate: marginInput ? Number(marginInput.value) || 0 : 0
      };
    });
  
  // ë¼ë””ì˜¤ ë²„íŠ¼ì—ì„œ ìƒíƒœ ê°’ ê°€ì ¸ì˜¤ê¸°
  const statusRadio = document.querySelector('input[name="deal-status"]:checked');
  
  const data = {
    title: document.getElementById('deal-title').value,
    supplierId: document.getElementById('deal-supplier').value,
    sellerId: document.getElementById('deal-seller').value,
    startDate: document.getElementById('deal-start').value,
    endDate: document.getElementById('deal-end').value,
    status: statusRadio ? statusRadio.value : 'negotiating',
    notes: document.getElementById('deal-notes').value,
    selectedProducts: selectedProducts,  // ì´ì œ ê°ì²´ ë°°ì—´: [{productId, productName, marginRate}]
    // ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸
    journeySample: document.getElementById('journey-sample')?.checked || false,
    journeyPaymentLink: document.getElementById('journey-payment-link')?.checked || false,
    journeyContent: document.getElementById('journey-content')?.checked || false,
    updatedAt: new Date().toISOString()
  };
  if (id) data.id = id;
  else data.createdAt = new Date().toISOString();
  saveDeal(data);
}

function openSupplierModal(supplier = null, bulk = false) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  if (bulk) {
    // ì¼ê´„ ë“±ë¡ì€ ì œê±°í•˜ê³  ë‹¨ìˆœ ì•ˆë‚´ë¡œ ë³€ê²½
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ê³µê¸‰ì‚¬ ë“±ë¡ ì•ˆë‚´</h2>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div style="padding: 20px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ­</div>
          <p>ê³µê¸‰ì‚¬ëŠ” ê°œë³„ ë“±ë¡ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
          <p style="color: var(--gray-500); font-size: 14px;">ì‚¬ì—…ìë“±ë¡ì¦, í†µì¥ì‚¬ë³¸ ë“± ì²¨ë¶€íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary" onclick="closeModal(); openSupplierModal()">ê°œë³„ ë“±ë¡í•˜ê¸°</button>
        </div>
      </div>
    `;
    return;
  }
  
  const isEdit = supplier !== null;
  const s = supplier || { 
    name: '', supplierType: 'external', website: '', 
    managerName: '', managerTitle: '', managerPhone: '', managerEmail: '',
    inquiryMethod: '', contractStatus: 'pending',
    businessLicenseUrl: '', bankBookUrl: '', bankAccount: '',
    notes: '', products: []
  };
  
  // í•´ë‹¹ ê³µê¸‰ì‚¬ì˜ ìƒí’ˆ ëª©ë¡ (ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ, ìƒˆ ë“±ë¡ ì‹œì—ëŠ” ë¹ˆ ë°°ì—´)
  const supplierProducts = isEdit ? (state.supplierProducts || []).filter(p => p.supplierId === s.id) : [];
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ­ ${isEdit ? 'ê³µê¸‰ì‚¬ ìˆ˜ì •' : 'ìƒˆ ê³µê¸‰ì‚¬ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitSupplierForm(event, '${s.id || ''}')" style="max-height: 75vh; overflow-y: auto; padding-right: 8px;">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="form-label">ê³µê¸‰ì‚¬ëª… <span style="color: var(--danger);">*</span></label>
              <input type="text" class="form-input" id="supplier-name" value="${s.name}" required placeholder="ì˜ˆ: ABC ì‹í’ˆ">
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">ìœ í˜• <span style="color: var(--danger);">*</span></label>
              <select class="form-input" id="supplier-type" required onchange="updateSupplierProductSection()">
                <option value="inhouse" ${s.supplierType === 'inhouse' ? 'selected' : ''}>ìì‚¬</option>
                <option value="external" ${s.supplierType === 'external' ? 'selected' : ''}>íƒ€ì‚¬</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">í™ˆí˜ì´ì§€</label>
            <input type="text" class="form-input" id="supplier-website" value="${s.website || ''}" placeholder="https://example.com">
          </div>
        </div>
        
        <!-- ë‹´ë‹¹ì ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ‘¤ ë‹´ë‹¹ì ì •ë³´</h3>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ë‹´ë‹¹ìëª…</label>
              <input type="text" class="form-input" id="supplier-manager-name" value="${s.managerName || ''}" placeholder="í™ê¸¸ë™">
            </div>
            <div class="form-group">
              <label class="form-label">ì§ê¸‰ (ì„ íƒ)</label>
              <input type="text" class="form-input" id="supplier-manager-title" value="${s.managerTitle || ''}" placeholder="ê³¼ì¥, ëŒ€ë¦¬ ë“±">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì—°ë½ì²˜</label>
              <input type="text" class="form-input" id="supplier-manager-phone" value="${s.managerPhone || s.contact || ''}" placeholder="010-1234-5678">
            </div>
            <div class="form-group">
              <label class="form-label">ì´ë©”ì¼</label>
              <input type="email" class="form-input" id="supplier-manager-email" value="${s.managerEmail || ''}" placeholder="manager@example.com">
            </div>
          </div>
        </div>
        
        <!-- ğŸ†• ìƒí’ˆ ë“±ë¡ ì„¹ì…˜ - ê³µê¸‰ì‚¬ ìƒí’ˆ DB ì—°ë™ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-300);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="font-size: 13px; color: var(--gray-700); margin: 0; font-weight: 600;">ğŸ“¦ ìƒí’ˆ ê´€ë¦¬</h3>
          </div>
          <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 16px;">ì´ ê³µê¸‰ì‚¬ì˜ ìƒí’ˆì€ ê³µê¸‰ì‚¬ ìƒí’ˆ DBì—ì„œ í†µí•© ê´€ë¦¬ë©ë‹ˆë‹¤.</p>
          
          <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; border: 1px dashed var(--gray-300);">
            <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“¦</div>
            <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">
              ìƒí’ˆ ë“±ë¡, ìˆ˜ì •, ì‚­ì œëŠ”<br><strong>ê³µê¸‰ì‚¬ ìƒí’ˆ DB</strong>ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”.
            </p>
            <button type="button" class="btn btn-primary" onclick="closeModal(); switchTab('productDB');">
              ğŸ“¦ ê³µê¸‰ì‚¬ ìƒí’ˆ DBë¡œ ì´ë™
            </button>
          </div>
        </div>
        
        <!-- ìƒí’ˆ ë¬¸ì˜ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ’¬ ìƒí’ˆ ë¬¸ì˜ ë°©ì•ˆ</h3>
          <div class="form-group" style="margin: 0;">
            <textarea class="form-textarea" id="supplier-inquiry" rows="2" placeholder="ì¹´ì¹´ì˜¤í†¡ ì±„ë„, ì „í™” ë“± ë³„ë„ ë¬¸ì˜ ë°©ë²•">${s.inquiryMethod || ''}</textarea>
          </div>
        </div>
        
        <!-- ê³„ì•½ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">âœ… ê³„ì•½ ì •ë³´</h3>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ê³„ì•½ ìƒíƒœ</label>
              <select class="form-input" id="supplier-contract-status">
                <option value="pending" ${s.contractStatus === 'pending' ? 'selected' : ''}>â³ í˜‘ì˜ì¤‘</option>
                <option value="completed" ${s.contractStatus === 'completed' ? 'selected' : ''}>âœ… ê³„ì•½ì™„ë£Œ</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">í†µì¥ë²ˆí˜¸</label>
              <input type="text" class="form-input" id="supplier-bank-account" value="${s.bankAccount || ''}" placeholder="ì€í–‰ëª… / ê³„ì¢Œë²ˆí˜¸">
            </div>
          </div>
          
          <!-- ì„œë¥˜ ìˆ˜ë ¹ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
          <div style="background: white; border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <label class="form-label" style="margin: 0;">ğŸ“‹ ì„œë¥˜ ìˆ˜ë ¹ ì²´í¬ë¦¬ìŠ¤íŠ¸</label>
              <div id="supplier-checklist-progress" style="font-size: 12px; color: var(--gray-500);">0/4 ì™„ë£Œ</div>
            </div>
            
            <!-- ì§„í–‰ë¥  ë°” -->
            <div style="height: 6px; background: var(--gray-200); border-radius: 3px; margin-bottom: 16px; overflow: hidden;">
              <div id="supplier-progress-bar" style="height: 100%; background: var(--success); border-radius: 3px; transition: width 0.3s ease; width: 0%;"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="supplier-has-product-info" ${s.hasProductInfo ? 'checked' : ''} onchange="updateSupplierProgress()" style="width: 20px; height: 20px; accent-color: var(--success);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ“¦ ìƒí’ˆë“±ë¡</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="supplier-has-business-license" ${s.hasBusinessLicense ? 'checked' : ''} onchange="updateSupplierProgress()" style="width: 20px; height: 20px; accent-color: var(--success);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ¢ ì‚¬ì—…ì</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="supplier-has-bank-account" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSupplierProgress()" style="width: 20px; height: 20px; accent-color: var(--success);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ¦ í†µì¥</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="supplier-has-contract" ${s.hasContract ? 'checked' : ''} onchange="updateSupplierProgress()" style="width: 20px; height: 20px; accent-color: var(--success);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ“ ê³„ì•½</span>
              </label>
            </div>
            
            <!-- êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°”ë¡œê°€ê¸° ë²„íŠ¼ -->
            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--gray-300);">
              <a href="#" id="supplier-gdrive-link" onclick="openSupplierGDrive('${s.id || ''}')" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(66,133,244,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                  <path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/>
                </svg>
                ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ì„œë¥˜ ê´€ë¦¬
              </a>
            </div>
          </div>
        </div>
        
        <!-- ğŸ” ë¡œê·¸ì¸ ì •ë³´ (ì¼ì •í‘œ ê³µìœ ìš©) -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--gray-300);">
          <h3 style="font-size: 14px; color: #6d28d9; margin-bottom: 8px;">ğŸ” ì¼ì •í‘œ ë¡œê·¸ì¸ ì •ë³´</h3>
          <p style="font-size: 12px; color: #7c3aed; margin-bottom: 12px;">ê³µê¸‰ì‚¬ê°€ ì¼ì •í‘œì— ì ‘ì†í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê³„ì •ì…ë‹ˆë‹¤.</p>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì•„ì´ë””</label>
              <input type="text" class="form-input" id="supplier-login-id" value="${s.loginId || ''}" placeholder="ì˜ˆ: grohome" style="background: white;">
            </div>
            <div class="form-group">
              <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="text" class="form-input" id="supplier-login-pw" value="${s.loginPw || ''}" placeholder="ì˜ˆ: 1234" style="background: white;">
            </div>
          </div>
        </div>
        
        <!-- ê¸°íƒ€ ì‚¬í•­ -->
        <div class="form-group">
          <label class="form-label">ê¸°íƒ€ì‚¬í•­</label>
          <textarea class="form-textarea" id="supplier-notes" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨">${s.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSupplier('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  // ëª¨ë‹¬ ì—´ë¦° í›„ ì§„í–‰ë¥  ì´ˆê¸°í™”
  setTimeout(() => updateSupplierProgress(), 50);
}

// ========== ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  í•¨ìˆ˜ ==========

// ê³µê¸‰ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (4ê°œ í•­ëª©)
function updateSupplierProgress() {
  const checkboxes = [
    'supplier-has-product-info',
    'supplier-has-business-license',
    'supplier-has-bank-account',
    'supplier-has-contract'
  ];
  
  let checked = 0;
  const total = checkboxes.length;
  
  checkboxes.forEach(id => {
    const cb = document.getElementById(id);
    if (cb && cb.checked) checked++;
    
    // ì²´í¬ëœ í•­ëª© ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    const label = cb?.closest('.checklist-item');
    if (label) {
      if (cb.checked) {
        label.style.background = 'var(--success-light)';
        label.style.borderColor = 'var(--success)';
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.borderColor = 'var(--gray-200)';
      }
    }
  });
  
  const progress = document.getElementById('supplier-checklist-progress');
  const progressBar = document.getElementById('supplier-progress-bar');
  
  if (progress) {
    progress.textContent = `${checked}/${total} ì™„ë£Œ`;
    progress.style.color = checked === total ? 'var(--success)' : 'var(--gray-500)';
  }
  if (progressBar) {
    progressBar.style.width = `${(checked / total) * 100}%`;
    progressBar.style.background = checked === total ? 'var(--success)' : 'var(--primary)';
  }
}

// ì…€ëŸ¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (4ê°œ í•­ëª©)
function updateSellerProgress() {
  const checkboxes = [
    'seller-has-id-card',
    'seller-has-bank-account'
  ];
  
  let checked = 0;
  const total = checkboxes.length;
  
  checkboxes.forEach(id => {
    const cb = document.getElementById(id);
    if (cb && cb.checked) checked++;
    
    // ì²´í¬ëœ í•­ëª© ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    const label = cb?.closest('.checklist-item');
    if (label) {
      if (cb.checked) {
        label.style.background = 'var(--success-light)';
        label.style.borderColor = 'var(--success)';
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.borderColor = 'var(--gray-200)';
      }
    }
  });
  
  const progress = document.getElementById('seller-checklist-progress');
  const progressBar = document.getElementById('seller-progress-bar');
  
  if (progress) {
    progress.textContent = `${checked}/${total} ì™„ë£Œ`;
    progress.style.color = checked === total ? 'var(--success)' : 'var(--gray-500)';
  }
  if (progressBar) {
    progressBar.style.width = `${(checked / total) * 100}%`;
    progressBar.style.background = checked === total ? 'var(--success)' : 'var(--primary)';
  }
}

// ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ í•¨ìˆ˜ ==========

// êµ¬ê¸€ ë“œë¼ì´ë¸Œ ê¸°ë³¸ ë§í¬ (ë‚˜ì¤‘ì— ì‹¤ì œ ë§í¬ë¡œ êµì²´)
const GDRIVE_BASE_URL = 'https://drive.google.com/drive/folders/';
const GDRIVE_SUPPLIER_FOLDER = ''; // ê³µê¸‰ì‚¬ í´ë” ID (ë‚˜ì¤‘ì— ì„¤ì •)
const GDRIVE_SELLER_FOLDER = ''; // ì…€ëŸ¬ í´ë” ID (ë‚˜ì¤‘ì— ì„¤ì •)

// ê³µê¸‰ì‚¬ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°
function openSupplierGDrive(supplierId) {
  // ê³µê¸‰ì‚¬ë³„ í´ë”ê°€ ìˆìœ¼ë©´ í•´ë‹¹ í´ë”ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ í´ë”ë¡œ
  const supplier = state.suppliers.find(s => s.id === supplierId);
  const folderUrl = supplier?.gdriveFolder || (GDRIVE_SUPPLIER_FOLDER ? GDRIVE_BASE_URL + GDRIVE_SUPPLIER_FOLDER : '');
  
  if (folderUrl) {
    window.open(folderUrl, '_blank');
  } else {
    // í´ë” ë§í¬ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
  }
}

// ì…€ëŸ¬ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°
function openSellerGDrive(sellerId) {
  // ì…€ëŸ¬ë³„ í´ë”ê°€ ìˆìœ¼ë©´ í•´ë‹¹ í´ë”ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ í´ë”ë¡œ
  const seller = state.sellers.find(s => s.id === sellerId);
  const folderUrl = seller?.gdriveFolder || (GDRIVE_SELLER_FOLDER ? GDRIVE_BASE_URL + GDRIVE_SELLER_FOLDER : '');
  
  if (folderUrl) {
    window.open(folderUrl, '_blank');
  } else {
    // í´ë” ë§í¬ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
  }
}

// ========== ì…€ëŸ¬ ê³„ì•½ ê±´ìˆ˜ ì¡°ì • í•¨ìˆ˜ ==========

// ê³„ì•½ ê±´ìˆ˜ ì¡°ì • (â–¼â–² ë²„íŠ¼)
function adjustContractCount(delta) {
  const input = document.getElementById('seller-contract-count');
  if (!input) return;
  
  let value = parseInt(input.value) || 1;
  value = Math.max(1, Math.min(99, value + delta));
  input.value = value;
  
  updateContractCountDisplay();
}

// ê³„ì•½ ê±´ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateContractCountDisplay() {
  const input = document.getElementById('seller-contract-count');
  const display = document.getElementById('contract-count-display');
  const totalNum = document.getElementById('contract-total-num');
  
  if (!input || !display || !totalNum) return;
  
  const count = parseInt(input.value) || 1;
  totalNum.textContent = count;
  
  // ê±´ìˆ˜ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
  if (count >= 1) {
    display.style.background = 'var(--success-light)';
    display.style.color = 'var(--success)';
  }
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ í–‰ ì¶”ê°€
function addSupplierProductRow() {
  const container = document.getElementById('supplier-products-list');
  const emptyMsg = document.getElementById('supplier-products-empty');
  if (emptyMsg) emptyMsg.remove();
  
  // í˜„ì¬ ì„ íƒëœ ê³µê¸‰ì‚¬ ìœ í˜• í™•ì¸
  const supplierType = document.getElementById('supplier-type')?.value || 'external';
  const isInhouse = supplierType === 'inhouse';
  
  if (isInhouse) {
    // ìì‚¬: ìƒí’ˆëª…, ì†Œë¹„ìì •ê°€, ê³µêµ¬íŒë§¤ê°€, ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ
    container.insertAdjacentHTML('beforeend', `
      <div class="supplier-product-row" style="display: grid; grid-template-columns: 2fr 90px 90px 90px 36px; gap: 8px; align-items: center; padding: 8px; background: #fff; margin-bottom: 1px; border-bottom: 1px solid var(--gray-100);">
        <input type="text" class="form-input sp-name" placeholder="ìƒí’ˆëª…" style="font-size: 12px;">
        <input type="number" class="form-input sp-retail-price" placeholder="ì†Œë¹„ìì •ê°€" style="font-size: 12px; text-align: right;">
        <input type="number" class="form-input sp-sale-price" placeholder="ê³µêµ¬íŒë§¤ê°€" style="font-size: 12px; text-align: right;">
        <input type="number" class="form-input sp-margin-fee" placeholder="ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ" style="font-size: 12px; text-align: right; background: var(--gray-50);">
        <button type="button" onclick="removeSupplierProductRow(this)" style="background: none; border: none; color: var(--gray-400); font-size: 16px; cursor: pointer;">Ã—</button>
      </div>
    `);
  } else {
    // íƒ€ì‚¬: ìƒí’ˆëª…, ê³µêµ¬íŒë§¤ê°€, ê³µê¸‰ë‹¨ê°€, ìˆ˜ìˆ˜ë£Œ% (ìë™ê³„ì‚°)
    container.insertAdjacentHTML('beforeend', `
      <div class="supplier-product-row" style="display: grid; grid-template-columns: 2fr 90px 90px 70px 36px; gap: 8px; align-items: center; padding: 8px; background: #fff; margin-bottom: 1px; border-bottom: 1px solid var(--gray-100);">
        <input type="text" class="form-input sp-name" placeholder="ìƒí’ˆëª…" style="font-size: 12px;">
        <input type="number" class="form-input sp-sale-price" placeholder="ê³µêµ¬íŒë§¤ê°€" style="font-size: 12px; text-align: right;" onchange="calcSupplyOrFee(this, 'sale')">
        <input type="number" class="form-input sp-supply-price" placeholder="ê³µê¸‰ë‹¨ê°€" style="font-size: 12px; text-align: right;" onchange="calcSupplyOrFee(this, 'supply')">
        <input type="number" class="form-input sp-fee-percent" placeholder="%" step="0.1" style="font-size: 12px; text-align: right; background: var(--gray-50);" onchange="calcSupplyOrFee(this, 'percent')">
        <button type="button" onclick="removeSupplierProductRow(this)" style="background: none; border: none; color: var(--gray-400); font-size: 16px; cursor: pointer;">Ã—</button>
      </div>
    `);
  }
}

// ê³µê¸‰ë‹¨ê°€/ìˆ˜ìˆ˜ë£Œ% ìë™ ê³„ì‚°
function calcSupplyOrFee(input, changedField) {
  const row = input.closest('.supplier-product-row');
  const salePrice = Number(row.querySelector('.sp-sale-price')?.value) || 0;
  const supplyPrice = row.querySelector('.sp-supply-price');
  const feePercent = row.querySelector('.sp-fee-percent');
  
  if (!supplyPrice || !feePercent || salePrice === 0) return;
  
  if (changedField === 'sale') {
    // íŒë§¤ê°€ ë³€ê²½ ì‹œ: ê³µê¸‰ë‹¨ê°€ê°€ ìˆìœ¼ë©´ ìˆ˜ìˆ˜ë£Œ% ê³„ì‚°, ìˆ˜ìˆ˜ë£Œ%ê°€ ìˆìœ¼ë©´ ê³µê¸‰ë‹¨ê°€ ê³„ì‚°
    const supply = Number(supplyPrice.value) || 0;
    const percent = Number(feePercent.value) || 0;
    
    if (supply > 0) {
      // ìˆ˜ìˆ˜ë£Œ% = (íŒë§¤ê°€ - ê³µê¸‰ë‹¨ê°€) / íŒë§¤ê°€ * 100
      feePercent.value = Math.round((salePrice - supply) / salePrice * 100 * 10) / 10;
    } else if (percent > 0) {
      // ê³µê¸‰ë‹¨ê°€ = íŒë§¤ê°€ * (1 - ìˆ˜ìˆ˜ë£Œ%/100)
      supplyPrice.value = Math.round(salePrice * (1 - percent / 100));
    }
  } else if (changedField === 'supply') {
    // ê³µê¸‰ë‹¨ê°€ ì…ë ¥ ì‹œ â†’ ìˆ˜ìˆ˜ë£Œ% ìë™ ê³„ì‚°
    const supply = Number(supplyPrice.value) || 0;
    if (salePrice > 0 && supply > 0) {
      feePercent.value = Math.round((salePrice - supply) / salePrice * 100 * 10) / 10;
    }
  } else if (changedField === 'percent') {
    // ìˆ˜ìˆ˜ë£Œ% ì…ë ¥ ì‹œ â†’ ê³µê¸‰ë‹¨ê°€ ìë™ ê³„ì‚°
    const percent = Number(feePercent.value) || 0;
    if (salePrice > 0 && percent > 0) {
      supplyPrice.value = Math.round(salePrice * (1 - percent / 100));
    }
  }
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ í–‰ ì‚­ì œ
function removeSupplierProductRow(btn) {
  const row = btn.closest('.supplier-product-row');
  row.remove();
}

// ê³µê¸‰ì‚¬ ìœ í˜• ë³€ê²½ ì‹œ ìƒí’ˆ ì„¹ì…˜ ì—…ë°ì´íŠ¸
function updateSupplierProductSection() {
  const supplierType = document.getElementById('supplier-type')?.value || 'external';
  const isInhouse = supplierType === 'inhouse';
  
  // ë¼ë²¨ ì—…ë°ì´íŠ¸
  const typeLabel = document.getElementById('supplier-product-type-label');
  if (typeLabel) {
    typeLabel.textContent = `(${isInhouse ? 'ìì‚¬' : 'íƒ€ì‚¬'} ìƒí’ˆ)`;
  }
  
  // í—¤ë” ì—…ë°ì´íŠ¸
  const header = document.getElementById('supplier-product-header');
  if (header) {
    if (isInhouse) {
      header.style.gridTemplateColumns = '2fr 90px 90px 90px 36px';
      header.innerHTML = `
        <div>ìƒí’ˆëª…</div>
        <div style="text-align: right;">ì†Œë¹„ìì •ê°€</div>
        <div style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</div>
        <div style="text-align: right;">ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ</div>
        <div></div>
      `;
    } else {
      header.style.gridTemplateColumns = '2fr 90px 90px 70px 36px';
      header.innerHTML = `
        <div>ìƒí’ˆëª…</div>
        <div style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</div>
        <div style="text-align: right;">ê³µê¸‰ë‹¨ê°€</div>
        <div style="text-align: right;">ìˆ˜ìˆ˜ë£Œ%</div>
        <div></div>
      `;
    }
  }
  
  // ê¸°ì¡´ ìƒí’ˆ ëª©ë¡ì´ ìˆìœ¼ë©´ ê²½ê³ 
  const productRows = document.querySelectorAll('.supplier-product-row');
  if (productRows.length > 0) {
    const confirmChange = confirm(`ìœ í˜•ì„ ë³€ê²½í•˜ë©´ ê¸°ì¡´ ì…ë ¥í•œ ìƒí’ˆ ${productRows.length}ê°œê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if (confirmChange) {
      // ê¸°ì¡´ ìƒí’ˆ ì‚­ì œ
      const container = document.getElementById('supplier-products-list');
      container.innerHTML = `
        <div id="supplier-products-empty" style="text-align: center; padding: 20px; color: var(--gray-600); font-size: 13px;">
          + ìƒí’ˆ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒí’ˆì„ ë“±ë¡í•˜ì„¸ìš”
        </div>
      `;
    } else {
      // ì·¨ì†Œ ì‹œ ì›ë˜ ìœ í˜•ìœ¼ë¡œ ë³µì›
      document.getElementById('supplier-type').value = isInhouse ? 'external' : 'inhouse';
      updateSupplierProductSection();
    }
  }
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
function downloadSupplierProductTemplate() {
  const supplierType = document.getElementById('supplier-type')?.value || 'external';
  const isInhouse = supplierType === 'inhouse';
  
  let ws, filename;
  
  if (isInhouse) {
    // ìì‚¬ ì–‘ì‹: ìƒí’ˆëª…, ì†Œë¹„ìì •ê°€, ê³µêµ¬íŒë§¤ê°€, ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ
    ws = XLSX.utils.aoa_to_sheet([
      ['ìƒí’ˆëª…', 'ì†Œë¹„ìì •ê°€', 'ê³µêµ¬íŒë§¤ê°€', 'ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ'],
      ['ì˜ˆì‹œ: í”„ë¦¬ë¯¸ì—„ ì´ìœ ì‹ 10íŒ©', '50000', '45000', '5000'],
      ['ì˜ˆì‹œ: ìœ ê¸°ë† ìŒ€ê³¼ì ì„¸íŠ¸', '30000', '27000', '3000']
    ]);
    filename = 'ìì‚¬ìƒí’ˆ_ì–‘ì‹.xlsx';
  } else {
    // íƒ€ì‚¬ ì–‘ì‹: ìƒí’ˆëª…, ê³µêµ¬íŒë§¤ê°€, ê³µê¸‰ë‹¨ê°€(V+)
    ws = XLSX.utils.aoa_to_sheet([
      ['ìƒí’ˆëª…', 'ê³µêµ¬íŒë§¤ê°€', 'ê³µê¸‰ë‹¨ê°€(V+)'],
      ['ì˜ˆì‹œ: ìœ ê¸°ë† ìŒ€ê³¼ì 10ë´‰', '17100', '12000'],
      ['ì˜ˆì‹œ: ABCì£¼ìŠ¤ 2ë°•ìŠ¤', '56700', '45000']
    ]);
    filename = 'íƒ€ì‚¬ìƒí’ˆ_ì–‘ì‹.xlsx';
  }
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ìƒí’ˆëª©ë¡');
  XLSX.writeFile(wb, filename);
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ ì—‘ì…€ ì—…ë¡œë“œ
function handleSupplierProductExcel(file) {
  if (!file) return;
  
  const supplierType = document.getElementById('supplier-type')?.value || 'external';
  const isInhouse = supplierType === 'inhouse';
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      const container = document.getElementById('supplier-products-list');
      const emptyMsg = document.getElementById('supplier-products-empty');
      if (emptyMsg) emptyMsg.remove();
      
      // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° í–‰ ì²˜ë¦¬
      let count = 0;
      jsonData.slice(1).forEach(row => {
        if (!row[0]) return; // ìƒí’ˆëª… ì—†ìœ¼ë©´ ìŠ¤í‚µ
        
        if (isInhouse) {
          // ìì‚¬: ìƒí’ˆëª…, ì†Œë¹„ìì •ê°€, ê³µêµ¬íŒë§¤ê°€, ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ
          container.insertAdjacentHTML('beforeend', `
            <div class="supplier-product-row" style="display: grid; grid-template-columns: 2fr 90px 90px 90px 36px; gap: 8px; align-items: center; padding: 8px; background: #fff; margin-bottom: 1px; border-bottom: 1px solid var(--gray-100);">
              <input type="text" class="form-input sp-name" value="${row[0] || ''}" placeholder="ìƒí’ˆëª…" style="font-size: 13px;">
              <input type="number" class="form-input sp-retail-price" value="${row[1] || ''}" placeholder="ì†Œë¹„ìì •ê°€" style="font-size: 13px; text-align: right;">
              <input type="number" class="form-input sp-sale-price" value="${row[2] || ''}" placeholder="ê³µêµ¬íŒë§¤ê°€" style="font-size: 13px; text-align: right;">
              <input type="number" class="form-input sp-margin-fee" value="${row[3] || ''}" placeholder="ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ" style="font-size: 13px; text-align: right; background: var(--gray-50);">
              <button type="button" onclick="removeSupplierProductRow(this)" style="background: none; border: none; color: var(--danger); font-size: 18px; cursor: pointer;">Ã—</button>
            </div>
          `);
        } else {
          // íƒ€ì‚¬: ìƒí’ˆëª…, ê³µêµ¬íŒë§¤ê°€, ê³µê¸‰ë‹¨ê°€(V+)
          container.insertAdjacentHTML('beforeend', `
            <div class="supplier-product-row" style="display: grid; grid-template-columns: 2fr 100px 100px 36px; gap: 8px; align-items: center; padding: 8px; background: #fff; margin-bottom: 1px; border-bottom: 1px solid var(--gray-100);">
              <input type="text" class="form-input sp-name" value="${row[0] || ''}" placeholder="ìƒí’ˆëª…" style="font-size: 13px;">
              <input type="number" class="form-input sp-sale-price" value="${row[1] || ''}" placeholder="ê³µêµ¬íŒë§¤ê°€" style="font-size: 13px; text-align: right;">
              <input type="number" class="form-input sp-supply-price" value="${row[2] || ''}" placeholder="ê³µê¸‰ë‹¨ê°€(V+)" style="font-size: 13px; text-align: right; background: var(--gray-50);">
              <button type="button" onclick="removeSupplierProductRow(this)" style="background: none; border: none; color: var(--danger); font-size: 18px; cursor: pointer;">Ã—</button>
            </div>
          `);
        }
        count++;
      });
      
      showToast(`${count}ê°œ ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
    } catch (err) {
      showToast('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
}

// ê³µê¸‰ì‚¬ ì…ë ¥ ë°©ì‹ ì „í™˜
function showSupplierTextInput() {
  document.getElementById('supplier-excel-upload').style.display = 'none';
  document.getElementById('supplier-text-input').style.display = 'block';
  window.supplierBulkMode = 'text';
}

function showSupplierExcelUpload() {
  document.getElementById('supplier-excel-upload').style.display = 'block';
  document.getElementById('supplier-text-input').style.display = 'none';
  window.supplierBulkMode = 'excel';
}

// ê³µê¸‰ì‚¬ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
let supplierExcelData = [];

function handleSupplierExcelDrop(e) {
  e.preventDefault();
  e.target.style.borderColor = 'var(--gray-300)';
  e.target.style.background = 'transparent';
  const file = e.dataTransfer.files[0];
  if (file) handleSupplierExcelFile(file);
}

function handleSupplierExcelFile(file) {
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      const headers = jsonData[0].map(h => String(h).trim());
      const rows = jsonData.slice(1).filter(row => row.some(cell => cell));
      
      const colMap = {
        name: headers.findIndex(h => h.includes('ê³µê¸‰ì‚¬') || h.includes('ì´ë¦„') || h.toLowerCase().includes('name')),
        contact: headers.findIndex(h => h.includes('ì—°ë½') || h.includes('ì „í™”') || h.toLowerCase().includes('contact')),
        notes: headers.findIndex(h => h.includes('ë©”ëª¨') || h.includes('ë¹„ê³ ') || h.toLowerCase().includes('note'))
      };
      
      supplierExcelData = rows.map(row => ({
        name: colMap.name >= 0 ? String(row[colMap.name] || '').trim() : '',
        contact: colMap.contact >= 0 ? String(row[colMap.contact] || '').trim() : '',
        notes: colMap.notes >= 0 ? String(row[colMap.notes] || '').trim() : ''
      })).filter(item => item.name);
      
      const previewDiv = document.getElementById('supplier-excel-preview');
      const countSpan = document.getElementById('supplier-preview-count');
      const thead = document.querySelector('#supplier-preview-table thead');
      const tbody = document.querySelector('#supplier-preview-table tbody');
      
      countSpan.textContent = `(${supplierExcelData.length}ê°œ)`;
      thead.innerHTML = '<tr><th>ê³µê¸‰ì‚¬ëª…</th><th>ì—°ë½ì²˜</th><th>ë©”ëª¨</th></tr>';
      tbody.innerHTML = supplierExcelData.slice(0, 10).map(s => `
        <tr><td>${s.name}</td><td>${s.contact}</td><td>${s.notes}</td></tr>
      `).join('') + (supplierExcelData.length > 10 ? `<tr><td colspan="3" style="text-align:center;color:var(--gray-500)">... ì™¸ ${supplierExcelData.length - 10}ê°œ</td></tr>` : '');
      
      previewDiv.style.display = 'block';
      showToast(`${supplierExcelData.length}ê°œì˜ ê³µê¸‰ì‚¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
      
    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };
  reader.readAsArrayBuffer(file);
}

function downloadSupplierTemplate() {
  const ws = XLSX.utils.aoa_to_sheet([
    ['ê³µê¸‰ì‚¬ëª…', 'ì—°ë½ì²˜', 'ë©”ëª¨'],
    ['ABC ì‹í’ˆ', '010-1234-5678', 'ê³¼ì¼ ì „ë¬¸'],
    ['XYZ ìœ í†µ', '02-555-1234', ''],
  ]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ê³µê¸‰ì‚¬ëª©ë¡');
  XLSX.writeFile(wb, 'ê³µê¸‰ì‚¬_ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx');
}

async function submitBulkSuppliers() {
  let dataToSubmit = [];
  
  if (window.supplierBulkMode !== 'text' && supplierExcelData.length > 0) {
    dataToSubmit = supplierExcelData;
  } else {
    const text = document.getElementById('bulk-suppliers')?.value?.trim();
    if (!text) {
      showToast('ê³µê¸‰ì‚¬ ëª©ë¡ì„ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    dataToSubmit = lines.map(line => {
      const parts = line.split(',').map(p => p.trim());
      return {
        name: parts[0] || '',
        contact: parts[1] || '',
        notes: parts[2] || ''
      };
    }).filter(item => item.name);
  }
  
  if (dataToSubmit.length === 0) {
    showToast('ë“±ë¡í•  ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  let successCount = 0;
  for (const data of dataToSubmit) {
    try {
      await db.collection('suppliers').add(data);
      successCount++;
    } catch(e) {
      console.error(e);
    }
  }
  
  supplierExcelData = [];
  showToast(`${successCount}ê°œì˜ ê³µê¸‰ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
  closeModal();
}

function submitSupplierForm(e, id) {
  e.preventDefault();
  
  const supplierType = document.getElementById('supplier-type').value;
  const isInhouse = supplierType === 'inhouse';
  
  // ìƒí’ˆ ëª©ë¡ ìˆ˜ì§‘ - ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ í•„ë“œ ìˆ˜ì§‘
  const productRows = document.querySelectorAll('.supplier-product-row');
  const products = [];
  productRows.forEach(row => {
    const name = row.querySelector('.sp-name')?.value.trim();
    const salePrice = row.querySelector('.sp-sale-price')?.value;
    
    if (name) {
      if (isInhouse) {
        // ìì‚¬: ì†Œë¹„ìì •ê°€, ê³µêµ¬íŒë§¤ê°€, ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ
        const retailPrice = row.querySelector('.sp-retail-price')?.value;
        const marginFee = row.querySelector('.sp-margin-fee')?.value;
        products.push({
          productName: name,
          retailPrice: Number(retailPrice) || 0,
          salePrice: Number(salePrice) || 0,
          marginFee: Number(marginFee) || 0,
          supplyPrice: 0, // ìì‚¬ëŠ” ê³µê¸‰ë‹¨ê°€ ì—†ìŒ
          fee: 0,
          existingId: row.dataset.productId || null
        });
      } else {
        // íƒ€ì‚¬: ê³µêµ¬íŒë§¤ê°€, ê³µê¸‰ë‹¨ê°€, ìˆ˜ìˆ˜ë£Œ%
        const supplyPrice = row.querySelector('.sp-supply-price')?.value;
        const feePercent = row.querySelector('.sp-fee-percent')?.value;
        products.push({
          productName: name,
          retailPrice: 0,
          salePrice: Number(salePrice) || 0,
          supplyPrice: Number(supplyPrice) || 0,
          feePercent: Number(feePercent) || 0,
          marginFee: 0, // íƒ€ì‚¬ëŠ” ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ ì—†ìŒ
          existingId: row.dataset.productId || null
        });
      }
    }
  });
  
  const data = {
    name: document.getElementById('supplier-name').value,
    supplierType: supplierType,
    website: document.getElementById('supplier-website').value,
    managerName: document.getElementById('supplier-manager-name').value,
    managerTitle: document.getElementById('supplier-manager-title').value,
    managerPhone: document.getElementById('supplier-manager-phone').value,
    managerEmail: document.getElementById('supplier-manager-email').value,
    inquiryMethod: document.getElementById('supplier-inquiry').value,
    contractStatus: document.getElementById('supplier-contract-status').value,
    bankAccount: document.getElementById('supplier-bank-account').value,
    // ì„œë¥˜ ìˆ˜ë ¹ ì²´í¬ë°•ìŠ¤ (4ê°œ í•­ëª©)
    hasProductInfo: document.getElementById('supplier-has-product-info')?.checked || false,
    hasBusinessLicense: document.getElementById('supplier-has-business-license')?.checked || false,
    hasBankAccount: document.getElementById('supplier-has-bank-account')?.checked || false,
    hasContract: document.getElementById('supplier-has-contract')?.checked || false,
    // ë¡œê·¸ì¸ ì •ë³´
    loginId: document.getElementById('supplier-login-id')?.value || '',
    loginPw: document.getElementById('supplier-login-pw')?.value || '',
    notes: document.getElementById('supplier-notes').value,
    contact: document.getElementById('supplier-manager-phone').value, // í˜¸í™˜ì„±
    _products: products // ìƒí’ˆ ëª©ë¡ (saveSupplierì—ì„œ ì²˜ë¦¬)
  };
  
  if (id) data.id = id;
  saveSupplierWithProducts(data);
}

// ê³µê¸‰ì‚¬ì™€ ìƒí’ˆì„ í•¨ê»˜ ì €ì¥
async function saveSupplierWithProducts(data) {
  const products = data._products || [];
  delete data._products;
  
  const supplierName = data.name;
  const supplierType = data.supplierType;
  
  try {
    let supplierId = data.id;
    
    // ê³µê¸‰ì‚¬ ì €ì¥
    if (data.id) {
      data.updatedAt = new Date().toISOString();
      await db.collection('suppliers').doc(data.id).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      const docRef = await db.collection('suppliers').add(data);
      supplierId = docRef.id;
    }
    
    // ê¸°ì¡´ ìƒí’ˆ ì¤‘ ì‚­ì œëœ ê²ƒ ì²˜ë¦¬
    const existingProducts = (state.supplierProducts || []).filter(p => p.supplierId === supplierId);
    const existingIds = products.filter(p => p.existingId).map(p => p.existingId);
    
    for (const existingProduct of existingProducts) {
      if (!existingIds.includes(existingProduct.id)) {
        // ì‚­ì œëœ ìƒí’ˆ
        await db.collection('supplierProducts').doc(existingProduct.id).delete();
      }
    }
    
    // ìƒí’ˆ ì €ì¥/ì—…ë°ì´íŠ¸
    for (const product of products) {
      const productData = {
        supplierId: supplierId,
        brandName: supplierName,
        supplierType: supplierType,
        productName: product.productName,
        retailPrice: product.retailPrice || 0,  // ì†Œë¹„ìì •ê°€ (ìì‚¬ìš©)
        salePrice: product.salePrice || 0,       // ê³µêµ¬íŒë§¤ê°€
        supplyPrice: product.supplyPrice || 0,   // ê³µê¸‰ë‹¨ê°€(V+) (íƒ€ì‚¬ìš©)
        marginFee: product.marginFee || 0,       // ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ (ìì‚¬ìš©)
        updatedAt: new Date().toISOString()
      };
      
      if (product.existingId) {
        // ê¸°ì¡´ ìƒí’ˆ ì—…ë°ì´íŠ¸
        await db.collection('supplierProducts').doc(product.existingId).update(productData);
      } else {
        // ìƒˆ ìƒí’ˆ ì¶”ê°€
        productData.createdAt = new Date().toISOString();
        await db.collection('supplierProducts').add(productData);
      }
    }
    
    showToast(data.id ? 'ê³µê¸‰ì‚¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ê³µê¸‰ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function openSellerModal(seller = null, bulk = false) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  if (bulk) {
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ì…€ëŸ¬ ì¼ê´„ ë“±ë¡</h2>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
          <button class="btn btn-secondary" style="flex:1" onclick="showSellerTextInput()">ğŸ“ í…ìŠ¤íŠ¸ ì…ë ¥</button>
          <button class="btn btn-primary" style="flex:1" onclick="showSellerExcelUpload()">ğŸ“Š ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        
        <div id="seller-bulk-content">
          <div id="seller-excel-upload">
            <div class="form-group">
              <label class="form-label">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">
                ì—‘ì…€ íŒŒì¼ì˜ ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.<br>
                <strong>í•„ìˆ˜ ì—´:</strong> ì…€ëŸ¬ëª…, ì—°ë½ì²˜, ì±„ë„ë§í¬, íŒ”ë¡œì›Œìˆ˜, ì¹´í…Œê³ ë¦¬, ë©”ëª¨
              </p>
              <div style="border: 2px dashed var(--gray-300); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.15s ease;" 
                   onclick="document.getElementById('excel-file-seller').click()"
                   ondragover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'; event.preventDefault()"
                   ondragleave="this.style.borderColor='var(--gray-300)'; this.style.background='transparent'"
                   ondrop="handleSellerExcelDrop(event)">
                <div style="font-size: 36px; margin-bottom: 8px;">ğŸ“</div>
                <div style="color: var(--gray-700); font-weight: 500;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                <div style="color: var(--gray-500); font-size: 13px; margin-top: 4px;">.xlsx, .xls íŒŒì¼ ì§€ì›</div>
              </div>
              <input type="file" id="excel-file-seller" accept=".xlsx,.xls" style="display:none" onchange="handleSellerExcelFile(this.files[0])">
            </div>
            
            <div id="seller-excel-preview" style="display:none; margin-top: 16px;">
              <div class="form-label">ë¯¸ë¦¬ë³´ê¸° <span id="seller-preview-count" style="color: var(--primary);"></span></div>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 8px;">
                <table class="data-table" id="seller-preview-table">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            
            <div style="margin-top: 16px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px;">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì˜ˆì‹œ</div>
              <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">
                ì¹´í…Œê³ ë¦¬: ìœ¡ì•„, ì‹í’ˆ, ë¯¸ìš©, ìƒí™œ, ì·¨ë¯¸, ê±´ê°• ì¤‘ ì„ íƒ
              </p>
              <div style="overflow-x: auto;">
                <table style="font-size: 12px; border-collapse: collapse; width: 100%;">
                  <tr style="background: var(--primary-light);">
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì…€ëŸ¬ëª…/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì—°ë½ì²˜</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì£¼ì†Œ</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ê³„ì •ë§í¬</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì¹´í…Œê³ ë¦¬</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ë©”ëª¨</th>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ë·°í‹°ë§ˆì¼“(5ë§Œ)</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">010-1234-5678</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ì„œìš¸ì‹œ ê°•ë‚¨êµ¬</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">instagram.com/beauty</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ë¯¸ìš©</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">VIP ì…€ëŸ¬</td>
                  </tr>
                </table>
              </div>
              <button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="downloadSellerTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
          
          <div id="seller-text-input" style="display: none;">
            <div class="form-group">
              <label class="form-label">ì…€ëŸ¬ ëª©ë¡</label>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">
                í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”. (ì‰¼í‘œë¡œ êµ¬ë¶„)<br>
                í˜•ì‹: ì…€ëŸ¬ëª…(íŒ”ë¡œì›Œìˆ˜), ì—°ë½ì²˜, ì£¼ì†Œ, ê³„ì •ë§í¬, ì¹´í…Œê³ ë¦¬, ë©”ëª¨
              </p>
              <textarea class="form-textarea" id="bulk-sellers" rows="10" placeholder="ì˜ˆì‹œ:
ë·°í‹°ë§ˆì¼“(5ë§Œ), 010-1234-5678, ì„œìš¸ì‹œ ê°•ë‚¨êµ¬, instagram.com/beauty, ë¯¸ìš©, VIP ì…€ëŸ¬
í—¬ìŠ¤ìŠ¤í† ì–´(12ë§Œ), 010-2222-3333, ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬, youtube.com/health, ê±´ê°•
ë§˜ìŠ¤í† ì–´(3ë§Œ), 010-4444-5555, ê²½ê¸°ë„ ì„±ë‚¨ì‹œ, blog.naver.com/mom, ìœ¡ì•„, ì‹ ê·œ"></textarea>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="seller-bulk-submit" onclick="submitBulkSellers()">ì¼ê´„ ë“±ë¡</button>
        </div>
      </div>
    `;
    return;
  }
  
  const isEdit = seller !== null;
  const s = seller || { name: '', contact: '', address: '', channelLink: '', followers: '', category: '', notes: '' };
  
  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  const categories = ['ìœ¡ì•„', 'ì‹í’ˆ', 'ë¯¸ìš©', 'ìƒí™œ', 'ì·¨ë¯¸', 'ê±´ê°•'];
  
  // ìˆ˜ì • ì‹œ í•´ë‹¹ ì…€ëŸ¬ì˜ í†µê³„ ê³„ì‚°
  let sellerStatsHtml = '';
  if (isEdit) {
    const sellerSettlements = (state.sellerSettlements || []).filter(ss => ss.sellerName === s.name);
    let totalSalesCount = 0;
    let totalSalesAmount = 0;
    let totalMarginAmount = 0;
    
    sellerSettlements.forEach(ss => {
      const items = ss.salesItems || [];
      totalSalesCount += items.length;
      totalSalesAmount += items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      totalMarginAmount += items.reduce((sum, item) => sum + (Number(item.marginAmount) || 0), 0);
    });
    
    if (totalSalesCount > 0) {
      sellerStatsHtml = `
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <h3 style="font-size: 14px; color: var(--info); margin-bottom: 12px;">ğŸ“Š ì •ì‚° í˜„í™©</h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--gray-600);">ì´ íŒë§¤ê±´</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${totalSalesCount}ê±´</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--gray-600);">ì´ íŒë§¤ì•¡</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--primary);">${totalSalesAmount.toLocaleString()}ì›</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 12px; color: var(--gray-600);">ì´ ë§ˆì§„ê¸ˆ</div>
              <div style="font-size: 18px; font-weight: 700; color: #d97706;">${totalMarginAmount.toLocaleString()}ì›</div>
            </div>
          </div>
        </div>
      `;
    }
  }
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ‘¤ ${isEdit ? 'ì…€ëŸ¬ ìˆ˜ì •' : 'ìƒˆ ì…€ëŸ¬ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitSellerForm(event, '${s.id || ''}')" style="max-height: 75vh; overflow-y: auto; padding-right: 8px;">
        ${sellerStatsHtml}
        
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="form-label">ì…€ëŸ¬ëª…/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜) *</label>
              <input type="text" class="form-input" id="seller-name" value="${s.name}" required placeholder="ì˜ˆ: ë·°í‹°ë§ˆì¼“(5ë§Œ) ë˜ëŠ” í—¬ìŠ¤ìŠ¤í† ì–´(12ë§Œ)">
              <p style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">íŒ”ë¡œì›Œìˆ˜ëŠ” ê´„í˜¸ ì•ˆì— ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
              <select class="form-input" id="seller-category">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${categories.map(cat => `<option value="${cat}" ${s.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì—°ë½ì²˜</label>
              <input type="text" class="form-input" id="seller-contact" value="${s.contact || ''}" placeholder="010-0000-0000">
            </div>
            <div class="form-group">
              <label class="form-label">ì£¼ì†Œ</label>
              <input type="text" class="form-input" id="seller-address" value="${s.address || ''}" placeholder="ë°°ì†¡ì§€ ì£¼ì†Œ">
            </div>
          </div>
        </div>
        
        <!-- ì±„ë„ ì •ë³´ -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ“± ì±„ë„ ì •ë³´</h3>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">ê³„ì •ë§í¬</label>
            <input type="text" class="form-input" id="seller-channelLink" value="${s.channelLink || s.accountLink || ''}" placeholder="ì˜ˆ: https://www.instagram.com/username">
          </div>
        </div>
        
        <!-- ğŸ†• ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (íŒŒì¼ ì²¨ë¶€ ì‚­ì œ) -->
        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
          <h3 style="font-size: 13px; color: var(--gray-700); margin-bottom: 12px; font-weight: 600;">ğŸ“„ ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
          
          <!-- ì„œë¥˜ ìˆ˜ë ¹ ì²´í¬ -->
          <div style="background: white; border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <label class="form-label" style="margin: 0;">ğŸ“‹ ì„œë¥˜ ìˆ˜ë ¹ í˜„í™©</label>
              <div id="seller-checklist-progress" style="font-size: 12px; color: var(--gray-500);">0/4 ì™„ë£Œ</div>
            </div>
            
            <!-- ì§„í–‰ë¥  ë°” -->
            <div style="height: 6px; background: var(--gray-200); border-radius: 3px; margin-bottom: 16px; overflow: hidden;">
              <div id="seller-progress-bar" style="height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s ease; width: 0%;"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <!-- ë¯¼ì¦ -->
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="seller-has-id-card" ${s.hasIdCard ? 'checked' : ''} onchange="updateSellerProgress()" style="width: 20px; height: 20px; accent-color: var(--primary);">
                <span style="font-size: 13px; font-weight: 500;">ğŸªª ë¯¼ì¦</span>
              </label>
              
              <!-- í†µì¥ -->
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200); transition: all 0.15s ease;" class="checklist-item">
                <input type="checkbox" id="seller-has-bank-account" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSellerProgress()" style="width: 20px; height: 20px; accent-color: var(--primary);">
                <span style="font-size: 13px; font-weight: 500;">ğŸ¦ í†µì¥</span>
              </label>
            </div>
            
            <!-- êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°”ë¡œê°€ê¸° ë²„íŠ¼ -->
            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--gray-300);">
              <a href="#" id="seller-gdrive-link" onclick="openSellerGDrive('${s.id || ''}')" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(66,133,244,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                  <path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/>
                </svg>
                ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ì„œë¥˜ ê´€ë¦¬
              </a>
            </div>
          </div>
        </div>
        
        <!-- ğŸ” ë¡œê·¸ì¸ ì •ë³´ (ì¼ì •í‘œ ê³µìœ ìš©) -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--gray-300);">
          <h3 style="font-size: 14px; color: #be185d; margin-bottom: 8px;">ğŸ” ì¼ì •í‘œ ë¡œê·¸ì¸ ì •ë³´</h3>
          <p style="font-size: 12px; color: #db2777; margin-bottom: 12px;">ì…€ëŸ¬ê°€ ì¼ì •í‘œì— ì ‘ì†í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê³„ì •ì…ë‹ˆë‹¤.</p>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì•„ì´ë””</label>
              <input type="text" class="form-input" id="seller-login-id" value="${s.loginId || ''}" placeholder="ì˜ˆ: jinhama" style="background: white;">
            </div>
            <div class="form-group">
              <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="text" class="form-input" id="seller-login-pw" value="${s.loginPw || ''}" placeholder="ì˜ˆ: 1234" style="background: white;">
            </div>
          </div>
        </div>
        
        <!-- ë©”ëª¨ -->
        <div class="form-group">
          <label class="form-label">ë©”ëª¨</label>
          <textarea class="form-textarea" id="seller-notes" rows="3" placeholder="ì¶”ê°€ ì •ë³´">${s.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSeller('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  // ëª¨ë‹¬ ì—´ë¦° í›„ ì§„í–‰ë¥  ë° ê³„ì•½ ê±´ìˆ˜ ì´ˆê¸°í™”
  setTimeout(() => {
    updateSellerProgress();
    updateContractCountDisplay();
  }, 50);
}

// ì…€ëŸ¬ ëª¨ë‹¬ ë‚´ íŒŒì¼ ì—…ë¡œë“œ
// ì…€ëŸ¬ íŒŒì¼ ê´€ë ¨ í•¨ìˆ˜ - ì œê±°ë¨ (êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ê´€ë¦¬)
// ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•´ placeholder í•¨ìˆ˜ ìœ ì§€
function uploadSellerDocInModal() { console.log('íŒŒì¼ ì²¨ë¶€ ê¸°ëŠ¥ì´ êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
function removeSellerDoc() { console.log('íŒŒì¼ ì‚­ì œ ê¸°ëŠ¥ì´ êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
function viewSellerDocument() { showToast('ì„œë¥˜ëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ í™•ì¸í•˜ì„¸ìš”.'); }
function viewSellerContracts() { showToast('ê³„ì•½ì„œëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ í™•ì¸í•˜ì„¸ìš”.'); }
function viewSingleContract() { showToast('ê³„ì•½ì„œëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ í™•ì¸í•˜ì„¸ìš”.'); }
function deleteSellerContract() { showToast('ê³„ì•½ì„œ ê´€ë¦¬ëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ì§„í–‰í•˜ì„¸ìš”.'); }
function uploadSellerDocDirect() { showToast('íŒŒì¼ ì—…ë¡œë“œëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
function openDocumentViewer() { showToast('ì„œë¥˜ í™•ì¸ì€ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ì§„í–‰í•˜ì„¸ìš”.'); }


// ì…€ëŸ¬ ì„œë¥˜ ì§ì ‘ ì—…ë¡œë“œ (í…Œì´ë¸”ì—ì„œ)
// ì…€ëŸ¬ ì…ë ¥ ë°©ì‹ ì „í™˜
function showSellerTextInput() {
  document.getElementById('seller-excel-upload').style.display = 'none';
  document.getElementById('seller-text-input').style.display = 'block';
  window.sellerBulkMode = 'text';
}

function showSellerExcelUpload() {
  document.getElementById('seller-excel-upload').style.display = 'block';
  document.getElementById('seller-text-input').style.display = 'none';
  window.sellerBulkMode = 'excel';
}

// ì…€ëŸ¬ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
let sellerExcelData = [];

function handleSellerExcelDrop(e) {
  e.preventDefault();
  e.target.style.borderColor = 'var(--gray-300)';
  e.target.style.background = 'transparent';
  const file = e.dataTransfer.files[0];
  if (file) handleSellerExcelFile(file);
}

function handleSellerExcelFile(file) {
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      const headers = jsonData[0].map(h => String(h).trim());
      const rows = jsonData.slice(1).filter(row => row.some(cell => cell));
      
      // ì—´ ë§¤í•‘ (ìˆœì„œ: ì…€ëŸ¬ëª…(íŒ”ë¡œì›Œìˆ˜), ì—°ë½ì²˜, ì£¼ì†Œ, ê³„ì •ë§í¬, ì¹´í…Œê³ ë¦¬, ë©”ëª¨)
      const colMap = {
        name: headers.findIndex(h => h.includes('ì…€ëŸ¬') || h.includes('ì´ë¦„') || h.includes('ë‹‰ë„¤ì„') || h.toLowerCase().includes('name')),
        contact: headers.findIndex(h => h.includes('ì—°ë½') || h.includes('ì „í™”') || h.toLowerCase().includes('contact') || h.toLowerCase().includes('phone')),
        address: headers.findIndex(h => h.includes('ì£¼ì†Œ') || h.toLowerCase().includes('address')),
        channelLink: headers.findIndex(h => h.includes('ê³„ì •') || h.includes('ì±„ë„') || h.includes('ë§í¬') || h.toLowerCase().includes('channel') || h.toLowerCase().includes('link')),
        category: headers.findIndex(h => h.includes('ì¹´í…Œê³ ë¦¬') || h.includes('ë¶„ë¥˜') || h.toLowerCase().includes('category')),
        notes: headers.findIndex(h => h.includes('ë©”ëª¨') || h.includes('ë¹„ê³ ') || h.toLowerCase().includes('note') || h.toLowerCase().includes('memo'))
      };
      
      sellerExcelData = rows.map(row => ({
        name: colMap.name >= 0 ? String(row[colMap.name] || '').trim() : '',
        contact: colMap.contact >= 0 ? String(row[colMap.contact] || '').trim() : '',
        address: colMap.address >= 0 ? String(row[colMap.address] || '').trim() : '',
        channelLink: colMap.channelLink >= 0 ? String(row[colMap.channelLink] || '').trim() : '',
        category: colMap.category >= 0 ? String(row[colMap.category] || '').trim() : '',
        notes: colMap.notes >= 0 ? String(row[colMap.notes] || '').trim() : ''
      })).filter(item => item.name);
      
      // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
      const previewDiv = document.getElementById('seller-excel-preview');
      const countSpan = document.getElementById('seller-preview-count');
      const thead = document.querySelector('#seller-preview-table thead');
      const tbody = document.querySelector('#seller-preview-table tbody');
      
      countSpan.textContent = `(${sellerExcelData.length}ëª…)`;
      thead.innerHTML = '<tr><th>ì…€ëŸ¬ëª…(íŒ”ë¡œì›Œ)</th><th>ì—°ë½ì²˜</th><th>ì£¼ì†Œ</th><th>ê³„ì •ë§í¬</th><th>ì¹´í…Œê³ ë¦¬</th><th>ë©”ëª¨</th></tr>';
      tbody.innerHTML = sellerExcelData.slice(0, 10).map(s => `
        <tr>
          <td>${s.name}</td>
          <td>${s.contact}</td>
          <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${s.address}</td>
          <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${s.channelLink}</td>
          <td>${s.category}</td>
          <td>${s.notes}</td>
        </tr>
      `).join('') + (sellerExcelData.length > 10 ? `<tr><td colspan="6" style="text-align:center;color:var(--gray-500)">... ì™¸ ${sellerExcelData.length - 10}ëª…</td></tr>` : '');
      
      previewDiv.style.display = 'block';
      showToast(`${sellerExcelData.length}ëª…ì˜ ì…€ëŸ¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
      
    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ì…€ëŸ¬ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
function downloadSellerTemplate() {
  const ws = XLSX.utils.aoa_to_sheet([
    ['ì…€ëŸ¬ëª…/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)', 'ì—°ë½ì²˜', 'ì£¼ì†Œ', 'ê³„ì •ë§í¬', 'ì¹´í…Œê³ ë¦¬', 'ë©”ëª¨'],
    ['ë·°í‹°ë§ˆì¼“(5ë§Œ)', '010-1234-5678', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬', 'instagram.com/beauty', 'ë¯¸ìš©', 'VIP ì…€ëŸ¬'],
    ['í—¬ìŠ¤ìŠ¤í† ì–´(12ë§Œ)', '010-2222-3333', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬', 'youtube.com/health', 'ê±´ê°•', ''],
    ['ë§˜ìŠ¤í† ì–´(3ë§Œ)', '010-4444-5555', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ', 'blog.naver.com/mom', 'ìœ¡ì•„', 'ì‹ ê·œ'],
  ]);
  
  // ì—´ ë„ˆë¹„ ì„¤ì •
  ws['!cols'] = [
    { wch: 20 }, // ì…€ëŸ¬ëª…
    { wch: 15 }, // ì—°ë½ì²˜
    { wch: 25 }, // ì£¼ì†Œ
    { wch: 30 }, // ê³„ì •ë§í¬
    { wch: 10 }, // ì¹´í…Œê³ ë¦¬
    { wch: 15 }, // ë©”ëª¨
  ];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì…€ëŸ¬ëª©ë¡');
  XLSX.writeFile(wb, 'ì…€ëŸ¬_ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx');
}

async function submitBulkSellers() {
  let dataToSubmit = [];
  
  // ì—‘ì…€ ëª¨ë“œì¸ ê²½ìš°
  if (window.sellerBulkMode !== 'text' && sellerExcelData.length > 0) {
    dataToSubmit = sellerExcelData;
  } else {
    // í…ìŠ¤íŠ¸ ëª¨ë“œ
    const text = document.getElementById('bulk-sellers')?.value?.trim();
    if (!text) {
      showToast('ì…€ëŸ¬ ëª©ë¡ì„ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }
    
    // ìˆœì„œ: ì…€ëŸ¬ëª…(íŒ”ë¡œì›Œìˆ˜), ì—°ë½ì²˜, ì£¼ì†Œ, ê³„ì •ë§í¬, ì¹´í…Œê³ ë¦¬, ë©”ëª¨
    const lines = text.split('\n').filter(line => line.trim());
    dataToSubmit = lines.map(line => {
      const parts = line.split(',').map(p => p.trim());
      return {
        name: parts[0] || '',
        contact: parts[1] || '',
        address: parts[2] || '',
        channelLink: parts[3] || '',
        category: parts[4] || '',
        notes: parts[5] || ''
      };
    }).filter(item => item.name);
  }
  
  if (dataToSubmit.length === 0) {
    showToast('ë“±ë¡í•  ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  let successCount = 0;
  for (const data of dataToSubmit) {
    try {
      await db.collection('sellers').add(data);
      successCount++;
    } catch(e) {
      console.error(e);
    }
  }
  
  sellerExcelData = [];
  showToast(`${successCount}ëª…ì˜ ì…€ëŸ¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
  closeModal();
}

function submitSellerForm(e, id) {
  e.preventDefault();
  const data = {
    name: document.getElementById('seller-name').value,
    contact: document.getElementById('seller-contact').value,
    phone: document.getElementById('seller-contact').value, // í˜¸í™˜ì„±
    address: document.getElementById('seller-address').value,
    channelLink: document.getElementById('seller-channelLink').value,
    accountLink: document.getElementById('seller-channelLink').value, // í˜¸í™˜ì„±
    category: document.getElementById('seller-category').value,
    notes: document.getElementById('seller-notes').value,
    // ë¡œê·¸ì¸ ì •ë³´
    loginId: document.getElementById('seller-login-id')?.value || '',
    loginPw: document.getElementById('seller-login-pw')?.value || '',
    // ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ë¯¼ì¦, í†µì¥ë§Œ)
    hasIdCard: document.getElementById('seller-has-id-card')?.checked || false,
    hasBankAccount: document.getElementById('seller-has-bank-account')?.checked || false,
  };
  
  if (id) data.id = id;
  saveSeller(data);
}

// í—¬í¼ í•¨ìˆ˜
function getSupplierName(id) {
  const s = state.suppliers.find(s => s.id === id);
  return s ? s.name : 'ë¯¸ì§€ì •';
}

function getSellerName(id) {
  const s = state.sellers.find(s => s.id === id);
  return s ? s.name : 'ë¯¸ì§€ì •';
}

function getFilteredDeals() {
  let deals = state.deals;
  if (state.viewFilter === 'supplier' && state.selectedSupplier) {
    deals = deals.filter(d => d.supplierId === state.selectedSupplier);
  } else if (state.viewFilter === 'seller' && state.selectedSeller) {
    deals = deals.filter(d => d.sellerId === state.selectedSeller);
  }
  return deals;
}

function getDealsNeedingSettlement() {
  const today = new Date();
  return state.deals.filter(d => {
    if (d.status !== 'completed') return false;
    if (d.supplierSettled && d.sellerSettled) return false;
    const endDate = parseDate(d.endDate);
    const daysSinceEnd = Math.floor((today - endDate) / (1000 * 60 * 60 * 24));
    return daysSinceEnd >= 0 && daysSinceEnd <= 7;
  });
}

// ë Œë”ë§
function render() {
  const app = document.getElementById('app');
  
  if (state.loading) {
    app.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
    return;
  }
  
  switch (state.currentTab) {
    case 'calendar': renderCalendar(); break;
    case 'deals': renderDeals(); break;
    case 'suppliers': renderSuppliers(); break;
    case 'sellers': renderSellers(); break;
    case 'sellerList': renderSellerList(); break;
    case 'products': renderProducts(); break;
    case 'productDB': renderProductDB(); break;
    case 'dealManagement': renderDealManagement(); break;
    case 'settlement': renderSettlement(); break;
    case 'salesReport': renderSalesReport(); break;
    case 'shareLinks': renderShareLinks(); break;
    case 'partnerMessages': renderPartnerMessages(); break;
    case 'partnerNotices': renderPartnerNotices(); break;
    case 'proposalManagement': renderProposalManagement(); break;
    case 'teamMembers': renderTeamMembers(); break;
    case 'salesDashboard': renderSalesDashboard(); break;
    case 'dataUsage': renderDataUsage(); break;
    case 'inquiries': renderInquiries(); break;
    case 'urgentSales': renderUrgentSales(); break;
    case 'dealCenter': renderDealCenter(); break;
  }
}

// ìƒíƒœë³„ ê³µêµ¬ ëª©ë¡ ëª¨ë‹¬
function openStatusModal(statusType) {
  const today = formatDate(new Date());
  const statusLabels = {
    negotiating: 'í˜‘ì˜ì¤‘',
    confirmed: 'ì§„í–‰ì˜ˆì •',
    ongoing: 'ì§„í–‰ì¤‘',
    completed: 'ì§„í–‰ì™„ë£Œ'
  };
  
  // ìƒíƒœë³„ë¡œ ê³µêµ¬ í•„í„°ë§
  const filteredDeals = state.deals.filter(d => {
    const displayStatus = getDisplayStatus(d);
    if (statusType === 'negotiating') return displayStatus.label === 'í˜‘ì˜ì¤‘';
    if (statusType === 'confirmed') return displayStatus.label === 'ì§„í–‰ì˜ˆì •';
    if (statusType === 'ongoing') return displayStatus.label === 'ì§„í–‰ì¤‘';
    if (statusType === 'completed') return displayStatus.label === 'ì§„í–‰ì™„ë£Œ';
    return false;
  });
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">${statusLabels[statusType]} ê³µêµ¬ ëª©ë¡ (${filteredDeals.length}ê±´)</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px; overflow-y: auto; flex: 1;">
        ${filteredDeals.length === 0 ? `
          <div style="text-align: center; padding: 40px; color: var(--gray-500);">
            ${statusLabels[statusType]} ìƒíƒœì˜ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        ` : `
          <table class="data-table">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ì…€ëŸ¬</th>
                <th>ìƒí’ˆ</th>
                <th>ê³µêµ¬ ê¸°ê°„</th>
                <th>ìƒ˜í”Œì „ë‹¬</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${filteredDeals.map(d => {
                const supplier = state.suppliers.find(s => s.id === d.supplierId);
                const seller = state.sellers.find(s => s.id === d.sellerId);
                return `
                  <tr>
                    <td><strong>${supplier?.name || '-'}</strong></td>
                    <td>${seller?.name || '-'}</td>
                    <td>${d.productName || '-'}</td>
                    <td style="font-size: 13px;">
                      ${d.startDate ? formatDateKR(d.startDate) : '-'} ~ ${d.endDate ? formatDateKR(d.endDate) : '-'}
                    </td>
                    <td>
                      ${d.sampleDelivered ? 
                        '<span style="color: var(--success);">âœ“ ì™„ë£Œ</span>' : 
                        '<span style="color: var(--gray-400);">-</span>'}
                    </td>
                    <td>
                      <button class="btn btn-ghost btn-sm" onclick="closeModal(); openDealModal(state.deals.find(deal=>deal.id==='${d.id}'))">ìƒì„¸</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `}
      </div>
    </div>
  `;
}

function renderCalendar() {
  const app = document.getElementById('app');
  const year = state.currentDate.getFullYear();
  const month = state.currentDate.getMonth();
  const today = formatDate(new Date());
  
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);
  const prevMonthDays = getDaysInMonth(year, month - 1);
  
  const filteredDeals = getFilteredDeals();
  const settlementNeeded = getDealsNeedingSettlement();
  
  // ë‚ ì§œ ê¸°ë°˜ ìë™ ìƒíƒœ ê³„ì‚°
  const todayDate = new Date();
  todayDate.setHours(0, 0, 0, 0);
  
  const stats = {
    negotiating: state.deals.filter(d => d.status === 'negotiating').length,
    confirmed: state.deals.filter(d => {
      if (d.status === 'negotiating') return false;
      const start = new Date(d.startDate);
      start.setHours(0, 0, 0, 0);
      return todayDate < start;
    }).length,
    ongoing: state.deals.filter(d => {
      if (d.status === 'negotiating') return false;
      const start = new Date(d.startDate);
      start.setHours(0, 0, 0, 0);
      const end = new Date(d.endDate);
      end.setHours(0, 0, 0, 0);
      return todayDate >= start && todayDate <= end;
    }).length,
    completed: state.deals.filter(d => {
      if (d.status === 'negotiating') return false;
      const end = new Date(d.endDate);
      end.setHours(0, 0, 0, 0);
      return todayDate > end;
    }).length
  };
  
  let alerts = '';
  if (settlementNeeded.length > 0) {
    alerts += `<div class="alert alert-warning">âš ï¸ ì •ì‚° ëŒ€ê¸° ì¤‘ì¸ ê³µêµ¬ê°€ ${settlementNeeded.length}ê±´ ìˆìŠµë‹ˆë‹¤</div>`;
  }
  
  let calendarDays = '';
  
  for (let i = firstDay - 1; i >= 0; i--) {
    const day = prevMonthDays - i;
    calendarDays += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = formatDate(new Date(year, month, day));
    const dayOfWeek = new Date(year, month, day).getDay();
    const isToday = dateStr === today;
    const isSunday = dayOfWeek === 0;
    const isSaturday = dayOfWeek === 6;
    
    const dayDeals = filteredDeals.filter(d => dateStr >= d.startDate && dateStr <= d.endDate);
    
    let dealBadges = '';
    dayDeals.slice(0, 3).forEach(deal => {
      const isStart = dateStr === deal.startDate;
      const isSingle = deal.startDate === deal.endDate;
      
      // ê³µêµ¬ ê¸°ê°„ ê³„ì‚°
      const startDate = new Date(deal.startDate);
      const endDate = new Date(deal.endDate);
      const dealDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const daysText = dealDays > 1 ? `(${dealDays}ì¼)` : '';
      
      let badgeClass = 'deal-badge';
      if (state.viewFilter === 'supplier') badgeClass += ' supplier';
      else if (state.viewFilter === 'seller') badgeClass += ' seller';
      else badgeClass += ' both';
      
      const displayText = isStart || isSingle ? `${deal.title}${daysText}` : 'Â·';
      dealBadges += `<div class="${badgeClass}" onclick="event.stopPropagation(); openDealModal(state.deals.find(d=>d.id==='${deal.id}'))" title="${deal.title} ${daysText}">${displayText}</div>`;
    });
    
    if (dayDeals.length > 3) {
      dealBadges += `<div style="font-size:11px;color:var(--gray-500);text-align:center">+${dayDeals.length - 3}</div>`;
    }
    
    calendarDays += `
      <div class="calendar-day ${isToday ? 'today' : ''} ${isSunday ? 'sunday' : ''} ${isSaturday ? 'saturday' : ''}" onclick="openDealModal()">
        <div class="day-number">${day}</div>
        ${dealBadges}
      </div>
    `;
  }
  
  const totalCells = firstDay + daysInMonth;
  const remainingCells = 7 - (totalCells % 7);
  if (remainingCells < 7) {
    for (let i = 1; i <= remainingCells; i++) {
      calendarDays += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
    }
  }
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ìº˜ë¦°ë”</h1>
      <p class="page-desc">ê³µêµ¬ ì¼ì •ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openDealModal()">+ ìƒˆ ê³µêµ¬</button>
      </div>
    </div>
    
    ${alerts}
    
    <div class="stats-row">
      <div class="stat-card" style="cursor: pointer;" onclick="openStatusModal('negotiating')">
        <div class="stat-label">í˜‘ì˜ì¤‘</div>
        <div class="stat-value">${stats.negotiating}</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="openStatusModal('confirmed')">
        <div class="stat-label">ì§„í–‰ì˜ˆì •</div>
        <div class="stat-value">${stats.confirmed}</div>
      </div>
      <div class="stat-card highlight" style="cursor: pointer;" onclick="openStatusModal('ongoing')">
        <div class="stat-label">ì§„í–‰ì¤‘</div>
        <div class="stat-value">${stats.ongoing}</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="openStatusModal('completed')">
        <div class="stat-label">ì§„í–‰ì™„ë£Œ</div>
        <div class="stat-value">${stats.completed}</div>
      </div>
    </div>
    
    <div class="card">
      <div class="filter-bar">
        <div class="filter-group">
          <button class="filter-btn ${state.viewFilter === 'all' ? 'active' : ''}" onclick="changeViewFilter('all')">ì „ì²´</button>
          <button class="filter-btn ${state.viewFilter === 'supplier' ? 'active' : ''}" onclick="changeViewFilter('supplier')">ê³µê¸‰ì‚¬ë³„</button>
          <button class="filter-btn ${state.viewFilter === 'seller' ? 'active' : ''}" onclick="changeViewFilter('seller')">ì…€ëŸ¬ë³„</button>
        </div>
        
        ${state.viewFilter === 'supplier' ? `
          <select class="form-select" style="width:auto" onchange="changeSupplierFilter(this.value)">
            <option value="">ê³µê¸‰ì‚¬ ì„ íƒ</option>
            ${state.suppliers.map(s => `<option value="${s.id}" ${state.selectedSupplier === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
          </select>
        ` : ''}
        
        ${state.viewFilter === 'seller' ? `
          <select class="form-select" style="width:auto" onchange="changeSellerFilter(this.value)">
            <option value="">ì…€ëŸ¬ ì„ íƒ</option>
            ${state.sellers.map(s => `<option value="${s.id}" ${state.selectedSeller === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
          </select>
        ` : ''}
      </div>
      
      <div class="legend">
        <div class="legend-item"><div class="legend-dot supplier"></div> ê³µê¸‰ì‚¬ ë·°</div>
        <div class="legend-item"><div class="legend-dot seller"></div> ì…€ëŸ¬ ë·°</div>
        <div class="legend-item"><div class="legend-dot both"></div> ì „ì²´ ë·°</div>
      </div>
      
      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="prevMonth()">â€¹</button>
          <span class="calendar-title">${year}ë…„ ${MONTHS[month]}</span>
          <button onclick="nextMonth()">â€º</button>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="goToday()">ì˜¤ëŠ˜</button>
      </div>
      
      <div class="calendar-grid">
        ${WEEKDAYS.map(d => `<div class="calendar-weekday">${d}</div>`).join('')}
      </div>
      <div class="calendar-grid">
        ${calendarDays}
      </div>
    </div>
  `;
}

function renderDeals() {
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ê³µêµ¬ ëª©ë¡</h1>
      <p class="page-desc">ì „ì²´ ${state.deals.length}ê°œì˜ ê³µêµ¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openDealModal()">+ ìƒˆ ê³µêµ¬</button>
      </div>
    </div>
    
    <div class="card">
      <div class="deal-list">
        ${state.deals.length === 0 ? `
          <div class="empty-state">
            <div class="icon">ğŸ“¦</div>
            <div class="text">ë“±ë¡ëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        ` : ''}
        ${state.deals.map(d => {
          const displayStatus = getDisplayStatus(d);
          return `
          <div class="deal-item" onclick="openDealModal(state.deals.find(deal=>deal.id==='${d.id}'))">
            <div class="deal-color ${d.status === 'negotiating' ? 'negotiating' : getAutoStatus(d)}"></div>
            <div class="deal-info">
              <div class="deal-title">${d.title}</div>
              <div class="deal-meta">
                <span>ğŸ­ ${getSupplierName(d.supplierId)}</span>
                <span>ğŸ‘¤ ${getSellerName(d.sellerId)}</span>
                <span>${formatDateKR(d.startDate)} ~ ${formatDateKR(d.endDate)}</span>
              </div>
              ${displayStatus.label === 'ì§„í–‰ì™„ë£Œ' ? `
                <div class="settlement-badges">
                  <span class="settlement-badge ${d.supplierSettled ? 'done' : 'pending'}">${d.supplierSettled ? 'âœ“' : 'â—‹'} ê³µê¸‰ì‚¬</span>
                  <span class="settlement-badge ${d.sellerSettled ? 'done' : 'pending'}">${d.sellerSettled ? 'âœ“' : 'â—‹'} ì…€ëŸ¬</span>
                </div>
              ` : ''}
            </div>
            <div class="deal-status">
              <span class="status-badge ${displayStatus.class}">${displayStatus.label}</span>
            </div>
          </div>
        `}).join('')}
      </div>
    </div>
  `;
}

function renderSuppliers() {
  const app = document.getElementById('app');
  
  // ê³„ì•½ ì™„ë£Œëœ ê³µê¸‰ì‚¬ / ë¯¸ì™„ë£Œ ê³µê¸‰ì‚¬ ë¶„ë¦¬
  const contractedSuppliers = state.suppliers.filter(s => s.contractStatus === 'completed');
  const pendingSuppliers = state.suppliers.filter(s => s.contractStatus !== 'completed');
  
  // ì´ ìƒí’ˆ ìˆ˜
  const totalProducts = (state.supplierProducts || []).length;
  
  // ê³µê¸‰ì‚¬ë³„ ë§¤ì¶œ ë°ì´í„° ì§‘ê³„
  const supplierSalesStats = {};
  state.suppliers.forEach(supplier => {
    const settlements = (state.sellerSettlements || []).filter(ss => ss.brandName === supplier.name);
    let totalSalesAmount = 0;
    let totalSalesCount = 0;
    
    settlements.forEach(ss => {
      const items = ss.salesItems || [];
      totalSalesCount += items.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);
      totalSalesAmount += items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
    });
    
    supplierSalesStats[supplier.id] = { totalSalesAmount, totalSalesCount };
  });
  
  // ì „ì²´ ë§¤ì¶œ í•©ê³„
  const grandTotalSales = Object.values(supplierSalesStats).reduce((sum, s) => sum + s.totalSalesAmount, 0);
  const grandTotalCount = Object.values(supplierSalesStats).reduce((sum, s) => sum + s.totalSalesCount, 0);
  
  // ì„œë¥˜ ì™„ë£Œ ì—¬ë¶€ ì²´í¬ (4ê°œ í•­ëª©: ìƒí’ˆë“±ë¡, ì‚¬ì—…ì, í†µì¥, ê³„ì•½)
  const fullyDocumented = contractedSuppliers.filter(s => {
    return s.hasProductInfo && s.hasBusinessLicense && s.hasBankAccount && s.hasContract;
  });
  
  const missingDocs = contractedSuppliers.filter(s => {
    return !(s.hasProductInfo && s.hasBusinessLicense && s.hasBankAccount && s.hasContract);
  });
  
  // íŒë§¤ëŸ‰ TOP 5 / ì €ì¡° ë¸Œëœë“œ
  const suppliersWithSales = state.suppliers
    .map(s => ({ ...s, sales: supplierSalesStats[s.id]?.totalSalesAmount || 0, count: supplierSalesStats[s.id]?.totalSalesCount || 0 }))
    .filter(s => s.sales > 0);
  
  const topSellers = [...suppliersWithSales].sort((a, b) => b.sales - a.sales).slice(0, 5);
  const lowSellers = [...suppliersWithSales].sort((a, b) => a.sales - b.sales).slice(0, 3);
  
  // ê³µêµ¬ ì§„í–‰ TOP 5 (ìº˜ë¦°ë” ë“±ë¡ ê¸°ì¤€)
  const products = state.supplierProducts || [];
  const dealProgressStats = products.map(p => {
    // selectedProductsê°€ ê°ì²´ ë°°ì—´ [{productId, ...}] ë˜ëŠ” ë¬¸ìì—´ ë°°ì—´ [id]ì¼ ìˆ˜ ìˆìŒ
    const linkedDeals = state.deals.filter(d => {
      if (!d.selectedProducts) return false;
      return d.selectedProducts.some(item => {
        const pid = typeof item === 'string' ? item : item.productId;
        return pid === p.id;
      });
    });
    return {
      ...p,
      dealCount: linkedDeals.length
    };
  }).filter(p => p.dealCount > 0)
    .sort((a, b) => b.dealCount - a.dealCount)
    .slice(0, 5);
  
  // íŒë§¤ ë² ìŠ¤íŠ¸ TOP 5 (ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œ ì •ì‚° ê¸°ì¤€)
  const salesByProduct = {};
  (state.sellerSettlements || []).forEach(ss => {
    const items = ss.salesItems || ss.items || [];
    items.forEach(item => {
      const productName = item.productName || item.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
      const brandName = ss.brandName || '-';
      const key = `${brandName}__${productName}`;
      if (!salesByProduct[key]) {
        salesByProduct[key] = { productName, brandName, totalQty: 0, totalAmount: 0 };
      }
      salesByProduct[key].totalQty += Number(item.quantity) || 0;
      salesByProduct[key].totalAmount += Number(item.amount) || 0;
    });
  });
  
  const salesBestStats = Object.values(salesByProduct)
    .filter(p => p.totalAmount > 0)
    .sort((a, b) => b.totalAmount - a.totalAmount)
    .slice(0, 5);
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ê³µê¸‰ì‚¬ ê´€ë¦¬</h1>
      <p class="page-desc">ì´ ${state.suppliers.length}ê°œì˜ ê³µê¸‰ì‚¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openSupplierModal()">+ ìƒˆ ê³µê¸‰ì‚¬</button>
      </div>
    </div>
    
    <!-- 1í–‰: ê¸°ë³¸ í†µê³„ -->
    <div class="stats-row" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 16px;">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ê³µê¸‰ì‚¬</div>
        <div class="stat-value">${state.suppliers.length}ê°œ</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-label">ì´ íŒë§¤ì•¡</div>
        <div class="stat-value">${grandTotalSales.toLocaleString()}ì›</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: var(--gray-600);">ì´ íŒë§¤ê±´</div>
        <div class="stat-value" style="color: #d97706;">${grandTotalCount.toLocaleString()}ê±´</div>
      </div>
    </div>
    
    <!-- 2í–‰: ê³„ì•½ ë° ì„œë¥˜ í˜„í™© -->
    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #065f46;">âœ… ê³„ì•½ì™„ë£Œ</div>
        <div class="stat-value" style="color: #059669;">${contractedSuppliers.length}ê°œ</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #9a3412;">â³ í˜‘ì˜ì¤‘</div>
        <div class="stat-value" style="color: #ea580c;">${pendingSuppliers.length}ê°œ</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #1e40af;">ğŸ“‹ ì„œë¥˜ì™„ë£Œ</div>
        <div class="stat-value" style="color: #2563eb;">${fullyDocumented.length}ê°œ</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #991b1b;">âš ï¸ ì„œë¥˜ë¯¸ë¹„</div>
        <div class="stat-value" style="color: #dc2626;">${missingDocs.length}ê°œ</div>
      </div>
    </div>
    
    <!-- 3í–‰: íŒë§¤ ìˆœìœ„ (4ì—´) -->
    <div class="card" style="margin-bottom: 16px; padding: 16px;">
      <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ“Š íŒë§¤ ìˆœìœ„</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">
        <!-- íŒë§¤ëŸ‰ TOP 5 (ë¸Œëœë“œ) -->
        <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px;">
          <div style="font-size: 12px; font-weight: 600; color: #065f46; margin-bottom: 10px;">ğŸ† ë¸Œëœë“œ íŒë§¤ëŸ‰</div>
          ${topSellers.length === 0 ? '<div style="color: var(--gray-500); font-size: 11px;">ë°ì´í„° ì—†ìŒ</div>' : 
            topSellers.map((s, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; ${i < 3 ? 'border-left: 2px solid ' + (i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : '#CD7F32') : ''}">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 12px;">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1)}</span>
                  <span style="font-weight: 600; font-size: 12px;">${s.name}</span>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: 700; color: #059669; font-size: 11px;">${s.sales.toLocaleString()}ì›</div>
                </div>
              </div>
            `).join('')}
        </div>
        <!-- ê³µêµ¬ ì§„í–‰ TOP 5 (ìƒí’ˆ) -->
        <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px;">
          <div style="font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 10px;">ğŸ“¦ ê³µêµ¬ ì§„í–‰ ê±´ìˆ˜ TOP5</div>
          ${dealProgressStats.length === 0 ? '<div style="color: var(--gray-500); font-size: 11px;">ê³µêµ¬ ë“±ë¡ëœ ìƒí’ˆ ì—†ìŒ</div>' : 
            dealProgressStats.map((p, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; ${i < 3 ? 'border-left: 2px solid ' + (i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : '#CD7F32') : ''}">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div>
                  <div style="font-size: 10px; color: var(--gray-500);">${p.brandName || '-'}</div>
                </div>
                <div style="font-weight: 700; color: #2563eb; font-size: 11px; flex-shrink: 0;">${p.dealCount}ê±´</div>
              </div>
            `).join('')}
        </div>
        <!-- íŒë§¤ ë² ìŠ¤íŠ¸ TOP 5 (ìƒí’ˆ) -->
        <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px;">
          <div style="font-size: 12px; font-weight: 600; color: #dc2626; margin-bottom: 10px;">ğŸ”¥ íŒë§¤ ë² ìŠ¤íŠ¸ ìƒí’ˆ TOP5</div>
          ${salesBestStats.length === 0 ? '<div style="color: var(--gray-500); font-size: 11px;">ì •ì‚° ë°ì´í„° ì—†ìŒ</div>' : 
            salesBestStats.map((p, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; ${i < 3 ? 'border-left: 2px solid ' + (i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : '#CD7F32') : ''}">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.productName}</div>
                  <div style="font-size: 10px; color: var(--gray-500);">${p.brandName} Â· ${p.totalQty}ê°œ</div>
                </div>
                <div style="font-weight: 700; color: #dc2626; font-size: 11px; flex-shrink: 0;">${p.totalAmount.toLocaleString()}ì›</div>
              </div>
            `).join('')}
        </div>
        <!-- íŒë§¤ ì €ì¡° ë¸Œëœë“œ -->
        <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px;">
          <div style="font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 10px;">ğŸ“‰ íŒë§¤ ì €ì¡° ë¸Œëœë“œ</div>
          ${lowSellers.length === 0 ? '<div style="color: var(--gray-500); font-size: 11px;">ë°ì´í„° ì—†ìŒ</div>' : 
            lowSellers.map((s, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 11px; color: var(--gray-600);">${i + 1}ìœ„</span>
                  <span style="font-weight: 600; font-size: 12px;">${s.name}</span>
                </div>
                <div style="font-weight: 700; color: #d97706; font-size: 11px;">${s.sales.toLocaleString()}ì›</div>
              </div>
            `).join('')}
        </div>
      </div>
    </div>
    
    <!-- ì„œë¥˜ ë¯¸ë¹„ ê³µê¸‰ì‚¬ (ê³„ì•½ì™„ë£Œ but ì„œë¥˜ ë¶€ì¡±) -->
    ${missingDocs.length > 0 ? `
    <div class="card" style="margin-bottom: 16px; border: 2px solid #fca5a5;">
      <h2 class="card-title" style="color: #dc2626;">âš ï¸ ì„œë¥˜ ë¯¸ë¹„ ê³µê¸‰ì‚¬ (ê³„ì•½ì™„ë£Œ)</h2>
      <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 12px;">ìƒí’ˆë“±ë¡, ì‚¬ì—…ì, í†µì¥, ê³„ì•½ ì¤‘ ë¯¸ë¹„ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤</p>
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ê³µê¸‰ì‚¬ëª…</th>
              <th>ìœ í˜•</th>
              <th>ê³„ì•½ìƒíƒœ</th>
              <th style="text-align: center;">ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</th>
              <th style="text-align: center;">ë“œë¼ì´ë¸Œ</th>
              <th>ë‹´ë‹¹ì</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${missingDocs.map(s => {
              return `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td><span class="status-badge ${s.supplierType === 'inhouse' ? 'status-confirmed' : 'status-negotiating'}">${s.supplierType === 'inhouse' ? 'ìì‚¬' : 'íƒ€ì‚¬'}</span></td>
                  <td>
                    <select class="form-input" style="padding: 4px 8px; font-size: 12px; min-width: 90px;" onchange="updateSupplierField('${s.id}', 'contractStatus', this.value)">
                      <option value="pending" ${s.contractStatus === 'pending' ? 'selected' : ''}>â³ í˜‘ì˜ì¤‘</option>
                      <option value="completed" ${s.contractStatus === 'completed' ? 'selected' : ''}>âœ… ê³„ì•½ì™„ë£Œ</option>
                    </select>
                  </td>
                  <td style="text-align: center;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasProductInfo ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ìƒí’ˆë“±ë¡">
                        <input type="checkbox" ${s.hasProductInfo ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasProductInfo', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasProductInfo ? '#166534' : '#991b1b'};">ìƒí’ˆë“±ë¡</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasBusinessLicense ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ì‚¬ì—…ìë“±ë¡ì¦">
                        <input type="checkbox" ${s.hasBusinessLicense ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasBusinessLicense', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasBusinessLicense ? '#166534' : '#991b1b'};">ì‚¬ì—…ì</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasBankAccount ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="í†µì¥ì‚¬ë³¸">
                        <input type="checkbox" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasBankAccount', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasBankAccount ? '#166534' : '#991b1b'};">í†µì¥</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasContract ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ê³„ì•½ì„œ">
                        <input type="checkbox" ${s.hasContract ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasContract', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasContract ? '#166534' : '#991b1b'};">ê³„ì•½</span>
                      </label>
                    </div>
                  </td>
                  <td style="text-align: center;">
                    <button onclick="openSupplierGDrive('${s.id}')" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, #4285f4, #34a853); border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" title="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/></svg>
                    </button>
                  </td>
                  <td>${s.managerName || '-'}${s.managerPhone ? ` (${s.managerPhone})` : ''}</td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openSupplierModal(state.suppliers.find(sup=>sup.id==='${s.id}'))">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
    ` : ''}
    
    <!-- ì„œë¥˜ ì™„ë£Œ ê³µê¸‰ì‚¬ -->
    ${fullyDocumented.length > 0 ? `
    <div class="card" style="margin-bottom: 16px; border: 2px solid #a7f3d0;">
      <h2 class="card-title" style="color: #059669;">âœ… ì„œë¥˜ ì™„ë£Œ ê³µê¸‰ì‚¬</h2>
      <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 12px;">ìƒí’ˆë“±ë¡, ì‚¬ì—…ì, í†µì¥, ê³„ì•½ ëª¨ë‘ ì™„ë£Œ</p>
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ê³µê¸‰ì‚¬ëª…</th>
              <th>ìœ í˜•</th>
              <th>ê³„ì•½ìƒíƒœ</th>
              <th style="text-align: center;">ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</th>
              <th style="text-align: center;">ë“œë¼ì´ë¸Œ</th>
              <th style="text-align: right;">ì´ íŒë§¤ì•¡</th>
              <th style="text-align: right;">ì´ íŒë§¤ê±´</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${fullyDocumented.map(s => {
              const productCount = (state.supplierProducts || []).filter(p => p.supplierId === s.id).length;
              const stats = supplierSalesStats[s.id] || { totalSalesAmount: 0, totalSalesCount: 0 };
              return `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td><span class="status-badge ${s.supplierType === 'inhouse' ? 'status-confirmed' : 'status-negotiating'}">${s.supplierType === 'inhouse' ? 'ìì‚¬' : 'íƒ€ì‚¬'}</span></td>
                  <td>
                    <select class="form-input" style="padding: 4px 8px; font-size: 12px; min-width: 90px;" onchange="updateSupplierField('${s.id}', 'contractStatus', this.value)">
                      <option value="pending" ${s.contractStatus === 'pending' ? 'selected' : ''}>â³ í˜‘ì˜ì¤‘</option>
                      <option value="completed" ${s.contractStatus === 'completed' ? 'selected' : ''}>âœ… ê³„ì•½ì™„ë£Œ</option>
                    </select>
                  </td>
                  <td style="text-align: center;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasProductInfo ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ìƒí’ˆë“±ë¡">
                        <input type="checkbox" ${s.hasProductInfo ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasProductInfo', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasProductInfo ? '#166534' : '#991b1b'};">ìƒí’ˆë“±ë¡</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasBusinessLicense ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ì‚¬ì—…ìë“±ë¡ì¦">
                        <input type="checkbox" ${s.hasBusinessLicense ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasBusinessLicense', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasBusinessLicense ? '#166534' : '#991b1b'};">ì‚¬ì—…ì</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasBankAccount ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="í†µì¥ì‚¬ë³¸">
                        <input type="checkbox" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasBankAccount', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasBankAccount ? '#166534' : '#991b1b'};">í†µì¥</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 12px; padding: 4px 8px; background: ${s.hasContract ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ê³„ì•½ì„œ">
                        <input type="checkbox" ${s.hasContract ? 'checked' : ''} onchange="updateSupplierField('${s.id}', 'hasContract', this.checked)" style="width: 16px; height: 16px;">
                        <span style="color: ${s.hasContract ? '#166534' : '#991b1b'};">ê³„ì•½</span>
                      </label>
                    </div>
                  </td>
                  <td style="text-align: center;">
                    <button onclick="openSupplierGDrive('${s.id}')" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, #4285f4, #34a853); border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" title="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/></svg>
                    </button>
                  </td>
                  <td style="text-align: right; font-weight: 600; color: var(--primary);">${stats.totalSalesAmount.toLocaleString()}ì›</td>
                  <td style="text-align: right;">${stats.totalSalesCount}ê±´</td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openSupplierModal(state.suppliers.find(sup=>sup.id==='${s.id}'))">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
    ` : ''}
    
    <!-- í˜‘ì˜ì¤‘ ê³µê¸‰ì‚¬ -->
    <div class="card">
      <h2 class="card-title" style="color: var(--gray-600);">â³ í˜‘ì˜ì¤‘ ê³µê¸‰ì‚¬</h2>
      ${pendingSuppliers.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ­</div>
          <div class="text">í˜‘ì˜ì¤‘ì¸ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬ëª…</th>
                <th>ìœ í˜•</th>
                <th>ë“±ë¡ìƒí’ˆ</th>
                <th>ë‹´ë‹¹ì</th>
                <th>ì—°ë½ì²˜</th>
                <th>ìƒí’ˆë¬¸ì˜</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${pendingSuppliers.map(s => {
                const productCount = (state.supplierProducts || []).filter(p => p.supplierId === s.id).length;
                return `
                  <tr>
                    <td><strong>${s.name}</strong></td>
                    <td><span class="status-badge ${s.supplierType === 'inhouse' ? 'status-confirmed' : 'status-negotiating'}">${s.supplierType === 'inhouse' ? 'ìì‚¬' : 'íƒ€ì‚¬'}</span></td>
                    <td><span class="status-badge" style="background: var(--gray-100); color: var(--gray-600);">${productCount}ê°œ</span></td>
                    <td>${s.managerName || '-'}${s.managerTitle ? ` (${s.managerTitle})` : ''}</td>
                    <td>${s.managerPhone || s.contact || '-'}</td>
                    <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.inquiryMethod || '-'}</td>
                    <td class="actions">
                      <button class="btn btn-secondary btn-sm" onclick="openSupplierModal(state.suppliers.find(sup=>sup.id==='${s.id}'))">ìˆ˜ì •</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

function renderSellers() {
  const app = document.getElementById('app');
  
  // ì…€ëŸ¬ë³„ ì •ì‚° í†µê³„ ê³„ì‚°
  const sellerStats = {};
  state.sellers.forEach(seller => {
    // ì…€ëŸ¬ ì •ì‚° ë‚´ì—­ì—ì„œ í•´ë‹¹ ì…€ëŸ¬ì˜ ë°ì´í„° ì§‘ê³„
    const sellerSettlements = (state.sellerSettlements || []).filter(ss => ss.sellerName === seller.name);
    
    let totalSalesCount = 0;  // ì´ íŒë§¤ê±´
    let totalSalesAmount = 0;  // ì´ íŒë§¤ì•¡
    let totalMarginAmount = 0;  // ì´ ë§ˆì§„ê¸ˆ
    let ongoingCount = 0;  // ì§„í–‰ì¤‘
    let completedCount = 0;  // ì™„ë£Œ
    
    sellerSettlements.forEach(ss => {
      const items = ss.salesItems || [];
      totalSalesCount += items.length;
      totalSalesAmount += items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      totalMarginAmount += items.reduce((sum, item) => sum + (Number(item.marginAmount) || 0), 0);
      
      // ì •ì‚°ì¼ ê¸°ì¤€ìœ¼ë¡œ ì§„í–‰ì¤‘/ì™„ë£Œ íŒë‹¨ (ì •ì‚°ì¼ì´ ìˆìœ¼ë©´ ì™„ë£Œ)
      if (ss.settlementDate) {
        completedCount++;
      } else {
        ongoingCount++;
      }
    });
    
    // ê³µêµ¬ ëª©ë¡ì—ì„œë„ ì§„í–‰ì¤‘ ì²´í¬
    const ongoingDeals = state.deals.filter(d => d.sellerId === seller.id && d.status !== 'completed').length;
    
    sellerStats[seller.id] = {
      totalSalesCount,
      totalSalesAmount,
      totalMarginAmount,
      ongoingCount: ongoingCount + ongoingDeals,
      completedCount
    };
  });
  
  // ì „ì²´ í†µê³„
  const totalSellers = state.sellers.length;
  const totalSalesAmount = Object.values(sellerStats).reduce((sum, s) => sum + s.totalSalesAmount, 0);
  const totalMarginAmount = Object.values(sellerStats).reduce((sum, s) => sum + s.totalMarginAmount, 0);
  
  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  const categories = ['ìœ¡ì•„', 'ì‹í’ˆ', 'ë¯¸ìš©', 'ìƒí™œ', 'ì·¨ë¯¸', 'ê±´ê°•'];
  
  // ê³µêµ¬ ìƒíƒœë³„ ì¹´ìš´íŠ¸
  const completedDealsCount = state.deals.filter(d => d.status === 'completed').length;
  const ongoingDealsCount = state.deals.filter(d => d.status === 'ongoing' || d.status === 'negotiating').length;
  const scheduledDealsCount = state.deals.filter(d => d.status === 'scheduled' || d.status === 'confirmed').length;
  
  // íŒë§¤ì•¡ ê¸°ì¤€ ì…€ëŸ¬ ë¶„ë¥˜
  const sellers100M = state.sellers.filter(s => (sellerStats[s.id]?.totalSalesAmount || 0) >= 1000000);
  const sellers500M = state.sellers.filter(s => (sellerStats[s.id]?.totalSalesAmount || 0) >= 5000000);
  const sellers1000M = state.sellers.filter(s => (sellerStats[s.id]?.totalSalesAmount || 0) >= 10000000);
  
  // ì´ íŒë§¤ê±´ìˆ˜
  const totalSalesCount = Object.values(sellerStats).reduce((sum, s) => sum + s.totalSalesCount, 0);
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ì…€ëŸ¬ ê´€ë¦¬</h1>
      <p class="page-desc">ì´ ${totalSellers}ëª…ì˜ ì…€ëŸ¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="openSellerModal(null, true)">ğŸ“‹ ì¼ê´„ ë“±ë¡</button>
        <button class="btn btn-primary" onclick="openSellerModal()">+ ìƒˆ ì…€ëŸ¬</button>
      </div>
    </div>
    
    <!-- 1í–‰: ê¸°ë³¸ í†µê³„ -->
    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
      <div class="stat-card">
        <div class="stat-label">ì´ ì…€ëŸ¬</div>
        <div class="stat-value">${totalSellers}ëª…</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: var(--gray-600);">ì´ ë§ˆì§„ê¸ˆ</div>
        <div class="stat-value" style="color: #d97706;">${totalMarginAmount.toLocaleString()}ì›</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-label">ì´ íŒë§¤ì•¡</div>
        <div class="stat-value">${totalSalesAmount.toLocaleString()}ì›</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì´ íŒë§¤ê±´</div>
        <div class="stat-value">${totalSalesCount}ê±´</div>
      </div>
    </div>
    
    <!-- 2í–‰: ê³µêµ¬ í˜„í™© -->
    <div class="stats-row" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 16px;">
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #065f46;">ì§„í–‰ì™„ë£Œ ê³µêµ¬</div>
        <div class="stat-value" style="color: #059669;">${completedDealsCount}ê±´</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #9a3412;">ì§„í–‰ì¤‘ ê³µêµ¬</div>
        <div class="stat-value" style="color: #ea580c;">${ongoingDealsCount}ê±´</div>
      </div>
      <div class="stat-card" style="background: var(--white); border: 1px solid var(--gray-200);">
        <div class="stat-label" style="color: #3730a3;">ì§„í–‰ì˜ˆì • ê³µêµ¬</div>
        <div class="stat-value" style="color: #4f46e5;">${scheduledDealsCount}ê±´</div>
      </div>
    </div>
    
    <!-- 3í–‰: íŒë§¤ì•¡ ê¸°ì¤€ ì…€ëŸ¬ ë¶„ë¥˜ -->
    <div class="card" style="margin-bottom: 16px; padding: 16px;">
      <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ† íŒë§¤ì•¡ ê¸°ì¤€ ì…€ëŸ¬ ë¶„ë¥˜</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
        <div style="background: var(--gray-50); border-radius: 12px; padding: 12px; cursor: pointer;" onclick="toggleSellerTierList('100m')">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: var(--gray-600);">ğŸ’° 100ë§Œì› ì´ìƒ</div>
              <div style="font-size: 24px; font-weight: 700; color: #d97706;">${sellers100M.length}ëª…</div>
            </div>
            <span style="color: var(--gray-600); font-size: 12px;">ìƒì„¸ë³´ê¸° â–¼</span>
          </div>
          <div id="seller-tier-100m" style="display: none; margin-top: 12px; max-height: 150px; overflow-y: auto;">
            ${sellers100M.length === 0 ? '<div style="color: var(--gray-600); font-size: 12px;">í•´ë‹¹ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
              sellers100M.map(s => `<div style="padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 12px; display: flex; justify-content: space-between;">
                <span>${s.name}</span>
                <span style="color: #d97706; font-weight: 600;">${(sellerStats[s.id]?.totalSalesAmount || 0).toLocaleString()}ì›</span>
              </div>`).join('')}
          </div>
        </div>
        <div style="background: #dbeafe; border-radius: 12px; padding: 12px; cursor: pointer;" onclick="toggleSellerTierList('500m')">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: #1e40af;">ğŸ’ 500ë§Œì› ì´ìƒ</div>
              <div style="font-size: 24px; font-weight: 700; color: #2563eb;">${sellers500M.length}ëª…</div>
            </div>
            <span style="color: #1e40af; font-size: 12px;">ìƒì„¸ë³´ê¸° â–¼</span>
          </div>
          <div id="seller-tier-500m" style="display: none; margin-top: 12px; max-height: 150px; overflow-y: auto;">
            ${sellers500M.length === 0 ? '<div style="color: #1e40af; font-size: 12px;">í•´ë‹¹ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
              sellers500M.map(s => `<div style="padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 12px; display: flex; justify-content: space-between;">
                <span>${s.name}</span>
                <span style="color: #2563eb; font-weight: 600;">${(sellerStats[s.id]?.totalSalesAmount || 0).toLocaleString()}ì›</span>
              </div>`).join('')}
          </div>
        </div>
        <div style="background: #fce7f3; border-radius: 12px; padding: 12px; cursor: pointer;" onclick="toggleSellerTierList('1000m')">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: #9d174d;">ğŸ‘‘ 1000ë§Œì› ì´ìƒ</div>
              <div style="font-size: 24px; font-weight: 700; color: #db2777;">${sellers1000M.length}ëª…</div>
            </div>
            <span style="color: #9d174d; font-size: 12px;">ìƒì„¸ë³´ê¸° â–¼</span>
          </div>
          <div id="seller-tier-1000m" style="display: none; margin-top: 12px; max-height: 150px; overflow-y: auto;">
            ${sellers1000M.length === 0 ? '<div style="color: #9d174d; font-size: 12px;">í•´ë‹¹ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
              sellers1000M.map(s => `<div style="padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 12px; display: flex; justify-content: space-between;">
                <span>${s.name}</span>
                <span style="color: #db2777; font-weight: 600;">${(sellerStats[s.id]?.totalSalesAmount || 0).toLocaleString()}ì›</span>
              </div>`).join('')}
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      ${state.sellers.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ‘¤</div>
          <div class="text">ë“±ë¡ëœ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      ` : `
        <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th style="min-width: 180px;">ì…€ëŸ¬ëª…/ë‹‰ë„¤ì„(íŒ”ë¡œì›Œìˆ˜)</th>
              <th>ì—°ë½ì²˜</th>
              <th style="min-width: 120px;">ì£¼ì†Œ</th>
              <th>ê³„ì •ë§í¬</th>
              <th>ì¹´í…Œê³ ë¦¬</th>
              <th style="text-align: center;">ì„œë¥˜í˜„í™©</th>
              <th style="text-align: center;">ë“œë¼ì´ë¸Œ</th>
              <th style="text-align: center;">ì§„í–‰í˜„í™©</th>
              <th style="text-align: right;">ì´ íŒë§¤ê±´</th>
              <th style="text-align: right;">ì´ íŒë§¤ì•¡</th>
              <th style="text-align: right;">ì´ ë§ˆì§„ê¸ˆ</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${state.sellers.map(s => {
              const stats = sellerStats[s.id] || { totalSalesCount: 0, totalSalesAmount: 0, totalMarginAmount: 0, ongoingCount: 0, completedCount: 0 };
              const categoryBadge = s.category ? `<span class="status-badge status-confirmed">${s.category}</span>` : '-';
              
              // ì„œë¥˜ í˜„í™© - ë¯¼ì¦, í†µì¥ë§Œ ì²´í¬
              const docStatus = `
                <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 2px; cursor: pointer; font-size: 11px; padding: 3px 6px; background: ${s.hasIdCard ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="ì‹ ë¶„ì¦">
                    <input type="checkbox" ${s.hasIdCard ? 'checked' : ''} onchange="updateSellerField('${s.id}', 'hasIdCard', this.checked)" style="width: 14px; height: 14px;">
                    <span style="color: ${s.hasIdCard ? '#166534' : '#991b1b'};">ë¯¼ì¦</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 2px; cursor: pointer; font-size: 11px; padding: 3px 6px; background: ${s.hasBankAccount ? '#dcfce7' : '#fef2f2'}; border-radius: 4px;" title="í†µì¥ì‚¬ë³¸">
                    <input type="checkbox" ${s.hasBankAccount ? 'checked' : ''} onchange="updateSellerField('${s.id}', 'hasBankAccount', this.checked)" style="width: 14px; height: 14px;">
                    <span style="color: ${s.hasBankAccount ? '#166534' : '#991b1b'};">í†µì¥</span>
                  </label>
                </div>
              `;
              
              return `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td>${s.contact || '-'}</td>
                  <td style="font-size: 12px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${s.address || ''}">${s.address || '-'}</td>
                  <td>
                    ${s.channelLink ? `<a href="${s.channelLink.startsWith('http') ? s.channelLink : 'https://' + s.channelLink}" target="_blank" style="color: var(--primary); text-decoration: none; font-size: 12px;">
                      ${getChannelIcon(s.channelLink)} ë°”ë¡œê°€ê¸°
                    </a>` : '-'}
                  </td>
                  <td>${categoryBadge}</td>
                  <td>${docStatus}</td>
                  <td style="text-align: center;">
                    <button onclick="openSellerGDrive('${s.id}')" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, #4285f4, #34a853); border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" title="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 2L4.5 12.5l2.5 4.3 5-8.5 5 8.5 2.5-4.3L12 2zm-5 17.5l2.5-4.3h9l2.5 4.3H7z"/></svg>
                    </button>
                  </td>
                  <td style="text-align: center;">
                    ${stats.completedCount > 0 ? `<span class="status-badge status-confirmed" style="font-size: 11px;">ì™„ë£Œ ${stats.completedCount}</span>` : ''}
                    ${stats.ongoingCount > 0 ? `<span class="status-badge status-ongoing" style="font-size: 11px;">ì§„í–‰ ${stats.ongoingCount}</span>` : ''}
                    ${stats.completedCount === 0 && stats.ongoingCount === 0 ? '-' : ''}
                  </td>
                  <td style="text-align: right;"><strong>${stats.totalSalesCount}</strong>ê±´</td>
                  <td style="text-align: right; color: var(--primary); font-weight: 600;">${stats.totalSalesAmount.toLocaleString()}ì›</td>
                  <td style="text-align: right; color: #d97706; font-weight: 600;">${stats.totalMarginAmount.toLocaleString()}ì›</td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openSellerModal(state.sellers.find(sel=>sel.id==='${s.id}'))">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        </div>
      `}
    </div>
  `;
}

// íŒ”ë¡œì›Œ ìˆ˜ í¬ë§·
function formatFollowers(num) {
  const n = Number(num);
  if (isNaN(n)) return num;
  if (n >= 10000) return (n / 10000).toFixed(1) + 'ë§Œ';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
  return n.toLocaleString();
}

// ì±„ë„ ì•„ì´ì½˜ ë°˜í™˜
function getChannelIcon(link) {
  if (!link) return 'ğŸ”—';
  const lower = link.toLowerCase();
  if (lower.includes('instagram')) return 'ğŸ“·';
  if (lower.includes('youtube')) return 'ğŸ¬';
  if (lower.includes('naver') || lower.includes('blog')) return 'ğŸ“';
  if (lower.includes('kakao')) return 'ğŸ’¬';
  if (lower.includes('tiktok')) return 'ğŸµ';
  return 'ğŸ”—';
}

function renderSettlement() {
  const app = document.getElementById('app');
  const today = new Date();
  
  const completedDeals = state.deals.filter(d => d.status === 'completed');
  const pendingSettlement = completedDeals.filter(d => !d.supplierSettled || !d.sellerSettled);
  const fullySettled = completedDeals.filter(d => d.supplierSettled && d.sellerSettled);
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ì •ì‚° ê´€ë¦¬</h1>
      <p class="page-desc">ê³µêµ¬ ë§ˆê° í›„ 3~7ì¼ ì´ë‚´ ì •ì‚°ì„ ê¶Œì¥í•©ë‹ˆë‹¤</p>
    </div>
    
    <div class="stats-row" style="grid-template-columns: repeat(3, 1fr);">
      <div class="stat-card highlight">
        <div class="stat-label">ì •ì‚° ëŒ€ê¸°</div>
        <div class="stat-value">${pendingSettlement.length}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì •ì‚° ì™„ë£Œ</div>
        <div class="stat-value">${fullySettled.length}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ì™„ë£Œ</div>
        <div class="stat-value">${completedDeals.length}</div>
      </div>
    </div>
    
    <div class="card">
      <h2 class="card-title" style="color: var(--primary)">â° ì •ì‚° ëŒ€ê¸°</h2>
      
      ${pendingSettlement.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ‰</div>
          <div class="text">ì •ì‚° ëŒ€ê¸° ì¤‘ì¸ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th>ê³µêµ¬ëª…</th>
              <th>ê³µê¸‰ì‚¬</th>
              <th>ì…€ëŸ¬</th>
              <th>ë§ˆê°ì¼</th>
              <th>ê²½ê³¼</th>
              <th>ê³µê¸‰ì‚¬ ì •ì‚°</th>
              <th>ì…€ëŸ¬ ì •ì‚°</th>
            </tr>
          </thead>
          <tbody>
            ${pendingSettlement.sort((a,b) => new Date(a.endDate) - new Date(b.endDate)).map(d => {
              const endDate = parseDate(d.endDate);
              const daysSince = Math.floor((today - endDate) / (1000 * 60 * 60 * 24));
              const urgent = daysSince >= 3 && daysSince <= 7;
              const overdue = daysSince > 7;
              
              return `
                <tr style="${overdue ? 'background: var(--danger-light)' : urgent ? 'background: var(--primary-light)' : ''}">
                  <td><strong>${d.title}</strong></td>
                  <td>${getSupplierName(d.supplierId)}</td>
                  <td>${getSellerName(d.sellerId)}</td>
                  <td>${formatDateKR(d.endDate)}</td>
                  <td style="color: ${overdue ? 'var(--danger)' : urgent ? 'var(--primary)' : 'var(--success)'}; font-weight: 600">
                    ${daysSince}ì¼ ${overdue ? 'âš ï¸' : ''}
                  </td>
                  <td>
                    <label class="checkbox-wrapper" style="padding: 8px 12px" onclick="event.stopPropagation(); updateSettlement('${d.id}', 'supplierSettled', ${!d.supplierSettled})">
                      <input type="checkbox" ${d.supplierSettled ? 'checked' : ''} onclick="event.stopPropagation()">
                      <span>${d.supplierSettled ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}</span>
                    </label>
                  </td>
                  <td>
                    <label class="checkbox-wrapper" style="padding: 8px 12px" onclick="event.stopPropagation(); updateSettlement('${d.id}', 'sellerSettled', ${!d.sellerSettled})">
                      <input type="checkbox" ${d.sellerSettled ? 'checked' : ''} onclick="event.stopPropagation()">
                      <span>${d.sellerSettled ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}</span>
                    </label>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `}
    </div>
    
    ${fullySettled.length > 0 ? `
      <div class="card">
        <h2 class="card-title" style="color: var(--success)">âœ… ì •ì‚° ì™„ë£Œ</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>ê³µêµ¬ëª…</th>
              <th>ê³µê¸‰ì‚¬</th>
              <th>ì…€ëŸ¬</th>
              <th>ë§ˆê°ì¼</th>
            </tr>
          </thead>
          <tbody>
            ${fullySettled.map(d => `
              <tr style="opacity: 0.6">
                <td>${d.title}</td>
                <td>${getSupplierName(d.supplierId)}</td>
                <td>${getSellerName(d.sellerId)}</td>
                <td>${formatDateKR(d.endDate)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    ` : ''}
  `;
}

// ========== ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ í•¨ìˆ˜ ==========

async function saveSellerListItem(data) {
  try {
    if (data.id) {
      await db.collection('sellerList').doc(data.id).update(data);
    } else {
      delete data.id;
      await db.collection('sellerList').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteSellerListItem(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('sellerList').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function toggleSellerListField(id, field, value) {
  try {
    await db.collection('sellerList').doc(id).update({ [field]: value });
  } catch(e) {
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function openSellerListModal(item = null, bulk = false) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  if (bulk) {
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ ë“±ë¡</h2>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
          <button class="btn btn-secondary" style="flex:1" onclick="showSellerListTextInput()">ğŸ“ í…ìŠ¤íŠ¸ ì…ë ¥</button>
          <button class="btn btn-primary" style="flex:1" onclick="showSellerListExcelUpload()">ğŸ“Š ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        
        <div id="sellerList-bulk-content">
          <div id="sellerList-excel-upload">
            <div class="form-group">
              <label class="form-label">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">
                ì—‘ì…€ íŒŒì¼ì˜ ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.<br>
                <strong>ì—´:</strong> ì¹´í…Œê³ ë¦¬, ê³„ì •ëª…, ê³„ì •ë§í¬, ì»¨íƒìœ ë¬´, ì œì•ˆìƒí’ˆ, ë¹„ê³ 
              </p>
              <div style="border: 2px dashed var(--gray-300); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.15s ease;" 
                   onclick="document.getElementById('excel-file-sellerList').click()"
                   ondragover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'; event.preventDefault()"
                   ondragleave="this.style.borderColor='var(--gray-300)'; this.style.background='transparent'"
                   ondrop="handleSellerListExcelDrop(event)">
                <div style="font-size: 36px; margin-bottom: 8px;">ğŸ“</div>
                <div style="color: var(--gray-700); font-weight: 500;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                <div style="color: var(--gray-500); font-size: 13px; margin-top: 4px;">.xlsx, .xls íŒŒì¼ ì§€ì›</div>
              </div>
              <input type="file" id="excel-file-sellerList" accept=".xlsx,.xls" style="display:none" onchange="handleSellerListExcelFile(this.files[0])">
            </div>
            
            <div id="sellerList-excel-preview" style="display:none; margin-top: 16px;">
              <div class="form-label">ë¯¸ë¦¬ë³´ê¸° <span id="sellerList-preview-count" style="color: var(--primary);"></span></div>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 8px;">
                <table class="data-table" id="sellerList-preview-table">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            
            <div style="margin-top: 16px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px;">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì˜ˆì‹œ</div>
              <div style="overflow-x: auto;">
                <table style="font-size: 12px; border-collapse: collapse; width: 100%;">
                  <tr style="background: var(--primary-light);">
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì¹´í…Œê³ ë¦¬</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ê³„ì •ëª…</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ê³„ì •ë§í¬</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì»¨íƒìœ ë¬´</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ì œì•ˆìƒí’ˆ</th>
                    <th style="padding: 8px; border: 1px solid var(--gray-300);">ë¹„ê³ </th>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ë·°í‹°</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ë·°í‹°ì¸í”Œë£¨ì–¸ì„œ</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">instagram.com/beauty</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">O</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸</td>
                    <td style="padding: 8px; border: 1px solid var(--gray-300);">VIP</td>
                  </tr>
                </table>
              </div>
              <button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="downloadSellerListTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
          
          <div id="sellerList-text-input" style="display: none;">
            <div class="form-group">
              <label class="form-label">ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</label>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">
                í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”. (ì‰¼í‘œë¡œ êµ¬ë¶„)<br>
                í˜•ì‹: ì¹´í…Œê³ ë¦¬, ê³„ì •ëª…, ê³„ì •ë§í¬, ì»¨íƒìœ ë¬´(O/X), ì œì•ˆìƒí’ˆ, ë¹„ê³ 
              </p>
              <textarea class="form-textarea" id="bulk-sellerList" rows="10" placeholder="ì˜ˆì‹œ:
ë·°í‹°, ë·°í‹°ì¸í”Œë£¨ì–¸ì„œ, instagram.com/beauty, O, ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸, VIP
íŒ¨ì…˜, íŒ¨ì…˜ìŠ¤íƒ€, youtube.com/fashion, X, ì—¬ë¦„ ì›í”¼ìŠ¤, ì‹ ê·œ
ê±´ê°•, í—¬ìŠ¤ë§ˆë‹ˆì•„, blog.naver.com/health, O, í”„ë¡œí‹´, "></textarea>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="submitBulkSellerList()">ì¼ê´„ ë“±ë¡</button>
        </div>
      </div>
    `;
    return;
  }
  
  const isEdit = item !== null;
  const s = item || { category: '', accountName: '', accountLink: '', contacted: false, proposedProduct: '', productDetails: {}, notes: '' };
  
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ìˆ˜ì •' : 'ìƒˆ ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitSellerListForm(event, '${s.id || ''}')">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <input type="text" class="form-input" id="sl-category" value="${s.category || ''}" placeholder="ì˜ˆ: ë·°í‹°, íŒ¨ì…˜, ê±´ê°•">
          </div>
          <div class="form-group">
            <label class="form-label">ê³„ì •ëª… *</label>
            <input type="text" class="form-input" id="sl-accountName" value="${s.accountName || ''}" required placeholder="ì˜ˆ: ë·°í‹°ì¸í”Œë£¨ì–¸ì„œ">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ê³„ì •ë§í¬</label>
          <input type="text" class="form-input" id="sl-accountLink" value="${s.accountLink || ''}" placeholder="ì˜ˆ: instagram.com/username">
        </div>
        <div class="form-group">
          <label class="form-label">ì»¨íƒìœ ë¬´</label>
          <label class="checkbox-wrapper">
            <input type="checkbox" id="sl-contacted" ${s.contacted ? 'checked' : ''}>
            <span>ì»¨íƒ ì™„ë£Œ</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">ì œì•ˆí•œ ìƒí’ˆ</label>
          <input type="text" class="form-input" id="sl-proposedProduct" value="${s.proposedProduct || ''}" placeholder="ì˜ˆ: ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸, ì—¬ë¦„ ì›í”¼ìŠ¤">
        </div>
        
        ${state.products.length > 0 ? `
          <div class="form-group">
            <label class="form-label">ìƒí’ˆë³„ ìƒ˜í”Œ ì „ë‹¬ ë° í˜‘ì˜ ë‚´ì—­</label>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${state.products.map(p => {
                const detail = (s.productDetails && s.productDetails[p.id]) || { sampleSent: false, notes: '' };
                return `
                <div style="padding: 12px; background: var(--gray-50); border-radius: 10px;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <label class="checkbox-wrapper" style="flex: 0 0 auto;">
                      <input type="checkbox" name="sl-sample-${p.id}" ${detail.sampleSent ? 'checked' : ''}>
                      <span style="font-weight: 600;">${p.name}</span>
                    </label>
                    <span style="font-size: 12px; color: var(--gray-500);">ìƒ˜í”Œ ì „ë‹¬</span>
                  </div>
                  <textarea class="form-textarea" name="sl-note-${p.id}" rows="2" placeholder="${p.name} í˜‘ì˜ ë‚´ì—­ ì…ë ¥..." style="font-size: 13px;">${detail.notes || ''}</textarea>
                </div>
              `}).join('')}
            </div>
          </div>
        ` : `
          <div class="alert alert-warning" style="margin-bottom: 16px;">
            ìƒí’ˆë³„ ìƒ˜í”Œ ì „ë‹¬ì„ ì²´í¬í•˜ë ¤ë©´ <a href="#" onclick="closeModal(); switchTab('products');" style="color: var(--primary); font-weight: 600;">ìƒí’ˆ ê´€ë¦¬</a>ì—ì„œ ìƒí’ˆì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
          </div>
        `}
        
        <div class="form-group">
          <label class="form-label">ë¹„ê³ </label>
          <textarea class="form-textarea" id="sl-notes" rows="3" placeholder="ì¶”ê°€ ì •ë³´">${s.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSellerListItem('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
}

function submitSellerListForm(e, id) {
  e.preventDefault();
  
  // ìƒí’ˆë³„ ìƒ˜í”Œ ì „ë‹¬ ë° í˜‘ì˜ ë‚´ì—­ ìˆ˜ì§‘
  const productDetails = {};
  state.products.forEach(p => {
    const sampleCheckbox = document.querySelector(`input[name="sl-sample-${p.id}"]`);
    const noteTextarea = document.querySelector(`textarea[name="sl-note-${p.id}"]`);
    productDetails[p.id] = {
      sampleSent: sampleCheckbox ? sampleCheckbox.checked : false,
      notes: noteTextarea ? noteTextarea.value : ''
    };
  });
  
  const data = {
    category: document.getElementById('sl-category').value,
    accountName: document.getElementById('sl-accountName').value,
    accountLink: document.getElementById('sl-accountLink').value,
    contacted: document.getElementById('sl-contacted').checked,
    proposedProduct: document.getElementById('sl-proposedProduct').value,
    productDetails: productDetails,
    notes: document.getElementById('sl-notes').value,
  };
  if (id) data.id = id;
  saveSellerListItem(data);
}

// ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì…ë ¥ ë°©ì‹ ì „í™˜
function showSellerListTextInput() {
  document.getElementById('sellerList-excel-upload').style.display = 'none';
  document.getElementById('sellerList-text-input').style.display = 'block';
  window.sellerListBulkMode = 'text';
}

function showSellerListExcelUpload() {
  document.getElementById('sellerList-excel-upload').style.display = 'block';
  document.getElementById('sellerList-text-input').style.display = 'none';
  window.sellerListBulkMode = 'excel';
}

// ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
let sellerListExcelData = [];

function handleSellerListExcelDrop(e) {
  e.preventDefault();
  e.target.style.borderColor = 'var(--gray-300)';
  e.target.style.background = 'transparent';
  const file = e.dataTransfer.files[0];
  if (file) handleSellerListExcelFile(file);
}

function handleSellerListExcelFile(file) {
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      if (jsonData.length < 2) {
        showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      const headers = jsonData[0].map(h => String(h).trim());
      const rows = jsonData.slice(1).filter(row => row.some(cell => cell));
      
      const colMap = {
        category: headers.findIndex(h => h.includes('ì¹´í…Œê³ ë¦¬') || h.toLowerCase().includes('category')),
        accountName: headers.findIndex(h => h.includes('ê³„ì •ëª…') || h.includes('ì´ë¦„') || h.toLowerCase().includes('name') || h.toLowerCase().includes('account')),
        accountLink: headers.findIndex(h => h.includes('ê³„ì •ë§í¬') || h.includes('ë§í¬') || h.toLowerCase().includes('link')),
        contacted: headers.findIndex(h => h.includes('ì»¨íƒ') || h.toLowerCase().includes('contact')),
        proposedProduct: headers.findIndex(h => h.includes('ì œì•ˆ') || h.includes('ìƒí’ˆ') || h.toLowerCase().includes('product')),
        notes: headers.findIndex(h => h.includes('ë¹„ê³ ') || h.includes('ë©”ëª¨') || h.toLowerCase().includes('note'))
      };
      
      sellerListExcelData = rows.map(row => ({
        category: colMap.category >= 0 ? String(row[colMap.category] || '').trim() : '',
        accountName: colMap.accountName >= 0 ? String(row[colMap.accountName] || '').trim() : '',
        accountLink: colMap.accountLink >= 0 ? String(row[colMap.accountLink] || '').trim() : '',
        contacted: colMap.contacted >= 0 ? ['O', 'o', 'Y', 'y', '1', 'true', 'TRUE', 'ì™„ë£Œ', 'ì˜ˆ'].includes(String(row[colMap.contacted] || '').trim()) : false,
        proposedProduct: colMap.proposedProduct >= 0 ? String(row[colMap.proposedProduct] || '').trim() : '',
        productDetails: {},
        notes: colMap.notes >= 0 ? String(row[colMap.notes] || '').trim() : ''
      })).filter(item => item.accountName);
      
      const previewDiv = document.getElementById('sellerList-excel-preview');
      const countSpan = document.getElementById('sellerList-preview-count');
      const thead = document.querySelector('#sellerList-preview-table thead');
      const tbody = document.querySelector('#sellerList-preview-table tbody');
      
      countSpan.textContent = `(${sellerListExcelData.length}ê±´)`;
      thead.innerHTML = '<tr><th>ì¹´í…Œê³ ë¦¬</th><th>ê³„ì •ëª…</th><th>ê³„ì •ë§í¬</th><th>ì»¨íƒ</th><th>ì œì•ˆìƒí’ˆ</th><th>ë¹„ê³ </th></tr>';
      tbody.innerHTML = sellerListExcelData.slice(0, 10).map(s => `
        <tr>
          <td>${s.category}</td>
          <td>${s.accountName}</td>
          <td>${s.accountLink}</td>
          <td>${s.contacted ? 'âœ“' : '-'}</td>
          <td>${s.proposedProduct}</td>
          <td>${s.notes}</td>
        </tr>
      `).join('') + (sellerListExcelData.length > 10 ? `<tr><td colspan="6" style="text-align:center;color:var(--gray-500)">... ì™¸ ${sellerListExcelData.length - 10}ê±´</td></tr>` : '');
      
      previewDiv.style.display = 'block';
      showToast(`${sellerListExcelData.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
      
    } catch(err) {
      console.error(err);
      showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };
  reader.readAsArrayBuffer(file);
}

function downloadSellerListTemplate() {
  const ws = XLSX.utils.aoa_to_sheet([
    ['ì¹´í…Œê³ ë¦¬', 'ê³„ì •ëª…', 'ê³„ì •ë§í¬', 'ì»¨íƒìœ ë¬´', 'ì œì•ˆìƒí’ˆ', 'ë¹„ê³ '],
    ['ë·°í‹°', 'ë·°í‹°ì¸í”Œë£¨ì–¸ì„œ', 'instagram.com/beauty', 'O', 'ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸', 'VIP'],
    ['íŒ¨ì…˜', 'íŒ¨ì…˜ìŠ¤íƒ€', 'youtube.com/fashion', 'X', 'ì—¬ë¦„ ì›í”¼ìŠ¤', 'ì‹ ê·œ'],
  ]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì…€ëŸ¬ë¦¬ìŠ¤íŠ¸');
  XLSX.writeFile(wb, 'ì…€ëŸ¬ë¦¬ìŠ¤íŠ¸_ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx');
}

async function submitBulkSellerList() {
  let dataToSubmit = [];
  
  if (window.sellerListBulkMode !== 'text' && sellerListExcelData.length > 0) {
    dataToSubmit = sellerListExcelData;
  } else {
    const text = document.getElementById('bulk-sellerList')?.value?.trim();
    if (!text) {
      showToast('ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    dataToSubmit = lines.map(line => {
      const parts = line.split(',').map(p => p.trim());
      return {
        category: parts[0] || '',
        accountName: parts[1] || '',
        accountLink: parts[2] || '',
        contacted: ['O', 'o', 'Y', 'y', '1'].includes(parts[3] || ''),
        proposedProduct: parts[4] || '',
        productDetails: {},
        notes: parts[5] || ''
      };
    }).filter(item => item.accountName);
  }
  
  if (dataToSubmit.length === 0) {
    showToast('ë“±ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  let successCount = 0;
  for (const data of dataToSubmit) {
    try {
      await db.collection('sellerList').add(data);
      successCount++;
    } catch(e) {
      console.error(e);
    }
  }
  
  sellerListExcelData = [];
  showToast(`${successCount}ê±´ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
  closeModal();
}

function renderSellerList() {
  const app = document.getElementById('app');
  
  // í†µê³„ ê³„ì‚°
  const totalCount = state.sellerList.length;
  const contactedCount = state.sellerList.filter(s => s.contacted).length;
  
  // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¶”ì¶œ
  const categories = [...new Set(state.sellerList.map(s => s.category).filter(c => c))];
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸</h1>
      <p class="page-desc">ì´ ${totalCount}ê±´ì˜ ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="openSellerListModal(null, true)">ğŸ“‹ ì¼ê´„ ë“±ë¡</button>
        <button class="btn btn-primary" onclick="openSellerListModal()">+ ìƒˆ ì…€ëŸ¬</button>
      </div>
    </div>
    
    <div class="stats-row" style="grid-template-columns: repeat(${3 + Math.min(state.products.length, 3)}, 1fr);">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´</div>
        <div class="stat-value">${totalCount}</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-label">ì»¨íƒ ì™„ë£Œ</div>
        <div class="stat-value">${contactedCount}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">í˜œíƒ ë“±ë¡</div>
        <div class="stat-value">${state.sellerList.filter(s => s.benefits && ((s.benefits.prelaunch && s.benefits.prelaunch.length > 0) || (s.benefits.launch && s.benefits.launch.length > 0) || (s.benefits.support && s.benefits.support.length > 0))).length}</div>
      </div>
      ${state.products.slice(0, 3).map(p => {
        const count = state.sellerList.filter(s => {
          const detail = s.productDetails && s.productDetails[p.id];
          return detail && detail.sampleSent;
        }).length;
        return `
          <div class="stat-card">
            <div class="stat-label">${p.name} ìƒ˜í”Œ</div>
            <div class="stat-value">${count}</div>
          </div>
        `;
      }).join('')}
    </div>
    
    ${state.products.length === 0 ? `
      <div class="alert alert-warning">
        âš ï¸ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. <a href="#" onclick="switchTab('products')" style="color: var(--primary); font-weight: 600;">ìƒí’ˆ ê´€ë¦¬</a>ì—ì„œ ìƒí’ˆì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
      </div>
    ` : ''}
    
    <div class="card">
      <div class="filter-bar">
        <div class="filter-group">
          <button class="filter-btn ${!window.slCategoryFilter ? 'active' : ''}" onclick="filterSellerListByCategory('')">ì „ì²´</button>
          ${categories.map(cat => `
            <button class="filter-btn ${window.slCategoryFilter === cat ? 'active' : ''}" onclick="filterSellerListByCategory('${cat}')">${cat}</button>
          `).join('')}
        </div>
      </div>
      
      ${state.sellerList.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ“’</div>
          <div class="text">ë“±ë¡ëœ ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      ` : `
        <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ì¹´í…Œê³ ë¦¬</th>
              <th>ê³„ì •ëª…</th>
              <th>ê³„ì •ë§í¬</th>
              <th>ì»¨íƒ</th>
              <th>ì œì•ˆí•œ ìƒí’ˆ</th>
              <th>ì…€ëŸ¬ í˜œíƒ</th>
              ${state.products.map(p => `<th style="text-align:center; min-width: 100px;">${p.name}<br><span style="font-size:10px;color:var(--gray-500)">ìƒ˜í”Œ/í˜‘ì˜</span></th>`).join('')}
              <th>ë¹„ê³ </th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${state.sellerList
              .filter(s => !window.slCategoryFilter || s.category === window.slCategoryFilter)
              .map(s => {
                const productDetails = s.productDetails || {};
                const sellerBenefits = s.benefits || { prelaunch: [], launch: [], support: [] };
                const hasSellerBenefits = (sellerBenefits.prelaunch && sellerBenefits.prelaunch.length > 0) ||
                                          (sellerBenefits.launch && sellerBenefits.launch.length > 0) ||
                                          (sellerBenefits.support && sellerBenefits.support.length > 0);
                return `
              <tr>
                <td>${s.category ? `<span class="status-badge status-confirmed">${s.category}</span>` : '-'}</td>
                <td><strong>${s.accountName}</strong></td>
                <td>${s.accountLink ? `<a href="${s.accountLink.startsWith('http') ? s.accountLink : 'https://' + s.accountLink}" target="_blank" style="color: var(--primary); text-decoration: none;">${s.accountLink.length > 20 ? s.accountLink.substring(0, 20) + '...' : s.accountLink}</a>` : '-'}</td>
                <td>
                  <label class="checkbox-wrapper" style="padding: 6px 10px; display: inline-flex;" onclick="event.stopPropagation(); toggleSellerListField('${s.id}', 'contacted', ${!s.contacted})">
                    <input type="checkbox" ${s.contacted ? 'checked' : ''} onclick="event.stopPropagation()">
                  </label>
                </td>
                <td>${s.proposedProduct || '-'}</td>
                <td>
                  <button class="btn btn-sm ${hasSellerBenefits ? 'btn-primary' : 'btn-secondary'}" onclick="openSellerBenefitsModal('${s.id}')" style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                    ğŸ ${hasSellerBenefits ? 'í˜œíƒ ë³´ê¸°' : 'í˜œíƒ ì„¤ì •'}
                  </button>
                </td>
                ${state.products.map(p => {
                  const detail = productDetails[p.id] || { sampleSent: false, notes: '' };
                  const hasNotes = detail.notes && detail.notes.trim();
                  return `
                    <td style="text-align:center;">
                      <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <label class="checkbox-wrapper" style="padding: 4px 6px; display: inline-flex;" onclick="event.stopPropagation(); toggleProductSample('${s.id}', '${p.id}', ${!detail.sampleSent})">
                          <input type="checkbox" ${detail.sampleSent ? 'checked' : ''} onclick="event.stopPropagation()">
                        </label>
                        <button class="btn-icon ${hasNotes ? 'has-notes' : ''}" onclick="openProductNoteModal('${s.id}', '${p.id}')" title="${hasNotes ? 'í˜‘ì˜ ë‚´ì—­ ìˆìŒ' : 'í˜‘ì˜ ë‚´ì—­ ì¶”ê°€'}">
                          ${hasNotes ? 'ğŸ“' : 'âœï¸'}
                        </button>
                      </div>
                      ${hasNotes ? `<div style="font-size: 11px; color: var(--gray-500); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px;" title="${detail.notes}">${detail.notes}</div>` : ''}
                    </td>
                  `;
                }).join('')}
                <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.notes || '-'}</td>
                <td class="actions">
                  <button class="btn btn-secondary btn-sm" onclick="openSellerListModal(state.sellerList.find(item=>item.id==='${s.id}'))">ìˆ˜ì •</button>
                </td>
              </tr>
            `;}).join('')}
          </tbody>
        </table>
        </div>
      `}
    </div>
  `;
}

// ìƒí’ˆë³„ ìƒ˜í”Œ ì „ë‹¬ í† ê¸€
async function toggleProductSample(sellerListId, productId, sampleSent) {
  try {
    const item = state.sellerList.find(s => s.id === sellerListId);
    let productDetails = item.productDetails || {};
    
    productDetails[productId] = {
      ...productDetails[productId],
      sampleSent: sampleSent,
      notes: productDetails[productId]?.notes || ''
    };
    
    await db.collection('sellerList').doc(sellerListId).update({ productDetails });
  } catch(e) {
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ìƒí’ˆë³„ í˜‘ì˜ ë‚´ì—­ ëª¨ë‹¬
function openProductNoteModal(sellerListId, productId) {
  const seller = state.sellerList.find(s => s.id === sellerListId);
  const product = state.products.find(p => p.id === productId);
  const detail = (seller.productDetails && seller.productDetails[productId]) || { sampleSent: false, notes: '' };
  const sellerBenefits = seller.benefits || { prelaunch: [], launch: [], support: [] };
  const hasSellerBenefits = (sellerBenefits.prelaunch && sellerBenefits.prelaunch.length > 0) ||
                            (sellerBenefits.launch && sellerBenefits.launch.length > 0) ||
                            (sellerBenefits.support && sellerBenefits.support.length > 0);
  
  const supportLabels = {
    ad: 'ì½˜í…ì¸  ê´‘ê³ ', payment: 'ì „ìš© ê²°ì œì°½', sample: 'ìƒ˜í”Œ ì œê³µ',
    feed: 'í”¼ë“œ ì œì‘', shipping: 'ë¬´ë£Œ ë°°ì†¡', commission: 'ë†’ì€ ìˆ˜ìˆ˜ë£Œ'
  };
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">${product.name} - í˜‘ì˜ ë‚´ì—­</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 16px; background: var(--gray-50); border-radius: 12px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 13px; color: var(--gray-500);">ì…€ëŸ¬</div>
            <div style="font-weight: 600; margin-top: 4px;">${seller.accountName}</div>
          </div>
          ${hasSellerBenefits ? `
            <button class="btn btn-secondary btn-sm" onclick="closeModal(); openSellerBenefitsModal('${sellerListId}')" style="font-size: 12px;">ğŸ í˜œíƒ ë³´ê¸°</button>
          ` : ''}
        </div>
      </div>
      
      <form onsubmit="submitProductNote(event, '${sellerListId}', '${productId}')">
        <div class="form-group">
          <label class="checkbox-wrapper">
            <input type="checkbox" id="pn-sampleSent" ${detail.sampleSent ? 'checked' : ''}>
            <span>ìƒ˜í”Œ ì „ë‹¬ ì™„ë£Œ</span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">í˜‘ì˜ ë‚´ì—­</label>
          <textarea class="form-textarea" id="pn-notes" rows="5" placeholder="ì´ ìƒí’ˆì— ëŒ€í•œ í˜‘ì˜ ë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”.&#10;ì˜ˆ: 12/15 í†µí™” - ìƒ˜í”Œ ìˆ˜ë ¹ í›„ ë¦¬ë·° ì§„í–‰ ì˜ˆì •&#10;    12/20 í˜‘ì˜ - 1ì›” ì²«ì§¸ì£¼ ê³µêµ¬ ì§„í–‰ í™•ì •">${detail.notes || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
        </div>
      </form>
    </div>
  `;
}

async function submitProductNote(e, sellerListId, productId) {
  e.preventDefault();
  
  try {
    const item = state.sellerList.find(s => s.id === sellerListId);
    let productDetails = item.productDetails || {};
    
    productDetails[productId] = {
      sampleSent: document.getElementById('pn-sampleSent').checked,
      notes: document.getElementById('pn-notes').value
    };
    
    await db.collection('sellerList').doc(sellerListId).update({ productDetails });
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function filterSellerListByCategory(category) {
  window.slCategoryFilter = category;
  render();
}

// ========== ìƒí’ˆ ê´€ë¦¬ ê´€ë ¨ í•¨ìˆ˜ ==========

async function saveProduct(data) {
  try {
    if (data.id) {
      await db.collection('products').doc(data.id).update(data);
    } else {
      delete data.id;
      // ìƒˆ ìƒí’ˆì€ ë§ˆì§€ë§‰ ìˆœì„œë¡œ ì¶”ê°€
      data.order = state.products.length;
      await db.collection('products').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteProduct(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ìƒí’ˆì˜ ìƒ˜í”Œ ì „ë‹¬ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;
  try {
    await db.collection('products').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function reorderProducts(productId, direction) {
  const currentIndex = state.products.findIndex(p => p.id === productId);
  if (currentIndex === -1) return;
  
  const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
  if (newIndex < 0 || newIndex >= state.products.length) return;
  
  try {
    const batch = db.batch();
    const currentProduct = state.products[currentIndex];
    const swapProduct = state.products[newIndex];
    
    batch.update(db.collection('products').doc(currentProduct.id), { order: newIndex });
    batch.update(db.collection('products').doc(swapProduct.id), { order: currentIndex });
    
    await batch.commit();
  } catch(e) {
    showToast('ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function openProductModal(product = null) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  const isEdit = product !== null;
  const p = product || { name: '', description: '' };
  
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ìƒí’ˆ ìˆ˜ì •' : 'ìƒˆ ìƒí’ˆ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitProductForm(event, '${p.id || ''}')">
        <div class="form-group">
          <label class="form-label">ìƒí’ˆëª… *</label>
          <input type="text" class="form-input" id="product-name" value="${p.name || ''}" required placeholder="ì˜ˆ: ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸">
        </div>
        <div class="form-group">
          <label class="form-label">ì„¤ëª…</label>
          <textarea class="form-textarea" id="product-description" rows="3" placeholder="ìƒí’ˆì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…">${p.description || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteProduct('${p.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
}

function addBenefitRow(type) {
  const container = document.getElementById(type + '-benefits');
  const row = document.createElement('div');
  row.className = 'benefit-row';
  row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
  row.innerHTML = `
    <input type="text" class="form-input" name="${type}-name" placeholder="ì´ë²¤íŠ¸ëª…" style="flex: 2;">
    <input type="text" class="form-input" name="${type}-count" placeholder="ì¸ì›" style="flex: 0.5;">
    <input type="text" class="form-input" name="${type}-reward" placeholder="í˜œíƒ" style="flex: 1.5;">
    <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
  `;
  container.appendChild(row);
}

function submitProductForm(e, id) {
  e.preventDefault();
  const data = {
    name: document.getElementById('product-name').value,
    description: document.getElementById('product-description').value,
  };
  if (id) data.id = id;
  saveProduct(data);
}

function renderProducts() {
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ìƒí’ˆ ê´€ë¦¬</h1>
      <p class="page-desc">ìƒ˜í”Œ ì „ë‹¬ ì²´í¬ì— ì‚¬ìš©í•  ìƒí’ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openProductModal()">+ ìƒˆ ìƒí’ˆ</button>
      </div>
    </div>
    
    <div class="card">
      <div style="margin-bottom: 16px; padding: 16px; background: var(--info-light); border-radius: 12px; color: var(--info);">
        <strong>ğŸ’¡ íŒ:</strong> ì—¬ê¸°ì„œ ë“±ë¡í•œ ìƒí’ˆë“¤ì´ ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì˜ 'ìƒ˜í”Œ ì „ë‹¬' ì²´í¬ í•­ëª©ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
      </div>
      
      ${state.products.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ“¦</div>
          <div class="text">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="openProductModal()">+ ì²« ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 60px;">ìˆœì„œ</th>
              <th>ìƒí’ˆëª…</th>
              <th>ì„¤ëª…</th>
              <th>ìƒ˜í”Œ ì „ë‹¬</th>
              <th>í˜‘ì˜ ì§„í–‰</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${state.products.map((p, idx) => {
              const sampleCount = state.sellerList.filter(s => s.productDetails && s.productDetails[p.id] && s.productDetails[p.id].sampleSent).length;
              const noteCount = state.sellerList.filter(s => s.productDetails && s.productDetails[p.id] && s.productDetails[p.id].notes && s.productDetails[p.id].notes.trim()).length;
              return `
                <tr>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button class="btn btn-secondary btn-sm" style="padding: 4px 8px;" onclick="reorderProducts('${p.id}', 'up')" ${idx === 0 ? 'disabled style="opacity:0.3;padding:4px 8px;"' : ''}>â†‘</button>
                      <button class="btn btn-secondary btn-sm" style="padding: 4px 8px;" onclick="reorderProducts('${p.id}', 'down')" ${idx === state.products.length - 1 ? 'disabled style="opacity:0.3;padding:4px 8px;"' : ''}>â†“</button>
                    </div>
                  </td>
                  <td><strong>${p.name}</strong></td>
                  <td style="color: var(--gray-500);">${p.description || '-'}</td>
                  <td>
                    <span class="status-badge status-ongoing">${sampleCount}ëª…</span>
                  </td>
                  <td>
                    <span class="status-badge status-confirmed">${noteCount}ê±´</span>
                  </td>
                  <td class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="openProductModal(state.products.find(prod=>prod.id==='${p.id}'))">ìˆ˜ì •</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `}
    </div>
    
    ${state.products.length > 0 ? `
      <div class="card">
        <h3 class="card-title">ğŸ“Š ìƒí’ˆë³„ í˜„í™©</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
          ${state.products.map(p => {
            const sampleCount = state.sellerList.filter(s => s.productDetails && s.productDetails[p.id] && s.productDetails[p.id].sampleSent).length;
            const noteCount = state.sellerList.filter(s => s.productDetails && s.productDetails[p.id] && s.productDetails[p.id].notes && s.productDetails[p.id].notes.trim()).length;
            const totalCount = state.sellerList.length;
            const samplePercentage = totalCount > 0 ? Math.round((sampleCount / totalCount) * 100) : 0;
            return `
              <div style="padding: 16px; background: var(--gray-50); border-radius: 12px;">
                <div style="font-weight: 600; margin-bottom: 12px;">${p.name}</div>
                <div style="margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                    <span style="color: var(--gray-500);">ìƒ˜í”Œ ì „ë‹¬</span>
                    <span style="font-weight: 600; color: var(--primary);">${sampleCount}/${totalCount}</span>
                  </div>
                  <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                    <div style="height: 100%; width: ${samplePercentage}%; background: var(--primary); border-radius: 3px;"></div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                  <span style="color: var(--gray-500);">í˜‘ì˜ ì§„í–‰</span>
                  <span style="font-weight: 600; color: var(--success);">${noteCount}ê±´</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    ` : ''}
  `;
}

// ========== ê³µê¸‰ì‚¬ ìƒí’ˆ DB ë Œë”ë§ ==========
function renderProductDB() {
  const app = document.getElementById('app');
  const products = state.supplierProducts || [];
  
  // ê³µê¸‰ì‚¬ë³„ë¡œ ê·¸ë£¹í™”
  const productsBySupplier = {};
  products.forEach(p => {
    const key = p.supplierId || 'unknown';
    if (!productsBySupplier[key]) {
      productsBySupplier[key] = [];
    }
    productsBySupplier[key].push(p);
  });
  
  // í†µê³„
  const totalProducts = products.length;
  const supplierCount = Object.keys(productsBySupplier).length;
  const inhouseCount = products.filter(p => p.supplierType === 'inhouse').length;
  const externalCount = products.filter(p => p.supplierType !== 'inhouse').length;
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ê³µê¸‰ì‚¬ ìƒí’ˆ DB</h1>
      <p class="page-desc">ê³µê¸‰ì‚¬ì—ì„œ ë°›ì€ ìƒí’ˆ ì •ë³´ë¥¼ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤. ê³µêµ¬ ë“±ë¡ ë° ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œì™€ ì—°ë™ë©ë‹ˆë‹¤.</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openProductDBModal()">+ ìƒˆ ìƒí’ˆ ë“±ë¡</button>
      </div>
    </div>
    
    <!-- í†µê³„ ì¹´ë“œ -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
      <div class="card" style="text-align: center; padding: 20px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${totalProducts}</div>
        <div style="font-size: 14px; color: var(--gray-500);">ì „ì²´ ìƒí’ˆ</div>
      </div>
      <div class="card" style="text-align: center; padding: 20px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--info);">${supplierCount}</div>
        <div style="font-size: 14px; color: var(--gray-500);">ê³µê¸‰ì‚¬ ìˆ˜</div>
      </div>
      <div class="card" style="text-align: center; padding: 20px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--success);">${inhouseCount}</div>
        <div style="font-size: 14px; color: var(--gray-500);">ìì‚¬ ìƒí’ˆ</div>
      </div>
      <div class="card" style="text-align: center; padding: 20px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--warning);">${externalCount}</div>
        <div style="font-size: 14px; color: var(--gray-500);">íƒ€ì‚¬ ìƒí’ˆ</div>
      </div>
    </div>
    
    <!-- ì—°ë™ ì•ˆë‚´ -->
    <div class="card" style="margin-bottom: 24px;">
      <div style="padding: 16px; background: var(--info-light); border-radius: 12px; color: var(--info);">
        <strong>ğŸ’¡ ì´ ë°ì´í„°ëŠ” ë‹¤ìŒê³¼ ì—°ë™ë©ë‹ˆë‹¤:</strong>
        <ul style="margin: 8px 0 0 20px; font-size: 14px;">
          <li><strong>ìº˜ë¦°ë” ê³µêµ¬ ë“±ë¡</strong> - ê³µê¸‰ì‚¬ ì„ íƒ ì‹œ í•´ë‹¹ ìƒí’ˆ ëª©ë¡ì—ì„œ ì„ íƒ</li>
          <li><strong>ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œ</strong> - ì •ì‚° ê¸ˆì•¡ ì‚°ì¶œì— í™œìš©</li>
          <li><strong>ê³µêµ¬ ì§„í–‰ ê´€ë¦¬</strong> - ìƒ˜í”Œ ì „ë‹¬ ë° í˜‘ì˜ì‚¬í•­ ê´€ë¦¬</li>
        </ul>
      </div>
    </div>
    
    <!-- ìƒí’ˆ ëª©ë¡ -->
    <div class="card">
      <h3 class="card-title">ğŸ“¦ ìƒí’ˆ ëª©ë¡</h3>
      
      ${products.length === 0 ? `
        <div class="empty-state">
          <div class="icon">ğŸ“¦</div>
          <div class="text">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>
          <p style="color: var(--gray-500); margin: 8px 0;">ê³µê¸‰ì‚¬ ë©”ë‰´ì—ì„œ ìƒí’ˆì„ ë“±ë¡í•˜ê±°ë‚˜, ì—¬ê¸°ì„œ ì§ì ‘ ì¶”ê°€í•˜ì„¸ìš”.</p>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="openProductDBModal()">+ ì²« ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ìƒí’ˆëª…</th>
                <th style="text-align: right;">ì •ê°€(V+)</th>
                <th style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                <th style="text-align: right;">ê³µê¸‰ê°€(V+)</th>
                <th style="text-align: right;">ìˆ˜ìˆ˜ë£Œìœ¨</th>
                <th>ê³µêµ¬ ì—°ê²°</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${products.map(p => {
                const supplier = state.suppliers.find(s => s.id === p.supplierId);
                const isInhouse = p.supplierType === 'inhouse';
                // ì´ ìƒí’ˆì´ ì—°ê²°ëœ ê³µêµ¬ ìˆ˜ (selectedProductsê°€ ê°ì²´ ë°°ì—´ ë˜ëŠ” ë¬¸ìì—´ ë°°ì—´)
                const linkedDeals = state.deals.filter(d => {
                  if (!d.selectedProducts) return false;
                  return d.selectedProducts.some(item => {
                    const pid = typeof item === 'string' ? item : item.productId;
                    return pid === p.id;
                  });
                }).length;
                
                return `
                  <tr>
                    <td>
                      <span style="font-weight: 600;">${p.brandName || supplier?.name || '-'}</span>
                    </td>
                    <td><strong>${p.productName || '-'}</strong></td>
                    <td style="text-align: right;">${Number(p.originalPrice || p.retailPrice || 0).toLocaleString()}ì›</td>
                    <td style="text-align: right;">${Number(p.salePrice || 0).toLocaleString()}ì›</td>
                    <td style="text-align: right;">${Number(p.supplyPrice || 0) > 0 ? Number(p.supplyPrice).toLocaleString() + 'ì›' : '-'}</td>
                    <td style="text-align: right;">${p.commission ? p.commission + '%' : '-'}</td>
                    <td>
                      ${linkedDeals > 0 ? `<span class="status-badge status-negotiating">${linkedDeals}ê±´</span>` : '<span style="color: var(--gray-400);">-</span>'}
                    </td>
                    <td class="actions">
                      <button class="btn btn-secondary btn-sm" onclick="openProductDBModal('${p.id}')">ìˆ˜ì •</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

// ê³µê¸‰ì‚¬ ìƒí’ˆ DB ëª¨ë‹¬
function openProductDBModal(productId = null) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  const isEdit = productId !== null;
  const p = isEdit ? state.supplierProducts.find(prod => prod.id === productId) : {
    supplierId: '', brandName: '', productName: '', supplierType: 'external',
    retailPrice: '', salePrice: '', supplyPrice: '', marginFee: ''
  };
  
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ìƒí’ˆ ìˆ˜ì •' : 'ìƒˆ ìƒí’ˆ ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <form onsubmit="submitProductDBForm(event, '${productId || ''}')">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ê³µê¸‰ì‚¬ ì„ íƒ *</label>
            <select class="form-select" id="pdb-supplier" required onchange="updateProductDBSupplierInfo()">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${state.suppliers.map(s => `<option value="${s.id}" data-type="${s.supplierType || 'external'}" ${p.supplierId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ìœ í˜•</label>
            <select class="form-select" id="pdb-type" disabled style="background: var(--gray-100);">
              <option value="external" ${p.supplierType !== 'inhouse' ? 'selected' : ''}>íƒ€ì‚¬ (ê³µê¸‰ë‹¨ê°€ ë°©ì‹)</option>
              <option value="inhouse" ${p.supplierType === 'inhouse' ? 'selected' : ''}>ìì‚¬ (ë§ˆì§„ ë°©ì‹)</option>
            </select>
            <small style="color: var(--gray-500); font-size: 11px;">ê³µê¸‰ì‚¬ ì„ íƒ ì‹œ ìë™ ì„¤ì •</small>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ìƒí’ˆëª… *</label>
          <input type="text" class="form-input" id="pdb-name" value="${p.productName || ''}" required placeholder="ì˜ˆ: ìŠ¤í‚¨ì¼€ì–´ ì„¸íŠ¸">
        </div>
        
        <div class="form-group">
          <label class="form-label">ì •ê°€ (V+, ì›)</label>
          <input type="number" class="form-input" id="pdb-original" value="${p.originalPrice || p.retailPrice || ''}" placeholder="ì†Œë¹„ì ì •ê°€">
        </div>
        
        <div class="form-group">
          <label class="form-label">ê³µêµ¬ íŒë§¤ê°€ (V+, ì›) *</label>
          <input type="number" class="form-input" id="pdb-sale" value="${p.salePrice || ''}" required placeholder="ê³µë™êµ¬ë§¤ íŒë§¤ê°€" oninput="calcProductDBCommission()">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ê³µê¸‰ë‹¨ê°€ (V+, ì›)</label>
            <input type="number" class="form-input" id="pdb-supply" value="${p.supplyPrice || ''}" placeholder="VAT í¬í•¨ ê³µê¸‰ê°€" oninput="calcProductDBCommission()">
            <small style="color: var(--gray-500); font-size: 11px;">ìˆ˜ìˆ˜ë£Œì™€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥</small>
          </div>
          <div class="form-group">
            <label class="form-label">ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
            <input type="number" class="form-input" id="pdb-commission" value="${p.commission || ''}" step="0.1" placeholder="ìˆ˜ìˆ˜ë£Œ" oninput="calcProductDBSupply()">
            <small style="color: var(--gray-500); font-size: 11px;">ê³µê¸‰ë‹¨ê°€ì™€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥</small>
          </div>
        </div>
        
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteProductDB('${productId}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
}

// ê³µê¸‰ë‹¨ê°€ â†’ ìˆ˜ìˆ˜ë£Œ ìë™ê³„ì‚°
function calcProductDBCommission() {
  const supply = Number(document.getElementById('pdb-supply').value);
  const sale = Number(document.getElementById('pdb-sale').value);
  if (supply && sale && sale > 0) {
    const commission = ((sale - supply) / sale * 100).toFixed(1);
    document.getElementById('pdb-commission').value = commission;
  }
}

// ìˆ˜ìˆ˜ë£Œ â†’ ê³µê¸‰ë‹¨ê°€ ìë™ê³„ì‚°
function calcProductDBSupply() {
  const commission = Number(document.getElementById('pdb-commission').value);
  const sale = Number(document.getElementById('pdb-sale').value);
  if (commission && sale && sale > 0) {
    const supply = Math.round(sale * (1 - commission / 100));
    document.getElementById('pdb-supply').value = supply;
  }
}

function updateProductDBSupplierInfo() {
  const select = document.getElementById('pdb-supplier');
  const option = select.options[select.selectedIndex];
  if (option && option.dataset.type) {
    document.getElementById('pdb-type').value = option.dataset.type === 'inhouse' ? 'inhouse' : 'external';
  }
}

async function submitProductDBForm(e, id) {
  e.preventDefault();
  
  const supplierId = document.getElementById('pdb-supplier').value;
  const supplier = state.suppliers.find(s => s.id === supplierId);
  
  const data = {
    supplierId: supplierId,
    brandName: supplier?.name || '',
    supplierType: document.getElementById('pdb-type').value,
    productName: document.getElementById('pdb-name').value,
    originalPrice: Number(document.getElementById('pdb-original').value) || 0,
    salePrice: Number(document.getElementById('pdb-sale').value) || 0,
    supplyPrice: Number(document.getElementById('pdb-supply').value) || 0,
    commission: Number(document.getElementById('pdb-commission').value) || 0,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (id) {
      await db.collection('supplierProducts').doc(id).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('supplierProducts').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

async function deleteProductDB(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ìƒí’ˆê³¼ ì—°ê²°ëœ ê³µêµ¬ ë°ì´í„°ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
  try {
    await db.collection('supplierProducts').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ========== ê³µêµ¬ ì§„í–‰ ê´€ë¦¬ ë Œë”ë§ ==========
function renderDealManagement() {
  const app = document.getElementById('app');
  
  // D-Day ê³„ì‚° í•¨ìˆ˜ (Xì¼ ì¤‘ Yì¼ì°¨ í˜•ì‹)
  const calcDday = (startDate, endDate) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(0, 0, 0, 0);
    
    // ì´ ì¼ìˆ˜ ê³„ì‚° (ì‹œì‘ì¼~ì¢…ë£Œì¼ í¬í•¨)
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    
    if (today < start) {
      const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
      return { text: `D-${diff}`, color: 'var(--info)', status: 'upcoming' };
    } else if (today >= start && today <= end) {
      // í˜„ì¬ ëª‡ ì¼ì°¨ì¸ì§€ ê³„ì‚°
      const currentDay = Math.ceil((today - start) / (1000 * 60 * 60 * 24)) + 1;
      return { text: `${totalDays}ì¼ ì¤‘ ${currentDay}ì¼ì°¨`, color: 'var(--danger)', status: 'ongoing' };
    } else {
      return { text: 'ì¢…ë£Œ', color: 'var(--gray-400)', status: 'ended' };
    }
  };
  
  // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ íŒë‹¨
  const isOngoingDeal = (deal) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = new Date(deal.startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(deal.endDate);
    end.setHours(0, 0, 0, 0);
    return today >= start && today <= end;
  };
  
  const isUpcomingDeal = (deal) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = new Date(deal.startDate);
    start.setHours(0, 0, 0, 0);
    return today < start;
  };
  
  // í˜‘ì˜ì¤‘ ê³µêµ¬
  const negotiatingDeals = state.deals.filter(d => d.status === 'negotiating')
    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
  
  // ì „ì²´ í™œì„± ê³µêµ¬ (í˜‘ì˜ì¤‘ ì œì™¸í•œ ëª¨ë“  ê³µêµ¬)
  const activeDeals = state.deals.filter(d => d.status !== 'negotiating');
  
  // ì§„í–‰ì¤‘ (ì‹œì‘ì¼ <= ì˜¤ëŠ˜ <= ì¢…ë£Œì¼)
  const ongoingDeals = activeDeals.filter(d => isOngoingDeal(d))
    .sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
  
  // ì§„í–‰ ì˜ˆì • (ì˜¤ëŠ˜ < ì‹œì‘ì¼)
  const upcomingDeals = activeDeals.filter(d => isUpcomingDeal(d))
    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
  
  // ì™„ë£Œëœ ê³µêµ¬ (ì˜¤ëŠ˜ > ì¢…ë£Œì¼) - ë‚ ì§œ ê¸°ë°˜
  const completedDeals = activeDeals.filter(d => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const end = new Date(d.endDate);
    end.setHours(0, 0, 0, 0);
    return today > end;
  }).sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
  
  // í…Œì´ë¸” í–‰ ìƒì„± í•¨ìˆ˜
  const renderDealRow = (deal, isOngoing) => {
    const supplier = state.suppliers.find(s => s.id === deal.supplierId);
    const seller = state.sellers.find(s => s.id === deal.sellerId);
    // selectedProductsê°€ ê°ì²´ ë°°ì—´ì¸ì§€ ë¬¸ìì—´ ë°°ì—´ì¸ì§€ í™•ì¸
    const selectedProductsData = deal.selectedProducts || [];
    const products = selectedProductsData.map(item => {
      const pid = typeof item === 'string' ? item : item.productId;
      return state.supplierProducts.find(p => p.id === pid);
    }).filter(Boolean);
    const statusInfo = getDisplayStatus(deal);
    const dday = deal.startDate && deal.endDate ? calcDday(deal.startDate, deal.endDate) : { text: '-', color: 'var(--gray-400)', status: 'none' };
    
    // ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ (ê³µêµ¬ ëª¨ë‹¬ê³¼ ì—°ë™)
    const journeySample = deal.journeySample === true;
    const journeyPaymentLink = deal.journeyPaymentLink === true;
    const journeyContent = deal.journeyContent === true;
    
    return `
      <tr>
        <td style="text-align:center;">
          <span style="display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700;background:${dday.status === 'ongoing' ? 'var(--danger-light)' : dday.status === 'completed' ? 'var(--gray-100)' : 'var(--info-light)'};color:${dday.color};white-space:nowrap;">
            ${dday.text}
          </span>
        </td>
        <td>
          <strong>${deal.title}</strong>
          <div style="font-size:11px;color:var(--gray-500);margin-top:2px;">${deal.startDate || '-'} ~ ${deal.endDate || '-'}</div>
        </td>
        <td>${supplier?.name || '-'}</td>
        <td>${seller?.name || '-'}</td>
        <td style="text-align:center;">
          <span style="color:${journeySample ? 'var(--success)' : 'var(--gray-300)'};">
            ${journeySample ? 'âœ“' : '-'}
          </span>
        </td>
        <td style="text-align:center;">
          <span style="color:${journeyPaymentLink ? 'var(--success)' : 'var(--gray-300)'};">
            ${journeyPaymentLink ? 'âœ“' : '-'}
          </span>
        </td>
        <td style="text-align:center;">
          <span style="color:${journeyContent ? 'var(--success)' : 'var(--gray-300)'};">
            ${journeyContent ? 'âœ“' : '-'}
          </span>
        </td>
        <td style="text-align:center;"><span class="status-badge ${statusInfo.class}">${statusInfo.label}</span></td>
        <td style="text-align:center;">
          <button type="button" class="btn btn-secondary btn-sm" style="padding:6px 12px;font-size:12px;cursor:pointer;position:relative;z-index:10;" onclick="event.stopPropagation();openDealProgressModal('${deal.id}')">ìƒì„¸</button>
        </td>
      </tr>
    `;
  };
  
  // í…Œì´ë¸” í—¤ë” ê³µí†µ
  const tableHeader = `
    <thead>
      <tr>
        <th style="width:110px;text-align:center;white-space:nowrap;">D-Day</th>
        <th>ê³µêµ¬ëª…</th>
        <th>ê³µê¸‰ì‚¬</th>
        <th>ì…€ëŸ¬</th>
        <th style="text-align:center;">ìƒ˜í”Œ</th>
        <th style="text-align:center;">ê²°ì œë§í¬</th>
        <th style="text-align:center;">ì»¨í…ì¸ </th>
        <th style="text-align:center;">ìƒíƒœ</th>
        <th style="text-align:center;">ê´€ë¦¬</th>
      </tr>
    </thead>
  `;
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ì§„í–‰ ì¤‘ ê³µêµ¬ê´€ë¦¬</h1>
      <p class="page-desc">ê³µêµ¬ë³„ ìƒ˜í”Œì „ë‹¬, ê²°ì œë§í¬ì „ë‹¬, ì»¨í…ì¸ ì „ë‹¬ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. (íŒŒíŠ¸ë„ˆ í˜ì´ì§€ì— ì—°ë™)</p>
    </div>
    
    <!-- í˜‘ì˜ì¤‘ ê³µêµ¬ (ë‹«íŒ ìƒíƒœ) -->
    <div class="card" style="margin-bottom: 24px;">
      <h3 class="card-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleDealSection('negotiating')">
        <span>â³ í˜‘ì˜ì¤‘ (${negotiatingDeals.length}ê±´)</span>
        <span id="negotiating-arrow" style="font-size: 12px; transition: transform 0.2s;">â–¼</span>
      </h3>
      <div id="negotiating-section" style="display: none;">
        ${negotiatingDeals.length === 0 ? `
          <div style="padding: 24px; text-align: center; color: var(--gray-500);">í˜‘ì˜ì¤‘ì¸ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        ` : `
          <div style="overflow-x: auto;">
            <table class="data-table">
              ${tableHeader}
              <tbody>
                ${negotiatingDeals.map(deal => renderDealRow(deal, false)).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
    
    <!-- ì§„í–‰ì¤‘ ê³µêµ¬ (ì—´ë¦° ìƒíƒœ) -->
    <div class="card" style="margin-bottom: 24px;">
      <h3 class="card-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleDealSection('ongoing')">
        <span>ğŸ”¥ ì§„í–‰ì¤‘ (${ongoingDeals.length}ê±´)</span>
        <span id="ongoing-arrow" style="font-size: 12px; transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
      </h3>
      <div id="ongoing-section" style="display: block;">
        ${ongoingDeals.length === 0 ? `
          <div style="padding: 24px; text-align: center; color: var(--gray-500);">í˜„ì¬ ì§„í–‰ì¤‘ì¸ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        ` : `
          <div style="overflow-x: auto;">
            <table class="data-table">
              ${tableHeader}
              <tbody>
                ${ongoingDeals.map(deal => renderDealRow(deal, true)).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
    
    <!-- ì§„í–‰ ì˜ˆì • ê³µêµ¬ (ì—´ë¦° ìƒíƒœ) -->
    <div class="card" style="margin-bottom: 24px;">
      <h3 class="card-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleDealSection('upcoming')">
        <span>ğŸ“… ì§„í–‰ ì˜ˆì • (${upcomingDeals.length}ê±´)</span>
        <span id="upcoming-arrow" style="font-size: 12px; transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
      </h3>
      <div id="upcoming-section" style="display: block;">
        ${upcomingDeals.length === 0 ? `
          <div style="padding: 24px; text-align: center; color: var(--gray-500);">ì˜ˆì •ëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        ` : `
          <div style="overflow-x: auto;">
            <table class="data-table">
              ${tableHeader}
              <tbody>
                ${upcomingDeals.map(deal => renderDealRow(deal, true)).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
    
    <div style="margin-bottom: 24px; padding: 12px 16px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
      ğŸ’¡ í–‰ì„ í´ë¦­í•˜ê±°ë‚˜ ìƒì„¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒ˜í”Œì „ë‹¬, ê²°ì œë§í¬ì „ë‹¬, ì»¨í…ì¸ ì „ë‹¬ì„ ê´€ë¦¬í•˜ì„¸ìš”.
    </div>
    
    <!-- ì™„ë£Œëœ ê³µêµ¬ (ì—´ë¦° ìƒíƒœ) -->
    <div class="card">
      <h3 class="card-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleDealSection('completed')">
        <span>âœ… ì™„ë£Œëœ ê³µêµ¬ (${completedDeals.length}ê±´)</span>
        <span id="completed-arrow" style="font-size: 12px; transition: transform 0.2s; transform: rotate(180deg);">â–¼</span>
      </h3>
      <div id="completed-section" style="display: block;">
        ${completedDeals.length === 0 ? `
          <div style="padding: 24px; text-align: center; color: var(--gray-500);">ì™„ë£Œëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        ` : `
          <div style="overflow-x: auto;">
            <table class="data-table">
              ${tableHeader}
              <tbody>
                ${completedDeals.map(deal => renderDealRow(deal, false)).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
  `;
}

// ê³µêµ¬ ì„¹ì…˜ í† ê¸€
function toggleDealSection(sectionId) {
  const section = document.getElementById(sectionId + '-section');
  const arrow = document.getElementById(sectionId + '-arrow');
  
  if (section) {
    const isHidden = section.style.display === 'none';
    section.style.display = isHidden ? 'block' : 'none';
    arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

// ìƒ˜í”Œ ì „ë‹¬ ìƒíƒœ í† ê¸€
async function toggleSampleDelivery(dealId, productId, isChecked) {
  try {
    const deal = state.deals.find(d => d.id === dealId);
    const sampleDelivery = deal.sampleDelivery || {};
    sampleDelivery[productId] = isChecked;
    
    await db.collection('deals').doc(dealId).update({ sampleDelivery });
    showToast(isChecked ? 'ìƒ˜í”Œ ì „ë‹¬ ì™„ë£Œ!' : 'ìƒ˜í”Œ ì „ë‹¬ ì·¨ì†Œ');
  } catch(e) {
    console.error(e);
    showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
  }
}

// í˜‘ì˜ì‚¬í•­ ê´€ë¦¬ ëª¨ë‹¬
function openDealNegotiationModal(dealId) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;
  
  const supplier = state.suppliers.find(s => s.id === deal.supplierId);
  const seller = state.sellers.find(s => s.id === deal.sellerId);
  const negotiation = deal.negotiation || {};
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“ í˜‘ì˜ì‚¬í•­ ê´€ë¦¬</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">${deal.title}</div>
        <div style="display: flex; gap: 16px; font-size: 13px; color: var(--gray-500);">
          <span>ğŸ­ ${supplier?.name || '-'}</span>
          <span>ğŸ‘¤ ${seller?.name || '-'}</span>
          <span>ğŸ“… ${deal.startDate} ~ ${deal.endDate}</span>
        </div>
      </div>
      
      <form onsubmit="submitNegotiationForm(event, '${dealId}')">
        <div class="form-group">
          <label class="form-label">ğŸ’° ìˆ˜ìˆ˜ë£Œ í˜‘ì˜</label>
          <textarea class="form-textarea" id="nego-commission" rows="3" placeholder="ì˜ˆ: íŒë§¤ ìˆ˜ìˆ˜ë£Œ 15%, 1000ê°œ ì´ìƒ ì‹œ ì¶”ê°€ 3% ì¸ì„¼í‹°ë¸Œ">${negotiation.commission || ''}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">ğŸ ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜</label>
          <textarea class="form-textarea" id="nego-event" rows="3" placeholder="ì˜ˆ: êµ¬ë§¤ì ëŒ€ìƒ ì‚¬ì€í’ˆ ì¦ì •, ë¦¬ë·° ì´ë²¤íŠ¸ ì§„í–‰">${negotiation.event || ''}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">ğŸ¯ ì„œë¹„ìŠ¤ ì§€ì› í˜œíƒ</label>
          <textarea class="form-textarea" id="nego-support" rows="3" placeholder="ì˜ˆ: ìƒì„¸í˜ì´ì§€ ì œì‘ ì§€ì›, ê´‘ê³ ë¹„ 50% ì§€ì›">${negotiation.support || ''}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">ğŸ“‹ ê¸°íƒ€ í˜‘ì˜ì‚¬í•­</label>
          <textarea class="form-textarea" id="nego-etc" rows="3" placeholder="ì¶”ê°€ í˜‘ì˜ ë‚´ìš©">${negotiation.etc || ''}</textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
        </div>
      </form>
    </div>
  `;
}

async function submitNegotiationForm(e, dealId) {
  e.preventDefault();
  
  const negotiation = {
    commission: document.getElementById('nego-commission').value,
    event: document.getElementById('nego-event').value,
    support: document.getElementById('nego-support').value,
    etc: document.getElementById('nego-etc').value,
    updatedAt: new Date().toISOString()
  };
  
  try {
    await db.collection('deals').doc(dealId).update({ negotiation });
    showToast('í˜‘ì˜ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ê³µêµ¬ ì§„í–‰ ìƒì„¸ ëª¨ë‹¬
function openDealProgressModal(dealId) {
  const deal = state.deals.find(d => d.id === dealId);
  if (!deal) return;
  
  const modalEl = document.getElementById('modal');
  const supplier = state.suppliers.find(s => s.id === deal.supplierId);
  const seller = state.sellers.find(s => s.id === deal.sellerId);
  
  // selectedProductsê°€ ê°ì²´ ë°°ì—´ì¸ì§€ ë¬¸ìì—´ ë°°ì—´ì¸ì§€ í™•ì¸
  const selectedProductsData = deal.selectedProducts || [];
  const products = selectedProductsData.map(item => {
    const pid = typeof item === 'string' ? item : item.productId;
    const product = state.supplierProducts.find(p => p.id === pid);
    if (product) {
      return {
        ...product,
        marginRate: typeof item === 'object' ? item.marginRate : 0
      };
    }
    return null;
  }).filter(Boolean);
  
  const negotiation = deal.negotiation || {};
  const statusInfo = getDisplayStatus(deal);
  
  // ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ
  const journeySample = deal.journeySample === true;
  const journeyPaymentLink = deal.journeyPaymentLink === true;
  const journeyContent = deal.journeyContent === true;
  const journeyCompleted = [journeySample, journeyPaymentLink, journeyContent].filter(Boolean).length;
  
  // D-Day ê³„ì‚° (Xì¼ ì¤‘ Yì¼ì°¨ í˜•ì‹)
  const calcDday = (startDate, endDate) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(0, 0, 0, 0);
    
    // ì´ ì¼ìˆ˜ ê³„ì‚° (ì‹œì‘ì¼~ì¢…ë£Œì¼ í¬í•¨)
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    
    if (today < start) {
      const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
      return { text: `D-${diff}`, isOngoing: false };
    } else if (today >= start && today <= end) {
      // í˜„ì¬ ëª‡ ì¼ì°¨ì¸ì§€ ê³„ì‚°
      const currentDay = Math.ceil((today - start) / (1000 * 60 * 60 * 24)) + 1;
      return { text: `${totalDays}ì¼ ì¤‘ ${currentDay}ì¼ì°¨`, isOngoing: true };
    } else {
      return { text: 'ì¢…ë£Œ', isOngoing: false };
    }
  };
  const dday = calcDday(deal.startDate, deal.endDate);
  
  modalEl.innerHTML = `
    <div class="modal-content" style="max-width: 700px; max-height: 95vh; overflow-y: auto;">
      <div class="modal-header">
        <div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <h3 style="margin: 0;">${deal.title}</h3>
            <span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; background: ${dday.isOngoing ? 'var(--danger-light)' : 'var(--info-light)'}; color: ${dday.isOngoing ? 'var(--danger)' : 'var(--info)'};">${dday.text}</span>
            <span class="status-badge ${statusInfo.class}">${statusInfo.label}</span>
          </div>
          <div style="font-size: 13px; color: var(--gray-500); margin-top: 4px;">${deal.startDate} ~ ${deal.endDate}</div>
        </div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
          <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
            <div style="font-size: 11px; color: var(--gray-500);">ğŸ­ ê³µê¸‰ì‚¬</div>
            <div style="font-weight: 600; margin-top: 4px;">${supplier?.name || '-'}</div>
          </div>
          <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
            <div style="font-size: 11px; color: var(--gray-500);">ğŸ‘¤ ì…€ëŸ¬</div>
            <div style="font-weight: 600; margin-top: 4px;">${seller?.name || '-'}</div>
          </div>
        </div>
        
        <!-- 1. ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        <div style="margin-bottom: 20px; border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
          <div style="background: var(--primary-light); padding: 12px 16px; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“‹ ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
            <span style="font-size: 12px; color: var(--gray-500);">${journeyCompleted}/3 ì™„ë£Œ</span>
          </div>
          <div style="padding: 16px;">
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: ${journeySample ? 'var(--success-light)' : 'var(--gray-50)'}; border-radius: 10px; cursor: pointer; border: 1px solid ${journeySample ? 'var(--success)' : 'var(--gray-200)'};">
                <input type="checkbox" id="modal-journey-sample" ${journeySample ? 'checked' : ''} onchange="toggleJourneyItem('${deal.id}', 'journeySample', this.checked)" style="width: 20px; height: 20px;">
                <div>
                  <div style="font-weight: 600; color: ${journeySample ? 'var(--success)' : 'var(--gray-700)'};">ğŸ“¦ ìƒ˜í”Œì „ë‹¬</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ê³µê¸‰ì‚¬ë¡œë¶€í„° ìƒ˜í”Œì„ ì „ë‹¬ë°›ìŒ</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: ${journeyPaymentLink ? 'var(--success-light)' : 'var(--gray-50)'}; border-radius: 10px; cursor: pointer; border: 1px solid ${journeyPaymentLink ? 'var(--success)' : 'var(--gray-200)'};">
                <input type="checkbox" id="modal-journey-payment" ${journeyPaymentLink ? 'checked' : ''} onchange="toggleJourneyItem('${deal.id}', 'journeyPaymentLink', this.checked)" style="width: 20px; height: 20px;">
                <div>
                  <div style="font-weight: 600; color: ${journeyPaymentLink ? 'var(--success)' : 'var(--gray-700)'};">ğŸ’³ ê²°ì œë§í¬ì „ë‹¬</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ì…€ëŸ¬ì—ê²Œ ê²°ì œ ë§í¬ ì „ë‹¬ ì™„ë£Œ</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: ${journeyContent ? 'var(--success-light)' : 'var(--gray-50)'}; border-radius: 10px; cursor: pointer; border: 1px solid ${journeyContent ? 'var(--success)' : 'var(--gray-200)'};">
                <input type="checkbox" id="modal-journey-content" ${journeyContent ? 'checked' : ''} onchange="toggleJourneyItem('${deal.id}', 'journeyContent', this.checked)" style="width: 20px; height: 20px;">
                <div>
                  <div style="font-weight: 600; color: ${journeyContent ? 'var(--success)' : 'var(--gray-700)'};">ğŸ¬ ì»¨í…ì¸ ì „ë‹¬</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ìƒí’ˆ ì‚¬ì§„, ìƒì„¸í˜ì´ì§€ ì´ë¯¸ì§€ ë“± ì „ë‹¬</div>
                </div>
              </label>
            </div>
          </div>
        </div>
        
        <!-- 2. ìƒí’ˆë³„ ë§ˆì§„ìœ¨ -->
        ${products.length > 0 ? `
          <div style="margin-bottom: 20px; border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
            <div style="background: var(--gray-50); padding: 12px 16px; font-weight: 600;">
              <span>ğŸ“¦ ìƒí’ˆë³„ ë§ˆì§„ìœ¨</span>
            </div>
            <div style="padding: 0;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                  <tr style="background: var(--gray-100);">
                    <th style="padding: 10px 16px; text-align: left; font-weight: 600;">ìƒí’ˆëª…</th>
                    <th style="padding: 10px 16px; text-align: center; width: 100px; font-weight: 600;">ë§ˆì§„ìœ¨</th>
                  </tr>
                </thead>
                <tbody>
                  ${products.map(p => `
                    <tr style="border-top: 1px solid var(--gray-200);">
                      <td style="padding: 10px 16px;">${p.productName}</td>
                      <td style="padding: 10px 16px; text-align: center; font-weight: 600; color: var(--primary);">${p.marginRate || 0}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : ''}
        
        <!-- 3. í˜‘ì˜ì‚¬í•­ -->
        <div style="border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
          <div style="background: var(--gray-50); padding: 12px 16px; font-weight: 600;">
            <span>ğŸ“ í˜‘ì˜ì‚¬í•­</span>
          </div>
          <div style="padding: 16px;">
            <div style="display: grid; gap: 12px; font-size: 13px;">
              <div>
                <label style="font-size: 11px; color: var(--gray-500); display: block; margin-bottom: 4px;">ğŸ ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜</label>
                <input type="text" id="nego-event-input" class="form-input" value="${negotiation.event || ''}" placeholder="ì˜ˆ: êµ¬ë§¤ì ì‚¬ì€í’ˆ ì¦ì •">
              </div>
              <div>
                <label style="font-size: 11px; color: var(--gray-500); display: block; margin-bottom: 4px;">ğŸ¯ ì„œë¹„ìŠ¤ ì§€ì›</label>
                <input type="text" id="nego-support-input" class="form-input" value="${negotiation.support || ''}" placeholder="ì˜ˆ: ìƒì„¸í˜ì´ì§€ ì œì‘ ì§€ì›">
              </div>
              <div>
                <label style="font-size: 11px; color: var(--gray-500); display: block; margin-bottom: 4px;">ğŸ“‹ ê¸°íƒ€</label>
                <input type="text" id="nego-etc-input" class="form-input" value="${negotiation.etc || ''}" placeholder="ê¸°íƒ€ í˜‘ì˜ ë‚´ìš©">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button class="btn btn-secondary" onclick="closeModal(); openDealModal(state.deals.find(d=>d.id==='${deal.id}'))">ê³µêµ¬ ìˆ˜ì •</button>
        <button class="btn btn-primary" onclick="saveDealProgress('${deal.id}')">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  `;
  
  modalEl.className = 'modal show';
}

// ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ í† ê¸€
async function toggleJourneyItem(dealId, field, checked) {
  try {
    const updateData = { 
      [field]: checked,
      updatedAt: new Date().toISOString()
    };
    
    await db.collection('deals').doc(dealId).update(updateData);
    
    // ë¡œì»¬ ìƒíƒœë„ ì—…ë°ì´íŠ¸
    const deal = state.deals.find(d => d.id === dealId);
    if (deal) {
      deal[field] = checked;
    }
    
    const labels = {
      journeySample: 'ìƒ˜í”Œì „ë‹¬',
      journeyPaymentLink: 'ê²°ì œë§í¬ì „ë‹¬',
      journeyContent: 'ì»¨í…ì¸ ì „ë‹¬'
    };
    showToast(checked ? `${labels[field]} ì™„ë£Œ!` : `${labels[field]} ì·¨ì†Œ`);
    
    // ëª¨ë‹¬ ë‹¤ì‹œ ë Œë”ë§
    openDealProgressModal(dealId);
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì»¨í…ì¸  ì „ë‹¬ í† ê¸€ (ê¸°ì¡´ í˜¸í™˜ìš©)
async function toggleContentDelivered(dealId, delivered) {
  await toggleJourneyItem(dealId, 'journeyContent', delivered);
}

// ê³µêµ¬ ì§„í–‰ ì •ë³´ ì €ì¥ (í˜‘ì˜ì‚¬í•­)
async function saveDealProgress(dealId) {
  const negotiation = {
    event: document.getElementById('nego-event-input').value,
    support: document.getElementById('nego-support-input').value,
    etc: document.getElementById('nego-etc-input').value,
    updatedAt: new Date().toISOString()
  };
  
  try {
    await db.collection('deals').doc(dealId).update({ 
      negotiation,
      updatedAt: new Date().toISOString()
    });
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ========== ê³µìœ  ë§í¬ ê´€ë¦¬ ==========
function renderShareLinks() {
  const app = document.getElementById('app');
  
  // íŒŒíŠ¸ë„ˆ í¬í„¸ ë¡œê·¸ì¸ í˜ì´ì§€ URL (ê³ ì •)
  const loginUrl = 'https://partner-moyeoradeal.kr/login/';
  // ê³µìœ  í˜ì´ì§€ ê¸°ë³¸ URL (ê°™ì€ í´ë”ì— ìˆë‹¤ê³  ê°€ì •)
  const baseUrl = window.location.href.replace(/[^/]*$/, '') + 'moyeora-calendar-public.html';
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ”‘ íŒŒíŠ¸ë„ˆ ê³„ì •ê´€ë¦¬</h1>
      <p class="page-desc">ê³µê¸‰ì‚¬ ë° ì…€ëŸ¬ì˜ ë¡œê·¸ì¸ ê³„ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>
    
    <!-- ğŸ” ë¡œê·¸ì¸ í˜ì´ì§€ (ë©”ì¸) -->
    <div class="card" style="margin-bottom: 24px; border: 2px solid var(--primary);">
      <h3 class="card-title">ğŸ” íŒŒíŠ¸ë„ˆ ë¡œê·¸ì¸ í˜ì´ì§€</h3>
      <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">ê³µê¸‰ì‚¬/ì…€ëŸ¬ì—ê²Œ ì´ ë§í¬ë¥¼ ê³µìœ í•˜ì„¸ìš”. ID/PWë¡œ ë¡œê·¸ì¸í•˜ë©´ ê°ìì˜ ì¼ì •í‘œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div style="display: flex; gap: 12px; align-items: center; padding: 16px; background: var(--primary-light); border-radius: 12px;">
        <input type="text" class="form-input" value="${loginUrl}" readonly style="flex: 1; background: white; font-weight: 600;">
        <button class="btn btn-primary" onclick="copyShareLink('${loginUrl}')">ğŸ“‹ ë³µì‚¬</button>
        <a href="${loginUrl}" target="_blank" class="btn btn-secondary">ğŸ”— ì—´ê¸°</a>
      </div>
    </div>
    
    <!-- ì•ˆë‚´ ì¹´ë“œ -->
    <div class="card" style="margin-bottom: 24px;">
      <div style="padding: 16px; background: var(--info-light); border-radius: 12px; color: var(--info);">
        <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•</strong>
        <ol style="margin: 8px 0 0 20px; font-size: 14px;">
          <li>ì•„ë˜ì—ì„œ ê³µê¸‰ì‚¬/ì…€ëŸ¬ì—ê²Œ <strong>ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸</strong>ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</li>
          <li>ìœ„ <strong>ë¡œê·¸ì¸ í˜ì´ì§€ ë§í¬</strong>ë¥¼ ê³µê¸‰ì‚¬/ì…€ëŸ¬ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.</li>
          <li>ê³µê¸‰ì‚¬/ì…€ëŸ¬ê°€ ë¡œê·¸ì¸í•˜ë©´ ë³¸ì¸ ê´€ë ¨ ê³µêµ¬ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ol>
      </div>
    </div>
    
    <!-- ê³µê¸‰ì‚¬ë³„ ê³„ì • -->
    <div class="card" style="margin-bottom: 24px;">
      <h3 class="card-title">ğŸ­ ê³µê¸‰ì‚¬ ê³„ì • ê´€ë¦¬</h3>
      <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">ê³µê¸‰ì‚¬ë³„ ë¡œê·¸ì¸ ì •ë³´ì…ë‹ˆë‹¤. ìˆ˜ì •ì€ ê³µê¸‰ì‚¬ ê´€ë¦¬ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      
      ${state.suppliers.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          ë“±ë¡ëœ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      ` : `
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬ëª…</th>
                <th>ì•„ì´ë””</th>
                <th>ë¹„ë°€ë²ˆí˜¸</th>
                <th>ì§„í–‰ ê³µêµ¬</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${state.suppliers.map(s => {
                const dealCount = state.deals.filter(d => d.supplierId === s.id).length;
                return `
                  <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.loginId ? `<code style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">${s.loginId}</code>` : '<span style="color: var(--gray-400);">ë¯¸ì„¤ì •</span>'}</td>
                    <td>${s.loginPw ? `<code style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">${s.loginPw}</code>` : '<span style="color: var(--gray-400);">ë¯¸ì„¤ì •</span>'}</td>
                    <td><span class="status-badge status-ongoing">${dealCount}ê±´</span></td>
                    <td>
                      <button class="btn btn-secondary btn-sm" onclick="openSupplierModal(state.suppliers.find(s=>s.id==='${s.id}'))">âœï¸ ìˆ˜ì •</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
    
    <!-- ì…€ëŸ¬ë³„ ê³„ì • -->
    <div class="card">
      <h3 class="card-title">ğŸ‘¤ ì…€ëŸ¬ ê³„ì • ê´€ë¦¬</h3>
      <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">ì…€ëŸ¬ë³„ ë¡œê·¸ì¸ ì •ë³´ì…ë‹ˆë‹¤. ìˆ˜ì •ì€ ì…€ëŸ¬ ê´€ë¦¬ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      
      ${state.sellers.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          ë“±ë¡ëœ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      ` : `
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ì…€ëŸ¬ëª…</th>
                <th>ì•„ì´ë””</th>
                <th>ë¹„ë°€ë²ˆí˜¸</th>
                <th>ì§„í–‰ ê³µêµ¬</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${state.sellers.map(s => {
                const dealCount = state.deals.filter(d => d.sellerId === s.id).length;
                return `
                  <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.loginId ? `<code style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">${s.loginId}</code>` : '<span style="color: var(--gray-400);">ë¯¸ì„¤ì •</span>'}</td>
                    <td>${s.loginPw ? `<code style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">${s.loginPw}</code>` : '<span style="color: var(--gray-400);">ë¯¸ì„¤ì •</span>'}</td>
                    <td><span class="status-badge status-confirmed">${dealCount}ê±´</span></td>
                    <td>
                      <button class="btn btn-secondary btn-sm" onclick="openSellerModal(state.sellers.find(s=>s.id==='${s.id}'))">âœï¸ ìˆ˜ì •</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

// ê³µìœ  ë§í¬ ë³µì‚¬
function copyShareLink(url) {
  navigator.clipboard.writeText(url).then(() => {
    showToast('âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }).catch(() => {
    // êµ¬í˜• ë¸Œë¼ìš°ì € ëŒ€ì‘
    const input = document.createElement('input');
    input.value = url;
    document.body.appendChild(input);
    input.select();
    document.execCommand('copy');
    document.body.removeChild(input);
    showToast('âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });
}

// ì´ˆê¸°í™”
setupListeners();

// ì…€ëŸ¬ë³„ í˜œíƒ ëª¨ë‹¬
function openSellerBenefitsModal(sellerListId, editMode = false) {
  const seller = state.sellerList.find(s => s.id === sellerListId);
  if (!seller) return;
  
  const benefits = seller.benefits || { prelaunch: [], launch: [], support: [] };
  const hasSellerBenefits = (benefits.prelaunch && benefits.prelaunch.length > 0) ||
                            (benefits.launch && benefits.launch.length > 0) ||
                            (benefits.support && benefits.support.length > 0);
  
  // í˜œíƒì´ ìˆê³  í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ë³´ê¸° ëª¨ë“œë¡œ í‘œì‹œ
  if (hasSellerBenefits && !editMode) {
    openSellerBenefitsViewModal(sellerListId);
    return;
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ ì…€ëŸ¬ í˜œíƒ ì„¤ì •</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 16px; background: var(--gray-50); border-radius: 12px; margin-bottom: 20px;">
        <div style="font-size: 13px; color: var(--gray-500);">ì…€ëŸ¬</div>
        <div style="font-weight: 600; margin-top: 4px;">${seller.accountName}</div>
        ${seller.accountLink ? `<div style="font-size: 13px; color: var(--primary); margin-top: 2px;">${seller.accountLink}</div>` : ''}
      </div>
      
      <form onsubmit="submitSellerBenefits(event, '${sellerListId}')">
        <!-- ê³µêµ¬ì˜ˆê³  í˜œíƒ -->
        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
            <span style="background: var(--gray-700); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">1</span>
            ê³µêµ¬ì˜ˆê³  í˜œíƒ (ë¦´ìŠ¤)
          </label>
          <div id="seller-prelaunch-benefits">
            ${(benefits.prelaunch && benefits.prelaunch.length > 0) ? benefits.prelaunch.map((b, i) => `
              <div class="benefit-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="form-input" name="seller-prelaunch-name" value="${b.name || ''}" placeholder="ì´ë²¤íŠ¸ëª… (ì˜ˆ: ì‚¬ì „ì•Œë¦¼ ì´ë²¤íŠ¸)" style="flex: 2;">
                <input type="text" class="form-input" name="seller-prelaunch-count" value="${b.count || ''}" placeholder="ì¸ì›" style="flex: 0.5;">
                <input type="text" class="form-input" name="seller-prelaunch-reward" value="${b.reward || ''}" placeholder="í˜œíƒ (ì˜ˆ: ì ¤ë¦¬ 1ë°•ìŠ¤)" style="flex: 1.5;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
              </div>
            `).join('') : `
              <div class="benefit-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="form-input" name="seller-prelaunch-name" placeholder="ì´ë²¤íŠ¸ëª… (ì˜ˆ: ì‚¬ì „ì•Œë¦¼ ì´ë²¤íŠ¸)" style="flex: 2;">
                <input type="text" class="form-input" name="seller-prelaunch-count" placeholder="ì¸ì›" style="flex: 0.5;">
                <input type="text" class="form-input" name="seller-prelaunch-reward" placeholder="í˜œíƒ (ì˜ˆ: ì ¤ë¦¬ 1ë°•ìŠ¤)" style="flex: 1.5;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
              </div>
            `}
          </div>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addSellerBenefitRow('seller-prelaunch')">+ í•­ëª© ì¶”ê°€</button>
        </div>
        
        <!-- ê³µêµ¬ì˜¤í”ˆ í˜œíƒ -->
        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
            <span style="background: var(--gray-700); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">2</span>
            ê³µêµ¬ì˜¤í”ˆ í˜œíƒ (í”¼ë“œ)
          </label>
          <div id="seller-launch-benefits">
            ${(benefits.launch && benefits.launch.length > 0) ? benefits.launch.map((b, i) => `
              <div class="benefit-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="form-input" name="seller-launch-name" value="${b.name || ''}" placeholder="ì´ë²¤íŠ¸ëª… (ì˜ˆ: ì„ ì°©ìˆœ êµ¬ë§¤ ì´ë²¤íŠ¸)" style="flex: 2;">
                <input type="text" class="form-input" name="seller-launch-count" value="${b.count || ''}" placeholder="ì¸ì›" style="flex: 0.5;">
                <input type="text" class="form-input" name="seller-launch-reward" value="${b.reward || ''}" placeholder="í˜œíƒ (ì˜ˆ: ë„¤ì´ë²„í˜ì´ 1ë§Œì›)" style="flex: 1.5;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
              </div>
            `).join('') : `
              <div class="benefit-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="form-input" name="seller-launch-name" placeholder="ì´ë²¤íŠ¸ëª… (ì˜ˆ: ì„ ì°©ìˆœ êµ¬ë§¤ ì´ë²¤íŠ¸)" style="flex: 2;">
                <input type="text" class="form-input" name="seller-launch-count" placeholder="ì¸ì›" style="flex: 0.5;">
                <input type="text" class="form-input" name="seller-launch-reward" placeholder="í˜œíƒ (ì˜ˆ: ë„¤ì´ë²„í˜ì´ 1ë§Œì›)" style="flex: 1.5;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
              </div>
            `}
          </div>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addSellerBenefitRow('seller-launch')">+ í•­ëª© ì¶”ê°€</button>
        </div>
        
        <!-- ì¶”ê°€ ì§€ì› -->
        <div class="form-group">
          <label class="form-label">âœ¨ ì¶”ê°€ ì§€ì›</label>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-ad" ${benefits.support && benefits.support.includes('ad') ? 'checked' : ''}>
              <span>ì½˜í…ì¸  ê´‘ê³  ë¬´ìƒ ë“±ë¡</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-payment" ${benefits.support && benefits.support.includes('payment') ? 'checked' : ''}>
              <span>ì…€ëŸ¬ ì „ìš© ê²°ì œì°½ ì œê³µ</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-sample" ${benefits.support && benefits.support.includes('sample') ? 'checked' : ''}>
              <span>ìƒ˜í”Œ ë¬´ë£Œ ì œê³µ</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-feed" ${benefits.support && benefits.support.includes('feed') ? 'checked' : ''}>
              <span>í”¼ë“œ ì œì‘ ì§€ì›</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-shipping" ${benefits.support && benefits.support.includes('shipping') ? 'checked' : ''}>
              <span>ë¬´ë£Œ ë°°ì†¡ ì§€ì›</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" name="seller-support-commission" ${benefits.support && benefits.support.includes('commission') ? 'checked' : ''}>
              <span>ë†’ì€ íŒë§¤ ìˆ˜ìˆ˜ë£Œ</span>
            </label>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
        </div>
      </form>
    </div>
  `;
}

// ì…€ëŸ¬ í˜œíƒ ë³´ê¸° ëª¨ë‹¬ (ì˜ˆìœ ì¹´ë“œ í˜•íƒœ)
function openSellerBenefitsViewModal(sellerListId) {
  const seller = state.sellerList.find(s => s.id === sellerListId);
  if (!seller) return;
  
  const benefits = seller.benefits || { prelaunch: [], launch: [], support: [] };
  const supportLabels = {
    ad: { icon: 'ğŸ“¢', label: 'ì½˜í…ì¸  ê´‘ê³  ë¬´ìƒ ë“±ë¡' },
    payment: { icon: 'ğŸ’³', label: 'ì…€ëŸ¬ ì „ìš© ê²°ì œì°½ ì œê³µ' },
    sample: { icon: 'ğŸ', label: 'ìƒ˜í”Œ ë¬´ë£Œ ì œê³µ' },
    feed: { icon: 'ğŸ“¸', label: 'í”¼ë“œ ì œì‘ ì§€ì›' },
    shipping: { icon: 'ğŸšš', label: 'ë¬´ë£Œ ë°°ì†¡ ì§€ì›' },
    commission: { icon: 'ğŸ’°', label: 'ë†’ì€ íŒë§¤ ìˆ˜ìˆ˜ë£Œ' }
  };
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header" style="background: var(--gray-900); color: white; margin: -24px -24px 20px -24px; padding: 24px; border-radius: 20px 20px 0 0;">
        <div style="text-align: center; width: 100%;">
          <div style="background: rgba(255,255,255,0.2); display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 14px; margin-bottom: 12px;">
            ëª¨ì—¬ë¼ë”œ Ã— ì…€ëŸ¬
          </div>
          <h2 style="font-size: 20px; font-weight: 700; margin: 0;">${seller.accountName}</h2>
          <div style="margin-top: 12px;">
            <span style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 6px; font-size: 14px; font-weight: 600;">100%</span>
            <span style="font-size: 18px; font-weight: 700; margin-left: 8px;">ë¬´ìƒì§€ì›</span>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal()" style="position: absolute; right: 16px; top: 16px; color: white;">Ã—</button>
      </div>
      
      ${benefits.prelaunch && benefits.prelaunch.length > 0 ? `
        <div style="background: var(--gray-50); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--gray-700); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">1</span>
              <span style="font-weight: 600;">ê³µêµ¬ì˜ˆê³ </span>
            </div>
            <span style="background: var(--gray-200); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: var(--gray-600);">ë¦´ìŠ¤</span>
          </div>
          ${benefits.prelaunch.map(b => `
            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: white; border-radius: 12px; margin-bottom: 8px;">
              <span style="font-size: 20px;">ğŸŸï¸</span>
              <div>
                <div style="font-weight: 600; color: var(--primary);">${b.name} ${b.count ? `<span style="color: var(--primary);">${b.count}ëª…</span>` : ''}</div>
                <div style="font-size: 13px; color: var(--gray-600); margin-top: 2px;">${b.reward}</div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
      
      ${benefits.launch && benefits.launch.length > 0 ? `
        <div style="background: var(--gray-50); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--gray-700); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">2</span>
              <span style="font-weight: 600;">ê³µêµ¬ì˜¤í”ˆ</span>
            </div>
            <span style="background: var(--gray-200); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: var(--gray-600);">í”¼ë“œ</span>
          </div>
          ${benefits.launch.map(b => `
            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: white; border-radius: 12px; margin-bottom: 8px;">
              <span style="font-size: 20px;">${b.name.includes('í›„ê¸°') ? 'ğŸ’¬' : 'ğŸ›’'}</span>
              <div>
                <div style="font-weight: 600; color: var(--primary);">${b.name} ${b.count ? `<span style="color: var(--primary);">${b.count}ëª…</span>` : ''}</div>
                <div style="font-size: 13px; color: var(--gray-600); margin-top: 2px;">${b.reward}</div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
      
      ${benefits.support && benefits.support.length > 0 ? `
        <div style="background: var(--gray-800); border-radius: 16px; padding: 20px; color: white;">
          <div style="font-size: 13px; margin-bottom: 12px;">âœ¨ ì¶”ê°€ ì§€ì›</div>
          <div style="display: grid; grid-template-columns: repeat(${Math.min(benefits.support.length, 4)}, 1fr); gap: 12px;">
            ${benefits.support.map(s => {
              const info = supportLabels[s] || { icon: 'âœ“', label: s };
              return `
                <div style="text-align: center;">
                  <div style="background: var(--gray-700); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 20px;">${info.icon}</div>
                  <div style="font-size: 11px; line-height: 1.3;">${info.label}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      ` : ''}
      
      <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gray-200); font-size: 12px; color: var(--gray-500); text-align: center;">
        ğŸ“£ ê³µêµ¬ì˜ˆê³  ë¦´ìŠ¤ ì—…ë¡œë“œ í›„ ì•Œë ¤ì£¼ì‹œë©´<br>ëª¨ì—¬ë¼ë”œ ê³„ì •ì—ì„œ <strong style="color: var(--primary);">ê´‘ê³  ë“±ë¡</strong>í•´ë“œë ¤ìš”!
      </div>
      
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button class="btn btn-primary" onclick="closeModal(); openSellerBenefitsModal('${sellerListId}', true)">ìˆ˜ì •í•˜ê¸°</button>
      </div>
    </div>
  `;
}

function addSellerBenefitRow(type) {
  const container = document.getElementById(type + '-benefits');
  const row = document.createElement('div');
  row.className = 'benefit-row';
  row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
  row.innerHTML = `
    <input type="text" class="form-input" name="${type}-name" placeholder="ì´ë²¤íŠ¸ëª…" style="flex: 2;">
    <input type="text" class="form-input" name="${type}-count" placeholder="ì¸ì›" style="flex: 0.5;">
    <input type="text" class="form-input" name="${type}-reward" placeholder="í˜œíƒ" style="flex: 1.5;">
    <button type="button" class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding: 8px;">âœ•</button>
  `;
  container.appendChild(row);
}

async function submitSellerBenefits(e, sellerListId) {
  e.preventDefault();
  
  // í˜œíƒ ì •ë³´ ìˆ˜ì§‘
  const prelaunchNames = document.querySelectorAll('input[name="seller-prelaunch-name"]');
  const prelaunchCounts = document.querySelectorAll('input[name="seller-prelaunch-count"]');
  const prelaunchRewards = document.querySelectorAll('input[name="seller-prelaunch-reward"]');
  const prelaunch = [];
  prelaunchNames.forEach((el, i) => {
    if (el.value.trim() || prelaunchRewards[i].value.trim()) {
      prelaunch.push({
        name: el.value.trim(),
        count: prelaunchCounts[i].value.trim(),
        reward: prelaunchRewards[i].value.trim()
      });
    }
  });
  
  const launchNames = document.querySelectorAll('input[name="seller-launch-name"]');
  const launchCounts = document.querySelectorAll('input[name="seller-launch-count"]');
  const launchRewards = document.querySelectorAll('input[name="seller-launch-reward"]');
  const launch = [];
  launchNames.forEach((el, i) => {
    if (el.value.trim() || launchRewards[i].value.trim()) {
      launch.push({
        name: el.value.trim(),
        count: launchCounts[i].value.trim(),
        reward: launchRewards[i].value.trim()
      });
    }
  });
  
  const support = [];
  if (document.querySelector('input[name="seller-support-ad"]').checked) support.push('ad');
  if (document.querySelector('input[name="seller-support-payment"]').checked) support.push('payment');
  if (document.querySelector('input[name="seller-support-sample"]').checked) support.push('sample');
  if (document.querySelector('input[name="seller-support-feed"]').checked) support.push('feed');
  if (document.querySelector('input[name="seller-support-shipping"]').checked) support.push('shipping');
  if (document.querySelector('input[name="seller-support-commission"]').checked) support.push('commission');
  
  try {
    await db.collection('sellerList').doc(sellerListId).update({
      benefits: { prelaunch, launch, support }
    });
    showToast('í˜œíƒ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
  } catch(err) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ========== ê²½ì˜íŒ€ ì •ì‚°ì„œ ìƒì„± ==========

function generateManagementReport() {
  // ë°ì´í„° ë¶„ë¥˜ - ì •ì‚°ëŒ€ê¸°(ë¯¸ì™„ë£Œ)ë§Œ í‘œì‹œ
  const sellerInhouse = state.sellerSettlements.filter(s => s.productType === 'inhouse' && !s.isCompleted);
  const sellerExternal = state.sellerSettlements.filter(s => s.productType === 'external' && !s.isCompleted);
  const supplierSettlements = (state.supplierSettlements || []).filter(s => !s.isCompleted);
  
  // ìì‚¬ ìƒí’ˆ í•©ê³„
  const inhouseTotals = sellerInhouse.reduce((acc, s) => {
    acc.salesAmount += Number(s.salesAmount) || 0;
    acc.marginAmount += Number(s.marginAmount) || 0;
    acc.actualPayment += Number(s.actualPayment) || 0;
    return acc;
  }, { salesAmount: 0, marginAmount: 0, actualPayment: 0 });
  
  // íƒ€ì‚¬ ìƒí’ˆ í•©ê³„
  const externalTotals = sellerExternal.reduce((acc, s) => {
    acc.salesAmount += Number(s.salesAmount) || 0;
    acc.supplyAmount += Number(s.supplyAmount) || 0;
    acc.marginAmount += Number(s.marginAmount) || 0;
    acc.actualPayment += Number(s.actualPayment) || 0;
    return acc;
  }, { salesAmount: 0, supplyAmount: 0, marginAmount: 0, actualPayment: 0 });
  
  // ê³µê¸‰ì‚¬ ì •ì‚° í•©ê³„
  const supplierTotals = supplierSettlements.reduce((acc, s) => {
    acc.supplyAmount += Number(s.totalAmount) || 0;
    acc.shippingFee += Number(s.totalShippingFee) || 0;
    return acc;
  }, { supplyAmount: 0, shippingFee: 0 });
  
  const today = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
  const totalPendingCount = sellerInhouse.length + sellerExternal.length + supplierSettlements.length;
  
  // ëª¨ë‹¬ë¡œ ì •ì‚°ì„œ í‘œì‹œ
  const modal = document.getElementById('modal');
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 1400px; width: 95%; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>ğŸ“‹ ê²½ì˜íŒ€ ì œì¶œìš© ì •ì‚°ì„œ</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <div id="management-report-content" style="padding: 24px; background: white;">
        <!-- í—¤ë” -->
        <div style="text-align: center; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid #f97316;">
          <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #1f2937;">ğŸ“Š ì •ì‚° ë‚´ì—­ì„œ</h1>
          <p style="color: #6b7280; font-size: 14px;">ëª¨ì—¬ë¼ë”œ | ${today}</p>
          <div style="margin-top: 12px; display: inline-block; background: var(--gray-100); color: var(--gray-600); padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;">
            â³ ì •ì‚°ëŒ€ê¸° ${totalPendingCount}ê±´
          </div>
        </div>
        
        <!-- 1 ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚° -->
        <div style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #3b82f6;">
            <span style="background: #3b82f6; color: white; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">1</span>
            <h3 style="font-size: 14px; font-weight: 700; color: #1e40af; margin: 0;">ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚°</h3>
            <span style="font-size: 11px; color: #6b7280;">(${sellerInhouse.length}ê±´)</span>
          </div>
          
          ${sellerInhouse.length === 0 ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">ì •ì‚°ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : `
          <table style="width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 9%; white-space: nowrap;">ì…€ëŸ¬ëª…</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 6%; white-space: nowrap;">ë¸Œëœë“œ</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 11%; white-space: nowrap;">ê³µêµ¬ê¸°ê°„</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 14%; white-space: nowrap;">íŒë§¤ìƒí’ˆ</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 7%; white-space: nowrap;">ë‹¨ê°€</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 4%; white-space: nowrap;">ìˆ˜ëŸ‰</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 8%; white-space: nowrap;">íŒë§¤ê¸ˆì•¡</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 7%; white-space: nowrap;">ë§ˆì§„ê¸ˆì•¡</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 6%; white-space: nowrap;">ì›ì²œì„¸</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 7%; white-space: nowrap;">ì†Œê³„</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 8%; white-space: nowrap; background: #dbeafe; font-weight: 700;">ì´ì‹¤ì§€ê¸‰ì•¡</th>
                <th style="padding: 4px 2px; border: 1px solid #dbeafe; text-align: center; width: 8%; white-space: nowrap;">ì •ì‚°ì¼</th>
              </tr>
            </thead>
            <tbody>
              ${sellerInhouse.map(s => {
                // 1. ì…€ëŸ¬ ì •ì‚°ì˜ salesItems ë¨¼ì € í™•ì¸
                let items = s.salesItems || s.items || [];
                
                // 2. salesItemsê°€ ì—†ìœ¼ë©´ ê³µêµ¬ ê´€ë¦¬(deals)ì—ì„œ ìƒí’ˆ ì •ë³´ ì—°ë™
                if (items.length === 0 && s.dealPeriod) {
                  // ê³µêµ¬ ê¸°ê°„ìœ¼ë¡œ ë§¤ì¹­ë˜ëŠ” ê³µêµ¬ ì°¾ê¸°
                  const matchingDeal = state.deals.find(d => {
                    const dealPeriod = d.startDate + '~' + d.endDate;
                    return dealPeriod === s.dealPeriod || 
                           (d.brandName === s.brandName) ||
                           (d.sellerName && d.sellerName.includes(s.sellerName));
                  });
                  if (matchingDeal && matchingDeal.products && matchingDeal.products.length > 0) {
                    items = matchingDeal.products.map(p => ({
                      productName: p.productName || p.name,
                      unitPrice: Number(p.salePrice) || Number(p.price) || 0,
                      quantity: 0, // ìˆ˜ëŸ‰ì€ ì •ì‚° ë°ì´í„°ì—ì„œ
                      amount: 0,
                      marginRate: Number(p.marginRate) || 0,
                      marginAmount: 0,
                      actualPayment: 0
                    }));
                  }
                }
                
                if (items.length === 0) {
                  return '<tr>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;"><strong>' + (s.sellerName || '-') + '</strong></td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + (s.brandName || '-') + '</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px;">' + (s.dealPeriod || '-') + '</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; color: #9ca3af;">(í’ˆëª©ì •ë³´ì—†ìŒ)</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">-</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + (s.totalQuantity || 0) + '</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + Number(s.salesAmount || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + Number(s.marginAmount || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + Number(s.withholdingTax || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + Number(s.actualPayment || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; background: #dbeafe; font-weight: 700; color: #1e40af;">' + Number(s.actualPayment || 0).toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px;">' + (s.settlementDate || '-') + '</td>' +
                    '</tr>';
                } else {
                  let rows = '';
                  const totalActual = Number(s.actualPayment) || 0;
                  
                  items.forEach((item, idx) => {
                    const isFirst = idx === 0;
                    const rowspan = items.length;
                    const qty = Number(item.quantity) || 0;
                    const unitPrice = Number(item.unitPrice) || 0;
                    const itemSalesAmount = Number(item.amount) || (unitPrice * qty);
                    const itemMargin = Number(item.marginAmount) || 0;
                    const itemTax = Math.round(itemMargin * 0.033);
                    const itemSubtotal = Number(item.actualPayment) || (itemMargin - itemTax);
                    
                    rows += '<tr>' +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; vertical-align: middle;" rowspan="' + rowspan + '"><strong>' + (s.sellerName || '-') + '</strong></td>' : '') +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.brandName || '-') + '</td>' : '') +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.dealPeriod || '-') + '</td>' : '') +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px;">' + (item.productName || '-') + '</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + unitPrice.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + qty + '</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + itemSalesAmount.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + itemMargin.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + itemTax.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">' + itemSubtotal.toLocaleString() + 'ì›</td>' +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; vertical-align: middle; background: #dbeafe; font-weight: 700; color: #1e40af;" rowspan="' + rowspan + '">' + totalActual.toLocaleString() + 'ì›</td>' : '') +
                      (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; font-size: 9px; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.settlementDate || '-') + '</td>' : '') +
                      '</tr>';
                  });
                  return rows;
                }
              }).join('')}
              <tr style="background: #f3f4f6; font-weight: 700;">
                <td colspan="5" style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">í•©ê³„</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">${sellerInhouse.reduce((sum,s)=>sum+(Number(s.totalQuantity)||0),0)}</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">${inhouseTotals.salesAmount.toLocaleString()}ì›</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">${inhouseTotals.marginAmount.toLocaleString()}ì›</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;">${sellerInhouse.reduce((sum,s)=>sum+(Number(s.withholdingTax)||0),0).toLocaleString()}ì›</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;"></td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap; background: #bfdbfe; font-weight: 700; color: #1e40af;">${inhouseTotals.actualPayment.toLocaleString()}ì›</td>
                <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; white-space: nowrap;"></td>
              </tr>
            </tbody>
          </table>
          `}
        </div>
        
        <!-- 2 íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (í†µí•© í…Œì´ë¸”) -->
        <div style="margin-bottom: 32px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #059669;">
            <span style="background: #059669; color: white; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">2</span>
            <h3 style="font-size: 14px; font-weight: 700; color: #065f46; margin: 0;">íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚°</h3>
            <span style="font-size: 11px; color: #6b7280;">(${sellerExternal.length + supplierSettlements.length}ê±´)</span>
          </div>
          
          ${(sellerExternal.length === 0 && supplierSettlements.length === 0) ? '<p style="color: #9ca3af; text-align: center; padding: 20px;">íƒ€ì‚¬ ìƒí’ˆ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : `
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 9px; min-width: 1200px;">
              <thead>
                <tr style="background: linear-gradient(90deg, #ecfdf5 0%, var(--gray-100) 100%);">
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 7%; white-space: nowrap;">ì…€ëŸ¬ëª…</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 6%; white-space: nowrap;">ë¸Œëœë“œ(ê³µê¸‰ì‚¬)</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 9%; white-space: nowrap;">ê³µêµ¬ê¸°ê°„</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 11%; white-space: nowrap;">íŒë§¤ìƒí’ˆ</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap;">ë‹¨ê°€</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 3%; white-space: nowrap;">ìˆ˜ëŸ‰</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 6%; white-space: nowrap;">íŒë§¤ê¸ˆì•¡</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap; background: #d1fae5;">ë§ˆì§„ê¸ˆì•¡</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 4%; white-space: nowrap; background: #d1fae5;">ì›ì²œì„¸</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 5%; white-space: nowrap; background: #d1fae5;">ì†Œê³„</th>
                  <th style="padding: 4px 2px; border: 1px solid #d1fae5; text-align: center; width: 6%; white-space: nowrap; background: #a7f3d0; font-weight: 700;">ì´ì‹¤ì§€ê¸‰ì•¡</th>
                  <th style="padding: 4px 2px; border: 1px solid #fde68a; text-align: center; width: 5%; white-space: nowrap; background: #fde68a;">ê³µê¸‰ê°€ì•¡</th>
                  <th style="padding: 4px 2px; border: 1px solid #fde68a; text-align: center; width: 5%; white-space: nowrap; background: #fde68a;">ë¶€ê°€ì„¸(10%)</th>
                  <th style="padding: 4px 2px; border: 1px solid #fde68a; text-align: center; width: 5%; white-space: nowrap; background: #fde68a;">ì´í•©ê³„</th>
                  <th style="padding: 4px 2px; border: 1px solid #fde68a; text-align: center; width: 6%; white-space: nowrap; background: var(--gray-300); font-weight: 700;">ì •ì‚°ê¸ˆì•¡(V+)</th>
                  <th style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; width: 6%; white-space: nowrap;">ì •ì‚°ì¼</th>
                </tr>
                <tr style="background: #f9fafb; font-size: 8px; color: #6b7280;">
                  <th colspan="7" style="border: 1px solid #e5e7eb;"></th>
                  <th colspan="4" style="border: 1px solid #d1fae5; background: #ecfdf5; color: #065f46;">â† ì…€ëŸ¬ ì •ì‚° â†’</th>
                  <th colspan="4" style="border: 1px solid #fde68a; background: var(--gray-50); color: var(--gray-600);">â† ê³µê¸‰ì‚¬ ì •ì‚° â†’</th>
                  <th style="border: 1px solid #e5e7eb;"></th>
                </tr>
              </thead>
              <tbody>
                ${sellerExternal.map(s => {
                  // ì…€ëŸ¬ ì •ì‚° ë°ì´í„°
                  let sellerItems = s.salesItems || s.items || [];
                  
                  // ë§¤ì¹­ë˜ëŠ” ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸°
                  const matchingSupplier = supplierSettlements.find(sup => 
                    ((sup.sellerName || '').includes(s.sellerName || '') || (s.sellerName || '').includes(sup.sellerName || '')) &&
                    ((sup.brandName || '').includes(s.brandName || '') || (s.brandName || '').includes(sup.brandName || ''))
                  );
                  
                  // ê³µê¸‰ì‚¬ ì •ì‚° ì•„ì´í…œ
                  const supplierItems = matchingSupplier ? (matchingSupplier.items || []) : [];
                  
                  // ì•„ì´í…œì´ ì—†ìœ¼ë©´ ê³µê¸‰ì‚¬ ì•„ì´í…œ ì‚¬ìš©
                  if (sellerItems.length === 0 && supplierItems.length > 0) {
                    sellerItems = supplierItems;
                  }
                  
                  // ê³µêµ¬ì—ì„œ ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                  if (sellerItems.length === 0 && s.dealPeriod) {
                    const matchingDeal = state.deals.find(d => {
                      const dealPeriod = d.startDate + '~' + d.endDate;
                      return dealPeriod === s.dealPeriod || (d.brandName === s.brandName);
                    });
                    if (matchingDeal && matchingDeal.products && matchingDeal.products.length > 0) {
                      sellerItems = matchingDeal.products.map(p => ({
                        productName: p.productName || p.name,
                        salePrice: Number(p.salePrice) || Number(p.price) || 0,
                        supplyPrice: Number(p.supplyPrice) || 0,
                        quantity: 0
                      }));
                    }
                  }
                  
                  const totalActualPayment = Number(s.actualPayment) || 0;
                  const supplierTotalAmount = matchingSupplier ? Number(matchingSupplier.totalAmount) || 0 : 0;
                  
                  if (sellerItems.length === 0) {
                    // í’ˆëª© ì •ë³´ ì—†ëŠ” ê²½ìš°
                    return '<tr>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;"><strong>' + (s.sellerName || '-') + '</strong></td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + (s.brandName || '-') + '</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px;">' + (s.dealPeriod || '-') + '</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; color: #9ca3af;">(í’ˆëª©ì •ë³´ì—†ìŒ)</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">-</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + (s.totalQuantity || 0) + '</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + Number(s.salesAmount || 0).toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + Number(s.marginAmount || 0).toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + Number(s.withholdingTax || 0).toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + totalActualPayment.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #d1fae5; font-weight: 700; color: #065f46;">' + totalActualPayment.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + (matchingSupplier ? Number(matchingSupplier.totalSupplyAmount || 0).toLocaleString() : '-') + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + (matchingSupplier ? Number(matchingSupplier.totalVatAmount || 0).toLocaleString() : '-') + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + supplierTotalAmount.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-100); font-weight: 700; color: var(--gray-600);">' + supplierTotalAmount.toLocaleString() + 'ì›</td>' +
                      '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px;">' + (s.settlementDate || '-') + '</td>' +
                      '</tr>';
                  } else {
                    // í’ˆëª©ë³„ ìƒì„¸ í‘œì‹œ
                    let rows = '';
                    const rowspan = sellerItems.length;
                    
                    sellerItems.forEach((item, idx) => {
                      const isFirst = idx === 0;
                      const qty = Number(item.quantity) || 0;
                      const unitPrice = Number(item.unitPrice) || Number(item.salePrice) || Number(item.supplyPrice) || 0;
                      const itemSalesAmount = Number(item.amount) || (unitPrice * qty);
                      
                      // ì…€ëŸ¬ ì •ì‚° ê³„ì‚°
                      const totalSalesAmt = Number(s.salesAmount) || 0;
                      const totalMarginAmt = Number(s.marginAmount) || 0;
                      const totalTaxAmt = Number(s.withholdingTax) || 0;
                      const ratio = totalSalesAmt > 0 ? itemSalesAmount / totalSalesAmt : (1 / sellerItems.length);
                      const itemMargin = Number(item.marginAmount) || Math.round(totalMarginAmt * ratio);
                      const itemTax = Math.round(itemMargin * 0.033);
                      const itemSubtotal = Number(item.actualPayment) || (itemMargin - itemTax);
                      
                      // ê³µê¸‰ì‚¬ ì •ì‚° ê³„ì‚°
                      const supplyPrice = Number(item.supplyPrice) || unitPrice;
                      const supplyAmount = Math.round(supplyPrice * qty / 1.1);
                      const vatAmount = Math.round(supplyAmount * 0.1);
                      const itemSupplierTotal = supplyAmount + vatAmount;
                      
                      rows += '<tr>' +
                        (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle;" rowspan="' + rowspan + '"><strong>' + (s.sellerName || '-') + '</strong></td>' : '') +
                        (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.brandName || '-') + '</td>' : '') +
                        (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.dealPeriod || '-') + '</td>' : '') +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px;">' + (item.productName || '-') + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + unitPrice.toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + qty + '</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">' + itemSalesAmount.toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + itemMargin.toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + itemTax.toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-50);">' + itemSubtotal.toLocaleString() + 'ì›</td>' +
                        (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle; background: #d1fae5; font-weight: 700; color: #065f46;" rowspan="' + rowspan + '">' + totalActualPayment.toLocaleString() + 'ì›</td>' : '') +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + supplyAmount.toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + vatAmount.toLocaleString() + 'ì›</td>' +
                        '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #fffbeb;">' + itemSupplierTotal.toLocaleString() + 'ì›</td>' +
                        (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle; background: var(--gray-100); font-weight: 700; color: var(--gray-600);" rowspan="' + rowspan + '">' + supplierTotalAmount.toLocaleString() + 'ì›</td>' : '') +
                        (isFirst ? '<td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; font-size: 8px; vertical-align: middle;" rowspan="' + rowspan + '">' + (s.settlementDate || '-') + '</td>' : '') +
                        '</tr>';
                    });
                    return rows;
                  }
                }).join('')}
                <tr style="background: #f3f4f6; font-weight: 700;">
                  <td colspan="5" style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">í•©ê³„</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">${sellerExternal.reduce((sum,s)=>sum+(Number(s.totalQuantity)||0),0)}</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;">${externalTotals.salesAmount.toLocaleString()}ì›</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #d1fae5;">${externalTotals.marginAmount.toLocaleString()}ì›</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #d1fae5;">${sellerExternal.reduce((sum,s)=>sum+(Number(s.withholdingTax)||0),0).toLocaleString()}ì›</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #d1fae5;"></td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: #a7f3d0; color: #065f46;">${externalTotals.actualPayment.toLocaleString()}ì›</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-100);">${supplierSettlements.reduce((sum,s)=>sum+(Number(s.totalSupplyAmount)||0),0).toLocaleString()}ì›</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-100);">${supplierSettlements.reduce((sum,s)=>sum+(Number(s.totalVatAmount)||0),0).toLocaleString()}ì›</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-100);">${supplierSettlements.reduce((sum,s)=>sum+(Number(s.totalAmount)||0),0).toLocaleString()}ì›</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center; background: var(--gray-300); color: var(--gray-600);">${supplierTotals.supplyAmount.toLocaleString()}ì›</td>
                  <td style="padding: 4px 2px; border: 1px solid #e5e7eb; text-align: center;"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <p style="font-size: 10px; color: #6b7280; margin-top: 8px;">
            ğŸ’¡ <span style="background: #d1fae5; padding: 1px 4px; border-radius: 2px;">ë…¹ìƒ‰ ì»¬ëŸ¼</span>: ì…€ëŸ¬ ì •ì‚° í•­ëª© | <span style="background: var(--gray-100); padding: 1px 4px; border-radius: 2px;">ë…¸ë€ìƒ‰ ì»¬ëŸ¼</span>: ê³µê¸‰ì‚¬ ì •ì‚° í•­ëª©
          </p>
          `}
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: center;">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button class="btn btn-primary" style="background: #217346;" onclick="downloadManagementReportExcel()">ğŸ“Š ì—‘ì…€ íŒŒì¼ ì €ì¥</button>
        <button class="btn btn-primary" style="background: #059669;" onclick="downloadManagementReportHTML()">ğŸ’¾ HTML ì €ì¥</button>
      </div>
    </div>
  `;
  modal.className = 'modal show';
}

// ê²½ì˜íŒ€ ì •ì‚°ì„œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
async function downloadManagementReportExcel() {
  // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    await new Promise(resolve => script.onload = resolve);
  }
  
  const today = new Date().toISOString().split('T')[0];
  const wb = XLSX.utils.book_new();
  
  // ë°ì´í„° ë¶„ë¥˜
  const sellerInhouse = state.sellerSettlements.filter(s => s.productType === 'inhouse' && !s.isCompleted);
  const sellerExternal = state.sellerSettlements.filter(s => s.productType === 'external' && !s.isCompleted);
  const supplierSettlements = (state.supplierSettlements || []).filter(s => !s.isCompleted);
  
  // ===== ì‹œíŠ¸1: ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚° =====
  const sheet1Data = [
    ['ğŸ“Š ì •ì‚° ë‚´ì—­ì„œ - ëª¨ì—¬ë¼ë”œ | ' + today],
    [],
    ['1. ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚° (' + sellerInhouse.length + 'ê±´)'],
    ['ì…€ëŸ¬ëª…', 'ë¸Œëœë“œ', 'ê³µêµ¬ê¸°ê°„', 'íŒë§¤ìƒí’ˆ', 'ë‹¨ê°€', 'ìˆ˜ëŸ‰', 'íŒë§¤ê¸ˆì•¡', 'ë§ˆì§„ê¸ˆì•¡', 'ì›ì²œì„¸', 'ì†Œê³„', 'ì´ì‹¤ì§€ê¸‰ì•¡', 'ì •ì‚°ì¼']
  ];
  
  let inhouseTotalQty = 0, inhouseTotalSales = 0, inhouseTotalMargin = 0, inhouseTotalTax = 0, inhouseTotalPayment = 0;
  
  sellerInhouse.forEach(s => {
    const items = s.salesItems || s.items || [];
    if (items.length === 0) {
      const qty = Number(s.totalQuantity) || 0;
      const sales = Number(s.salesAmount) || 0;
      const margin = Number(s.marginAmount) || 0;
      const tax = Number(s.withholdingTax) || 0;
      const payment = Number(s.actualPayment) || 0;
      inhouseTotalQty += qty;
      inhouseTotalSales += sales;
      inhouseTotalMargin += margin;
      inhouseTotalTax += tax;
      inhouseTotalPayment += payment;
      sheet1Data.push([s.sellerName || '-', s.brandName || '-', s.dealPeriod || '-', '(í’ˆëª©ì •ë³´ì—†ìŒ)', '-', qty, sales, margin, tax, payment, payment, s.settlementDate || '-']);
    } else {
      items.forEach((item, idx) => {
        const qty = Number(item.quantity) || 0;
        const unitPrice = Number(item.unitPrice) || 0;
        const itemSales = Number(item.amount) || (unitPrice * qty);
        const itemMargin = Number(item.marginAmount) || 0;
        const itemTax = Math.round(itemMargin * 0.033);
        const itemSubtotal = Number(item.actualPayment) || (itemMargin - itemTax);
        inhouseTotalQty += qty;
        inhouseTotalSales += itemSales;
        inhouseTotalMargin += itemMargin;
        inhouseTotalTax += itemTax;
        if (idx === 0) inhouseTotalPayment += Number(s.actualPayment) || 0;
        sheet1Data.push([
          idx === 0 ? (s.sellerName || '-') : '',
          idx === 0 ? (s.brandName || '-') : '',
          idx === 0 ? (s.dealPeriod || '-') : '',
          item.productName || '-',
          unitPrice,
          qty,
          itemSales,
          itemMargin,
          itemTax,
          itemSubtotal,
          idx === 0 ? (Number(s.actualPayment) || 0) : '',
          idx === 0 ? (s.settlementDate || '-') : ''
        ]);
      });
    }
  });
  
  sheet1Data.push(['í•©ê³„', '', '', '', '', inhouseTotalQty, inhouseTotalSales, inhouseTotalMargin, inhouseTotalTax, '', inhouseTotalPayment, '']);
  
  const ws1 = XLSX.utils.aoa_to_sheet(sheet1Data);
  ws1['!cols'] = [{wch:18},{wch:10},{wch:22},{wch:30},{wch:10},{wch:6},{wch:12},{wch:12},{wch:10},{wch:10},{wch:12},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws1, '1.ìì‚¬ìƒí’ˆ-ì…€ëŸ¬ì •ì‚°');
  
  // ===== ì‹œíŠ¸2: íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (í†µí•©) =====
  const sheet2Data = [
    ['2. íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (' + (sellerExternal.length + supplierSettlements.length) + 'ê±´)'],
    [],
    ['', '', '', '', '', '', '', 'â† ì…€ëŸ¬ ì •ì‚° â†’', '', '', '', 'â† ê³µê¸‰ì‚¬ ì •ì‚° â†’', '', '', '', ''],
    ['ì…€ëŸ¬ëª…', 'ë¸Œëœë“œ(ê³µê¸‰ì‚¬)', 'ê³µêµ¬ê¸°ê°„', 'íŒë§¤ìƒí’ˆ', 'ë‹¨ê°€', 'ìˆ˜ëŸ‰', 'íŒë§¤ê¸ˆì•¡', 'ë§ˆì§„ê¸ˆì•¡', 'ì›ì²œì„¸', 'ì†Œê³„', 'ì´ì‹¤ì§€ê¸‰ì•¡', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸(10%)', 'ì´í•©ê³„', 'ì •ì‚°ê¸ˆì•¡(V+)', 'ì •ì‚°ì¼']
  ];
  
  let extTotalQty = 0, extTotalSales = 0, extTotalMargin = 0, extTotalTax = 0, extTotalPayment = 0;
  let supTotalSupply = 0, supTotalVat = 0, supTotalAmount = 0;
  
  sellerExternal.forEach(s => {
    let sellerItems = s.salesItems || s.items || [];
    
    // ë§¤ì¹­ë˜ëŠ” ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸°
    const matchingSupplier = supplierSettlements.find(sup => 
      ((sup.sellerName || '').includes(s.sellerName || '') || (s.sellerName || '').includes(sup.sellerName || '')) &&
      ((sup.brandName || '').includes(s.brandName || '') || (s.brandName || '').includes(sup.brandName || ''))
    );
    
    const supplierItems = matchingSupplier ? (matchingSupplier.items || []) : [];
    if (sellerItems.length === 0 && supplierItems.length > 0) {
      sellerItems = supplierItems;
    }
    
    const totalActualPayment = Number(s.actualPayment) || 0;
    const supplierTotalAmount = matchingSupplier ? Number(matchingSupplier.totalAmount) || 0 : 0;
    const supplierTotalSupply = matchingSupplier ? Number(matchingSupplier.totalSupplyAmount) || 0 : 0;
    const supplierTotalVat = matchingSupplier ? Number(matchingSupplier.totalVatAmount) || 0 : 0;
    
    if (sellerItems.length === 0) {
      const qty = Number(s.totalQuantity) || 0;
      const sales = Number(s.salesAmount) || 0;
      const margin = Number(s.marginAmount) || 0;
      const tax = Number(s.withholdingTax) || 0;
      extTotalQty += qty;
      extTotalSales += sales;
      extTotalMargin += margin;
      extTotalTax += tax;
      extTotalPayment += totalActualPayment;
      supTotalSupply += supplierTotalSupply;
      supTotalVat += supplierTotalVat;
      supTotalAmount += supplierTotalAmount;
      
      sheet2Data.push([
        s.sellerName || '-', s.brandName || '-', s.dealPeriod || '-', '(í’ˆëª©ì •ë³´ì—†ìŒ)', '-', qty, sales,
        margin, tax, totalActualPayment, totalActualPayment,
        supplierTotalSupply, supplierTotalVat, supplierTotalAmount, supplierTotalAmount, s.settlementDate || '-'
      ]);
    } else {
      sellerItems.forEach((item, idx) => {
        const qty = Number(item.quantity) || 0;
        const unitPrice = Number(item.unitPrice) || Number(item.salePrice) || Number(item.supplyPrice) || 0;
        const itemSales = Number(item.amount) || (unitPrice * qty);
        const totalSalesAmt = Number(s.salesAmount) || 0;
        const totalMarginAmt = Number(s.marginAmount) || 0;
        const ratio = totalSalesAmt > 0 ? itemSales / totalSalesAmt : (1 / sellerItems.length);
        const itemMargin = Number(item.marginAmount) || Math.round(totalMarginAmt * ratio);
        const itemTax = Math.round(itemMargin * 0.033);
        const itemSubtotal = Number(item.actualPayment) || (itemMargin - itemTax);
        
        // ê³µê¸‰ì‚¬ ê³„ì‚°
        const supplyPrice = Number(item.supplyPrice) || unitPrice;
        const supplyAmount = Math.round(supplyPrice * qty / 1.1);
        const vatAmount = Math.round(supplyAmount * 0.1);
        const itemSupplierTotal = supplyAmount + vatAmount;
        
        extTotalQty += qty;
        extTotalSales += itemSales;
        extTotalMargin += itemMargin;
        extTotalTax += itemTax;
        if (idx === 0) {
          extTotalPayment += totalActualPayment;
          supTotalSupply += supplierTotalSupply;
          supTotalVat += supplierTotalVat;
          supTotalAmount += supplierTotalAmount;
        }
        
        sheet2Data.push([
          idx === 0 ? (s.sellerName || '-') : '',
          idx === 0 ? (s.brandName || '-') : '',
          idx === 0 ? (s.dealPeriod || '-') : '',
          item.productName || '-',
          unitPrice,
          qty,
          itemSales,
          itemMargin,
          itemTax,
          itemSubtotal,
          idx === 0 ? totalActualPayment : '',
          supplyAmount,
          vatAmount,
          itemSupplierTotal,
          idx === 0 ? supplierTotalAmount : '',
          idx === 0 ? (s.settlementDate || '-') : ''
        ]);
      });
    }
  });
  
  sheet2Data.push(['í•©ê³„', '', '', '', '', extTotalQty, extTotalSales, extTotalMargin, extTotalTax, '', extTotalPayment, supTotalSupply, supTotalVat, supTotalAmount, supTotalAmount, '']);
  
  const ws2 = XLSX.utils.aoa_to_sheet(sheet2Data);
  ws2['!cols'] = [{wch:18},{wch:12},{wch:22},{wch:28},{wch:10},{wch:6},{wch:12},{wch:10},{wch:8},{wch:10},{wch:12},{wch:10},{wch:10},{wch:10},{wch:12},{wch:12}];
  
  // ì…€ ë³‘í•© ì„¤ì • (â† ì…€ëŸ¬ ì •ì‚° â†’ ì™€ â† ê³µê¸‰ì‚¬ ì •ì‚° â†’ ë¶€ë¶„)
  ws2['!merges'] = [
    { s: { r: 2, c: 7 }, e: { r: 2, c: 10 } },   // H3:K3 (â† ì…€ëŸ¬ ì •ì‚° â†’)
    { s: { r: 2, c: 11 }, e: { r: 2, c: 14 } }   // L3:O3 (â† ê³µê¸‰ì‚¬ ì •ì‚° â†’)
  ];
  
  XLSX.utils.book_append_sheet(wb, ws2, '2.íƒ€ì‚¬ìƒí’ˆ-í†µí•©ì •ì‚°');
  
  // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
  XLSX.writeFile(wb, 'ëª¨ì—¬ë¼ë”œ_ì •ì‚°ì„œ_' + today + '.xlsx');
  showToast('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ê²½ì˜íŒ€ ì •ì‚°ì„œ HTML ë‹¤ìš´ë¡œë“œ
function downloadManagementReportHTML() {
  const content = document.getElementById('management-report-content');
  const today = new Date().toISOString().split('T')[0];
  
  const htmlContent = `
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì—¬ë¼ë”œ ì •ì‚°ì„œ - ${today}</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Malgun Gothic', sans-serif; 
      padding: 20px; 
      max-width: 1400px; 
      margin: 0 auto; 
      background: #f9fafb;
    }
    .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    th, td { padding: 6px 4px; border: 1px solid #e5e7eb; }
    @media print { 
      body { padding: 0; background: white; } 
      .container { box-shadow: none; }
      @page { size: A4 landscape; margin: 0.5cm; }
    }
  </style>
</head>
<body>
  <div class="container">
    ${content.innerHTML}
  </div>
</body>
</html>
  `;
  
  const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ëª¨ì—¬ë¼ë”œ_ì •ì‚°ì„œ_${today}.html`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('ì •ì‚°ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ========== ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œ ê´€ë ¨ í•¨ìˆ˜ ==========

// ì •ì‚°ì™„ë£Œ ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸° ìƒíƒœ
let completedSectionCollapsed = true;

function renderSalesReport() {
  const app = document.getElementById('app');
  
  // íƒ€ì‚¬ ìƒí’ˆ ì™„ë£Œ íŒë‹¨: ì…€ëŸ¬ì™„ë£Œ + ê³µê¸‰ì‚¬ì™„ë£Œ ë‘˜ ë‹¤ ì²´í¬ë˜ì–´ì•¼ ì™„ë£Œ
  const isExternalComplete = (seller) => {
    if (!seller.isSellerCompleted) return false;
    // ì—°ê²°ëœ ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸°
    const matchingSupplier = state.supplierSettlements.find(sup => 
      sup.sellerName === seller.sellerName && 
      sup.brandName === seller.brandName && 
      sup.dealPeriod === seller.dealPeriod
    );
    // ê³µê¸‰ì‚¬ ì •ì‚°ì´ ì—†ê±°ë‚˜ ì™„ë£Œ ì•ˆëìœ¼ë©´ ë¯¸ì™„ë£Œ
    return matchingSupplier?.isCompleted === true;
  };
  
  // ì •ì‚°ëŒ€ê¸° (ë¯¸ì™„ë£Œ)
  const sellerInhousePending = state.sellerSettlements.filter(s => s.productType === 'inhouse' && !s.isCompleted);
  const sellerExternalPending = state.sellerSettlements.filter(s => s.productType === 'external' && !isExternalComplete(s));
  const supplierPending = state.supplierSettlements.filter(s => !s.isCompleted);
  
  // ì •ì‚°ì™„ë£Œ
  const sellerInhouseCompleted = state.sellerSettlements.filter(s => s.productType === 'inhouse' && s.isCompleted);
  const sellerExternalCompleted = state.sellerSettlements.filter(s => s.productType === 'external' && isExternalComplete(s));
  const supplierCompleted = state.supplierSettlements.filter(s => s.isCompleted);
  
  // ì „ì²´ (ê¸°ì¡´ í˜¸í™˜)
  const sellerInhouse = state.sellerSettlements.filter(s => s.productType === 'inhouse');
  const sellerExternal = state.sellerSettlements.filter(s => s.productType === 'external');
  
  const inhouseTotals = sellerInhouse.reduce((acc, s) => {
    acc.salesAmount += Number(s.salesAmount) || 0;
    acc.marginAmount += Number(s.marginAmount) || 0;
    acc.eventCost += Number(s.eventCost) || 0;
    return acc;
  }, { salesAmount: 0, marginAmount: 0, eventCost: 0 });
  
  // íƒ€ì‚¬ ìƒí’ˆ - sellerSettlementsì—ì„œ ê³„ì‚°
  const externalSellerTotals = sellerExternal.reduce((acc, s) => {
    acc.salesAmount += Number(s.salesAmount) || 0;
    acc.supplyAmount += Number(s.supplyAmount) || 0;
    acc.marginAmount += Number(s.marginAmount) || 0;
    acc.eventCost += Number(s.eventCost) || 0;
    
    // ê³µê¸‰ì‚¬ ì •ì‚°ê¸ˆì•¡: sellerSettlementsì— ì €ì¥ëœ ê°’ ë˜ëŠ” ì—°ê²°ëœ supplierSettlementsì—ì„œ ì°¾ê¸°
    let supplierAmount = Number(s.supplierTotalAmount) || 0;
    if (supplierAmount === 0) {
      // ê¸°ì¡´ ë°©ì‹: supplierSettlementsì—ì„œ ë§¤ì¹­ë˜ëŠ” ë°ì´í„° ì°¾ê¸°
      const matchedSupplier = state.supplierSettlements.find(sup => 
        sup.sellerName === s.sellerName && 
        sup.brandName === s.brandName && 
        sup.dealPeriod === s.dealPeriod
      );
      if (matchedSupplier) {
        supplierAmount = Number(matchedSupplier.totalAmount) || 0;
      }
    }
    acc.supplierTotalAmount += supplierAmount;
    
    return acc;
  }, { salesAmount: 0, supplyAmount: 0, supplierTotalAmount: 0, marginAmount: 0, eventCost: 0 });
  
  // ì¶”ê°€: supplierSettlementsì—ë§Œ ìˆëŠ” ë°ì´í„°ë„ í•©ì‚° (sellerSettlementsì™€ ë§¤ì¹­ ì•ˆ ëœ ê²ƒ)
  const unmatchedSupplierTotal = state.supplierSettlements.reduce((sum, sup) => {
    const hasMatch = sellerExternal.some(s => 
      s.sellerName === sup.sellerName && 
      s.brandName === sup.brandName && 
      s.dealPeriod === sup.dealPeriod
    );
    if (!hasMatch) {
      return sum + (Number(sup.totalAmount) || 0);
    }
    return sum;
  }, 0);
  
  // ê³µê¸‰ì‚¬ ì •ì‚° ì´ì•¡
  const supplierTotals = {
    totalAmount: externalSellerTotals.supplierTotalAmount + unmatchedSupplierTotal,
    totalSupplyAmount: externalSellerTotals.supplyAmount,
    totalVatAmount: Math.round(externalSellerTotals.supplyAmount * 0.1)
  };
  
  // ì´ íŒë§¤ê¸ˆì•¡ (PGìˆ˜ìˆ˜ë£Œ ê³„ì‚° ê¸°ì¤€)
  const totalSalesAmount = inhouseTotals.salesAmount + externalSellerTotals.salesAmount;
  // PGìˆ˜ìˆ˜ë£Œ 4%
  const pgFee = Math.round(totalSalesAmount * 0.04);
  // ì´ë²¤íŠ¸ë¹„ìš© (ì…€ëŸ¬ë³„ í•©ê³„)
  const totalEventCost = inhouseTotals.eventCost + externalSellerTotals.eventCost;
  
  // ìì‚¬ ìƒí’ˆ ìˆœì´ìµ ê³„ì‚° (ë§¤ì¶œ - ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ - PGìˆ˜ìˆ˜ë£Œ - ì´ë²¤íŠ¸ë¹„ìš©)
  const inhousePgFee = Math.round(inhouseTotals.salesAmount * 0.04);
  const inhouseProfit = inhouseTotals.salesAmount - inhouseTotals.marginAmount - inhousePgFee - inhouseTotals.eventCost;
  
  // íƒ€ì‚¬ ìƒí’ˆ ìˆœì´ìµ ê³„ì‚° (íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ì‚¬ì •ì‚° - ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ - PGìˆ˜ìˆ˜ë£Œ - ì´ë²¤íŠ¸ë¹„ìš©)
  const externalPgFee = Math.round(externalSellerTotals.salesAmount * 0.04);
  const externalProfit = externalSellerTotals.salesAmount - supplierTotals.totalAmount - externalSellerTotals.marginAmount - externalPgFee - externalSellerTotals.eventCost;
  
  // íƒ€ì‚¬ ìƒí’ˆ ë§¤ì¶œê¸ˆì•¡ (ìˆœìˆ˜ìµ) = íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ì‚¬ì •ì‚°ê¸ˆì•¡
  const externalRevenueAmount = externalSellerTotals.salesAmount - supplierTotals.totalAmount;
  
  // ì´ í•©ê³„
  const totalRevenue = inhouseTotals.salesAmount + externalRevenueAmount;
  const totalSellerCost = inhouseTotals.marginAmount + externalSellerTotals.marginAmount;
  const totalSupplierCost = supplierTotals.totalAmount;
  const totalProfit = totalRevenue - totalSellerCost - pgFee - totalEventCost;
  
  // ===== ìƒˆ ëŒ€ì‹œë³´ë“œ ì§€í‘œ =====
  // ì´ ë¶€ê°€ë¹„ìš© (ì…€ëŸ¬ + ê³µê¸‰ì‚¬ + PG + ì´ë²¤íŠ¸)
  const totalCost = totalSellerCost + totalSupplierCost + pgFee + totalEventCost;
  
  // ì´ìµë¥  (%)
  const profitRate = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(1) : 0;
  
  // ì •ì‚°ëŒ€ê¸° ê¸ˆì•¡ (íƒ€ì‚¬ ìƒí’ˆì€ ê³µê¸‰ì‚¬ì •ì‚°ê¸ˆì•¡ë„ í¬í•¨)
  const pendingSellerAmount = [...sellerInhousePending, ...sellerExternalPending].reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
  const pendingSupplierAmount = sellerExternalPending.reduce((sum, s) => sum + (Number(s.supplierTotalAmount) || 0), 0);
  const pendingTotalAmount = pendingSellerAmount + pendingSupplierAmount;
  
  // ê³µêµ¬ ê±´ìˆ˜ (sellerSettlements ê¸°ì¤€)
  const totalDealCount = state.sellerSettlements.length;
  
  // í‰ê·  ê°ë‹¨ê°€ (ì´ íŒë§¤ê¸ˆì•¡ / ì´ ìˆ˜ëŸ‰)
  const totalQuantity = state.sellerSettlements.reduce((sum, s) => sum + (Number(s.totalQuantity) || 0), 0);
  const avgOrderValue = totalQuantity > 0 ? Math.round(totalSalesAmount / totalQuantity) : 0;
  
  // ì´ë²ˆë‹¬/ì§€ë‚œë‹¬ ê³„ì‚°
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
  const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;
  
  const getMonthFromSettlement = (s) => {
    if (!s.settlementDate) return null;
    const d = new Date(s.settlementDate);
    return { month: d.getMonth(), year: d.getFullYear() };
  };
  
  const thisMonthRevenue = state.sellerSettlements.filter(s => {
    const md = getMonthFromSettlement(s);
    return md && md.month === thisMonth && md.year === thisYear;
  }).reduce((sum, s) => {
    if (s.productType === 'inhouse') return sum + (Number(s.salesAmount) || 0);
    return sum + (Number(s.revenueAmount) || 0);
  }, 0);
  
  const lastMonthRevenue = state.sellerSettlements.filter(s => {
    const md = getMonthFromSettlement(s);
    return md && md.month === lastMonth && md.year === lastMonthYear;
  }).reduce((sum, s) => {
    if (s.productType === 'inhouse') return sum + (Number(s.salesAmount) || 0);
    return sum + (Number(s.revenueAmount) || 0);
  }, 0);
  
  const monthGrowth = lastMonthRevenue > 0 ? (((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100).toFixed(1) : (thisMonthRevenue > 0 ? 100 : 0);
  
  // ì •ì‚°ëŒ€ê¸° ê±´ìˆ˜ (supplierPendingì€ sellerExternalPendingê³¼ ì¤‘ë³µë˜ë¯€ë¡œ ì œì™¸)
  const pendingCount = sellerInhousePending.length + sellerExternalPending.length;
  const completedCount = sellerInhouseCompleted.length + sellerExternalCompleted.length;
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ“Š ë§¤ì¶œê´€ë¦¬ ë‚´ì—­ì„œ</h1>
      <p class="page-desc">ë‚´ë¶€ ê²½ì˜ë¶€ ì œì¶œìš© | ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° ê¸°ë°˜ ë§¤ì¶œ ê´€ë¦¬</p>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openUnifiedSettlementModal()">â• ì •ì‚° ì¶”ê°€</button>
        <button class="btn btn-secondary" onclick="generateManagementReport()">ğŸ“‹ ê²½ì˜íŒ€ ì •ì‚°ì„œ</button>
        <div class="help-tooltip-wrapper" style="position: relative; display: inline-block; margin-left: 8px;">
          <button type="button" class="help-tooltip-btn" style="width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--gray-300); background: var(--white); color: var(--gray-500); font-size: 14px; font-weight: 600; cursor: help; display: flex; align-items: center; justify-content: center;">?</button>
          <div class="help-tooltip-content" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; width: 420px; background: var(--white); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 16px; z-index: 100; border: 1px solid var(--gray-200);">
            <div style="font-weight: 700; color: var(--gray-900); margin-bottom: 12px; font-size: 14px;">ğŸ’¡ ë§¤ì¶œ ë° ë¹„ìš© êµ¬ì¡°</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div style="background: var(--info-light); border-radius: 8px; padding: 12px;">
                <div style="font-weight: 600; color: var(--info); margin-bottom: 6px; font-size: 13px;">1. ìì‚¬ ìƒí’ˆ</div>
                <div style="font-size: 12px; color: var(--gray-700); line-height: 1.6;">
                  â€¢ ë§¤ì¶œê¸ˆì•¡ = íŒë§¤ê¸ˆì•¡<br>
                  â€¢ ë¹„ìš© = ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ<br>
                  <span style="color: var(--info); font-weight: 500;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚°ë§Œ ì§„í–‰</span>
                </div>
              </div>
              <div style="background: var(--success-light); border-radius: 8px; padding: 12px;">
                <div style="font-weight: 600; color: var(--success); margin-bottom: 6px; font-size: 13px;">2. íƒ€ì‚¬ ìƒí’ˆ</div>
                <div style="font-size: 12px; color: var(--gray-700); line-height: 1.6;">
                  â€¢ ë§¤ì¶œê¸ˆì•¡ = íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ê°€ì•¡<br>
                  â€¢ ë¹„ìš© = ê³µê¸‰ê°€ì•¡ + ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ<br>
                  <span style="color: var(--success); font-weight: 500;">ğŸ‘¤ ì…€ëŸ¬ + ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚°</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ===== ë©”ì¸ ì§€í‘œ (4ê°œ) ===== -->
    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
      <div class="stat-card">
        <div class="stat-label">ì´ íŒë§¤ê¸ˆì•¡</div>
        <div class="stat-value" style="font-size: 24px;">${totalSalesAmount.toLocaleString()}ì›</div>
        <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ì‹¤ì œ ê±°ë˜ì•¡</div>
      </div>
      <div class="stat-card highlight" style="position: relative;">
        <div class="stat-label" style="display: flex; align-items: center; gap: 6px;">
          ì´ ë§¤ì¶œê¸ˆì•¡
          <div class="help-tooltip-wrapper" style="position: relative; display: inline-block;">
            <span style="width: 16px; height: 16px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.2); color: #fff; font-size: 10px; font-weight: 600; cursor: help; display: inline-flex; align-items: center; justify-content: center;">?</span>
            <div class="help-tooltip-content" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; width: 220px; background: var(--gray-900); border-radius: 8px; padding: 12px; z-index: 100; font-size: 12px; color: #fff; line-height: 1.5;">
              <strong>íƒ€ì‚¬ ìƒí’ˆì˜ ê³µê¸‰ê°€ì•¡ì´ ì œì™¸</strong>ëœ ê¸ˆì•¡ì…ë‹ˆë‹¤.<br><br>
              ìì‚¬: íŒë§¤ê¸ˆì•¡ ê·¸ëŒ€ë¡œ<br>
              íƒ€ì‚¬: íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ê°€ì•¡
            </div>
          </div>
        </div>
        <div class="stat-value" style="font-size: 24px;">${totalRevenue.toLocaleString()}ì›</div>
        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">íšŒê³„ìƒ ë§¤ì¶œ</div>
      </div>
      <div class="stat-card" style="background: #fff8f0; position: relative;">
        <div class="stat-label" style="color: var(--gray-700); display: flex; align-items: center; gap: 6px;">
          ì´ ë¶€ê°€ë¹„ìš©
          <div class="help-tooltip-wrapper" style="position: relative; display: inline-block;">
            <span style="width: 16px; height: 16px; border-radius: 50%; border: 1px solid var(--gray-400); background: transparent; color: var(--gray-500); font-size: 10px; font-weight: 600; cursor: help; display: inline-flex; align-items: center; justify-content: center;">?</span>
            <div class="help-tooltip-content" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; width: 260px; background: var(--gray-900); border-radius: 8px; padding: 12px; z-index: 100; font-size: 12px; color: #fff; line-height: 1.8;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>ğŸ‘¤ ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ</span><span>${totalSellerCost.toLocaleString()}ì›</span></div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>ğŸ­ ê³µê¸‰ì‚¬ ì§€ê¸‰</span><span>${totalSupplierCost.toLocaleString()}ì›</span></div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>ğŸ’³ PGìˆ˜ìˆ˜ë£Œ(4%)</span><span>${pgFee.toLocaleString()}ì›</span></div>
              <div style="display: flex; justify-content: space-between;"><span>ğŸ ì´ë²¤íŠ¸ë¹„ìš©</span><span>${totalEventCost.toLocaleString()}ì›</span></div>
              <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 8px; padding-top: 8px; font-weight: 600; display: flex; justify-content: space-between;"><span>í•©ê³„</span><span>${totalCost.toLocaleString()}ì›</span></div>
            </div>
          </div>
        </div>
        <div class="stat-value" style="font-size: 24px; color: var(--gray-900);">${totalCost.toLocaleString()}ì›</div>
        <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬+ê³µê¸‰ì‚¬+PG+ì´ë²¤íŠ¸</div>
      </div>
      <div class="stat-card" style="background: #fff8f0;">
        <div class="stat-label" style="color: var(--gray-700);">ìˆœì´ìµ</div>
        <div class="stat-value" style="font-size: 24px; color: var(--gray-900);">${totalProfit.toLocaleString()}ì›</div>
        <div style="font-size: 13px; color: var(--primary); margin-top: 4px; font-weight: 700;">ì´ìµë¥  ${profitRate}%</div>
      </div>
    </div>
    
    <!-- ===== ì„œë¸Œ ì§€í‘œ (5ê°œ) - ê¹”ë”í•œ í°ìƒ‰ ===== -->
    <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
        <div style="text-align: center; padding: 12px 8px; border-right: 1px solid var(--gray-200);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">â³ ì •ì‚°ëŒ€ê¸° ê¸ˆì•¡</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${pendingTotalAmount.toLocaleString()}ì›</div>
          <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">${pendingCount}ê±´ ëŒ€ê¸°ì¤‘</div>
        </div>
        <div style="text-align: center; padding: 12px 8px; border-right: 1px solid var(--gray-200);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ğŸ“… ì´ë²ˆë‹¬ ë§¤ì¶œ</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${thisMonthRevenue.toLocaleString()}ì›</div>
          <div style="font-size: 11px; color: ${Number(monthGrowth) >= 0 ? 'var(--success)' : 'var(--danger)'}; margin-top: 4px; font-weight: 600;">
            ${Number(monthGrowth) >= 0 ? 'â–²' : 'â–¼'} ì „ì›”ëŒ€ë¹„ ${Math.abs(monthGrowth)}%
          </div>
        </div>
        <div style="text-align: center; padding: 12px 8px; border-right: 1px solid var(--gray-200);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ğŸ“… ì§€ë‚œë‹¬ ë§¤ì¶œ</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${lastMonthRevenue.toLocaleString()}ì›</div>
          <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">${lastMonth + 1}ì›” ì‹¤ì </div>
        </div>
        <div style="text-align: center; padding: 12px 8px; border-right: 1px solid var(--gray-200);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ğŸ“¦ ê³µêµ¬ ê±´ìˆ˜</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${totalDealCount}ê±´</div>
          <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬+ê³µê¸‰ì‚¬ ì •ì‚°</div>
        </div>
        <div style="text-align: center; padding: 12px 8px;">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ğŸ’° í‰ê·  ê°ë‹¨ê°€</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${avgOrderValue.toLocaleString()}ì›</div>
          <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ì´ ${totalQuantity}ê°œ íŒë§¤</div>
        </div>
      </div>
    </div>
    
    <!-- ========== ì •ì‚°ëŒ€ê¸° ì„¹ì…˜ ========== -->
    <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
      <span style="font-size: 24px;">â³</span>
      <div>
        <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--gray-600);">ì •ì‚°ëŒ€ê¸°</h2>
        <p style="margin: 4px 0 0; font-size: 13px; color: #b45309;">ì•„ë˜ í•­ëª©ë“¤ì€ ê²½ì˜íŒ€ ì •ì‚°ì„œì— í¬í•¨ë©ë‹ˆë‹¤</p>
      </div>
      <span style="margin-left: auto; background: #dc2626; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 14px;">${pendingCount}ê±´</span>
    </div>
    
    <!-- 1 ìì‚¬ ìƒí’ˆ ì…€ëŸ¬ ì •ì‚° (ëŒ€ê¸°) -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="card-title" style="color: var(--info); margin: 0; display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--info); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">1</span>
          ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚°
        </h2>
        <span class="status-badge" style="background: var(--gray-100); color: var(--gray-600);">${sellerInhousePending.length}ê±´ ëŒ€ê¸°</span>
      </div>
      ${sellerInhousePending.length === 0 ? '<div style="text-align: center; padding: 20px; color: var(--gray-500);">âœ… ì •ì‚°ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>' : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead><tr><th>ì…€ëŸ¬ëª…</th><th>ë¸Œëœë“œ</th><th>ê³µêµ¬ê¸°ê°„</th><th style="text-align:center;">ìˆ˜ëŸ‰</th><th style="text-align:right;">íŒë§¤ê¸ˆì•¡</th><th style="text-align:right;color:var(--danger);">ë§ˆì§„ê¸ˆì•¡</th><th style="text-align:right;">ì›ì²œì„¸</th><th style="text-align:right;color:var(--success);">ì‹¤ì§€ê¸‰ì•¡</th><th>ì •ì‚°ì¼</th><th style="text-align:center;">ê´€ë¦¬</th></tr></thead>
            <tbody>
              ${sellerInhousePending.map(s => `<tr><td><strong>${s.sellerName||'-'}</strong></td><td><span class="status-badge status-confirmed">${s.brandName||'-'}</span></td><td style="font-size:13px;">${s.dealPeriod||'-'}</td><td style="text-align:center;font-weight:600;">${s.totalQuantity||'-'}</td><td style="text-align:right;font-weight:600;">${Number(s.salesAmount||0).toLocaleString()}ì›</td><td style="text-align:right;color:var(--danger);">${Number(s.marginAmount||0).toLocaleString()}ì›</td><td style="text-align:right;font-size:12px;">${Number(s.withholdingTax||0).toLocaleString()}ì›</td><td style="text-align:right;color:var(--success);font-weight:600;">${Number(s.actualPayment||0).toLocaleString()}ì›</td><td>${s.settlementDate||'-'}</td><td class="actions" style="white-space:nowrap;"><div style="display:flex;flex-direction:column;gap:6px;align-items:center;"><div style="display:flex;gap:4px;"><button class="btn btn-secondary btn-sm" onclick="openUnifiedSettlementModal(state.sellerSettlements.find(x=>x.id==='${s.id}'))">ìˆ˜ì •</button><button class="btn btn-secondary btn-sm" onclick="generateSellerStatement('${s.id}')">ğŸ“„</button></div><label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--gray-600);cursor:pointer;"><input type="checkbox" onchange="toggleSettlementComplete('seller','${s.id}',true)" style="width:16px;height:16px;cursor:pointer;"><span>ì™„ë£Œ</span></label></div></td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
    
    <!-- 2 íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (ëŒ€ê¸°) - í†µí•© -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="card-title" style="color: var(--success); margin: 0; display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--success); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">2</span>
          íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚°
        </h2>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button class="btn btn-secondary btn-sm" onclick="openSupplierProductModal()">ğŸ“¦ ìƒí’ˆê´€ë¦¬</button>
          <span class="status-badge" style="background: var(--gray-100); color: var(--gray-600);">${sellerExternalPending.length}ê±´ ëŒ€ê¸°</span>
        </div>
      </div>
      ${sellerExternalPending.length === 0 ? '<div style="text-align: center; padding: 20px; color: var(--gray-500);">âœ… ì •ì‚°ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>' : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th rowspan="2" style="vertical-align:middle;">ì…€ëŸ¬ëª…</th>
                <th rowspan="2" style="vertical-align:middle;">ë¸Œëœë“œ(ê³µê¸‰ì‚¬)</th>
                <th rowspan="2" style="vertical-align:middle;">ê³µêµ¬ê¸°ê°„</th>
                <th rowspan="2" style="text-align:center;vertical-align:middle;">ìˆ˜ëŸ‰</th>
                <th rowspan="2" style="text-align:right;vertical-align:middle;">íŒë§¤ê¸ˆì•¡</th>
                <th colspan="3" style="text-align:center;background:#dcfce7;border-bottom:1px solid var(--gray-300);">ì…€ëŸ¬ ì •ì‚°</th>
                <th colspan="3" style="text-align:center;background:#fef9c3;border-bottom:1px solid var(--gray-300);">ê³µê¸‰ì‚¬ ì •ì‚°</th>
                <th rowspan="2" style="vertical-align:middle;">ì •ì‚°ì¼</th>
                <th rowspan="2" style="text-align:center;vertical-align:middle;">ê´€ë¦¬</th>
              </tr>
              <tr>
                <th style="text-align:right;background:#dcfce7;font-size:11px;">ë§ˆì§„ê¸ˆì•¡</th>
                <th style="text-align:right;background:#dcfce7;font-size:11px;">ì›ì²œì„¸</th>
                <th style="text-align:right;background:#dcfce7;font-size:11px;">ì‹¤ì§€ê¸‰ì•¡</th>
                <th style="text-align:right;background:#fef9c3;font-size:11px;">ê³µê¸‰ê°€ì•¡</th>
                <th style="text-align:right;background:#fef9c3;font-size:11px;">ë¶€ê°€ì„¸</th>
                <th style="text-align:right;background:#fef9c3;font-size:11px;">ì •ì‚°ê¸ˆì•¡(V+)</th>
              </tr>
            </thead>
            <tbody>
              ${sellerExternalPending.map(s => {
                // ì—°ê²°ëœ ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸°
                const supplierData = state.supplierSettlements.find(sup => 
                  sup.sellerName === s.sellerName && 
                  sup.brandName === s.brandName && 
                  sup.dealPeriod === s.dealPeriod
                ) || {};
                const supplierId = supplierData.id || '';
                return `<tr>
                  <td><strong>${s.sellerName||'-'}</strong></td>
                  <td><span class="status-badge status-negotiating">${s.brandName||'-'}</span></td>
                  <td style="font-size:13px;">${s.dealPeriod||'-'}</td>
                  <td style="text-align:center;font-weight:600;">${s.totalQuantity||'-'}</td>
                  <td style="text-align:right;font-weight:600;">${Number(s.salesAmount||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;background:#f0fdf4;">${Number(s.marginAmount||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;background:#f0fdf4;font-size:12px;">${Number(s.withholdingTax||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;background:#f0fdf4;font-weight:600;">${Number(s.actualPayment||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;background:#fefce8;">${Number(supplierData.totalSupplyAmount||s.supplyAmount||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;background:#fefce8;font-size:12px;">${Number(supplierData.totalVatAmount||s.vatAmount||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;background:#fefce8;font-weight:600;">${Number(supplierData.totalAmount||s.supplierTotalAmount||0).toLocaleString()}ì›</td>
                  <td>${s.settlementDate||'-'}</td>
                  <td class="actions" style="white-space:nowrap;">
                    <div style="display:flex;flex-direction:column;gap:6px;align-items:center;">
                      <div style="display:flex;gap:4px;">
                        <button class="btn btn-secondary btn-sm" onclick="openUnifiedSettlementModal(state.sellerSettlements.find(x=>x.id==='${s.id}'))">ìˆ˜ì •</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateSellerStatement('${s.id}')" title="ì…€ëŸ¬ ì •ì‚°ì„œ">ğŸ‘¤</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateSupplierStatement('${s.id}')" title="ê³µê¸‰ì‚¬ ì •ì‚°ì„œ">ğŸ­</button>
                      </div>
                      <div style="display:flex;flex-direction:column;gap:3px;font-size:10px;">
                        <label style="display:flex;align-items:center;gap:3px;color:#16a34a;cursor:pointer;">
                          <input type="checkbox" ${s.isSellerCompleted ? 'checked' : ''} onchange="toggleExternalSettlement('seller','${s.id}',this.checked)" style="width:14px;height:14px;cursor:pointer;accent-color:#16a34a;">
                          <span>ì…€ëŸ¬ì™„ë£Œ</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:3px;color:#ca8a04;cursor:pointer;">
                          <input type="checkbox" ${supplierData.isCompleted ? 'checked' : ''} onchange="toggleExternalSettlement('supplier','${supplierId}',this.checked)" style="width:14px;height:14px;cursor:pointer;accent-color:#ca8a04;" ${!supplierId ? 'disabled title="ê³µê¸‰ì‚¬ ì •ì‚° ë°ì´í„° ì—†ìŒ"' : ''}>
                          <span>ê³µê¸‰ì‚¬ì™„ë£Œ</span>
                        </label>
                      </div>
                    </div>
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
          ğŸ’¡ <span style="color: #16a34a;">ë…¹ìƒ‰ ì˜ì—­</span>: ì…€ëŸ¬ ì •ì‚° í•­ëª© | <span style="color: #ca8a04;">ë…¸ë€ìƒ‰ ì˜ì—­</span>: ê³µê¸‰ì‚¬ ì •ì‚° í•­ëª©
        </div>
      `}
    </div>
    
    <!-- ========== ì •ì‚°ì™„ë£Œ ì„¹ì…˜ (ì ‘ê¸°/í¼ì¹˜ê¸°) ========== -->
    ${completedCount > 0 ? `
    <div style="margin-top: 32px;">
      <div onclick="toggleCompletedSection()" style="background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px 20px; margin-bottom: ${completedSectionCollapsed ? '0' : '24px'}; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s;">
        <span style="font-size: 24px;">âœ…</span>
        <div>
          <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: #065f46;">ì •ì‚°ì™„ë£Œ</h2>
          <p style="margin: 4px 0 0; font-size: 13px; color: #047857;">í´ë¦­í•˜ì—¬ ${completedSectionCollapsed ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}</p>
        </div>
        <span style="margin-left: auto; background: #059669; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 14px;">${completedCount}ê±´</span>
        <span style="font-size: 20px; color: #065f46;">${completedSectionCollapsed ? 'â–¼' : 'â–²'}</span>
      </div>
      
      <div id="completed-section" style="display: ${completedSectionCollapsed ? 'none' : 'block'};">
        <!-- 1 ìì‚¬ ìƒí’ˆ ì…€ëŸ¬ ì •ì‚° (ì™„ë£Œ) -->
        ${sellerInhouseCompleted.length > 0 ? `
        <div class="card" style="border-left: 4px solid #059669;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="card-title" style="color: var(--info); margin: 0; display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--info); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">1</span>
              ìì‚¬ ìƒí’ˆ - ì…€ëŸ¬ ì •ì‚°
            </h2>
            <span class="status-badge" style="background: #d1fae5; color: #065f46;">${sellerInhouseCompleted.length}ê±´ ì™„ë£Œ</span>
          </div>
          <div style="overflow-x: auto;">
            <table class="data-table">
              <thead><tr><th>ì…€ëŸ¬ëª…</th><th>ë¸Œëœë“œ</th><th>ê³µêµ¬ê¸°ê°„</th><th style="text-align:center;">ìˆ˜ëŸ‰</th><th style="text-align:right;">íŒë§¤ê¸ˆì•¡</th><th style="text-align:right;">ë§ˆì§„ê¸ˆì•¡</th><th style="text-align:right;">ì›ì²œì„¸</th><th style="text-align:right;">ì‹¤ì§€ê¸‰ì•¡</th><th>ì •ì‚°ì¼</th><th style="text-align:center;">ê´€ë¦¬</th></tr></thead>
              <tbody>
                ${sellerInhouseCompleted.map(s => `<tr style="opacity:0.7;"><td><strong>${s.sellerName||'-'}</strong></td><td><span class="status-badge status-confirmed">${s.brandName||'-'}</span></td><td style="font-size:13px;">${s.dealPeriod||'-'}</td><td style="text-align:center;">${s.totalQuantity||'-'}</td><td style="text-align:right;">${Number(s.salesAmount||0).toLocaleString()}ì›</td><td style="text-align:right;">${Number(s.marginAmount||0).toLocaleString()}ì›</td><td style="text-align:right;">${Number(s.withholdingTax||0).toLocaleString()}ì›</td><td style="text-align:right;">${Number(s.actualPayment||0).toLocaleString()}ì›</td><td>${s.settlementDate||'-'}</td><td class="actions" style="white-space:nowrap;"><div style="display:flex;flex-direction:column;gap:6px;align-items:center;"><div style="display:flex;gap:4px;"><button class="btn btn-secondary btn-sm" onclick="openUnifiedSettlementModal(state.sellerSettlements.find(x=>x.id==='${s.id}'))">ìˆ˜ì •</button><button class="btn btn-secondary btn-sm" onclick="generateSellerStatement('${s.id}')">ğŸ“„</button></div><label style="display:flex;align-items:center;gap:4px;font-size:11px;color:#065f46;cursor:pointer;"><input type="checkbox" checked onchange="toggleSettlementComplete('seller','${s.id}',false)" style="width:16px;height:16px;cursor:pointer;"><span>ì™„ë£Œ</span></label></div></td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>
        ` : ''}
        
        <!-- 2 íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° (ì™„ë£Œ) - í†µí•© -->
        ${sellerExternalCompleted.length > 0 ? `
        <div class="card" style="border-left: 4px solid #059669;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="card-title" style="color: var(--success); margin: 0; display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--success); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">2</span>
              íƒ€ì‚¬ ìƒí’ˆ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚°
            </h2>
            <span class="status-badge" style="background: #d1fae5; color: #065f46;">${sellerExternalCompleted.length}ê±´ ì™„ë£Œ</span>
          </div>
          <div style="overflow-x: auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th rowspan="2" style="vertical-align:middle;">ì…€ëŸ¬ëª…</th>
                  <th rowspan="2" style="vertical-align:middle;">ë¸Œëœë“œ(ê³µê¸‰ì‚¬)</th>
                  <th rowspan="2" style="vertical-align:middle;">ê³µêµ¬ê¸°ê°„</th>
                  <th rowspan="2" style="text-align:center;vertical-align:middle;">ìˆ˜ëŸ‰</th>
                  <th rowspan="2" style="text-align:right;vertical-align:middle;">íŒë§¤ê¸ˆì•¡</th>
                  <th colspan="3" style="text-align:center;background:#dcfce7;border-bottom:1px solid var(--gray-300);">ì…€ëŸ¬ ì •ì‚°</th>
                  <th colspan="3" style="text-align:center;background:#fef9c3;border-bottom:1px solid var(--gray-300);">ê³µê¸‰ì‚¬ ì •ì‚°</th>
                  <th rowspan="2" style="vertical-align:middle;">ì •ì‚°ì¼</th>
                  <th rowspan="2" style="text-align:center;vertical-align:middle;">ê´€ë¦¬</th>
                </tr>
                <tr>
                  <th style="text-align:right;background:#dcfce7;font-size:11px;">ë§ˆì§„ê¸ˆì•¡</th>
                  <th style="text-align:right;background:#dcfce7;font-size:11px;">ì›ì²œì„¸</th>
                  <th style="text-align:right;background:#dcfce7;font-size:11px;">ì‹¤ì§€ê¸‰ì•¡</th>
                  <th style="text-align:right;background:#fef9c3;font-size:11px;">ê³µê¸‰ê°€ì•¡</th>
                  <th style="text-align:right;background:#fef9c3;font-size:11px;">ë¶€ê°€ì„¸</th>
                  <th style="text-align:right;background:#fef9c3;font-size:11px;">ì •ì‚°ê¸ˆì•¡(V+)</th>
                </tr>
              </thead>
              <tbody>
                ${sellerExternalCompleted.map(s => {
                  const supplierData = state.supplierSettlements.find(sup => 
                    sup.sellerName === s.sellerName && 
                    sup.brandName === s.brandName && 
                    sup.dealPeriod === s.dealPeriod
                  ) || {};
                  return `<tr style="opacity:0.7;">
                    <td><strong>${s.sellerName||'-'}</strong></td>
                    <td><span class="status-badge status-negotiating">${s.brandName||'-'}</span></td>
                    <td style="font-size:13px;">${s.dealPeriod||'-'}</td>
                    <td style="text-align:center;">${s.totalQuantity||'-'}</td>
                    <td style="text-align:right;">${Number(s.salesAmount||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#f0fdf4;">${Number(s.marginAmount||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#f0fdf4;font-size:12px;">${Number(s.withholdingTax||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#f0fdf4;">${Number(s.actualPayment||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#fefce8;">${Number(supplierData.totalSupplyAmount||s.supplyAmount||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#fefce8;font-size:12px;">${Number(supplierData.totalVatAmount||s.vatAmount||0).toLocaleString()}ì›</td>
                    <td style="text-align:right;background:#fefce8;">${Number(supplierData.totalAmount||s.supplierTotalAmount||0).toLocaleString()}ì›</td>
                    <td>${s.settlementDate||'-'}</td>
                    <td class="actions" style="white-space:nowrap;">
                      <div style="display:flex;flex-direction:column;gap:6px;align-items:center;">
                        <div style="display:flex;gap:4px;">
                          <button class="btn btn-secondary btn-sm" onclick="openUnifiedSettlementModal(state.sellerSettlements.find(x=>x.id==='${s.id}'))">ìˆ˜ì •</button>
                          <button class="btn btn-secondary btn-sm" onclick="generateSellerStatement('${s.id}')" title="ì…€ëŸ¬ ì •ì‚°ì„œ">ğŸ‘¤</button>
                          <button class="btn btn-secondary btn-sm" onclick="generateSupplierStatement('${s.id}')" title="ê³µê¸‰ì‚¬ ì •ì‚°ì„œ">ğŸ­</button>
                        </div>
                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--gray-600);cursor:pointer;">
                          <input type="checkbox" checked onchange="toggleSettlementComplete('seller','${s.id}',false)" style="width:16px;height:16px;cursor:pointer;">
                          <span>ì™„ë£Œ</span>
                        </label>
                      </div>
                    </td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
        ` : ''}
      </div>
    </div>
    ` : ''}
    
    <!-- ì „ì²´ í•©ê³„ -->
    <div class="card" style="background: linear-gradient(135deg, var(--gray-900) 0%, #374151 100%); color: #fff;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="card-title" style="color: #fff; margin: 0;">ğŸ“ˆ ì „ì²´ ë§¤ì¶œ ìš”ì•½</h2>
        <span style="font-size: 12px; opacity: 0.7;">ì´ë²¤íŠ¸ë¹„ìš©ì€ ê° ì…€ëŸ¬ ì •ì‚°ì—ì„œ ì…ë ¥</span>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        <!-- ìì‚¬ ìƒí’ˆ -->
        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;">
          <div style="font-size: 13px; opacity: 0.8; margin-bottom: 12px;"><span style="background: var(--info); padding: 2px 8px; border-radius: 4px; font-size: 11px;">1</span> ìì‚¬ ìƒí’ˆ</div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ë§¤ì¶œ(=íŒë§¤ê¸ˆì•¡)</span><span style="font-weight: 600;">${inhouseTotals.salesAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ</span><span style="color: #fca5a5;">-${inhouseTotals.marginAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">PGìˆ˜ìˆ˜ë£Œ(4%)</span><span style="color: #fca5a5;">-${inhousePgFee.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ì´ë²¤íŠ¸ë¹„ìš©</span><span style="color: #fca5a5;">-${inhouseTotals.eventCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);"><span>ìˆœì´ìµ</span><span style="font-weight: 700; color: ${inhouseProfit >= 0 ? '#86efac' : '#fca5a5'};">${inhouseProfit.toLocaleString()}ì›</span></div>
        </div>
        <!-- íƒ€ì‚¬ ìƒí’ˆ -->
        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;">
          <div style="font-size: 13px; opacity: 0.8; margin-bottom: 12px;"><span style="background: var(--success); padding: 2px 8px; border-radius: 4px; font-size: 11px;">2</span> íƒ€ì‚¬ ìƒí’ˆ</div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">íŒë§¤ê¸ˆì•¡</span><span style="font-weight: 600;">${externalSellerTotals.salesAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ê³µê¸‰ì‚¬ì •ì‚°</span><span style="color: #fca5a5;">-${supplierTotals.totalAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ</span><span style="color: #fca5a5;">-${externalSellerTotals.marginAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">PGìˆ˜ìˆ˜ë£Œ(4%)</span><span style="color: #fca5a5;">-${externalPgFee.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.7;">ì´ë²¤íŠ¸ë¹„ìš©</span><span style="color: #fca5a5;">-${externalSellerTotals.eventCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);"><span>ìˆœìˆ˜ìµ</span><span style="font-weight: 700; color: ${externalProfit >= 0 ? '#86efac' : '#fca5a5'};">${externalProfit.toLocaleString()}ì›</span></div>
        </div>
        <!-- ì´ í•©ê³„ -->
        <div style="background: linear-gradient(135deg, var(--primary) 0%, #e08600 100%); border-radius: 12px; padding: 20px;">
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">ğŸ† ì´ í•©ê³„</div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">ì´ íŒë§¤ê¸ˆì•¡</span><span style="font-weight: 600;">${totalSalesAmount.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed rgba(255,255,255,0.3);"><span style="opacity: 0.8;">ì´ ë§¤ì¶œê¸ˆì•¡ <small style="font-size:10px;">(ê³µê¸‰ê°€ ì œì™¸)</small></span><span style="font-weight: 700; font-size: 16px;">${totalRevenue.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">ì…€ëŸ¬ìˆ˜ìˆ˜ë£Œ</span><span>-${totalSellerCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">ê³µê¸‰ì‚¬ì •ì‚°</span><span>-${totalSupplierCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">PGìˆ˜ìˆ˜ë£Œ(4%)</span><span>-${pgFee.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><span style="opacity: 0.8;">ì´ë²¤íŠ¸ë¹„ìš©</span><span>-${totalEventCost.toLocaleString()}ì›</span></div>
          <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);"><span style="font-weight: 600;">ì´ ìˆœì´ìµ</span><span style="font-size: 20px; font-weight: 800; color: ${totalProfit >= 0 ? '#fff' : '#fca5a5'};">${totalProfit.toLocaleString()}ì›</span></div>
        </div>
      </div>
    </div>
  `;
}

// ì •ì‚°ì™„ë£Œ ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸°
function toggleCompletedSection() {
  completedSectionCollapsed = !completedSectionCollapsed;
  renderSalesReport();
}

// ì •ì‚°ì™„ë£Œ ìƒíƒœ í† ê¸€
async function toggleSettlementComplete(type, id, setComplete, target) {
  // target: undefined (ê¸°ë³¸), 'seller' (ì…€ëŸ¬ë§Œ), 'supplier' (ê³µê¸‰ì‚¬ë§Œ)
  try {
    const collection = type === 'seller' ? 'sellerSettlements' : 'supplierSettlements';
    const doc = await db.collection(collection).doc(id).get();
    const data = doc.data();
    
    // targetì´ ì—†ê±°ë‚˜ ìì‚¬ ìƒí’ˆì¸ ê²½ìš°: ë‘˜ ë‹¤ ì™„ë£Œ ì²˜ë¦¬
    if (!target || data?.productType === 'inhouse') {
      await db.collection(collection).doc(id).update({
        isCompleted: setComplete,
        isSellerCompleted: setComplete,
        isSupplierCompleted: setComplete,
        completedAt: setComplete ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ì •ì‚°ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤' : 'â³ ì •ì‚°ëŒ€ê¸°ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
    } 
    // íƒ€ì‚¬ ìƒí’ˆ: ì…€ëŸ¬ë§Œ ì²˜ë¦¬
    else if (target === 'seller') {
      const isSupplierDone = data?.isSupplierCompleted || false;
      const bothDone = setComplete && isSupplierDone;
      await db.collection(collection).doc(id).update({
        isSellerCompleted: setComplete,
        isCompleted: bothDone,
        completedAt: bothDone ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ì…€ëŸ¬ ì •ì‚°ì™„ë£Œ' : 'â³ ì…€ëŸ¬ ì •ì‚°ëŒ€ê¸°');
    } 
    // íƒ€ì‚¬ ìƒí’ˆ: ê³µê¸‰ì‚¬ë§Œ ì²˜ë¦¬
    else if (target === 'supplier') {
      const isSellerDone = data?.isSellerCompleted || false;
      const bothDone = setComplete && isSellerDone;
      await db.collection(collection).doc(id).update({
        isSupplierCompleted: setComplete,
        isCompleted: bothDone,
        completedAt: bothDone ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ê³µê¸‰ì‚¬ ì •ì‚°ì™„ë£Œ' : 'â³ ê³µê¸‰ì‚¬ ì •ì‚°ëŒ€ê¸°');
    }
  } catch (err) {
    console.error(err);
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ğŸ†• íƒ€ì‚¬ ìƒí’ˆ ì „ìš© ì •ì‚° ì™„ë£Œ í† ê¸€ - ì…€ëŸ¬/ê³µê¸‰ì‚¬ ê°ê° ë³„ë„ ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸
async function toggleExternalSettlement(type, id, setComplete) {
  if (!id) {
    showToast('ì •ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  try {
    if (type === 'seller') {
      // sellerSettlements ì—…ë°ì´íŠ¸
      await db.collection('sellerSettlements').doc(id).update({
        isSellerCompleted: setComplete,
        isCompleted: setComplete,
        completedAt: setComplete ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ì…€ëŸ¬ ì •ì‚°ì™„ë£Œ' : 'â³ ì…€ëŸ¬ ì •ì‚°ëŒ€ê¸°');
    } 
    else if (type === 'supplier') {
      // supplierSettlements ì—…ë°ì´íŠ¸ (ë³„ë„ ì»¬ë ‰ì…˜!)
      await db.collection('supplierSettlements').doc(id).update({
        isCompleted: setComplete,
        completedAt: setComplete ? new Date().toISOString() : null
      });
      showToast(setComplete ? 'âœ… ê³µê¸‰ì‚¬ ì •ì‚°ì™„ë£Œ' : 'â³ ê³µê¸‰ì‚¬ ì •ì‚°ëŒ€ê¸°');
    }
  } catch (err) {
    console.error(err);
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}


function openSellerSettlementTypeModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header"><h2 class="modal-title">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚° ì¶”ê°€</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      <div style="padding: 20px 0;">
        <p style="text-align: center; color: var(--gray-600); margin-bottom: 24px;">ì •ì‚°í•  ìƒí’ˆ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div onclick="closeModal(); openSellerSettlementModal('inhouse')" style="background: var(--info-light); border: 2px solid var(--info); border-radius: 16px; padding: 24px; cursor: pointer; text-align: center; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
            <div style="font-size: 36px; margin-bottom: 12px;">ğŸ </div>
            <div style="font-size: 18px; font-weight: 700; color: var(--info); margin-bottom: 8px;">1-1. ìì‚¬ ìƒí’ˆ</div>
            <div style="font-size: 13px; color: var(--gray-600);">íŒë§¤ê¸ˆì•¡ = ë§¤ì¶œê¸ˆì•¡<br>ì…€ëŸ¬ ë§ˆì§„% ì ìš©</div>
          </div>
          <div onclick="closeModal(); openSellerSettlementModal('external')" style="background: var(--success-light); border: 2px solid var(--success); border-radius: 16px; padding: 24px; cursor: pointer; text-align: center; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
            <div style="font-size: 36px; margin-bottom: 12px;">ğŸ­</div>
            <div style="font-size: 18px; font-weight: 700; color: var(--success); margin-bottom: 8px;">1-2. íƒ€ì‚¬ ìƒí’ˆ</div>
            <div style="font-size: 13px; color: var(--gray-600);">ë§¤ì¶œ = íŒë§¤ - ê³µê¸‰ê°€<br>ì…€ëŸ¬ ë§ˆì§„% ì ìš©</div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: center;"><button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button></div>
    </div>
  `;
}

function openSellerSettlementModal(productType, item = null) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const isEdit = item !== null;
  const isInhouse = productType === 'inhouse';
  const s = item || { productType, sellerName: '', brandName: '', dealPeriod: '', salesItems: [], salesAmount: '', supplyAmount: '', revenueAmount: '', marginAmount: '', withholdingTax: '', actualPayment: '', settlementDate: formatDate(new Date()), notes: '' };
  
  // ê³µê¸‰ì‚¬ ë°ì´í„° ì‚¬ìš©
  const suppliers = state.suppliers || [];
  
  // ë””ë²„ê¹…: ì½˜ì†”ì— ê³µê¸‰ì‚¬ ì •ë³´ ì¶œë ¥
  console.log('=== ì…€ëŸ¬ ì •ì‚° ëª¨ë‹¬ ===');
  console.log('productType:', productType, '(isInhouse:', isInhouse, ')');
  console.log('ì „ì²´ ê³µê¸‰ì‚¬:', suppliers.map(s => ({ name: s.name, supplierType: s.supplierType })));
  
  const filteredSuppliers = isInhouse 
    ? suppliers.filter(sup => sup.supplierType === 'inhouse')
    : suppliers.filter(sup => sup.supplierType !== 'inhouse' && sup.supplierType !== undefined);
  
  console.log('í•„í„°ë§ëœ ê³µê¸‰ì‚¬:', filteredSuppliers.map(s => s.name));
  
  const salesItems = s.salesItems || [];
  const totalQty = salesItems.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
  const totalAmount = salesItems.reduce((sum, i) => sum + (Number(i.amount) || 0), 0);
  const totalMargin = salesItems.reduce((sum, i) => sum + (Number(i.marginAmount) || 0), 0);
  const totalActualPayment = salesItems.reduce((sum, i) => sum + (Number(i.actualPayment) || 0), 0);
  
  // ê³µê¸‰ì‚¬ê°€ ì—†ì„ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€
  const noSuppliersMsg = filteredSuppliers.length === 0 ? `
    <div style="background: var(--gray-100); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
      <div style="font-size: 13px; color: var(--gray-600);">
        âš ï¸ ${isInhouse ? 'ìì‚¬' : 'íƒ€ì‚¬'} ìœ í˜•ì˜ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
        <a href="#" onclick="closeModal(); setTab('suppliers');" style="color: #d97706; text-decoration: underline;">ê³µê¸‰ì‚¬ ë©”ë‰´</a>ì—ì„œ ê³µê¸‰ì‚¬ë¥¼ ë“±ë¡í•˜ê³  ìœ í˜•ì„ '${isInhouse ? 'ìì‚¬' : 'íƒ€ì‚¬'}'ë¡œ ì„¤ì •í•˜ì„¸ìš”.
      </div>
    </div>
  ` : '';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 750px;">
      <div class="modal-header"><h2 class="modal-title">${isEdit ? 'ì…€ëŸ¬ ì •ì‚° ìˆ˜ì •' : 'ìƒˆ ì…€ëŸ¬ ì •ì‚° ë“±ë¡'}</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      <div style="background: ${isInhouse ? 'var(--info-light)' : 'var(--success-light)'}; border-radius: 12px; padding: 16px; margin-bottom: 20px; border-left: 4px solid ${isInhouse ? 'var(--info)' : 'var(--success)'};">
        <div style="font-weight: 600; color: ${isInhouse ? 'var(--info)' : 'var(--success)'};">${isInhouse ? '1-1. ìì‚¬ ìƒí’ˆ ì •ì‚°' : '1-2. íƒ€ì‚¬ ìƒí’ˆ ì •ì‚°'}</div>
        <div style="font-size: 13px; color: var(--gray-600);">${isInhouse ? 'íŒë§¤ê¸ˆì•¡ = ë§¤ì¶œê¸ˆì•¡, ë¹„ìš© = ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ (ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ì ìš©)' : 'ë§¤ì¶œê¸ˆì•¡ = íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ê°€ì•¡ (ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ì ìš©)'}</div>
      </div>
      ${noSuppliersMsg}
      <form onsubmit="submitSellerSettlement(event, '${s.id || ''}', '${productType}')">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì…€ëŸ¬ëª… * <span style="font-size: 11px; color: var(--gray-500);">(${state.sellers.length}ëª…)</span></label>
            <select class="form-input" id="ss-sellerName" required onchange="handleSellerNameChange(this)">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${state.sellers.map(sel => `<option value="${sel.name}" ${s.sellerName === sel.name ? 'selected' : ''}>${sel.name}</option>`).join('')}
              <option value="_other" ${s.sellerName && !state.sellers.find(sel => sel.name === s.sellerName) ? 'selected' : ''}>ì§ì ‘ ì…ë ¥...</option>
            </select>
            <input type="text" class="form-input" id="ss-sellerNameCustom" value="${s.sellerName && !state.sellers.find(sel => sel.name === s.sellerName) ? s.sellerName : ''}" placeholder="ì§ì ‘ ì…ë ¥" style="display: ${s.sellerName && !state.sellers.find(sel => sel.name === s.sellerName) ? 'block' : 'none'}; margin-top: 8px;">
          </div>
          <div class="form-group">
            <label class="form-label">ë¸Œëœë“œ(ê³µê¸‰ì‚¬) * <span style="font-size: 11px; color: var(--gray-500);">(${filteredSuppliers.length}ê°œ)</span></label>
            <select class="form-input" id="ss-brandName" required onchange="handleBrandChange(this)">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              ${filteredSuppliers.map(sup => `<option value="${sup.name}" ${s.brandName === sup.name ? 'selected' : ''}>${sup.name}</option>`).join('')}
              <option value="_other" ${s.brandName && !filteredSuppliers.find(sup => sup.name === s.brandName) ? 'selected' : ''}>ì§ì ‘ ì…ë ¥...</option>
            </select>
            <input type="text" class="form-input" id="ss-brandNameCustom" value="${s.brandName && !filteredSuppliers.find(sup => sup.name === s.brandName) ? s.brandName : ''}" placeholder="ì§ì ‘ ì…ë ¥" style="display: ${s.brandName && !filteredSuppliers.find(sup => sup.name === s.brandName) ? 'block' : 'none'}; margin-top: 8px;">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê³µêµ¬ ê¸°ê°„</label><input type="text" class="form-input" id="ss-dealPeriod" value="${s.dealPeriod}" placeholder="2025-11-27~2025-11-30"></div>
          <div class="form-group"><label class="form-label">ì •ì‚°ì¼</label><input type="date" class="form-input" id="ss-settlementDate" value="${s.settlementDate}"></div>
        </div>
        
        <!-- íŒë§¤ ê±´ ëª©ë¡ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <label class="form-label" style="margin: 0; font-weight: 600;">ğŸ“¦ íŒë§¤ ê±´ ëª©ë¡ (ìƒí’ˆë³„ ë§ˆì§„ìœ¨ ì„¤ì •)</label>
            <button type="button" class="btn btn-primary btn-sm" onclick="openSalesItemsEditor('${productType}')">+ íŒë§¤ê±´ ì¶”ê°€/í¸ì§‘</button>
          </div>
          <div id="ss-salesItemsList" style="max-height: 250px; overflow-y: auto;">
            ${salesItems.length === 0 ? '<div style="color: var(--gray-500); font-size: 13px; text-align: center; padding: 20px;">íŒë§¤ê±´ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>' : `
              <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                <thead><tr style="background: var(--gray-200);"><th style="padding: 6px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 6px; text-align: right;">íŒë§¤ë‹¨ê°€</th><th style="padding: 6px; text-align: right; background: var(--gray-50);">ê³µê¸‰ë‹¨ê°€</th><th style="padding: 6px; text-align: center;">ìˆ˜ëŸ‰</th><th style="padding: 6px; text-align: right;">íŒë§¤ê¸ˆì•¡</th><th style="padding: 6px; text-align: center;">ë§ˆì§„ìœ¨</th><th style="padding: 6px; text-align: right;">ë§ˆì§„ê¸ˆì•¡</th><th style="padding: 6px; text-align: right;">ì‹¤ì§€ê¸‰ì•¡</th></tr></thead>
                <tbody>${salesItems.map((item, i) => `<tr style="border-bottom: 1px solid var(--gray-200);"><td style="padding: 6px;">${item.productName || '-'}</td><td style="padding: 6px; text-align: right;">${Number(item.unitPrice || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; background: #fefce8;">${Number(item.supplyPrice || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: center;">${item.quantity || 0}</td><td style="padding: 6px; text-align: right;">${Number(item.amount || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: center; color: var(--primary);">${item.marginRate || 0}%</td><td style="padding: 6px; text-align: right; color: var(--danger);">${Number(item.marginAmount || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; color: var(--success);">${Number(item.actualPayment || 0).toLocaleString()}ì›</td></tr>`).join('')}</tbody>
                <tfoot><tr style="background: var(--gray-100); font-weight: 700;"><td style="padding: 6px;">í•©ê³„</td><td style="padding: 6px;"></td><td style="padding: 6px; background: var(--gray-50);"></td><td style="padding: 6px; text-align: center;">${totalQty}</td><td style="padding: 6px; text-align: right;">${totalAmount.toLocaleString()}ì›</td><td style="padding: 6px;"></td><td style="padding: 6px; text-align: right; color: var(--danger);">${totalMargin.toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; color: var(--success);">${totalActualPayment.toLocaleString()}ì›</td></tr></tfoot>
              </table>
            `}
          </div>
          <input type="hidden" id="ss-salesItems" value='${JSON.stringify(salesItems)}'>
        </div>
        
        <div class="form-row">
          <div class="form-group"><label class="form-label">ì´ íŒë§¤ê¸ˆì•¡</label><input type="number" class="form-input" id="ss-salesAmount" value="${s.salesAmount || totalAmount}" placeholder="íŒë§¤ê±´ í•©ê³„" style="background: var(--gray-50); font-weight: 600;" readonly></div>
          ${!isInhouse ? `<div class="form-group"><label class="form-label">ê³µê¸‰ê°€ì•¡ (VAT+)</label><input type="number" class="form-input" id="ss-supplyAmount" value="${s.supplyAmount || salesItems.reduce((sum, i) => sum + (Number(i.supplyPrice || 0) * Number(i.quantity || 0)), 0)}" placeholder="ìë™ ê³„ì‚°" style="background: var(--gray-50);" readonly></div>` : ''}
        </div>
        ${!isInhouse ? `<div class="form-group"><label class="form-label">ë§¤ì¶œê¸ˆì•¡ (íŒë§¤ - ê³µê¸‰)</label><input type="number" class="form-input" id="ss-revenueAmount" value="${s.revenueAmount}" placeholder="ìë™ ê³„ì‚°" style="background: var(--gray-50); font-weight: 600;" readonly></div>` : ''}
        <div class="form-row">
          <div class="form-group"><label class="form-label">ì´ ë§ˆì§„ê¸ˆì•¡ (ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ)</label><input type="number" class="form-input" id="ss-marginAmount" value="${s.marginAmount || totalMargin}" placeholder="íŒë§¤ê±´ í•©ê³„" style="background: var(--danger-light);" readonly></div>
          <div class="form-group"><label class="form-label">ì›ì²œì„¸ (3.3%)</label><input type="number" class="form-input" id="ss-withholdingTax" value="${s.withholdingTax || Math.round(totalMargin * 0.033)}" placeholder="ìë™ ê³„ì‚°" readonly></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ì…€ëŸ¬ ì‹¤ì§€ê¸‰ì•¡</label><input type="number" class="form-input" id="ss-actualPayment" value="${s.actualPayment || totalActualPayment}" placeholder="íŒë§¤ê±´ í•©ê³„" style="background: var(--success-light); font-weight: 600;" readonly></div>
          <div class="form-group">
            <label class="form-label">ğŸ ì´ë²¤íŠ¸ë¹„ìš© <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">(ì…€ëŸ¬ ë¬´ë£Œì§€ì›)</span></label>
            <input type="number" class="form-input" id="ss-eventCost" value="${s.eventCost || 0}" placeholder="0" style="background: #fce7f3; border-color: #ec4899;">
          </div>
        </div>
        <div class="form-group"><label class="form-label">ë¹„ê³ </label><textarea class="form-textarea" id="ss-notes" rows="2" placeholder="ì¶”ê°€ ë©”ëª¨">${s.notes || ''}</textarea></div>
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSellerSettlement('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
}

// íŒë§¤ê±´ í¸ì§‘ê¸° (ë³„ë„ ëª¨ë‹¬) - ìƒí’ˆ ê²€ìƒ‰ í¬í•¨
function openSalesItemsEditor(productType) {
  const currentItems = JSON.parse(document.getElementById('ss-salesItems')?.value || '[]');
  const brandName = document.getElementById('ss-brandName')?.value || '';
  const isInhouse = productType === 'inhouse';
  
  // productTypeì— ë§ëŠ” ìƒí’ˆë§Œ í•„í„°ë§
  const filteredProducts = (state.supplierProducts || []).filter(p => {
    if (isInhouse) {
      return p.supplierType === 'inhouse';
    } else {
      return p.supplierType !== 'inhouse';
    }
  });
  const brands = [...new Set(filteredProducts.map(p => p.brandName))];
  
  // í˜„ì¬ ì„ íƒëœ ë¸Œëœë“œê°€ í•„í„°ë§ëœ ë¸Œëœë“œì— ì—†ìœ¼ë©´ ì´ˆê¸°í™”
  const selectedBrand = brands.includes(brandName) ? brandName : '';
  
  const editorModal = document.createElement('div');
  editorModal.id = 'salesItemsEditor';
  editorModal.dataset.productType = productType; // productType ì €ì¥
  editorModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  editorModal.innerHTML = `
    <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">ğŸ“¦ íŒë§¤ê±´ í¸ì§‘ <span style="font-size: 13px; color: ${isInhouse ? 'var(--info)' : 'var(--success)'}; font-weight: normal;">(${isInhouse ? 'ìì‚¬ ìƒí’ˆ' : 'íƒ€ì‚¬ ìƒí’ˆ'})</span></h3>
        <button onclick="closeSalesItemsEditor()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
      </div>
      <div style="padding: 16px 20px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200);">
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
          <span style="font-size: 13px; color: var(--gray-600);">ğŸ” ìƒí’ˆ ê²€ìƒ‰:</span>
          <input type="text" id="salesProductSearch" class="form-input" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." style="width: 200px;" oninput="filterSalesProducts()">
          <select id="salesBrandFilter" class="form-input" style="width: 150px;" onchange="filterSalesProducts()">
            <option value="">ì „ì²´ ë¸Œëœë“œ</option>
            ${brands.map(b => `<option value="${b}" ${b === selectedBrand ? 'selected' : ''}>${b}</option>`).join('')}
          </select>
          <button type="button" class="btn btn-primary btn-sm" onclick="addSelectedSalesProducts('${productType}')">ì„ íƒ ìƒí’ˆ ì¶”ê°€</button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addSalesItemRow()">+ ì§ì ‘ ì…ë ¥</button>
        </div>
        <div id="salesProductResults" style="margin-top: 12px; max-height: 150px; overflow-y: auto; display: none;">
        </div>
      </div>
      <div style="padding: 20px; flex: 1; overflow-y: auto;">
        <!-- í—¤ë” ë¼ë²¨ -->
        <div style="display: grid; grid-template-columns: 2fr 90px 90px 60px 90px 70px 90px 90px 36px; gap: 6px; padding: 8px 12px; background: var(--gray-100); border-radius: 8px; margin-bottom: 8px; font-size: 11px; font-weight: 600; color: var(--gray-600);">
          <div>ìƒí’ˆëª…</div>
          <div style="text-align: center;">íŒë§¤ë‹¨ê°€</div>
          <div style="text-align: center; background: var(--gray-50); border-radius: 4px;">ê³µê¸‰ë‹¨ê°€</div>
          <div style="text-align: center;">ìˆ˜ëŸ‰</div>
          <div style="text-align: center; color: var(--info);">íŒë§¤ê¸ˆì•¡</div>
          <div style="text-align: center; color: var(--gray-600);">ë§ˆì§„ìœ¨</div>
          <div style="text-align: center; color: var(--danger);">ë§ˆì§„ê¸ˆì•¡</div>
          <div style="text-align: center; color: var(--success);">ì‹¤ì§€ê¸‰ì•¡</div>
          <div></div>
        </div>
        
        <div id="salesItemsRows">
          ${currentItems.length === 0 ? getSalesItemRow(0, {}, productType) : currentItems.map((item, i) => getSalesItemRow(i, item, productType)).join('')}
        </div>
      </div>
      <div style="padding: 16px 20px; border-top: 1px solid var(--gray-200); background: var(--gray-50); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <div style="font-size: 14px;">
          <span style="color: var(--gray-600);">ì´ ìˆ˜ëŸ‰:</span> <strong id="editorTotalQty">0</strong>ê°œ &nbsp;|&nbsp;
          <span style="color: var(--gray-600);">ì´ íŒë§¤ê¸ˆì•¡:</span> <strong id="editorTotalAmount" style="color: var(--primary);">0</strong>ì› &nbsp;|&nbsp;
          <span style="color: var(--danger);">ì´ ë§ˆì§„ê¸ˆì•¡:</span> <strong id="editorTotalMargin" style="color: var(--danger);">0</strong>ì›
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="closeSalesItemsEditor()" class="btn btn-secondary">ì·¨ì†Œ</button>
          <button onclick="saveSalesItems('${productType}')" class="btn btn-primary">ì ìš©í•˜ê¸°</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(editorModal);
  filterSalesProducts(); // ì´ˆê¸° ìƒí’ˆ ëª©ë¡ í‘œì‹œ
  updateEditorTotals();
}

// ìƒí’ˆ ê²€ìƒ‰ í•„í„°
function filterSalesProducts() {
  const searchText = document.getElementById('salesProductSearch')?.value.toLowerCase() || '';
  const brandFilter = document.getElementById('salesBrandFilter')?.value || '';
  const editorModal = document.getElementById('salesItemsEditor');
  const productType = editorModal?.dataset?.productType || '';
  const isInhouse = productType === 'inhouse';
  
  const products = state.supplierProducts || [];
  
  // productTypeì— ë§ëŠ” ìƒí’ˆë§Œ í•„í„°ë§
  const filtered = products.filter(p => {
    // ìì‚¬/íƒ€ì‚¬ í•„í„°
    const matchType = isInhouse ? (p.supplierType === 'inhouse') : (p.supplierType !== 'inhouse');
    const matchBrand = !brandFilter || p.brandName === brandFilter;
    const matchText = !searchText || p.productName.toLowerCase().includes(searchText) || p.brandName.toLowerCase().includes(searchText);
    return matchType && matchBrand && matchText;
  });
  
  const container = document.getElementById('salesProductResults');
  if (filtered.length === 0) {
    container.style.display = 'block';
    container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">
      ${isInhouse ? 'ğŸ  ìì‚¬ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ê³µê¸‰ì‚¬ ë©”ë‰´ì—ì„œ ìì‚¬ ê³µê¸‰ì‚¬ì˜ ìƒí’ˆì„ ë“±ë¡í•˜ì„¸ìš”.' : 'ğŸ­ íƒ€ì‚¬ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ê³µê¸‰ì‚¬ ë©”ë‰´ì—ì„œ íƒ€ì‚¬ ê³µê¸‰ì‚¬ì˜ ìƒí’ˆì„ ë“±ë¡í•˜ì„¸ìš”.'}
    </div>`;
    return;
  }
  
  container.style.display = 'block';
  
  // ìì‚¬ì™€ íƒ€ì‚¬ì— ë”°ë¼ ë‹¤ë¥¸ ì»¬ëŸ¼ í‘œì‹œ
  const lastColHeader = isInhouse ? 'ì´ë§ˆì§„ìˆ˜ìˆ˜ë£Œ' : 'ê³µê¸‰ë‹¨ê°€(V+)';
  const lastColValue = (p) => isInhouse ? Number(p.marginFee || 0).toLocaleString() : Number(p.supplyPrice || 0).toLocaleString();
  
  container.innerHTML = `
    <table style="width: 100%; font-size: 12px; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden;">
      <thead><tr style="background: var(--gray-200);"><th style="padding: 6px; width: 30px;"></th><th style="padding: 6px; text-align: left;">ë¸Œëœë“œ</th><th style="padding: 6px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 6px; text-align: right;">ì†Œë¹„ìì •ê°€</th><th style="padding: 6px; text-align: right;">ê³µêµ¬íŒë§¤ê°€</th><th style="padding: 6px; text-align: right; background: var(--gray-50);">${lastColHeader}</th></tr></thead>
      <tbody>
        ${filtered.slice(0, 10).map(p => `
          <tr style="border-bottom: 1px solid var(--gray-100);" data-product='${JSON.stringify(p).replace(/'/g, "&#39;")}'>
            <td style="padding: 6px; text-align: center;"><input type="checkbox" class="sales-product-checkbox" style="width: 16px; height: 16px;"></td>
            <td style="padding: 6px;"><span class="status-badge ${p.supplierType === 'inhouse' ? 'status-confirmed' : 'status-negotiating'}" style="font-size: 10px;">${p.brandName}</span></td>
            <td style="padding: 6px;">${p.productName}</td>
            <td style="padding: 6px; text-align: right; color: var(--gray-500); text-decoration: line-through;">${Number(p.retailPrice || 0).toLocaleString()}ì›</td>
            <td style="padding: 6px; text-align: right; font-weight: 600;">${Number(p.salePrice || 0).toLocaleString()}ì›</td>
            <td style="padding: 6px; text-align: right; background: #fefce8; font-weight: 600;">${lastColValue(p)}ì›</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    ${filtered.length > 10 ? `<div style="text-align: center; padding: 8px; font-size: 12px; color: var(--gray-500);">ê²€ìƒ‰ ê²°ê³¼ ${filtered.length}ê°œ ì¤‘ 10ê°œ í‘œì‹œ</div>` : ''}
  `;
}

// ì„ íƒí•œ ìƒí’ˆ ì¶”ê°€
function addSelectedSalesProducts(productType) {
  const checkboxes = document.querySelectorAll('.sales-product-checkbox:checked');
  if (checkboxes.length === 0) {
    showToast('ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  const isInhouse = productType === 'inhouse';
  
  checkboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    const product = JSON.parse(row.dataset.product);
    
    const container = document.getElementById('salesItemsRows');
    const newIndex = container.children.length;
    
    // ê³µê¸‰ì‚¬ ìƒí’ˆ ì •ë³´ ìë™ ì…ë ¥
    let item;
    if (isInhouse) {
      // ìì‚¬: marginFeeë¡œ ë§ˆì§„ìœ¨ ê³„ì‚°
      const salePrice = product.salePrice || 0;
      const marginFee = product.marginFee || 0;
      const calculatedMarginRate = salePrice > 0 ? Math.round((marginFee / salePrice) * 100) : 0;
      
      item = {
        productName: product.productName,
        unitPrice: salePrice,  // ê³µêµ¬íŒë§¤ê°€
        supplyPrice: 0,  // ìì‚¬ëŠ” ê³µê¸‰ë‹¨ê°€ ì—†ìŒ
        quantity: 1,
        marginRate: calculatedMarginRate  // marginFee ê¸°ë°˜ ë§ˆì§„ìœ¨
      };
    } else {
      // íƒ€ì‚¬: supplyPrice ì‚¬ìš©
      item = {
        productName: product.productName,
        unitPrice: product.salePrice || 0,  // ê³µêµ¬íŒë§¤ê°€
        supplyPrice: product.supplyPrice || 0,  // ê³µê¸‰ë‹¨ê°€
        quantity: 1,
        marginRate: 20  // ê¸°ë³¸ ë§ˆì§„ìœ¨
      };
    }
    
    container.insertAdjacentHTML('beforeend', getSalesItemRow(newIndex, item, productType));
  });
  
  // ì²´í¬ë°•ìŠ¤ í•´ì œ
  checkboxes.forEach(cb => cb.checked = false);
  
  // ê¸ˆì•¡ ê³„ì‚°
  document.querySelectorAll('.sales-item-row').forEach(row => {
    const input = row.querySelector('.si-unitPrice');
    if (input) updateSalesItemAmount(input);
  });
  
  showToast(`${checkboxes.length}ê°œ ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
}

function getSalesItemRow(index, item = {}, productType = '') {
  return `
    <div class="sales-item-row" style="display: grid; grid-template-columns: 2fr 90px 90px 60px 90px 70px 90px 90px 36px; gap: 6px; align-items: center; padding: 10px; background: #fff; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 8px;">
      <input type="text" class="form-input si-productName" value="${item.productName || ''}" placeholder="ìƒí’ˆëª…" style="font-size: 12px;">
      <input type="number" class="form-input si-unitPrice" value="${item.unitPrice || ''}" placeholder="íŒë§¤ë‹¨ê°€" style="font-size: 12px;" oninput="updateSalesItemAmount(this)">
      <input type="number" class="form-input si-supplyPrice" value="${item.supplyPrice || ''}" placeholder="ê³µê¸‰ë‹¨ê°€" style="font-size: 12px; background: var(--gray-50);">
      <input type="number" class="form-input si-quantity" value="${item.quantity || ''}" placeholder="ìˆ˜ëŸ‰" style="font-size: 12px; text-align: center;" oninput="updateSalesItemAmount(this)">
      <input type="number" class="form-input si-amount" value="${item.amount || ''}" placeholder="íŒë§¤ê¸ˆì•¡" style="font-size: 12px; background: var(--gray-50); font-weight: 600;" readonly>
      <input type="number" class="form-input si-marginRate" value="${item.marginRate || '20'}" placeholder="%" style="font-size: 12px; text-align: center; background: var(--gray-50);" oninput="updateSalesItemAmount(this)">
      <input type="number" class="form-input si-marginAmount" value="${item.marginAmount || ''}" placeholder="ë§ˆì§„ê¸ˆì•¡" style="font-size: 12px; background: var(--danger-light); color: var(--danger);" readonly>
      <input type="number" class="form-input si-actualPayment" value="${item.actualPayment || ''}" placeholder="ì‹¤ì§€ê¸‰ì•¡" style="font-size: 12px; background: var(--success-light); color: var(--success);" readonly>
      <button type="button" onclick="removeSalesItemRow(this)" style="background: none; border: none; color: var(--danger); font-size: 18px; cursor: pointer;">Ã—</button>
    </div>
  `;
}

function addSalesItemRow() {
  const container = document.getElementById('salesItemsRows');
  const newIndex = container.children.length;
  container.insertAdjacentHTML('beforeend', getSalesItemRow(newIndex, {}, ''));
}

function removeSalesItemRow(btn) {
  const row = btn.closest('.sales-item-row');
  if (document.querySelectorAll('.sales-item-row').length > 1) {
    row.remove();
    updateEditorTotals();
  }
}

function updateSalesItemAmount(input) {
  const row = input.closest('.sales-item-row');
  const unitPrice = Number(row.querySelector('.si-unitPrice').value) || 0;
  const quantity = Number(row.querySelector('.si-quantity').value) || 0;
  const marginRate = Number(row.querySelector('.si-marginRate').value) || 0;
  
  const amount = unitPrice * quantity;
  const marginAmount = Math.round(amount * (marginRate / 100));
  const withholdingTax = Math.round(marginAmount * 0.033);
  const actualPayment = marginAmount - withholdingTax;
  
  row.querySelector('.si-amount').value = amount;
  row.querySelector('.si-marginAmount').value = marginAmount;
  row.querySelector('.si-actualPayment').value = actualPayment;
  updateEditorTotals();
}

function updateEditorTotals() {
  const rows = document.querySelectorAll('.sales-item-row');
  let totalQty = 0, totalAmount = 0, totalMargin = 0;
  rows.forEach(row => {
    totalQty += Number(row.querySelector('.si-quantity')?.value) || 0;
    totalAmount += Number(row.querySelector('.si-amount')?.value) || 0;
    totalMargin += Number(row.querySelector('.si-marginAmount')?.value) || 0;
  });
  if (document.getElementById('editorTotalQty')) document.getElementById('editorTotalQty').textContent = totalQty;
  if (document.getElementById('editorTotalAmount')) document.getElementById('editorTotalAmount').textContent = totalAmount.toLocaleString();
  if (document.getElementById('editorTotalMargin')) document.getElementById('editorTotalMargin').textContent = totalMargin.toLocaleString();
}

function closeSalesItemsEditor() {
  const editor = document.getElementById('salesItemsEditor');
  if (editor) editor.remove();
}

function saveSalesItems(productType) {
  const rows = document.querySelectorAll('.sales-item-row');
  const items = [];
  let totalAmount = 0, totalMarginAmount = 0, totalActualPayment = 0, totalSupplyAmount = 0;
  
  rows.forEach(row => {
    const productName = row.querySelector('.si-productName').value.trim();
    const unitPrice = Number(row.querySelector('.si-unitPrice').value) || 0;
    const supplyPrice = Number(row.querySelector('.si-supplyPrice')?.value) || 0;
    const quantity = Number(row.querySelector('.si-quantity').value) || 0;
    const amount = Number(row.querySelector('.si-amount').value) || 0;
    const marginRate = Number(row.querySelector('.si-marginRate').value) || 0;
    const marginAmount = Number(row.querySelector('.si-marginAmount').value) || 0;
    const withholdingTax = Math.round(marginAmount * 0.033);
    const actualPayment = Number(row.querySelector('.si-actualPayment').value) || 0;
    
    if (productName || unitPrice || quantity) {
      items.push({ productName, unitPrice, supplyPrice, quantity, amount, marginRate, marginAmount, withholdingTax, actualPayment });
      totalAmount += amount;
      totalMarginAmount += marginAmount;
      totalActualPayment += actualPayment;
      totalSupplyAmount += supplyPrice * quantity;
    }
  });
  
  const totalWithholdingTax = Math.round(totalMarginAmount * 0.033);
  
  // ë©”ì¸ ëª¨ë‹¬ì— ë°˜ì˜
  document.getElementById('ss-salesItems').value = JSON.stringify(items);
  document.getElementById('ss-salesAmount').value = totalAmount;
  if (document.getElementById('ss-supplyAmount')) document.getElementById('ss-supplyAmount').value = totalSupplyAmount;
  if (document.getElementById('ss-marginAmount')) document.getElementById('ss-marginAmount').value = totalMarginAmount;
  if (document.getElementById('ss-withholdingTax')) document.getElementById('ss-withholdingTax').value = totalWithholdingTax;
  if (document.getElementById('ss-actualPayment')) document.getElementById('ss-actualPayment').value = totalMarginAmount - totalWithholdingTax;
  
  // íƒ€ì‚¬ ìƒí’ˆì¼ ê²½ìš° ë§¤ì¶œê¸ˆì•¡ ê³„ì‚°
  if (productType === 'external') {
    calculateSellerMargin(productType);
  }
  
  // ë©”ì¸ ëª¨ë‹¬ì— ë°˜ì˜
  document.getElementById('ss-salesItems').value = JSON.stringify(items);
  document.getElementById('ss-salesAmount').value = totalAmount;
  if (document.getElementById('ss-marginAmount')) document.getElementById('ss-marginAmount').value = totalMarginAmount;
  if (document.getElementById('ss-withholdingTax')) document.getElementById('ss-withholdingTax').value = totalWithholdingTax;
  if (document.getElementById('ss-actualPayment')) document.getElementById('ss-actualPayment').value = totalMarginAmount - totalWithholdingTax;
  
  // íŒë§¤ê±´ ëª©ë¡ UI ì—…ë°ì´íŠ¸
  const listContainer = document.getElementById('ss-salesItemsList');
  if (items.length === 0) {
    listContainer.innerHTML = '<div style="color: var(--gray-500); font-size: 13px; text-align: center; padding: 20px;">íŒë§¤ê±´ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>';
  } else {
    listContainer.innerHTML = `
      <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
        <thead><tr style="background: var(--gray-200);"><th style="padding: 6px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 6px; text-align: right;">íŒë§¤ë‹¨ê°€</th><th style="padding: 6px; text-align: center;">ìˆ˜ëŸ‰</th><th style="padding: 6px; text-align: right;">íŒë§¤ê¸ˆì•¡</th><th style="padding: 6px; text-align: center;">ë§ˆì§„ìœ¨</th><th style="padding: 6px; text-align: right;">ë§ˆì§„ê¸ˆì•¡</th><th style="padding: 6px; text-align: right;">ì‹¤ì§€ê¸‰ì•¡</th></tr></thead>
        <tbody>${items.map(item => `<tr style="border-bottom: 1px solid var(--gray-200);"><td style="padding: 6px;">${item.productName || '-'}</td><td style="padding: 6px; text-align: right;">${Number(item.unitPrice || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: center;">${item.quantity || 0}</td><td style="padding: 6px; text-align: right;">${Number(item.amount || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: center; color: var(--primary);">${item.marginRate}%</td><td style="padding: 6px; text-align: right; color: var(--danger);">${Number(item.marginAmount || 0).toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; color: var(--success);">${Number(item.actualPayment || 0).toLocaleString()}ì›</td></tr>`).join('')}</tbody>
        <tfoot><tr style="background: var(--gray-100); font-weight: 700;"><td style="padding: 6px;">í•©ê³„</td><td style="padding: 6px;"></td><td style="padding: 6px; text-align: center;">${items.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0)}</td><td style="padding: 6px; text-align: right;">${totalAmount.toLocaleString()}ì›</td><td style="padding: 6px;"></td><td style="padding: 6px; text-align: right; color: var(--danger);">${totalMarginAmount.toLocaleString()}ì›</td><td style="padding: 6px; text-align: right; color: var(--success);">${totalActualPayment.toLocaleString()}ì›</td></tr></tfoot>
      </table>
    `;
  }
  
  closeSalesItemsEditor();
}

function calculateSellerMargin(productType) {
  const salesAmount = Number(document.getElementById('ss-salesAmount')?.value) || 0;
  if (productType === 'external') {
    const supplyAmount = Number(document.getElementById('ss-supplyAmount')?.value) || 0;
    const revenueAmount = salesAmount - supplyAmount;
    if (document.getElementById('ss-revenueAmount')) document.getElementById('ss-revenueAmount').value = revenueAmount;
  }
}

async function submitSellerSettlement(e, id, productType) {
  e.preventDefault();
  const salesItems = JSON.parse(document.getElementById('ss-salesItems')?.value || '[]');
  const salesAmount = Number(document.getElementById('ss-salesAmount').value) || 0;
  const supplyAmount = Number(document.getElementById('ss-supplyAmount')?.value) || 0;
  const revenueAmount = productType === 'external' ? salesAmount - supplyAmount : salesAmount;
  const totalQuantity = salesItems.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
  const marginAmount = salesItems.reduce((sum, i) => sum + (Number(i.marginAmount) || 0), 0);
  const withholdingTax = Math.round(marginAmount * 0.033);
  const actualPayment = marginAmount - withholdingTax;
  const eventCost = Number(document.getElementById('ss-eventCost')?.value) || 0;
  
  // ë¸Œëœë“œëª… ì²˜ë¦¬ (ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì„ íƒ)
  const brandSelect = document.getElementById('ss-brandName').value;
  const brandName = brandSelect === '_other' 
    ? document.getElementById('ss-brandNameCustom').value 
    : brandSelect;
  
  // ì…€ëŸ¬ëª… ì²˜ë¦¬ (ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì„ íƒ)
  const sellerSelect = document.getElementById('ss-sellerName').value;
  const sellerName = sellerSelect === '_other' 
    ? document.getElementById('ss-sellerNameCustom').value 
    : sellerSelect;
  
  // sellerId ì°¾ê¸° (ì…€ëŸ¬ëª…ìœ¼ë¡œ ë§¤ì¹­)
  const matchedSeller = state.sellers.find(s => s.name === sellerName);
  const sellerId = matchedSeller?.id || '';
  
  // supplierId ì°¾ê¸° (ë¸Œëœë“œëª…ìœ¼ë¡œ ë§¤ì¹­)
  const matchedSupplier = state.suppliers.find(s => s.name === brandName);
  const supplierId = matchedSupplier?.id || '';
  
  const data = {
    productType, sellerName: sellerName, brandName: brandName,
    sellerId: sellerId, supplierId: supplierId,
    dealPeriod: document.getElementById('ss-dealPeriod').value, salesItems, totalQuantity, salesAmount, supplyAmount, revenueAmount,
    marginAmount, withholdingTax, actualPayment, eventCost,
    settlementDate: document.getElementById('ss-settlementDate').value, notes: document.getElementById('ss-notes').value, updatedAt: new Date().toISOString()
  };
  try {
    if (id) { await db.collection('sellerSettlements').doc(id).update(data); }
    else { data.createdAt = new Date().toISOString(); await db.collection('sellerSettlements').add(data); }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤'); closeModal();
  } catch(err) { showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

async function deleteSellerSettlement(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try { await db.collection('sellerSettlements').doc(id).delete(); showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); closeModal(); } catch(err) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

// ========================================
// 1. ê³µê¸‰ì‚¬ ìƒí’ˆ ë“±ë¡ (ê¸°ë³¸ ì •ë³´ë§Œ)
// ========================================
function openSupplierProductModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const products = state.supplierProducts || [];
  const brands = state.settlementBrands || [];
  
  // ë¸Œëœë“œë³„ ê·¸ë£¹í•‘
  const groupedProducts = products.reduce((acc, p) => {
    if (!acc[p.brandName]) acc[p.brandName] = [];
    acc[p.brandName].push(p);
    return acc;
  }, {});
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 950px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“¦ ê³µê¸‰ì‚¬ ìƒí’ˆ ë“±ë¡</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="display: flex; gap: 8px; padding: 0 0 16px 0; border-bottom: 1px solid var(--gray-200); margin-bottom: 16px;">
        <button class="btn btn-primary btn-sm" onclick="openProductAddModal()">â• ìƒí’ˆ ë“±ë¡</button>
        <button class="btn btn-secondary btn-sm" onclick="openProductBulkImportModal()">ğŸ“¥ ì—‘ì…€ ì¼ê´„ë“±ë¡</button>
        <button class="btn btn-secondary btn-sm" onclick="downloadProductTemplate()">ğŸ“„ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-secondary btn-sm" onclick="exportProductsToExcel()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
      </div>
      
      <div style="flex: 1; overflow-y: auto;">
        ${Object.keys(groupedProducts).length === 0 ? '<div class="empty-state"><div class="icon">ğŸ“¦</div><div class="text">ë“±ë¡ëœ ê³µê¸‰ì‚¬ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤<br><small>ìƒí’ˆì„ ë“±ë¡í•˜ê±°ë‚˜ ì—‘ì…€ë¡œ ì¼ê´„ë“±ë¡í•˜ì„¸ìš”</small></div></div>' : `
          ${Object.entries(groupedProducts).map(([brand, prods]) => `
            <div style="margin-bottom: 24px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <span class="status-badge status-negotiating" style="font-size: 14px;">${brand}</span>
                <span style="color: var(--gray-500); font-size: 13px;">${prods.length}ê°œ ìƒí’ˆ</span>
              </div>
              <div style="overflow-x: auto;">
                <table class="data-table" style="font-size: 12px;">
                  <thead>
                    <tr style="background: var(--gray-100);">
                      <th style="min-width: 200px;">ìƒí’ˆëª…</th>
                      <th style="text-align: right;">ì†Œë¹„ìì •ê°€</th>
                      <th style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                      <th style="text-align: right; background: var(--gray-50);">ê³µê¸‰ë‹¨ê°€(V+)</th>
                      <th style="text-align: right; background: var(--gray-50);">ë°°ì†¡ë£Œ</th>
                      <th style="text-align: right;">ì •ê°€í• ì¸ìœ¨</th>
                      <th style="text-align: right;">ì´ë§ˆì§„ìœ¨</th>
                      <th style="text-align: right;">ì´ë§ˆì§„ê¸ˆ</th>
                      <th style="width: 80px;"></th>
                    </tr>
                  </thead>
                  <tbody>
                    ${prods.map(p => {
                      const retailPrice = Number(p.retailPrice) || 0;
                      const salePrice = Number(p.salePrice) || 0;
                      const supplyPrice = Number(p.supplyPrice) || 0;
                      const shippingFee = Number(p.shippingFee) || 0;
                      const discountRate = retailPrice > 0 ? ((retailPrice - salePrice) / retailPrice * 100).toFixed(1) : 0;
                      const totalMargin = salePrice - supplyPrice;
                      const totalMarginRate = salePrice > 0 ? (totalMargin / salePrice * 100).toFixed(1) : 0;
                      return `<tr>
                        <td>${p.productName}</td>
                        <td style="text-align: right;">${retailPrice.toLocaleString()}ì›</td>
                        <td style="text-align: right;">${salePrice.toLocaleString()}ì›</td>
                        <td style="text-align: right; background: #fefce8; font-weight: 600;">${supplyPrice.toLocaleString()}ì›</td>
                        <td style="text-align: right; background: #f0f9ff;">${shippingFee.toLocaleString()}ì›</td>
                        <td style="text-align: right; color: var(--danger);">${discountRate}%</td>
                        <td style="text-align: right;">${totalMarginRate}%</td>
                        <td style="text-align: right; font-weight: 600;">${totalMargin.toLocaleString()}ì›</td>
                        <td class="actions">
                          <button class="btn btn-secondary btn-sm" onclick="editSupplierProduct('${p.id}')" style="padding: 4px 8px;">ìˆ˜ì •</button>
                          <button class="btn btn-secondary btn-sm" onclick="deleteSupplierProduct('${p.id}')" style="padding: 4px 8px; color: var(--danger);">ì‚­ì œ</button>
                        </td>
                      </tr>`;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `).join('')}
        `}
      </div>
      
      <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button></div>
    </div>
  `;
}

// ìƒí’ˆ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ (ê¸°ë³¸ ì •ë³´ë§Œ)
function openProductAddModal(item = null) {
  const isEdit = item !== null;
  const p = item || { brandName: '', productName: '', retailPrice: '', salePrice: '', supplyPrice: '', shippingFee: '' };
  const brands = state.settlementBrands || [];
  
  const editorModal = document.createElement('div');
  editorModal.id = 'productAddModal';
  editorModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  editorModal.innerHTML = `
    <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden;">
      <div style="padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">${isEdit ? 'ğŸ“ ìƒí’ˆ ìˆ˜ì •' : 'â• ìƒˆ ìƒí’ˆ ë“±ë¡'}</h3>
        <button onclick="document.getElementById('productAddModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
      </div>
      <form onsubmit="submitSupplierProductForm(event, '${p.id || ''}')" style="padding: 20px;">
        <div class="form-group"><label class="form-label">ê³µê¸‰ì‚¬(ë¸Œëœë“œ) *</label><input type="text" class="form-input" id="pf-brandName" value="${p.brandName}" required placeholder="ì˜ˆ: ë¡œì§€ì˜¤ê°€ë‹‰" list="pf-brand-list"><datalist id="pf-brand-list">${brands.map(b => `<option value="${b.name}">`).join('')}</datalist></div>
        <div class="form-group"><label class="form-label">ìƒí’ˆëª… *</label><input type="text" class="form-input" id="pf-productName" value="${p.productName}" required placeholder="ì˜ˆ: ì§œë¨¹ëŠ” ì•„ë„¬ë¼HOP ì‹œì‘ê³¼ì¼ 14íŒ©"></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ì†Œë¹„ì ì •ê°€</label><input type="number" class="form-input" id="pf-retailPrice" value="${p.retailPrice}" placeholder="64400"></div>
          <div class="form-group"><label class="form-label">ê³µë™êµ¬ë§¤ íŒë§¤ê°€ *</label><input type="number" class="form-input" id="pf-salePrice" value="${p.salePrice}" required placeholder="34000"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê³µê¸‰ë‹¨ê°€ (V+) *</label><input type="number" class="form-input" id="pf-supplyPrice" value="${p.supplyPrice}" required placeholder="27200" style="background: var(--gray-50);"></div>
          <div class="form-group"><label class="form-label">ë°°ì†¡ë£Œ (ê±´ë‹¹)</label><input type="number" class="form-input" id="pf-shippingFee" value="${p.shippingFee || ''}" placeholder="3000" style="background: var(--gray-50);"></div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('productAddModal').remove()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(editorModal);
}

async function submitSupplierProductForm(e, id) {
  e.preventDefault();
  const data = {
    brandName: document.getElementById('pf-brandName').value.trim(),
    productName: document.getElementById('pf-productName').value.trim(),
    retailPrice: Number(document.getElementById('pf-retailPrice').value) || 0,
    salePrice: Number(document.getElementById('pf-salePrice').value) || 0,
    supplyPrice: Number(document.getElementById('pf-supplyPrice').value) || 0,
    shippingFee: Number(document.getElementById('pf-shippingFee').value) || 0,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (id) {
      await db.collection('supplierProducts').doc(id).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('supplierProducts').add(data);
    }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    document.getElementById('productAddModal')?.remove();
    setTimeout(() => openSupplierProductModal(), 300);
  } catch(err) { showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

function editSupplierProduct(id) {
  const product = state.supplierProducts.find(p => p.id === id);
  if (product) {
    closeModal();
    setTimeout(() => openProductAddModal(product), 100);
  }
}

async function deleteSupplierProduct(id) {
  if (!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try { 
    await db.collection('supplierProducts').doc(id).delete(); 
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); 
    setTimeout(() => openSupplierProductModal(), 300); 
  } catch(err) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

// ì—‘ì…€ ì¼ê´„ë“±ë¡ ëª¨ë‹¬
function openProductBulkImportModal() {
  const editorModal = document.createElement('div');
  editorModal.id = 'bulkImportModal';
  editorModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  editorModal.innerHTML = `
    <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow: hidden;">
      <div style="padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">ğŸ“¥ ì—‘ì…€ ì¼ê´„ë“±ë¡</h3>
        <button onclick="document.getElementById('bulkImportModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="background: var(--info-light); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--info);">ğŸ“‹ ì—‘ì…€ ì–‘ì‹ ì•ˆë‚´</h4>
          <p style="margin: 0; font-size: 13px; color: var(--gray-600);">ì•„ë˜ ì—´ ìˆœì„œëŒ€ë¡œ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:</p>
          <ol style="margin: 8px 0 0 0; padding-left: 20px; font-size: 12px; color: var(--gray-600);">
            <li>ê³µê¸‰ì‚¬(ë¸Œëœë“œ)</li>
            <li>ìƒí’ˆëª…</li>
            <li>ì†Œë¹„ìì •ê°€</li>
            <li>ê³µë™êµ¬ë§¤íŒë§¤ê°€</li>
            <li>ê³µê¸‰ë‹¨ê°€(V+)</li>
          </ol>
        </div>
        
        <div style="border: 2px dashed var(--gray-300); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 16px;" id="dropZone">
          <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“‚</div>
          <p style="margin: 0 0 12px 0; color: var(--gray-600);">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
          <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleExcelUpload(this)">
          <button type="button" class="btn btn-primary" onclick="document.getElementById('excelFileInput').click()">íŒŒì¼ ì„ íƒ</button>
        </div>
        
        <div id="importPreview" style="display: none; max-height: 300px; overflow: auto;"></div>
        
        <div style="display: flex; justify-content: flex-end; gap: 8px;">
          <button type="button" class="btn btn-secondary" onclick="downloadProductTemplate()">ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('bulkImportModal').remove()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="importBtn" style="display: none;" onclick="executeImport()">ì¼ê´„ ë“±ë¡</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(editorModal);
  
  const dropZone = editorModal.querySelector('#dropZone');
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; });
  dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = 'var(--gray-300)'; });
  dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--gray-300)'; if (e.dataTransfer.files.length) handleExcelUpload({ files: e.dataTransfer.files }); });
}

let importData = [];

async function handleExcelUpload(input) {
  const file = input.files[0];
  if (!file) return;
  
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    await new Promise(resolve => script.onload = resolve);
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      
      importData = [];
      for (let i = 1; i < json.length; i++) {
        const row = json[i];
        if (row[0] && row[1]) {
          importData.push({
            brandName: String(row[0] || '').trim(),
            productName: String(row[1] || '').trim(),
            retailPrice: Number(row[2]) || 0,
            salePrice: Number(row[3]) || 0,
            supplyPrice: Number(row[4]) || 0
          });
        }
      }
      
      const preview = document.getElementById('importPreview');
      preview.style.display = 'block';
      preview.innerHTML = `
        <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ“‹ ${importData.length}ê°œ ìƒí’ˆ ë¯¸ë¦¬ë³´ê¸°</p>
        <div style="overflow-x: auto;">
        <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
          <thead><tr style="background: var(--gray-200);"><th style="padding: 4px;">ë¸Œëœë“œ</th><th style="padding: 4px;">ìƒí’ˆëª…</th><th style="padding: 4px;">ì •ê°€</th><th style="padding: 4px;">íŒë§¤ê°€</th><th style="padding: 4px; background: var(--gray-50);">ê³µê¸‰ê°€</th><th style="padding: 4px; color: var(--danger);">ì •ê°€í• ì¸ìœ¨</th><th style="padding: 4px;">ì´ë§ˆì§„ìœ¨</th><th style="padding: 4px;">ì´ë§ˆì§„ê¸ˆ</th></tr></thead>
          <tbody>${importData.slice(0, 10).map(d => {
            const discountRate = d.retailPrice > 0 ? ((d.retailPrice - d.salePrice) / d.retailPrice * 100).toFixed(1) : 0;
            const totalMargin = d.salePrice - d.supplyPrice;
            const totalMarginRate = d.salePrice > 0 ? (totalMargin / d.salePrice * 100).toFixed(1) : 0;
            return `<tr><td style="padding: 4px;">${d.brandName}</td><td style="padding: 4px;">${d.productName}</td><td style="padding: 4px; text-align: right;">${d.retailPrice.toLocaleString()}</td><td style="padding: 4px; text-align: right;">${d.salePrice.toLocaleString()}</td><td style="padding: 4px; text-align: right; background: #fefce8;">${d.supplyPrice.toLocaleString()}</td><td style="padding: 4px; text-align: right; color: var(--danger);">${discountRate}%</td><td style="padding: 4px; text-align: right;">${totalMarginRate}%</td><td style="padding: 4px; text-align: right; font-weight: 600;">${totalMargin.toLocaleString()}ì›</td></tr>`;
          }).join('')}</tbody>
        </table>
        </div>
        ${importData.length > 10 ? `<p style="text-align: center; color: var(--gray-500); font-size: 12px; margin-top: 8px;">... ì™¸ ${importData.length - 10}ê°œ</p>` : ''}
      `;
      
      document.getElementById('importBtn').style.display = 'inline-flex';
    } catch(err) { showToast('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ' + err.message); }
  };
  reader.readAsArrayBuffer(file);
}

async function executeImport() {
  if (importData.length === 0) { showToast('ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
  try {
    const batch = db.batch();
    importData.forEach(item => {
      const ref = db.collection('supplierProducts').doc();
      batch.set(ref, { ...item, createdAt: new Date().toISOString() });
    });
    await batch.commit();
    showToast(`${importData.length}ê°œ ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
    document.getElementById('bulkImportModal')?.remove();
    importData = [];
    setTimeout(() => openSupplierProductModal(), 300);
  } catch(err) { showToast('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message); }
}

function downloadProductTemplate() {
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    script.onload = () => createAndDownloadTemplate();
    return;
  }
  createAndDownloadTemplate();
}

function createAndDownloadTemplate() {
  // ì…ë ¥ í•­ëª©ë§Œ (ì •ê°€í• ì¸ìœ¨, ì´ë§ˆì§„ìœ¨, ì´ë§ˆì§„ê¸ˆì€ ë“±ë¡ í›„ ìë™ê³„ì‚°)
  const headers = ['ê³µê¸‰ì‚¬(ë¸Œëœë“œ)', 'ìƒí’ˆëª…', 'ì†Œë¹„ìì •ê°€', 'ê³µë™êµ¬ë§¤íŒë§¤ê°€', 'ê³µê¸‰ë‹¨ê°€(V+)'];
  const sampleData = [
    ['ë¡œì§€ì˜¤ê°€ë‹‰', 'ì§œë¨¹ëŠ” ì•„ë„¬ë¼HOP ì‹œì‘ê³¼ì¼ 14íŒ©', 64400, 34000, 27200],
    ['ë¡œì§€ì˜¤ê°€ë‹‰', 'ì§œë¨¹ëŠ” ì•„ë„¬ë¼HOP ì‹œì‘ê³¼ì¼ 28íŒ©', 138000, 65000, 52000],
    ['ê·¸ë¡œí™ˆ', 'ë¯¸ë„ëŸ¼ ë°©ì§€ ë¡¤ëŸ¬í˜ì¸íŠ¸ 1ê°œ', 29900, 24900, 19900]
  ];
  
  const ws = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
  ws['!cols'] = [{ wch: 15 }, { wch: 35 }, { wch: 12 }, { wch: 16 }, { wch: 14 }];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ìƒí’ˆë“±ë¡');
  XLSX.writeFile(wb, 'ê³µê¸‰ì‚¬ìƒí’ˆë“±ë¡_ì–‘ì‹.xlsx');
  showToast('ì–‘ì‹ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤');
}

function exportProductsToExcel() {
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    script.onload = () => doExportProducts();
    return;
  }
  doExportProducts();
}

function doExportProducts() {
  const products = state.supplierProducts || [];
  if (products.length === 0) { showToast('ë‚´ë³´ë‚¼ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤'); return; }
  
  const headers = ['ê³µê¸‰ì‚¬(ë¸Œëœë“œ)', 'ìƒí’ˆëª…', 'ì†Œë¹„ìì •ê°€', 'ê³µë™êµ¬ë§¤íŒë§¤ê°€', 'ê³µê¸‰ë‹¨ê°€(V+)', 'ì •ê°€í• ì¸ìœ¨', 'ì´ë§ˆì§„ìœ¨', 'ì´ë§ˆì§„ê¸ˆ'];
  const data = products.map(p => {
    const retailPrice = Number(p.retailPrice) || 0;
    const salePrice = Number(p.salePrice) || 0;
    const supplyPrice = Number(p.supplyPrice) || 0;
    const discountRate = retailPrice > 0 ? ((retailPrice - salePrice) / retailPrice * 100).toFixed(1) : 0;
    const totalMargin = salePrice - supplyPrice;
    const totalMarginRate = salePrice > 0 ? (totalMargin / salePrice * 100).toFixed(1) : 0;
    return [p.brandName, p.productName, retailPrice, salePrice, supplyPrice, discountRate + '%', totalMarginRate + '%', totalMargin];
  });
  
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  ws['!cols'] = [{ wch: 15 }, { wch: 35 }, { wch: 12 }, { wch: 16 }, { wch: 14 }, { wch: 10 }, { wch: 10 }, { wch: 12 }];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ê³µê¸‰ì‚¬ìƒí’ˆëª©ë¡');
  XLSX.writeFile(wb, `ê³µê¸‰ì‚¬ìƒí’ˆëª©ë¡_${formatDate(new Date())}.xlsx`);
  showToast('ìƒí’ˆ ëª©ë¡ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤');
}

// ========================================
// 2. ë§ˆì§„ ê³„ì‚°ê¸° (ë³„ë„ ë„êµ¬ - ì €ì¥ ì•ˆí•¨)
// ========================================
function openMarginCalculator() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const products = state.supplierProducts || [];
  const brands = state.settlementBrands || [];
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ§® ë§ˆì§„ ê³„ì‚°ê¸°</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <p style="color: var(--gray-600); font-size: 13px; margin-bottom: 16px;">
        ì…€ëŸ¬ì™€ í˜‘ìƒ ì‹œ ì‚¬ìš©í•˜ì„¸ìš”. ìƒí’ˆ ì„ íƒ í›„ <strong>ì…€ëŸ¬ ë§ˆì§„ìœ¨</strong>ë§Œ ì…ë ¥í•˜ë©´ <strong>ì…€ëŸ¬ ë§ˆì§„ê¸ˆ</strong>ê³¼ <strong>ëª¨ì—¬ë¼ë”œ ë§ˆì§„</strong>ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.
      </p>
      
      <!-- ìƒí’ˆ ê²€ìƒ‰ ì˜ì—­ -->
      <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ” ìƒí’ˆ ê²€ìƒ‰</div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
          <select id="calcBrandFilter" class="form-input" style="width: 150px;" onchange="filterCalcProducts()">
            <option value="">ì „ì²´ ë¸Œëœë“œ</option>
            ${brands.map(b => `<option value="${b.name}">${b.name}</option>`).join('')}
          </select>
          <input type="text" id="calcProductSearch" class="form-input" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." style="width: 200px;" oninput="filterCalcProducts()">
          <button class="btn btn-primary btn-sm" onclick="addSelectedCalcProducts()">âœ… ì„ íƒ ìƒí’ˆ ì¶”ê°€</button>
          <span style="margin-left: auto; font-size: 12px; color: var(--gray-500);">ì„ íƒë¨: <strong id="calcSelectedCount">0</strong>ê°œ</span>
        </div>
        <div style="max-height: 180px; overflow-y: auto; margin-top: 12px; border: 1px solid var(--gray-200); border-radius: 8px;" id="calcProductList">
          <table class="data-table" style="font-size: 12px; margin: 0;">
            <thead style="position: sticky; top: 0; background: var(--gray-100);">
              <tr>
                <th style="width: 30px;"><input type="checkbox" id="calcSelectAll" onchange="toggleCalcSelectAll(this)"></th>
                <th>ë¸Œëœë“œ</th>
                <th>ìƒí’ˆëª…</th>
                <th style="text-align: right;">ì†Œë¹„ìì •ê°€</th>
                <th style="text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
                <th style="text-align: right; background: var(--gray-50);">ê³µê¸‰ë‹¨ê°€(V+)</th>
                <th style="text-align: right;">ì´ë§ˆì§„ê¸ˆ</th>
              </tr>
            </thead>
            <tbody id="calcProductBody">
              ${products.map(p => {
                const totalMargin = (Number(p.salePrice)||0) - (Number(p.supplyPrice)||0);
                return `
                <tr data-brand="${p.brandName}" data-name="${p.productName}">
                  <td><input type="checkbox" class="calc-product-check" data-id="${p.id}"></td>
                  <td><span class="status-badge status-confirmed" style="font-size:11px;">${p.brandName||'-'}</span></td>
                  <td style="font-weight:500;">${p.productName||'-'}</td>
                  <td style="text-align:right;">${Number(p.retailPrice||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;">${Number(p.salePrice||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;background:var(--gray-50);">${Number(p.supplyPrice||0).toLocaleString()}ì›</td>
                  <td style="text-align:right;font-weight:600;color:${totalMargin>=0?'var(--success)':'var(--danger)'};">${totalMargin.toLocaleString()}ì›</td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- ê³„ì‚° í…Œì´ë¸” -->
      <div style="flex: 1; overflow: auto;">
        <table class="data-table" style="font-size: 12px; min-width: 900px;" id="calcTable">
          <thead>
            <tr style="background: var(--gray-100);">
              <th style="width: 30px;">No</th>
              <th style="min-width: 100px;">ë¸Œëœë“œ</th>
              <th style="min-width: 150px;">ìƒí’ˆëª…</th>
              <th style="width: 90px; text-align: right;">ê³µêµ¬íŒë§¤ê°€</th>
              <th style="width: 90px; text-align: right; background: var(--gray-50);">ê³µê¸‰ë‹¨ê°€(V+)</th>
              <th style="width: 80px; text-align: right;">ì´ë§ˆì§„ê¸ˆ</th>
              <th style="width: 80px; text-align: center; background: #dbeafe;">ì…€ëŸ¬ë§ˆì§„ìœ¨</th>
              <th style="width: 90px; text-align: right; background: #dbeafe;">ì…€ëŸ¬ë§ˆì§„ê¸ˆ</th>
              <th style="width: 80px; text-align: center; background: #dcfce7;">ëª¨ì—¬ë¼ë”œ%</th>
              <th style="width: 90px; text-align: right; background: #dcfce7;">ëª¨ì—¬ë¼ë”œë§ˆì§„</th>
              <th style="width: 40px;"></th>
            </tr>
          </thead>
          <tbody id="calcBody">
          </tbody>
        </table>
        <div id="calcEmptyState" style="text-align: center; padding: 40px; color: var(--gray-500);">
          <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“¦</div>
          <div>ìœ„ì—ì„œ ìƒí’ˆì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</div>
        </div>
      </div>
      
      <!-- í•©ê³„ ì˜ì—­ -->
      <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-top: 16px;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
          <div><div style="font-size: 11px; color: var(--gray-500);">ì´ íŒë§¤ê¸ˆì•¡</div><div style="font-size: 18px; font-weight: 700;" id="calcTotalSales">0ì›</div></div>
          <div><div style="font-size: 11px; color: var(--gray-500);">ì´ ë§ˆì§„ê¸ˆ</div><div style="font-size: 18px; font-weight: 700;" id="calcTotalMargin">0ì›</div></div>
          <div style="background: var(--gray-50); border-radius: 8px; padding: 8px;"><div style="font-size: 11px; color: var(--info);">ì…€ëŸ¬ ë§ˆì§„ í•©ê³„</div><div style="font-size: 18px; font-weight: 700; color: var(--info);" id="calcTotalSeller">0ì›</div></div>
          <div style="background: var(--gray-50); border-radius: 8px; padding: 8px;"><div style="font-size: 11px; color: var(--success);">ëª¨ì—¬ë¼ë”œ ë§ˆì§„ í•©ê³„</div><div style="font-size: 18px; font-weight: 700; color: var(--success);" id="calcTotalMoyeora">0ì›</div></div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="clearCalcRows()">ğŸ—‘ï¸ ëª¨ë‘ ì§€ìš°ê¸°</button>
        <button type="button" class="btn btn-primary" onclick="exportCalcToExcel()">ğŸ“¤ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

let calcRowId = 0;

function filterCalcProducts() {
  const brand = document.getElementById('calcBrandFilter').value.toLowerCase();
  const search = document.getElementById('calcProductSearch').value.toLowerCase();
  const rows = document.querySelectorAll('#calcProductBody tr');
  
  rows.forEach(row => {
    const rowBrand = (row.dataset.brand || '').toLowerCase();
    const rowName = (row.dataset.name || '').toLowerCase();
    const brandMatch = !brand || rowBrand === brand;
    const searchMatch = !search || rowName.includes(search);
    row.style.display = brandMatch && searchMatch ? '' : 'none';
  });
}

function toggleCalcSelectAll(checkbox) {
  const checkboxes = document.querySelectorAll('#calcProductBody tr:not([style*="display: none"]) .calc-product-check');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateCalcSelectedCount();
}

function updateCalcSelectedCount() {
  const count = document.querySelectorAll('.calc-product-check:checked').length;
  document.getElementById('calcSelectedCount').textContent = count;
}

// ì²´í¬ë°•ìŠ¤ ë³€ê²½ì‹œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('calc-product-check')) {
    updateCalcSelectedCount();
  }
});

function addSelectedCalcProducts() {
  const checkboxes = document.querySelectorAll('.calc-product-check:checked');
  if (checkboxes.length === 0) {
    showToast('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”');
    return;
  }
  
  const products = state.supplierProducts || [];
  
  checkboxes.forEach(cb => {
    const productId = cb.dataset.id;
    const product = products.find(p => p.id === productId);
    if (product) {
      addCalcRow({
        brandName: product.brandName,
        productName: product.productName,
        salePrice: product.salePrice,
        supplyPrice: product.supplyPrice,
        sellerRate: 20  // ê¸°ë³¸ ì…€ëŸ¬ ë§ˆì§„ìœ¨ 20%
      });
    }
    cb.checked = false;  // ì²´í¬ í•´ì œ
  });
  
  document.getElementById('calcSelectAll').checked = false;
  updateCalcSelectedCount();
  document.getElementById('calcEmptyState').style.display = 'none';
  showToast(`${checkboxes.length}ê°œ ìƒí’ˆì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤`);
}

function addCalcRow(data = {}) {
  calcRowId++;
  const tbody = document.getElementById('calcBody');
  const row = document.createElement('tr');
  row.id = `calcRow_${calcRowId}`;
  
  const salePrice = Number(data.salePrice) || 0;
  const supplyPrice = Number(data.supplyPrice) || 0;
  const totalMargin = salePrice - supplyPrice;
  const sellerRate = Number(data.sellerRate) || 20;
  const sellerAmt = Math.round(salePrice * sellerRate / 100);
  const moyeoraMargin = totalMargin - sellerAmt;
  const moyeoraRate = salePrice > 0 ? (moyeoraMargin / salePrice * 100) : 0;
  
  row.innerHTML = `
    <td style="text-align: center; color: var(--gray-500);">${calcRowId}</td>
    <td><span class="status-badge status-confirmed" style="font-size:11px;">${data.brandName || '-'}</span></td>
    <td style="font-weight:500;">${data.productName || '-'}</td>
    <td style="text-align:right;" class="calc-sale" data-value="${salePrice}">${salePrice.toLocaleString()}ì›</td>
    <td style="text-align:right;background:var(--gray-50);" class="calc-supply" data-value="${supplyPrice}">${supplyPrice.toLocaleString()}ì›</td>
    <td style="text-align:right;font-weight:600;" class="calc-margin-amt">${totalMargin.toLocaleString()}ì›</td>
    <td style="background: var(--gray-50);"><input type="number" class="form-input calc-seller-rate" style="font-size: 12px; padding: 6px; text-align: center; width: 60px;" value="${sellerRate}" step="1" oninput="recalcRow(this)">%</td>
    <td class="calc-seller-amt" style="text-align: right; background: var(--gray-50); font-weight:600; color:var(--info);">${sellerAmt.toLocaleString()}ì›</td>
    <td class="calc-moyeora-rate" style="text-align: center; background: var(--gray-50); color:var(--success);">${moyeoraRate.toFixed(1)}%</td>
    <td class="calc-moyeora-amt" style="text-align: right; background: var(--gray-50); font-weight: 600; color:var(--success);">${moyeoraMargin.toLocaleString()}ì›</td>
    <td><button class="btn btn-secondary btn-sm" style="padding: 4px 8px; color: var(--danger);" onclick="removeCalcRow('${row.id}')">Ã—</button></td>
  `;
  tbody.appendChild(row);
  updateCalcTotals();
}

function removeCalcRow(rowId) {
  document.getElementById(rowId)?.remove();
  updateCalcTotals();
  
  // ë¹ˆ ìƒíƒœ ì²´í¬
  if (document.querySelectorAll('#calcBody tr').length === 0) {
    document.getElementById('calcEmptyState').style.display = '';
  }
}

function clearCalcRows() {
  document.getElementById('calcBody').innerHTML = '';
  calcRowId = 0;
  document.getElementById('calcEmptyState').style.display = '';
  updateCalcTotals();
}

function loadProductsToCalc() {
  const products = state.supplierProducts || [];
  if (products.length === 0) { showToast('ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤'); return; }
  
  document.getElementById('calcBody').innerHTML = '';
  calcRowId = 0;
  
  products.forEach(p => {
    addCalcRow({
      brandName: p.brandName,
      productName: p.productName,
      salePrice: p.salePrice,
      supplyPrice: p.supplyPrice,
      sellerRate: 20
    });
  });
  
  document.getElementById('calcEmptyState').style.display = 'none';
  showToast(`${products.length}ê°œ ìƒí’ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
}

function recalcRow(input) {
  const row = input.closest('tr');
  const salePrice = Number(row.querySelector('.calc-sale').dataset.value) || 0;
  const supplyPrice = Number(row.querySelector('.calc-supply').dataset.value) || 0;
  const sellerRate = Number(row.querySelector('.calc-seller-rate').value) || 0;
  
  // ì´ë§ˆì§„ê¸ˆ
  const totalMargin = salePrice - supplyPrice;
  
  // ì…€ëŸ¬ ë§ˆì§„ê¸ˆ (íŒë§¤ê°€ Ã— ì…€ëŸ¬ë§ˆì§„ìœ¨)
  const sellerAmt = Math.round(salePrice * sellerRate / 100);
  row.querySelector('.calc-seller-amt').textContent = sellerAmt.toLocaleString() + 'ì›';
  
  // ëª¨ì—¬ë¼ë”œ ë§ˆì§„ (ì´ë§ˆì§„ê¸ˆ - ì…€ëŸ¬ë§ˆì§„ê¸ˆ)
  const moyeoraMargin = totalMargin - sellerAmt;
  const moyeoraRate = salePrice > 0 ? (moyeoraMargin / salePrice * 100) : 0;
  
  const moyeoraRateCell = row.querySelector('.calc-moyeora-rate');
  const moyeoraAmtCell = row.querySelector('.calc-moyeora-amt');
  
  moyeoraRateCell.textContent = moyeoraRate.toFixed(1) + '%';
  moyeoraAmtCell.textContent = moyeoraMargin.toLocaleString() + 'ì›';
  
  // ë§ˆì§„ì´ ë§ˆì´ë„ˆìŠ¤ë©´ ë¹¨ê°„ìƒ‰ í‘œì‹œ
  moyeoraRateCell.style.color = moyeoraMargin < 0 ? 'var(--danger)' : 'var(--success)';
  moyeoraAmtCell.style.color = moyeoraMargin < 0 ? 'var(--danger)' : 'var(--success)';
  
  updateCalcTotals();
}

function updateCalcTotals() {
  const rows = document.querySelectorAll('#calcBody tr');
  let totalSales = 0, totalMargin = 0, totalSeller = 0, totalMoyeora = 0;
  
  rows.forEach(row => {
    const salePrice = Number(row.querySelector('.calc-sale')?.dataset?.value) || 0;
    const supplyPrice = Number(row.querySelector('.calc-supply')?.dataset?.value) || 0;
    const sellerRate = Number(row.querySelector('.calc-seller-rate')?.value) || 0;
    
    const margin = salePrice - supplyPrice;
    const sellerAmt = Math.round(salePrice * sellerRate / 100);
    const moyeoraAmt = margin - sellerAmt;
    
    totalSales += salePrice;
    totalMargin += margin;
    totalSeller += sellerAmt;
    totalMoyeora += moyeoraAmt;
  });
  
  document.getElementById('calcTotalSales').textContent = totalSales.toLocaleString() + 'ì›';
  document.getElementById('calcTotalMargin').textContent = totalMargin.toLocaleString() + 'ì›';
  document.getElementById('calcTotalSeller').textContent = totalSeller.toLocaleString() + 'ì›';
  document.getElementById('calcTotalMoyeora').textContent = totalMoyeora.toLocaleString() + 'ì›';
  document.getElementById('calcTotalMoyeora').style.color = totalMoyeora < 0 ? 'var(--danger)' : 'var(--success)';
}

function exportCalcToExcel() {
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(script);
    script.onload = () => doExportCalc();
    return;
  }
  doExportCalc();
}

function doExportCalc() {
  const rows = document.querySelectorAll('#calcBody tr');
  const headers = ['No', 'ë¸Œëœë“œ', 'ìƒí’ˆëª…', 'ê³µêµ¬íŒë§¤ê°€', 'ê³µê¸‰ë‹¨ê°€(V+)', 'ì´ë§ˆì§„ê¸ˆ', 'ì…€ëŸ¬ë§ˆì§„ìœ¨(%)', 'ì…€ëŸ¬ë§ˆì§„ê¸ˆ', 'ëª¨ì—¬ë¼ë”œë§ˆì§„ìœ¨(%)', 'ëª¨ì—¬ë¼ë”œë§ˆì§„ê¸ˆ'];
  const data = [];
  
  rows.forEach((row, idx) => {
    const brandName = row.querySelector('.status-badge')?.textContent || '';
    const productName = row.querySelectorAll('td')[2]?.textContent || '';
    const salePrice = Number(row.querySelector('.calc-sale')?.dataset?.value) || 0;
    const supplyPrice = Number(row.querySelector('.calc-supply')?.dataset?.value) || 0;
    const sellerRate = Number(row.querySelector('.calc-seller-rate')?.value) || 0;
    
    if (!productName || productName === '-') return;
    
    const totalMargin = salePrice - supplyPrice;
    const sellerAmt = Math.round(salePrice * sellerRate / 100);
    const moyeoraMargin = totalMargin - sellerAmt;
    const moyeoraRate = salePrice > 0 ? (moyeoraMargin / salePrice * 100) : 0;
    
    data.push([idx + 1, brandName, productName, salePrice, supplyPrice, totalMargin, sellerRate + '%', sellerAmt, moyeoraRate.toFixed(1) + '%', moyeoraMargin]);
  });
  
  if (data.length === 0) { showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
  
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  ws['!cols'] = [{ wch: 5 }, { wch: 15 }, { wch: 30 }, { wch: 12 }, { wch: 14 }, { wch: 12 }, { wch: 14 }, { wch: 12 }, { wch: 16 }, { wch: 14 }];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ë§ˆì§„ê³„ì‚°');
  XLSX.writeFile(wb, `ë§ˆì§„ê³„ì‚°_${formatDate(new Date())}.xlsx`);
  showToast('ë§ˆì§„ ê³„ì‚° ê²°ê³¼ê°€ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤');
}

function openSupplierSettlementModal(item = null) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const isEdit = item !== null;
  const s = item || { brandName: '', sellerName: '', sellerId: '', dealPeriod: '', settlementDate: formatDate(new Date()), items: [], notes: '' };
  const brands = state.settlementBrands || [];
  const sellers = state.sellers || [];
  const settlementItems = s.items || [];
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header"><h2 class="modal-title">${isEdit ? 'ê³µê¸‰ì‚¬ ì •ì‚° ìˆ˜ì •' : 'ìƒˆ ê³µê¸‰ì‚¬ ì •ì‚° ë“±ë¡'}</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      <div style="background: #fef3c3; border-radius: 12px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #d97706;">
        <div style="font-weight: 600; color: var(--gray-600);">ğŸ­ ê³µê¸‰ì‚¬ ì •ì‚°</div>
        <div style="font-size: 13px; color: var(--gray-600);">ìƒí’ˆì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ê³  íŒë§¤ìˆ˜ëŸ‰ë§Œ ì…ë ¥í•˜ë©´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</div>
      </div>
      <form onsubmit="submitSupplierSettlement(event, '${s.id || ''}')">
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê³µê¸‰ì‚¬(ë¸Œëœë“œ) *</label><input type="text" class="form-input" id="sps-brandName" value="${s.brandName}" required placeholder="ì˜ˆ: ë¡œì§€ì˜¤ê°€ë‹‰" list="brand-list" onchange="onBrandNameChange()"><datalist id="brand-list">${brands.map(b => `<option value="${b.name}">`).join('')}</datalist></div>
          <div class="form-group">
            <label class="form-label">ì…€ëŸ¬ëª… *</label>
            <div style="position: relative;">
              <input type="text" class="form-input" id="sps-sellerName" value="${s.sellerName}" required placeholder="ì…€ëŸ¬ ê²€ìƒ‰..." autocomplete="off" oninput="filterSellerDropdown(this.value)" onfocus="showSellerDropdown()">
              <input type="hidden" id="sps-sellerId" value="${s.sellerId || ''}">
              <div id="seller-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; z-index: 100;">
                ${sellers.map(seller => `
                  <div class="seller-option" onclick="selectSeller('${seller.id}', '${seller.nickname || seller.name}')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--gray-100); transition: background 0.15s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='white'">
                    <div style="font-weight: 600; color: var(--gray-900);">${seller.nickname || '-'}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">${seller.name || ''} ${seller.phone ? 'Â· ' + seller.phone : ''}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ê³µêµ¬ ê¸°ê°„</label><input type="text" class="form-input" id="sps-dealPeriod" value="${s.dealPeriod}" placeholder="2025-11-27~2025-11-30"></div>
          <div class="form-group"><label class="form-label">ì •ì‚°ì¼</label><input type="date" class="form-input" id="sps-settlementDate" value="${s.settlementDate}"></div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">íŒë§¤ê¸ˆì•¡ (ì†Œë¹„ì ê²°ì œ ì´ì•¡) *</label>
            <input type="number" class="form-input" id="sps-salesAmount" value="${s.salesAmount || ''}" required placeholder="ì˜ˆ: 49700" style="background: var(--gray-50); font-weight: 600; font-size: 16px;">
            <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">ğŸ’¡ í•´ë‹¹ ê³µêµ¬ì˜ ì´ íŒë§¤ê¸ˆì•¡ (ì…€ëŸ¬ ì •ì‚°ì˜ íŒë§¤ê¸ˆì•¡ê³¼ ë™ì¼)</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <label class="form-label" style="margin: 0; font-weight: 600;">ğŸ“¦ ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ì…ë ¥</label>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn btn-primary btn-sm" onclick="openProductSearchModal()">ğŸ” ìƒí’ˆ ê²€ìƒ‰ ì¶”ê°€</button>
              <button type="button" class="btn btn-secondary btn-sm" onclick="openSupplierProductModal()">ìƒí’ˆ ê´€ë¦¬</button>
            </div>
          </div>
          
          <div id="sps-productsList" style="max-height: 350px; overflow-y: auto;">
            ${settlementItems.length === 0 ? `<div style="color: var(--gray-500); font-size: 13px; text-align: center; padding: 30px;">ğŸ” ìƒí’ˆ ê²€ìƒ‰ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒí’ˆì„ ì¶”ê°€í•˜ì„¸ìš”</div>` : `
              <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                <thead><tr style="background: var(--gray-200);"><th style="padding: 8px; text-align: left;">No.</th><th style="padding: 8px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ë‹¨ê°€(VAT+)</th><th style="padding: 8px; text-align: center; width: 80px; background: var(--gray-50);">íŒë§¤ìˆ˜ëŸ‰</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ê°€ì•¡</th><th style="padding: 8px; text-align: right;">ë¶€ê°€ì„¸(10%)</th><th style="padding: 8px; text-align: right; background: #d1fae5;">í•©ê³„ê¸ˆì•¡(VATí¬í•¨)</th><th style="width: 40px;"></th></tr></thead>
                <tbody>
                  ${settlementItems.map((si, idx) => `<tr style="border-bottom: 1px solid var(--gray-200);" data-product-id="${si.productId}" data-supply-price="${si.supplyPrice}"><td style="padding: 8px;">${idx + 1}</td><td style="padding: 8px;">${si.productName}</td><td style="padding: 8px; text-align: right;">${Number(si.supplyPrice).toLocaleString()}ì›</td><td style="padding: 4px; text-align: center;"><input type="number" class="form-input sps-qty" value="${si.quantity}" min="0" style="width: 70px; text-align: center; padding: 6px; background: var(--gray-50);" oninput="calculateSupplierRow(this)"></td><td style="padding: 8px; text-align: right;" class="sps-supply">0ì›</td><td style="padding: 8px; text-align: right;" class="sps-vat">0ì›</td><td style="padding: 8px; text-align: right; font-weight: 600; background: #ecfdf5;" class="sps-total">0ì›</td><td style="padding: 4px;"><button type="button" class="btn btn-secondary btn-sm" style="padding: 4px 8px; color: var(--danger);" onclick="removeSettlementProduct(this)">Ã—</button></td></tr>`).join('')}
                </tbody>
                <tfoot><tr style="background: var(--gray-100); font-weight: 700;"><td colspan="3" style="padding: 10px;">í•© ê³„</td><td style="padding: 10px; text-align: center;" id="sps-totalQty">0</td><td style="padding: 10px; text-align: right;" id="sps-totalSupply">0ì›</td><td style="padding: 10px; text-align: right;" id="sps-totalVat">0ì›</td><td style="padding: 10px; text-align: right; background: #d1fae5;" id="sps-grandTotal">0ì›</td><td></td></tr></tfoot>
              </table>
            `}
          </div>
        </div>
        
        <div class="form-group"><label class="form-label">ë¹„ê³ </label><textarea class="form-textarea" id="sps-notes" rows="2" placeholder="ì¶”ê°€ ë©”ëª¨">${s.notes || ''}</textarea></div>
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSupplierSettlement('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  setTimeout(() => { document.querySelectorAll('.sps-qty').forEach(input => calculateSupplierRow(input)); }, 100);
  
  // ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
  document.addEventListener('click', closeSellerDropdownOnOutsideClick);
}

// ì…€ëŸ¬ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
function showSellerDropdown() {
  const dropdown = document.getElementById('seller-dropdown');
  if (dropdown) {
    dropdown.style.display = 'block';
    filterSellerDropdown(document.getElementById('sps-sellerName').value);
  }
}

// ì…€ëŸ¬ ë“œë¡­ë‹¤ìš´ í•„í„°ë§
function filterSellerDropdown(searchText) {
  const dropdown = document.getElementById('seller-dropdown');
  if (!dropdown) return;
  
  const sellers = state.sellers || [];
  const filtered = sellers.filter(seller => {
    const nickname = (seller.nickname || '').toLowerCase();
    const name = (seller.name || '').toLowerCase();
    const search = searchText.toLowerCase();
    return nickname.includes(search) || name.includes(search);
  });
  
  dropdown.innerHTML = filtered.length === 0 
    ? `<div style="padding: 16px; text-align: center; color: var(--gray-500);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>`
    : filtered.map(seller => `
      <div class="seller-option" onclick="selectSeller('${seller.id}', '${seller.nickname || seller.name}')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--gray-100); transition: background 0.15s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='white'">
        <div style="font-weight: 600; color: var(--gray-900);">${seller.nickname || '-'}</div>
        <div style="font-size: 12px; color: var(--gray-500);">${seller.name || ''} ${seller.phone ? 'Â· ' + seller.phone : ''}</div>
      </div>
    `).join('');
  
  dropdown.style.display = 'block';
}

// ì…€ëŸ¬ ì„ íƒ
function selectSeller(sellerId, sellerNickname) {
  document.getElementById('sps-sellerName').value = sellerNickname;
  document.getElementById('sps-sellerId').value = sellerId;
  document.getElementById('seller-dropdown').style.display = 'none';
  
  // í•´ë‹¹ ì…€ëŸ¬ì˜ íƒ€ì‚¬ìƒí’ˆ ì •ì‚° ë‚´ì—­ì—ì„œ íŒë§¤ê¸ˆì•¡ ìë™ ì—°ë™
  const brandName = document.getElementById('sps-brandName').value;
  if (brandName && sellerId) {
    autoFillSalesAmount(sellerId, sellerNickname, brandName);
  }
}

// íŒë§¤ê¸ˆì•¡ ìë™ ì—°ë™ (ì…€ëŸ¬ ì •ì‚°ì—ì„œ ë™ì¼ ê³µêµ¬ ì°¾ê¸°)
function autoFillSalesAmount(sellerId, sellerNickname, brandName) {
  const sellerSettlements = state.sellerSettlements || [];
  
  // ë™ì¼ ì…€ëŸ¬ + ë™ì¼ ë¸Œëœë“œì˜ ìµœê·¼ ì •ì‚° ì°¾ê¸°
  const matchingSettlement = sellerSettlements.find(s => {
    const matchSeller = s.sellerId === sellerId || (s.sellerName || '').includes(sellerNickname);
    const matchBrand = (s.brandName || '').includes(brandName) || (brandName || '').includes(s.brandName || '');
    return matchSeller && matchBrand && !s.isInhouse;
  });
  
  if (matchingSettlement && matchingSettlement.salesAmount) {
    const salesAmountInput = document.getElementById('sps-salesAmount');
    if (salesAmountInput && !salesAmountInput.value) {
      salesAmountInput.value = matchingSettlement.salesAmount;
      showToast(`ì…€ëŸ¬ ì •ì‚°ì—ì„œ íŒë§¤ê¸ˆì•¡ ${Number(matchingSettlement.salesAmount).toLocaleString()}ì›ì´ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤`);
    }
  }
}

// ë¸Œëœë“œëª… ë³€ê²½ ì‹œ ìë™ ì—°ë™ íŠ¸ë¦¬ê±°
function onBrandNameChange() {
  const brandName = document.getElementById('sps-brandName').value;
  const sellerId = document.getElementById('sps-sellerId')?.value;
  const sellerNickname = document.getElementById('sps-sellerName').value;
  
  if (brandName && (sellerId || sellerNickname)) {
    autoFillSalesAmount(sellerId, sellerNickname, brandName);
  }
}

// ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
function closeSellerDropdownOnOutsideClick(e) {
  const dropdown = document.getElementById('seller-dropdown');
  const input = document.getElementById('sps-sellerName');
  if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
    dropdown.style.display = 'none';
  }
}

// ìƒí’ˆ ê²€ìƒ‰ ëª¨ë‹¬
function openProductSearchModal() {
  const products = state.supplierProducts || [];
  const brands = [...new Set(products.map(p => p.brandName))];
  
  const searchModal = document.createElement('div');
  searchModal.id = 'productSearchModal';
  searchModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  searchModal.innerHTML = `
    <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">ğŸ” ìƒí’ˆ ê²€ìƒ‰</h3>
        <button onclick="document.getElementById('productSearchModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
      </div>
      <div style="padding: 16px; border-bottom: 1px solid var(--gray-200);">
        <div style="display: flex; gap: 8px;">
          <select id="search-brand-filter" class="form-input" style="width: 150px;" onchange="filterSearchProducts()">
            <option value="">ì „ì²´ ë¸Œëœë“œ</option>
            ${brands.map(b => `<option value="${b}">${b}</option>`).join('')}
          </select>
          <input type="text" id="search-product-input" class="form-input" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." oninput="filterSearchProducts()" style="flex: 1;">
        </div>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 16px;" id="search-results">
        ${renderSearchResults(products)}
      </div>
      <div style="padding: 16px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 13px; color: var(--gray-600);"><span id="selected-count">0</span>ê°œ ì„ íƒë¨</span>
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('productSearchModal').remove()">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="addSelectedProducts()">ì„ íƒ ìƒí’ˆ ì¶”ê°€</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(searchModal);
}

function renderSearchResults(products) {
  if (products.length === 0) {
    return '<div style="text-align: center; padding: 40px; color: var(--gray-500);">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>';
  }
  
  // ì´ë¯¸ ì¶”ê°€ëœ ìƒí’ˆ ID ëª©ë¡
  const existingIds = [];
  document.querySelectorAll('#sps-productsList tbody tr').forEach(tr => {
    if (tr.dataset.productId) existingIds.push(tr.dataset.productId);
  });
  
  return `
    <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
      <thead><tr style="background: var(--gray-100);"><th style="padding: 8px; width: 40px;"></th><th style="padding: 8px; text-align: left;">ë¸Œëœë“œ</th><th style="padding: 8px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ë‹¨ê°€</th></tr></thead>
      <tbody>
        ${products.map(p => {
          const isExisting = existingIds.includes(p.id);
          return `<tr style="border-bottom: 1px solid var(--gray-200); ${isExisting ? 'opacity: 0.5;' : ''}" data-product='${JSON.stringify(p).replace(/'/g, "&#39;")}'>
            <td style="padding: 8px; text-align: center;">
              <input type="checkbox" class="search-checkbox" ${isExisting ? 'disabled checked' : ''} onchange="updateSelectedCount()" style="width: 18px; height: 18px; cursor: ${isExisting ? 'not-allowed' : 'pointer'};">
            </td>
            <td style="padding: 8px;"><span class="status-badge status-negotiating" style="font-size: 11px;">${p.brandName}</span></td>
            <td style="padding: 8px;">${p.productName}</td>
            <td style="padding: 8px; text-align: right; font-weight: 600;">${Number(p.supplyPrice).toLocaleString()}ì›</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  `;
}

function filterSearchProducts() {
  const brandFilter = document.getElementById('search-brand-filter').value;
  const searchText = document.getElementById('search-product-input').value.toLowerCase();
  const products = state.supplierProducts || [];
  
  const filtered = products.filter(p => {
    const matchBrand = !brandFilter || p.brandName === brandFilter;
    const matchText = !searchText || p.productName.toLowerCase().includes(searchText) || p.brandName.toLowerCase().includes(searchText);
    return matchBrand && matchText;
  });
  
  document.getElementById('search-results').innerHTML = renderSearchResults(filtered);
  updateSelectedCount();
}

function updateSelectedCount() {
  const count = document.querySelectorAll('.search-checkbox:checked:not(:disabled)').length;
  const countEl = document.getElementById('selected-count');
  if (countEl) countEl.textContent = count;
}

function addSelectedProducts() {
  const selectedProducts = [];
  document.querySelectorAll('.search-checkbox:checked:not(:disabled)').forEach(checkbox => {
    const row = checkbox.closest('tr');
    const productData = JSON.parse(row.dataset.product);
    selectedProducts.push(productData);
  });
  
  if (selectedProducts.length === 0) {
    showToast('ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // ìƒí’ˆ ëª©ë¡ í…Œì´ë¸”ì— ì¶”ê°€
  const container = document.getElementById('sps-productsList');
  let tbody = container.querySelector('tbody');
  
  if (!tbody) {
    // ì²« ìƒí’ˆ ì¶”ê°€ ì‹œ í…Œì´ë¸” ìƒì„±
    container.innerHTML = `
      <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
        <thead><tr style="background: var(--gray-200);"><th style="padding: 8px; text-align: left;">No.</th><th style="padding: 8px; text-align: left;">ìƒí’ˆëª…</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ë‹¨ê°€(VAT+)</th><th style="padding: 8px; text-align: center; width: 80px; background: var(--gray-50);">íŒë§¤ìˆ˜ëŸ‰</th><th style="padding: 8px; text-align: right;">ê³µê¸‰ê°€ì•¡</th><th style="padding: 8px; text-align: right;">ë¶€ê°€ì„¸(10%)</th><th style="padding: 8px; text-align: right; background: #d1fae5;">í•©ê³„ê¸ˆì•¡(VATí¬í•¨)</th><th style="width: 40px;"></th></tr></thead>
        <tbody></tbody>
        <tfoot><tr style="background: var(--gray-100); font-weight: 700;"><td colspan="3" style="padding: 10px;">í•© ê³„</td><td style="padding: 10px; text-align: center;" id="sps-totalQty">0</td><td style="padding: 10px; text-align: right;" id="sps-totalSupply">0ì›</td><td style="padding: 10px; text-align: right;" id="sps-totalVat">0ì›</td><td style="padding: 10px; text-align: right; background: #d1fae5;" id="sps-grandTotal">0ì›</td><td></td></tr></tfoot>
      </table>
    `;
    tbody = container.querySelector('tbody');
  }
  
  // ê¸°ì¡´ í–‰ ê°œìˆ˜
  const existingCount = tbody.querySelectorAll('tr').length;
  
  selectedProducts.forEach((p, idx) => {
    const rowNum = existingCount + idx + 1;
    const newRow = document.createElement('tr');
    newRow.style.cssText = 'border-bottom: 1px solid var(--gray-200);';
    newRow.dataset.productId = p.id;
    newRow.dataset.supplyPrice = p.supplyPrice;
    newRow.innerHTML = `
      <td style="padding: 8px;">${rowNum}</td>
      <td style="padding: 8px;">${p.productName}</td>
      <td style="padding: 8px; text-align: right;">${Number(p.supplyPrice).toLocaleString()}ì›</td>
      <td style="padding: 4px; text-align: center;"><input type="number" class="form-input sps-qty" value="0" min="0" style="width: 70px; text-align: center; padding: 6px; background: var(--gray-50);" oninput="calculateSupplierRow(this)"></td>
      <td style="padding: 8px; text-align: right;" class="sps-supply">0ì›</td>
      <td style="padding: 8px; text-align: right;" class="sps-vat">0ì›</td>
      <td style="padding: 8px; text-align: right; font-weight: 600; background: #ecfdf5;" class="sps-total">0ì›</td>
      <td style="padding: 4px;"><button type="button" class="btn btn-secondary btn-sm" style="padding: 4px 8px; color: var(--danger);" onclick="removeSettlementProduct(this)">Ã—</button></td>
    `;
    tbody.appendChild(newRow);
  });
  
  // í–‰ ë²ˆí˜¸ ì¬ì •ë ¬
  renumberSettlementRows();
  
  document.getElementById('productSearchModal').remove();
  showToast(`${selectedProducts.length}ê°œ ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
}

function removeSettlementProduct(btn) {
  btn.closest('tr').remove();
  renumberSettlementRows();
  // í•©ê³„ ì¬ê³„ì‚°
  const firstQty = document.querySelector('.sps-qty');
  if (firstQty) calculateSupplierRow(firstQty);
  else {
    // ëª¨ë“  ìƒí’ˆ ì‚­ì œë¨
    document.getElementById('sps-productsList').innerHTML = `<div style="color: var(--gray-500); font-size: 13px; text-align: center; padding: 30px;">ğŸ” ìƒí’ˆ ê²€ìƒ‰ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒí’ˆì„ ì¶”ê°€í•˜ì„¸ìš”</div>`;
  }
}

function renumberSettlementRows() {
  document.querySelectorAll('#sps-productsList tbody tr').forEach((tr, idx) => {
    tr.querySelector('td:first-child').textContent = idx + 1;
  });
}

function loadBrandProducts() {
  // ì´ì „ í˜¸í™˜ì„± ìœ ì§€ (ì‚¬ìš© ì•ˆí•¨)
}

function calculateSupplierRow(input) {
  const row = input.closest('tr');
  const supplyPrice = Number(row.dataset.supplyPrice) || 0;
  const quantity = Number(input.value) || 0;
  const supplyAmount = Math.round(supplyPrice * quantity / 1.1);
  const vatAmount = Math.round(supplyAmount * 0.1);
  const totalAmount = supplyAmount + vatAmount;
  
  row.querySelector('.sps-supply').textContent = supplyAmount.toLocaleString() + 'ì›';
  row.querySelector('.sps-vat').textContent = vatAmount.toLocaleString() + 'ì›';
  row.querySelector('.sps-total').textContent = totalAmount.toLocaleString() + 'ì›';
  
  let totalQty = 0, totalSupply = 0, totalVat = 0, grandTotal = 0;
  document.querySelectorAll('#sps-productsList tbody tr').forEach(tr => {
    const qty = Number(tr.querySelector('.sps-qty')?.value) || 0;
    const price = Number(tr.dataset.supplyPrice) || 0;
    const supply = Math.round(price * qty / 1.1);
    const vat = Math.round(supply * 0.1);
    totalQty += qty; totalSupply += supply; totalVat += vat; grandTotal += supply + vat;
  });
  
  if (document.getElementById('sps-totalQty')) document.getElementById('sps-totalQty').textContent = totalQty;
  if (document.getElementById('sps-totalSupply')) document.getElementById('sps-totalSupply').textContent = totalSupply.toLocaleString() + 'ì›';
  if (document.getElementById('sps-totalVat')) document.getElementById('sps-totalVat').textContent = totalVat.toLocaleString() + 'ì›';
  if (document.getElementById('sps-grandTotal')) document.getElementById('sps-grandTotal').textContent = grandTotal.toLocaleString() + 'ì›';
}

async function submitSupplierSettlement(e, id) {
  e.preventDefault();
  const items = [];
  let totalQuantity = 0, totalSupplyAmount = 0, totalVatAmount = 0, totalAmount = 0;
  
  document.querySelectorAll('#sps-productsList tbody tr').forEach(tr => {
    const productId = tr.dataset.productId;
    const supplyPrice = Number(tr.dataset.supplyPrice) || 0;
    const quantity = Number(tr.querySelector('.sps-qty')?.value) || 0;
    if (quantity > 0) {
      const supplyAmount = Math.round(supplyPrice * quantity / 1.1);
      const vatAmount = Math.round(supplyAmount * 0.1);
      const productName = tr.querySelectorAll('td')[1].textContent;
      items.push({ productId, productName, supplyPrice, quantity, supplyAmount, vatAmount, totalAmount: supplyAmount + vatAmount });
      totalQuantity += quantity; totalSupplyAmount += supplyAmount; totalVatAmount += vatAmount; totalAmount += supplyAmount + vatAmount;
    }
  });
  
  // supplierId ì°¾ê¸° (ë¸Œëœë“œëª…ìœ¼ë¡œ ë§¤ì¹­)
  const brandNameValue = document.getElementById('sps-brandName').value;
  const matchedSupplier = state.suppliers.find(s => s.name === brandNameValue);
  const supplierId = matchedSupplier?.id || '';
  
  const data = {
    brandName: brandNameValue, 
    supplierId: supplierId,
    sellerName: document.getElementById('sps-sellerName').value,
    sellerId: document.getElementById('sps-sellerId')?.value || '',
    dealPeriod: document.getElementById('sps-dealPeriod').value, 
    settlementDate: document.getElementById('sps-settlementDate').value,
    salesAmount: Number(document.getElementById('sps-salesAmount').value) || 0,
    items, totalQuantity, totalSupplyAmount, totalVatAmount, totalAmount,
    notes: document.getElementById('sps-notes').value, updatedAt: new Date().toISOString()
  };
  
  try {
    if (id) { await db.collection('supplierSettlements').doc(id).update(data); }
    else { data.createdAt = new Date().toISOString(); await db.collection('supplierSettlements').add(data); }
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤'); closeModal();
  } catch(err) { showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

async function deleteSupplierSettlement(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try { await db.collection('supplierSettlements').doc(id).delete(); showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); closeModal(); } catch(err) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

// ì´ë²¤íŠ¸ë¹„ìš© ì„¤ì • ëª¨ë‹¬
function openEventCostModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const eventCost = state.eventCost || 0;
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header"><h2 class="modal-title">ğŸ ì´ë²¤íŠ¸ë¹„ìš© ì„¤ì •</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      <div style="padding: 20px 0;">
        <div style="background: #fef3c3; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="font-size: 13px; color: var(--gray-600);">
            <strong>ì´ë²¤íŠ¸ë¹„ìš©ì´ë€?</strong><br>
            ì…€ëŸ¬ì—ê²Œ ë¬´ë£Œë¡œ ì§€ì›í•œ ì„œë¹„ìŠ¤ ë¹„ìš©ì…ë‹ˆë‹¤.<br>
            ì˜ˆ: ë¬´ë£Œ ë°°ì†¡ë¹„ ì§€ì›, ìƒ˜í”Œ ì œê³µ, í”„ë¡œëª¨ì…˜ ë¹„ìš© ë“±
          </div>
        </div>
        <form onsubmit="saveEventCost(event)">
          <div class="form-group">
            <label class="form-label">ì´ë²¤íŠ¸ë¹„ìš© (ì›)</label>
            <input type="number" class="form-input" id="event-cost-input" value="${eventCost}" placeholder="0" style="font-size: 18px; text-align: right;">
          </div>
          <div style="background: var(--gray-50); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; font-size: 14px;">
              <span style="color: var(--gray-600);">í˜„ì¬ ì„¤ì •ëœ ì´ë²¤íŠ¸ë¹„ìš©</span>
              <span style="font-weight: 700; color: var(--danger);">${eventCost.toLocaleString()}ì›</span>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
          </div>
        </form>
      </div>
    </div>
  `;
}

async function saveEventCost(e) {
  e.preventDefault();
  const eventCost = Number(document.getElementById('event-cost-input').value) || 0;
  
  try {
    // settings ì»¬ë ‰ì…˜ì— ì €ì¥
    await db.collection('settings').doc('eventCost').set({ value: eventCost, updatedAt: new Date().toISOString() });
    state.eventCost = eventCost;
    showToast('ì´ë²¤íŠ¸ë¹„ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    render();
  } catch(err) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

function openBrandManageModal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const suppliers = state.suppliers || [];
  
  // ê³µê¸‰ì‚¬ë¥¼ ìœ í˜•ë³„ë¡œ ë¶„ë¥˜
  const inhouseSuppliers = suppliers.filter(s => s.supplierType === 'inhouse');
  const externalSuppliers = suppliers.filter(s => s.supplierType !== 'inhouse');
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header"><h2 class="modal-title">ğŸ·ï¸ ë¸Œëœë“œ(ê³µê¸‰ì‚¬) ê´€ë¦¬</h2><button class="modal-close" onclick="closeModal()">Ã—</button></div>
      
      <div style="background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 20px;">ğŸ’¡</span>
          <strong style="color: var(--gray-600);">ê³µê¸‰ì‚¬ ì •ë³´ ì—°ë™</strong>
        </div>
        <p style="color: var(--gray-500); font-size: 13px; margin: 0;">
          ì™¼ìª½ ë©”ë‰´ì˜ <strong>'ê³µê¸‰ì‚¬'</strong>ì—ì„œ ë“±ë¡í•œ ë°ì´í„°ì™€ ì—°ë™ë©ë‹ˆë‹¤.<br>
          ìƒˆ ê³µê¸‰ì‚¬ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ ê³µê¸‰ì‚¬ ë©”ë‰´ì—ì„œ ë“±ë¡í•˜ì„¸ìš”.
        </p>
        <button class="btn btn-sm" style="margin-top: 12px; background: var(--gray-600); color: #fff;" onclick="closeModal(); setTab('suppliers')">
          ğŸ­ ê³µê¸‰ì‚¬ ê´€ë¦¬ ë°”ë¡œê°€ê¸°
        </button>
      </div>
      
      <div style="max-height: 400px; overflow-y: auto;">
        <!-- ìì‚¬ ê³µê¸‰ì‚¬ -->
        <div style="margin-bottom: 20px;">
          <h3 style="font-size: 14px; color: var(--info); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span style="background: var(--info); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">ìì‚¬</span>
            ìì‚¬ ê³µê¸‰ì‚¬ (${inhouseSuppliers.length}ê°œ)
          </h3>
          ${inhouseSuppliers.length === 0 ? 
            '<div style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">ìì‚¬ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
            `<table class="data-table" style="font-size: 13px;">
              <thead><tr><th>ê³µê¸‰ì‚¬ëª…</th><th>ë‹´ë‹¹ì</th><th>ê³„ì•½ìƒíƒœ</th></tr></thead>
              <tbody>${inhouseSuppliers.map(s => `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td>${s.managerName || '-'}</td>
                  <td><span class="status-badge ${s.contractStatus === 'completed' ? 'status-confirmed' : 'status-negotiating'}">${s.contractStatus === 'completed' ? 'ê³„ì•½ì™„ë£Œ' : 'í˜‘ì˜ì¤‘'}</span></td>
                </tr>
              `).join('')}</tbody>
            </table>`
          }
        </div>
        
        <!-- íƒ€ì‚¬ ê³µê¸‰ì‚¬ -->
        <div>
          <h3 style="font-size: 14px; color: var(--success); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span style="background: var(--success); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">íƒ€ì‚¬</span>
            íƒ€ì‚¬ ê³µê¸‰ì‚¬ (${externalSuppliers.length}ê°œ)
          </h3>
          ${externalSuppliers.length === 0 ? 
            '<div style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">íƒ€ì‚¬ ê³µê¸‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : 
            `<table class="data-table" style="font-size: 13px;">
              <thead><tr><th>ê³µê¸‰ì‚¬ëª…</th><th>ë‹´ë‹¹ì</th><th>ê³„ì•½ìƒíƒœ</th></tr></thead>
              <tbody>${externalSuppliers.map(s => `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td>${s.managerName || '-'}</td>
                  <td><span class="status-badge ${s.contractStatus === 'completed' ? 'status-confirmed' : 'status-negotiating'}">${s.contractStatus === 'completed' ? 'ê³„ì•½ì™„ë£Œ' : 'í˜‘ì˜ì¤‘'}</span></td>
                </tr>
              `).join('')}</tbody>
            </table>`
          }
        </div>
      </div>
      
      <div class="modal-footer" style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// ê¸°ì¡´ settlementBrands ê´€ë ¨ í•¨ìˆ˜ ìœ ì§€ (í˜¸í™˜ì„±)
async function addBrand(e) {
  e.preventDefault();
  const data = { name: document.getElementById('new-brand-name').value, type: document.getElementById('new-brand-type').value || 'íƒ€ì‚¬', defaultMarginRate: Number(document.getElementById('new-brand-rate').value) || 20, createdAt: new Date().toISOString() };
  try { await db.collection('settlementBrands').add(data); showToast('ë¸Œëœë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤'); openBrandManageModal(); } catch(err) { showToast('ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

async function deleteBrand(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try { await db.collection('settlementBrands').doc(id).delete(); showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); openBrandManageModal(); } catch(err) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
}

// ë¸Œëœë“œ ì„ íƒ ë³€ê²½ í•¸ë“¤ëŸ¬
function handleBrandChange(select) {
  const customInput = document.getElementById('ss-brandNameCustom');
  if (select.value === '_other') {
    customInput.style.display = 'block';
    customInput.focus();
  } else {
    customInput.style.display = 'none';
    customInput.value = '';
  }
}

// ì…€ëŸ¬ëª… ì„ íƒ ë³€ê²½ í•¸ë“¤ëŸ¬
function handleSellerNameChange(select) {
  const customInput = document.getElementById('ss-sellerNameCustom');
  if (select.value === '_other') {
    customInput.style.display = 'block';
    customInput.focus();
  } else {
    customInput.style.display = 'none';
    customInput.value = '';
  }
}

// íŒë§¤ì•¡ ê¸°ì¤€ ì…€ëŸ¬ í‹°ì–´ ë¦¬ìŠ¤íŠ¸ í† ê¸€
function toggleSellerTierList(tier) {
  const el = document.getElementById(`seller-tier-${tier}`);
  if (el) {
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }
}

// ê³µê¸‰ì‚¬ í•„ë“œ ì¸ë¼ì¸ ì—…ë°ì´íŠ¸
async function updateSupplierField(supplierId, field, value) {
  try {
    const supplierRef = db.collection('suppliers').doc(supplierId);
    await supplierRef.update({ [field]: value });
    
    // state ì—…ë°ì´íŠ¸
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (supplier) {
      supplier[field] = value;
    }
    
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    renderSuppliers();
  } catch (error) {
    console.error('ê³µê¸‰ì‚¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì…€ëŸ¬ í•„ë“œ ì¸ë¼ì¸ ì—…ë°ì´íŠ¸
async function updateSellerField(sellerId, field, value) {
  try {
    const sellerRef = db.collection('sellers').doc(sellerId);
    await sellerRef.update({ [field]: value });
    
    // state ì—…ë°ì´íŠ¸
    const seller = state.sellers.find(s => s.id === sellerId);
    if (seller) {
      seller[field] = value;
    }
    
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    renderSellers();
  } catch (error) {
    console.error('ì…€ëŸ¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³µê¸‰ì‚¬ ì„œë¥˜ íŒŒì¼ ì—…ë¡œë“œ (Base64ë¡œ ì €ì¥)
async function uploadSupplierDocument(supplierId, docType, file) {
  if (!file) {
    showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  console.log('ì—…ë¡œë“œ ì‹œì‘:', { supplierId, docType, fileName: file.name, fileSize: file.size, fileType: file.type });
  
  // íŒŒì¼ í¬ê¸° ì œí•œ (10MB ì›ë³¸ ê¸°ì¤€)
  if (file.size > 10 * 1024 * 1024) {
    showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    return;
  }
  
  // í—ˆìš©ëœ íŒŒì¼ í˜•ì‹ í™•ì¸
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
  if (!allowedTypes.includes(file.type)) {
    showToast('JPG, PNG, PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    return;
  }
  
  showToast('íŒŒì¼ ì²˜ë¦¬ ì¤‘...');
  
  try {
    let base64Data;
    const fileName = file.name;
    const fileType = file.type;
    
    // ì´ë¯¸ì§€ì¸ ê²½ìš° ì••ì¶•
    if (file.type.startsWith('image/') && file.type !== 'image/gif') {
      base64Data = await compressImage(file, 800, 0.7); // ìµœëŒ€ 800px, í’ˆì§ˆ 70%
      console.log('ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ:', Math.round(base64Data.length / 1024) + 'KB');
    } else {
      // PDFë‚˜ GIFëŠ” ê·¸ëŒ€ë¡œ
      base64Data = await readFileAsBase64(file);
    }
    
    // Firebase ë¬¸ì„œ í¬ê¸° ì œí•œ ì²´í¬ (ì•½ 700KBê¹Œì§€ ì•ˆì „)
    if (base64Data.length > 700000) {
      showToast('íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ë” ì‘ì€ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    let fieldName, fileNameField, fileTypeField, checkField;
    if (docType === 'businessLicense') {
      fieldName = 'businessLicenseData';
      fileNameField = 'businessLicenseFileName';
      fileTypeField = 'businessLicenseFileType';
      checkField = 'hasBusinessLicense';
    } else if (docType === 'bankAccount') {
      fieldName = 'bankAccountData';
      fileNameField = 'bankAccountFileName';
      fileTypeField = 'bankAccountFileType';
      checkField = 'hasBankAccount';
    } else if (docType === 'contract') {
      fieldName = 'contractData';
      fileNameField = 'contractFileName';
      fileTypeField = 'contractFileType';
      checkField = 'hasContract';
    }
    
    const updatePayload = {
      [fieldName]: base64Data,
      [fileNameField]: fileName,
      [fileTypeField]: fileType,
      [checkField]: true,
      updatedAt: new Date().toISOString()
    };
    
    await db.collection('suppliers').doc(supplierId).update(updatePayload);
    
    console.log('Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    
    // state ì—…ë°ì´íŠ¸
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (supplier) {
      supplier[fieldName] = base64Data;
      supplier[fileNameField] = fileName;
      supplier[fileTypeField] = fileType;
      supplier[checkField] = true;
    }
    
    showToast('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    renderSuppliers();
  } catch (error) {
    console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
  }
}

// ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
function compressImage(file, maxSize, quality) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // í¬ê¸° ì¡°ì •
        if (width > maxSize || height > maxSize) {
          if (width > height) {
            height = Math.round(height * maxSize / width);
            width = maxSize;
          } else {
            width = Math.round(width * maxSize / height);
            height = maxSize;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // JPEGë¡œ ì••ì¶•
        const compressedData = canvas.toDataURL('image/jpeg', quality);
        resolve(compressedData);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// íŒŒì¼ì„ Base64ë¡œ ì½ê¸°
function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ì„œë¥˜ ë³´ê¸° (ìƒˆ ì°½ì—ì„œ ì—´ê¸°)
function viewDocument(supplierId, docType) {
  const supplier = state.suppliers.find(s => s.id === supplierId);
  if (!supplier) return;
  
  let fieldName, fileNameField, fileTypeField, docTitle;
  if (docType === 'businessLicense') {
    fieldName = 'businessLicenseData';
    fileNameField = 'businessLicenseFileName';
    fileTypeField = 'businessLicenseFileType';
    docTitle = 'ì‚¬ì—…ìë“±ë¡ì¦';
  } else if (docType === 'bankAccount') {
    fieldName = 'bankAccountData';
    fileNameField = 'bankAccountFileName';
    fileTypeField = 'bankAccountFileType';
    docTitle = 'í†µì¥ì‚¬ë³¸';
  } else if (docType === 'contract') {
    fieldName = 'contractData';
    fileNameField = 'contractFileName';
    fileTypeField = 'contractFileType';
    docTitle = 'ê³„ì•½ì„œ';
  }
  
  const data = supplier[fieldName];
  const fileName = supplier[fileNameField] || 'ë¬¸ì„œ';
  const fileType = supplier[fileTypeField] || 'image/png';
  
  if (!data) {
    showToast('ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ìƒˆ ì°½ì—ì„œ ë¬¸ì„œ ë³´ê¸°
  const newWindow = window.open('', '_blank');
  newWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>${supplier.name} - ${docTitle}</title>
      <style>
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          margin: 0; 
          padding: 20px; 
          background: #f5f5f5;
        }
        .header {
          background: white;
          padding: 16px 24px;
          border-radius: 12px;
          margin-bottom: 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .header h1 {
          margin: 0;
          font-size: 18px;
          color: #333;
        }
        .header .info {
          font-size: 14px;
          color: #666;
        }
        .btn {
          padding: 8px 16px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
        }
        .btn-primary {
          background: #f97316;
          color: white;
        }
        .btn-danger {
          background: #dc2626;
          color: white;
          margin-left: 8px;
        }
        .content {
          background: white;
          padding: 24px;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          text-align: center;
        }
        img {
          max-width: 100%;
          height: auto;
          border-radius: 8px;
        }
        iframe {
          width: 100%;
          height: 80vh;
          border: none;
          border-radius: 8px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <div>
          <h1>ğŸ“„ ${supplier.name} - ${docTitle}</h1>
          <div class="info">íŒŒì¼ëª…: ${fileName}</div>
        </div>
        <div>
          <a href="${data}" download="${fileName}" class="btn btn-primary">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</a>
          <button class="btn btn-danger" onclick="if(confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { window.opener.deleteSupplierDocument('${supplierId}', '${docType}'); window.close(); }">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>
      </div>
      <div class="content">
        ${fileType.includes('pdf') ? 
          `<iframe src="${data}"></iframe>` :
          `<img src="${data}" alt="${docTitle}">`
        }
      </div>
    </body>
    </html>
  `);
  newWindow.document.close();
}

// ì„œë¥˜ ì‚­ì œ
async function deleteSupplierDocument(supplierId, docType) {
  try {
    const fieldName = docType === 'businessLicense' ? 'businessLicenseData' : 'bankAccountData';
    const fileNameField = docType === 'businessLicense' ? 'businessLicenseFileName' : 'bankAccountFileName';
    const fileTypeField = docType === 'businessLicense' ? 'businessLicenseFileType' : 'bankAccountFileType';
    
    const supplierRef = db.collection('suppliers').doc(supplierId);
    await supplierRef.update({
      [fieldName]: firebase.firestore.FieldValue.delete(),
      [fileNameField]: firebase.firestore.FieldValue.delete(),
      [fileTypeField]: firebase.firestore.FieldValue.delete()
    });
    
    // state ì—…ë°ì´íŠ¸
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (supplier) {
      delete supplier[fieldName];
      delete supplier[fileNameField];
      delete supplier[fileTypeField];
    }
    
    renderSuppliers();
  } catch (error) {
    console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
    alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ========== ê³µê¸‰ì‚¬ ì •ì‚°ì„œ(ì¸ë³´ì´ìŠ¤) ê¸°ëŠ¥ ==========

// ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ëª©ë¡ ëª¨ë‹¬
function openSupplierInvoiceList() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  const settlements = state.supplierSettlements || [];
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ§¾ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ë°œí–‰</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div style="padding: 16px; background: var(--gray-50); border-bottom: 1px solid #bbf7d0;">
        <p style="margin: 0; font-size: 13px; color: #166534;">
          ğŸ’¡ ê³µê¸‰ì‚¬ì—ê²Œ ë°œì†¡í•  ì •ì‚°ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê° ì •ì‚° ê±´ë³„ë¡œ ì •ì‚°ì„œë¥¼ ì¶œë ¥í•˜ê±°ë‚˜ HTML íŒŒì¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
      </div>
      
      <div style="flex: 1; overflow-y: auto; padding: 16px;">
        ${settlements.length === 0 ? '<div class="empty-state"><div class="icon">ğŸ§¾</div><div class="text">ë°œí–‰í•  ê³µê¸‰ì‚¬ ì •ì‚°ì´ ì—†ìŠµë‹ˆë‹¤<br><small>ë¨¼ì € ê³µê¸‰ì‚¬ ì •ì‚°ì„ ë“±ë¡í•´ì£¼ì„¸ìš”</small></div></div>' : `
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr style="background: var(--gray-100);">
                <th>ë¸Œëœë“œ(ê³µê¸‰ì‚¬)</th>
                <th>ì…€ëŸ¬</th>
                <th>ê³µêµ¬ê¸°ê°„</th>
                <th style="text-align: center;">ìˆ˜ëŸ‰</th>
                <th style="text-align: right;">í•©ê³„ê¸ˆì•¡(V+)</th>
                <th style="text-align: center;">ì •ì‚°ì¼</th>
                <th style="width: 100px;"></th>
              </tr>
            </thead>
            <tbody>
              ${settlements.map(s => `
                <tr>
                  <td><strong>${s.brandName || '-'}</strong></td>
                  <td>${s.sellerName || '-'}</td>
                  <td style="font-size: 12px;">${s.dealPeriod || '-'}</td>
                  <td style="text-align: center;">${s.totalQuantity || 0}</td>
                  <td style="text-align: right; font-weight: 600; color: var(--gray-600);">${Number(s.totalAmount || 0).toLocaleString()}ì›</td>
                  <td style="text-align: center;">${s.settlementDate || '-'}</td>
                  <td class="actions">
                    <button class="btn btn-primary btn-sm" onclick="generateSupplierInvoice('${s.id}')" style="background: #059669;">ì •ì‚°ì„œ ìƒì„±</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `}
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// ê°œë³„ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ìƒì„±
function generateSupplierInvoice(settlementId) {
  const settlement = state.supplierSettlements.find(s => s.id === settlementId);
  if (!settlement) {
    showToast('ì •ì‚° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // ê³µê¸‰ì‚¬ ì •ë³´ ì°¾ê¸°
  const supplier = state.suppliers.find(sup => sup.name === settlement.brandName) || {};
  
  // ì…€ëŸ¬ ì •ë³´ ì°¾ê¸°
  const seller = state.sellers.find(sel => sel.id === settlement.sellerId) || 
                 state.sellers.find(sel => sel.nickname === settlement.sellerName) || {};
  const sellerNickname = seller.nickname || settlement.sellerName || '-';
  const sellerLink = seller.sns || seller.instagramLink || '';
  
  // ìƒí’ˆ ì •ë³´ (items í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°)
  const products = settlement.items || settlement.products || [];
  
  // ì˜¤ëŠ˜ ë‚ ì§œ
  const today = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
  
  // í•©ê³„ ê³„ì‚°
  let totalSupplyAmount = 0;
  let totalVatAmount = 0;
  let totalShippingFee = 0;
  let totalAmount = 0;
  let totalQuantity = 0;
  
  products.forEach(p => {
    const qty = Number(p.quantity) || 0;
    const supplyPrice = Number(p.supplyPrice) || 0;
    const shippingFee = Number(p.shippingFee) || 0;
    // ê³µê¸‰ê°€ì•¡ ê³„ì‚° (VAT ì œì™¸)
    const supplyAmount = Math.round(supplyPrice * qty / 1.1);
    const vatAmount = Math.round(supplyAmount * 0.1);
    const shipping = shippingFee * qty;
    
    totalQuantity += qty;
    totalSupplyAmount += supplyAmount;
    totalVatAmount += vatAmount;
    totalShippingFee += shipping;
    totalAmount += supplyAmount + vatAmount + shipping;
  });
  
  // ëª¨ë‹¬ì— ì •ì‚°ì„œ í‘œì‹œ
  const m = document.getElementById('modal');
  m.className = 'modal show';
  
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ§¾ ê³µê¸‰ì‚¬ ì •ì‚°ì„œ - ${settlement.brandName}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div id="supplier-invoice-content" style="flex: 1; overflow-y: auto; padding: 24px; background: white;">
        <!-- í—¤ë” -->
        <div style="text-align: center; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid #059669;">
          <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #1f2937;">ê³µê¸‰ ëŒ€ê¸ˆ ì •ì‚°ì„œ</h1>
          <p style="color: #6b7280; font-size: 14px;">ëª¨ì—¬ë¼ë”œ | ${today}</p>
        </div>
        
        <!-- ê³µê¸‰ì‚¬ ì •ë³´ & ì…€ëŸ¬ ì •ë³´ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
          <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; border: 1px solid #bbf7d0;">
            <h3 style="font-size: 14px; font-weight: 700; color: #166534; margin-bottom: 16px;">ğŸ“¦ ê³µê¸‰ì‚¬ ì •ë³´</h3>
            <div style="font-size: 13px; line-height: 1.8;">
              <div><strong>ê³µê¸‰ì‚¬ëª…:</strong> ${settlement.brandName || '-'}</div>
              <div><strong>ë‹´ë‹¹ì:</strong> ${supplier.contactPerson || '-'}</div>
              <div><strong>ì—°ë½ì²˜:</strong> ${supplier.phone || '-'}</div>
              <div><strong>ì…ê¸ˆê³„ì¢Œ:</strong> ${supplier.bankInfo || '-'}</div>
            </div>
          </div>
          <div style="background: var(--gray-100); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-300);">
            <h3 style="font-size: 14px; font-weight: 700; color: var(--gray-600); margin-bottom: 16px;">ğŸ‘¤ ì…€ëŸ¬ ì •ë³´</h3>
            <div style="font-size: 13px; line-height: 1.8;">
              <div><strong>ì…€ëŸ¬:</strong> ${sellerNickname}</div>
              ${sellerLink ? `<div><strong>ê³„ì •:</strong> <a href="${sellerLink.startsWith('http') ? sellerLink : 'https://instagram.com/' + sellerLink}" target="_blank" style="color: #2563eb; text-decoration: underline;">${sellerLink.includes('instagram') ? '@' + sellerLink.split('/').pop() : sellerLink}</a></div>` : ''}
              <div><strong>ê³µêµ¬ ê¸°ê°„:</strong> ${settlement.dealPeriod || '-'}</div>
              <div><strong>ì •ì‚° ì˜ˆì •ì¼:</strong> ${settlement.settlementDate || '-'}</div>
              <div><strong>ì´ ìˆ˜ëŸ‰:</strong> ${totalQuantity > 0 ? totalQuantity.toLocaleString() : (settlement.totalQuantity || 0).toLocaleString()}ê°œ</div>
            </div>
          </div>
        </div>
        
        <!-- ìƒí’ˆë³„ ì •ì‚° ë‚´ì—­ -->
        <div style="margin-bottom: 32px;">
          <h3 style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #059669;">
            ğŸ“¦ ìƒí’ˆë³„ ì •ì‚° ë‚´ì—­
          </h3>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: left;">ìƒí’ˆëª…</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">ê³µê¸‰ë‹¨ê°€(V+)</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: center;">íŒë§¤ìˆ˜ëŸ‰</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">ê³µê¸‰ê°€ì•¡</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">ë¶€ê°€ì„¸(10%)</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">ë°°ì†¡ë£Œ</th>
                <th style="padding: 12px; border: 1px solid #bbf7d0; text-align: right; font-weight: 700;">í•©ê³„ê¸ˆì•¡(V+)</th>
              </tr>
            </thead>
            <tbody>
              ${products.length === 0 ? `
                <tr>
                  <td colspan="7" style="padding: 20px; text-align: center; color: #9ca3af; border: 1px solid #e5e7eb;">
                    ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (ì¼ê´„ ì…ë ¥ëœ ì •ì‚°)
                  </td>
                </tr>
                <tr style="background: var(--gray-50); font-weight: 700;">
                  <td colspan="3" style="padding: 12px; border: 1px solid #bbf7d0;">í•©ê³„</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${Number(settlement.totalSupplyAmount || 0).toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${Number(settlement.totalVatAmount || 0).toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${Number(settlement.totalShippingFee || 0).toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right; color: #059669;">${Number(settlement.totalAmount || 0).toLocaleString()}ì›</td>
                </tr>
              ` : `
                ${products.map(p => {
                  const qty = Number(p.quantity) || 0;
                  const supplyPrice = Number(p.supplyPrice) || 0;
                  const shippingFee = Number(p.shippingFee) || 0;
                  const supplyAmount = Math.round(supplyPrice * qty / 1.1);
                  const vatAmount = Math.round(supplyAmount * 0.1);
                  const shipping = shippingFee * qty;
                  const rowTotal = supplyAmount + vatAmount + shipping;
                  return '<tr>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb;">' + (p.productName || '-') + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">' + supplyPrice.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">' + qty.toLocaleString() + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">' + supplyAmount.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">' + vatAmount.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">' + shipping.toLocaleString() + 'ì›</td>' +
                    '<td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600;">' + rowTotal.toLocaleString() + 'ì›</td>' +
                    '</tr>';
                }).join('')}
                <tr style="background: var(--gray-50); font-weight: 700;">
                  <td style="padding: 12px; border: 1px solid #bbf7d0;">í•©ê³„</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0;"></td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: center;">${totalQuantity.toLocaleString()}</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${totalSupplyAmount.toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${totalVatAmount.toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">${totalShippingFee.toLocaleString()}ì›</td>
                  <td style="padding: 12px; border: 1px solid #bbf7d0; text-align: right; color: #059669;">${totalAmount.toLocaleString()}ì›</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
        
        <!-- ìµœì¢… ì •ì‚° ê¸ˆì•¡ -->
        <div style="background: linear-gradient(135deg, #059669 0%, #047857 100%); border-radius: 16px; padding: 24px; color: white; text-align: center;">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ’° ìµœì¢… ì •ì‚° ê¸ˆì•¡ (VAT í¬í•¨)</div>
          <div style="font-size: 36px; font-weight: 700;">${(products.length > 0 ? totalAmount : Number(settlement.totalAmount || 0)).toLocaleString()}ì›</div>
        </div>
        
        <!-- ë©”ëª¨ -->
        ${settlement.memo ? `
          <div style="margin-top: 24px; padding: 16px; background: var(--gray-100); border-radius: 8px; border: 1px solid var(--gray-300);">
            <strong style="color: var(--gray-600);">ğŸ“ ë©”ëª¨:</strong>
            <p style="margin: 8px 0 0 0; color: var(--gray-500);">${settlement.memo}</p>
          </div>
        ` : ''}
        
        <!-- í‘¸í„° -->
        <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 12px;">
          <p>ë³¸ ì •ì‚°ì„œëŠ” ëª¨ì—¬ë¼ë”œì—ì„œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          <p style="margin-top: 4px;">ë¬¸ì˜: moyeoradeal@gmail.com</p>
        </div>
      </div>
      
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: center;">
        <button class="btn btn-secondary" onclick="openSupplierInvoiceList()">â† ëª©ë¡ìœ¼ë¡œ</button>
        <button class="btn btn-primary" onclick="printSupplierInvoice()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
        <button class="btn btn-primary" style="background: #059669;" onclick="downloadSupplierInvoice('${settlement.brandName}', '${settlement.dealPeriod || ''}')">ğŸ’¾ HTML ì €ì¥</button>
      </div>
    </div>
  `;
}

// ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ì¸ì‡„
function printSupplierInvoice() {
  const content = document.getElementById('supplier-invoice-content');
  if (!content) return;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <title>ê³µê¸‰ì‚¬ ì •ì‚°ì„œ</title>
      <style>
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif; 
          padding: 20px; 
          color: #1f2937;
        }
        @media print { 
          body { padding: 0; }
          @page { margin: 1cm; }
        }
      </style>
    </head>
    <body>${content.innerHTML}</body>
    </html>
  `);
  printWindow.document.close();
  setTimeout(() => printWindow.print(), 300);
}

// ê³µê¸‰ì‚¬ ì •ì‚°ì„œ HTML ë‹¤ìš´ë¡œë“œ
function downloadSupplierInvoice(brandName, period) {
  const content = document.getElementById('supplier-invoice-content');
  if (!content) return;
  
  const today = new Date().toISOString().split('T')[0];
  const fileName = 'ê³µê¸‰ì‚¬ì •ì‚°ì„œ_' + brandName + '_' + (period || today).replace(/[\/\s~]/g, '-') + '.html';
  
  const htmlContent = '<!DOCTYPE html>' +
    '<html lang="ko">' +
    '<head>' +
    '<meta charset="UTF-8">' +
    '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
    '<title>ê³µê¸‰ì‚¬ ì •ì‚°ì„œ - ' + brandName + '</title>' +
    '<style>' +
    'body { font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; background: #f9fafb; color: #1f2937; }' +
    '.container { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }' +
    'table { width: 100%; border-collapse: collapse; font-size: 13px; }' +
    'th, td { padding: 12px; border: 1px solid #e5e7eb; }' +
    '@media print { body { padding: 0; background: white; } .container { box-shadow: none; } }' +
    '</style>' +
    '</head>' +
    '<body>' +
    '<div class="container">' +
    content.innerHTML +
    '</div>' +
    '</body>' +
    '</html>';
  
  const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('ì •ì‚°ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ==================== í†µí•© ì •ì‚° ëª¨ë‹¬ ====================
function openUnifiedSettlementModal(item = null) {
  const modalEl = document.getElementById('modal');
  const isEdit = item !== null;
  const s = item || {
    productType: 'inhouse',
    sellerName: '',
    brandName: '',
    dealPeriod: '',
    totalQuantity: '',
    salesAmount: '',
    marginRate: '',
    marginAmount: '',
    withholdingTax: '',
    actualPayment: '',
    eventCost: '',
    settlementDate: new Date().toISOString().split('T')[0],
    // íƒ€ì‚¬ ìƒí’ˆ ê³µê¸‰ì‚¬ ì •ë³´
    supplyAmount: '',
    vatAmount: '',
    supplierTotalAmount: '',
    products: []
  };
  
  const sellers = state.sellers || [];
  const brands = state.brands || [];
  const supplierProducts = state.supplierProducts || [];
  
  // ë¸Œëœë“œë³„ ìƒí’ˆ ê·¸ë£¹í™”
  const productsByBrand = {};
  supplierProducts.forEach(p => {
    if (!productsByBrand[p.brandName]) productsByBrand[p.brandName] = [];
    productsByBrand[p.brandName].push(p);
  });
  
  modalEl.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>${isEdit ? 'ğŸ“ ì •ì‚° ìˆ˜ì •' : 'â• ì •ì‚° ì¶”ê°€'}</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="submitUnifiedSettlement(event, '${s.id || ''}')" id="unified-settlement-form">
        <div class="modal-body">
          <!-- ìƒí’ˆ ìœ í˜• ì„ íƒ -->
          <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <label style="flex: 1; padding: 16px; border: 2px solid ${s.productType === 'inhouse' ? 'var(--info)' : 'var(--gray-200)'}; border-radius: 12px; cursor: pointer; text-align: center; background: ${s.productType === 'inhouse' ? 'var(--info-light)' : 'transparent'};" onclick="toggleProductType('inhouse')">
              <input type="radio" name="productType" value="inhouse" ${s.productType === 'inhouse' ? 'checked' : ''} style="display: none;">
              <div style="font-size: 24px; margin-bottom: 8px;">ğŸ </div>
              <div style="font-weight: 700; color: var(--info);">1. ìì‚¬ ìƒí’ˆ</div>
              <div style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬ ì •ì‚°ë§Œ</div>
            </label>
            <label style="flex: 1; padding: 16px; border: 2px solid ${s.productType === 'external' ? 'var(--success)' : 'var(--gray-200)'}; border-radius: 12px; cursor: pointer; text-align: center; background: ${s.productType === 'external' ? 'var(--success-light)' : 'transparent'};" onclick="toggleProductType('external')">
              <input type="radio" name="productType" value="external" ${s.productType === 'external' ? 'checked' : ''} style="display: none;">
              <div style="font-size: 24px; margin-bottom: 8px;">ğŸ­</div>
              <div style="font-weight: 700; color: var(--success);">2. íƒ€ì‚¬ ìƒí’ˆ</div>
              <div style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬ + ê³µê¸‰ì‚¬ ì •ì‚°</div>
            </label>
          </div>
          
          <!-- ê¸°ë³¸ ì •ë³´ -->
          <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px; font-size: 14px; color: var(--gray-700);">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ì…€ëŸ¬ëª… *</label>
                <input type="text" class="form-input" id="us-sellerName" value="${s.sellerName}" required list="us-seller-list">
                <datalist id="us-seller-list">${sellers.map(sel => `<option value="${sel.name}">`).join('')}</datalist>
              </div>
              <div class="form-group">
                <label class="form-label">ë¸Œëœë“œ *</label>
                <input type="text" class="form-input" id="us-brandName" value="${s.brandName}" required list="us-brand-list" onchange="onBrandChange(this.value)">
                <datalist id="us-brand-list">${brands.map(b => `<option value="${b.name}">`).join('')}</datalist>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ê³µêµ¬ê¸°ê°„</label>
                <input type="text" class="form-input" id="us-dealPeriod" value="${s.dealPeriod}" placeholder="2025-11-27~2025-11-30">
              </div>
              <div class="form-group">
                <label class="form-label">ì •ì‚°ì¼ *</label>
                <input type="date" class="form-input" id="us-settlementDate" value="${s.settlementDate}" required>
              </div>
            </div>
          </div>
          
          <!-- íƒ€ì‚¬ ìƒí’ˆ: ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ì…ë ¥ -->
          <div id="supplier-products-section" style="display: ${s.productType === 'external' ? 'block' : 'none'}; background: #fefce8; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0; font-size: 14px; color: #ca8a04;">ğŸ­ ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ì…ë ¥</h4>
              <button type="button" class="btn btn-secondary btn-sm" onclick="openSupplierProductModal()">ğŸ“¦ ìƒí’ˆê´€ë¦¬</button>
            </div>
            <div id="product-quantity-inputs">
              ${s.products && s.products.length > 0 ? 
                s.products.map((p, i) => `
                  <div class="form-row" style="align-items: center; margin-bottom: 8px;">
                    <div style="flex: 3;"><input type="text" class="form-input" value="${p.productName}" readonly style="background: #fff;"></div>
                    <div style="flex: 1;"><input type="number" class="form-input product-qty" data-supply="${p.supplyPrice}" data-sale="${p.salePrice}" value="${p.quantity || 0}" placeholder="ìˆ˜ëŸ‰" oninput="calculateSupplierTotals()"></div>
                    <div style="flex: 1; text-align: right; font-size: 12px; color: var(--gray-600);">${Number(p.supplyPrice).toLocaleString()}ì›</div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; padding: 20px; color: var(--gray-500);">ë¸Œëœë“œë¥¼ ì„ íƒí•˜ë©´ ë“±ë¡ëœ ìƒí’ˆì´ í‘œì‹œë©ë‹ˆë‹¤</div>'
              }
            </div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #fde68a;">
              <div class="form-row">
                <div class="form-group"><label class="form-label">ì´ ìˆ˜ëŸ‰</label><input type="number" class="form-input" id="us-totalQuantity" value="${s.totalQuantity}" readonly style="background: #fff;"></div>
                <div class="form-group"><label class="form-label">ì´ íŒë§¤ê¸ˆì•¡</label><input type="number" class="form-input" id="us-salesAmount" value="${s.salesAmount}" readonly style="background: #fff;"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">ê³µê¸‰ê°€ì•¡ (V-)</label><input type="number" class="form-input" id="us-supplyAmount" value="${s.supplyAmount}" readonly style="background: #fff8f0;"></div>
                <div class="form-group"><label class="form-label">ë¶€ê°€ì„¸ (10%)</label><input type="number" class="form-input" id="us-vatAmount" value="${s.vatAmount}" readonly style="background: #fff8f0;"></div>
                <div class="form-group"><label class="form-label">ê³µê¸‰ì‚¬ ì •ì‚°ê¸ˆì•¡ (V+)</label><input type="number" class="form-input" id="us-supplierTotalAmount" value="${s.supplierTotalAmount}" readonly style="background: #fff8f0; font-weight: 700;"></div>
              </div>
            </div>
          </div>
          
          <!-- ìì‚¬ ìƒí’ˆ: ì§ì ‘ ì…ë ¥ -->
          <div id="inhouse-inputs-section" style="display: ${s.productType === 'inhouse' ? 'block' : 'none'}; background: var(--info-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px; font-size: 14px; color: var(--info);">ğŸ’° íŒë§¤ ì •ë³´</h4>
            <div class="form-row">
              <div class="form-group"><label class="form-label">ì´ ìˆ˜ëŸ‰</label><input type="number" class="form-input" id="us-totalQuantity-inhouse" value="${s.totalQuantity}" oninput="calculateInhouseTotals()"></div>
              <div class="form-group"><label class="form-label">ì´ íŒë§¤ê¸ˆì•¡ *</label><input type="number" class="form-input" id="us-salesAmount-inhouse" value="${s.salesAmount}" required oninput="calculateInhouseTotals()"></div>
            </div>
          </div>
          
          <!-- ì…€ëŸ¬ ì •ì‚° ì •ë³´ -->
          <div style="background: #dcfce7; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px; font-size: 14px; color: #16a34a;">ğŸ‘¤ ì…€ëŸ¬ ì •ì‚° ì •ë³´</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ë§ˆì§„ìœ¨ (%)</label>
                <input type="number" class="form-input" id="us-marginRate" value="${s.marginRate || ''}" step="0.1" oninput="calculateMarginFromRate()">
              </div>
              <div class="form-group">
                <label class="form-label">ë§ˆì§„ê¸ˆì•¡</label>
                <input type="number" class="form-input" id="us-marginAmount" value="${s.marginAmount}" oninput="calculateMarginFromAmount()">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">ì›ì²œì„¸ (3.3%)</label><input type="number" class="form-input" id="us-withholdingTax" value="${s.withholdingTax}" readonly style="background: #f0fdf4;"></div>
              <div class="form-group"><label class="form-label">ì‹¤ì§€ê¸‰ì•¡</label><input type="number" class="form-input" id="us-actualPayment" value="${s.actualPayment}" readonly style="background: #f0fdf4; font-weight: 700;"></div>
            </div>
            <div class="form-group"><label class="form-label">ì´ë²¤íŠ¸ ë¹„ìš©</label><input type="number" class="form-input" id="us-eventCost" value="${s.eventCost || 0}" placeholder="0"></div>
          </div>
        </div>
        <div class="modal-footer">
          ${isEdit ? `<button type="button" class="btn btn-secondary" style="color: var(--danger);" onclick="deleteSettlement('${s.id}')">ì‚­ì œ</button>` : ''}
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ì €ì¥í•˜ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  
  modalEl.className = 'modal show';
  
  // ë¸Œëœë“œ ë³€ê²½ì‹œ ìƒí’ˆ ë¡œë“œ
  window.onBrandChange = function(brandName) {
    const productType = document.querySelector('input[name="productType"]:checked')?.value;
    if (productType !== 'external') return;
    
    const products = productsByBrand[brandName] || [];
    const container = document.getElementById('product-quantity-inputs');
    
    if (products.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆê´€ë¦¬ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>';
      return;
    }
    
    container.innerHTML = products.map(p => `
      <div class="form-row" style="align-items: center; margin-bottom: 8px;">
        <div style="flex: 3;"><input type="text" class="form-input" value="${p.productName}" data-product-id="${p.id}" readonly style="background: #fff;"></div>
        <div style="flex: 1;"><input type="number" class="form-input product-qty" data-supply="${p.supplyPrice}" data-sale="${p.salePrice}" value="0" placeholder="ìˆ˜ëŸ‰" min="0" oninput="calculateSupplierTotals()"></div>
        <div style="flex: 1; text-align: right; font-size: 12px; color: var(--gray-600);">${Number(p.supplyPrice).toLocaleString()}ì›</div>
      </div>
    `).join('');
  };
  
  // ìƒí’ˆìœ í˜• í† ê¸€
  window.toggleProductType = function(type) {
    document.querySelector(`input[name="productType"][value="${type}"]`).checked = true;
    
    // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('label[onclick^="toggleProductType"]').forEach(label => {
      const isSelected = label.querySelector('input').checked;
      const isInhouse = label.querySelector('input').value === 'inhouse';
      label.style.borderColor = isSelected ? (isInhouse ? 'var(--info)' : 'var(--success)') : 'var(--gray-200)';
      label.style.background = isSelected ? (isInhouse ? 'var(--info-light)' : 'var(--success-light)') : 'transparent';
    });
    
    // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
    document.getElementById('supplier-products-section').style.display = type === 'external' ? 'block' : 'none';
    document.getElementById('inhouse-inputs-section').style.display = type === 'inhouse' ? 'block' : 'none';
  };
  
  // ê³µê¸‰ì‚¬ ì´ì•¡ ê³„ì‚°
  window.calculateSupplierTotals = function() {
    const inputs = document.querySelectorAll('.product-qty');
    let totalQty = 0, totalSales = 0, totalSupply = 0;
    
    inputs.forEach(input => {
      const qty = Number(input.value) || 0;
      const supplyPrice = Number(input.dataset.supply) || 0;
      const salePrice = Number(input.dataset.sale) || 0;
      totalQty += qty;
      totalSales += salePrice * qty;
      totalSupply += supplyPrice * qty;
    });
    
    const vat = Math.round(totalSupply * 0.1);
    const supplierTotal = totalSupply + vat;
    
    document.getElementById('us-totalQuantity').value = totalQty;
    document.getElementById('us-salesAmount').value = totalSales;
    document.getElementById('us-supplyAmount').value = totalSupply;
    document.getElementById('us-vatAmount').value = vat;
    document.getElementById('us-supplierTotalAmount').value = supplierTotal;
    
    // ë§ˆì§„ ìë™ ê³„ì‚° (íŒë§¤ê¸ˆì•¡ - ê³µê¸‰ì‚¬ì •ì‚°ê¸ˆì•¡)
    const marginAmount = totalSales - supplierTotal;
    if (marginAmount > 0) {
      document.getElementById('us-marginAmount').value = marginAmount;
      calculateMarginFromAmount();
    }
  };
  
  // ìì‚¬ ìƒí’ˆ ê³„ì‚°
  window.calculateInhouseTotals = function() {
    // í•„ìš”ì‹œ êµ¬í˜„
  };
  
  // ë§ˆì§„ìœ¨ë¡œ ë§ˆì§„ê¸ˆì•¡ ê³„ì‚°
  window.calculateMarginFromRate = function() {
    const productType = document.querySelector('input[name="productType"]:checked')?.value;
    const salesAmount = productType === 'inhouse' ? 
      Number(document.getElementById('us-salesAmount-inhouse').value) : 
      Number(document.getElementById('us-salesAmount').value);
    const marginRate = Number(document.getElementById('us-marginRate').value) || 0;
    
    const marginAmount = Math.round(salesAmount * (marginRate / 100));
    document.getElementById('us-marginAmount').value = marginAmount;
    
    const withholdingTax = Math.round(marginAmount * 0.033);
    const actualPayment = marginAmount - withholdingTax;
    
    document.getElementById('us-withholdingTax').value = withholdingTax;
    document.getElementById('us-actualPayment').value = actualPayment;
  };
  
  // ë§ˆì§„ê¸ˆì•¡ìœ¼ë¡œ ë§ˆì§„ìœ¨ ê³„ì‚°
  window.calculateMarginFromAmount = function() {
    const productType = document.querySelector('input[name="productType"]:checked')?.value;
    const salesAmount = productType === 'inhouse' ? 
      Number(document.getElementById('us-salesAmount-inhouse').value) : 
      Number(document.getElementById('us-salesAmount').value);
    const marginAmount = Number(document.getElementById('us-marginAmount').value) || 0;
    
    if (salesAmount > 0) {
      const marginRate = (marginAmount / salesAmount * 100).toFixed(1);
      document.getElementById('us-marginRate').value = marginRate;
    }
    
    const withholdingTax = Math.round(marginAmount * 0.033);
    const actualPayment = marginAmount - withholdingTax;
    
    document.getElementById('us-withholdingTax').value = withholdingTax;
    document.getElementById('us-actualPayment').value = actualPayment;
  };
}

// í†µí•© ì •ì‚° ì €ì¥
async function submitUnifiedSettlement(e, id) {
  e.preventDefault();
  
  const productType = document.querySelector('input[name="productType"]:checked')?.value;
  const isExternal = productType === 'external';
  
  const data = {
    productType: productType,
    sellerName: document.getElementById('us-sellerName').value.trim(),
    brandName: document.getElementById('us-brandName').value.trim(),
    dealPeriod: document.getElementById('us-dealPeriod').value.trim(),
    settlementDate: document.getElementById('us-settlementDate').value,
    marginRate: Number(document.getElementById('us-marginRate').value) || 0,
    marginAmount: Number(document.getElementById('us-marginAmount').value) || 0,
    withholdingTax: Number(document.getElementById('us-withholdingTax').value) || 0,
    actualPayment: Number(document.getElementById('us-actualPayment').value) || 0,
    eventCost: Number(document.getElementById('us-eventCost').value) || 0,
    isCompleted: false,
    updatedAt: new Date().toISOString()
  };
  
  if (isExternal) {
    data.totalQuantity = Number(document.getElementById('us-totalQuantity').value) || 0;
    data.salesAmount = Number(document.getElementById('us-salesAmount').value) || 0;
    data.supplyAmount = Number(document.getElementById('us-supplyAmount').value) || 0;
    data.vatAmount = Number(document.getElementById('us-vatAmount').value) || 0;
    data.supplierTotalAmount = Number(document.getElementById('us-supplierTotalAmount').value) || 0;
    
    // ìƒí’ˆ ì •ë³´ ì €ì¥
    const products = [];
    document.querySelectorAll('.product-qty').forEach(input => {
      const qty = Number(input.value) || 0;
      if (qty > 0) {
        const row = input.closest('.form-row');
        const productName = row.querySelector('input[readonly]').value;
        products.push({
          productName,
          quantity: qty,
          supplyPrice: Number(input.dataset.supply),
          salePrice: Number(input.dataset.sale)
        });
      }
    });
    data.products = products;
  } else {
    data.totalQuantity = Number(document.getElementById('us-totalQuantity-inhouse').value) || 0;
    data.salesAmount = Number(document.getElementById('us-salesAmount-inhouse').value) || 0;
  }
  
  try {
    if (id) {
      await db.collection('sellerSettlements').doc(id).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('sellerSettlements').add(data);
    }
    
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    renderSalesManagement();
  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ì •ì‚° ì‚­ì œ
async function deleteSettlement(id) {
  if (!confirm('ì´ ì •ì‚°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('sellerSettlements').doc(id).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal();
    renderSalesManagement();
  } catch (err) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}

// ==================== ê°œë³„ ì •ì‚°ì„œ ìƒì„± ====================
// ì…€ëŸ¬ ì •ì‚°ì„œ ìƒì„±
function generateSellerStatement(settlementId) {
  const settlement = state.sellerSettlements.find(s => s.id === settlementId);
  if (!settlement) return showToast('ì •ì‚° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  
  const today = new Date().toLocaleDateString('ko-KR');
  
  // ìƒí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê²½ì˜íŒ€ ì •ì‚°ì„œì™€ ë™ì¼í•œ ë¡œì§)
  let items = settlement.salesItems || settlement.items || [];
  
  // salesItemsê°€ ì—†ìœ¼ë©´ ê³µêµ¬ ê´€ë¦¬(deals)ì—ì„œ ìƒí’ˆ ì •ë³´ ì—°ë™
  if (items.length === 0 && settlement.dealPeriod) {
    const matchingDeal = state.deals.find(d => {
      const dealPeriod = d.startDate + '~' + d.endDate;
      return dealPeriod === settlement.dealPeriod || 
             (d.brandName === settlement.brandName) ||
             (d.sellerName && d.sellerName.includes(settlement.sellerName));
    });
    if (matchingDeal && matchingDeal.products && matchingDeal.products.length > 0) {
      items = matchingDeal.products.map(p => ({
        productName: p.productName || p.name,
        unitPrice: Number(p.salePrice) || Number(p.price) || 0,
        quantity: 0,
        amount: 0
      }));
    }
  }
  
  // ë§¤ì¹­ë˜ëŠ” ê³µê¸‰ì‚¬ ì •ì‚°ì—ì„œ ì•„ì´í…œ ê°€ì ¸ì˜¤ê¸°
  if (items.length === 0) {
    const supplierSettlements = state.supplierSettlements || [];
    const matchingSupplier = supplierSettlements.find(sup => 
      ((sup.sellerName || '').includes(settlement.sellerName || '') || (settlement.sellerName || '').includes(sup.sellerName || '')) &&
      ((sup.brandName || '').includes(settlement.brandName || '') || (settlement.brandName || '').includes(sup.brandName || ''))
    );
    if (matchingSupplier && matchingSupplier.items) {
      items = matchingSupplier.items;
    }
  }
  
  // ìƒí’ˆë³„ í–‰ ìƒì„±
  let productRows = '';
  let totalQty = 0;
  let totalSalesAmount = 0;
  
  if (items.length > 0) {
    items.forEach((item, i) => {
      const price = Number(item.unitPrice) || Number(item.salePrice) || Number(item.price) || 0;
      const qty = Number(item.quantity) || 0;
      const amount = Number(item.amount) || (price * qty);
      totalQty += qty;
      totalSalesAmount += amount;
      
      productRows += '<tr>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; font-size: 13px;">' + (item.productName || '-') + '</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + price.toLocaleString() + 'ì›</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">' + qty + '</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + amount.toLocaleString() + 'ì›</td>' +
        '</tr>';
    });
    
    // í•©ê³„í–‰
    productRows += '<tr style="background: #f9fafb; font-weight: 600;">' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">í•©ê³„</td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb;"></td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">' + (totalQty || settlement.totalQuantity || 0) + '</td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + (totalSalesAmount || Number(settlement.salesAmount) || 0).toLocaleString() + 'ì›</td>' +
      '</tr>';
  }
  
  const content = `
    <div style="max-width: 700px; margin: 0 auto; padding: 40px; font-family: 'Malgun Gothic', sans-serif;">
      <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 28px; margin-bottom: 8px; color: #16a34a;">ì…€ëŸ¬ ì •ì‚°ì„œ</h1>
        <p style="color: #6b7684;">ëª¨ì—¬ë¼ë”œ | ${today}</p>
      </div>
      
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #dcfce7;">
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; width: 25%;">ì…€ëŸ¬ëª…</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;"><strong>${settlement.sellerName}</strong></td>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; width: 25%;">ë¸Œëœë“œ</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.brandName}</td>
        </tr>
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ê³µêµ¬ê¸°ê°„</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.dealPeriod || '-'}</td>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ì •ì‚°ì¼</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.settlementDate}</td>
        </tr>
      </table>
      
      <!-- íŒë§¤ ìƒí’ˆ ë‚´ì—­ -->
      <h3 style="font-size: 16px; margin-bottom: 16px; color: #16a34a;">ğŸ“¦ íŒë§¤ ìƒí’ˆ ë‚´ì—­</h3>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #dcfce7;">
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb;">íŒë§¤ìƒí’ˆ</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 100px;">ë‹¨ê°€</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 60px;">ìˆ˜ëŸ‰</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 120px;">íŒë§¤ê¸ˆì•¡</th>
        </tr>
        ${productRows || '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7684;">ìƒí’ˆ ì •ë³´ ì—†ìŒ</td></tr>'}
      </table>
      
      <!-- ì •ì‚° ë‚´ì—­ -->
      <h3 style="font-size: 16px; margin-bottom: 16px; color: #16a34a;">ğŸ’° ì •ì‚° ë‚´ì—­</h3>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #f9fafb;">
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left;">í•­ëª©</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">ê¸ˆì•¡</th>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">ì´ íŒë§¤ê¸ˆì•¡</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">${Number(settlement.salesAmount || 0).toLocaleString()}ì›</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">ì´ ìˆ˜ëŸ‰</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">${settlement.totalQuantity || totalQty || '-'}ê°œ</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">ë§ˆì§„ê¸ˆì•¡ (${settlement.marginRate || 0}%)</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">${Number(settlement.marginAmount || 0).toLocaleString()}ì›</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">ì›ì²œì„¸ (3.3%)</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right; color: #dc2626;">-${Number(settlement.withholdingTax || 0).toLocaleString()}ì›</td>
        </tr>
        <tr style="background: #dcfce7;">
          <td style="padding: 16px; border: 1px solid #e5e7eb; font-weight: 700;">ì‹¤ì§€ê¸‰ì•¡</td>
          <td style="padding: 16px; border: 1px solid #e5e7eb; text-align: right; font-weight: 700; font-size: 20px; color: #16a34a;">${Number(settlement.actualPayment || 0).toLocaleString()}ì›</td>
        </tr>
      </table>
      
      <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <p style="color: #6b7684; font-size: 13px;">ë³¸ ì •ì‚°ì„œëŠ” ëª¨ì—¬ë¼ë”œì—ì„œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write('<!DOCTYPE html><html><head><title>ì…€ëŸ¬ ì •ì‚°ì„œ - ' + settlement.sellerName + '</title></head><body>' + content + '</body></html>');
  printWindow.document.close();
}

// ê³µê¸‰ì‚¬ ì •ì‚°ì„œ ìƒì„±
function generateSupplierStatement(settlementId) {
  const settlement = state.sellerSettlements.find(s => s.id === settlementId);
  if (!settlement) return showToast('ì •ì‚° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  
  const today = new Date().toLocaleDateString('ko-KR');
  
  // ë§¤ì¹­ë˜ëŠ” ê³µê¸‰ì‚¬ ì •ì‚° ì°¾ê¸° (ê²½ì˜íŒ€ ì‹œìŠ¤í…œê³¼ ë™ì¼í•œ ë¡œì§)
  const supplierSettlements = state.supplierSettlements || [];
  const matchingSupplier = supplierSettlements.find(sup => 
    ((sup.sellerName || '').includes(settlement.sellerName || '') || (settlement.sellerName || '').includes(sup.sellerName || '')) &&
    ((sup.brandName || '').includes(settlement.brandName || '') || (settlement.brandName || '').includes(sup.brandName || ''))
  );
  
  // ìƒí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê²½ì˜íŒ€ ì •ì‚°ì„œì™€ ë™ì¼í•œ ë¡œì§)
  let items = settlement.salesItems || settlement.items || [];
  
  // ê³µê¸‰ì‚¬ ì •ì‚°ì˜ items ë¨¼ì € í™•ì¸
  if (items.length === 0 && matchingSupplier && matchingSupplier.items) {
    items = matchingSupplier.items;
  }
  
  // ê³µêµ¬ ê´€ë¦¬(deals)ì—ì„œ ìƒí’ˆ ì •ë³´ ì—°ë™
  if (items.length === 0 && settlement.dealPeriod) {
    const matchingDeal = state.deals.find(d => {
      const dealPeriod = d.startDate + '~' + d.endDate;
      return dealPeriod === settlement.dealPeriod || 
             (d.brandName === settlement.brandName) ||
             (d.sellerName && d.sellerName.includes(settlement.sellerName));
    });
    if (matchingDeal && matchingDeal.products && matchingDeal.products.length > 0) {
      items = matchingDeal.products.map(p => ({
        productName: p.productName || p.name,
        unitPrice: Number(p.salePrice) || Number(p.price) || 0,
        salePrice: Number(p.salePrice) || Number(p.price) || 0,
        supplyPrice: Number(p.supplyPrice) || 0,
        quantity: 0
      }));
    }
  }
  
  // ì…€ëŸ¬ëª…ì—ì„œ ë‹‰ë„¤ì„ë§Œ ì¶”ì¶œ (ì˜ˆ: ì •ì§€ì„ /ìš¸ë§˜(2ë§Œ) â†’ ìš¸ë§˜(2ë§Œ))
  const sellerName = settlement.sellerName || '-';
  const sellerParts = sellerName.split('/');
  const sellerDisplay = sellerParts.length > 1 ? sellerParts[1] : sellerName;
  
  // ê³µê¸‰ì‚¬ ì •ì‚° ê¸ˆì•¡ - supplierSettlementsì—ì„œ ìš°ì„  ê°€ì ¸ì˜¤ê¸°
  const supplyAmount = matchingSupplier ? Number(matchingSupplier.totalSupplyAmount) || 0 : Number(settlement.supplyAmount) || 0;
  const vatAmount = matchingSupplier ? Number(matchingSupplier.totalVatAmount) || 0 : Number(settlement.vatAmount) || 0;
  const totalAmount = matchingSupplier ? Number(matchingSupplier.totalAmount) || 0 : Number(settlement.supplierTotalAmount) || 0;
  const salesAmount = Number(settlement.salesAmount) || 0;
  
  // ìƒí’ˆë³„ í–‰ ìƒì„±
  let productRows = '';
  let totalQty = 0;
  let totalSalesAmount = 0;
  
  if (items.length > 0) {
    items.forEach((item, i) => {
      const price = Number(item.unitPrice) || Number(item.salePrice) || Number(item.price) || 0;
      const qty = Number(item.quantity) || 0;
      const amount = Number(item.amount) || (price * qty);
      totalQty += qty;
      totalSalesAmount += amount;
      
      productRows += '<tr>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; font-size: 13px;">' + (item.productName || '-') + '</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + price.toLocaleString() + 'ì›</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">' + qty + '</td>' +
        '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + amount.toLocaleString() + 'ì›</td>' +
        '</tr>';
    });
    
    // í•©ê³„í–‰
    productRows += '<tr style="background: #f9fafb; font-weight: 600;">' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">í•©ê³„</td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb;"></td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: center;">' + (totalQty || settlement.totalQuantity || 0) + '</td>' +
      '<td style="padding: 10px 12px; border: 1px solid #e5e7eb; text-align: right;">' + (totalSalesAmount || salesAmount).toLocaleString() + 'ì›</td>' +
      '</tr>';
  }
  
  const content = `
    <div style="max-width: 700px; margin: 0 auto; padding: 40px; font-family: 'Malgun Gothic', sans-serif;">
      <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 28px; margin-bottom: 8px; color: #ca8a04;">ê³µê¸‰ì‚¬ ì •ì‚°ì„œ</h1>
        <p style="color: #6b7684;">ëª¨ì—¬ë¼ë”œ | ${today}</p>
      </div>
      
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #fef9c3;">
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; width: 25%;">ê³µê¸‰ì‚¬(ë¸Œëœë“œ)</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;"><strong>${settlement.brandName}</strong></td>
        </tr>
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ì…€ëŸ¬</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${sellerDisplay}</td>
        </tr>
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ê³µêµ¬ê¸°ê°„</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.dealPeriod || '-'}</td>
        </tr>
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; background: #f9fafb;">ì •ì‚°ì¼</th>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${settlement.settlementDate}</td>
        </tr>
      </table>
      
      <h3 style="font-size: 16px; margin-bottom: 16px; color: #ca8a04;">ğŸ“¦ íŒë§¤ ìƒí’ˆ ë‚´ì—­</h3>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr style="background: #fef9c3;">
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb;">íŒë§¤ìƒí’ˆ</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 100px;">ë‹¨ê°€</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 60px;">ìˆ˜ëŸ‰</th>
          <th style="padding: 10px 12px; border: 1px solid #e5e7eb; width: 120px;">íŒë§¤ê¸ˆì•¡</th>
        </tr>
        ${productRows || '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7684;">ìƒí’ˆ ì •ë³´ ì—†ìŒ</td></tr>'}
      </table>
      
      <h3 style="font-size: 16px; margin-bottom: 16px; color: #ca8a04;">ğŸ’° ê³µê¸‰ì‚¬ ì •ì‚° ê¸ˆì•¡</h3>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
        <tr>
          <td style="padding: 14px; border: 1px solid #e5e7eb; background: #f9fafb; width: 50%;">ê³µê¸‰ê°€ì•¡</td>
          <td style="padding: 14px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600;">${supplyAmount.toLocaleString()}ì›</td>
        </tr>
        <tr>
          <td style="padding: 14px; border: 1px solid #e5e7eb; background: #f9fafb;">ë¶€ê°€ì„¸ (10%)</td>
          <td style="padding: 14px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600;">${vatAmount.toLocaleString()}ì›</td>
        </tr>
        <tr style="background: #fef9c3;">
          <td style="padding: 16px; border: 1px solid #e5e7eb; font-weight: 700; font-size: 15px;">í•©ê³„ ì •ì‚°ê¸ˆì•¡ (V+)</td>
          <td style="padding: 16px; border: 1px solid #e5e7eb; text-align: right; font-weight: 700; font-size: 20px; color: #ca8a04;">${totalAmount.toLocaleString()}ì›</td>
        </tr>
      </table>
      
      <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <p style="color: #6b7684; font-size: 13px;">ë³¸ ì •ì‚°ì„œëŠ” ëª¨ì—¬ë¼ë”œì—ì„œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write('<!DOCTYPE html><html><head><title>ê³µê¸‰ì‚¬ ì •ì‚°ì„œ - ' + settlement.brandName + '</title></head><body>' + content + '</body></html>');
  printWindow.document.close();
}

// ==================== íŒŒíŠ¸ë„ˆ ì†Œí†µ ê´€ë¦¬ ====================
function renderPartnerMessages() {
  const app = document.getElementById('app');
  
  // íŒŒíŠ¸ë„ˆë³„ë¡œ ê·¸ë£¹í™”
  const grouped = {};
  state.partnerMessages.forEach(m => {
    const key = `${m.partnerType}-${m.partnerId}`;
    if (!grouped[key]) {
      grouped[key] = {
        partnerId: m.partnerId,
        partnerType: m.partnerType,
        partnerName: m.partnerName,
        messages: [],
        lastMessage: null,
        unreadCount: 0
      };
    }
    grouped[key].messages.push(m);
    if (!grouped[key].lastMessage || new Date(m.createdAt) > new Date(grouped[key].lastMessage.createdAt)) {
      grouped[key].lastMessage = m;
    }
    if (!m.isAdmin && !m.isRead) {
      grouped[key].unreadCount++;
    }
  });
  
  const conversations = Object.values(grouped).sort((a, b) => 
    new Date(b.lastMessage?.createdAt || 0) - new Date(a.lastMessage?.createdAt || 0)
  );
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ’¬ íŒŒíŠ¸ë„ˆ ì†Œí†µ</h1>
      <p style="color: var(--gray-500); margin-top: 4px;">ê³µê¸‰ì‚¬/ì…€ëŸ¬ì™€ 1:1 ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ìŠµë‹ˆë‹¤.</p>
    </div>
    
    <div class="card">
      ${conversations.length === 0 ? `
        <div style="text-align: center; padding: 60px 20px; color: var(--gray-500);">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’¬</div>
          <p>ì•„ì§ íŒŒíŠ¸ë„ˆ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      ` : `
        <div style="display: grid; gap: 8px;">
          ${conversations.map(c => `
            <div onclick="openMessageThread('${c.partnerType}', '${c.partnerId}', '${c.partnerName}')" 
                 style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid var(--gray-200); border-radius: 12px; cursor: pointer; transition: all 0.15s; ${c.unreadCount > 0 ? 'background: var(--primary-light); border-color: var(--primary);' : ''}"
                 onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='${c.unreadCount > 0 ? 'var(--primary-light)' : ''}'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; background: ${c.partnerType === 'supplier' ? 'var(--info-light)' : 'var(--primary-light)'};">
                  ${c.partnerType === 'supplier' ? 'ğŸ­' : 'ğŸ‘¤'}
                </div>
                <div>
                  <div style="font-weight: 600; margin-bottom: 4px;">
                    ${c.partnerName}
                    <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; background: ${c.partnerType === 'supplier' ? 'var(--info-light)' : 'var(--primary-light)'}; color: ${c.partnerType === 'supplier' ? 'var(--info)' : 'var(--primary)'};">
                      ${c.partnerType === 'supplier' ? 'ê³µê¸‰ì‚¬' : 'ì…€ëŸ¬'}
                    </span>
                  </div>
                  <div style="font-size: 13px; color: var(--gray-500); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${c.lastMessage?.content || ''}
                  </div>
                </div>
              </div>
              <div style="text-align: right;">
                ${c.unreadCount > 0 ? `
                  <div style="background: var(--danger); color: white; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; margin-bottom: 4px;">
                    ${c.unreadCount}
                  </div>
                ` : ''}
                <div style="font-size: 12px; color: var(--gray-400);">
                  ${formatDateKR(c.lastMessage?.createdAt)}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

// ë©”ì‹œì§€ ìŠ¤ë ˆë“œ ì—´ê¸°
function openMessageThread(partnerType, partnerId, partnerName) {
  const messages = state.partnerMessages
    .filter(m => m.partnerId === partnerId && m.partnerType === partnerType)
    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
  
  // ì•ˆì½ì€ ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
  messages.forEach(m => {
    if (!m.isAdmin && !m.isRead) {
      db.collection('partnerMessages').doc(m.id).update({ isRead: true });
    }
  });
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
      <div class="modal-header" style="flex-shrink: 0;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: ${partnerType === 'supplier' ? 'var(--info-light)' : 'var(--primary-light)'};">
            ${partnerType === 'supplier' ? 'ğŸ­' : 'ğŸ‘¤'}
          </div>
          <div>
            <h2 class="modal-title" style="margin: 0;">${partnerName}</h2>
            <span style="font-size: 12px; color: var(--gray-500);">${partnerType === 'supplier' ? 'ê³µê¸‰ì‚¬' : 'ì…€ëŸ¬'}</span>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      
      <div id="message-thread" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--gray-50);">
        ${messages.length === 0 ? `
          <div style="text-align: center; padding: 40px; color: var(--gray-500);">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        ` : messages.map(msg => `
          <div style="display: flex; flex-direction: column; align-items: ${msg.isAdmin ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
            <div style="max-width: 80%; padding: 12px 16px; border-radius: 16px; ${msg.isAdmin ? 'background: var(--primary); color: white; border-bottom-right-radius: 4px;' : 'background: white; border: 1px solid var(--gray-200); border-bottom-left-radius: 4px;'}">
              <div style="font-size: 14px; line-height: 1.5;">${msg.content}</div>
            </div>
            <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px; padding: 0 4px;">
              ${msg.isAdmin ? 'ê´€ë¦¬ì' : partnerName} Â· ${formatDateKR(msg.createdAt)}
            </div>
          </div>
        `).join('')}
      </div>
      
      <div style="flex-shrink: 0; padding: 16px; border-top: 1px solid var(--gray-200); background: white;">
        <div style="display: flex; gap: 8px;">
          <input type="text" id="admin-message-input" class="form-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1;" onkeypress="if(event.key==='Enter')sendAdminMessage('${partnerType}','${partnerId}','${partnerName}')">
          <button class="btn btn-primary" style="flex-shrink: 0;" onclick="sendAdminMessage('${partnerType}','${partnerId}','${partnerName}')">ì „ì†¡</button>
        </div>
      </div>
    </div>
  `;
  
  // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
  setTimeout(() => {
    const thread = document.getElementById('message-thread');
    if (thread) thread.scrollTop = thread.scrollHeight;
  }, 100);
}

// ê´€ë¦¬ì ë©”ì‹œì§€ ì „ì†¡
async function sendAdminMessage(partnerType, partnerId, partnerName) {
  const input = document.getElementById('admin-message-input');
  const content = input.value.trim();
  if (!content) return;
  
  try {
    await db.collection('partnerMessages').add({
      partnerId: partnerId,
      partnerType: partnerType,
      partnerName: partnerName,
      content: content,
      isAdmin: true,
      isRead: true,
      createdAt: new Date().toISOString()
    });
    
    input.value = '';
    showToast('ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.');
    openMessageThread(partnerType, partnerId, partnerName);
  } catch (e) {
    console.error(e);
    showToast('ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ğŸš€ ê³µêµ¬ì„¼í„° (í†µí•©) ====================
function renderDealCenter() {
  const app = document.getElementById('app');
  
  // ë°ì´í„° ì¤€ë¹„
  const urgentList = (state.urgentSales || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const sellerProposals = (state.sellerProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const adminProposals = (state.adminProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  // í†µê³„
  const urgentPending = urgentList.filter(u => !u.status || u.status === 'pending').length;
  const sellerPending = sellerProposals.filter(p => !p.status || p.status === 'pending').length;
  const adminPending = adminProposals.filter(p => !p.sellerStatus || p.sellerStatus === 'pending').length;
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ê³µêµ¬ì„¼í„°</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ê¸´ê¸‰íŒë§¤ìš”ì²­, ê³µêµ¬ ì œì•ˆì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
      <button onclick="openAdminProposalModal()" style="
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35);
        display: flex;
        align-items: center;
        gap: 6px;
      ">
        <span style="font-size: 18px;">+</span> ì…€ëŸ¬ì—ê²Œ ì œì•ˆ
      </button>
    </div>
    
    <!-- íƒ­ -->
    <div style="display: flex; gap: 4px; margin-bottom: 24px; background: var(--gray-100); padding: 4px; border-radius: 12px;">
      <button id="tab-urgent" onclick="switchDealCenterTab('urgent')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600); color: white; cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.3);
      ">
        ê¸´ê¸‰íŒë§¤ìš”ì²­ <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 8px; margin-left: 4px;">${urgentList.length}</span>
        ${urgentPending > 0 ? `<span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ëŒ€ê¸° ${urgentPending}</span>` : ''}
      </button>
      <button id="tab-received" onclick="switchDealCenterTab('received')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: transparent; color: var(--gray-500); cursor: pointer;
      ">
        ë°›ì€ ì œì•ˆ <span style="opacity: 0.7;">${sellerProposals.length}</span>
        ${sellerPending > 0 ? `<span style="background: #2563eb; color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ê²€í†  ${sellerPending}</span>` : ''}
      </button>
      <button id="tab-sent" onclick="switchDealCenterTab('sent')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: transparent; color: var(--gray-500); cursor: pointer;
      ">
        ë³´ë‚¸ ì œì•ˆ <span style="opacity: 0.7;">${adminProposals.length}</span>
        ${adminPending > 0 ? `<span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ëŒ€ê¸° ${adminPending}</span>` : ''}
      </button>
    </div>
    
    <!-- ì½˜í…ì¸  ì˜ì—­ -->
    <div id="dealCenterContent">
      ${renderDealCenterUrgent(urgentList)}
    </div>
  `;
}

// ì˜¤ëŠ˜ ì²˜ë¦¬ëœ ê±´ìˆ˜
function getTodayProcessed() {
  const today = new Date().toISOString().slice(0, 10);
  let count = 0;
  
  // ê¸´ê¸‰íŒë§¤ìš”ì²­ ì¤‘ ì˜¤ëŠ˜ ì™„ë£Œëœ ê²ƒ
  (state.urgentSales || []).forEach(u => {
    if (u.status === 'completed' && u.updatedAt?.slice(0, 10) === today) count++;
  });
  
  // ì…€ëŸ¬ ì œì•ˆ ì¤‘ ì˜¤ëŠ˜ ì²˜ë¦¬ëœ ê²ƒ
  (state.sellerProposals || []).forEach(p => {
    if ((p.status === 'approved' || p.status === 'rejected') && p.updatedAt?.slice(0, 10) === today) count++;
  });
  
  return count;
}

// íƒ­ ì „í™˜
function switchDealCenterTab(tab) {
  // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
  ['urgent', 'received', 'sent'].forEach(t => {
    const btn = document.getElementById('tab-' + t);
    if (btn) {
      if (t === tab) {
        btn.style.background = 'linear-gradient(145deg, #fc9600, #e08600)';
        btn.style.color = 'white';
        btn.style.boxShadow = '0 4px 12px rgba(252,150,0,0.3)';
      } else {
        btn.style.background = 'transparent';
        btn.style.color = 'var(--gray-500)';
        btn.style.boxShadow = 'none';
      }
    }
  });
  
  // ì½˜í…ì¸  ë³€ê²½
  const content = document.getElementById('dealCenterContent');
  if (tab === 'urgent') {
    const urgentList = (state.urgentSales || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    content.innerHTML = renderDealCenterUrgent(urgentList);
  } else if (tab === 'received') {
    const sellerProposals = (state.sellerProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    content.innerHTML = renderDealCenterReceived(sellerProposals);
  } else if (tab === 'sent') {
    const adminProposals = (state.adminProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    content.innerHTML = renderDealCenterSent(adminProposals);
  }
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ íƒ­ ì½˜í…ì¸ 
function renderDealCenterUrgent(urgentList) {
  if (urgentList.length === 0) {
    return `
      <div class="card" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div>
        <p style="color: var(--gray-500);">ë“±ë¡ëœ ê¸´ê¸‰íŒë§¤ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    `;
  }
  
  return `
    <div class="card">
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ìƒíƒœ</th>
              <th>ê³µê¸‰ì‚¬</th>
              <th>ìƒí’ˆëª…</th>
              <th>ìš”ì²­ìœ í˜•</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>í¬ë§ì¼</th>
              <th>ë“±ë¡ì¼</th>
              <th style="text-align: center;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${urgentList.map(u => {
              const supplier = state.suppliers.find(s => s.id === u.supplierId);
              const supplierName = supplier?.name || u.supplierName || '-';
              const statusLabel = u.status === 'completed' ? 'ì™„ë£Œ' : u.status === 'processing' ? 'ì²˜ë¦¬ì¤‘' : 'ëŒ€ê¸°';
              const statusColor = u.status === 'completed' ? '#16a34a' : u.status === 'processing' ? 'var(--primary)' : '#dc2626';
              const statusBg = u.status === 'completed' ? '#f0fdf4' : u.status === 'processing' ? '#fff8f0' : '#fef2f2';
              
              return `
                <tr>
                  <td>
                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">
                      ${statusLabel}
                    </span>
                  </td>
                  <td style="font-weight: 600;">${supplierName}</td>
                  <td>${u.productName || '-'}</td>
                  <td>
                    <span style="padding: 3px 8px; border-radius: 8px; font-size: 11px; background: ${u.requestType === 'newProduct' ? '#dbeafe' : u.requestType === 'inventory' ? '#fef3c7' : '#f3e8ff'}; color: ${u.requestType === 'newProduct' ? '#1d4ed8' : u.requestType === 'inventory' ? '#d97706' : '#7c3aed'};">
                      ${u.requestType === 'newProduct' ? 'ì‹ ìƒí’ˆ' : u.requestType === 'inventory' ? 'ì¬ê³ ì²˜ë¦¬' : u.requestType === 'seasonal' ? 'ì‹œì¦Œìƒí’ˆ' : 'ê¸°íƒ€'}
                    </span>
                  </td>
                  <td>${u.quantity || '-'}ê°œ</td>
                  <td>${u.desiredDate || '-'}</td>
                  <td style="font-size: 12px; color: var(--gray-500);">${u.createdAt?.slice(0, 10) || '-'}</td>
                  <td style="text-align: center;">
                    <div style="display: flex; gap: 6px; justify-content: center;">
                      <button onclick="viewUrgentSalesDetail('${u.id}')" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; background: white; cursor: pointer; font-size: 12px;">ìƒì„¸</button>
                      ${u.status !== 'completed' ? `
                        <button onclick="proposeUrgentToSeller('${u.id}')" style="padding: 6px 12px; border: none; border-radius: 6px; background: var(--primary); color: white; cursor: pointer; font-size: 12px; font-weight: 600;">ê³µêµ¬ì œì•ˆ</button>
                      ` : ''}
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ë°›ì€ ì œì•ˆ íƒ­ ì½˜í…ì¸  (ì…€ëŸ¬ â†’ ì–´ë“œë¯¼)
function renderDealCenterReceived(sellerProposals) {
  if (sellerProposals.length === 0) {
    return `
      <div class="card" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¨</div>
        <p style="color: var(--gray-500);">ì…€ëŸ¬ë¡œë¶€í„° ë°›ì€ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    `;
  }
  
  return `
    <div class="card">
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ìƒíƒœ</th>
              <th>ì…€ëŸ¬</th>
              <th>ì œì•ˆ ì œëª©</th>
              <th>ë¸Œëœë“œ/ìƒí’ˆ</th>
              <th>í¬ë§ê°€ê²©</th>
              <th>ì œì•ˆì¼</th>
              <th style="text-align: center;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${sellerProposals.map(p => {
              const statusLabel = p.status === 'approved' ? 'ìŠ¹ì¸' : p.status === 'rejected' ? 'ë°˜ë ¤' : 'ê²€í† ëŒ€ê¸°';
              const statusColor = p.status === 'approved' ? '#16a34a' : p.status === 'rejected' ? '#dc2626' : '#2563eb';
              const statusBg = p.status === 'approved' ? '#f0fdf4' : p.status === 'rejected' ? '#fef2f2' : '#eff6ff';
              
              return `
                <tr>
                  <td>
                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">
                      ${statusLabel}
                    </span>
                  </td>
                  <td style="font-weight: 600;">${p.sellerName || '-'}</td>
                  <td>${p.title || '-'}</td>
                  <td>${p.brandName || p.productName || '-'}</td>
                  <td>${p.desiredPrice ? formatNumber(p.desiredPrice) + 'ì›' : '-'}</td>
                  <td style="font-size: 12px; color: var(--gray-500);">${p.createdAt?.slice(0, 10) || '-'}</td>
                  <td style="text-align: center;">
                    <div style="display: flex; gap: 6px; justify-content: center;">
                      <button onclick="viewSellerProposalDetail('${p.id}')" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; background: white; cursor: pointer; font-size: 12px;">ìƒì„¸</button>
                      <button onclick="deleteSellerProposal('${p.id}')" style="padding: 6px 12px; border: 1px solid #dc2626; border-radius: 6px; background: white; color: #dc2626; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ë³´ë‚¸ ì œì•ˆ íƒ­ ì½˜í…ì¸  (ì–´ë“œë¯¼ â†’ ì…€ëŸ¬)
function renderDealCenterSent(adminProposals) {
  if (adminProposals.length === 0) {
    return `
      <div class="card" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¬</div>
        <p style="color: var(--gray-500);">ì…€ëŸ¬ì—ê²Œ ë³´ë‚¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <button class="btn btn-primary" style="margin-top: 16px;" onclick="openAdminProposalModal()">+ ìƒˆ ì œì•ˆ ë³´ë‚´ê¸°</button>
      </div>
    `;
  }
  
  return `
    <div class="card">
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>ì…€ëŸ¬ì‘ë‹µ</th>
              <th>ëŒ€ìƒ ì…€ëŸ¬</th>
              <th>ìƒí’ˆëª…</th>
              <th>ê³µê¸‰ì‚¬</th>
              <th>ì œì•ˆì¼</th>
              <th style="text-align: center;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${adminProposals.map(p => {
              const statusLabel = p.sellerStatus === 'accepted' ? 'ìˆ˜ë½' : p.sellerStatus === 'rejected' ? 'ê±°ì ˆ' : 'ëŒ€ê¸°ì¤‘';
              const statusColor = p.sellerStatus === 'accepted' ? '#16a34a' : p.sellerStatus === 'rejected' ? '#dc2626' : 'var(--primary)';
              const statusBg = p.sellerStatus === 'accepted' ? '#f0fdf4' : p.sellerStatus === 'rejected' ? '#fef2f2' : '#fff8f0';
              
              return `
                <tr>
                  <td>
                    <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">
                      ${statusLabel}
                    </span>
                  </td>
                  <td style="font-weight: 600;">${p.sellerName || '-'}</td>
                  <td>${p.productName || '-'}</td>
                  <td>${p.supplierName || '-'}</td>
                  <td style="font-size: 12px; color: var(--gray-500);">${p.createdAt?.slice(0, 10) || '-'}</td>
                  <td style="text-align: center;">
                    <div style="display: flex; gap: 6px; justify-content: center;">
                      <button onclick="openAdminProposalModal(true, '${p.id}')" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; background: white; cursor: pointer; font-size: 12px;">ìˆ˜ì •</button>
                      <button onclick="deleteAdminProposal('${p.id}')" style="padding: 6px 12px; border: 1px solid #dc2626; border-radius: 6px; background: white; color: #dc2626; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ì…€ëŸ¬ ì œì•ˆ ìƒì„¸ ë³´ê¸°
function viewSellerProposalDetail(proposalId) {
  const p = (state.sellerProposals || []).find(pr => pr.id === proposalId);
  if (!p) return;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ“¨ ì…€ëŸ¬ ì œì•ˆ ìƒì„¸</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; gap: 12px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ì…€ëŸ¬</div>
              <div style="font-weight: 600;">${p.sellerName || '-'}</div>
            </div>
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ì œì•ˆì¼</div>
              <div style="font-weight: 600;">${p.createdAt?.slice(0, 10) || '-'}</div>
            </div>
          </div>
          <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
            <div style="font-size: 11px; color: var(--gray-500);">ì œì•ˆ ì œëª©</div>
            <div style="font-weight: 600; font-size: 15px;">${p.title || '-'}</div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ë¸Œëœë“œ/ìƒí’ˆ</div>
              <div style="font-weight: 600;">${p.brandName || p.productName || '-'}</div>
            </div>
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">í¬ë§ê°€ê²©</div>
              <div style="font-weight: 600;">${p.desiredPrice ? formatNumber(p.desiredPrice) + 'ì›' : '-'}</div>
            </div>
          </div>
          ${p.content ? `
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ì œì•ˆ ë‚´ìš©</div>
              <div style="white-space: pre-wrap; margin-top: 4px;">${p.content}</div>
            </div>
          ` : ''}
          ${p.referenceLink ? `
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
              <div style="font-size: 11px; color: var(--gray-500);">ì°¸ê³  ë§í¬</div>
              <a href="${p.referenceLink}" target="_blank" style="color: var(--primary); text-decoration: underline;">${p.referenceLink}</a>
            </div>
          ` : ''}
          <div style="padding: 12px; background: var(--gray-50); border-radius: 8px;">
            <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 8px;">ìƒíƒœ ë³€ê²½</div>
            <select id="sellerProposalStatus" style="width: 100%; padding: 8px; border: 1px solid var(--gray-200); border-radius: 6px;">
              <option value="pending" ${!p.status || p.status === 'pending' ? 'selected' : ''}>ê²€í† ëŒ€ê¸°</option>
              <option value="approved" ${p.status === 'approved' ? 'selected' : ''}>ìŠ¹ì¸</option>
              <option value="rejected" ${p.status === 'rejected' ? 'selected' : ''}>ë°˜ë ¤</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 8px; justify-content: space-between;">
        <button class="btn" style="background: var(--danger); color: white;" onclick="deleteSellerProposal('${p.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          <button class="btn btn-primary" onclick="updateSellerProposalStatus('${p.id}')">ìƒíƒœ ì €ì¥</button>
        </div>
      </div>
    </div>
  `;
}

// ì…€ëŸ¬ ì œì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateSellerProposalStatus(proposalId) {
  const status = document.getElementById('sellerProposalStatus').value;
  try {
    await db.collection('sellerProposals').doc(proposalId).update({ 
      status,
      updatedAt: new Date().toISOString()
    });
    showToast('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    setTimeout(() => switchDealCenterTab('received'), 300);
  } catch (e) {
    console.error(e);
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì…€ëŸ¬ ì œì•ˆ ì‚­ì œ
async function deleteSellerProposal(proposalId) {
  if (!confirm('ì´ ì œì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('sellerProposals').doc(proposalId).delete();
    showToast('ì œì•ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    setTimeout(() => switchDealCenterTab('received'), 300);
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì–´ë“œë¯¼ ì œì•ˆ ì‚­ì œ
async function deleteAdminProposal(proposalId) {
  if (!confirm('ì´ ì œì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('adminProposals').doc(proposalId).delete();
    showToast('ì œì•ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(() => switchDealCenterTab('sent'), 300);
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ê¸´ê¸‰íŒë§¤ìš”ì²­ ê´€ë¦¬ ====================
function renderUrgentSales() {
  const app = document.getElementById('app');
  
  const urgentList = state.urgentSales.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  // ìƒíƒœë³„ ë¶„ë¥˜
  const pendingList = urgentList.filter(u => u.status === 'pending' || !u.status);
  const processingList = urgentList.filter(u => u.status === 'processing');
  const completedList = urgentList.filter(u => u.status === 'completed');
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ”¥ ê¸´ê¸‰íŒë§¤ìš”ì²­</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ê³µê¸‰ì‚¬ê°€ ë“±ë¡í•œ ê¸´ê¸‰íŒë§¤ìš”ì²­ì„ í™•ì¸í•˜ê³  ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ì œì•ˆí•©ë‹ˆë‹¤.</p>
      </div>
    </div>
    
    <!-- ìš”ì•½ ì¹´ë“œ -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
      <div style="padding: 20px; background: linear-gradient(145deg, #fef2f2, #fee2e2); border-radius: 14px; border: 1px solid #fecaca;">
        <div style="font-size: 28px; font-weight: 700; color: #dc2626;">${pendingList.length}</div>
        <div style="font-size: 13px; color: var(--gray-600);">ëŒ€ê¸° ì¤‘</div>
      </div>
      <div style="padding: 20px; background: linear-gradient(145deg, #fff8f0, #fff5eb); border-radius: 14px; border: 1px solid rgba(252,150,0,0.3);">
        <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${processingList.length}</div>
        <div style="font-size: 13px; color: var(--gray-600);">ì²˜ë¦¬ ì¤‘</div>
      </div>
      <div style="padding: 20px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 14px; border: 1px solid #86efac;">
        <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${completedList.length}</div>
        <div style="font-size: 13px; color: var(--gray-600);">ì™„ë£Œ</div>
      </div>
    </div>
    
    <div class="card">
      <h3 class="card-title" style="margin-bottom: 16px;">ìš”ì²­ ëª©ë¡ (${urgentList.length}ê±´)</h3>
      
      ${urgentList.length === 0 ? `
        <div style="text-align: center; padding: 60px 20px; color: var(--gray-500);">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div>
          <p>ì•„ì§ ë“±ë¡ëœ ê¸´ê¸‰íŒë§¤ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      ` : `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ìƒíƒœ</th>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ìƒí’ˆëª…</th>
                <th>ìš”ì²­ìœ í˜•</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>í¬ë§ì¼</th>
                <th>ë“±ë¡ì¼</th>
                <th style="text-align: center;">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${urgentList.map(u => {
                const supplier = state.suppliers.find(s => s.id === u.supplierId);
                const supplierName = supplier?.name || u.supplierName || '-';
                const statusLabel = u.status === 'completed' ? 'ì™„ë£Œ' : u.status === 'processing' ? 'ì²˜ë¦¬ì¤‘' : 'ëŒ€ê¸°';
                const statusColor = u.status === 'completed' ? '#16a34a' : u.status === 'processing' ? 'var(--primary)' : '#dc2626';
                const statusBg = u.status === 'completed' ? '#f0fdf4' : u.status === 'processing' ? '#fff8f0' : '#fef2f2';
                
                return `
                  <tr>
                    <td>
                      <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">
                        ${statusLabel}
                      </span>
                    </td>
                    <td style="font-weight: 600;">${supplierName}</td>
                    <td>${u.productName || '-'}</td>
                    <td>
                      <span style="padding: 3px 8px; border-radius: 8px; font-size: 11px; background: ${u.requestType === 'newProduct' ? '#dbeafe' : u.requestType === 'inventory' ? '#fef3c7' : '#f3e8ff'}; color: ${u.requestType === 'newProduct' ? '#1d4ed8' : u.requestType === 'inventory' ? '#d97706' : '#7c3aed'};">
                        ${u.requestType === 'newProduct' ? 'ì‹ ìƒí’ˆ' : u.requestType === 'inventory' ? 'ì¬ê³ ì²˜ë¦¬' : u.requestType === 'seasonal' ? 'ì‹œì¦Œìƒí’ˆ' : 'ê¸°íƒ€'}
                      </span>
                    </td>
                    <td>${u.quantity || '-'}ê°œ</td>
                    <td>${u.desiredDate || '-'}</td>
                    <td style="font-size: 12px; color: var(--gray-500);">${u.createdAt?.slice(0, 10) || '-'}</td>
                    <td style="text-align: center;">
                      <div style="display: flex; gap: 6px; justify-content: center;">
                        <button onclick="viewUrgentSalesDetail('${u.id}')" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; background: white; cursor: pointer; font-size: 12px;">ìƒì„¸</button>
                        ${u.status !== 'completed' ? `
                          <button onclick="proposeUrgentToSeller('${u.id}')" style="padding: 6px 12px; border: none; border-radius: 6px; background: var(--primary); color: white; cursor: pointer; font-size: 12px; font-weight: 600;">ê³µêµ¬ì œì•ˆ</button>
                        ` : ''}
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ ìƒì„¸ ë³´ê¸°
function viewUrgentSalesDetail(urgentId) {
  const u = state.urgentSales.find(item => item.id === urgentId);
  if (!u) return;
  
  const supplier = state.suppliers.find(s => s.id === u.supplierId);
  const supplierName = supplier?.name || u.supplierName || '-';
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ”¥ ê¸´ê¸‰íŒë§¤ìš”ì²­ ìƒì„¸</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; gap: 16px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ê³µê¸‰ì‚¬</div>
              <div style="font-weight: 700; color: var(--gray-800);">${supplierName}</div>
            </div>
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìš”ì²­ìœ í˜•</div>
              <div style="font-weight: 700; color: var(--primary);">
                ${u.requestType === 'newProduct' ? 'ì‹ ìƒí’ˆ í™ë³´' : u.requestType === 'inventory' ? 'ì¬ê³ ì²˜ë¦¬' : u.requestType === 'seasonal' ? 'ì‹œì¦Œìƒí’ˆ' : 'ê¸°íƒ€'}
              </div>
            </div>
          </div>
          
          <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìƒí’ˆëª…</div>
            <div style="font-weight: 700; font-size: 16px; color: var(--gray-800);">${u.productName || '-'}</div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">í¬ë§ ìˆ˜ëŸ‰</div>
              <div style="font-weight: 700; color: var(--gray-800);">${u.quantity || '-'}ê°œ</div>
            </div>
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">í¬ë§ì¼</div>
              <div style="font-weight: 700; color: var(--gray-800);">${u.desiredDate || '-'}</div>
            </div>
          </div>
          
          ${u.note ? `
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìš”ì²­ì‚¬í•­</div>
              <div style="color: var(--gray-700); white-space: pre-wrap;">${u.note}</div>
            </div>
          ` : ''}
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ë“±ë¡ì¼</div>
              <div style="color: var(--gray-700);">${u.createdAt?.slice(0, 10) || '-'}</div>
            </div>
            <div style="padding: 16px; background: var(--gray-50); border-radius: 10px;">
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ìƒíƒœ</div>
              <div>
                <select id="urgentStatus" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 13px;">
                  <option value="pending" ${u.status === 'pending' || !u.status ? 'selected' : ''}>ëŒ€ê¸°</option>
                  <option value="processing" ${u.status === 'processing' ? 'selected' : ''}>ì²˜ë¦¬ì¤‘</option>
                  <option value="completed" ${u.status === 'completed' ? 'selected' : ''}>ì™„ë£Œ</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 8px; justify-content: space-between;">
        <button class="btn" style="background: var(--danger); color: white;" onclick="deleteUrgentSales('${u.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          <button class="btn btn-secondary" onclick="updateUrgentSalesStatus('${u.id}')">ìƒíƒœ ì €ì¥</button>
          ${u.status !== 'completed' ? `
            <button class="btn btn-primary" onclick="proposeUrgentToSeller('${u.id}')">ğŸš€ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ì œì•ˆ</button>
          ` : ''}
      </div>
    </div>
  `;
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateUrgentSalesStatus(urgentId) {
  const status = document.getElementById('urgentStatus').value;
  try {
    await db.collection('urgentSales').doc(urgentId).update({ status });
    showToast('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ ì‚­ì œ
async function deleteUrgentSales(urgentId) {
  if (!confirm('ì´ ê¸´ê¸‰íŒë§¤ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await db.collection('urgentSales').doc(urgentId).delete();
    showToast('ê¸´ê¸‰íŒë§¤ìš”ì²­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ â†’ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ì œì•ˆ
function proposeUrgentToSeller(urgentId) {
  const u = state.urgentSales.find(item => item.id === urgentId);
  if (!u) return;
  
  const supplier = state.suppliers.find(s => s.id === u.supplierId);
  const supplierName = supplier?.name || u.supplierName || '-';
  
  // ì…€ëŸ¬ ëª©ë¡ (ì—°ë½ì²˜ ìˆëŠ” ì…€ëŸ¬ë§Œ)
  const activeSellers = state.sellers.filter(s => s.name);
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸš€ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ì œì•ˆ</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="padding: 16px; background: linear-gradient(145deg, #fff8f0, #fff5eb); border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ê¸´ê¸‰íŒë§¤ìš”ì²­ ì •ë³´</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <span style="font-size: 12px; color: var(--gray-500);">ê³µê¸‰ì‚¬:</span>
              <span style="font-weight: 600; margin-left: 4px;">${supplierName}</span>
            </div>
            <div>
              <span style="font-size: 12px; color: var(--gray-500);">ìƒí’ˆ:</span>
              <span style="font-weight: 600; margin-left: 4px;">${u.productName || '-'}</span>
            </div>
            <div>
              <span style="font-size: 12px; color: var(--gray-500);">ìˆ˜ëŸ‰:</span>
              <span style="font-weight: 600; margin-left: 4px;">${u.quantity || '-'}ê°œ</span>
            </div>
            <div>
              <span style="font-size: 12px; color: var(--gray-500);">í¬ë§ì¼:</span>
              <span style="font-weight: 600; margin-left: 4px;">${u.desiredDate || '-'}</span>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œì•ˆí•  ì…€ëŸ¬ ì„ íƒ <span style="color: #dc2626;">*</span></label>
          <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 10px; padding: 12px;">
            ${activeSellers.length === 0 ? `
              <p style="text-align: center; color: var(--gray-400); padding: 20px;">ë“±ë¡ëœ ì…€ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            ` : activeSellers.map(s => {
              const parts = s.name?.split('/') || [s.name];
              const displayName = parts.length > 1 ? `${parts[0]} (${parts[1]})` : s.name;
              return `
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; background: var(--gray-50);">
                  <input type="checkbox" class="urgent-seller-checkbox" value="${s.id}" style="width: 18px; height: 18px;">
                  <span style="flex: 1; font-weight: 500;">${displayName}</span>
                </label>
              `;
            }).join('')}
          </div>
          <div style="margin-top: 8px; display: flex; gap: 8px;">
            <button type="button" onclick="document.querySelectorAll('.urgent-seller-checkbox').forEach(c=>c.checked=true)" style="padding: 6px 12px; background: var(--gray-100); border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">ì „ì²´ì„ íƒ</button>
            <button type="button" onclick="document.querySelectorAll('.urgent-seller-checkbox').forEach(c=>c.checked=false)" style="padding: 6px 12px; background: var(--gray-100); border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">ì „ì²´í•´ì œ</button>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œì•ˆ ë©”ì‹œì§€</label>
          <textarea id="urgentProposalMessage" class="form-control" rows="4" placeholder="ì…€ëŸ¬ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">${supplierName}ì—ì„œ ê¸´ê¸‰íŒë§¤ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤.\n\nìƒí’ˆ: ${u.productName || '-'}\nìˆ˜ëŸ‰: ${u.quantity || '-'}ê°œ\ní¬ë§ì¼: ${u.desiredDate || '-'}\n\nê´€ì‹¬ ìˆìœ¼ì‹œë©´ ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤!</textarea>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="sendUrgentProposalToSellers('${u.id}')">ğŸš€ ì œì•ˆ ë³´ë‚´ê¸°</button>
      </div>
    </div>
  `;
}

// ê¸´ê¸‰íŒë§¤ìš”ì²­ ê³µêµ¬ì œì•ˆ ì „ì†¡
async function sendUrgentProposalToSellers(urgentId) {
  const u = state.urgentSales.find(item => item.id === urgentId);
  if (!u) return;
  
  const checkedSellers = Array.from(document.querySelectorAll('.urgent-seller-checkbox:checked')).map(c => c.value);
  const message = document.getElementById('urgentProposalMessage').value;
  
  if (checkedSellers.length === 0) {
    showToast('ì œì•ˆí•  ì…€ëŸ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    // ê° ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ì œì•ˆ ìƒì„±
    for (const sellerId of checkedSellers) {
      const seller = state.sellers.find(s => s.id === sellerId);
      const supplier = state.suppliers.find(s => s.id === u.supplierId);
      
      await db.collection('adminProposals').add({
        sellerId,
        sellerName: seller?.name || '',
        supplierId: u.supplierId || '',
        supplierName: supplier?.name || u.supplierName || '',
        productName: u.productName || '',
        message: message,
        quantity: u.quantity || '',
        desiredDate: u.desiredDate || '',
        status: 'pending',
        source: 'urgentSales',
        urgentSalesId: urgentId,
        createdAt: new Date().toISOString()
      });
    }
    
    // ê¸´ê¸‰íŒë§¤ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await db.collection('urgentSales').doc(urgentId).update({ 
      status: 'processing',
      proposedAt: new Date().toISOString(),
      proposedSellers: checkedSellers
    });
    
    showToast(`${checkedSellers.length}ëª…ì˜ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì œì•ˆ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ê³µì§€ì‚¬í•­ ê´€ë¦¬ ====================
function renderPartnerNotices() {
  const app = document.getElementById('app');
  
  const notices = state.partnerNotices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">íŒŒíŠ¸ë„ˆì—ê²Œ ì „ë‹¬í•  ê³µì§€ì‚¬í•­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
      <button class="btn btn-primary" onclick="openNoticeModal()">+ ê³µì§€ ì‘ì„±</button>
    </div>
    
    <div class="card">
      ${notices.length === 0 ? `
        <div style="text-align: center; padding: 60px 20px; color: var(--gray-500);">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¢</div>
          <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 80px;">êµ¬ë¶„</th>
              <th>ì œëª©</th>
              <th style="width: 120px;">ì‘ì„±ì¼</th>
              <th style="width: 100px;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${notices.map(n => `
              <tr>
                <td>
                  <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; ${n.important ? 'background: var(--danger-light); color: var(--danger);' : 'background: var(--gray-100); color: var(--gray-600);'}">
                    ${n.important ? 'ì¤‘ìš”' : 'ì¼ë°˜'}
                  </span>
                </td>
                <td style="font-weight: 500;">${n.title}</td>
                <td style="color: var(--gray-500); font-size: 13px;">${formatDateKR(n.createdAt)}</td>
                <td>
                  <div class="actions">
                    <button class="btn btn-ghost btn-sm" onclick="openNoticeModal('${n.id}')">ìˆ˜ì •</button>
                    <button class="btn btn-ghost btn-sm" style="color: var(--danger);" onclick="deleteNotice('${n.id}')">ì‚­ì œ</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
}

// ê³µì§€ì‚¬í•­ ëª¨ë‹¬
function openNoticeModal(noticeId) {
  const notice = noticeId ? state.partnerNotices.find(n => n.id === noticeId) : null;
  const isEdit = !!notice;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'ê³µì§€ ìˆ˜ì •' : 'ìƒˆ ê³µì§€ ì‘ì„±'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="saveNotice(event, '${noticeId || ''}')">
        <div style="padding: 20px;">
          <div class="form-group">
            <label class="form-label">ì œëª© *</label>
            <input type="text" class="form-input" id="notice-title" value="${notice?.title || ''}" placeholder="ê³µì§€ì‚¬í•­ ì œëª©" required>
          </div>
          <div class="form-group">
            <label class="form-label">ë‚´ìš© *</label>
            <textarea class="form-textarea" id="notice-content" rows="8" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required>${notice?.content || ''}</textarea>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="notice-important" ${notice?.important ? 'checked' : ''} style="width: 18px; height: 18px;">
              <span class="form-label" style="margin: 0;">ì¤‘ìš” ê³µì§€ë¡œ í‘œì‹œ</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •' : 'ë“±ë¡'}</button>
        </div>
      </form>
    </div>
  `;
}

// ê³µì§€ì‚¬í•­ ì €ì¥
async function saveNotice(e, noticeId) {
  e.preventDefault();
  
  const data = {
    title: document.getElementById('notice-title').value.trim(),
    content: document.getElementById('notice-content').value.trim(),
    important: document.getElementById('notice-important').checked,
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (noticeId) {
      await db.collection('partnerNotices').doc(noticeId).update(data);
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('partnerNotices').add(data);
    }
    
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³µì§€ì‚¬í•­ ì‚­ì œ
async function deleteNotice(noticeId) {
  if (!confirm('ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('partnerNotices').doc(noticeId).delete();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    console.error(e);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ì…€ëŸ¬ì—ê²Œ ì œì•ˆ ê´€ë¦¬ ====================
function renderSellerProposals() {
  const app = document.getElementById('app');
  
  const proposals = (state.adminProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  const pending = proposals.filter(p => !p.sellerStatus || p.sellerStatus === 'pending');
  const accepted = proposals.filter(p => p.sellerStatus === 'accepted');
  const rejected = proposals.filter(p => p.sellerStatus === 'rejected');
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ“¨ ì…€ëŸ¬ì—ê²Œ ì œì•ˆ</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ê³µêµ¬ ì§„í–‰ì„ ìœ„í•œ ì œì•ˆì„ ì…€ëŸ¬ì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.</p>
      </div>
      <button onclick="openAdminProposalModal()" style="
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        gap: 6px;
      ">
        <span style="font-size: 18px;">+</span> ìƒˆ ì œì•ˆ ë³´ë‚´ê¸°
      </button>
    </div>
    
    <!-- í†µê³„ ì¹´ë“œ -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
      <div class="stat-card">
        <div class="stat-value">${proposals.length}</div>
        <div class="stat-label">ì „ì²´ ì œì•ˆ</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #fff8f0, #fffbf5);">
        <div class="stat-value" style="color: var(--primary);">${pending.length}</div>
        <div class="stat-label">ì‘ë‹µ ëŒ€ê¸°</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f0fdf4, #f7fef9);">
        <div class="stat-value" style="color: #16a34a;">${accepted.length}</div>
        <div class="stat-label">ìˆ˜ë½ë¨</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #fef2f2, #fef7f7);">
        <div class="stat-value" style="color: #dc2626;">${rejected.length}</div>
        <div class="stat-label">ê±°ì ˆë¨</div>
      </div>
    </div>
    
    ${pending.length > 0 ? `
      <div class="card" style="border: 2px solid var(--primary); margin-bottom: 16px; background: linear-gradient(145deg, #fffbf5, #fff8f0);">
        <h3 style="margin-bottom: 16px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 8px; font-size: 14px;">${pending.length}</span>
          ì‘ë‹µ ëŒ€ê¸°ì¤‘
        </h3>
        <div style="display: grid; gap: 12px;">
          ${pending.map(p => renderAdminProposalCard(p)).join('')}
        </div>
      </div>
    ` : ''}
    
    <div class="card">
      <h3 style="margin-bottom: 16px;">ğŸ“ ì „ì²´ ì œì•ˆ ëª©ë¡</h3>
      ${proposals.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
          ì•„ì§ ë³´ë‚¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>
          <button onclick="openAdminProposalModal()" style="
            margin-top: 16px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(145deg, #fc9600, #e08600);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(252,150,0,0.35);
          ">ì²« ì œì•ˆ ë³´ë‚´ê¸°</button>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th>ì œì•ˆì¼</th>
              <th>ì…€ëŸ¬</th>
              <th>ì œì•ˆ ì œëª©</th>
              <th>ë¸Œëœë“œ/ê³µê¸‰ì‚¬</th>
              <th>ìƒíƒœ</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${proposals.map(p => {
              const seller = state.sellers.find(s => s.id === p.targetSellerId);
              const sellerName = seller?.name?.split('/')[0] || p.targetSellerName || 'ì „ì²´ê³µê°œ';
              const statusColor = p.sellerStatus === 'accepted' ? '#16a34a' : p.sellerStatus === 'rejected' ? '#dc2626' : 'var(--primary)';
              const statusText = p.sellerStatus === 'accepted' ? 'ìˆ˜ë½ë¨' : p.sellerStatus === 'rejected' ? 'ê±°ì ˆë¨' : 'ì‘ë‹µëŒ€ê¸°';
              return `
                <tr>
                  <td>${formatDate(p.createdAt)}</td>
                  <td>${sellerName}</td>
                  <td>${p.title}</td>
                  <td>${p.brandName || '-'}</td>
                  <td><span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; background: ${p.sellerStatus === 'accepted' ? 'linear-gradient(145deg, #dcfce7, #bbf7d0)' : p.sellerStatus === 'rejected' ? 'linear-gradient(145deg, #fee2e2, #fecaca)' : 'linear-gradient(145deg, #fff8f0, #ffedd5)'}; color: ${statusColor};">${statusText}</span></td>
                  <td>
                    <div style="display: flex; gap: 6px;">
                      <button onclick="viewAdminProposal('${p.id}')" style="
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                        color: var(--gray-600);
                        border: 1px solid var(--gray-200);
                        border-radius: 6px;
                        cursor: pointer;
                      ">ìƒì„¸</button>
                      <button onclick="deleteAdminProposal('${p.id}')" style="
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        background: linear-gradient(145deg, #fef2f2, #fee2e2);
                        color: #dc2626;
                        border: 1px solid #fecaca;
                        border-radius: 6px;
                        cursor: pointer;
                      ">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
}

function renderAdminProposalCard(p) {
  const seller = state.sellers.find(s => s.id === p.targetSellerId);
  const sellerName = seller?.name?.split('/')[0] || p.targetSellerName || 'ì „ì²´ê³µê°œ';
  const sellerNickname = seller?.name?.split('/')[1] || '';
  
  return `
    <div style="padding: 16px; background: white; border-radius: 12px; border: 1px solid rgba(252,150,0,0.2); box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
        <div>
          <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">${p.title}</div>
          <div style="font-size: 13px; color: var(--gray-500);">${formatDate(p.createdAt)} Â· ëŒ€ìƒ: ${sellerName}${sellerNickname ? ` (${sellerNickname})` : ''}</div>
        </div>
        <span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; background: linear-gradient(145deg, #fff8f0, #ffedd5); color: var(--primary);">ì‘ë‹µëŒ€ê¸°</span>
      </div>
      ${p.content ? `<div style="font-size: 14px; color: var(--gray-600); margin-bottom: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px;">${p.content.substring(0, 100)}${p.content.length > 100 ? '...' : ''}</div>` : ''}
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        ${p.brandName ? `<span style="background: var(--gray-100); padding: 4px 10px; border-radius: 6px; font-size: 12px;">ë¸Œëœë“œ: ${p.brandName}</span>` : ''}
        ${p.expectedPeriod ? `<span style="background: var(--gray-100); padding: 4px 10px; border-radius: 6px; font-size: 12px;">í¬ë§ì¼ì: ${p.expectedPeriod}</span>` : ''}
        ${p.expectedMargin ? `<span style="background: var(--gray-100); padding: 4px 10px; border-radius: 6px; font-size: 12px;">ìˆ˜ìˆ˜ë£Œìœ¨: ${p.expectedMargin}</span>` : ''}
      </div>
    </div>
  `;
}

function openAdminProposalModal(proposalId = null) {
  const isEdit = !!proposalId;
  const p = isEdit ? state.adminProposals.find(pr => pr.id === proposalId) : {};
  
  const sellerOptions = state.sellers.map(s => {
    const name = s.name?.split('/')[0] || s.name;
    const nickname = s.name?.split('/')[1] || '';
    return `<option value="${s.id}" ${p.targetSellerId === s.id ? 'selected' : ''}>${name}${nickname ? ` (${nickname})` : ''}</option>`;
  }).join('');
  
  const modal = document.getElementById('modal');
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“¨ ${isEdit ? 'ì œì•ˆ ìˆ˜ì •' : 'ì…€ëŸ¬ì—ê²Œ ì œì•ˆ ë³´ë‚´ê¸°'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form onsubmit="saveAdminProposal(event, '${proposalId || ''}')">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ëŒ€ìƒ ì…€ëŸ¬ *</label>
            <select class="form-input" id="proposal-seller" required>
              <option value="">ì…€ëŸ¬ ì„ íƒ...</option>
              ${sellerOptions}
            </select>
            <small style="color: var(--gray-500);">ë˜ëŠ” ì „ì²´ ì…€ëŸ¬ì—ê²Œ ê³µê°œí•˜ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”</small>
          </div>
          <div class="form-group">
            <label class="form-label">ì œì•ˆ ì œëª© *</label>
            <input type="text" class="form-input" id="proposal-title" value="${p.title || ''}" placeholder="ì˜ˆ: 12ì›” ì‹ ì œí’ˆ ê³µêµ¬ ì œì•ˆ" required>
          </div>
          <div class="form-group">
            <label class="form-label">ë¸Œëœë“œ/ê³µê¸‰ì‚¬ëª…</label>
            <input type="text" class="form-input" id="proposal-brand" value="${p.brandName || ''}" placeholder="ì˜ˆ: ë¡œì§€ì˜¤ê°€ë‹‰">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">ì˜ˆìƒ ê¸°ê°„</label>
              <input type="text" class="form-input" id="proposal-period" value="${p.expectedPeriod || ''}" placeholder="ì˜ˆ: 12/18~12/20">
            </div>
            <div class="form-group">
              <label class="form-label">ì˜ˆìƒ ë§ˆì§„</label>
              <input type="text" class="form-input" id="proposal-margin" value="${p.expectedMargin || ''}" placeholder="ì˜ˆ: 15%">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ì œì•ˆ ë‚´ìš© *</label>
            <textarea class="form-input" id="proposal-content" rows="5" placeholder="ê³µêµ¬ ì œì•ˆ ìƒì„¸ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..." required>${p.content || ''}</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">ìƒí’ˆ ë§í¬</label>
            <input type="text" class="form-input" id="proposal-link" value="${p.productLink || ''}" placeholder="https://...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn-primary">${isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ì œì•ˆ ë³´ë‚´ê¸°'}</button>
        </div>
      </form>
    </div>
  `;
  modal.classList.add('show');
}

async function saveAdminProposal(e, proposalId = '') {
  e.preventDefault();
  
  const sellerId = document.getElementById('proposal-seller').value;
  const seller = state.sellers.find(s => s.id === sellerId);
  
  const data = {
    targetSellerId: sellerId || null,
    targetSellerName: seller?.name?.split('/')[0] || null,
    title: document.getElementById('proposal-title').value,
    brandName: document.getElementById('proposal-brand').value,
    expectedPeriod: document.getElementById('proposal-period').value,
    expectedMargin: document.getElementById('proposal-margin').value,
    content: document.getElementById('proposal-content').value,
    productLink: document.getElementById('proposal-link').value,
    isPublic: !sellerId, // ì…€ëŸ¬ ë¯¸ì„ íƒì‹œ ì „ì²´ê³µê°œ
    sellerStatus: 'pending',
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (proposalId) {
      await db.collection('adminProposals').doc(proposalId).update(data);
      showToast('ì œì•ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('adminProposals').add(data);
      showToast('ì…€ëŸ¬ì—ê²Œ ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤!');
    }
    closeModal();
    // Firebase onSnapshotì´ ìë™ìœ¼ë¡œ stateë¥¼ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë Œë”ë§
    setTimeout(() => renderSellerProposals(), 500);
  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

async function deleteAdminProposal(proposalId) {
  if (!confirm('ì´ ì œì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('adminProposals').doc(proposalId).delete();
    showToast('ì œì•ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    // Firebase onSnapshotì´ ìë™ìœ¼ë¡œ stateë¥¼ ì—…ë°ì´íŠ¸
    setTimeout(() => renderSellerProposals(), 500);
  } catch (err) {
    console.error(err);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

function viewAdminProposal(proposalId) {
  const p = state.adminProposals.find(pr => pr.id === proposalId);
  if (!p) return;
  
  const seller = state.sellers.find(s => s.id === p.targetSellerId);
  const sellerName = seller?.name?.split('/')[0] || p.targetSellerName || 'ì „ì²´ê³µê°œ';
  const sellerNickname = seller?.name?.split('/')[1] || '';
  
  const statusColor = p.sellerStatus === 'accepted' ? '#16a34a' : p.sellerStatus === 'rejected' ? '#dc2626' : 'var(--primary)';
  const statusText = p.sellerStatus === 'accepted' ? 'ìˆ˜ë½ë¨' : p.sellerStatus === 'rejected' ? 'ê±°ì ˆë¨' : 'ì‘ë‹µëŒ€ê¸°';
  
  const modal = document.getElementById('modal');
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“¨ ì œì•ˆ ìƒì„¸</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="margin-bottom: 8px;">${p.title}</h3>
          <span style="padding: 4px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; background: ${p.sellerStatus === 'accepted' ? '#dcfce7' : p.sellerStatus === 'rejected' ? '#fee2e2' : '#fff8f0'}; color: ${statusColor};">${statusText}</span>
        </div>
        
        <div style="background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div style="display: grid; gap: 10px; font-size: 14px;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--gray-500);">ëŒ€ìƒ ì…€ëŸ¬</span>
              <span style="font-weight: 600;">${sellerName}${sellerNickname ? ` (${sellerNickname})` : ''}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--gray-500);">ì œì•ˆì¼</span>
              <span>${formatDate(p.createdAt)}</span>
            </div>
            ${p.brandName ? `
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ë¸Œëœë“œ/ê³µê¸‰ì‚¬</span>
                <span>${p.brandName}</span>
              </div>
            ` : ''}
            ${p.expectedPeriod ? `
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ì˜ˆìƒ ê¸°ê°„</span>
                <span>${p.expectedPeriod}</span>
              </div>
            ` : ''}
            ${p.expectedMargin ? `
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--gray-500);">ì˜ˆìƒ ë§ˆì§„</span>
                <span>${p.expectedMargin}</span>
              </div>
            ` : ''}
          </div>
        </div>
        
        ${p.content ? `
          <div style="margin-bottom: 16px;">
            <h4 style="margin-bottom: 8px;">ì œì•ˆ ë‚´ìš©</h4>
            <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; white-space: pre-wrap;">${p.content}</div>
          </div>
        ` : ''}
        
        ${p.productLink ? `
          <a href="${p.productLink}" target="_blank" style="display: block; padding: 12px; background: var(--info-light); border-radius: 8px; text-align: center; color: var(--info); font-weight: 500; text-decoration: none;">ğŸ”— ìƒí’ˆ ë§í¬ ë³´ê¸°</a>
        ` : ''}
        
        ${p.respondedAt ? `
          <div style="margin-top: 16px; padding: 12px; background: ${p.sellerStatus === 'accepted' ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px; text-align: center; font-size: 13px; color: ${statusColor};">
            ${formatDate(p.respondedAt)}ì— ${statusText}
          </div>
        ` : ''}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button type="button" class="btn-primary" onclick="openAdminProposalModal('${p.id}')">ìˆ˜ì •</button>
      </div>
    </div>
  `;
  modal.classList.add('show');
}

// ==================== ê³µêµ¬ ì œì•ˆ ê´€ë¦¬ ====================
function renderDealSuggestions() {
  const app = document.getElementById('app');
  
  const suggestions = state.dealSuggestions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  const pending = suggestions.filter(s => s.status === 'pending');
  const renegotiating = suggestions.filter(s => s.status === 'renegotiating');
  const processed = suggestions.filter(s => s.status !== 'pending' && s.status !== 'renegotiating');
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ’¡ ê³µêµ¬ ì œì•ˆ ì ‘ìˆ˜</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬ë“¤ì˜ ê³µêµ¬ ì œì•ˆì„ ê²€í† í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
      <!-- í†µê³„ ìš”ì•½ -->
      <div style="display: flex; gap: 12px;">
        <div style="padding: 12px 20px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 12px; text-align: center; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${pending.length}</div>
          <div style="font-size: 11px; color: var(--gray-500);">ê²€í† ëŒ€ê¸°</div>
        </div>
        <div style="padding: 12px 20px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 12px; text-align: center; border: 1px solid #86efac;">
          <div style="font-size: 24px; font-weight: 700; color: #16a34a;">${processed.filter(s => s.status === 'approved').length}</div>
          <div style="font-size: 11px; color: var(--gray-500);">ìŠ¹ì¸</div>
        </div>
        <div style="padding: 12px 20px; background: linear-gradient(145deg, #fef2f2, #fee2e2); border-radius: 12px; text-align: center; border: 1px solid #fecaca;">
          <div style="font-size: 24px; font-weight: 700; color: #dc2626;">${processed.filter(s => s.status === 'rejected').length}</div>
          <div style="font-size: 11px; color: var(--gray-500);">ë°˜ë ¤</div>
        </div>
      </div>
    </div>
    
    ${pending.length > 0 ? `
      <div class="card" style="border: 2px solid var(--primary); background: linear-gradient(145deg, #fffbf5, #fff8f0);">
        <h3 style="margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 8px; font-size: 14px;">${pending.length}</span>
          ê²€í†  ëŒ€ê¸°ì¤‘ì¸ ì œì•ˆ
        </h3>
        <div style="display: grid; gap: 16px;">
          ${pending.map(s => renderSuggestionCard(s)).join('')}
        </div>
      </div>
    ` : `
      <div class="card" style="text-align: center; padding: 48px; background: linear-gradient(145deg, #f9fafb, #f3f4f6);">
        <div style="font-size: 48px; margin-bottom: 12px;">âœ…</div>
        <p style="color: var(--gray-500);">ê²€í†  ëŒ€ê¸°ì¤‘ì¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    `}
    
    ${renegotiating.length > 0 ? `
      <div class="card" style="border: 2px solid var(--info); margin-top: 20px; background: linear-gradient(145deg, #f0f9ff, #e0f2fe);">
        <h3 style="margin-bottom: 20px; color: var(--info); display: flex; align-items: center; gap: 8px;">
          <span style="background: var(--info); color: white; padding: 4px 10px; border-radius: 8px; font-size: 14px;">${renegotiating.length}</span>
          ì¬í˜‘ì˜ ì§„í–‰ì¤‘
        </h3>
        <div style="display: grid; gap: 16px;">
          ${renegotiating.map(s => renderSuggestionCard(s, true)).join('')}
        </div>
      </div>
    ` : ''}
    
    <div class="card" style="margin-top: 20px;">
      <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">ğŸ“ ì „ì²´ ì œì•ˆ ëª©ë¡</h3>
      ${processed.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          ì²˜ë¦¬ëœ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th>ì…€ëŸ¬</th>
              <th>ì œì•ˆ ì œëª©</th>
              <th>ë¸Œëœë“œ/ìƒí’ˆ</th>
              <th>ìƒíƒœ</th>
              <th>ì œì•ˆì¼</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${processed.map(s => `
              <tr>
                <td>${s.sellerName}</td>
                <td style="font-weight: 500;">${s.title}</td>
                <td>${s.brand || '-'}</td>
                <td>
                  <span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; ${s.status === 'approved' ? 'background: linear-gradient(145deg, #dcfce7, #bbf7d0); color: #16a34a;' : 'background: linear-gradient(145deg, #fee2e2, #fecaca); color: #dc2626;'}">
                    ${s.status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'}
                  </span>
                </td>
                <td style="font-size: 13px; color: var(--gray-500);">${formatDateKR(s.createdAt)}</td>
                <td>
                  <div style="display: flex; gap: 4px;">
                    <button class="btn btn-ghost btn-sm" onclick="openSuggestionDetail('${s.id}')">ìƒì„¸</button>
                    ${s.status === 'rejected' ? `<button class="btn-secondary" style="padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); color: var(--info); border: 1px solid #7dd3fc;" onclick="updateSuggestionStatus('${s.id}', 'renegotiating')">ğŸ”„ ì¬í˜‘ì˜</button>` : ''}
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
}

function renderSuggestionCard(s, isRenegotiating = false) {
  const seller = state.sellers.find(sel => sel.id === s.sellerId);
  const sellerDisplayName = seller?.name?.split('/')[0] || s.sellerName || 'ì•Œ ìˆ˜ ì—†ìŒ';
  
  return `
    <div style="
      padding: 20px;
      background: white;
      border-radius: 14px;
      border: 1px solid ${isRenegotiating ? '#7dd3fc' : 'rgba(252,150,0,0.3)'};
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    ">
      <!-- í—¤ë” -->
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="
              padding: 4px 10px;
              border-radius: 6px;
              font-size: 12px;
              font-weight: 600;
              background: ${isRenegotiating ? 'linear-gradient(145deg, #e0f2fe, #bae6fd)' : 'linear-gradient(145deg, #fff8f0, #ffedd5)'};
              color: ${isRenegotiating ? 'var(--info)' : 'var(--primary)'};
            ">${isRenegotiating ? 'ğŸ”„ ì¬í˜‘ì˜' : 'ğŸ‘¤'} ${sellerDisplayName}</span>
            <span style="font-size: 12px; color: var(--gray-400);">${formatDateKR(s.createdAt)}</span>
          </div>
          <h4 style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 4px;">${s.title}</h4>
          <p style="font-size: 13px; color: var(--gray-500);">${s.brand || ''} ${s.price ? 'Â· ' + s.price : ''}</p>
        </div>
      </div>
      
      <!-- ë‚´ìš© -->
      <div style="
        font-size: 14px;
        color: var(--gray-700);
        margin-bottom: 16px;
        padding: 14px;
        background: var(--gray-50);
        border-radius: 10px;
        line-height: 1.6;
        max-height: 100px;
        overflow: hidden;
      ">${s.content}</div>
      
      ${s.renegotiationNote ? `
        <div style="padding: 12px 14px; background: linear-gradient(145deg, #e0f2fe, #bae6fd); border-radius: 10px; margin-bottom: 16px;">
          <div style="font-size: 12px; color: var(--info); font-weight: 600; margin-bottom: 6px;">ğŸ’¬ ì¬í˜‘ì˜ ë©”ëª¨</div>
          <div style="font-size: 13px; color: var(--gray-700);">${s.renegotiationNote}</div>
        </div>
      ` : ''}
      
      ${s.link ? `
        <a href="${s.link}" target="_blank" style="
          display: inline-flex;
          align-items: center;
          gap: 4px;
          font-size: 13px;
          color: var(--info);
          text-decoration: none;
          margin-bottom: 16px;
        ">ğŸ”— ì°¸ê³  ë§í¬ ë³´ê¸°</a>
      ` : ''}
      
      <!-- ì•¡ì…˜ ë²„íŠ¼ -->
      <div style="display: flex; gap: 10px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
        <button onclick="updateSuggestionStatus('${s.id}', 'approved')" style="
          flex: 1;
          padding: 12px;
          font-size: 14px;
          font-weight: 600;
          background: linear-gradient(145deg, #22c55e, #16a34a);
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(34,197,94,0.3);
        ">âœ“ ìŠ¹ì¸</button>
        <button onclick="updateSuggestionStatus('${s.id}', 'rejected')" style="
          flex: 1;
          padding: 12px;
          font-size: 14px;
          font-weight: 600;
          background: linear-gradient(145deg, #f9fafb, #f3f4f6);
          color: #dc2626;
          border: 1px solid #fecaca;
          border-radius: 10px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        ">âœ• ë°˜ë ¤</button>
        <button onclick="openSuggestionDetail('${s.id}')" style="
          padding: 12px 16px;
          font-size: 14px;
          font-weight: 600;
          background: linear-gradient(145deg, #f9fafb, #f3f4f6);
          color: var(--gray-600);
          border: 1px solid var(--gray-200);
          border-radius: 10px;
          cursor: pointer;
        ">ìƒì„¸</button>
      </div>
    </div>
  `;
}

// ì œì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateSuggestionStatus(suggestionId, status) {
  if (status === 'renegotiating') {
    // ì¬í˜‘ì˜ ëª¨ë‹¬ ì—´ê¸°
    openRenegotiationModal(suggestionId);
    return;
  }
  
  const statusText = status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤';
  if (!confirm(`ì´ ì œì•ˆì„ ${statusText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  try {
    await db.collection('dealSuggestions').doc(suggestionId).update({
      status: status,
      processedAt: new Date().toISOString()
    });
    showToast(`${statusText}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  } catch (e) {
    console.error(e);
    showToast('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì¬í˜‘ì˜ ëª¨ë‹¬
function openRenegotiationModal(suggestionId) {
  const s = state.dealSuggestions.find(item => item.id === suggestionId);
  if (!s) return;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ”„ ì¬í˜‘ì˜ ìš”ì²­</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="padding: 16px; background: var(--gray-50); border-radius: 8px; margin-bottom: 20px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">${s.title}</div>
          <div style="font-size: 13px; color: var(--gray-500);">ì…€ëŸ¬: ${s.sellerName}</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì¬í˜‘ì˜ ì‚¬ìœ /ë©”ëª¨</label>
          <textarea id="renegotiation-note" class="form-textarea" rows="4" placeholder="ì…€ëŸ¬ì—ê²Œ ì „ë‹¬í•  ì¬í˜‘ì˜ ì‚¬ìœ ë‚˜ ìˆ˜ì • ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        
        <div style="display: flex; gap: 12px; padding-top: 16px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="submitRenegotiation('${suggestionId}')">ğŸ”„ ì¬í˜‘ì˜ ìš”ì²­</button>
        </div>
      </div>
    </div>
  `;
}

// ì¬í˜‘ì˜ ì œì¶œ
async function submitRenegotiation(suggestionId) {
  const note = document.getElementById('renegotiation-note').value.trim();
  
  try {
    await db.collection('dealSuggestions').doc(suggestionId).update({
      status: 'renegotiating',
      renegotiationNote: note,
      renegotiationAt: new Date().toISOString()
    });
    closeModal();
    showToast('ì¬í˜‘ì˜ê°€ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    console.error(e);
    showToast('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì œì•ˆ ìƒì„¸ ëª¨ë‹¬
function openSuggestionDetail(suggestionId) {
  const s = state.dealSuggestions.find(item => item.id === suggestionId);
  if (!s) return;
  
  // ìƒíƒœ í‘œì‹œ ë¡œì§
  const getStatusStyle = (status) => {
    switch(status) {
      case 'pending': return 'background: var(--warning-light); color: var(--warning);';
      case 'approved': return 'background: var(--success-light); color: var(--success);';
      case 'renegotiating': return 'background: var(--info-light); color: var(--info);';
      default: return 'background: var(--danger-light); color: var(--danger);';
    }
  };
  const getStatusText = (status) => {
    switch(status) {
      case 'pending': return 'ê²€í† ì¤‘';
      case 'approved': return 'ìŠ¹ì¸';
      case 'renegotiating': return 'ì¬í˜‘ì˜ì¤‘';
      default: return 'ë°˜ë ¤';
    }
  };
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ’¡ ê³µêµ¬ ì œì•ˆ ìƒì„¸</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <span style="padding: 4px 10px; border-radius: 6px; font-size: 13px; background: var(--primary-light); color: var(--primary);">
            ì…€ëŸ¬: ${s.sellerName}
          </span>
          <span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; ${getStatusStyle(s.status)}">
            ${getStatusText(s.status)}
          </span>
        </div>
        
        <h3 style="font-size: 18px; margin-bottom: 8px;">${s.title}</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; padding: 16px; background: var(--gray-50); border-radius: 8px;">
          <div>
            <div style="font-size: 12px; color: var(--gray-500);">ë¸Œëœë“œ/ìƒí’ˆ</div>
            <div style="font-weight: 500;">${s.brand || '-'}</div>
          </div>
          <div>
            <div style="font-size: 12px; color: var(--gray-500);">ì˜ˆìƒ íŒë§¤ê°€</div>
            <div style="font-weight: 500;">${s.price || '-'}</div>
          </div>
          <div>
            <div style="font-size: 12px; color: var(--gray-500);">ì œì•ˆì¼</div>
            <div>${formatDateKR(s.createdAt)}</div>
          </div>
          ${s.link ? `
            <div>
              <div style="font-size: 12px; color: var(--gray-500);">ì°¸ê³  ë§í¬</div>
              <a href="${s.link}" target="_blank" style="color: var(--info);">ë§í¬ ì—´ê¸° â†’</a>
            </div>
          ` : ''}
        </div>
        
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">ì œì•ˆ ë‚´ìš©</div>
          <div style="padding: 16px; background: var(--gray-50); border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">${s.content}</div>
        </div>
        
        ${s.renegotiationNote ? `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; color: var(--info); margin-bottom: 8px;">ğŸ’¬ ì¬í˜‘ì˜ ë©”ëª¨</div>
            <div style="padding: 16px; background: var(--info-light); border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">${s.renegotiationNote}</div>
          </div>
        ` : ''}
        
        ${s.status === 'pending' || s.status === 'renegotiating' ? `
          <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
            <button class="btn btn-primary" style="flex: 1;" onclick="updateSuggestionStatus('${s.id}', 'approved'); closeModal();">âœ“ ìŠ¹ì¸</button>
            <button class="btn btn-secondary" style="flex: 1; color: var(--danger);" onclick="updateSuggestionStatus('${s.id}', 'rejected'); closeModal();">âœ• ë°˜ë ¤</button>
          </div>
        ` : s.status === 'rejected' ? `
          <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
            <button class="btn btn-secondary" style="flex: 1; color: var(--info);" onclick="closeModal(); updateSuggestionStatus('${s.id}', 'renegotiating');">ğŸ”„ ì¬í˜‘ì˜ ìš”ì²­</button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

// ============================================
// ë¬¸ì˜ì ‘ìˆ˜ ê´€ë¦¬
// ============================================

function getInquiries() {
  return JSON.parse(localStorage.getItem('moyeora_inquiries') || '[]');
}

function saveInquiries(inquiries) {
  localStorage.setItem('moyeora_inquiries', JSON.stringify(inquiries));
}

function updateInquiryBadge() {
  const inquiries = getInquiries();
  const newCount = inquiries.filter(i => i.status === 'new').length;
  const badge = document.getElementById('inquiry-badge');
  if (badge) {
    if (newCount > 0) {
      badge.textContent = newCount;
      badge.style.display = 'inline';
    } else {
      badge.style.display = 'none';
    }
  }
}

function updateInquiryStatus(id, status) {
  const inquiries = getInquiries();
  const idx = inquiries.findIndex(i => i.id === id);
  if (idx !== -1) {
    inquiries[idx].status = status;
    if (status === 'contacted') {
      inquiries[idx].contactedAt = new Date().toISOString();
    }
    saveInquiries(inquiries);
    renderInquiries();
    updateInquiryBadge();
  }
}

function deleteInquiry(id) {
  if (!confirm('ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const inquiries = getInquiries().filter(i => i.id !== id);
  saveInquiries(inquiries);
  renderInquiries();
  updateInquiryBadge();
}

function renderInquiries() {
  const app = document.getElementById('app');
  const inquiries = getInquiries().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  const supplierInquiries = inquiries.filter(i => i.type === 'supplier');
  const sellerInquiries = inquiries.filter(i => i.type === 'seller');
  
  const formatDate = (dateStr) => {
    const d = new Date(dateStr);
    return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  };
  
  const getStatusBadge = (status) => {
    switch(status) {
      case 'new': return '<span style="background: #fee2e2; color: #dc2626; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">ì‹ ê·œ</span>';
      case 'contacted': return '<span style="background: #d1fae5; color: #059669; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">ì—°ë½ì™„ë£Œ</span>';
      case 'pending': return '<span style="background: #fef3c7; color: #d97706; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">ëŒ€ê¸°ì¤‘</span>';
      default: return '<span style="background: #f3f4f6; color: #6b7280; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">ê¸°íƒ€</span>';
    }
  };
  
  const renderTable = (items, type) => {
    if (items.length === 0) {
      return '<div style="text-align: center; padding: 48px; color: var(--gray-500);">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    }
    
    return `
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: var(--gray-50); border-bottom: 1px solid var(--gray-200);">
            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600);">ìƒíƒœ</th>
            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600);">${type === 'supplier' ? 'ê³µê¸‰ì‚¬ëª…' : 'ì„±í•¨'}</th>
            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600);">ì—°ë½ì²˜</th>
            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600);">ì ‘ìˆ˜ì¼ì‹œ</th>
            <th style="padding: 12px 16px; text-align: center; font-size: 13px; font-weight: 600; color: var(--gray-600);">ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(item => `
            <tr style="border-bottom: 1px solid var(--gray-100);">
              <td style="padding: 14px 16px;">${getStatusBadge(item.status)}</td>
              <td style="padding: 14px 16px; font-weight: 500;">${item.name}</td>
              <td style="padding: 14px 16px;">
                <a href="tel:${item.contact.replace(/-/g, '')}" style="color: var(--info); text-decoration: none; font-weight: 500;">${item.contact}</a>
              </td>
              <td style="padding: 14px 16px; font-size: 13px; color: var(--gray-600);">${formatDate(item.createdAt)}</td>
              <td style="padding: 14px 16px; text-align: center;">
                <div style="display: flex; gap: 8px; justify-content: center;">
                  ${item.status === 'new' ? `
                    <button onclick="updateInquiryStatus(${item.id}, 'contacted')" style="padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ì—°ë½ì™„ë£Œ</button>
                    <button onclick="updateInquiryStatus(${item.id}, 'pending')" style="padding: 6px 12px; background: var(--warning); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ëŒ€ê¸°</button>
                  ` : item.status === 'pending' ? `
                    <button onclick="updateInquiryStatus(${item.id}, 'contacted')" style="padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ì—°ë½ì™„ë£Œ</button>
                  ` : ''}
                  <button onclick="deleteInquiry(${item.id})" style="padding: 6px 12px; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ì‚­ì œ</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  };
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ“© ë¬¸ì˜ì ‘ìˆ˜</h1>
      <p style="color: var(--gray-600); font-size: 14px; margin-top: 4px;">
        ëœë”©í˜ì´ì§€ì—ì„œ ì ‘ìˆ˜ëœ ë¬¸ì˜ ë‚´ì—­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤
      </p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;">
      <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 4px;">ì „ì²´ ë¬¸ì˜</div>
        <div style="font-size: 28px; font-weight: 700; color: var(--gray-900);">${inquiries.length}</div>
      </div>
      <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 4px;">ì‹ ê·œ ë¬¸ì˜</div>
        <div style="font-size: 28px; font-weight: 700; color: var(--danger);">${inquiries.filter(i => i.status === 'new').length}</div>
      </div>
      <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 4px;">ì—°ë½ì™„ë£Œ</div>
        <div style="font-size: 28px; font-weight: 700; color: var(--success);">${inquiries.filter(i => i.status === 'contacted').length}</div>
      </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 24px;">
      <!-- ê³µê¸‰ì‚¬ ë¬¸ì˜ -->
      <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="padding: 20px; border-bottom: 1px solid var(--gray-100); display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 18px;">ğŸ¢</span>
          <h2 style="font-size: 16px; font-weight: 700;">ê³µê¸‰ì‚¬ ë¬¸ì˜</h2>
          <span style="background: var(--gray-100); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; color: var(--gray-600);">${supplierInquiries.length}</span>
        </div>
        ${renderTable(supplierInquiries, 'supplier')}
      </div>
      
      <!-- ì…€ëŸ¬ ë¬¸ì˜ -->
      <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <div style="padding: 20px; border-bottom: 1px solid var(--gray-100); display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 18px;">ğŸ‘¤</span>
          <h2 style="font-size: 16px; font-weight: 700;">ì…€ëŸ¬ ë¬¸ì˜</h2>
          <span style="background: var(--gray-100); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; color: var(--gray-600);">${sellerInquiries.length}</span>
        </div>
        ${renderTable(sellerInquiries, 'seller')}
      </div>
    </div>
  `;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°°ì§€ ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(updateInquiryBadge, 500);
});

// ==================== í†µí•© ê³µêµ¬ ì œì•ˆ ê´€ë¦¬ ====================
function renderProposalManagement() {
  const app = document.getElementById('app');
  
  // ì…€ëŸ¬ê°€ ë³´ë‚¸ ì œì•ˆ (dealSuggestions)
  const sellerSuggestions = (state.dealSuggestions || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const pendingSuggestions = sellerSuggestions.filter(s => s.status === 'pending');
  
  // ì–´ë“œë¯¼ì´ ë³´ë‚¸ ì œì•ˆ (adminProposals)
  const adminProposals = (state.adminProposals || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const pendingProposals = adminProposals.filter(p => !p.sellerStatus || p.sellerStatus === 'pending');
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ“‹ ê³µêµ¬ ì œì•ˆ ê´€ë¦¬</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ì…€ëŸ¬ ì œì•ˆ ê²€í†  ë° ì…€ëŸ¬ì—ê²Œ ì œì•ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
      <button onclick="openAdminProposalModal()" style="
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        gap: 6px;
      ">
        <span style="font-size: 18px;">+</span> ì…€ëŸ¬ì—ê²Œ ì œì•ˆ
      </button>
    </div>
    
    <!-- íƒ­ -->
    <div style="display: flex; gap: 4px; margin-bottom: 24px; background: var(--gray-100); padding: 4px; border-radius: 12px;">
      <button id="proposalTab-received" onclick="switchProposalTab('received')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600); color: white; cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.3);
      ">
        ğŸ“¥ ë°›ì€ ì œì•ˆ <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 8px; margin-left: 4px;">${sellerSuggestions.length}</span>
        ${pendingSuggestions.length > 0 ? `<span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ê²€í†  ${pendingSuggestions.length}</span>` : ''}
      </button>
      <button id="proposalTab-sent" onclick="switchProposalTab('sent')" style="
        flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
        background: transparent; color: var(--gray-500); cursor: pointer;
      ">
        ğŸ“¤ ë³´ë‚¸ ì œì•ˆ <span style="opacity: 0.7;">${adminProposals.length}</span>
        ${pendingProposals.length > 0 ? `<span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; margin-left: 4px;">ëŒ€ê¸° ${pendingProposals.length}</span>` : ''}
      </button>
    </div>
    
    <!-- ë°›ì€ ì œì•ˆ (ì…€ëŸ¬ â†’ ì–´ë“œë¯¼) -->
    <div id="proposalContent-received">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div style="padding: 16px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 12px; text-align: center; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${pendingSuggestions.length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ê²€í†  ëŒ€ê¸°</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 12px; text-align: center; border: 1px solid #86efac;">
          <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${sellerSuggestions.filter(s => s.status === 'approved').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ìŠ¹ì¸</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #fef2f2, #fee2e2); border-radius: 12px; text-align: center; border: 1px solid #fecaca;">
          <div style="font-size: 28px; font-weight: 700; color: #dc2626;">${sellerSuggestions.filter(s => s.status === 'rejected').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ë°˜ë ¤</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); border-radius: 12px; text-align: center; border: 1px solid #7dd3fc;">
          <div style="font-size: 28px; font-weight: 700; color: var(--info);">${sellerSuggestions.filter(s => s.status === 'renegotiating').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ì¬í˜‘ì˜</div>
        </div>
      </div>
      
      <div class="card">
        <h3 style="margin-bottom: 16px;">ì…€ëŸ¬ë“¤ì´ ë³´ë‚¸ ì œì•ˆ</h3>
        ${sellerSuggestions.length === 0 ? `
          <div style="text-align: center; padding: 48px; color: var(--gray-500);">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
            <p>ì•„ì§ ë°›ì€ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        ` : `
          <table class="data-table">
            <thead>
              <tr>
                <th>ì…€ëŸ¬</th>
                <th>ì œì•ˆ ì œëª©</th>
                <th>ë¸Œëœë“œ/ìƒí’ˆ</th>
                <th>ìƒíƒœ</th>
                <th>ì œì•ˆì¼</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${sellerSuggestions.map(s => {
                const seller = state.sellers.find(sel => sel.id === s.sellerId);
                const sellerName = seller?.name?.split('/')[0] || s.sellerName || '-';
                const statusStyle = s.status === 'approved' ? 'background: linear-gradient(145deg, #dcfce7, #bbf7d0); color: #16a34a;' :
                                   s.status === 'rejected' ? 'background: linear-gradient(145deg, #fee2e2, #fecaca); color: #dc2626;' :
                                   s.status === 'renegotiating' ? 'background: linear-gradient(145deg, #e0f2fe, #bae6fd); color: var(--info);' :
                                   'background: linear-gradient(145deg, #fff8f0, #ffedd5); color: var(--primary);';
                const statusText = s.status === 'approved' ? 'ìŠ¹ì¸' : s.status === 'rejected' ? 'ë°˜ë ¤' : s.status === 'renegotiating' ? 'ì¬í˜‘ì˜' : 'ê²€í† ëŒ€ê¸°';
                return `
                  <tr>
                    <td style="font-weight: 500;">${sellerName}</td>
                    <td>${s.title}</td>
                    <td>${s.brand || '-'}</td>
                    <td><span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; ${statusStyle}">${statusText}</span></td>
                    <td style="font-size: 13px; color: var(--gray-500);">${formatDateKR(s.createdAt)}</td>
                    <td>
                      <button onclick="openSuggestionDetailModal('${s.id}')" style="
                        padding: 6px 14px;
                        font-size: 12px;
                        font-weight: 600;
                        background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                        color: var(--gray-600);
                        border: 1px solid var(--gray-200);
                        border-radius: 8px;
                        cursor: pointer;
                      ">ìƒì„¸</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `}
      </div>
    </div>
    
    <!-- ë³´ë‚¸ ì œì•ˆ (ì–´ë“œë¯¼ â†’ ì…€ëŸ¬) -->
    <div id="proposalContent-sent" style="display: none;">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div style="padding: 16px; background: var(--gray-50); border-radius: 12px; text-align: center;">
          <div style="font-size: 28px; font-weight: 700;">${adminProposals.length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ì „ì²´</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 12px; text-align: center; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${pendingProposals.length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ì‘ë‹µ ëŒ€ê¸°</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 12px; text-align: center; border: 1px solid #86efac;">
          <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${adminProposals.filter(p => p.sellerStatus === 'accepted').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ìˆ˜ë½ë¨</div>
        </div>
        <div style="padding: 16px; background: linear-gradient(145deg, #fef2f2, #fee2e2); border-radius: 12px; text-align: center; border: 1px solid #fecaca;">
          <div style="font-size: 28px; font-weight: 700; color: #dc2626;">${adminProposals.filter(p => p.sellerStatus === 'rejected').length}</div>
          <div style="font-size: 12px; color: var(--gray-500);">ê±°ì ˆë¨</div>
        </div>
      </div>
      
      <div class="card">
        <h3 style="margin-bottom: 16px;">ì…€ëŸ¬ì—ê²Œ ë³´ë‚¸ ì œì•ˆ</h3>
        ${adminProposals.length === 0 ? `
          <div style="text-align: center; padding: 48px; color: var(--gray-500);">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
            <p>ì•„ì§ ë³´ë‚¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <button onclick="openAdminProposalModal()" style="
              margin-top: 16px;
              padding: 12px 24px;
              font-size: 14px;
              font-weight: 600;
              background: linear-gradient(145deg, #fc9600, #e08600);
              color: white;
              border: none;
              border-radius: 12px;
              cursor: pointer;
            ">ì²« ì œì•ˆ ë³´ë‚´ê¸°</button>
          </div>
        ` : `
          <table class="data-table">
            <thead>
              <tr>
                <th>ì œì•ˆì¼</th>
                <th>ëŒ€ìƒ ì…€ëŸ¬</th>
                <th>ì œì•ˆ ì œëª©</th>
                <th>ë¸Œëœë“œ</th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${adminProposals.map(p => {
                const seller = state.sellers.find(s => s.id === p.targetSellerId);
                const sellerName = seller?.name?.split('/')[0] || p.targetSellerName || 'ì „ì²´ê³µê°œ';
                const statusStyle = p.sellerStatus === 'accepted' ? 'background: linear-gradient(145deg, #dcfce7, #bbf7d0); color: #16a34a;' :
                                   p.sellerStatus === 'rejected' ? 'background: linear-gradient(145deg, #fee2e2, #fecaca); color: #dc2626;' :
                                   'background: linear-gradient(145deg, #fff8f0, #ffedd5); color: var(--primary);';
                const statusText = p.sellerStatus === 'accepted' ? 'ìˆ˜ë½ë¨' : p.sellerStatus === 'rejected' ? 'ê±°ì ˆë¨' : 'ì‘ë‹µëŒ€ê¸°';
                return `
                  <tr>
                    <td style="font-size: 13px; color: var(--gray-500);">${formatDate(p.createdAt)}</td>
                    <td style="font-weight: 500;">${sellerName}</td>
                    <td>${p.title}</td>
                    <td>${p.brandName || '-'}</td>
                    <td><span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; ${statusStyle}">${statusText}</span></td>
                    <td>
                      <div style="display: flex; gap: 6px;">
                        <button onclick="viewAdminProposal('${p.id}')" style="
                          padding: 6px 12px;
                          font-size: 12px;
                          font-weight: 500;
                          background: linear-gradient(145deg, #f9fafb, #f3f4f6);
                          color: var(--gray-600);
                          border: 1px solid var(--gray-200);
                          border-radius: 6px;
                          cursor: pointer;
                        ">ìƒì„¸</button>
                        <button onclick="deleteAdminProposal('${p.id}')" style="
                          padding: 6px 12px;
                          font-size: 12px;
                          font-weight: 500;
                          background: linear-gradient(145deg, #fef2f2, #fee2e2);
                          color: #dc2626;
                          border: 1px solid #fecaca;
                          border-radius: 6px;
                          cursor: pointer;
                        ">ì‚­ì œ</button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `}
      </div>
    </div>
  `;
}

// ì œì•ˆ íƒ­ ì „í™˜
function switchProposalTab(tab) {
  const receivedTab = document.getElementById('proposalTab-received');
  const sentTab = document.getElementById('proposalTab-sent');
  
  if (tab === 'received') {
    receivedTab.style.background = 'linear-gradient(145deg, #fc9600, #e08600)';
    receivedTab.style.color = 'white';
    receivedTab.style.boxShadow = '0 4px 12px rgba(252,150,0,0.3)';
    sentTab.style.background = 'transparent';
    sentTab.style.color = 'var(--gray-500)';
    sentTab.style.boxShadow = 'none';
  } else {
    sentTab.style.background = 'linear-gradient(145deg, #fc9600, #e08600)';
    sentTab.style.color = 'white';
    sentTab.style.boxShadow = '0 4px 12px rgba(252,150,0,0.3)';
    receivedTab.style.background = 'transparent';
    receivedTab.style.color = 'var(--gray-500)';
    receivedTab.style.boxShadow = 'none';
  }
  
  document.getElementById('proposalContent-received').style.display = tab === 'received' ? 'block' : 'none';
  document.getElementById('proposalContent-sent').style.display = tab === 'sent' ? 'block' : 'none';
}

// ì œì•ˆ ìƒì„¸ ëª¨ë‹¬ (ìŠ¹ì¸/ë°˜ë ¤)
function openSuggestionDetailModal(suggestionId) {
  const s = state.dealSuggestions.find(item => item.id === suggestionId);
  if (!s) return;
  
  const seller = state.sellers.find(sel => sel.id === s.sellerId);
  const sellerName = seller?.name?.split('/')[0] || s.sellerName || '-';
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ ì œì•ˆ ìƒì„¸</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="padding: 24px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">${s.title}</h3>
          <span style="padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; ${
            s.status === 'approved' ? 'background: #dcfce7; color: #16a34a;' :
            s.status === 'rejected' ? 'background: #fee2e2; color: #dc2626;' :
            s.status === 'renegotiating' ? 'background: #e0f2fe; color: var(--info);' :
            'background: #fff8f0; color: var(--primary);'
          }">
            ${s.status === 'approved' ? 'ìŠ¹ì¸ë¨' : s.status === 'rejected' ? 'ë°˜ë ¤ë¨' : s.status === 'renegotiating' ? 'ì¬í˜‘ì˜ì¤‘' : 'ê²€í† ëŒ€ê¸°'}
          </span>
        </div>
        
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì œì•ˆ ì…€ëŸ¬</div>
              <div style="font-weight: 600;">${sellerName}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì œì•ˆì¼</div>
              <div style="font-weight: 600;">${formatDate(s.createdAt)}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ë¸Œëœë“œ/ìƒí’ˆ</div>
              <div style="font-weight: 600;">${s.brand || '-'}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">í¬ë§ ê°€ê²©</div>
              <div style="font-weight: 600;">${s.price || '-'}</div>
            </div>
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ì œì•ˆ ë‚´ìš©</div>
          <div style="padding: 16px; background: white; border: 1px solid var(--gray-200); border-radius: 10px; line-height: 1.6; white-space: pre-wrap;">${s.content || 'ë‚´ìš© ì—†ìŒ'}</div>
        </div>
        
        ${s.link ? `
          <a href="${s.link}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; background: var(--info-light); color: var(--info); border-radius: 8px; text-decoration: none; font-size: 14px; margin-bottom: 20px;">
            ğŸ”— ì°¸ê³  ë§í¬ ë³´ê¸°
          </a>
        ` : ''}
        
        ${s.renegotiationNote ? `
          <div style="padding: 16px; background: #e0f2fe; border-radius: 10px; margin-bottom: 20px;">
            <div style="font-size: 12px; color: var(--info); font-weight: 600; margin-bottom: 6px;">ğŸ’¬ ì¬í˜‘ì˜ ë©”ëª¨</div>
            <div style="font-size: 14px; color: var(--gray-700);">${s.renegotiationNote}</div>
          </div>
        ` : ''}
        
        ${s.status === 'pending' || s.status === 'renegotiating' ? `
          <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
            <button onclick="updateSuggestionStatus('${s.id}', 'approved')" style="
              flex: 1;
              padding: 14px;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(145deg, #22c55e, #16a34a);
              color: white;
              border: none;
              border-radius: 12px;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(34,197,94,0.3);
            ">âœ“ ìŠ¹ì¸í•˜ê¸°</button>
            <button onclick="updateSuggestionStatus('${s.id}', 'rejected')" style="
              flex: 1;
              padding: 14px;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(145deg, #f9fafb, #f3f4f6);
              color: #dc2626;
              border: 1px solid #fecaca;
              border-radius: 12px;
              cursor: pointer;
            ">âœ• ë°˜ë ¤í•˜ê¸°</button>
            <button onclick="openRenegotiationModal('${s.id}')" style="
              padding: 14px 20px;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(145deg, #f0f9ff, #e0f2fe);
              color: var(--info);
              border: 1px solid #7dd3fc;
              border-radius: 12px;
              cursor: pointer;
            ">ğŸ”„ ì¬í˜‘ì˜</button>
          </div>
        ` : `
          <div style="display: flex; gap: 12px; justify-content: center; padding-top: 20px; border-top: 1px solid var(--gray-200);">
            <button onclick="closeModal()" style="
              padding: 14px 40px;
              font-size: 15px;
              font-weight: 600;
              background: linear-gradient(145deg, #f9fafb, #f3f4f6);
              color: var(--gray-600);
              border: 1px solid var(--gray-200);
              border-radius: 12px;
              cursor: pointer;
            ">ë‹«ê¸°</button>
          </div>
        `}
      </div>
    </div>
  `;
}

// ==================== íŒ€ì› ê´€ë¦¬ ====================
function renderTeamMembers() {
  const app = document.getElementById('app');
  const members = state.teamMembers || [];
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="page-title">ğŸ‘¥ íŒ€ì› ê´€ë¦¬</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">ëª¨ì—¬ë¼ë”œ íŒ€ì› ê³„ì •ì„ ê´€ë¦¬í•˜ê³  ë‹´ë‹¹ìë¥¼ ë°°ì •í•©ë‹ˆë‹¤.</p>
      </div>
      <button onclick="openTeamMemberModal()" style="
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(145deg, #fc9600, #e08600);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(252,150,0,0.35);
      ">
        + íŒ€ì› ì¶”ê°€
      </button>
    </div>
    
    <!-- í†µê³„ -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
      <div style="padding: 20px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 14px; text-align: center; border: 1px solid rgba(252,150,0,0.2);">
        <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${members.length}</div>
        <div style="font-size: 13px; color: var(--gray-500);">ì „ì²´ íŒ€ì›</div>
      </div>
      <div style="padding: 20px; background: var(--gray-50); border-radius: 14px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--gray-700);">${members.filter(m => m.role === 'admin').length}</div>
        <div style="font-size: 13px; color: var(--gray-500);">ê´€ë¦¬ì</div>
      </div>
      <div style="padding: 20px; background: var(--gray-50); border-radius: 14px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--gray-700);">${members.filter(m => m.role === 'manager').length}</div>
        <div style="font-size: 13px; color: var(--gray-500);">ë§¤ë‹ˆì €</div>
      </div>
      <div style="padding: 20px; background: var(--gray-50); border-radius: 14px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--gray-700);">${members.filter(m => m.role === 'staff').length}</div>
        <div style="font-size: 13px; color: var(--gray-500);">ì¼ë°˜</div>
      </div>
    </div>
    
    <div class="card">
      ${members.length === 0 ? `
        <div style="text-align: center; padding: 60px 20px; color: var(--gray-500);">
          <div style="font-size: 56px; margin-bottom: 16px;">ğŸ‘¥</div>
          <p style="font-size: 15px; margin-bottom: 20px;">ì•„ì§ ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          <button onclick="openTeamMemberModal()" style="
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(145deg, #fc9600, #e08600);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
          ">ì²« íŒ€ì› ë“±ë¡í•˜ê¸°</button>
        </div>
      ` : `
        <table class="data-table">
          <thead>
            <tr>
              <th>ì´ë¦„</th>
              <th>ì•„ì´ë””</th>
              <th>ì—­í• </th>
              <th>ë“±ë¡ì¼</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${members.map(m => {
              const roleStyle = m.role === 'admin' ? 'background: linear-gradient(145deg, #fef2f2, #fee2e2); color: #dc2626;' :
                               m.role === 'manager' ? 'background: linear-gradient(145deg, #fff8f0, #ffedd5); color: var(--primary);' :
                               'background: var(--gray-100); color: var(--gray-600);';
              const roleText = m.role === 'admin' ? 'ê´€ë¦¬ì' : m.role === 'manager' ? 'ë§¤ë‹ˆì €' : 'ì¼ë°˜';
              return `
                <tr>
                  <td style="font-weight: 600;">${m.name}</td>
                  <td><code style="background: var(--gray-100); padding: 2px 8px; border-radius: 4px; font-size: 12px;">${m.loginId || '-'}</code></td>
                  <td><span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; ${roleStyle}">${roleText}</span></td>
                  <td style="font-size: 13px; color: var(--gray-500);">${formatDate(m.createdAt)}</td>
                  <td>
                    <div style="display: flex; gap: 6px;">
                      <button onclick="openTeamMemberModal('${m.id}')" style="
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        background: var(--gray-100);
                        color: var(--gray-600);
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                      ">ìˆ˜ì •</button>
                      <button onclick="deleteTeamMember('${m.id}')" style="
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        background: #fee2e2;
                        color: #dc2626;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                      ">ì‚­ì œ</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
}

// íŒ€ì› ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬
function openTeamMemberModal(memberId = null) {
  const member = memberId ? state.teamMembers.find(m => m.id === memberId) : null;
  const isEdit = !!member;
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">${isEdit ? 'âœï¸ íŒ€ì› ìˆ˜ì •' : 'â• íŒ€ì› ë“±ë¡'}</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form id="teamMemberForm" onsubmit="saveTeamMember(event, '${memberId || ''}')">
        <div style="padding: 24px;">
          <div class="form-group">
            <label class="form-label">ì´ë¦„ *</label>
            <input type="text" class="form-input" id="memberName" value="${member?.name || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">ì´ë©”ì¼</label>
            <input type="email" class="form-input" id="memberEmail" value="${member?.email || ''}" placeholder="example@moyeoradeal.com">
          </div>
          
          <!-- ë¡œê·¸ì¸ ì •ë³´ -->
          <div style="padding: 16px; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); border-radius: 12px; margin-bottom: 16px;">
            <div style="font-size: 13px; font-weight: 600; color: var(--info); margin-bottom: 12px;">ğŸ” ë¡œê·¸ì¸ ì •ë³´</div>
            <div class="form-group" style="margin-bottom: 12px;">
              <label class="form-label">ì•„ì´ë”” *</label>
              <input type="text" class="form-input" id="memberLoginId" value="${member?.loginId || ''}" placeholder="ì˜ë¬¸/ìˆ«ì ì¡°í•©" required>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">ë¹„ë°€ë²ˆí˜¸ *</label>
              <input type="text" class="form-input" id="memberLoginPw" value="${member?.loginPw || ''}" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
              <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">â€» íŒ€ì› í™œë™ ì¶”ì ìš© ê³„ì •ì…ë‹ˆë‹¤</div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì—­í•  *</label>
            <select class="form-select" id="memberRole" required>
              <option value="staff" ${!member?.role || member?.role === 'staff' ? 'selected' : ''}>ì¼ë°˜</option>
              <option value="manager" ${member?.role === 'manager' ? 'selected' : ''}>ë§¤ë‹ˆì €</option>
              <option value="admin" ${member?.role === 'admin' ? 'selected' : ''}>ê´€ë¦¬ì</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <textarea class="form-textarea" id="memberNote" rows="2" placeholder="ë‹´ë‹¹ ì—…ë¬´ ë“±">${member?.note || ''}</textarea>
          </div>
        </div>
        <div style="padding: 16px 24px; background: var(--gray-50); display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">${isEdit ? 'ìˆ˜ì •' : 'ë“±ë¡'}</button>
        </div>
      </form>
    </div>
  `;
}

// íŒ€ì› ì €ì¥
async function saveTeamMember(e, memberId) {
  e.preventDefault();
  
  const loginId = document.getElementById('memberLoginId').value.trim();
  
  // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬
  const existingMember = state.teamMembers.find(m => m.loginId === loginId && m.id !== memberId);
  if (existingMember) {
    showToast('ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.');
    return;
  }
  
  const data = {
    name: document.getElementById('memberName').value.trim(),
    email: document.getElementById('memberEmail').value.trim(),
    loginId: loginId,
    loginPw: document.getElementById('memberLoginPw').value.trim(),
    role: document.getElementById('memberRole').value,
    note: document.getElementById('memberNote').value.trim(),
    updatedAt: new Date().toISOString()
  };
  
  try {
    if (memberId) {
      await db.collection('teamMembers').doc(memberId).update(data);
      showToast('íŒ€ì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      data.createdAt = new Date().toISOString();
      await db.collection('teamMembers').add(data);
      showToast('íŒ€ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    closeModal();
  } catch (err) {
    console.error(err);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// íŒ€ì› ì‚­ì œ
async function deleteTeamMember(memberId) {
  if (!confirm('ì´ íŒ€ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.collection('teamMembers').doc(memberId).delete();
    showToast('íŒ€ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (err) {
    console.error(err);
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ì˜ì—… í˜„í™© ëŒ€ì‹œë³´ë“œ ====================
function renderSalesDashboard() {
  const app = document.getElementById('app');
  const members = state.teamMembers || [];
  const currentUser = state.currentUser || {};
  const isAdmin = currentUser.role === 'admin';
  
  // ëª©í‘œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const goals = state.salesGoals || {};
  
  // ë¯¸ë°°ì • ë°ì´í„° ì§‘ê³„
  const unassignedSuppliers = state.suppliers.filter(s => !s.registeredBy);
  const unassignedSellers = state.sellers.filter(s => !s.registeredBy);
  const unassignedDeals = state.deals.filter(d => !d.registeredBy);
  
  // ì´ë²ˆë‹¬/ì „ì›” ê¸°ì¤€
  const now = new Date();
  const thisMonth = now.toISOString().slice(0, 7);
  const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const lastMonth = lastMonthDate.toISOString().slice(0, 7);
  
  // ì •ì‚° ë°ì´í„°
  const allSettlements = state.sellerSettlements || [];
  
  // íŒ€ì›ë³„ ì‹¤ì  ê³„ì‚° (íŒë§¤ê±´ìˆ˜, ë§¤ì¶œ, ìˆœìˆ˜ìµ í¬í•¨)
  const memberStats = members.map(member => {
    // ë‹´ë‹¹ìë¡œ ë“±ë¡ëœ í•­ëª©
    const suppliers = state.suppliers.filter(s => s.registeredBy === member.id);
    const sellers = state.sellers.filter(s => s.registeredBy === member.id);
    const deals = state.deals.filter(d => d.registeredBy === member.id);
    
    // ì´ë²ˆ ë‹¬ / ì „ì›” ì…ì 
    const monthlySuppliers = suppliers.filter(s => s.createdAt?.startsWith(thisMonth));
    const monthlySellers = sellers.filter(s => s.createdAt?.startsWith(thisMonth));
    const monthlyDeals = deals.filter(d => d.createdAt?.startsWith(thisMonth));
    
    const lastMonthSuppliers = suppliers.filter(s => s.createdAt?.startsWith(lastMonth));
    const lastMonthSellers = sellers.filter(s => s.createdAt?.startsWith(lastMonth));
    const lastMonthDeals = deals.filter(d => d.createdAt?.startsWith(lastMonth));
    
    // ë‹´ë‹¹ ì…€ëŸ¬ ì´ë¦„ ëª©ë¡
    const sellerNames = sellers.map(s => s.name).filter(Boolean);
    
    // ì •ì‚° ë°ì´í„° ì—°ë™ (ë‹´ë‹¹ ì…€ëŸ¬ë“¤ì˜ ì •ì‚° ë°ì´í„°)
    const memberSettlements = allSettlements.filter(s => {
      // 1. registeredByë¡œ ì§ì ‘ ì—°ê²°
      if (s.registeredBy === member.id) return true;
      // 2. ë‹´ë‹¹ ì…€ëŸ¬ ì´ë¦„ìœ¼ë¡œ ì—°ê²°
      const settlementSellerName = s.sellerName || '';
      return sellerNames.some(name => {
        if (!name) return false;
        const namePart = name.split('/')[0];
        return settlementSellerName.includes(namePart) || settlementSellerName.includes(name);
      });
    });
    
    // ì´ë²ˆë‹¬/ì „ì›” ì •ì‚°
    const thisMonthSettlements = memberSettlements.filter(s => {
      const dateStr = s.settlementDate || s.createdAt || '';
      return dateStr.startsWith(thisMonth) || dateStr.includes(thisMonth.replace('-', '.'));
    });
    const lastMonthSettlements = memberSettlements.filter(s => {
      const dateStr = s.settlementDate || s.createdAt || '';
      return dateStr.startsWith(lastMonth) || dateStr.includes(lastMonth.replace('-', '.'));
    });
    
    // ë§¤ì¶œ ì§‘ê³„
    const totalSales = memberSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
    const totalProfit = memberSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
    
    const thisMonthSales = thisMonthSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
    const thisMonthProfit = thisMonthSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
    
    return {
      ...member,
      totalSuppliers: suppliers.length,
      totalSellers: sellers.length,
      totalDeals: deals.length,
      monthlySuppliers: monthlySuppliers.length,
      monthlySellers: monthlySellers.length,
      monthlyDeals: monthlyDeals.length,
      lastMonthSuppliers: lastMonthSuppliers.length,
      lastMonthSellers: lastMonthSellers.length,
      lastMonthDeals: lastMonthDeals.length,
      salesCount: memberSettlements.length,
      thisMonthSalesCount: thisMonthSettlements.length,
      totalSales,
      totalProfit,
      thisMonthSales,
      thisMonthProfit
    };
  });
  
  // ì „ì²´ í†µê³„
  const totalSupplierCount = state.suppliers.length;
  const totalSellerCount = state.sellers.length;
  const totalDealCount = state.deals.length;
  const totalSalesCount = allSettlements.length;
  const totalSalesAmount = allSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
  const totalProfitAmount = allSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);
  
  // ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚°
  const calcRate = (current, goal) => goal > 0 ? Math.min(Math.round((current / goal) * 100), 100) : 0;
  
  app.innerHTML = `
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
      <div>
        <h1 class="page-title">ì˜ì—…í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">íŒ€ì›ë³„ ì…ì , ë§¤ì¶œ, ìˆœìˆ˜ìµ ì„±ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
      </div>
      ${isAdmin ? `
        <div style="display: flex; gap: 8px;">
          <button onclick="openGoalCalculator()" style="
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            background: white;
            color: #1e40af;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            cursor: pointer;
          ">ğŸ“Š ê³„ì‚°ê¸°</button>
          <button onclick="openGoalSettingModal()" style="
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            background: linear-gradient(145deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
          ">ğŸ¯ ëª©í‘œ ì„¤ì •</button>
        </div>
      ` : ''}
    </div>
    
    <!-- íŒ€ ëª©í‘œ í˜„í™© (ëª©í‘œ ì„¤ì • ì‹œì—ë§Œ í‘œì‹œ) -->
    ${(goals.suppliers || goals.sellers || goals.deals || goals.salesAmount || goals.profitAmount) ? `
      <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <div style="font-size: 18px; font-weight: 700;">ğŸ¯ íŒ€ ëª©í‘œ í˜„í™©</div>
            <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">ì „ì²´ íŒ€ì˜ ëª©í‘œ ë‹¬ì„± í˜„í™©ì…ë‹ˆë‹¤.</div>
          </div>
          ${goals.salesAmount ? `
            <div style="text-align: right;">
              <div style="font-size: 12px; opacity: 0.8;">ìµœì¢… ë§¤ì¶œ ë‹¬ì„±ë¥ </div>
              <div style="font-size: 32px; font-weight: 700;">${calcRate(totalSalesAmount, goals.salesAmount)}%</div>
            </div>
          ` : ''}
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">
          ${goals.suppliers ? `
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px; text-align: center;">
              <div style="font-size: 22px; font-weight: 700;">${totalSupplierCount}<span style="font-size: 14px; opacity: 0.7;">/${goals.suppliers}</span></div>
              <div style="font-size: 11px; opacity: 0.8; margin: 4px 0;">ê³µê¸‰ì‚¬ ì…ì </div>
              <div style="height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px;">
                <div style="height: 100%; width: ${calcRate(totalSupplierCount, goals.suppliers)}%; background: white; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">${goals.suppliers - totalSupplierCount > 0 ? `${goals.suppliers - totalSupplierCount}ê°œ ë‚¨ìŒ` : 'ë‹¬ì„±!'}</div>
            </div>
          ` : ''}
          ${goals.sellers ? `
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px; text-align: center;">
              <div style="font-size: 22px; font-weight: 700;">${totalSellerCount}<span style="font-size: 14px; opacity: 0.7;">/${goals.sellers}</span></div>
              <div style="font-size: 11px; opacity: 0.8; margin: 4px 0;">ì…€ëŸ¬ ì…ì </div>
              <div style="height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px;">
                <div style="height: 100%; width: ${calcRate(totalSellerCount, goals.sellers)}%; background: white; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">${goals.sellers - totalSellerCount > 0 ? `${goals.sellers - totalSellerCount}ëª… ë‚¨ìŒ` : 'ë‹¬ì„±!'}</div>
            </div>
          ` : ''}
          ${goals.deals ? `
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px; text-align: center;">
              <div style="font-size: 22px; font-weight: 700;">${totalDealCount}<span style="font-size: 14px; opacity: 0.7;">/${goals.deals}</span></div>
              <div style="font-size: 11px; opacity: 0.8; margin: 4px 0;">ê³µêµ¬ ë“±ë¡</div>
              <div style="height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px;">
                <div style="height: 100%; width: ${calcRate(totalDealCount, goals.deals)}%; background: white; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">${goals.deals - totalDealCount > 0 ? `${goals.deals - totalDealCount}ê±´ ë‚¨ìŒ` : 'ë‹¬ì„±!'}</div>
            </div>
          ` : ''}
          ${goals.salesCount ? `
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px; text-align: center;">
              <div style="font-size: 22px; font-weight: 700;">${totalSalesCount}<span style="font-size: 14px; opacity: 0.7;">/${goals.salesCount}</span></div>
              <div style="font-size: 11px; opacity: 0.8; margin: 4px 0;">íŒë§¤ ê±´ìˆ˜</div>
              <div style="height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px;">
                <div style="height: 100%; width: ${calcRate(totalSalesCount, goals.salesCount)}%; background: white; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">${goals.salesCount - totalSalesCount > 0 ? `${goals.salesCount - totalSalesCount}ê±´ ë‚¨ìŒ` : 'ë‹¬ì„±!'}</div>
            </div>
          ` : ''}
          ${goals.salesAmount ? `
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px; text-align: center;">
              <div style="font-size: 18px; font-weight: 700;">${formatNumber(totalSalesAmount)}ì›</div>
              <div style="font-size: 11px; opacity: 0.8; margin: 4px 0;">ë§¤ì¶œì•¡</div>
              <div style="height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px;">
                <div style="height: 100%; width: ${calcRate(totalSalesAmount, goals.salesAmount)}%; background: #fbbf24; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">ëª©í‘œ ${formatNumber(goals.salesAmount)}ì›</div>
            </div>
          ` : ''}
          ${goals.profitAmount ? `
            <div style="background: rgba(255,255,255,0.25); border-radius: 12px; padding: 14px; text-align: center;">
              <div style="font-size: 18px; font-weight: 700;">${formatNumber(totalProfitAmount)}ì›</div>
              <div style="font-size: 11px; opacity: 0.8; margin: 4px 0;">ìˆœìˆ˜ìµ</div>
              <div style="height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px;">
                <div style="height: 100%; width: ${calcRate(totalProfitAmount, goals.profitAmount)}%; background: #fbbf24; border-radius: 2px;"></div>
              </div>
              <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">ëª©í‘œ ${formatNumber(goals.profitAmount)}ì›</div>
            </div>
          ` : ''}
        </div>
      </div>
    ` : ''}
    
    <!-- ì „ì²´ í˜„í™© ìš”ì•½ -->
    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 24px;">
      <div style="padding: 16px; background: white; border-radius: 14px; border: 1px solid var(--gray-200); box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${totalSupplierCount}</div>
        <div style="font-size: 12px; color: var(--gray-500);">ê³µê¸‰ì‚¬ ì…ì </div>
      </div>
      <div style="padding: 16px; background: white; border-radius: 14px; border: 1px solid var(--gray-200); box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${totalSellerCount}</div>
        <div style="font-size: 12px; color: var(--gray-500);">ì…€ëŸ¬ ì…ì </div>
      </div>
      <div style="padding: 16px; background: white; border-radius: 14px; border: 1px solid var(--gray-200); box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${totalDealCount}</div>
        <div style="font-size: 12px; color: var(--gray-500);">ê³µêµ¬ ë“±ë¡</div>
      </div>
      <div style="padding: 16px; background: white; border-radius: 14px; border: 1px solid var(--gray-200); box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${totalSalesCount}</div>
        <div style="font-size: 12px; color: var(--gray-500);">íŒë§¤ ê±´ìˆ˜</div>
      </div>
      <div style="padding: 16px; background: linear-gradient(145deg, #fff8f0, #fff5eb); border-radius: 14px; border: 1px solid rgba(252,150,0,0.3);">
        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${formatNumber(totalSalesAmount)}ì›</div>
        <div style="font-size: 12px; color: var(--gray-600);">ì´ ë§¤ì¶œì•¡</div>
      </div>
      <div style="padding: 16px; background: linear-gradient(145deg, #fc9600, #e08600); border-radius: 14px;">
        <div style="font-size: 20px; font-weight: 700; color: white;">${formatNumber(totalProfitAmount)}ì›</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.8);">ì´ ìˆœìˆ˜ìµ</div>
      </div>
    </div>
    
    <!-- ë‹´ë‹¹ì ë¯¸ë°°ì • ì•Œë¦¼ -->
    ${(unassignedSuppliers.length + unassignedSellers.length + unassignedDeals.length) > 0 ? `
      <div style="padding: 16px 20px; background: white; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--gray-200);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 4px;">âš ï¸ ë‹´ë‹¹ì ë¯¸ë°°ì • ë°ì´í„°</div>
            <div style="font-size: 13px; color: var(--gray-500);">
              ê³µê¸‰ì‚¬ ${unassignedSuppliers.length}ê±´ Â· ì…€ëŸ¬ ${unassignedSellers.length}ê±´ Â· ê³µêµ¬ ${unassignedDeals.length}ê±´
            </div>
          </div>
          <button onclick="viewAssignmentStatus()" style="
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            background: linear-gradient(145deg, #fc9600, #e08600);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
          ">ë‹´ë‹¹ì ë°°ì •í™•ì¸</button>
        </div>
      </div>
    ` : ''}
    
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">íŒ€ì›ë³„ ì‹¤ì </h3>
        ${isAdmin ? `
          <button onclick="openAssignManagerModal()" style="
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 600;
            background: white;
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            cursor: pointer;
          ">ë‹´ë‹¹ì ìˆ˜ì •</button>
        ` : ''}
      </div>
      ${members.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
          <p>íŒ€ì›ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</p>
          <button onclick="switchTab('teamMembers')" style="
            margin-top: 12px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
          ">íŒ€ì› ê´€ë¦¬ë¡œ ì´ë™</button>
        </div>
      ` : `
        <div style="display: grid; gap: 16px;">
          ${memberStats.map(m => {
            const supplierDiff = m.monthlySuppliers - m.lastMonthSuppliers;
            const sellerDiff = m.monthlySellers - m.lastMonthSellers;
            const dealDiff = m.monthlyDeals - m.lastMonthDeals;
            const mGoal = (state.memberGoals || {})[m.id] || {};
            const hasGoal = mGoal.suppliers || mGoal.sellers || mGoal.deals || mGoal.salesAmount;
            
            return `
            <div style="padding: 20px; background: white; border-radius: 14px; border: 1px solid var(--gray-200);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 48px; height: 48px; background: linear-gradient(145deg, #fc9600, #e08600); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                    ${m.name.charAt(0)}
                  </div>
                  <div>
                    <div style="font-weight: 700; font-size: 16px; color: var(--gray-800);">${m.name}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">${m.loginId || '-'} Â· ${m.role === 'admin' ? 'ê´€ë¦¬ì' : m.role === 'manager' ? 'ë§¤ë‹ˆì €' : 'ì¼ë°˜'}</div>
                  </div>
                </div>
                ${hasGoal ? `
                  <div style="text-align: right; background: linear-gradient(135deg, #1e40af, #3b82f6); padding: 6px 12px; border-radius: 8px;">
                    <div style="font-size: 10px; color: rgba(255,255,255,0.8);">ë§¤ì¶œ ë‹¬ì„±ë¥ </div>
                    <div style="font-size: 16px; font-weight: 700; color: white;">${mGoal.salesAmount ? calcRate(m.totalSales, mGoal.salesAmount) : 0}%</div>
                  </div>
                ` : `
                  <div style="text-align: right; font-size: 11px; color: var(--gray-400);">
                    ì´ë²ˆ ë‹¬ vs ì „ì›”
                  </div>
                `}
              </div>
              
              <!-- 1í–‰: ì…ì /ë“±ë¡ í˜„í™© -->
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px;">
                <div style="text-align: center; padding: 12px; background: var(--gray-50); border-radius: 10px;">
                  <div style="font-size: 22px; font-weight: 700; color: var(--gray-700);">${m.totalSuppliers}${mGoal.suppliers ? `<span style="font-size: 12px; color: var(--gray-400);">/${mGoal.suppliers}</span>` : ''}</div>
                  <div style="font-size: 11px; color: var(--gray-500);">ê³µê¸‰ì‚¬ ì…ì </div>
                  ${mGoal.suppliers ? `
                    <div style="height: 3px; background: var(--gray-200); border-radius: 2px; margin-top: 6px;">
                      <div style="height: 100%; width: ${calcRate(m.totalSuppliers, mGoal.suppliers)}%; background: var(--primary); border-radius: 2px;"></div>
                    </div>
                  ` : `
                    <div style="font-size: 10px; margin-top: 4px; color: ${supplierDiff >= 0 ? 'var(--primary)' : 'var(--gray-400)'};">
                      ${supplierDiff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(supplierDiff)} (ì „ì›” ${m.lastMonthSuppliers})
                    </div>
                  `}
                </div>
                <div style="text-align: center; padding: 12px; background: var(--gray-50); border-radius: 10px;">
                  <div style="font-size: 22px; font-weight: 700; color: var(--gray-700);">${m.totalSellers}${mGoal.sellers ? `<span style="font-size: 12px; color: var(--gray-400);">/${mGoal.sellers}</span>` : ''}</div>
                  <div style="font-size: 11px; color: var(--gray-500);">ì…€ëŸ¬ ì…ì </div>
                  ${mGoal.sellers ? `
                    <div style="height: 3px; background: var(--gray-200); border-radius: 2px; margin-top: 6px;">
                      <div style="height: 100%; width: ${calcRate(m.totalSellers, mGoal.sellers)}%; background: var(--primary); border-radius: 2px;"></div>
                    </div>
                  ` : `
                    <div style="font-size: 10px; margin-top: 4px; color: ${sellerDiff >= 0 ? 'var(--primary)' : 'var(--gray-400)'};">
                      ${sellerDiff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(sellerDiff)} (ì „ì›” ${m.lastMonthSellers})
                    </div>
                  `}
                </div>
                <div style="text-align: center; padding: 12px; background: var(--gray-50); border-radius: 10px;">
                  <div style="font-size: 22px; font-weight: 700; color: var(--gray-700);">${m.totalDeals}${mGoal.deals ? `<span style="font-size: 12px; color: var(--gray-400);">/${mGoal.deals}</span>` : ''}</div>
                  <div style="font-size: 11px; color: var(--gray-500);">ê³µêµ¬ ë“±ë¡</div>
                  ${mGoal.deals ? `
                    <div style="height: 3px; background: var(--gray-200); border-radius: 2px; margin-top: 6px;">
                      <div style="height: 100%; width: ${calcRate(m.totalDeals, mGoal.deals)}%; background: var(--primary); border-radius: 2px;"></div>
                    </div>
                  ` : `
                    <div style="font-size: 10px; margin-top: 4px; color: ${dealDiff >= 0 ? 'var(--primary)' : 'var(--gray-400)'};">
                      ${dealDiff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(dealDiff)} (ì „ì›” ${m.lastMonthDeals})
                    </div>
                  `}
                </div>
              </div>
              
              <!-- 2í–‰: ë§¤ì¶œ/ìˆ˜ìµ í˜„í™© -->
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div style="text-align: center; padding: 12px; background: linear-gradient(145deg, #fff8f0, #fff5eb); border-radius: 10px; border: 1px solid rgba(252,150,0,0.2);">
                  <div style="font-size: 22px; font-weight: 700; color: var(--primary);">${m.salesCount}${mGoal.salesCount ? `<span style="font-size: 12px; color: var(--gray-400);">/${mGoal.salesCount}</span>` : ''}</div>
                  <div style="font-size: 11px; color: var(--gray-600);">íŒë§¤ ê±´ìˆ˜</div>
                  ${mGoal.salesCount ? `
                    <div style="height: 3px; background: rgba(252,150,0,0.2); border-radius: 2px; margin-top: 6px;">
                      <div style="height: 100%; width: ${calcRate(m.salesCount, mGoal.salesCount)}%; background: var(--primary); border-radius: 2px;"></div>
                    </div>
                  ` : `
                    <div style="font-size: 10px; margin-top: 4px; color: var(--gray-500);">
                      ì´ë²ˆë‹¬ ${m.thisMonthSalesCount}ê±´
                    </div>
                  `}
                </div>
                <div style="text-align: center; padding: 12px; background: linear-gradient(145deg, #fff8f0, #fff5eb); border-radius: 10px; border: 1px solid rgba(252,150,0,0.2);">
                  <div style="font-size: 16px; font-weight: 700; color: var(--primary);">${formatNumber(m.totalSales)}ì›</div>
                  <div style="font-size: 11px; color: var(--gray-600);">ë§¤ì¶œê¸ˆì•¡</div>
                  ${mGoal.salesAmount ? `
                    <div style="height: 3px; background: rgba(252,150,0,0.2); border-radius: 2px; margin-top: 6px;">
                      <div style="height: 100%; width: ${calcRate(m.totalSales, mGoal.salesAmount)}%; background: var(--primary); border-radius: 2px;"></div>
                    </div>
                    <div style="font-size: 9px; color: var(--gray-500); margin-top: 2px;">ëª©í‘œ ${formatNumber(mGoal.salesAmount)}ì›</div>
                  ` : `
                    <div style="font-size: 10px; margin-top: 4px; color: var(--gray-500);">
                      ì´ë²ˆë‹¬ ${formatNumber(m.thisMonthSales)}ì›
                    </div>
                  `}
                </div>
                <div style="text-align: center; padding: 12px; background: linear-gradient(145deg, #fc9600, #e08600); border-radius: 10px;">
                  <div style="font-size: 16px; font-weight: 700; color: white;">${formatNumber(m.totalProfit)}ì›</div>
                  <div style="font-size: 11px; color: rgba(255,255,255,0.8);">ìˆœìˆ˜ìµ(ë§ˆì§„)</div>
                  ${mGoal.profitAmount ? `
                    <div style="height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 6px;">
                      <div style="height: 100%; width: ${calcRate(m.totalProfit, mGoal.profitAmount)}%; background: white; border-radius: 2px;"></div>
                    </div>
                    <div style="font-size: 9px; color: rgba(255,255,255,0.7); margin-top: 2px;">ëª©í‘œ ${formatNumber(mGoal.profitAmount)}ì›</div>
                  ` : `
                    <div style="font-size: 10px; margin-top: 4px; color: rgba(255,255,255,0.7);">
                      ì´ë²ˆë‹¬ ${formatNumber(m.thisMonthProfit)}ì›
                    </div>
                  `}
                </div>
              </div>
            </div>
          `}).join('')}
        </div>
      `}
    </div>
    
    <div style="margin-top: 16px; padding: 16px; background: white; border-radius: 12px; border: 1px solid var(--gray-200);">
      <div style="font-size: 13px; color: var(--gray-600);">
        ğŸ’¡ <strong>ë°ì´í„° ì—°ë™:</strong> ê³µê¸‰ì‚¬/ì…€ëŸ¬/ê³µêµ¬ ë“±ë¡ ì‹œ ë‹´ë‹¹ìë¥¼ ë°°ì •í•˜ë©´ í•´ë‹¹ íŒ€ì›ì˜ ì‹¤ì ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. 
        ì…€ëŸ¬ ì •ì‚° ë°ì´í„°ë„ ë‹´ë‹¹ ì…€ëŸ¬ ê¸°ì¤€ìœ¼ë¡œ ì—°ë™ë©ë‹ˆë‹¤.
      </div>
    </div>
  `;
}

// ëª©í‘œ ì„¤ì • ëª¨ë‹¬ (ê´€ë¦¬ì ì „ìš©)
// ëª©í‘œ ê³„ì‚°ê¸° ëª¨ë‹¬
function openGoalCalculator() {
  // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
  if (!isAdminUnlocked) {
    showAdminAuthThen('openGoalCalculatorReal');
    return;
  }
  openGoalCalculatorReal();
}

function openGoalCalculatorReal() {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“Š ëª©í‘œ ê³„ì‚°ê¸°</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- ì…ë ¥ ì„¹ì…˜ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ“ ê¸°ë³¸ ì¡°ê±´ ì…ë ¥</div>
          
          <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
            <button onclick="setCalcPreset('default')" class="calc-preset active" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: #1e40af; color: white; font-size: 12px; cursor: pointer;">ê¸°ë³¸ê°’</button>
            <button onclick="setCalcPreset('conservative')" class="calc-preset" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; color: var(--gray-600); font-size: 12px; cursor: pointer;">ë³´ìˆ˜ì </button>
            <button onclick="setCalcPreset('aggressive')" class="calc-preset" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; color: var(--gray-600); font-size: 12px; cursor: pointer;">ê³µê²©ì </button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div style="grid-column: 1 / -1;">
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">ğŸ¯ ì—°ê°„ ë§¤ì¶œ ëª©í‘œ (ì›)</label>
              <input type="number" id="calc-annualTarget" value="500000000" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">ğŸ’° ê±´ë‹¹ íŒë§¤ê°€ (ì›)</label>
              <input type="number" id="calc-pricePerItem" value="9000" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">ğŸ“ˆ ê±´ë‹¹ ìˆœë§ˆì§„ (ì›)</label>
              <input type="number" id="calc-marginPerItem" value="2000" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">ğŸ“¦ ê³µêµ¬ë‹¹ ì˜ˆìƒ íŒë§¤ëŸ‰ (ê°œ)</label>
              <input type="number" id="calc-salesPerDeal" value="300" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">âœ… ê³µêµ¬ ì„±ê³µë¥  (%)</label>
              <input type="number" id="calc-successRate" value="30" min="1" max="100" oninput="calculateGoal()" style="width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px;">
            </div>
          </div>
        </div>
        
        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); border-radius: 12px; padding: 20px; color: white; margin-bottom: 20px;">
          <div style="font-weight: 600; margin-bottom: 16px;">ğŸ“Š ê³„ì‚° ê²°ê³¼</div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;" id="calc-monthlyDeals">52</div>
              <div style="font-size: 11px; opacity: 0.8;">ì›” í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;" id="calc-annualDeals">624</div>
              <div style="font-size: 11px; opacity: 0.8;">ì—° í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;" id="calc-weeklyDeals">13</div>
              <div style="font-size: 11px; opacity: 0.8;">ì£¼ í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 18px; font-weight: 700;" id="calc-revenuePerDeal">81ë§Œ</div>
              <div style="font-size: 11px; opacity: 0.8;">ê±´ë‹¹ ê¸°ëŒ€ë§¤ì¶œ</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 18px; font-weight: 700;" id="calc-profitPerDeal">18ë§Œ</div>
              <div style="font-size: 11px; opacity: 0.8;">ê±´ë‹¹ ê¸°ëŒ€ìˆœìµ</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 14px; text-align: center;">
              <div style="font-size: 18px; font-weight: 700;" id="calc-annualRevenue">5.1ì–µì›</div>
              <div style="font-size: 11px; opacity: 0.8;">ì—°ê°„ ì˜ˆìƒë§¤ì¶œ</div>
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; font-size: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span>ê³µêµ¬ 1ê±´ ì„±ê³µ ì‹œ ë§¤ì¶œ</span>
              <span id="calc-successRevenue">270ë§Œì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span>ê³µêµ¬ 1ê±´ ì„±ê³µ ì‹œ ìˆœìµ</span>
              <span id="calc-successProfit">60ë§Œì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span>ì›”ê°„ ë§¤ì¶œ ëª©í‘œ</span>
              <span id="calc-monthlyTarget">4,167ë§Œì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span>ì—°ê°„ ì˜ˆìƒ ìˆœìµ</span>
              <span id="calc-annualProfit" style="color: #fbbf24; font-weight: 600;">1ì–µì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
              <span>ë§ˆì§„ìœ¨</span>
              <span id="calc-marginRate">22.2%</span>
            </div>
          </div>
        </div>
        
        <!-- ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ -->
        <div style="background: white; border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ”„ ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ</div>
          <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--gray-50);">
                <th style="padding: 10px; text-align: left;">ì‹œë‚˜ë¦¬ì˜¤</th>
                <th style="padding: 10px; text-align: center;">ì„±ê³µë¥ </th>
                <th style="padding: 10px; text-align: center;">ì›” ê³µêµ¬</th>
                <th style="padding: 10px; text-align: center;">ì—° ê³µêµ¬</th>
                <th style="padding: 10px; text-align: center;">ì—° ìˆœìµ</th>
              </tr>
            </thead>
            <tbody id="calc-scenarios"></tbody>
          </table>
        </div>
        
        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 10px; padding: 14px; margin-top: 16px; font-size: 12px; color: #92400e;">
          <strong>ğŸ’¡ ì°¸ê³ </strong><br>
          ì„±ê³µë¥  30% = ì§„í–‰í•œ ê³µêµ¬ ì¤‘ 30%ë§Œ ëª©í‘œ íŒë§¤ëŸ‰ ë‹¬ì„±, ë‚˜ë¨¸ì§€ 70%ëŠ” ì‹¤íŒ¨ ë˜ëŠ” ë¶€ë¶„ ë‹¬ì„±
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
        <button class="btn btn-primary" onclick="applyCalculatedGoals()">ì´ ê°’ìœ¼ë¡œ ëª©í‘œ ì„¤ì •</button>
      </div>
    </div>
  `;
  
  calculateGoal();
}

// í”„ë¦¬ì…‹ ì„¤ì •
function setCalcPreset(type) {
  document.querySelectorAll('.calc-preset').forEach(btn => {
    btn.style.background = 'white';
    btn.style.color = 'var(--gray-600)';
  });
  event.target.style.background = '#1e40af';
  event.target.style.color = 'white';
  
  const presets = {
    default: { target: 500000000, price: 9000, margin: 2000, sales: 300, rate: 30 },
    conservative: { target: 300000000, price: 9000, margin: 2000, sales: 200, rate: 25 },
    aggressive: { target: 500000000, price: 9000, margin: 2500, sales: 400, rate: 40 }
  };
  
  if (presets[type]) {
    document.getElementById('calc-annualTarget').value = presets[type].target;
    document.getElementById('calc-pricePerItem').value = presets[type].price;
    document.getElementById('calc-marginPerItem').value = presets[type].margin;
    document.getElementById('calc-salesPerDeal').value = presets[type].sales;
    document.getElementById('calc-successRate').value = presets[type].rate;
  }
  
  calculateGoal();
}

// ëª©í‘œ ê³„ì‚°
function calculateGoal() {
  const annualTarget = Number(document.getElementById('calc-annualTarget').value) || 0;
  const pricePerItem = Number(document.getElementById('calc-pricePerItem').value) || 0;
  const marginPerItem = Number(document.getElementById('calc-marginPerItem').value) || 0;
  const salesPerDeal = Number(document.getElementById('calc-salesPerDeal').value) || 0;
  const successRate = Number(document.getElementById('calc-successRate').value) / 100 || 0;
  
  const successRevenue = pricePerItem * salesPerDeal;
  const successProfit = marginPerItem * salesPerDeal;
  const expectedRevenue = successRevenue * successRate;
  const expectedProfit = successProfit * successRate;
  
  const monthlyTarget = annualTarget / 12;
  const monthlyDeals = Math.ceil(monthlyTarget / expectedRevenue) || 0;
  const annualDeals = monthlyDeals * 12;
  const weeklyDeals = Math.ceil(monthlyDeals / 4);
  
  // ì—°ê°„ ì˜ˆìƒ ë§¤ì¶œ = ì›” ê³µêµ¬ ìˆ˜ Ã— 12 Ã— ê±´ë‹¹ ê¸°ëŒ€ë§¤ì¶œ
  const annualExpectedRevenue = monthlyDeals * 12 * expectedRevenue;
  // ì—°ê°„ ì˜ˆìƒ ìˆœìµ = ì›” ê³µêµ¬ ìˆ˜ Ã— 12 Ã— ê±´ë‹¹ ê¸°ëŒ€ìˆœìµ
  const annualExpectedProfit = monthlyDeals * 12 * expectedProfit;
  const marginRate = (marginPerItem / pricePerItem * 100).toFixed(1);
  
  // ê²°ê³¼ í‘œì‹œ
  document.getElementById('calc-monthlyDeals').textContent = monthlyDeals;
  document.getElementById('calc-annualDeals').textContent = annualDeals;
  document.getElementById('calc-weeklyDeals').textContent = weeklyDeals;
  document.getElementById('calc-revenuePerDeal').textContent = formatCalcWon(expectedRevenue);
  document.getElementById('calc-profitPerDeal').textContent = formatCalcWon(expectedProfit);
  document.getElementById('calc-annualRevenue').textContent = formatCalcWon(annualExpectedRevenue);
  document.getElementById('calc-annualProfit').textContent = formatCalcWon(annualExpectedProfit);
  
  document.getElementById('calc-successRevenue').textContent = formatCalcWon(successRevenue);
  document.getElementById('calc-successProfit').textContent = formatCalcWon(successProfit);
  document.getElementById('calc-monthlyTarget').textContent = formatCalcWon(monthlyTarget);
  document.getElementById('calc-marginRate').textContent = marginRate + '%';
  
  // ì‹œë‚˜ë¦¬ì˜¤ ë Œë”ë§
  renderCalcScenarios(pricePerItem, marginPerItem, salesPerDeal);
}

function formatCalcWon(num) {
  if (num >= 100000000) return (num / 100000000).toFixed(1) + 'ì–µì›';
  if (num >= 10000) return Math.round(num / 10000) + 'ë§Œì›';
  return formatNumber(num) + 'ì›';
}

function renderCalcScenarios(price, margin, sales) {
  const scenarios = [
    { name: '3ì–µ (í˜„ì‹¤ì )', target: 300000000, rate: 30 },
    { name: '5ì–µ (ëª©í‘œ)', target: 500000000, rate: 30 },
    { name: '5ì–µ (ì„±ê³µë¥ â†‘)', target: 500000000, rate: 40 },
  ];
  
  let html = '';
  scenarios.forEach(s => {
    const successRevenue = price * sales;
    const expectedRevenue = successRevenue * (s.rate / 100);
    const monthlyTarget = s.target / 12;
    const monthlyDeals = Math.ceil(monthlyTarget / expectedRevenue);
    const annualDeals = monthlyDeals * 12;
    const annualProfit = s.target * (margin / price);
    
    html += `<tr style="border-bottom: 1px solid var(--gray-100);">
      <td style="padding: 10px; font-weight: 600;">${s.name}</td>
      <td style="padding: 10px; text-align: center;">${s.rate}%</td>
      <td style="padding: 10px; text-align: center; color: #1e40af; font-weight: 700;">${monthlyDeals}ê±´</td>
      <td style="padding: 10px; text-align: center;">${annualDeals}ê±´</td>
      <td style="padding: 10px; text-align: center; color: #16a34a;">${formatCalcWon(annualProfit)}</td>
    </tr>`;
  });
  
  document.getElementById('calc-scenarios').innerHTML = html;
}

// ê³„ì‚° ê²°ê³¼ë¡œ ëª©í‘œ ì„¤ì • ì ìš©
function applyCalculatedGoals() {
  const annualTarget = Number(document.getElementById('calc-annualTarget').value) || 0;
  const annualDeals = Number(document.getElementById('calc-annualDeals').textContent) || 0;
  
  // ì—°ê°„ ì˜ˆìƒ ìˆœìµ í…ìŠ¤íŠ¸ì—ì„œ ê°’ ì¶”ì¶œ
  const profitText = document.getElementById('calc-annualProfit').textContent;
  let annualProfit = 0;
  if (profitText.includes('ì–µ')) {
    annualProfit = parseFloat(profitText) * 100000000;
  } else if (profitText.includes('ë§Œ')) {
    annualProfit = parseFloat(profitText) * 10000;
  }
  
  closeModal();
  
  setTimeout(() => {
    openGoalSettingModalReal();
    setTimeout(() => {
      // íŒ€ ëª©í‘œ íƒ­ì— ê°’ ì±„ìš°ê¸°
      const dealsInput = document.getElementById('goal-deals');
      const salesAmountInput = document.getElementById('goal-salesAmount');
      const profitAmountInput = document.getElementById('goal-profitAmount');
      
      if (dealsInput) dealsInput.value = annualDeals;
      if (salesAmountInput) salesAmountInput.value = annualTarget;
      if (profitAmountInput) profitAmountInput.value = Math.round(annualProfit);
      
      showToast('ê³„ì‚° ê²°ê³¼ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
    }, 200);
  }, 100);
}

function openGoalSettingModal() {
  // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
  if (!isAdminUnlocked) {
    showAdminAuthThen('openGoalSettingModalReal');
    return;
  }
  openGoalSettingModalReal();
}

function openGoalSettingModalReal() {
  const goals = state.salesGoals || {};
  const members = state.teamMembers || [];
  const memberGoals = state.memberGoals || {};
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ¯ ëª©í‘œ ì„¤ì •</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- íƒ­ -->
        <div style="display: flex; gap: 4px; margin-bottom: 20px; background: var(--gray-100); padding: 4px; border-radius: 10px;">
          <button onclick="switchGoalTab('team')" id="goalTab-team" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--primary); color: white; cursor: pointer;">
            íŒ€ ëª©í‘œ
          </button>
          <button onclick="switchGoalTab('member')" id="goalTab-member" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            íŒ€ì›ë³„ ëª©í‘œ
          </button>
        </div>
        
        <!-- íŒ€ ëª©í‘œ -->
        <div id="goalContent-team">
          <div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
            <div style="font-size: 13px; color: #1e40af;">íŒ€ ì „ì²´ì˜ ëª©í‘œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œ ìƒë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label class="form-label">ê³µê¸‰ì‚¬ ì…ì </label>
              <input type="number" class="form-input" id="goal-suppliers" value="${goals.suppliers || ''}" placeholder="ì˜ˆ: 50">
            </div>
            <div class="form-group">
              <label class="form-label">ì…€ëŸ¬ ì…ì </label>
              <input type="number" class="form-input" id="goal-sellers" value="${goals.sellers || ''}" placeholder="ì˜ˆ: 100">
            </div>
            <div class="form-group">
              <label class="form-label">ê³µêµ¬ ë“±ë¡</label>
              <input type="number" class="form-input" id="goal-deals" value="${goals.deals || ''}" placeholder="ì˜ˆ: 200">
            </div>
            <div class="form-group">
              <label class="form-label">íŒë§¤ ê±´ìˆ˜</label>
              <input type="number" class="form-input" id="goal-salesCount" value="${goals.salesCount || ''}" placeholder="ì˜ˆ: 500">
            </div>
            <div class="form-group">
              <label class="form-label">ë§¤ì¶œê¸ˆì•¡ (ì›)</label>
              <input type="number" class="form-input" id="goal-salesAmount" value="${goals.salesAmount || ''}" placeholder="ì˜ˆ: 100000000">
            </div>
            <div class="form-group">
              <label class="form-label">ìˆœìˆ˜ìµ (ì›)</label>
              <input type="number" class="form-input" id="goal-profitAmount" value="${goals.profitAmount || ''}" placeholder="ì˜ˆ: 10000000">
            </div>
          </div>
          
          <div style="margin-top: 20px; text-align: right;">
            <button class="btn btn-primary" onclick="saveSalesGoals()">íŒ€ ëª©í‘œ ì €ì¥</button>
          </div>
        </div>
        
        <!-- íŒ€ì›ë³„ ëª©í‘œ -->
        <div id="goalContent-member" style="display: none;">
          <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
            <div style="font-size: 13px; color: #92400e;">ê° íŒ€ì›ì˜ ê°œì¸ ëª©í‘œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</div>
          </div>
          
          ${members.length === 0 ? `
            <div style="text-align: center; padding: 40px; color: var(--gray-500);">
              íŒ€ì›ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
            </div>
          ` : members.map(member => {
            const mGoal = memberGoals[member.id] || {};
            return `
            <div style="border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(145deg, #fc9600, #e08600); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                  ${member.name.charAt(0)}
                </div>
                <div>
                  <div style="font-weight: 600;">${member.name}</div>
                  <div style="font-size: 12px; color: var(--gray-500);">${member.role === 'admin' ? 'ê´€ë¦¬ì' : member.role === 'manager' ? 'ë§¤ë‹ˆì €' : 'ì¼ë°˜'}</div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ê³µê¸‰ì‚¬</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-suppliers" value="${mGoal.suppliers || ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ì…€ëŸ¬</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-sellers" value="${mGoal.sellers || ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ê³µêµ¬</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-deals" value="${mGoal.deals || ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">íŒë§¤ê±´ìˆ˜</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-salesCount" value="${mGoal.salesCount || ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ë§¤ì¶œ(ë§Œì›)</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-salesAmount" value="${mGoal.salesAmount ? mGoal.salesAmount / 10000 : ''}" placeholder="0" style="padding: 8px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--gray-500);">ìˆœìˆ˜ìµ(ë§Œì›)</label>
                  <input type="number" class="form-input" id="mgoal-${member.id}-profitAmount" value="${mGoal.profitAmount ? mGoal.profitAmount / 10000 : ''}" placeholder="0" style="padding: 8px;">
                </div>
              </div>
            </div>
          `}).join('')}
          
          ${members.length > 0 ? `
            <div style="margin-top: 20px; text-align: right;">
              <button class="btn btn-primary" onclick="saveMemberGoals()">íŒ€ì›ë³„ ëª©í‘œ ì €ì¥</button>
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

// ëª©í‘œ íƒ­ ì „í™˜
function switchGoalTab(tab) {
  ['team', 'member'].forEach(t => {
    const btn = document.getElementById('goalTab-' + t);
    const content = document.getElementById('goalContent-' + t);
    if (btn && content) {
      if (t === tab) {
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        content.style.display = 'block';
      } else {
        btn.style.background = 'transparent';
        btn.style.color = 'var(--gray-500)';
        content.style.display = 'none';
      }
    }
  });
}

// ê´€ë¦¬ì ì¸ì¦ í›„ í•¨ìˆ˜ ì‹¤í–‰
function showAdminAuthThen(callbackFn) {
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ” ê´€ë¦¬ì ì¸ì¦</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="background: var(--gray-100); border-radius: 8px; padding: 12px; margin: 20px;">
        <p style="color: var(--gray-600); font-size: 13px; margin: 0;">ì´ ê¸°ëŠ¥ì€ ê´€ë¦¬ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
      </div>
      <form onsubmit="checkAdminPasswordThen(event, '${callbackFn}')">
        <div style="padding: 0 20px;">
          <div class="form-group">
            <label class="form-label">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" class="form-input" id="admin-auth-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required autofocus>
          </div>
          <div id="admin-auth-error" style="color: var(--danger); font-size: 14px; margin-bottom: 12px; display: none;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">í™•ì¸</button>
        </div>
      </form>
    </div>
  `;
}

function checkAdminPasswordThen(e, callbackFn) {
  e.preventDefault();
  const password = document.getElementById('admin-auth-password').value;
  
  if (password === ADMIN_PASSWORD) {
    isAdminUnlocked = true;
    sessionStorage.setItem('adminUnlocked', 'true');
    closeModal();
    
    // ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
    if (callbackFn === 'openGoalSettingModalReal') {
      setTimeout(() => openGoalSettingModalReal(), 100);
    } else if (callbackFn === 'openAssignManagerModalReal') {
      setTimeout(() => openAssignManagerModalReal(), 100);
    } else if (callbackFn === 'openGoalCalculatorReal') {
      setTimeout(() => openGoalCalculatorReal(), 100);
    }
  } else {
    document.getElementById('admin-auth-error').style.display = 'block';
    document.getElementById('admin-auth-password').value = '';
    document.getElementById('admin-auth-password').focus();
  }
}

// ëª©í‘œ ì €ì¥
async function saveSalesGoals() {
  const goals = {
    suppliers: parseInt(document.getElementById('goal-suppliers').value) || 0,
    sellers: parseInt(document.getElementById('goal-sellers').value) || 0,
    deals: parseInt(document.getElementById('goal-deals').value) || 0,
    salesCount: parseInt(document.getElementById('goal-salesCount').value) || 0,
    salesAmount: parseInt(document.getElementById('goal-salesAmount').value) || 0,
    profitAmount: parseInt(document.getElementById('goal-profitAmount').value) || 0,
    updatedAt: new Date().toISOString()
  };
  
  try {
    await db.collection('settings').doc('salesGoals').set(goals);
    state.salesGoals = goals;
    showToast('íŒ€ ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    renderSalesDashboard();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// íŒ€ì›ë³„ ëª©í‘œ ì €ì¥
async function saveMemberGoals() {
  const members = state.teamMembers || [];
  const memberGoals = {};
  
  members.forEach(member => {
    memberGoals[member.id] = {
      suppliers: parseInt(document.getElementById(`mgoal-${member.id}-suppliers`)?.value) || 0,
      sellers: parseInt(document.getElementById(`mgoal-${member.id}-sellers`)?.value) || 0,
      deals: parseInt(document.getElementById(`mgoal-${member.id}-deals`)?.value) || 0,
      salesCount: parseInt(document.getElementById(`mgoal-${member.id}-salesCount`)?.value) || 0,
      salesAmount: (parseInt(document.getElementById(`mgoal-${member.id}-salesAmount`)?.value) || 0) * 10000,
      profitAmount: (parseInt(document.getElementById(`mgoal-${member.id}-profitAmount`)?.value) || 0) * 10000
    };
  });
  
  try {
    await db.collection('settings').doc('memberGoals').set({
      goals: memberGoals,
      updatedAt: new Date().toISOString()
    });
    state.memberGoals = memberGoals;
    showToast('íŒ€ì›ë³„ ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeModal();
    renderSalesDashboard();
  } catch (e) {
    console.error(e);
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ë‹´ë‹¹ì ë°°ì •/ìˆ˜ì • ëª¨ë‹¬
// ë‹´ë‹¹ì ë°°ì • í™•ì¸ (ë³´ê¸° ì „ìš©)
function viewAssignmentStatus() {
  const members = state.teamMembers || [];
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ ë‹´ë‹¹ì ë°°ì •í˜„í™©</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- íƒ­ -->
        <div style="display: flex; gap: 4px; margin-bottom: 20px; background: var(--gray-100); padding: 4px; border-radius: 10px;">
          <button onclick="switchViewAssignTab('suppliers')" id="viewAssignTab-suppliers" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--primary); color: white; cursor: pointer;">
            ê³µê¸‰ì‚¬ (${state.suppliers.length})
          </button>
          <button onclick="switchViewAssignTab('sellers')" id="viewAssignTab-sellers" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            ì…€ëŸ¬ (${state.sellers.length})
          </button>
          <button onclick="switchViewAssignTab('deals')" id="viewAssignTab-deals" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            ê³µêµ¬ (${state.deals.length})
          </button>
        </div>
        
        <!-- ê³µê¸‰ì‚¬ íƒ­ -->
        <div id="viewAssignContent-suppliers">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬ëª…</th>
                <th>ë“±ë¡ì¼</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.suppliers.map(s => {
                const manager = members.find(m => m.id === s.registeredBy);
                return `
                <tr>
                  <td style="font-weight: 500;">${s.name}</td>
                  <td style="color: var(--gray-500);">${formatDate(s.createdAt)}</td>
                  <td>
                    <span style="padding: 6px 12px; border-radius: 6px; font-size: 12px; background: ${s.registeredBy ? 'var(--gray-100)' : '#fef2f2'}; color: ${s.registeredBy ? 'var(--gray-700)' : '#dc2626'};">
                      ${manager ? manager.name : 'ë¯¸ë°°ì •'}
                    </span>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- ì…€ëŸ¬ íƒ­ -->
        <div id="viewAssignContent-sellers" style="display: none;">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ì…€ëŸ¬ëª…</th>
                <th>ë“±ë¡ì¼</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.sellers.map(s => {
                const manager = members.find(m => m.id === s.registeredBy);
                return `
                <tr>
                  <td style="font-weight: 500;">${s.name?.split('/')[0] || s.name}</td>
                  <td style="color: var(--gray-500);">${formatDate(s.createdAt)}</td>
                  <td>
                    <span style="padding: 6px 12px; border-radius: 6px; font-size: 12px; background: ${s.registeredBy ? 'var(--gray-100)' : '#fef2f2'}; color: ${s.registeredBy ? 'var(--gray-700)' : '#dc2626'};">
                      ${manager ? manager.name : 'ë¯¸ë°°ì •'}
                    </span>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- ê³µêµ¬ íƒ­ -->
        <div id="viewAssignContent-deals" style="display: none;">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ê³µêµ¬ëª…</th>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ê¸°ê°„</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.deals.map(d => {
                const supplier = state.suppliers.find(s => s.id === d.supplierId);
                const manager = members.find(m => m.id === d.registeredBy);
                return `
                <tr>
                  <td style="font-weight: 500;">${d.title || '-'}</td>
                  <td>${supplier?.name || '-'}</td>
                  <td style="font-size: 11px; color: var(--gray-500);">${d.startDate || ''} ~ ${d.endDate || ''}</td>
                  <td>
                    <span style="padding: 6px 12px; border-radius: 6px; font-size: 12px; background: ${d.registeredBy ? 'var(--gray-100)' : '#fef2f2'}; color: ${d.registeredBy ? 'var(--gray-700)' : '#dc2626'};">
                      ${manager ? manager.name : 'ë¯¸ë°°ì •'}
                    </span>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

// ë°°ì •í™•ì¸ íƒ­ ì „í™˜
function switchViewAssignTab(tab) {
  ['suppliers', 'sellers', 'deals'].forEach(t => {
    const btn = document.getElementById('viewAssignTab-' + t);
    const content = document.getElementById('viewAssignContent-' + t);
    if (btn && content) {
      if (t === tab) {
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        content.style.display = 'block';
      } else {
        btn.style.background = 'transparent';
        btn.style.color = 'var(--gray-500)';
        content.style.display = 'none';
      }
    }
  });
}

function openAssignManagerModal() {
  // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
  if (!isAdminUnlocked) {
    showAdminAuthThen('openAssignManagerModalReal');
    return;
  }
  openAssignManagerModalReal();
}

function openAssignManagerModalReal() {
  const members = state.teamMembers || [];
  
  if (members.length === 0) {
    showToast('ë¨¼ì € íŒ€ì›ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
    switchTab('teamMembers');
    return;
  }
  
  const m = document.getElementById('modal');
  m.className = 'modal show';
  m.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2 class="modal-title">âœï¸ ë‹´ë‹¹ì ë°°ì •/ìˆ˜ì •</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- íƒ­ -->
        <div style="display: flex; gap: 4px; margin-bottom: 20px; background: var(--gray-100); padding: 4px; border-radius: 10px;">
          <button onclick="switchAssignTab('suppliers')" id="assignTab-suppliers" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--primary); color: white; cursor: pointer;">
            ğŸ­ ê³µê¸‰ì‚¬ (${state.suppliers.length})
          </button>
          <button onclick="switchAssignTab('sellers')" id="assignTab-sellers" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            ğŸ‘¤ ì…€ëŸ¬ (${state.sellers.length})
          </button>
          <button onclick="switchAssignTab('deals')" id="assignTab-deals" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: var(--gray-500); cursor: pointer;">
            ğŸ“¦ ê³µêµ¬ (${state.deals.length})
          </button>
        </div>
        
        <!-- ê³µê¸‰ì‚¬ íƒ­ -->
        <div id="assignContent-suppliers">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ê³µê¸‰ì‚¬ëª…</th>
                <th>ë“±ë¡ì¼</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.suppliers.map(s => `
                <tr>
                  <td style="font-weight: 500;">${s.name}</td>
                  <td style="color: var(--gray-500);">${formatDate(s.createdAt)}</td>
                  <td>
                    <select onchange="updateRegisteredBy('suppliers', '${s.id}', this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid ${s.registeredBy ? 'var(--gray-200)' : '#fecaca'}; border-radius: 6px; font-size: 12px; background: ${s.registeredBy ? 'white' : '#fef2f2'};">
                      <option value="">ë¯¸ë°°ì •</option>
                      ${members.map(m => `<option value="${m.id}" ${s.registeredBy === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                    </select>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- ì…€ëŸ¬ íƒ­ -->
        <div id="assignContent-sellers" style="display: none;">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ì…€ëŸ¬ëª…</th>
                <th>ë“±ë¡ì¼</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.sellers.map(s => `
                <tr>
                  <td style="font-weight: 500;">${s.name?.split('/')[0] || s.name}</td>
                  <td style="color: var(--gray-500);">${formatDate(s.createdAt)}</td>
                  <td>
                    <select onchange="updateRegisteredBy('sellers', '${s.id}', this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid ${s.registeredBy ? 'var(--gray-200)' : '#fecaca'}; border-radius: 6px; font-size: 12px; background: ${s.registeredBy ? 'white' : '#fef2f2'};">
                      <option value="">ë¯¸ë°°ì •</option>
                      ${members.map(m => `<option value="${m.id}" ${s.registeredBy === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                    </select>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- ê³µêµ¬ íƒ­ -->
        <div id="assignContent-deals" style="display: none;">
          <table class="data-table" style="font-size: 13px;">
            <thead>
              <tr>
                <th>ê³µêµ¬ëª…</th>
                <th>ê³µê¸‰ì‚¬</th>
                <th>ê¸°ê°„</th>
                <th style="width: 150px;">ë‹´ë‹¹ì</th>
              </tr>
            </thead>
            <tbody>
              ${state.deals.map(d => {
                const supplier = state.suppliers.find(s => s.id === d.supplierId);
                return `
                <tr>
                  <td style="font-weight: 500;">${d.title || '-'}</td>
                  <td>${supplier?.name || '-'}</td>
                  <td style="color: var(--gray-500); font-size: 12px;">${d.startDate || '-'}</td>
                  <td>
                    <select onchange="updateRegisteredBy('deals', '${d.id}', this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid ${d.registeredBy ? 'var(--gray-200)' : '#fecaca'}; border-radius: 6px; font-size: 12px; background: ${d.registeredBy ? 'white' : '#fef2f2'};">
                      <option value="">ë¯¸ë°°ì •</option>
                      ${members.map(m => `<option value="${m.id}" ${d.registeredBy === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                    </select>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
      </div>
      <div style="padding: 16px 20px; background: var(--gray-50); border-top: 1px solid var(--gray-200); text-align: right;">
        <button onclick="closeModal()" class="btn btn-primary">ì™„ë£Œ</button>
      </div>
    </div>
  `;
}

// ë‹´ë‹¹ì ë°°ì • íƒ­ ì „í™˜
function switchAssignTab(tab) {
  ['suppliers', 'sellers', 'deals'].forEach(t => {
    const tabBtn = document.getElementById('assignTab-' + t);
    const content = document.getElementById('assignContent-' + t);
    if (t === tab) {
      tabBtn.style.background = 'var(--primary)';
      tabBtn.style.color = 'white';
      content.style.display = 'block';
    } else {
      tabBtn.style.background = 'transparent';
      tabBtn.style.color = 'var(--gray-500)';
      content.style.display = 'none';
    }
  });
}

// ë‹´ë‹¹ì ì—…ë°ì´íŠ¸
async function updateRegisteredBy(collection, docId, memberId) {
  try {
    await db.collection(collection).doc(docId).update({
      registeredBy: memberId || null,
      registeredByUpdatedAt: new Date().toISOString()
    });
    showToast('ë‹´ë‹¹ìê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (err) {
    console.error(err);
    showToast('ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ==================== ë°ì´í„° ì‚¬ìš©ëŸ‰ ====================
async function renderDataUsage() {
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <div class="page-header">
      <h1 class="page-title">ğŸ’¾ ë°ì´í„° ì‚¬ìš©ëŸ‰</h1>
      <p style="color: var(--gray-500); margin-top: 4px;">Firebase Firestore ë°ì´í„° ì‚¬ìš© í˜„í™©ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
    </div>
    
    <div style="text-align: center; padding: 40px;">
      <div style="font-size: 48px; margin-bottom: 16px;">â³</div>
      <p style="color: var(--gray-500);">ë°ì´í„° ì‚¬ìš©ëŸ‰ì„ ì¡°íšŒí•˜ëŠ” ì¤‘...</p>
    </div>
  `;
  
  // ë°ì´í„° ìˆ˜ ê³„ì‚°
  try {
    const collections = [
      { name: 'deals', label: 'ê³µêµ¬', icon: 'ğŸ“¦' },
      { name: 'suppliers', label: 'ê³µê¸‰ì‚¬', icon: 'ğŸ­' },
      { name: 'sellers', label: 'ì…€ëŸ¬', icon: 'ğŸ‘¤' },
      { name: 'products', label: 'ìƒí’ˆ', icon: 'ğŸ›ï¸' },
      { name: 'sellerSettlements', label: 'ì…€ëŸ¬ ì •ì‚°', icon: 'ğŸ’°' },
      { name: 'supplierSettlements', label: 'ê³µê¸‰ì‚¬ ì •ì‚°', icon: 'ğŸ’µ' },
      { name: 'dealSuggestions', label: 'ê³µêµ¬ ì œì•ˆ', icon: 'ğŸ’¡' },
      { name: 'adminProposals', label: 'ì–´ë“œë¯¼ ì œì•ˆ', icon: 'ğŸ“¨' },
      { name: 'partnerMessages', label: 'íŒŒíŠ¸ë„ˆ ë©”ì‹œì§€', icon: 'ğŸ’¬' },
      { name: 'partnerNotices', label: 'ê³µì§€ì‚¬í•­', icon: 'ğŸ“¢' },
      { name: 'teamMembers', label: 'íŒ€ì›', icon: 'ğŸ‘¥' },
      { name: 'partnerAccounts', label: 'íŒŒíŠ¸ë„ˆ ê³„ì •', icon: 'ğŸ”' }
    ];
    
    const stats = [];
    let totalDocs = 0;
    
    for (const col of collections) {
      try {
        const snapshot = await db.collection(col.name).get();
        const count = snapshot.size;
        totalDocs += count;
        stats.push({ ...col, count });
      } catch (e) {
        stats.push({ ...col, count: 0, error: true });
      }
    }
    
    // ìš©ëŸ‰ ê³„ì‚° (ë¬¸ì„œë‹¹ ì•½ 1KB ê°€ì •)
    const estimatedSizeKB = totalDocs * 1; // KB
    const estimatedSizeMB = (estimatedSizeKB / 1024).toFixed(3); // MB (ì†Œìˆ˜ì  3ìë¦¬)
    const freeLimitMB = 1024; // 1GB = 1024MB
    const remainingMB = (freeLimitMB - estimatedSizeKB / 1024).toFixed(2);
    const usagePercent = ((estimatedSizeKB / 1024 / freeLimitMB) * 100).toFixed(4); // ì†Œìˆ˜ì  4ìë¦¬ê¹Œì§€
    
    // ë‚¨ì€ ë¬¸ì„œ ìˆ˜ (1GB = ì•½ 100ë§Œ ë¬¸ì„œ ê°€ì •)
    const maxDocs = 1000000;
    const remainingDocs = maxDocs - totalDocs;
    
    app.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">ğŸ’¾ ë°ì´í„° ì‚¬ìš©ëŸ‰</h1>
        <p style="color: var(--gray-500); margin-top: 4px;">Firebase Firestore ë°ì´í„° ì‚¬ìš© í˜„í™©ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
      </div>
      
      <!-- ì „ì²´ ìš”ì•½ -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
        <div style="padding: 20px; background: linear-gradient(145deg, #fff8f0, #fffbeb); border-radius: 14px; border: 1px solid rgba(252,150,0,0.2);">
          <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${totalDocs.toLocaleString()}</div>
          <div style="font-size: 13px; color: var(--gray-600);">ì´ ë¬¸ì„œ ìˆ˜</div>
        </div>
        <div style="padding: 20px; background: var(--gray-50); border-radius: 14px;">
          <div style="font-size: 28px; font-weight: 700; color: var(--gray-700);">${estimatedSizeKB < 1024 ? estimatedSizeKB + ' KB' : estimatedSizeMB + ' MB'}</div>
          <div style="font-size: 13px; color: var(--gray-600);">ì¶”ì • ìš©ëŸ‰</div>
        </div>
        <div style="padding: 20px; background: linear-gradient(145deg, #f0fdf4, #dcfce7); border-radius: 14px; border: 1px solid #86efac;">
          <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${remainingMB} MB</div>
          <div style="font-size: 13px; color: var(--gray-600);">ë‚¨ì€ ìš©ëŸ‰</div>
        </div>
        <div style="padding: 20px; background: linear-gradient(145deg, #f0f9ff, #e0f2fe); border-radius: 14px; border: 1px solid #7dd3fc;">
          <div style="font-size: 28px; font-weight: 700; color: var(--info);">${usagePercent}%</div>
          <div style="font-size: 13px; color: var(--gray-600);">ì‚¬ìš©ë¥ </div>
        </div>
      </div>
      
      <!-- ì‚¬ìš©ëŸ‰ í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
      <div style="padding: 20px; background: white; border-radius: 14px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="font-weight: 600;">ë¬´ë£Œ í•œë„ ì‚¬ìš©ëŸ‰</span>
          <span style="font-size: 14px; color: var(--gray-600);">${estimatedSizeMB} MB / 1,024 MB (1GB)</span>
        </div>
        <div style="height: 20px; background: var(--gray-200); border-radius: 10px; overflow: hidden;">
          <div style="height: 100%; width: ${Math.min(parseFloat(usagePercent), 100)}%; background: linear-gradient(90deg, #22c55e, #16a34a); border-radius: 10px; transition: width 0.3s;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--gray-500);">
          <span>í˜„ì¬ ì‚¬ìš©: ${usagePercent}%</span>
          <span>ë‚¨ì€ ë¬¸ì„œ ê°€ëŠ¥: ì•½ ${remainingDocs.toLocaleString()}ê°œ</span>
        </div>
      </div>
      
      <!-- ë¬´ë£Œ í•œë„ ë° ì´ˆê³¼ ë¹„ìš© ì•ˆë‚´ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
        <div style="padding: 20px; background: #e0f2fe; border-radius: 12px;">
          <div style="font-weight: 600; color: var(--info); margin-bottom: 12px;">ğŸ“Œ Firebase ë¬´ë£Œ í•œë„ (Spark Plan)</div>
          <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8;">
            <div>â€¢ ì €ì¥ì†Œ: <strong>1GB</strong></div>
            <div>â€¢ ì½ê¸°: <strong>50,000ê±´/ì¼</strong></div>
            <div>â€¢ ì“°ê¸°: <strong>20,000ê±´/ì¼</strong></div>
            <div>â€¢ ì‚­ì œ: <strong>20,000ê±´/ì¼</strong></div>
          </div>
        </div>
        <div style="padding: 20px; background: #fef2f2; border-radius: 12px;">
          <div style="font-weight: 600; color: #dc2626; margin-bottom: 12px;">ğŸ’¸ ë¬´ë£Œ í•œë„ ì´ˆê³¼ ì‹œ ìš”ê¸ˆ (Blaze Plan)</div>
          <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8;">
            <div>â€¢ ì €ì¥ì†Œ: <strong>$0.18 / GBÂ·ì›”</strong></div>
            <div>â€¢ ì½ê¸°: <strong>$0.06 / 10ë§Œê±´</strong></div>
            <div>â€¢ ì“°ê¸°: <strong>$0.18 / 10ë§Œê±´</strong></div>
            <div>â€¢ ì‚­ì œ: <strong>$0.02 / 10ë§Œê±´</strong></div>
          </div>
          <div style="margin-top: 12px; padding: 10px; background: #fee2e2; border-radius: 8px; font-size: 12px; color: #991b1b;">
            ğŸ’¡ ì˜ˆì‹œ: 2GB ì‚¬ìš© ì‹œ ì•½ $0.18/ì›”, ì½ê¸° 100ë§Œê±´ ì‹œ ì•½ $0.60 ì¶”ê°€
          </div>
        </div>
      </div>
      
      <!-- ì»¬ë ‰ì…˜ë³„ ìƒì„¸ -->
      <div class="card">
        <h3 style="margin-bottom: 20px;">ğŸ“‚ ì»¬ë ‰ì…˜ë³„ ë¬¸ì„œ ìˆ˜</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          ${stats.map(s => `
            <div style="padding: 16px; background: ${s.count > 100 ? 'linear-gradient(145deg, #fff8f0, #fffbeb)' : 'var(--gray-50)'}; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;">${s.icon}</span>
                <div>
                  <div style="font-weight: 600; font-size: 14px;">${s.label}</div>
                  <div style="font-size: 11px; color: var(--gray-400);">${s.name}</div>
                </div>
              </div>
              <div style="font-size: 20px; font-weight: 700; color: ${s.count > 100 ? 'var(--primary)' : 'var(--gray-600)'};">
                ${s.error ? '-' : s.count.toLocaleString()}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <!-- ê´€ë¦¬ íŒ -->
      <div style="margin-top: 20px; padding: 20px; background: #fffbeb; border-radius: 12px; border: 1px solid rgba(252,150,0,0.2);">
        <div style="font-weight: 600; color: var(--primary); margin-bottom: 12px;">ğŸ’¡ ë°ì´í„° ê´€ë¦¬ íŒ</div>
        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--gray-600); line-height: 1.8;">
          <li>ì •ê¸°ì ìœ¼ë¡œ "ë°ì´í„° ë°±ì—…"ì„ ì‹¤í–‰í•˜ì—¬ ì¤‘ìš” ë°ì´í„°ë¥¼ ë³´ê´€í•˜ì„¸ìš”.</li>
          <li>ì˜¤ë˜ëœ ë©”ì‹œì§€ë‚˜ ì™„ë£Œëœ ê³µêµ¬ëŠ” ì •ë¦¬í•˜ì—¬ ìš©ëŸ‰ì„ í™•ë³´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>í˜„ì¬ ì‚¬ìš©ëŸ‰(${usagePercent}%)ì´ ë§¤ìš° ë‚®ì•„ ë¬´ë£Œ í•œë„ ë‚´ì—ì„œ ì¶©ë¶„íˆ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
          <li>ì •í™•í•œ ì‚¬ìš©ëŸ‰ì€ <a href="https://console.firebase.google.com" target="_blank" style="color: var(--info);">Firebase Console</a>ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</li>
        </ul>
      </div>
      
      <!-- ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ -->
      <div style="margin-top: 20px; padding: 20px; background: #f0f9ff; border-radius: 12px; border: 1px solid #bae6fd;">
        <div style="font-weight: 600; color: var(--info); margin-bottom: 12px;">ğŸ”§ ë°ì´í„° ì—°ë™ ë„êµ¬</div>
        <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">
          íŒŒíŠ¸ë„ˆí¬í„¸ì—ì„œ ì •ì‚° ë°ì´í„°ê°€ ì•ˆ ë³´ì´ëŠ” ê²½ìš°, ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê¸°ì¡´ ì •ì‚° ë°ì´í„°ì— ì—°ë™ IDë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
        </p>
        <button onclick="migrateSettlementIds()" class="btn btn-secondary" style="background: var(--info); color: white; border: none;">
          ğŸ”„ ì •ì‚° ë°ì´í„° ID ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
        </button>
      </div>
    `;
  } catch (err) {
    console.error(err);
    app.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">ğŸ’¾ ë°ì´í„° ì‚¬ìš©ëŸ‰</h1>
      </div>
      <div class="card" style="text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
        <p style="color: var(--gray-500);">ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
        <p style="font-size: 13px; color: var(--gray-400); margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°°ì§€ ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(updateInquiryBadge, 500);
});

// ==================== ì •ì‚° ë°ì´í„° ID ë§ˆì´ê·¸ë ˆì´ì…˜ ====================
// ê¸°ì¡´ ì •ì‚° ë°ì´í„°ì— supplierId, sellerIdê°€ ì—†ëŠ” ê²½ìš° ì¶”ê°€
async function migrateSettlementIds() {
  if (!confirm('ê¸°ì¡´ ì •ì‚° ë°ì´í„°ì— supplierId, sellerIdë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  let updatedCount = 0;
  const batch = db.batch();
  
  try {
    // sellerSettlements ë§ˆì´ê·¸ë ˆì´ì…˜
    const sellerSettlementsSnapshot = await db.collection('sellerSettlements').get();
    sellerSettlementsSnapshot.docs.forEach(doc => {
      const data = doc.data();
      const updates = {};
      
      // sellerIdê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!data.sellerId && data.sellerName) {
        const matchedSeller = state.sellers.find(s => s.name === data.sellerName);
        if (matchedSeller) {
          updates.sellerId = matchedSeller.id;
        }
      }
      
      // supplierIdê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!data.supplierId && data.brandName) {
        const matchedSupplier = state.suppliers.find(s => s.name === data.brandName);
        if (matchedSupplier) {
          updates.supplierId = matchedSupplier.id;
        }
      }
      
      if (Object.keys(updates).length > 0) {
        batch.update(doc.ref, updates);
        updatedCount++;
      }
    });
    
    // supplierSettlements ë§ˆì´ê·¸ë ˆì´ì…˜
    const supplierSettlementsSnapshot = await db.collection('supplierSettlements').get();
    supplierSettlementsSnapshot.docs.forEach(doc => {
      const data = doc.data();
      const updates = {};
      
      // supplierIdê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!data.supplierId && data.brandName) {
        const matchedSupplier = state.suppliers.find(s => s.name === data.brandName);
        if (matchedSupplier) {
          updates.supplierId = matchedSupplier.id;
        }
      }
      
      // sellerIdê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!data.sellerId && data.sellerName) {
        const matchedSeller = state.sellers.find(s => s.name === data.sellerName);
        if (matchedSeller) {
          updates.sellerId = matchedSeller.id;
        }
      }
      
      if (Object.keys(updates).length > 0) {
        batch.update(doc.ref, updates);
        updatedCount++;
      }
    });
    
    await batch.commit();
    showToast(`âœ… ${updatedCount}ê±´ì˜ ì •ì‚° ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    
  } catch (err) {
    console.error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', err);
    showToast('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}
</script>

<!-- ë§ˆì§„ê³„ì‚°ê¸° í€µë°°ë„ˆ -->
<div id="margin-calc-fab" onclick="openMarginCalculator()" style="position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--primary); color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(252,150,0,0.4); z-index: 999; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
  ğŸ§®
</div>
<div id="margin-calc-label" onclick="openMarginCalculator()" style="position: fixed; bottom: 88px; right: 24px; background: var(--gray-900); color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 999; display: none;">
  ë§ˆì§„ê³„ì‚°ê¸°
</div>

</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI ÌöåÏùòÏö© Î∑∞ - Ï†ÑÎûµÏÑºÌÑ∞</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #6366F1;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --gray-50: #f9fafb;
      --gray-100: #f2f4f6;
      --gray-200: #e5e8eb;
      --gray-300: #d1d6db;
      --gray-400: #b0b8c1;
      --gray-500: #8b95a1;
      --gray-600: #6b7684;
      --gray-700: #4e5968;
      --gray-800: #333d4b;
      --gray-900: #191f28;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: white;
    }
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 20px;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .container {
      padding: 40px;
      max-width: 1600px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .header h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 16px;
    }
    .header .rate {
      font-size: 72px;
      font-weight: 900;
      background: linear-gradient(135deg, #6366F1, #8B5CF6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header .period {
      margin-top: 12px;
      opacity: 0.7;
      font-size: 14px;
    }
    .toolbar {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 30px;
    }
    .toolbar button {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .toolbar button:hover {
      background: rgba(255,255,255,0.2);
    }
    .toolbar button.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    .kr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
    }
    .kr-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 24px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .kr-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .kr-name {
      font-size: 16px;
      font-weight: 700;
    }
    .kr-rate {
      font-size: 28px;
      font-weight: 800;
    }
    .kpi-item {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .kpi-item:last-child {
      margin-bottom: 0;
    }
    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .kpi-name {
      font-size: 14px;
      font-weight: 600;
    }
    .kpi-rate {
      font-size: 18px;
      font-weight: 700;
    }
    .progress-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    .metric-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 12px;
    }
    .metric-section.input {
      border-left: 3px solid #64748b;
    }
    .metric-section.output {
      border-left: 3px solid #10B981;
    }
    .metric-label {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: 0.8;
    }
    .metric-item {
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      justify-content: space-between;
    }
    .metric-item:last-child {
      border-bottom: none;
    }
    .metric-value {
      font-weight: 700;
    }
    .metric-version {
      font-size: 10px;
      opacity: 0.6;
    }
    .ab-badge {
      font-size: 9px;
      padding: 2px 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      margin-right: 4px;
    }
    .footer {
      text-align: center;
      padding: 30px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 40px;
      font-size: 13px;
      opacity: 0.6;
    }
    .mindmap-view {
      display: none;
    }
    .mindmap-view.active {
      display: block;
    }
    .list-view {
      display: block;
    }
    .list-view.hidden {
      display: none;
    }
    /* ÎßàÏù∏ÎìúÎßµ Ïä§ÌÉÄÏùº */
    .mindmap-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      padding: 40px;
    }
    .mindmap-objective {
      background: linear-gradient(135deg, var(--primary), #8B5CF6);
      color: white;
      padding: 30px 50px;
      border-radius: 24px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
      max-width: 700px;
    }
    .mindmap-connection {
      width: 4px;
      height: 50px;
      background: linear-gradient(to bottom, var(--primary), rgba(255,255,255,0.2));
    }
    .mindmap-kr-container {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .mindmap-kr {
      min-width: 300px;
      max-width: 400px;
      flex: 1;
    }
    .mindmap-kr-card {
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .mindmap-kpi-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .mindmap-kpi {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px;
      text-align: left;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .color-0 { --kr-color: #8B5CF6; }
    .color-1 { --kr-color: #06B6D4; }
    .color-2 { --kr-color: #10B981; }
    .color-3 { --kr-color: #F59E0B; }
    @media print {
      body {
        background: white;
        color: black;
      }
      .toolbar {
        display: none;
      }
      .kr-card {
        border: 1px solid #ddd;
        background: white;
      }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>KPI Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
  </div>

  <div id="content" class="container" style="display: none;">
    <div class="header" id="headerContent"></div>

    <div class="toolbar">
      <button id="btnListView" class="active" onclick="switchView('list')">üìä Î¶¨Ïä§Ìä∏ Î∑∞</button>
      <button id="btnMindmapView" onclick="switchView('mindmap')">üó∫Ô∏è ÎßàÏù∏ÎìúÎßµ Î∑∞</button>
      <button onclick="window.print()">üñ®Ô∏è Ïù∏ÏáÑ</button>
      <button onclick="location.reload()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
      <button onclick="window.close()">‚úï Îã´Í∏∞</button>
    </div>

    <div id="listView" class="list-view">
      <div class="kr-grid" id="krGrid"></div>
    </div>

    <div id="mindmapView" class="mindmap-view">
      <div id="mindmapContent" class="mindmap-container"></div>
    </div>

    <div class="footer" id="footerContent"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase Ï¥àÍ∏∞Ìôî
    const firebaseConfig = {
      apiKey: "AIzaSyCU06n4f_v8IuKO6-Xz35Dv0_n3UaYqQys",
      authDomain: "moyeora-deal-manager.firebaseapp.com",
      projectId: "moyeora-deal-manager",
      storageBucket: "moyeora-deal-manager.firebasestorage.app",
      messagingSenderId: "988148282408",
      appId: "1:988148282408:web:0eb2bf3d57c86cd6fc70f9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ÏÉÅÌÉú
    let okrData = {
      objective: null,
      keyResults: [],
      kpis: [],
      totalMetrics: [],      // Ï¥ù ÏÑ±Í≥ºÏßÄÌëú (NEW)
      laggingIndicators: [],  // ÏÑ±Í≥ºÏßÄÌëú(Îã®ÏúÑÎ≥Ñ)
      subIndicators: [],     // ÌïòÏúÑÏßÄÌëú (NEW)
      dailyLogs: []
    };

    const okrColors = ['#8B5CF6', '#06B6D4', '#10B981', '#F59E0B'];
    const okrIcons = ['üí∞', 'üë•', 'üì±', 'üì¢'];

    // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    async function loadData() {
      try {
        // Î™©Ìëú
        const objSnapshot = await db.collection('okr_objective').limit(1).get();
        okrData.objective = objSnapshot.docs.length > 0
          ? { id: objSnapshot.docs[0].id, ...objSnapshot.docs[0].data() }
          : null;

        // KR
        const krSnapshot = await db.collection('okr_keyResults').orderBy('order').get();
        okrData.keyResults = krSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // KPI
        const kpiSnapshot = await db.collection('okr_kpis').orderBy('order').get();
        okrData.kpis = kpiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Ï¥ù ÏÑ±Í≥ºÏßÄÌëú (NEW)
        const totalMetricsSnapshot = await db.collection('okr_totalMetrics').get();
        okrData.totalMetrics = totalMetricsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ÏÑ±Í≥ºÏßÄÌëú(Îã®ÏúÑÎ≥Ñ) - Í∏∞Ï°¥ laggingIndicators
        const lagSnapshot = await db.collection('okr_laggingIndicators').get();
        okrData.laggingIndicators = lagSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ÌïòÏúÑÏßÄÌëú (NEW)
        const subIndicatorsSnapshot = await db.collection('okr_subIndicators').get();
        okrData.subIndicators = subIndicatorsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ÏóÖÎ¨¥ÏùºÏßÄ (ÏµúÍ∑º 30Ïùº)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const logSnapshot = await db.collection('okr_dailyLogs')
          .where('date', '>=', thirtyDaysAgo.toISOString().split('T')[0])
          .orderBy('date', 'desc')
          .get();
        okrData.dailyLogs = logSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        renderContent();
      } catch (error) {
        console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
        document.getElementById('loading').innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <div>Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</div>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">Îã§Ïãú ÏãúÎèÑ</button>
          </div>
        `;
      }
    }

    // KPI Îã¨ÏÑ±Î•† Í≥ÑÏÇ∞
    function calcKPIRate(kpiId) {
      const kpi = okrData.kpis.find(k => k.id === kpiId);
      if (!kpi || !kpi.targetValue) return 0;

      // ÏÉàÎ°úÏö¥ Í≥ÑÏ∏µ Íµ¨Ï°∞ ÌôïÏù∏: Ï¥ù ÏÑ±Í≥ºÏßÄÌëúÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
      const totalMetricsForKPI = okrData.totalMetrics.filter(tm => tm.kpiId === kpiId);

      if (totalMetricsForKPI.length > 0) {
        // ÏÉà Íµ¨Ï°∞: Ï¥ù ÏÑ±Í≥ºÏßÄÌëúÎì§Ïùò ÌèâÍ∑† Îã¨ÏÑ±Î•†
        const rates = totalMetricsForKPI.map(tm => parseFloat(calcTotalMetricRate(tm.id)));
        const avgRate = rates.reduce((a, b) => a + b, 0) / rates.length;
        return Math.round(avgRate);
      }

      // Í∏∞Ï°¥ Íµ¨Ï°∞: ÏÑ±Í≥ºÌòï(output) ÏßÄÌëúÎßå KPI Îã¨ÏÑ±Î•†Ïóê Î∞òÏòÅ
      const resultLags = okrData.laggingIndicators.filter(l => l.kpiId === kpiId && l.type === 'output');

      const totalValue = resultLags.reduce((sum, lag) => {
        const logs = okrData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
        const logSum = logs.reduce((s, l) => s + (l.resultValue || 0), 0);

        // Í±¥Îãπ ÏòàÏÉÅ Í∏àÏï°Ïù¥ ÏûàÏúºÎ©¥ Ï†ÅÏö©
        if (lag.valuePerUnit && lag.valuePerUnit > 0) {
          return sum + (logSum * lag.valuePerUnit);
        }
        return sum + logSum;
      }, 0);

      return Math.round(Math.min((totalValue / kpi.targetValue) * 100, 100));
    }

    // Ï¥ù ÏÑ±Í≥ºÏßÄÌëú Îã¨ÏÑ±Î•† Í≥ÑÏÇ∞ (NEW) - Îã®ÏúÑÎ≥Ñ ÏÑ±Í≥ºÏßÄÌëúÎì§Ïùò ÌèâÍ∑†
    function calcTotalMetricRate(totalMetricId) {
      const totalMetric = okrData.totalMetrics.find(tm => tm.id === totalMetricId);
      if (!totalMetric) return 0;

      // Ìï¥Îãπ Ï¥ù ÏÑ±Í≥ºÏßÄÌëúÏóê Ïó∞Í≤∞Îêú ÏÑ±Í≥ºÏßÄÌëú(Îã®ÏúÑÎ≥Ñ)Îì§
      const unitMetrics = okrData.laggingIndicators.filter(l => l.totalMetricId === totalMetricId && l.type === 'output');

      if (unitMetrics.length === 0) return 0;

      const rates = unitMetrics.map(um => parseFloat(calcUnitMetricRate(um.id)));
      const avgRate = rates.reduce((a, b) => a + b, 0) / rates.length;
      return avgRate.toFixed(2);
    }

    // ÏÑ±Í≥ºÏßÄÌëú(Îã®ÏúÑÎ≥Ñ) Îã¨ÏÑ±Î•† Í≥ÑÏÇ∞ (NEW)
    function calcUnitMetricRate(lagId) {
      const lag = okrData.laggingIndicators.find(l => l.id === lagId);
      if (!lag) return 0;

      // ÌïòÏúÑÏßÄÌëúÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
      const subIndicators = okrData.subIndicators.filter(si => si.laggingIndicatorId === lagId);

      if (subIndicators.length > 0) {
        // ÌïòÏúÑÏßÄÌëúÎì§Ïùò Ìï©Í≥Ñ
        const totalValue = subIndicators.reduce((sum, si) => {
          return sum + calcSubIndicatorValue(si.id);
        }, 0);

        // Í±¥Îãπ ÏòàÏÉÅ Í∏àÏï° Ï†ÅÏö©
        if (lag.valuePerUnit && lag.valuePerUnit > 0) {
          const kpi = okrData.kpis.find(k => k.id === lag.kpiId);
          if (kpi && kpi.targetValue) {
            return Math.min((totalValue * lag.valuePerUnit / kpi.targetValue) * 100, 100).toFixed(2);
          }
        }
        return totalValue;
      }

      // Í∏∞Ï°¥ Íµ¨Ï°∞: ÏßÅÏ†ë dailyLogsÏóêÏÑú Í≥ÑÏÇ∞
      const logs = okrData.dailyLogs.filter(l => l.laggingIndicatorId === lagId);
      const logSum = logs.reduce((s, l) => s + (l.resultValue || 0), 0);

      // Í±¥Îãπ ÏòàÏÉÅ Í∏àÏï° Ï†ÅÏö©
      if (lag.valuePerUnit && lag.valuePerUnit > 0) {
        const kpi = okrData.kpis.find(k => k.id === lag.kpiId);
        if (kpi && kpi.targetValue) {
          return Math.min((logSum * lag.valuePerUnit / kpi.targetValue) * 100, 100).toFixed(2);
        }
      }

      return logSum;
    }

    // ÌïòÏúÑÏßÄÌëú Í∞í Í≥ÑÏÇ∞ (NEW)
    function calcSubIndicatorValue(subIndicatorId) {
      const subIndicator = okrData.subIndicators.find(si => si.id === subIndicatorId);
      if (!subIndicator) return 0;

      // Ìï¥Îãπ ÌïòÏúÑÏßÄÌëúÏóê Ïó∞Í≤∞Îêú ÏóÖÎ¨¥ÏùºÏßÄ Ìï©Í≥Ñ
      const logs = okrData.dailyLogs.filter(l => l.subIndicatorId === subIndicatorId);
      return logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
    }

    // ÏÑ±Í≥ºÏßÄÌëú(Îã®ÏúÑÎ≥Ñ)Ïùò Ï¥ù Í∞í Í≥ÑÏÇ∞ (NEW)
    function calcUnitMetricValue(lagId) {
      const lag = okrData.laggingIndicators.find(l => l.id === lagId);
      if (!lag) return 0;

      // ÌïòÏúÑÏßÄÌëúÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
      const subIndicators = okrData.subIndicators.filter(si => si.laggingIndicatorId === lagId);

      if (subIndicators.length > 0) {
        return subIndicators.reduce((sum, si) => sum + calcSubIndicatorValue(si.id), 0);
      }

      // Í∏∞Ï°¥ Íµ¨Ï°∞: ÏßÅÏ†ë dailyLogsÏóêÏÑú Í≥ÑÏÇ∞
      const logs = okrData.dailyLogs.filter(l => l.laggingIndicatorId === lagId);
      return logs.reduce((s, l) => s + (l.resultValue || 0), 0);
    }

    // KR Îã¨ÏÑ±Î•† Í≥ÑÏÇ∞
    function calcKRRate(krId) {
      const kpisForKR = okrData.kpis.filter(kpi => kpi.keyResultId === krId);
      if (kpisForKR.length === 0) return 0;
      const rates = kpisForKR.map(kpi => calcKPIRate(kpi.id));
      return Math.round(rates.reduce((a, b) => a + b, 0) / rates.length);
    }

    // Î™©Ìëú Îã¨ÏÑ±Î•† Í≥ÑÏÇ∞
    function calcObjectiveRate() {
      if (okrData.keyResults.length === 0) return 0;
      const rates = okrData.keyResults.map(kr => calcKRRate(kr.id));
      return Math.round(rates.reduce((a, b) => a + b, 0) / rates.length);
    }

    // Í∏àÏï° Ìè¨Îß∑
    function formatKoreanAmount(num) {
      if (!num || num === 0) return '';
      const absNum = Math.abs(num);
      if (absNum >= 100000000) return (absNum / 100000000).toFixed(1) + 'Ïñµ';
      if (absNum >= 10000000) return (absNum / 10000000).toFixed(1) + 'Ï≤úÎßå';
      if (absNum >= 1000000) return (absNum / 1000000).toFixed(1) + 'Î∞±Îßå';
      if (absNum >= 10000) return (absNum / 10000).toFixed(1) + 'Îßå';
      return num.toLocaleString();
    }

    // Î†åÎçîÎßÅ
    function renderContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      if (!okrData.objective) {
        document.getElementById('content').innerHTML = `
          <div style="text-align: center; padding: 100px;">
            <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
            <div style="font-size: 24px; font-weight: 600;">ÏÑ§Ï†ïÎêú Î™©ÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
            <div style="margin-top: 12px; opacity: 0.7;">Ï†ÑÎûµÏÑºÌÑ∞ÏóêÏÑú Î™©ÌëúÎ•º Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî</div>
          </div>
        `;
        return;
      }

      const oRate = calcObjectiveRate();

      // Ìó§Îçî
      document.getElementById('headerContent').innerHTML = `
        <h1>üéØ ${okrData.objective.name}</h1>
        <div class="rate">${oRate}%</div>
        <p class="period">${okrData.objective.startDate || ''} ~ ${okrData.objective.endDate || ''}</p>
      `;

      // Î¶¨Ïä§Ìä∏ Î∑∞
      renderListView();

      // ÎßàÏù∏ÎìúÎßµ Î∑∞
      renderMindmapView();

      // Ìë∏ÌÑ∞
      document.getElementById('footerContent').innerHTML = `
        ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: ${new Date().toLocaleString('ko-KR')} | Ï†ÑÎûµÏÑºÌÑ∞ KPI ÌöåÏùòÏö© Î∑∞
      `;
    }

    // Î¶¨Ïä§Ìä∏ Î∑∞ Î†åÎçîÎßÅ
    function renderListView() {
      const grid = document.getElementById('krGrid');
      grid.innerHTML = okrData.keyResults.map((kr, krIdx) => {
        const krRate = calcKRRate(kr.id);
        const kpisForKR = okrData.kpis.filter(kpi => kpi.keyResultId === kr.id);

        return `
          <div class="kr-card" style="border-top: 4px solid ${okrColors[krIdx]};">
            <div class="kr-header">
              <div class="kr-name">${okrIcons[krIdx]} ${kr.name}</div>
              <div class="kr-rate" style="color: ${okrColors[krIdx]};">${krRate}%</div>
            </div>
            ${kpisForKR.map(kpi => {
              const kpiRate = calcKPIRate(kpi.id);
              const statusColor = kpiRate >= 80 ? '#10B981' : kpiRate >= 50 ? '#F59E0B' : '#EF4444';

              // ÏÉàÎ°úÏö¥ Í≥ÑÏ∏µ Íµ¨Ï°∞ ÌôïÏù∏
              const totalMetricsForKPI = okrData.totalMetrics.filter(tm => tm.kpiId === kpi.id);
              const hasNewStructure = totalMetricsForKPI.length > 0;

              return `
                <div class="kpi-item">
                  <div class="kpi-header">
                    <div class="kpi-name">üìå ${kpi.name}</div>
                    <div class="kpi-rate" style="color: ${statusColor};">${kpiRate}%</div>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(kpiRate, 100)}%; background: ${statusColor};"></div>
                  </div>

                  ${hasNewStructure ? `
                    <!-- ÏÉà Íµ¨Ï°∞: Ï¥ù ÏÑ±Í≥ºÏßÄÌëú Í∏∞Î∞ò -->
                    ${totalMetricsForKPI.map(tm => {
                      const tmRate = calcTotalMetricRate(tm.id);
                      const tmStatusColor = tmRate >= 80 ? '#10B981' : tmRate >= 50 ? '#F59E0B' : '#EF4444';
                      const unitMetrics = okrData.laggingIndicators.filter(l => l.totalMetricId === tm.id && l.type === 'output');

                      return `
                        <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-top: 12px;">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 12px; font-weight: 600; opacity: 0.9;">üìä ${tm.name} (Ï¥ù ÏÑ±Í≥ºÏßÄÌëú)</div>
                            <span style="font-size: 13px; font-weight: 700; color: ${tmStatusColor};">${tmRate}%</span>
                          </div>

                          ${unitMetrics.map(um => {
                            const umValue = calcUnitMetricValue(um.id);
                            const subInds = okrData.subIndicators.filter(si => si.laggingIndicatorId === um.id);

                            return `
                              <div style="background: rgba(255,255,255,0.08); border-radius: 6px; padding: 10px; margin-bottom: 8px; border-left: 3px solid ${okrColors[krIdx]};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${subInds.length > 0 ? '8px' : '0'};">
                                  <span style="font-size: 11px; font-weight: 600;"><span class="ab-badge">${um.version || 'A'}</span>${um.name}</span>
                                  <span style="font-size: 12px; font-weight: 700; color: #10B981;">${formatKoreanAmount(umValue) || umValue.toLocaleString()}</span>
                                </div>

                                ${subInds.length > 0 ? `
                                  <!-- ÌïòÏúÑÏßÄÌëú -->
                                  <div style="margin-left: 12px; padding-left: 12px; border-left: 2px solid rgba(255,255,255,0.2);">
                                    ${subInds.map(si => {
                                      const siValue = calcSubIndicatorValue(si.id);
                                      return `
                                        <div style="display: flex; justify-content: space-between; font-size: 10px; opacity: 0.8; margin-bottom: 4px;">
                                          <span>‚îî ${si.name}</span>
                                          <span style="font-weight: 600;">${siValue.toLocaleString()}</span>
                                        </div>
                                      `;
                                    }).join('')}
                                  </div>
                                ` : ''}
                              </div>
                            `;
                          }).join('')}
                        </div>
                      `;
                    }).join('')}
                  ` : `
                    <!-- Í∏∞Ï°¥ Íµ¨Ï°∞: Input/Output Metrics -->
                    <div class="metrics-grid" style="margin-top: 12px;">
                      ${(() => {
                        const metrics = okrData.laggingIndicators.filter(l => l.kpiId === kpi.id);
                        const inputMetrics = metrics.filter(l => l.type !== 'output');
                        const outputMetrics = metrics.filter(l => l.type === 'output');

                        return `
                          <div class="metric-section input">
                            <div class="metric-label">üì• Input Metrics (${inputMetrics.length})</div>
                            ${inputMetrics.length > 0 ? inputMetrics.map(m => {
                              const logs = okrData.dailyLogs.filter(l => l.laggingIndicatorId === m.id);
                              const total = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                              return `
                                <div class="metric-item">
                                  <span><span class="ab-badge">${m.version || 'A'}</span>${m.name}</span>
                                  <span class="metric-value">${total.toLocaleString()}</span>
                                </div>
                              `;
                            }).join('') : '<div style="font-size: 11px; opacity: 0.5;">ÏóÜÏùå</div>'}
                          </div>
                          <div class="metric-section output">
                            <div class="metric-label" style="color: #10B981;">üì§ Output Metrics (${outputMetrics.length})</div>
                            ${outputMetrics.length > 0 ? outputMetrics.map(m => {
                              const logs = okrData.dailyLogs.filter(l => l.laggingIndicatorId === m.id);
                              const total = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                              return `
                                <div class="metric-item">
                                  <span><span class="ab-badge">${m.version || 'A'}</span>${m.name}</span>
                                  <span class="metric-value" style="color: #10B981;">${formatKoreanAmount(total) || total.toLocaleString()}</span>
                                </div>
                              `;
                            }).join('') : '<div style="font-size: 11px; opacity: 0.5;">ÏóÜÏùå</div>'}
                          </div>
                        `;
                      })()}
                    </div>
                  `}
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).join('');
    }

    // ÎßàÏù∏ÎìúÎßµ Î∑∞ Î†åÎçîÎßÅ
    function renderMindmapView() {
      const container = document.getElementById('mindmapContent');
      const oRate = calcObjectiveRate();

      container.innerHTML = `
        <!-- Î™©Ìëú -->
        <div class="mindmap-objective">
          <div style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">üéØ Î™©Ìëú</div>
          <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">${okrData.objective.name}</div>
          <div style="font-size: 48px; font-weight: 900;">${oRate}%</div>
        </div>

        <div class="mindmap-connection"></div>

        <!-- Î©îÏù∏ KPIÎì§ -->
        <div class="mindmap-kr-container">
          ${okrData.keyResults.map((kr, krIdx) => {
            const krRate = calcKRRate(kr.id);
            const kpisForKR = okrData.kpis.filter(kpi => kpi.keyResultId === kr.id);

            return `
              <div class="mindmap-kr color-${krIdx}">
                <div class="mindmap-kr-card" style="background: ${okrColors[krIdx]}20; border: 2px solid ${okrColors[krIdx]};">
                  <div style="font-size: 11px; color: ${okrColors[krIdx]}; font-weight: 600; margin-bottom: 6px;">Î©îÏù∏ KPI ${krIdx + 1}</div>
                  <div style="font-size: 15px; font-weight: 700; margin-bottom: 8px;">${okrIcons[krIdx]} ${kr.name}</div>
                  <div style="font-size: 28px; font-weight: 800; color: ${okrColors[krIdx]};">${krRate}%</div>
                </div>

                <div class="mindmap-kpi-list">
                  ${kpisForKR.map(kpi => {
                    const kpiRate = calcKPIRate(kpi.id);
                    const statusColor = kpiRate >= 80 ? '#10B981' : kpiRate >= 50 ? '#F59E0B' : '#EF4444';

                    // ÏÉàÎ°úÏö¥ Í≥ÑÏ∏µ Íµ¨Ï°∞ ÌôïÏù∏
                    const totalMetricsForKPI = okrData.totalMetrics.filter(tm => tm.kpiId === kpi.id);
                    const hasNewStructure = totalMetricsForKPI.length > 0;

                    return `
                      <div class="mindmap-kpi" style="border-left: 4px solid ${okrColors[krIdx]};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                          <div style="font-size: 13px; font-weight: 600;">üìå ${kpi.name}</div>
                          <span style="font-size: 16px; font-weight: 700; color: ${statusColor};">${kpiRate}%</span>
                        </div>

                        ${hasNewStructure ? `
                          <!-- ÏÉà Íµ¨Ï°∞: 4Îã®Í≥Ñ Í≥ÑÏ∏µ (KPI ‚Üí Ï¥ù ÏÑ±Í≥ºÏßÄÌëú ‚Üí ÏÑ±Í≥ºÏßÄÌëú(Îã®ÏúÑÎ≥Ñ) ‚Üí ÌïòÏúÑÏßÄÌëú) -->
                          ${totalMetricsForKPI.map(tm => {
                            const tmRate = calcTotalMetricRate(tm.id);
                            const tmStatusColor = tmRate >= 80 ? '#10B981' : tmRate >= 50 ? '#F59E0B' : '#EF4444';
                            const unitMetrics = okrData.laggingIndicators.filter(l => l.totalMetricId === tm.id && l.type === 'output');

                            return `
                              <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                  <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.9);">üìä ${tm.name}</div>
                                  <span style="font-size: 12px; font-weight: 700; color: ${tmStatusColor};">${tmRate}%</span>
                                </div>

                                ${unitMetrics.map(um => {
                                  const umValue = calcUnitMetricValue(um.id);
                                  const subInds = okrData.subIndicators.filter(si => si.laggingIndicatorId === um.id);

                                  return `
                                    <div style="background: rgba(255,255,255,0.08); border-radius: 6px; padding: 8px; margin-bottom: 6px; border-left: 3px solid ${okrColors[krIdx]};">
                                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${subInds.length > 0 ? '6px' : '0'};">
                                        <span style="font-size: 10px; color: #D1D5DB;">[${um.version || 'A'}] ${um.name.length > 12 ? um.name.substring(0, 12) + '...' : um.name}</span>
                                        <span style="font-size: 11px; font-weight: 700; color: #10B981;">${formatKoreanAmount(umValue) || umValue}</span>
                                      </div>

                                      ${subInds.length > 0 ? `
                                        <!-- ÌïòÏúÑÏßÄÌëú -->
                                        <div style="margin-left: 8px; padding-left: 8px; border-left: 2px solid rgba(255,255,255,0.2);">
                                          ${subInds.slice(0, 3).map(si => {
                                            const siValue = calcSubIndicatorValue(si.id);
                                            return `
                                              <div style="font-size: 9px; color: rgba(255,255,255,0.7); display: flex; justify-content: space-between; margin-bottom: 3px;">
                                                <span>‚îî ${si.name.length > 10 ? si.name.substring(0, 10) + '...' : si.name}</span>
                                                <span style="font-weight: 600;">${siValue}</span>
                                              </div>
                                            `;
                                          }).join('')}
                                          ${subInds.length > 3 ? `<div style="font-size: 9px; color: rgba(255,255,255,0.5);">+${subInds.length - 3}Í∞ú Îçî</div>` : ''}
                                        </div>
                                      ` : ''}
                                    </div>
                                  `;
                                }).join('')}
                              </div>
                            `;
                          }).join('')}
                        ` : `
                          <!-- Í∏∞Ï°¥ Íµ¨Ï°∞: Input/Output Metrics -->
                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            ${(() => {
                              const metrics = okrData.laggingIndicators.filter(l => l.kpiId === kpi.id);
                              const inputMetrics = metrics.filter(l => l.type !== 'output');
                              const outputMetrics = metrics.filter(l => l.type === 'output');

                              return `
                                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px;">
                                  <div style="font-size: 10px; font-weight: 600; color: #9CA3AF; margin-bottom: 6px;">üì• Input (${inputMetrics.length})</div>
                                  ${inputMetrics.slice(0, 3).map(m => {
                                    const logs = okrData.dailyLogs.filter(l => l.laggingIndicatorId === m.id);
                                    const total = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                                    return `<div style="font-size: 11px; color: #D1D5DB; margin-bottom: 4px; display: flex; justify-content: space-between;">
                                      <span>[${m.version || 'A'}] ${m.name.length > 8 ? m.name.substring(0, 8) + '...' : m.name}</span>
                                      <span style="font-weight: 600;">${total}</span>
                                    </div>`;
                                  }).join('')}
                                  ${inputMetrics.length > 3 ? `<div style="font-size: 10px; opacity: 0.5;">+${inputMetrics.length - 3}Í∞ú Îçî</div>` : ''}
                                  ${inputMetrics.length === 0 ? '<div style="font-size: 10px; opacity: 0.5;">-</div>' : ''}
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 10px;">
                                  <div style="font-size: 10px; font-weight: 600; color: #10B981; margin-bottom: 6px;">üì§ Output (${outputMetrics.length})</div>
                                  ${outputMetrics.slice(0, 3).map(m => {
                                    const logs = okrData.dailyLogs.filter(l => l.laggingIndicatorId === m.id);
                                    const total = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                                    return `<div style="font-size: 11px; color: #D1D5DB; margin-bottom: 4px; display: flex; justify-content: space-between;">
                                      <span>[${m.version || 'A'}] ${m.name.length > 8 ? m.name.substring(0, 8) + '...' : m.name}</span>
                                      <span style="font-weight: 700; color: #10B981;">${formatKoreanAmount(total) || total}</span>
                                    </div>`;
                                  }).join('')}
                                  ${outputMetrics.length > 3 ? `<div style="font-size: 10px; opacity: 0.5;">+${outputMetrics.length - 3}Í∞ú Îçî</div>` : ''}
                                  ${outputMetrics.length === 0 ? '<div style="font-size: 10px; opacity: 0.5;">-</div>' : ''}
                                </div>
                              `;
                            })()}
                          </div>
                        `}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Î∑∞ Ï†ÑÌôò
    function switchView(view) {
      const listView = document.getElementById('listView');
      const mindmapView = document.getElementById('mindmapView');
      const btnList = document.getElementById('btnListView');
      const btnMindmap = document.getElementById('btnMindmapView');

      if (view === 'list') {
        listView.classList.remove('hidden');
        mindmapView.classList.remove('active');
        btnList.classList.add('active');
        btnMindmap.classList.remove('active');
      } else {
        listView.classList.add('hidden');
        mindmapView.classList.add('active');
        btnList.classList.remove('active');
        btnMindmap.classList.add('active');
      }
    }

    // Ï¥àÍ∏∞Ìôî
    loadData();
  </script>
</body>
</html>

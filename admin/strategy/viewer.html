<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê·¸ë¡œìŠ¤ë³´ë“œ - ì½ê¸° ì „ìš©</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #F8FAFC;
      min-height: 100vh;
    }
    :root {
      --primary: #2563EB;
      --purple: #6366F1;
      --green: #10B981;
      --yellow: #F59E0B;
      --red: #EF4444;
      --gray-50: #F8FAFC;
      --gray-100: #F1F5F9;
      --gray-200: #E2E8F0;
      --gray-300: #CBD5E1;
      --gray-500: #64748B;
      --gray-700: #334155;
      --gray-900: #0F172A;
      --white: #FFFFFF;
    }
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .header {
      background: linear-gradient(135deg, var(--purple), #8B5CF6);
      color: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 20px;
      font-weight: 700;
    }
    .header .badge {
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    .kpi-folder {
      background: var(--white);
      border-radius: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    .kpi-folder-header {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .kpi-folder-header:hover {
      background: var(--gray-50);
    }
    .kpi-folder-toggle {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      color: var(--gray-500);
      transition: transform 0.2s;
    }
    .kpi-folder-toggle.open {
      transform: rotate(90deg);
    }
    .kpi-folder-content {
      display: none;
    }
    .kpi-folder-content.show {
      display: block;
    }
    .refresh-notice {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--gray-900);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-screen">
    <div class="loading-spinner"></div>
    <div style="margin-top: 20px; color: var(--gray-500);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>

  <div id="error" class="error-screen" style="display: none;">
    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ”’</div>
    <div style="font-size: 20px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</div>
    <div style="color: var(--gray-500);">ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë¹„í™œì„±í™”ëœ ë§í¬ì…ë‹ˆë‹¤</div>
  </div>

  <div id="app" style="display: none;">
    <div class="header">
      <div>
        <h1>ğŸ“Š ê·¸ë¡œìŠ¤ë³´ë“œ</h1>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">ë©”ì¸ KPI â†’ ì„œë¸Œ KPI â†’ ì„ í–‰ì§€í‘œ â†’ ë‚´ ì„ í–‰ì§€í‘œ</div>
      </div>
      <div class="badge">ğŸ”’ ì½ê¸° ì „ìš©</div>
    </div>
    <div class="container" id="content"></div>
    <div class="refresh-notice">
      <div class="live-dot"></div>
      ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDxNqXrXPNentBcVde0rweuwqJHWLyI-p8",
      authDomain: "moyeoradeal.firebaseapp.com",
      projectId: "moyeoradeal",
      storageBucket: "moyeoradeal.firebasestorage.app",
      messagingSenderId: "568249498736",
      appId: "1:568249498736:web:7d6bf89706f3ed73463c1e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ìµëª… ì¸ì¦
    async function signInAnonymously() {
      try {
        await auth.signInAnonymously();
        console.log('ìµëª… ì¸ì¦ ì„±ê³µ');
        return true;
      } catch (e) {
        console.error('ìµëª… ì¸ì¦ ì‹¤íŒ¨:', e);
        return false;
      }
    }

    // ìƒíƒœ
    let state = {
      megaProjects: [],
      projects: [],
      teamKPIs: [],
      memberKPIs: [],
      isValid: false
    };

    // ìƒ‰ìƒ ìƒìˆ˜
    const C = {
      primary: '#2563EB',
      purple: '#6366F1',
      green: '#10B981',
      yellow: '#F59E0B',
      red: '#EF4444',
      gray50: '#F8FAFC',
      gray100: '#F1F5F9',
      gray200: '#E2E8F0',
      gray300: '#CBD5E1',
      gray500: '#64748B',
      gray700: '#334155',
      gray900: '#0F172A',
      white: '#FFFFFF'
    };

    // ë‹¨ìœ„ íƒ€ì… í—¬í¼
    const KPI_UNIT_TYPES = {
      revenue: { label: 'ë§¤ì¶œì•¡', unit: 'ì–µ', suffix: 'ì–µ' },
      percent: { label: 'í¼ì„¼íŠ¸', unit: '%', suffix: '%' },
      count: { label: 'ê°œìˆ˜', unit: 'ê°œ', suffix: 'ê°œ' },
      case: { label: 'ê±´ìˆ˜', unit: 'ê±´', suffix: 'ê±´' },
      won: { label: 'ê¸ˆì•¡', unit: 'ë§Œì›', suffix: 'ë§Œì›' }
    };

    function getTargetUnitInfo(unitType) {
      return KPI_UNIT_TYPES[unitType] || KPI_UNIT_TYPES.revenue;
    }

    function formatTargetValue(value, unitType) {
      const info = getTargetUnitInfo(unitType);
      if (value === null || value === undefined || value === 0) return '-';
      if (unitType === 'percent') return `${value}%`;
      return `${value}${info.suffix}`;
    }

    // URLì—ì„œ í† í° ì¶”ì¶œ
    function getTokenFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('token');
    }

    // í† í° ê²€ì¦
    async function validateToken(token) {
      if (!token) {
        console.log('í† í°ì´ ì—†ìŠµë‹ˆë‹¤');
        return false;
      }
      try {
        console.log('í† í° ê²€ì¦ ì‹œì‘:', token);

        // í† í°ìœ¼ë¡œ ë¨¼ì € ì¡°íšŒ
        const snapshot = await db.collection('secretLinks')
          .where('token', '==', token)
          .get();

        console.log('ì¿¼ë¦¬ ê²°ê³¼:', snapshot.size, 'ê°œ');

        if (snapshot.empty) {
          console.log('í† í°ì— í•´ë‹¹í•˜ëŠ” ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤');
          return false;
        }

        const doc = snapshot.docs[0];
        const data = doc.data();
        console.log('ë§í¬ ë°ì´í„°:', data);

        // í™œì„± ìƒíƒœ í™•ì¸
        if (!data.isActive) {
          console.log('ë§í¬ê°€ ë¹„í™œì„±í™” ìƒíƒœì…ë‹ˆë‹¤');
          return false;
        }

        // ì¡°íšŒìˆ˜ ì¦ê°€
        await db.collection('secretLinks').doc(doc.id).update({
          viewCount: firebase.firestore.FieldValue.increment(1),
          lastViewedAt: new Date().toISOString()
        });

        console.log('í† í° ê²€ì¦ ì„±ê³µ');
        return true;
      } catch (e) {
        console.error('í† í° ê²€ì¦ ì˜¤ë¥˜:', e);
        return false;
      }
    }

    // ë°ì´í„° ë¡œë“œ ë° ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë‹
    function loadData() {
      // ë©”ì¸ KPI
      db.collection('megaProjects').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.megaProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      // ì„œë¸Œ KPI
      db.collection('projects').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      // ì„ í–‰ì§€í‘œ
      db.collection('teamKPIs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.teamKPIs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      // ë‚´ ì„ í–‰ì§€í‘œ
      db.collection('memberKPIs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.memberKPIs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });
    }

    // ì§„í–‰ë¥  ê³„ì‚°
    function calculateProjectProgress(teamKPIs, memberKPIs) {
      if (teamKPIs.length === 0) return 0;
      let totalProgress = 0;
      teamKPIs.forEach(kpi => {
        const progress = kpi.target > 0 ? (kpi.current / kpi.target) * 100 : 0;
        totalProgress += Math.min(progress, 100);
      });
      return Math.round(totalProgress / teamKPIs.length);
    }

    // í† ê¸€ ê¸°ëŠ¥
    function toggleKPIFolder(id) {
      const content = document.getElementById(id);
      const toggle = document.getElementById(id + '-toggle');
      if (content && toggle) {
        content.classList.toggle('show');
        toggle.classList.toggle('open');
      }
    }

    function toggleKPISubFolder(id) {
      toggleKPIFolder(id);
    }

    // ë Œë”ë§
    function render() {
      const container = document.getElementById('content');
      if (!container) return;

      const { megaProjects, projects, teamKPIs, memberKPIs } = state;

      // ë‹¬ì„±ë¥  ê³„ì‚°
      let achievementRate = 0;
      if (teamKPIs.length > 0) {
        const totalProgress = teamKPIs.reduce((sum, kpi) => {
          const progress = kpi.target > 0 ? (kpi.current / kpi.target) * 100 : 0;
          return sum + Math.min(progress, 100);
        }, 0);
        achievementRate = Math.round(totalProgress / teamKPIs.length);
      }

      // ì£¼ëª© í•„ìš” KPI
      const attentionKPIs = teamKPIs.filter(kpi => {
        const project = projects.find(p => p.id === kpi.projectId);
        const mega = project ? megaProjects.find(m => m.id === project.megaProjectId) : null;
        const progress = kpi.target > 0 ? Math.round((kpi.current / kpi.target) * 100) : 0;
        return mega?.priority === 1 && progress < 30;
      }).slice(0, 5);

      // ìš°ì„ ìˆœìœ„ TOP
      const priorityMegaKPIs = megaProjects
        .filter(m => m.priority && m.priority <= 3)
        .sort((a, b) => a.priority - b.priority);

      container.innerHTML = `
        <!-- ë¹ ë¥¸ ì ‘ê·¼ íŒ¨ë„ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
          <!-- ì£¼ëª© í•„ìš” -->
          <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 20px; border: 1px solid #F59E0B;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 14px; font-weight: 700; color: #92400E;">âš ï¸ ì£¼ëª© í•„ìš” (1ìˆœìœ„ ì¤‘ ë‹¬ì„±ë¥  30% ë¯¸ë§Œ)</div>
              <span style="font-size: 12px; color: #B45309;">${attentionKPIs.length}ê°œ</span>
            </div>
            ${attentionKPIs.length > 0 ? `
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${attentionKPIs.map(kpi => {
                  const progress = kpi.target > 0 ? Math.round((kpi.current / kpi.target) * 100) : 0;
                  return `
                    <div style="background: white; padding: 10px 14px; border-radius: 8px; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                      <span style="font-size: 13px; font-weight: 600; color: #333;">${kpi.name}</span>
                      <span style="font-size: 11px; padding: 2px 8px; background: ${C.red}; color: white; border-radius: 10px;">${progress}%</span>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `<div style="color: #92400E; font-size: 13px;">1ìˆœìœ„ ì„ í–‰ì§€í‘œ ëª¨ë‘ ì–‘í˜¸í•©ë‹ˆë‹¤ ğŸ‘</div>`}
          </div>

          <!-- ìš°ì„ ìˆœìœ„ TOP -->
          <div style="background: linear-gradient(135deg, #EDE9FE, #DDD6FE); border-radius: 16px; padding: 20px; border: 1px solid ${C.purple};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 14px; font-weight: 700; color: #5B21B6;">â­ ìš°ì„ ìˆœìœ„ TOP (ë©”ì¸ KPI)</div>
              <span style="font-size: 12px; color: #7C3AED;">${priorityMegaKPIs.length}ê°œ</span>
            </div>
            ${priorityMegaKPIs.length > 0 ? `
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${priorityMegaKPIs.map(mega => {
                  const childProjects = projects.filter(p => p.megaProjectId === mega.id);
                  let progress = 0;
                  if (childProjects.length > 0) {
                    const avgProgress = childProjects.reduce((sum, p) => sum + (p.progress || 0), 0) / childProjects.length;
                    progress = Math.round(avgProgress);
                  }
                  return `
                    <div style="background: white; padding: 10px 14px; border-radius: 8px; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                      <span style="font-size: 12px; font-weight: 700; color: ${C.purple};">#${mega.priority}</span>
                      <span style="font-size: 13px; font-weight: 600; color: #333;">${mega.name}</span>
                      <span style="font-size: 11px; padding: 2px 8px; background: ${progress >= 70 ? C.green : progress >= 40 ? C.yellow : C.red}; color: white; border-radius: 10px;">${progress}%</span>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `<div style="color: #5B21B6; font-size: 13px;">ë©”ì¸ KPIì— ìš°ì„ ìˆœìœ„ë¥¼ ì„¤ì •í•˜ì„¸ìš”</div>`}
          </div>
        </div>

        <!-- KPI ìš”ì•½ ì¹´ë“œ -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px;">
          <div style="background: linear-gradient(135deg, ${C.purple}, #8B5CF6); border-radius: 12px; padding: 20px; color: white;">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px;">ğŸ¯ ë©”ì¸ KPI</div>
            <div style="font-size: 28px; font-weight: 700;">${megaProjects.length}</div>
          </div>
          <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ“ ì„œë¸Œ KPI</div>
            <div style="font-size: 28px; font-weight: 700; color: ${C.primary};">${projects.length}</div>
          </div>
          <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ“‹ ì„ í–‰ì§€í‘œ</div>
            <div style="font-size: 28px; font-weight: 700; color: ${C.green};">${teamKPIs.length}</div>
          </div>
          <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ‘¤ ë‚´ ì„ í–‰ì§€í‘œ</div>
            <div style="font-size: 28px; font-weight: 700; color: ${C.yellow};">${memberKPIs.length}</div>
          </div>
          <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ“ˆ ë‹¬ì„±ë¥ </div>
            <div style="font-size: 28px; font-weight: 700; color: ${achievementRate >= 70 ? C.green : achievementRate >= 40 ? C.yellow : C.red};">${achievementRate}%</div>
          </div>
        </div>

        <!-- KPI ê³„ì¸µ êµ¬ì¡° -->
        <div style="margin-top: 24px;">
          ${megaProjects.length === 0 ? `
            <div style="text-align: center; padding: 60px 20px; background: ${C.white}; border-radius: 16px;">
              <div style="font-size: 50px; margin-bottom: 16px;">ğŸ“Š</div>
              <div style="font-size: 18px; font-weight: 600; color: ${C.gray700};">ì•„ì§ ë“±ë¡ëœ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          ` : megaProjects.map((mega, megaIdx) => {
            const childProjects = projects.filter(p => p.megaProjectId === mega.id);
            const megaTeamKPIs = teamKPIs.filter(k => childProjects.some(p => p.id === k.projectId));
            const megaMemberKPIs = memberKPIs.filter(k => megaTeamKPIs.some(t => t.id === k.teamKpiId));
            const megaProgress = calculateProjectProgress(megaTeamKPIs, megaMemberKPIs);
            const megaFolderId = 'mega-folder-' + megaIdx;

            return `
              <div class="kpi-folder">
                <!-- ë©”ì¸ KPI í—¤ë” -->
                <div class="kpi-folder-header" onclick="toggleKPIFolder('${megaFolderId}')" style="padding: 20px 24px; border-left: 4px solid ${C.purple}; background: ${C.white};">
                  <button class="kpi-folder-toggle" id="${megaFolderId}-toggle">â–¶</button>
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, ${C.purple}, #8B5CF6); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px;">ğŸ¢</div>
                  <div style="flex: 1;">
                    <div style="font-size: 18px; font-weight: 700; color: ${C.gray900};">${mega.name}</div>
                    <div style="font-size: 12px; color: ${C.gray500}; margin-top: 2px;">${mega.description || ''} Â· ì„œë¸Œ KPI ${childProjects.length}ê°œ</div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 16px;">
                    ${(mega.targetValue || mega.revenueTarget) ? `<div style="text-align: right;"><div style="font-size: 10px; color: ${C.gray500};">ëª©í‘œ</div><div style="font-size: 16px; font-weight: 700; color: ${C.purple};">${formatTargetValue(mega.targetValue || (mega.revenueTarget / 100000000), mega.targetUnitType || 'revenue')}</div></div>` : ''}
                    <div style="text-align: right;">
                      <div style="font-size: 10px; color: ${C.gray500};">ì§„í–‰ë¥ </div>
                      <div style="font-size: 16px; font-weight: 700; color: ${megaProgress >= 70 ? C.green : megaProgress >= 40 ? C.yellow : C.red};">${megaProgress}%</div>
                    </div>
                  </div>
                </div>

                <!-- ë©”ì¸ KPI ë‚´ìš© -->
                <div class="kpi-folder-content" id="${megaFolderId}" style="padding: 0 24px 20px 24px;">
                  <div style="margin-left: 30px; border-left: 2px solid ${C.gray200}; padding-left: 20px; padding-top: 12px;">
                    ${childProjects.length === 0 ? `
                      <div style="padding: 20px; background: ${C.gray50}; border-radius: 12px; text-align: center;">
                        <div style="color: ${C.gray500};">ì„œë¸Œ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>
                      </div>
                    ` : childProjects.map((project, projIdx) => {
                      const projectTeamKPIs = teamKPIs.filter(k => k.projectId === project.id);
                      const projectMemberKPIs = memberKPIs.filter(k => k.projectId === project.id);
                      const projectProgress = calculateProjectProgress(projectTeamKPIs, projectMemberKPIs);
                      const subFolderId = megaFolderId + '-sub-' + projIdx;

                      return `
                        <div class="kpi-folder" style="background: ${C.gray50}; border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                          <!-- ì„œë¸Œ KPI í—¤ë” -->
                          <div class="kpi-folder-header" onclick="toggleKPISubFolder('${subFolderId}')" style="padding: 14px 16px;">
                            <button class="kpi-folder-toggle" id="${subFolderId}-toggle" style="font-size: 10px;">â–¶</button>
                            <div style="font-size: 16px; margin-right: 8px;">ğŸ“</div>
                            <div style="flex: 1;">
                              <div style="font-size: 15px; font-weight: 600; color: ${C.gray900};">${project.name}</div>
                              <div style="font-size: 11px; color: ${C.gray500};">ì„ í–‰ì§€í‘œ ${projectTeamKPIs.length}ê°œ${(project.targetValue || project.revenueGoal) ? ' Â· ëª©í‘œ ' + formatTargetValue(project.targetValue || (project.revenueGoal / 100000000), project.targetUnitType || 'revenue') : ''}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <div style="background: ${projectProgress >= 70 ? C.green : projectProgress >= 40 ? C.yellow : C.red}20; padding: 4px 10px; border-radius: 10px; font-size: 12px; font-weight: 600; color: ${projectProgress >= 70 ? C.green : projectProgress >= 40 ? C.yellow : C.red};">
                                ${projectProgress}%
                              </div>
                            </div>
                          </div>

                          <!-- ì„œë¸Œ KPI ë‚´ìš© (ì„ í–‰ì§€í‘œ) -->
                          <div class="kpi-folder-content" id="${subFolderId}" style="padding: 0 16px 16px 16px;">
                            ${projectTeamKPIs.length === 0 ? `
                              <div style="padding: 16px; background: ${C.white}; border-radius: 8px; text-align: center; color: ${C.gray500}; font-size: 13px;">
                                ì„ í–‰ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤
                              </div>
                            ` : projectTeamKPIs.map(kpi => {
                              const kpiProgress = kpi.target > 0 ? Math.round((kpi.current / kpi.target) * 100) : 0;
                              return `
                                <div style="background: ${C.white}; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
                                  <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 14px;">ğŸ“‹</span>
                                    <span style="font-size: 14px; font-weight: 500; color: ${C.gray900};">${kpi.name}</span>
                                  </div>
                                  <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 13px; color: ${C.gray500};">${kpi.current || 0}/${kpi.target || 0} ${kpi.unit || 'ê±´'}</span>
                                    <div style="background: ${kpiProgress >= 70 ? C.green : kpiProgress >= 40 ? C.yellow : C.red}20; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; color: ${kpiProgress >= 70 ? C.green : kpiProgress >= 40 ? C.yellow : C.red};">
                                      ${kpiProgress}%
                                    </div>
                                  </div>
                                </div>
                              `;
                            }).join('')}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // ì´ˆê¸°í™”
    async function init() {
      // ë¨¼ì € ìµëª… ì¸ì¦
      const authSuccess = await signInAnonymously();
      if (!authSuccess) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'flex';
        return;
      }

      const token = getTokenFromUrl();
      const isValid = await validateToken(token);

      document.getElementById('loading').style.display = 'none';

      if (!isValid) {
        document.getElementById('error').style.display = 'flex';
        return;
      }

      document.getElementById('app').style.display = 'block';
      loadData();
    }

    init();
  </script>
</body>
</html>

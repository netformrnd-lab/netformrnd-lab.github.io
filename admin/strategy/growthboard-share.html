<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒ€ & ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ - ì™¸ë¶€ ê³µìœ </title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #3182f6;
      --primary-light: #eef4ff;
      --primary-dark: #1b64da;
      --white: #ffffff;
      --gray-900: #191f28;
      --gray-800: #333d4b;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      --success: #00c073;
      --success-light: #e8f7f0;
      --warning: #fc9600;
      --warning-light: #fff8f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --purple: #6366F1;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ë¡œë”©/ì—ëŸ¬ í™”ë©´ */
    .loading-screen, .error-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, var(--purple), #8B5CF6);
      color: white;
      padding: 24px 32px;
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .badge {
      background: rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .snapshot-date {
      font-size: 12px;
      opacity: 0.8;
    }

    /* ì»¨í…Œì´ë„ˆ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 32px;
    }

    /* ì¹´ë“œ */
    .card {
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 24px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ëª©í‘œ ì¹´ë“œ */
    .objective-card {
      background: linear-gradient(135deg, var(--primary), #8B5CF6);
      color: white;
      padding: 28px;
      border-radius: 16px;
      margin-bottom: 20px;
    }
    .objective-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .objective-period {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    .objective-rate {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 12px;
    }
    .objective-progress {
      height: 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
      overflow: hidden;
    }
    .objective-progress-fill {
      height: 100%;
      background: white;
      border-radius: 6px;
      transition: width 0.5s;
    }

    /* KR ê·¸ë¦¬ë“œ */
    .kr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .kr-card {
      padding: 16px;
      border-radius: 12px;
      background: var(--gray-50);
      cursor: pointer;
      transition: all 0.2s;
    }
    .kr-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .kr-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .kr-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .kr-badge {
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
    }
    .kr-progress {
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      overflow: hidden;
    }
    .kr-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s;
    }

    /* KPI í…Œì´ë¸” */
    .kpi-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .kpi-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--gray-600);
      border-bottom: 2px solid var(--gray-200);
      background: var(--gray-50);
    }
    .kpi-table th:nth-child(3),
    .kpi-table th:nth-child(4),
    .kpi-table th:nth-child(5) {
      text-align: right;
    }
    .kpi-table th:nth-child(6) {
      text-align: center;
    }
    .kpi-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-100);
    }
    .kpi-row {
      cursor: pointer;
      transition: background 0.15s;
    }
    .kpi-row:hover {
      background: var(--gray-50);
    }

    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--gray-500);
      cursor: pointer;
      padding: 4px;
    }
    .modal-close:hover {
      color: var(--gray-900);
    }
    .modal-body {
      padding: 24px;
    }

    /* ìƒì„¸ ì •ë³´ ìŠ¤íƒ€ì¼ */
    .detail-section {
      margin-bottom: 20px;
    }
    .detail-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }
    .detail-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-800);
    }
    .detail-progress-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    .detail-progress-fill {
      height: 100%;
      border-radius: 4px;
    }
    .indicator-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .indicator-item {
      background: var(--gray-50);
      border-radius: 10px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .indicator-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .indicator-value {
      font-size: 13px;
      font-weight: 600;
    }

    /* í™œë™ vs ì„±ê³¼ */
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .summary-box {
      border-radius: 12px;
      padding: 16px;
    }
    .summary-box.activity {
      background: var(--gray-50);
      border-left: 4px solid var(--gray-400);
    }
    .summary-box.result {
      background: var(--success-light);
      border-left: 4px solid var(--success);
    }
    .summary-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .summary-row:last-child {
      margin-bottom: 0;
    }

    /* í‘¸í„° */
    .footer {
      text-align: center;
      padding: 24px;
      color: var(--gray-500);
      font-size: 12px;
    }

    /* ë°˜ì‘í˜• - íƒœë¸”ë¦¿ (769px ~ 1024px) */
    @media (max-width: 1024px) and (min-width: 769px) {
      .container {
        padding: 24px;
      }

      .card {
        padding: 20px;
      }

      .kpi-table {
        font-size: 13px;
      }

      .kr-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ë°˜ì‘í˜• - ëª¨ë°”ì¼ (~ 768px) */
    @media (max-width: 768px) {
      .header {
        padding: 20px;
      }

      .header-inner {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }

      .header h1 {
        font-size: 18px;
      }

      .badge {
        font-size: 11px;
        padding: 4px 10px;
      }

      .snapshot-date {
        font-size: 11px;
      }

      .container {
        padding: 16px;
      }

      .card {
        padding: 16px;
        margin-bottom: 16px;
      }

      .card-title {
        font-size: 15px;
      }

      .objective-card {
        padding: 20px;
      }

      .objective-name {
        font-size: 16px;
      }

      .objective-period {
        font-size: 12px;
      }

      .objective-rate {
        font-size: 36px;
      }

      .kr-grid {
        grid-template-columns: 1fr;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
      div[style*="overflow-x: auto"] {
        position: relative;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
      }

      /* ìŠ¤í¬ë¡¤ íŒíŠ¸ */
      div[style*="overflow-x: auto"]::after {
        content: 'ğŸ‘‰ ì¢Œìš° ìŠ¤í¬ë¡¤';
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        background: rgba(49, 130, 246, 0.9);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        pointer-events: none;
        animation: fadeOut 3s forwards;
      }

      @keyframes fadeOut {
        0%, 70% { opacity: 1; }
        100% { opacity: 0; }
      }

      .kpi-table {
        min-width: 700px;
        font-size: 12px;
        table-layout: auto !important;
      }

      .kpi-table th,
      .kpi-table td {
        padding: 10px 8px;
        font-size: 11px;
        white-space: nowrap;
      }

      /* KR ì¹¼ëŸ¼ */
      .kpi-table th:nth-child(1),
      .kpi-table td:nth-child(1) {
        min-width: 90px;
        max-width: 120px;
      }

      /* KPI ì¹¼ëŸ¼ */
      .kpi-table th:nth-child(2),
      .kpi-table td:nth-child(2) {
        min-width: 100px;
        max-width: 150px;
      }

      /* ìˆ«ì ì¹¼ëŸ¼ë“¤ */
      .kpi-table th:nth-child(3),
      .kpi-table th:nth-child(4),
      .kpi-table td:nth-child(3),
      .kpi-table td:nth-child(4) {
        min-width: 70px;
      }

      .kpi-table th:nth-child(5),
      .kpi-table td:nth-child(5) {
        min-width: 50px;
      }

      .kpi-table th:nth-child(6),
      .kpi-table td:nth-child(6) {
        min-width: 80px;
      }

      /* ëª¨ë‹¬ */
      .modal-content {
        max-width: 95vw;
        max-height: 90vh;
        margin: 10px;
      }

      .detail-modal-header h3 {
        font-size: 16px;
      }

      .footer {
        padding: 20px 16px;
        font-size: 11px;
      }
    }

    /* ì•„ì£¼ ì‘ì€ í™”ë©´ (~ 375px) */
    @media (max-width: 375px) {
      .container {
        padding: 12px;
      }

      .card {
        padding: 12px;
      }

      .header h1 {
        font-size: 16px;
      }

      .objective-rate {
        font-size: 32px;
      }

      .kpi-table {
        min-width: 600px;
        font-size: 11px;
      }

      .kpi-table th,
      .kpi-table td {
        padding: 8px 6px;
        font-size: 10px;
      }

      .kr-card {
        padding: 12px;
      }

      .kr-name {
        font-size: 12px;
      }

      .kr-badge {
        font-size: 10px;
      }
    }

    /* ê°œì¸ ëª©í‘œ ì„¹ì…˜ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #personalGoalsToggleBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }

    /* í•˜ìœ„ì§€í‘œ ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .sub-kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    @media (max-width: 768px) {
      .sub-kpi-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .sub-kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* í•˜ìœ„ì§€í‘œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .sub-kpi-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      border: 2px solid var(--gray-200);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .sub-kpi-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(49, 130, 246, 0.15);
    }

    .sub-kpi-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .sub-kpi-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      line-height: 1.4;
      flex: 1;
      margin-right: 8px;
    }

    .sub-kpi-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      color: white;
      white-space: nowrap;
    }

    .sub-kpi-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .sub-kpi-stat {
      text-align: center;
      padding: 8px;
      background: var(--gray-50);
      border-radius: 8px;
    }

    .sub-kpi-stat-label {
      font-size: 10px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }

    .sub-kpi-stat-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .sub-kpi-progress-wrapper {
      margin-top: 12px;
    }

    .sub-kpi-progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--gray-600);
      margin-bottom: 6px;
    }

    .sub-kpi-progress-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
    }

    .sub-kpi-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .sub-kpi-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      padding: 6px 10px;
      background: var(--gray-50);
      border-radius: 6px;
      font-size: 11px;
    }

    .sub-kpi-trend-icon {
      font-size: 14px;
    }

    .sub-kpi-trend-text {
      font-weight: 600;
    }

    /* ABí…ŒìŠ¤íŠ¸ ì„¹ì…˜ */
    .ab-test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }

    @media (max-width: 768px) {
      .ab-test-grid {
        grid-template-columns: 1fr;
      }
    }

    .ab-test-comparison {
      background: white;
      border-radius: 16px;
      padding: 20px;
      border: 2px solid var(--gray-200);
      transition: all 0.3s ease;
    }

    .ab-test-comparison:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }

    .ab-test-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--gray-200);
    }

    .ab-test-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 4px;
    }

    .ab-test-period {
      font-size: 12px;
      color: var(--gray-500);
    }

    .ab-test-variants {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .ab-variant {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      position: relative;
      transition: all 0.3s ease;
    }

    .ab-variant-a {
      background: linear-gradient(135deg, #EBF5FF, #D6E9FF);
      border: 2px solid #3182f6;
    }

    .ab-variant-b {
      background: linear-gradient(135deg, #E8F7F0, #D1F0E1);
      border: 2px solid #00c073;
    }

    .ab-variant-winner {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: scale(1.05);
    }

    .ab-variant-label {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .ab-variant-metric {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .ab-variant-desc {
      font-size: 11px;
      color: var(--gray-600);
    }

    .ab-test-winner-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(255, 165, 0, 0.4);
    }

    /* ë¹ˆ ìƒíƒœ ìŠ¤íƒ€ì¼ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-400);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 20px;
    }

    .empty-state-cta {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--primary), #60A5FA);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .empty-state-cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
    }

    /* ì„¹ì…˜ í—¤ë” */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-count {
      font-size: 13px;
      color: var(--gray-500);
      font-weight: 600;
      background: var(--gray-100);
      padding: 4px 12px;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <!-- ë¡œë”© í™”ë©´ -->
  <div id="loading" class="loading-screen">
    <div class="loading-spinner"></div>
    <div style="margin-top: 20px; color: var(--gray-500);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>

  <!-- ì—ëŸ¬ í™”ë©´ -->
  <div id="error" class="error-screen" style="display: none;">
    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ”’</div>
    <div style="font-size: 20px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</div>
    <div style="color: var(--gray-500);" id="errorMessage">ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë¹„í™œì„±í™”ëœ ë§í¬ì…ë‹ˆë‹¤</div>
  </div>

  <!-- ë©”ì¸ ì•± -->
  <div id="app" style="display: none;">
    <div class="header">
      <div class="header-inner">
        <div style="display: flex; align-items: center; gap: 12px;">
          <h1>ğŸ“Š ê·¸ë¡œìŠ¤ë³´ë“œ</h1>
          <button onclick="openStrategyCycleModal()" style="padding: 6px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
            â“ ì „ëµ ì‚¬ì´í´ì´ë€?
          </button>
        </div>
        <div class="header-meta">
          <div class="badge" id="modeBadge">ğŸ”’ ì½ê¸° ì „ìš©</div>
          <div class="snapshot-date" id="snapshotDate"></div>
        </div>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div style="background: white; border-bottom: 2px solid var(--gray-200); box-shadow: 0 2px 4px rgba(0,0,0,0.04);">
      <div style="max-width: 1200px; margin: 0 auto; padding: 0 32px; display: flex; gap: 8px;">
        <button id="tabTeam" onclick="switchTab('team')" style="padding: 16px 24px; border: none; background: none; font-size: 15px; font-weight: 600; color: var(--primary); cursor: pointer; position: relative; border-bottom: 3px solid var(--primary);">
          ğŸ“ˆ íŒ€ ê·¸ë¡œìŠ¤ë³´ë“œ
        </button>
        <button id="tabPersonal" onclick="switchTab('personal')" style="padding: 16px 24px; border: none; background: none; font-size: 15px; font-weight: 600; color: var(--gray-500); cursor: pointer; position: relative; border-bottom: 3px solid transparent;">
          ğŸ‘¤ ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ
        </button>
      </div>
    </div>

    <div class="container" id="content"></div>
    <div class="footer">
      <div>ì´ í˜ì´ì§€ëŠ” ì½ê¸° ì „ìš© ê³µìœ  í˜ì´ì§€ì…ë‹ˆë‹¤.</div>
      <div style="margin-top: 4px;">ë°ì´í„°ëŠ” ê³µìœ  ë§í¬ ìƒì„± ì‹œì ì˜ ìŠ¤ëƒ…ìƒ·ì…ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="modal" class="modal" onclick="if(event.target === this) closeModal()"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
      authDomain: "moyeora-deal-manager.firebaseapp.com",
      projectId: "moyeora-deal-manager",
      storageBucket: "moyeora-deal-manager.firebasestorage.app",
      messagingSenderId: "527148187832",
      appId: "1:527148187832:web:dc35b0413a7157db34744d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ìƒ‰ìƒ/ì•„ì´ì½˜ ìƒìˆ˜
    const okrColors = ['#8B5CF6', '#06B6D4', '#10B981', '#F59E0B'];
    const okrIcons = ['ğŸ¯', 'ğŸ“ˆ', 'ğŸ’°', 'ğŸš€'];

    // ìŠ¤ëƒ…ìƒ· ë°ì´í„°
    let snapshotData = null;

    // í˜„ì¬ íƒ­
    let currentTab = 'team'; // 'team' ë˜ëŠ” 'personal'

    // íƒ­ ì „í™˜
    function switchTab(tab) {
      currentTab = tab;

      // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      const teamBtn = document.getElementById('tabTeam');
      const personalBtn = document.getElementById('tabPersonal');

      if (tab === 'team') {
        teamBtn.style.color = 'var(--primary)';
        teamBtn.style.borderBottomColor = 'var(--primary)';
        personalBtn.style.color = 'var(--gray-500)';
        personalBtn.style.borderBottomColor = 'transparent';
      } else {
        teamBtn.style.color = 'var(--gray-500)';
        teamBtn.style.borderBottomColor = 'transparent';
        personalBtn.style.color = 'var(--primary)';
        personalBtn.style.borderBottomColor = 'var(--primary)';
      }

      // ì»¨í…ì¸  ë Œë”ë§
      render();
    }

    // URLì—ì„œ í† í° ì¶”ì¶œ
    function getTokenFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('token');
    }

    // í† í° ê²€ì¦ ë° ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ
    async function validateAndLoadSnapshot(token) {
      if (!token) {
        return { valid: false, error: 'í† í°ì´ ì—†ìŠµë‹ˆë‹¤' };
      }

      try {
        // ê³µìœ  ë§í¬ ì¡°íšŒ
        const snapshot = await db.collection('growthboardShareLinks')
          .where('token', '==', token)
          .get();

        if (snapshot.empty) {
          return { valid: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬ì…ë‹ˆë‹¤' };
        }

        const doc = snapshot.docs[0];
        const linkData = doc.data();

        if (!linkData.isActive) {
          return { valid: false, error: 'ë¹„í™œì„±í™”ëœ ë§í¬ì…ë‹ˆë‹¤' };
        }

        // objectiveIdê°€ ìˆìœ¼ë©´ ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ, ì—†ìœ¼ë©´ ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
        let data;
        if (linkData.objectiveId) {
          // ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ
          const objectiveDoc = await db.collection('okr_objective').doc(linkData.objectiveId).get();
          if (!objectiveDoc.exists) {
            return { valid: false, error: 'ëª©í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
          }

          const objective = { id: objectiveDoc.id, ...objectiveDoc.data() };

          // KR, KPI, ì§€í‘œ, ë¡œê·¸, ê°œì¸ëª©í‘œ ì‹¤ì‹œê°„ ë¡œë“œ
          const [krSnapshot, kpiSnapshot, lagSnapshot, logSnapshot, personalTargetSnapshot] = await Promise.all([
            db.collection('okr_keyResults').where('objectiveId', '==', linkData.objectiveId).get(),
            db.collection('okr_kpis').where('objectiveId', '==', linkData.objectiveId).get(),
            db.collection('okr_laggingIndicators').where('objectiveId', '==', linkData.objectiveId).get(),
            db.collection('okr_dailyLogs').where('objectiveId', '==', linkData.objectiveId).get(),
            db.collection('okr_personalTargets').get()
          ]);

          data = {
            objective,
            keyResults: krSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            kpis: kpiSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            laggingIndicators: lagSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            dailyLogs: logSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            personalTargets: personalTargetSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            snapshotCreatedAt: new Date().toISOString()  // ì‹¤ì‹œê°„ ë¡œë“œ ì‹œê°
          };

          // ë°ì´í„° ì¤‘ë³µ ì œê±° (í˜¹ì‹œ Firebaseì— ì¤‘ë³µ ë°ì´í„°ê°€ ìˆì„ ê²½ìš° ëŒ€ë¹„)
          const uniqueKRs = new Map();
          data.keyResults.forEach(kr => {
            if (!uniqueKRs.has(kr.id)) {
              uniqueKRs.set(kr.id, kr);
            }
          });
          data.keyResults = Array.from(uniqueKRs.values()).filter(kr => kr.name !== 'ë„·í¼ì•Œì•¤ë””');

          const uniqueKPIs = new Map();
          data.kpis.forEach(kpi => {
            if (!uniqueKPIs.has(kpi.id)) {
              uniqueKPIs.set(kpi.id, kpi);
            }
          });
          data.kpis = Array.from(uniqueKPIs.values());

          const uniqueLags = new Map();
          data.laggingIndicators.forEach(lag => {
            if (!uniqueLags.has(lag.id)) {
              uniqueLags.set(lag.id, lag);
            }
          });
          data.laggingIndicators = Array.from(uniqueLags.values());

          console.log('ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ:', {
            KRìˆ˜: data.keyResults.length,
            KPIìˆ˜: data.kpis.length,
            ì§€í‘œìˆ˜: data.laggingIndicators.length,
            ë¡œê·¸ìˆ˜: data.dailyLogs.length,
            ê°œì¸ëª©í‘œìˆ˜: data.personalTargets.length
          });
        } else {
          // ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· ë°ì´í„° ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
          data = linkData.snapshotData;
          // "ë„·í¼ì•Œì•¤ë””" í•„í„°ë§ (ìŠ¤ëƒ…ìƒ· ëª¨ë“œ)
          if (data && data.keyResults) {
            data.keyResults = data.keyResults.filter(kr => kr.name !== 'ë„·í¼ì•Œì•¤ë””');
          }
        }

        // ì¡°íšŒìˆ˜ ì¦ê°€
        await db.collection('growthboardShareLinks').doc(doc.id).update({
          viewCount: firebase.firestore.FieldValue.increment(1),
          lastViewedAt: new Date().toISOString()
        });

        return {
          valid: true,
          data: data,
          createdAt: linkData.createdAt,
          linkName: linkData.name,
          isRealtime: !!linkData.objectiveId  // ì‹¤ì‹œê°„ ì—¬ë¶€
        };
      } catch (e) {
        console.error('ê²€ì¦ ì˜¤ë¥˜:', e);
        return { valid: false, error: 'ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' };
      }
    }

    // â˜… ê¸ˆì•¡ ë‹¨ìœ„ í™•ì¸ í•¨ìˆ˜ (unit ë²„ê·¸ ìˆ˜ì •)
    function isMoneyUnit(unit) {
      return unit === 'ì›' || unit === '$' || unit === 'ë‹¬ëŸ¬' || unit === 'Â¥' || unit === 'â‚¬' || unit === 'USD' || unit === 'KRW';
    }

    // â˜… ì„±ê³¼ì§€í‘œ ê°’ ê³„ì‚° (valuePerUnit ì ìš© - ê¸ˆì•¡ ë‹¨ìœ„ëŠ” ì œì™¸)
    function calcLagValue(lag, logSum) {
      // ê¸ˆì•¡ ë‹¨ìœ„ëŠ” valuePerUnit ì‚¬ìš© ì•ˆ í•¨ (ê·¸ëŒ€ë¡œ í•©ì‚°)
      if (isMoneyUnit(lag.unit)) {
        return logSum;
      }

      // ê±´ìˆ˜/ê°œìˆ˜ ë‹¨ìœ„ëŠ” valuePerUnit ì‚¬ìš©
      if (lag.valuePerUnit && lag.valuePerUnit > 0) {
        return logSum * lag.valuePerUnit;
      }

      return logSum;
    }

    // ê¸ˆì•¡ í¬ë§·íŒ…
    function formatAmountWithSummary(num, unit) {
      if (num === null || num === undefined) return '-';
      const formatted = Number(num).toLocaleString();

      if (unit === 'ì›' && num >= 10000) {
        const korean = formatKoreanAmount(num);
        return `${formatted}(${korean})${unit}`;
      }
      return unit ? `${formatted}${unit}` : formatted;
    }

    function formatKoreanAmount(num) {
      if (num >= 100000000) {
        const eok = Math.floor(num / 100000000);
        const remainder = num % 100000000;
        if (remainder >= 10000000) {
          const cheonman = Math.floor(remainder / 10000000);
          return `${eok}ì–µ${cheonman}ì²œë§Œ`;
        }
        return `${eok}ì–µ`;
      } else if (num >= 10000000) {
        const cheonman = Math.floor(num / 10000000);
        return `${cheonman}ì²œë§Œ`;
      } else if (num >= 1000000) {
        const baekman = Math.floor(num / 1000000);
        return `${baekman}ë°±ë§Œ`;
      } else if (num >= 10000) {
        const man = Math.floor(num / 10000);
        return `${man}ë§Œ`;
      }
      return num.toLocaleString();
    }

    // ë‹¬ì„±ë¥  ê³„ì‚°
    function calcKRRate(krId) {
      if (!snapshotData) return 0;
      const kpisForKR = snapshotData.kpis.filter(k => k.keyResultId === krId);
      if (kpisForKR.length === 0) return 0;

      let totalRate = 0;
      kpisForKR.forEach(kpi => {
        totalRate += calcKPIRate(kpi.id);
      });
      return Math.round(totalRate / kpisForKR.length);
    }

    function calcKPIRate(kpiId) {
      if (!snapshotData) return 0;
      const kpi = snapshotData.kpis.find(k => k.id === kpiId);
      if (!kpi || !kpi.targetValue) return 0;

      const lagsForKPI = snapshotData.laggingIndicators.filter(l => l.kpiId === kpiId);
      let currentValue = 0;

      lagsForKPI.forEach(lag => {
        if (lag.type === 'output') {
          const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
          logs.forEach(log => {
            // â˜… FIXED: calcLagValue ë„ìš°ë¯¸ í•¨ìˆ˜ ì‚¬ìš©
            const value = calcLagValue(lag, log.resultValue || 0);
            currentValue += value;
          });
        }
      });

      return Math.round((currentValue / kpi.targetValue) * 100);
    }

    function calcObjectiveRate() {
      if (!snapshotData || snapshotData.keyResults.length === 0) return 0;
      let total = 0;
      snapshotData.keyResults.forEach(kr => {
        total += calcKRRate(kr.id);
      });
      return Math.round(total / snapshotData.keyResults.length);
    }

    // ì§€í‘œ ì•„ì´ì½˜
    function getLagIcon(name) {
      const lower = (name || '').toLowerCase();
      if (lower.includes('ë§¤ì¶œ') || lower.includes('ìˆ˜ìµ') || lower.includes('ê¸ˆì•¡')) return 'ğŸ’°';
      if (lower.includes('ê´‘ê³ ') || lower.includes('ë§ˆì¼€íŒ…')) return 'ğŸ“¢';
      if (lower.includes('ë¯¸íŒ…') || lower.includes('ìƒë‹´')) return 'ğŸ¤';
      if (lower.includes('ê³„ì•½') || lower.includes('ë”œ')) return 'ğŸ“';
      if (lower.includes('ì˜ì—…') || lower.includes('ì„¸ì¼ì¦ˆ')) return 'ğŸ’¼';
      if (lower.includes('ì½œ') || lower.includes('ì „í™”')) return 'ğŸ“';
      if (lower.includes('ì´ë©”ì¼') || lower.includes('ë©”ì¼')) return 'ğŸ“§';
      if (lower.includes('ë°©ë¬¸')) return 'ğŸš—';
      if (lower.includes('ë¦¬ë“œ') || lower.includes('ë°œêµ´')) return 'ğŸ¯';
      return 'ğŸ“‹';
    }

    // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    // ì „ëµ ì‚¬ì´í´ ì„¤ëª… ëª¨ë‹¬
    function openStrategyCycleModal() {
      showModal(`
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(135deg, var(--purple), #8B5CF6); color: white;">
            <h2 class="modal-title" style="color: white; display: flex; align-items: center; gap: 8px;">
              ğŸ¯ ì „ëµ ì‚¬ì´í´ì´ë€?
            </h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div class="modal-body">
            <!-- ì™œ ê·¸ë¡œìŠ¤ë³´ë“œê°€ í•„ìš”í•œê°€? -->
            <div style="background: linear-gradient(135deg, var(--primary)10, var(--success)10); padding: 20px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid var(--primary);">
              <div style="font-size: 16px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                ğŸ’¡ ì™œ ê·¸ë¡œìŠ¤ë³´ë“œê°€ í•„ìš”í•œê°€?
              </div>
              <div style="font-size: 14px; color: var(--gray-700); line-height: 1.7;">
                <strong>ëª©í‘œëŠ” ìˆì§€ë§Œ ì–´ë–»ê²Œ ë‹¬ì„±í• ì§€ ë§‰ë§‰í•œ ê²½í—˜</strong>, ëˆ„êµ¬ë‚˜ ìˆì£ ?<br>
                ê·¸ë¡œìŠ¤ë³´ë“œëŠ” <strong>í° ëª©í‘œë¥¼ ì‘ì€ í–‰ë™ìœ¼ë¡œ ì—°ê²°</strong>í•˜ëŠ” í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.<br>
                ë§¤ì¼ì˜ ì—…ë¬´ê°€ íŒ€ ëª©í‘œ ë‹¬ì„±ì— ì–´ë–»ê²Œ ê¸°ì—¬í•˜ëŠ”ì§€ í•œëˆˆì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>

            <!-- ì „ëµ ì‚¬ì´í´ 4ë‹¨ê³„ -->
            <div style="font-size: 15px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">
              ğŸ“Š ì „ëµ ì‚¬ì´í´ 4ë‹¨ê³„
            </div>

            <!-- 1. Objective -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 2px solid var(--gray-200);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8B5CF6, #6366F1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px;">1</div>
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: var(--gray-900);">ğŸ¯ O (Objective) - ëª©í‘œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ìš°ë¦¬ê°€ ì´ë£¨ê³  ì‹¶ì€ í° ê·¸ë¦¼</div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--gray-700); padding-left: 52px; line-height: 1.6;">
                <strong>ì˜ˆì‹œ:</strong> "26ë…„ë„ PMFë¥¼ ì°¾ëŠ” ë‹¨ê³„, ì—° 10ì–µ ë§¤ì¶œ ë‹¬ì„±"<br>
                â†’ íŒ€ ì „ì²´ê°€ í–¥í•˜ëŠ” <strong>ìµœì¢… ëª©ì ì§€</strong>
              </div>
            </div>

            <!-- 2. Key Results -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 2px solid var(--gray-200);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #06B6D4, #0891B2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px;">2</div>
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: var(--gray-900);">ğŸ“ˆ KR (Key Results) - í•µì‹¬ ê²°ê³¼</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œë¥¼ ë‹¬ì„±í–ˆëŠ”ì§€ ì¸¡ì •í•˜ëŠ” ì§€í‘œ</div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--gray-700); padding-left: 52px; line-height: 1.6;">
                <strong>ì˜ˆì‹œ:</strong> "ì—°ë§¤ì¶œ 10ì–µ ë‹¬ì„±", "íŒŒíŠ¸ë„ˆ 500ëª… í™•ë³´"<br>
                â†’ Objectiveë¥¼ <strong>ì¸¡ì • ê°€ëŠ¥í•œ ê²°ê³¼</strong>ë¡œ ìª¼ê°¬ (3~5ê°œ)
              </div>
            </div>

            <!-- 3. KPI -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 2px solid var(--gray-200);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10B981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px;">3</div>
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: var(--gray-900);">ğŸ’° KPI - í•µì‹¬ ì„±ê³¼ ì§€í‘œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">KRì„ ë‹¬ì„±í•˜ê¸° ìœ„í•œ êµ¬ì²´ì  ì§€í‘œ</div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--gray-700); padding-left: 52px; line-height: 1.6;">
                <strong>ì˜ˆì‹œ:</strong> "êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ 8ì–µ", "ê³µê¸‰ì‚¬ 200ê³³ í™•ë³´"<br>
                â†’ KRì„ <strong>ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ìœ„</strong>ë¡œ ì„¸ë¶„í™”
              </div>
            </div>

            <!-- 4. ì§€í‘œ (í™œë™/ì„±ê³¼) -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 2px solid var(--gray-200);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #F59E0B, #D97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px;">4</div>
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: var(--gray-900);">ğŸ“‹ ì§€í‘œ - ì¼ì¼ ì—…ë¬´ ê¸°ë¡</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ë§¤ì¼ í•˜ëŠ” ì‹¤ì œ í–‰ë™</div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--gray-700); padding-left: 52px; line-height: 1.6;">
                <strong>í™œë™í˜•:</strong> "ì „í™” ìƒë‹´ 3ê±´", "ë¯¸íŒ… 2íšŒ" (ê³¼ì • ì¶”ì )<br>
                <strong>ì„±ê³¼ì§€í‘œ:</strong> "ê³„ì•½ ì„±ì‚¬ 5ê±´", "ë§¤ì¶œ 200ë§Œì›" (ê²°ê³¼ ì¸¡ì •)<br>
                â†’ íŒ€ì›ë“¤ì´ <strong>ë§¤ì¼ ê¸°ë¡í•˜ëŠ” ì‹¤ì œ ì—…ë¬´</strong>
              </div>
            </div>

            <!-- ìˆœí™˜ êµ¬ì¡° -->
            <div style="background: var(--gray-50); padding: 20px; border-radius: 12px; margin-top: 24px;">
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                ğŸ”„ ì´ë ‡ê²Œ ì—°ê²°ë©ë‹ˆë‹¤
              </div>
              <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8;">
                <strong>ğŸ¯ O</strong> (í° ëª©í‘œ) <br>
                â†’ <strong>ğŸ“ˆ KR</strong> (ì¸¡ì • ê°€ëŠ¥í•œ ê²°ê³¼) <br>
                â†’ <strong>ğŸ’° KPI</strong> (êµ¬ì²´ì  ì§€í‘œ) <br>
                â†’ <strong>ğŸ“‹ ì¼ì¼ ì—…ë¬´</strong> (ë§¤ì¼ì˜ í–‰ë™)<br>
                <br>
                <span style="color: var(--primary); font-weight: 600;">
                  â†’ ë§¤ì¼ì˜ ì‘ì€ í–‰ë™ì´ ëª¨ì—¬ ëª©í‘œë¥¼ ë‹¬ì„±í•©ë‹ˆë‹¤! ğŸš€
                </span>
              </div>
            </div>

            <!-- í™œë™í˜• ì§€í‘œ/ì„±ê³¼ì§€í‘œ ì„¤ëª… -->
            <div style="background: linear-gradient(135deg, #fefce8, #fef9c3); padding: 20px; border-radius: 12px; margin-top: 24px; border-left: 4px solid #f59e0b;">
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                ğŸ’¡ í™œë™í˜• ì§€í‘œ vs ì„±ê³¼ì§€í‘œ
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--gray-200);">
                  <div style="font-weight: 600; color: var(--gray-600); margin-bottom: 6px;">ğŸ“‹ í™œë™í˜• ì§€í‘œ</div>
                  <div style="font-size: 12px; color: var(--gray-600); line-height: 1.6;">
                    â€¢ ì¼ìƒ ì—…ë¬´ ì¶”ì  (ì°¸ê³ ìš©)<br>
                    â€¢ <strong style="color: var(--gray-500);">KPI ê³„ì‚° ë¯¸ë°˜ì˜</strong><br>
                    â€¢ ì˜ˆ: ë¯¸íŒ…, ì—°ë½ íšŸìˆ˜
                  </div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--success);">
                  <div style="font-weight: 600; color: var(--success); margin-bottom: 6px;">ğŸ’° ì„±ê³¼ì§€í‘œ</div>
                  <div style="font-size: 12px; color: var(--gray-600); line-height: 1.6;">
                    â€¢ ì‹¤ì œ ì„±ê³¼ ì¸¡ì •<br>
                    â€¢ <strong style="color: var(--success);">KPI ê³„ì‚° ë°˜ì˜</strong><br>
                    â€¢ ì˜ˆ: ê³„ì•½, ë§¤ì¶œ
                  </div>
                </div>
              </div>
            </div>

            <!-- 3ê°€ì§€ ëª©í‘œì˜ ì°¨ì´ -->
            <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 20px; border-radius: 12px; margin-top: 16px; border-left: 4px solid #f59e0b;">
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                ğŸ¯ 3ê°€ì§€ ëª©í‘œì˜ ì°¨ì´ì 
              </div>
              <div style="font-size: 12px; color: var(--gray-700); line-height: 1.7; margin-bottom: 12px;">
                ê·¸ë¡œìŠ¤ë³´ë“œì—ëŠ” 3ê°€ì§€ ëª©í‘œê°€ ìˆìœ¼ë©°, ê°ê° ìš©ë„ê°€ ë‹¤ë¦…ë‹ˆë‹¤:
              </div>
              <div style="display: grid; gap: 10px;">
                <!-- íŒ€ KPI ëª©í‘œ -->
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary);">
                  <div style="font-weight: 600; color: var(--primary); font-size: 12px; margin-bottom: 4px;">ğŸ“Š íŒ€ KPI ëª©í‘œ</div>
                  <div style="font-size: 11px; color: var(--gray-600); line-height: 1.5;">
                    íŒ€ ì „ì²´ ëª©í‘œ Â· <strong style="color: var(--danger);">ë‹¬ì„±ë¥  ê³„ì‚° ì‚¬ìš©</strong><br>
                    <span style="color: var(--gray-500);">ì˜ˆ: êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ 8ì–µ</span>
                  </div>
                </div>
                <!-- ì¼ì¼ ëª©í‘œ -->
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid var(--warning);">
                  <div style="font-weight: 600; color: var(--warning); font-size: 12px; margin-bottom: 4px;">ğŸ“‹ ì¼ì¼ ëª©í‘œ</div>
                  <div style="font-size: 11px; color: var(--gray-600); line-height: 1.5;">
                    í•˜ë£¨ ê¶Œì¥ëŸ‰ ê°€ì´ë“œ Â· <strong style="color: var(--gray-500);">ì°¸ê³ ìš©ë§Œ</strong><br>
                    <span style="color: var(--gray-500);">ì˜ˆ: ì „í™” ìƒë‹´ 10ê±´/ì¼</span>
                  </div>
                </div>
                <!-- ê°œì¸ ëª©í‘œ -->
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid var(--success);">
                  <div style="font-weight: 600; color: var(--success); font-size: 12px; margin-bottom: 4px;">ğŸ¯ ê°œì¸ ëª©í‘œ</div>
                  <div style="font-size: 11px; color: var(--gray-600); line-height: 1.5;">
                    ê°œì¸ ì„±ì·¨ê° ì¶”ì  Â· <strong style="color: var(--gray-500);">ë™ê¸°ë¶€ì—¬ìš©</strong><br>
                    <span style="color: var(--gray-500);">ì˜ˆ: ë‚´ê°€ 3ì–µ ê¸°ì—¬!</span>
                  </div>
                </div>
              </div>
              <div style="margin-top: 12px; padding: 10px; background: rgba(245,158,11,0.1); border-radius: 6px; font-size: 11px; color: var(--gray-700);">
                ğŸ’¡ íŒ€ KPI ëª©í‘œë§Œ ì‹¤ì œ ë‹¬ì„±ë¥  ê³„ì‚°ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
              </div>
            </div>

            <!-- ê°œì¸ ëª©í‘œ ì„¤ëª… (ê¸°ì¡´) -->
            <div style="background: linear-gradient(135deg, var(--success)10, var(--primary)10); padding: 20px; border-radius: 12px; margin-top: 16px; border-left: 4px solid var(--success);">
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                ğŸ¯ ê°œì¸ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”?
              </div>
              <div style="font-size: 13px; color: var(--gray-700); line-height: 1.7;">
                íŒ€ KPIì™€ ë³„ê°œë¡œ <strong>ë‚˜ë§Œì˜ ë‹¤ì§</strong>ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                "ì´ë²ˆ ë‹¬ ë‚´ê°€ 3ì–µ ê¸°ì—¬í•˜ê² ë‹¤!" ê°™ì€ ê°œì¸ ëª©í‘œë¥¼ ì„¸ìš°ê³ ,<br>
                ë‹¬ì„±ë¥ ì„ ì¶”ì í•˜ë©° <strong>ì„±ì·¨ê°</strong>ì„ ëŠë‚„ ìˆ˜ ìˆì–´ìš”!<br>
                <span style="color: var(--gray-500); font-size: 12px;">(íŒ€ KPI ê³„ì‚°ì—ëŠ” ì˜í–¥ ì—†ìŒ)</span>
              </div>
            </div>
          </div>
        </div>
      `);
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) modal.className = 'modal';
    }

    function showModal(content) {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.innerHTML = content;
        modal.className = 'modal show';
      }
    }

    // KR ìƒì„¸ ëª¨ë‹¬
    function showKRDetail(krId) {
      const kr = snapshotData.keyResults.find(k => k.id === krId);
      const krIdx = snapshotData.keyResults.findIndex(k => k.id === krId);
      const kpisForKR = snapshotData.kpis.filter(k => k.keyResultId === krId);
      const krRate = calcKRRate(krId);

      showModal(`
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(135deg, ${okrColors[krIdx]}, ${okrColors[krIdx]}CC); color: white;">
            <h2 class="modal-title" style="color: white; display: flex; align-items: center; gap: 8px;">
              ${okrIcons[krIdx]} ${kr.name}
            </h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="detail-section">
              <div class="detail-label">ë‹¬ì„±ë¥ </div>
              <div class="detail-value" style="font-size: 32px; color: ${okrColors[krIdx]};">${krRate}%</div>
              <div class="detail-progress-bar">
                <div class="detail-progress-fill" style="width: ${Math.min(krRate, 100)}%; background: ${okrColors[krIdx]};"></div>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">ì—°ê²°ëœ KPI (${kpisForKR.length}ê°œ)</div>
              <div class="indicator-list" style="margin-top: 8px;">
                ${kpisForKR.map(kpi => {
                  const kpiRate = calcKPIRate(kpi.id);
                  const statusColor = kpiRate >= 80 ? 'var(--success)' : kpiRate >= 50 ? 'var(--warning)' : 'var(--danger)';
                  return `
                    <div class="indicator-item" style="cursor: pointer;" onclick="showKPIDetail('${kpi.id}')">
                      <div class="indicator-name">
                        <span style="color: ${statusColor}; font-size: 10px;">â—</span>
                        ${kpi.name}
                      </div>
                      <div class="indicator-value" style="color: ${statusColor};">${kpiRate}%</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `);
    }

    // KPI ìƒì„¸ ëª¨ë‹¬
    function showKPIDetail(kpiId) {
      const kpi = snapshotData.kpis.find(k => k.id === kpiId);
      const kr = snapshotData.keyResults.find(k => k.id === kpi.keyResultId);
      const krIdx = snapshotData.keyResults.findIndex(k => k.id === kpi.keyResultId);
      const lagsForKPI = snapshotData.laggingIndicators.filter(l => l.kpiId === kpiId);
      const kpiRate = calcKPIRate(kpiId);
      const statusColor = kpiRate >= 80 ? 'var(--success)' : kpiRate >= 50 ? 'var(--warning)' : 'var(--danger)';

      // í˜„ì¬ê°’ ê³„ì‚°
      let currentValue = 0;
      lagsForKPI.forEach(lag => {
        if (lag.type === 'output') {
          const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
          logs.forEach(log => {
            // â˜… FIXED: calcLagValue ë„ìš°ë¯¸ í•¨ìˆ˜ ì‚¬ìš©
            const value = calcLagValue(lag, log.resultValue || 0);
            currentValue += value;
          });
        }
      });

      showModal(`
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">ğŸ“Š ${kpi.name}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="detail-section" style="display: flex; gap: 16px; margin-bottom: 20px;">
              <div style="flex: 1; background: var(--gray-50); border-radius: 12px; padding: 16px; text-align: center;">
                <div class="detail-label">ëª©í‘œ</div>
                <div class="detail-value">${formatAmountWithSummary(kpi.targetValue, kpi.unit)}</div>
              </div>
              <div style="flex: 1; background: ${statusColor}15; border-radius: 12px; padding: 16px; text-align: center;">
                <div class="detail-label">í˜„ì¬</div>
                <div class="detail-value" style="color: ${statusColor};">${formatAmountWithSummary(currentValue, kpi.unit)}</div>
              </div>
              <div style="flex: 1; background: var(--gray-50); border-radius: 12px; padding: 16px; text-align: center;">
                <div class="detail-label">ë‹¬ì„±ë¥ </div>
                <div class="detail-value" style="color: ${statusColor};">${kpiRate}%</div>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">ì†Œì† KR</div>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                <span style="font-size: 16px;">${okrIcons[krIdx]}</span>
                <span style="font-size: 14px; font-weight: 600; color: ${okrColors[krIdx]};">${kr?.name || '-'}</span>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">ì—°ê²°ëœ ì§€í‘œ (${lagsForKPI.length}ê°œ)</div>
              <div class="indicator-list" style="margin-top: 8px;">
                ${lagsForKPI.length > 0 ? lagsForKPI.map(lag => {
                  const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
                  const totalValue = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                  return `
                    <div class="indicator-item">
                      <div class="indicator-name">
                        <span>${getLagIcon(lag.name)}</span>
                        ${lag.name}
                        <span style="font-size: 11px; padding: 2px 6px; border-radius: 10px; background: ${lag.type === 'output' ? 'var(--success-light)' : 'var(--gray-100)'}; color: ${lag.type === 'output' ? 'var(--success)' : 'var(--gray-500)'};">
                          ${lag.type === 'output' ? 'ì„±ê³¼ì§€í‘œ' : 'í™œë™í˜•'}
                        </span>
                      </div>
                      <div class="indicator-value">${totalValue.toLocaleString()}${lag.type === 'output' && lag.valuePerUnit ? ` Ã— ${lag.valuePerUnit.toLocaleString()}` : ''}</div>
                    </div>
                  `;
                }).join('') : '<div style="text-align: center; color: var(--gray-400); padding: 20px;">ì—°ê²°ëœ ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤</div>'}
              </div>
            </div>

            <div class="detail-progress-bar" style="margin-top: 16px;">
              <div class="detail-progress-fill" style="width: ${Math.min(kpiRate, 100)}%; background: ${statusColor};"></div>
            </div>
          </div>
        </div>
      `);
    }

    // ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ ë Œë”ë§
    function renderPersonalGrowthboard() {
      if (!snapshotData || !snapshotData.dailyLogs) return '';

      // íŒ€ì›ë³„ í†µê³„ ì§‘ê³„
      const memberStats = {};

      snapshotData.dailyLogs.forEach(log => {
        const memberId = log.memberId || 'unknown';
        const memberName = log.memberName || 'ì•Œ ìˆ˜ ì—†ìŒ';

        if (!memberStats[memberId]) {
          memberStats[memberId] = {
            id: memberId,
            name: memberName,
            totalCount: 0,
            activityCount: 0,
            resultValue: 0,
            krContributions: {}
          };
        }

        const lag = snapshotData.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        const isActivity = lag && lag.type !== 'output';
        const value = log.resultValue || 0;

        memberStats[memberId].totalCount += value;

        if (isActivity) {
          memberStats[memberId].activityCount += value;
        } else if (lag && lag.type === 'output') {
          // â˜… FIXED: calcLagValue ë„ìš°ë¯¸ í•¨ìˆ˜ ì‚¬ìš©
          const resultVal = calcLagValue(lag, value);
          memberStats[memberId].resultValue += resultVal;
        }

        // ë©”ì¸ KPIë³„ ê¸°ì—¬ë„
        const krId = log.krId;
        if (krId) {
          if (!memberStats[memberId].krContributions[krId]) {
            memberStats[memberId].krContributions[krId] = 0;
          }
          memberStats[memberId].krContributions[krId] += value;
        }
      });

      // ë°°ì—´ë¡œ ë³€í™˜ ë° ì •ë ¬
      const memberArray = Object.values(memberStats).sort((a, b) => b.totalCount - a.totalCount);

      if (memberArray.length === 0) {
        return '';
      }

      return `
        <!-- ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ -->
        <div class="card">
          <div class="card-title">ğŸ‘¤ ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ</div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">íŒ€ì›ë³„ í™œë™ í˜„í™© Â· KR ê¸°ì—¬ë„</p>
          <div style="overflow-x: auto;">
            <table class="kpi-table">
              <thead>
                <tr>
                  <th style="text-align: left; min-width: 100px;">íŒ€ì›</th>
                  <th style="text-align: center;">ì´ í™œë™</th>
                  <th style="text-align: center;">í–‰ë™ì§€í‘œ</th>
                  <th style="text-align: right;">Output Metric</th>
                  ${snapshotData.keyResults.map((kr, idx) => `
                    <th style="text-align: center; color: ${okrColors[idx]}; min-width: 80px;">
                      ${kr.name}
                    </th>
                  `).join('')}
                </tr>
              </thead>
              <tbody>
                ${memberArray.map(member => `
                  <tr>
                    <td style="font-weight: 600; color: var(--gray-800);">${member.name}</td>
                    <td style="text-align: center; font-weight: 700; color: var(--primary);">${member.totalCount}ê±´</td>
                    <td style="text-align: center; color: var(--gray-700);">${member.activityCount}ê±´</td>
                    <td style="text-align: right; font-weight: 600; color: var(--success);">${formatAmountWithSummary(member.resultValue, 'ì›')}</td>
                    ${snapshotData.keyResults.map((kr, idx) => {
                      const krCount = member.krContributions[kr.id] || 0;
                      return `
                        <td style="text-align: center;">
                          ${krCount > 0 ? `
                            <span style="display: inline-block; padding: 4px 10px; background: ${okrColors[idx]}15; color: ${okrColors[idx]}; border-radius: 12px; font-size: 12px; font-weight: 600;">
                              ${krCount}ê±´
                            </span>
                          ` : '<span style="color: var(--gray-300);">-</span>'}
                        </td>
                      `;
                    }).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ì„ íƒëœ íŒ€ì› ID (ì „ì—­ ìƒíƒœ)
    let selectedMemberId = null;

    // íŒ€ì› ì„ íƒ í•¨ìˆ˜
    function selectMember(memberId) {
      selectedMemberId = memberId;
      renderPersonalGrowthboardTab();
      // ì„ íƒëœ íŒ€ì› ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        const section = document.getElementById('memberAnalysisSection');
        if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    // íŒ€ì› ì„ íƒ í•´ì œ í•¨ìˆ˜
    function clearMemberSelection() {
      selectedMemberId = null;
      renderPersonalGrowthboardTab();
    }

    // ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ íƒ­ ë Œë”ë§ (ë…ë¦½ íƒ­)
    function renderPersonalGrowthboardTab() {
      const container = document.getElementById('content');
      if (!container || !snapshotData) return;

      // íŒ€ì›ë³„ í†µê³„ ì§‘ê³„
      const memberStats = {};

      snapshotData.dailyLogs.forEach(log => {
        const memberId = log.memberId || 'unknown';
        const memberName = log.memberName || 'ì•Œ ìˆ˜ ì—†ìŒ';

        if (!memberStats[memberId]) {
          memberStats[memberId] = {
            id: memberId,
            name: memberName,
            totalCount: 0,
            activityCount: 0,
            resultValue: 0,
            krContributions: {},
            kpiValues: {}  // KPIë³„ ì‹¤ì œ ê°’
          };
        }

        const lag = snapshotData.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        const isActivity = lag && lag.type !== 'output';
        const value = log.resultValue || 0;

        memberStats[memberId].totalCount += value;

        if (isActivity) {
          memberStats[memberId].activityCount += value;
        } else if (lag && lag.type === 'output') {
          // â˜… FIXED: calcLagValue ë„ìš°ë¯¸ í•¨ìˆ˜ ì‚¬ìš© (ê¸ˆì•¡ ë‹¨ìœ„ëŠ” valuePerUnit ì œì™¸)
          const resultVal = calcLagValue(lag, value);
          memberStats[memberId].resultValue += resultVal;

          // KPIë³„ ì‹¤ì œ ê°’ ê³„ì‚°
          const kpi = snapshotData.kpis.find(k => k.id === lag.kpiId);
          if (kpi) {
            if (!memberStats[memberId].kpiValues[kpi.id]) {
              memberStats[memberId].kpiValues[kpi.id] = 0;
            }
            memberStats[memberId].kpiValues[kpi.id] += resultVal;
          }
        }

        // ë©”ì¸ KPIë³„ ê¸°ì—¬ë„
        const krId = log.krId;
        if (krId) {
          if (!memberStats[memberId].krContributions[krId]) {
            memberStats[memberId].krContributions[krId] = 0;
          }
          memberStats[memberId].krContributions[krId] += value;
        }
      });

      // ê°œì¸ ëª©í‘œê°€ ì„¤ì •ëœ íŒ€ì›ë“¤
      const personalTargets = snapshotData.personalTargets || [];

      // ê°œì¸ ëª©í‘œë¥¼ ì„¤ì •í•œ íŒ€ì›ì´ memberStatsì— ì—†ìœ¼ë©´ ì¶”ê°€
      personalTargets.forEach(pt => {
        if (!memberStats[pt.memberId]) {
          memberStats[pt.memberId] = {
            id: pt.memberId,
            name: pt.memberName || 'ì•Œ ìˆ˜ ì—†ìŒ',
            totalCount: 0,
            activityCount: 0,
            resultValue: 0,
            krContributions: {},
            kpiValues: {}
          };
        }
      });

      // ë°°ì—´ë¡œ ë³€í™˜ ë° ì •ë ¬
      const memberArray = Object.values(memberStats).sort((a, b) => b.totalCount - a.totalCount);

      container.innerHTML = `
        <!-- íŒ€ì›ë³„ í™œë™ í˜„í™© -->
        <div class="card">
          <div class="card-title">ğŸ‘¤ íŒ€ì›ë³„ í™œë™ í˜„í™©</div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">íŒ€ì›ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ íŒ€ì›ì˜ ìƒì„¸ ë¶„ì„ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
          ${memberArray.length > 0 ? `
          <div style="overflow-x: auto;">
            <table class="kpi-table">
              <thead>
                <tr>
                  <th style="text-align: left; min-width: 100px;">íŒ€ì›</th>
                  <th style="text-align: center;">ì´ í™œë™</th>
                  <th style="text-align: center;">í–‰ë™ì§€í‘œ</th>
                  <th style="text-align: right;">Output Metric</th>
                  ${snapshotData.keyResults.map((kr, idx) => `
                    <th style="text-align: center; color: ${okrColors[idx]}; min-width: 80px;">
                      ${kr.name}
                    </th>
                  `).join('')}
                </tr>
              </thead>
              <tbody>
                ${memberArray.map(member => `
                  <tr onclick="selectMember('${member.id}')" style="cursor: pointer; transition: all 0.2s; ${selectedMemberId === member.id ? 'background: var(--primary)10; border-left: 3px solid var(--primary);' : ''}" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='${selectedMemberId === member.id ? 'var(--primary)10' : 'white'}'">
                    <td style="font-weight: 600; color: var(--gray-800);">
                      ${selectedMemberId === member.id ? 'âœ“ ' : ''}${member.name}
                      ${selectedMemberId === member.id ? '<span style="font-size: 10px; color: var(--primary); margin-left: 4px;">ì„ íƒë¨</span>' : ''}
                    </td>
                    <td style="text-align: center; font-weight: 700; color: var(--primary);">${member.totalCount}ê±´</td>
                    <td style="text-align: center; color: var(--gray-700);">${member.activityCount}ê±´</td>
                    <td style="text-align: right; font-weight: 600; color: var(--success);">${formatAmountWithSummary(member.resultValue, 'ì›')}</td>
                    ${snapshotData.keyResults.map((kr, idx) => {
                      const krCount = member.krContributions[kr.id] || 0;
                      return `
                        <td style="text-align: center;">
                          ${krCount > 0 ? `
                            <span style="display: inline-block; padding: 4px 10px; background: ${okrColors[idx]}15; color: ${okrColors[idx]}; border-radius: 12px; font-size: 12px; font-weight: 600;">
                              ${krCount}ê±´
                            </span>
                          ` : '<span style="color: var(--gray-300);">-</span>'}
                        </td>
                      `;
                    }).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          ` : `
          <div style="text-align: center; padding: 60px 20px; color: var(--gray-400);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¥</div>
            <div style="font-size: 15px; font-weight: 500;">íŒ€ì› í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 13px; margin-top: 8px;">ì—…ë¬´ ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
          `}
        </div>

        <!-- ì„ íƒëœ íŒ€ì› ë¶„ì„ ì„¹ì…˜ -->
        <div id="memberAnalysisSection">
        ${(() => {
          const selectedMember = selectedMemberId ? memberArray.find(m => m.id === selectedMemberId) : null;
          const memberName = selectedMember ? selectedMember.name : 'ì „ì²´ íŒ€';

          return selectedMemberId ? `
            <!-- ì„ íƒëœ íŒ€ì› í—¤ë” -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, var(--primary), #8B5CF6); color: white;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">ì„ íƒëœ íŒ€ì›</div>
                  <div style="font-size: 24px; font-weight: 800;">ğŸ‘¤ ${memberName}</div>
                </div>
                <button onclick="clearMemberSelection()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer;">
                  âœ• ì„ íƒ í•´ì œ
                </button>
              </div>
            </div>
          ` : '';
        })()}

        <!-- í™œë™í˜•/ì´ ì„±ê³¼ì§€í‘œ ë¹„ìœ¨ ìš”ì•½ -->
        ${(() => {
          const allLags = snapshotData.laggingIndicators || [];
          // ì„ íƒëœ íŒ€ì›ì´ ìˆìœ¼ë©´ í•´ë‹¹ íŒ€ì›ì˜ ë¡œê·¸ë§Œ í•„í„°ë§
          const dailyLogs = selectedMemberId
            ? (snapshotData.dailyLogs || []).filter(log => log.memberId === selectedMemberId)
            : (snapshotData.dailyLogs || []);

          const selectedMember = selectedMemberId ? memberArray.find(m => m.id === selectedMemberId) : null;
          const memberName = selectedMember ? selectedMember.name + 'ë‹˜ì˜' : 'ì „ì²´';

          // í™œë™í˜•/ì´ ì„±ê³¼ì§€í‘œ ë¶„ë¥˜
          const activityLagIds = allLags.filter(lag => lag.type !== 'output').map(l => l.id);
          const resultLagIds = allLags.filter(lag => lag.type === 'output').map(l => l.id);

          // ê¸°ë¡ ê±´ìˆ˜ ê³„ì‚°
          const activityCount = dailyLogs
            .filter(log => activityLagIds.includes(log.laggingIndicatorId))
            .reduce((sum, log) => sum + (log.resultValue || 0), 0);
          const resultCount = dailyLogs
            .filter(log => resultLagIds.includes(log.laggingIndicatorId))
            .reduce((sum, log) => sum + (log.resultValue || 0), 0);

          const totalCount = activityCount + resultCount;
          const activityPercent = totalCount > 0 ? Math.round((activityCount / totalCount) * 100) : 0;
          const resultPercent = totalCount > 0 ? Math.round((resultCount / totalCount) * 100) : 0;

          // ì§‘ì¤‘ë„ ë¶„ì„
          let focusMessage = '';
          let focusColor = 'var(--gray-600)';
          if (totalCount === 0) {
            focusMessage = 'ì•„ì§ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤';
          } else if (resultPercent >= 60) {
            focusMessage = 'ì´ ì„±ê³¼ì§€í‘œì— ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤';
            focusColor = 'var(--success)';
          } else if (activityPercent >= 60) {
            focusMessage = 'í™œë™í˜• ì§€í‘œì— ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤';
            focusColor = 'var(--primary)';
          } else {
            focusMessage = 'í™œë™í˜• ì§€í‘œì™€ ì´ ì„±ê³¼ì§€í‘œê°€ ê· í˜•ìˆê²Œ ì§„í–‰ë˜ê³  ìˆìŠµë‹ˆë‹¤';
            focusColor = 'var(--purple)';
          }

          return `
            <div class="card" style="margin-bottom: 20px;">
              <div class="card-title">ğŸ“Š ${memberName} í™œë™ í˜„í™©</div>
              <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 20px;">ì–´ë””ì— ì—´ì‹¬íˆ í–‰ë™í•˜ê³  ì„±ê³¼ë¥¼ ëƒˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”</p>

              <!-- ìƒì„¸ ìˆ˜ì¹˜ -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div style="background: linear-gradient(135deg, #E0F2FE, #BAE6FD); border-radius: 16px; padding: 20px; text-align: center;">
                  <div style="font-size: 13px; color: #0369A1; margin-bottom: 8px; font-weight: 600;">ğŸ“‹ í™œë™í˜•(Input)</div>
                  <div style="font-size: 36px; font-weight: 800; color: #0C4A6E;">${activityCount}<span style="font-size: 16px; font-weight: 600;">ê±´</span></div>
                  <div style="font-size: 12px; color: #0369A1; margin-top: 4px;">ì¼ì¼ ì—…ë¬´ í™œë™ ê¸°ë¡</div>
                </div>
                <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 20px; text-align: center;">
                  <div style="font-size: 13px; color: #D97706; margin-bottom: 8px; font-weight: 600;">ğŸ’° ì„±ê³¼í˜•(Output)</div>
                  <div style="font-size: 36px; font-weight: 800; color: #B45309;">${resultCount}<span style="font-size: 16px; font-weight: 600;">ê±´</span></div>
                  <div style="font-size: 12px; color: #D97706; margin-top: 4px;">ë§¤ì¶œ/ì‹¤ì  ì„±ê³¼ ê¸°ë¡</div>
                </div>
              </div>
            </div>
          `;
        })()}

        <!-- í•˜ìœ„ì§€í‘œ ì„¹ì…˜ (ê°œì„ ëœ ì¹´ë“œ í˜•ì‹) -->
        <div class="card">
          <div class="section-header">
            <div class="section-title">ğŸ“Š í•˜ìœ„ì§€í‘œ í˜„í™©</div>
            <div class="section-count">${(() => {
              const allLags = snapshotData.laggingIndicators || [];
              return allLags.length;
            })()}ê°œ</div>
          </div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">
            ${selectedMemberId ? 'ì„ íƒëœ íŒ€ì›ì˜ í•˜ìœ„ì§€í‘œë³„ ì¶•ì  í˜„í™©ì…ë‹ˆë‹¤' : 'ì „ì²´ í•˜ìœ„ì§€í‘œì˜ ì¶•ì  í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”'}
          </p>

          ${(() => {
            const allLags = snapshotData.laggingIndicators || [];
            const filteredLogs = selectedMemberId
              ? snapshotData.dailyLogs.filter(l => l.memberId === selectedMemberId)
              : snapshotData.dailyLogs;

            if (allLags.length === 0) {
              return `
                <div class="empty-state">
                  <div class="empty-state-icon">ğŸ“Š</div>
                  <div class="empty-state-title">ì•„ì§ í•˜ìœ„ì§€í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
                  <div class="empty-state-desc">í•˜ìœ„ì§€í‘œë¥¼ ì¶”ê°€í•˜ë©´ ì´ê³³ì—ì„œ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                </div>
              `;
            }

            return `
              <div class="sub-kpi-grid">
                ${allLags.map(lag => {
                  const kpi = snapshotData.kpis.find(k => k.id === lag.kpiId);
                  const kr = kpi ? snapshotData.keyResults.find(k => k.id === kpi.keyResultId) : null;
                  const krIdx = kr ? snapshotData.keyResults.findIndex(k => k.id === kpi.keyResultId) : 0;

                  const logs = filteredLogs.filter(l => l.laggingIndicatorId === lag.id);
                  const totalCount = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);

                  // ìƒ‰ìƒ: ê¸°ë¡ì´ ìˆìœ¼ë©´ í™œë™í˜•=íŒŒë‘, ì„±ê³¼í˜•=ë…¹ìƒ‰ / ì—†ìœ¼ë©´ íšŒìƒ‰
                  const statusColor = logs.length > 0 ? (lag.type === 'output' ? 'var(--success)' : 'var(--primary)') : 'var(--gray-400)';

                  // ìµœê·¼ 7ì¼ íŠ¸ë Œë“œ ê³„ì‚°
                  const recentLogs = logs.slice(-7);
                  const last7Days = recentLogs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                  const prev7Days = logs.slice(-14, -7).reduce((sum, l) => sum + (l.resultValue || 0), 0);
                  const trendPercent = prev7Days > 0 ? Math.round(((last7Days - prev7Days) / prev7Days) * 100) : 0;
                  const isUp = trendPercent > 0;
                  const isFlat = trendPercent === 0;

                  const typeIcon = lag.type === 'output' ? 'ğŸ’°' : 'ğŸ“‹';
                  const typeName = lag.type === 'output' ? 'ì„±ê³¼ì§€í‘œ' : 'í™œë™ì§€í‘œ';
                  const typeColor = lag.type === 'output' ? 'var(--success)' : 'var(--primary)';

                  return `
                    <div class="sub-kpi-card">
                      <div class="sub-kpi-card-header">
                        <div class="sub-kpi-name">
                          ${typeIcon} ${lag.name}
                        </div>
                      </div>

                      <div style="font-size: 11px; color: ${typeColor}; font-weight: 600; margin-bottom: 12px;">
                        ${typeName} ${kr ? `Â· ${okrIcons[krIdx]} ${kr.name}` : ''}
                      </div>

                      <div style="background: ${statusColor}15; border-radius: 12px; padding: 16px; text-align: center; margin-bottom: 12px;">
                        <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 6px;">ğŸ“ˆ ëˆ„ì  ê¸°ë¡</div>
                        <div style="font-size: 32px; font-weight: 800; color: ${statusColor};">${totalCount}</div>
                        <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">${logs.length}íšŒ ê¸°ë¡ë¨</div>
                      </div>

                      ${logs.length > 0 ? `
                        <div class="sub-kpi-trend" style="background: ${isUp ? 'var(--success)10' : isFlat ? 'var(--gray-100)' : 'var(--danger)10'};">
                          <span class="sub-kpi-trend-icon">
                            ${isUp ? 'ğŸ“ˆ' : isFlat ? 'â¡ï¸' : 'ğŸ“‰'}
                          </span>
                          <span class="sub-kpi-trend-text" style="color: ${isUp ? 'var(--success)' : isFlat ? 'var(--gray-600)' : 'var(--danger)'};">
                            ìµœê·¼ 7ì¼ ${isUp ? '+' : ''}${trendPercent}%
                          </span>
                        </div>
                      ` : `
                        <div class="sub-kpi-trend">
                          <span class="sub-kpi-trend-icon">ğŸ“Š</span>
                          <span class="sub-kpi-trend-text" style="color: var(--gray-500);">
                            ë°ì´í„° ì—†ìŒ
                          </span>
                        </div>
                      `}
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          })()}
        </div>

        <!-- ABí…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="card">
          <div class="section-header">
            <div class="section-title">ğŸ§ª ABí…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
            <div class="section-count">${(() => {
              const abTests = snapshotData.abTests || [];
              return abTests.length;
            })()}ê°œ</div>
          </div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">
            ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ ABí…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¹„êµí•˜ì„¸ìš”
          </p>

          ${(() => {
            const abTests = snapshotData.abTests || [];

            if (abTests.length === 0) {
              return `
                <div class="empty-state">
                  <div class="empty-state-icon">ğŸ§ª</div>
                  <div class="empty-state-title">ì§„í–‰ ì¤‘ì¸ ABí…ŒìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                  <div class="empty-state-desc">ABí…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì—¬ ì–´ë–¤ ë°©ë²•ì´ ë” íš¨ê³¼ì ì¸ì§€ í™•ì¸í•´ë³´ì„¸ìš”</div>
                  <button class="empty-state-cta" onclick="alert('ABí…ŒìŠ¤íŠ¸ ìƒì„± ê¸°ëŠ¥ì€ ë©”ì¸ ì•±ì—ì„œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤')">
                    ABí…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°
                  </button>
                </div>
              `;
            }

            return `
              <div class="ab-test-grid">
                ${abTests.map(test => {
                  const variantA = test.variantA || {};
                  const variantB = test.variantB || {};
                  const aRate = variantA.conversionRate || 0;
                  const bRate = variantB.conversionRate || 0;
                  const winner = aRate > bRate ? 'A' : bRate > aRate ? 'B' : null;

                  return `
                    <div class="ab-test-comparison">
                      <div class="ab-test-header">
                        <div class="ab-test-title">${test.name || 'ABí…ŒìŠ¤íŠ¸'}</div>
                        <div class="ab-test-period">${test.startDate || ''} ~ ${test.endDate || 'ì§„í–‰ì¤‘'}</div>
                      </div>

                      <div class="ab-test-variants">
                        <div class="ab-variant ab-variant-a ${winner === 'A' ? 'ab-variant-winner' : ''}">
                          ${winner === 'A' ? '<div class="ab-test-winner-badge">ğŸ† ìŠ¹ì</div>' : ''}
                          <div class="ab-variant-label" style="color: #3182f6;">
                            <span>Aì•ˆ</span>
                          </div>
                          <div class="ab-variant-metric" style="color: #3182f6;">
                            ${aRate.toFixed(1)}%
                          </div>
                          <div class="ab-variant-desc">ì „í™˜ìœ¨</div>
                          ${variantA.value !== undefined ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(49, 130, 246, 0.2);">
                              <div style="font-size: 11px; color: var(--gray-600);">ì£¼ìš” ì§€í‘œ</div>
                              <div style="font-size: 16px; font-weight: 700; color: #3182f6; margin-top: 2px;">
                                ${formatAmountWithSummary(variantA.value, variantA.unit || '')}
                              </div>
                            </div>
                          ` : ''}
                        </div>

                        <div class="ab-variant ab-variant-b ${winner === 'B' ? 'ab-variant-winner' : ''}">
                          ${winner === 'B' ? '<div class="ab-test-winner-badge">ğŸ† ìŠ¹ì</div>' : ''}
                          <div class="ab-variant-label" style="color: #00c073;">
                            <span>Bì•ˆ</span>
                          </div>
                          <div class="ab-variant-metric" style="color: #00c073;">
                            ${bRate.toFixed(1)}%
                          </div>
                          <div class="ab-variant-desc">ì „í™˜ìœ¨</div>
                          ${variantB.value !== undefined ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0, 192, 115, 0.2);">
                              <div style="font-size: 11px; color: var(--gray-600);">ì£¼ìš” ì§€í‘œ</div>
                              <div style="font-size: 16px; font-weight: 700; color: #00c073; margin-top: 2px;">
                                ${formatAmountWithSummary(variantB.value, variantB.unit || '')}
                              </div>
                            </div>
                          ` : ''}
                        </div>
                      </div>

                      ${winner ? `
                        <div style="text-align: center; padding: 12px; background: linear-gradient(135deg, #FFF9E6, #FFE6B3); border-radius: 8px; margin-top: 12px;">
                          <div style="font-size: 12px; font-weight: 600; color: #D97706;">
                            ${winner}ì•ˆì´ ${Math.abs(aRate - bRate).toFixed(1)}%p ë” ë†’ì€ ì „í™˜ìœ¨ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤
                          </div>
                        </div>
                      ` : `
                        <div style="text-align: center; padding: 12px; background: var(--gray-100); border-radius: 8px; margin-top: 12px;">
                          <div style="font-size: 12px; font-weight: 600; color: var(--gray-600);">
                            ë‘ ë°©ì•ˆì´ ë™ì¼í•œ ì„±ê³¼ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤
                          </div>
                        </div>
                      `}

                      ${test.description ? `
                        <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                          <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">í…ŒìŠ¤íŠ¸ ì„¤ëª…</div>
                          <div style="font-size: 12px; color: var(--gray-700);">${test.description}</div>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          })()}
        </div>
        </div> <!-- memberAnalysisSection ë‹«ê¸° -->

        <!-- ê°œì¸ ëª©í‘œ í† ê¸€ ë²„íŠ¼ -->
        <div style="text-align: center; margin: 24px 0;">
          <button onclick="togglePersonalGoals()" id="personalGoalsToggleBtn" style="padding: 14px 32px; background: linear-gradient(135deg, var(--primary), #818CF8); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px;">
            <span>ğŸ¯</span>
            <span>ê°œì¸ ëª©í‘œ ë° ì§„ì²™ë„ ë³´ê¸°</span>
            <span id="personalGoalsArrow" style="transition: transform 0.3s;">â–¼</span>
          </button>
        </div>

        <!-- ê°œì¸ ëª©í‘œ ì„¤ì • ë° ì§„ì²™ë„ (ê¸°ë³¸ ìˆ¨ê¹€) -->
        <div id="personalGoalsSection" style="display: none;">
          <div class="card">
            <div class="card-title">ğŸ¯ ê°œì¸ ëª©í‘œ ì„¤ì • ë° ì§„ì²™ë„</div>
            <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">íŒ€ì›ë³„ ê°œì¸ ëª©í‘œ ë‹¬ì„± í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>

          ${memberArray.length > 0 ? memberArray.map(member => {
            // ì´ íŒ€ì›ì˜ ê°œì¸ ëª©í‘œë“¤
            const memberTargets = personalTargets.filter(pt => pt.memberId === member.id);

            // ì´ íŒ€ì›ì´ ê´€ë ¨ëœ KPIë“¤ (ì£¼ ë‹´ë‹¹ì, ë¶€ ë‹´ë‹¹ì, ë˜ëŠ” ê°œì¸ ëª©í‘œë¥¼ ì„¤ì •í•œ KPI)
            const relatedKPIs = snapshotData.kpis.filter(kpi =>
              kpi.mainAssignee === member.id ||
              (kpi.subAssignees && kpi.subAssignees.includes(member.id)) ||
              memberTargets.some(pt => pt.kpiId === kpi.id)
            );

            if (relatedKPIs.length === 0 && memberTargets.length === 0) return '';

            return `
              <div style="margin-bottom: 24px; padding: 20px; background: var(--gray-50); border-radius: 12px; border-left: 4px solid var(--primary);">
                <div style="font-size: 15px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                  ğŸ‘¤ ${member.name}
                </div>

                <div style="display: grid; gap: 12px;">
                  ${relatedKPIs.map(kpi => {
                    const kr = snapshotData.keyResults.find(k => k.id === kpi.keyResultId);
                    const krIdx = snapshotData.keyResults.findIndex(k => k.id === kpi.keyResultId);
                    const personalTarget = memberTargets.find(pt => pt.kpiId === kpi.id);
                    const actualValue = member.kpiValues[kpi.id] || 0;

                    if (!personalTarget) {
                      // ëª©í‘œ ë¯¸ì„¤ì •
                      return `
                        <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid var(--gray-200);">
                          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                              <div style="font-size: 13px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">
                                ${kpi.name}
                              </div>
                              <div style="font-size: 11px; color: var(--gray-500);">
                                ${kr ? `${okrIcons[krIdx]} ${kr.name}` : ''}
                              </div>
                            </div>
                            <div style="padding: 4px 12px; background: var(--gray-200); color: var(--gray-600); border-radius: 12px; font-size: 11px; font-weight: 600;">
                              ë¯¸ì„¤ì •
                            </div>
                          </div>
                          <div style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">
                            í˜„ì¬: ${formatAmountWithSummary(actualValue, kpi.unit || '')}
                          </div>
                        </div>
                      `;
                    } else {
                      // ëª©í‘œ ì„¤ì •ë¨
                      const targetValue = personalTarget.targetValue || 0;
                      const achievementRate = targetValue > 0 ? Math.min(Math.round((actualValue / targetValue) * 100), 100) : 0;
                      const remaining = Math.max(targetValue - actualValue, 0);
                      const statusColor = achievementRate >= 100 ? 'var(--success)' : achievementRate >= 70 ? 'var(--primary)' : achievementRate >= 40 ? 'var(--warning)' : 'var(--danger)';

                      return `
                        <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid ${statusColor};">
                          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                              <div style="font-size: 13px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">
                                ${kpi.name}
                              </div>
                              <div style="font-size: 11px; color: var(--gray-500);">
                                ${kr ? `${okrIcons[krIdx]} ${kr.name}` : ''}
                              </div>
                            </div>
                            <div style="padding: 4px 12px; background: ${statusColor}; color: white; border-radius: 12px; font-size: 12px; font-weight: 700;">
                              ${achievementRate}%
                            </div>
                          </div>

                          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                            <div style="text-align: center; padding: 8px; background: var(--gray-50); border-radius: 8px;">
                              <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">ëª©í‘œ</div>
                              <div style="font-size: 12px; font-weight: 600; color: var(--gray-700);">${formatAmountWithSummary(targetValue, kpi.unit || '')}</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: ${statusColor}15; border-radius: 8px;">
                              <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">í˜„ì¬</div>
                              <div style="font-size: 12px; font-weight: 600; color: ${statusColor};">${formatAmountWithSummary(actualValue, kpi.unit || '')}</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: var(--gray-50); border-radius: 8px;">
                              <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">ë‚¨ì€ ëª©í‘œ</div>
                              <div style="font-size: 12px; font-weight: 600; color: var(--gray-600);">${formatAmountWithSummary(remaining, kpi.unit || '')}</div>
                            </div>
                          </div>

                          <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${achievementRate}%; background: ${statusColor}; border-radius: 4px; transition: width 0.5s;"></div>
                          </div>
                        </div>
                      `;
                    }
                  }).join('')}
                </div>
              </div>
            `;
          }).join('') : `
          <div style="text-align: center; padding: 60px 20px; color: var(--gray-400);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¯</div>
            <div style="font-size: 15px; font-weight: 500;">ê°œì¸ ëª©í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 13px; margin-top: 8px;">íŒ€ì›ë“¤ì´ ê°œì¸ ëª©í‘œë¥¼ ì„¤ì •í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
          `}
          </div>
        </div>
      `;
    }

    // ë Œë”ë§
    // ê°œì¸ ëª©í‘œ ì„¹ì…˜ í† ê¸€
    let personalGoalsVisible = false;
    function togglePersonalGoals() {
      const section = document.getElementById('personalGoalsSection');
      const btn = document.getElementById('personalGoalsToggleBtn');
      const arrow = document.getElementById('personalGoalsArrow');

      if (!section || !btn) return;

      personalGoalsVisible = !personalGoalsVisible;

      if (personalGoalsVisible) {
        section.style.display = 'block';
        section.style.animation = 'fadeIn 0.3s ease';
        btn.innerHTML = '<span>ğŸ¯</span><span>ê°œì¸ ëª©í‘œ ë° ì§„ì²™ë„ ì ‘ê¸°</span><span id="personalGoalsArrow" style="transition: transform 0.3s; transform: rotate(180deg);">â–¼</span>';
        btn.style.background = 'linear-gradient(135deg, #6B7280, #9CA3AF)';
      } else {
        section.style.display = 'none';
        btn.innerHTML = '<span>ğŸ¯</span><span>ê°œì¸ ëª©í‘œ ë° ì§„ì²™ë„ ë³´ê¸°</span><span id="personalGoalsArrow" style="transition: transform 0.3s;">â–¼</span>';
        btn.style.background = 'linear-gradient(135deg, var(--primary), #818CF8)';
      }
    }

    function render() {
      const container = document.getElementById('content');
      if (!container || !snapshotData) return;

      if (currentTab === 'team') {
        renderTeamGrowthboard();
      } else {
        renderPersonalGrowthboardTab();
      }
    }

    // íŒ€ ê·¸ë¡œìŠ¤ë³´ë“œ ë Œë”ë§
    function renderTeamGrowthboard() {
      const container = document.getElementById('content');
      if (!container || !snapshotData) return;

      const oRate = calcObjectiveRate();
      const krRates = snapshotData.keyResults.map(kr => ({ ...kr, rate: calcKRRate(kr.id) }));

      // KPI í˜„í™© ë°ì´í„°
      const kpiStatusData = snapshotData.kpis.map(kpi => {
        const kr = snapshotData.keyResults.find(k => k.id === kpi.keyResultId);
        const krIdx = snapshotData.keyResults.findIndex(k => k.id === kpi.keyResultId);
        const rate = calcKPIRate(kpi.id);
        const lagsForKPI = snapshotData.laggingIndicators.filter(l => l.kpiId === kpi.id);
        let currentValue = 0;
        lagsForKPI.forEach(lag => {
          if (lag.type === 'output') {
            const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
            logs.forEach(log => {
              // â˜… FIXED: calcLagValue ë„ìš°ë¯¸ í•¨ìˆ˜ ì‚¬ìš© (ê¸ˆì•¡ ë‹¨ìœ„ëŠ” valuePerUnit ì œì™¸)
              const value = calcLagValue(lag, log.resultValue || 0);
              currentValue += value;
            });
          }
        });
        return { ...kpi, kr, krIdx, rate, currentValue };
      }).sort((a, b) => a.krIdx - b.krIdx);

      // í™œë™í˜• ì§€í‘œ/ì´ ì„±ê³¼ì§€í‘œ ìš”ì•½
      const activityLags = snapshotData.laggingIndicators.filter(l => l.type !== 'output');
      const resultLags = snapshotData.laggingIndicators.filter(l => l.type === 'output');

      const activityLogs = snapshotData.dailyLogs.filter(log => {
        const lag = snapshotData.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        return lag && lag.type !== 'output';
      });
      const totalActivityCount = activityLogs.reduce((sum, l) => sum + (l.resultValue || 0), 0);

      let totalResultValue = 0;
      snapshotData.dailyLogs.forEach(log => {
        const lag = snapshotData.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        if (lag && lag.type === 'output') {
          // â˜… FIXED: calcLagValue ë„ìš°ë¯¸ í•¨ìˆ˜ ì‚¬ìš©
          const value = calcLagValue(lag, log.resultValue || 0);
          totalResultValue += value;
        }
      });

      container.innerHTML = `
        <!-- ëª©í‘œ ì¹´ë“œ -->
        <div class="objective-card">
          <div class="objective-name">ëª©í‘œ(O): ${snapshotData.objective?.name || 'ë¯¸ì„¤ì •'}</div>
          <div class="objective-period">${snapshotData.objective?.startDate || ''} ~ ${snapshotData.objective?.endDate || ''}</div>
          <div class="objective-rate">${oRate}%</div>
          <div class="objective-progress">
            <div class="objective-progress-fill" style="width: ${Math.min(oRate, 100)}%;"></div>
          </div>
        </div>

        <!-- ë©”ì¸ KPI í˜„í™© -->
        <div class="card">
          <div class="card-title">ğŸ“ˆ ë©”ì¸ KPI í˜„í™©</div>
          <div class="kr-grid">
            ${krRates.map((kr, idx) => `
              <div class="kr-card" style="border-left: 4px solid ${okrColors[idx]};" onclick="showKRDetail('${kr.id}')">
                <div class="kr-header">
                  <div class="kr-name">
                    <span>${okrIcons[idx] || 'ğŸ“Š'}</span> ${kr.name}
                  </div>
                  <span class="kr-badge" style="background: ${okrColors[idx]}20; color: ${okrColors[idx]};">${kr.rate}%</span>
                </div>
                <div class="kr-progress">
                  <div class="kr-progress-fill" style="width: ${Math.min(kr.rate, 100)}%; background: ${okrColors[idx]};"></div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- KPI í˜„í™© í…Œì´ë¸” -->
        <div class="card">
          <div class="card-title">ğŸ“Š KPI í˜„í™©</div>
          <div style="overflow-x: auto;">
            <table class="kpi-table">
              <thead>
                <tr>
                  <th>KR</th>
                  <th>KPI</th>
                  <th style="text-align: right;">ëª©í‘œ</th>
                  <th style="text-align: right;">í˜„ì¬</th>
                  <th style="text-align: right;">ë‹¬ì„±ë¥ </th>
                  <th style="text-align: center; width: 100px;">ì§„í–‰</th>
                </tr>
              </thead>
              <tbody>
                ${(() => {
                  if (kpiStatusData.length === 0) {
                    return '<tr><td colspan="6" style="padding: 30px; text-align: center; color: var(--gray-400);">ë“±ë¡ëœ KPIê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                  }

                  const krGroups = {};
                  kpiStatusData.forEach(kpi => {
                    const krId = kpi.keyResultId;
                    if (!krGroups[krId]) krGroups[krId] = [];
                    krGroups[krId].push(kpi);
                  });

                  const renderedKRs = new Set();

                  return kpiStatusData.map((kpi, idx) => {
                    const statusColor = kpi.rate >= 80 ? 'var(--success)' : kpi.rate >= 50 ? 'var(--warning)' : 'var(--danger)';
                    const krId = kpi.keyResultId;
                    const rowspan = krGroups[krId]?.length || 1;
                    const showKrCell = !renderedKRs.has(krId);

                    if (showKrCell) renderedKRs.add(krId);

                    return `
                      <tr class="kpi-row" onclick="showKPIDetail('${kpi.id}')">
                        ${showKrCell ? `
                        <td style="vertical-align: middle; background: ${okrColors[kpi.krIdx]}10;" rowspan="${rowspan}">
                          <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${okrColors[kpi.krIdx]}20; color: ${okrColors[kpi.krIdx]}; white-space: nowrap;">
                            <span style="font-size: 10px;">â—</span> ${kpi.kr?.name || '-'}
                          </span>
                        </td>
                        ` : ''}
                        <td style="font-weight: 500; color: var(--gray-800);">
                          <div><span style="color: ${statusColor}; font-size: 10px;">â—</span> ${kpi.name}</div>
                          ${kpi.mainAssigneeName || (kpi.subAssigneeNames && kpi.subAssigneeNames.length > 0) ? `
                            <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">
                              ${kpi.mainAssigneeName ? `â­ ${kpi.mainAssigneeName}` : ''}${kpi.subAssigneeNames && kpi.subAssigneeNames.length > 0 ? ` | ${kpi.subAssigneeNames.join('â€¢')}` : ''}
                            </div>
                          ` : ''}
                        </td>
                        <td style="text-align: right; color: var(--gray-500);">${formatAmountWithSummary(kpi.targetValue || 0, kpi.unit || '')}</td>
                        <td style="text-align: right; font-weight: 600; color: var(--gray-700);">${formatAmountWithSummary(kpi.currentValue, kpi.unit || '')}</td>
                        <td style="text-align: right;">
                          <span style="font-weight: 700; color: ${statusColor};">${kpi.rate}%</span>
                        </td>
                        <td style="width: 100px;">
                          <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(kpi.rate, 100)}%; background: ${statusColor}; border-radius: 3px;"></div>
                          </div>
                        </td>
                      </tr>
                    `;
                  }).join('');
                })()}
              </tbody>
            </table>
          </div>
        </div>

        <!-- í™œë™ vs ì„±ê³¼ ìš”ì•½ -->
        <div class="card">
          <div class="card-title">ğŸ“Š í™œë™ vs ì„±ê³¼ í˜„í™©</div>
          <div class="summary-grid">
            <div class="summary-box activity">
              <div class="summary-title">
                ğŸ“‹ í™œë™í˜• ì§€í‘œ
                <span style="font-size: 11px; padding: 2px 8px; background: var(--gray-200); color: var(--gray-600); border-radius: 10px;">ì°¸ê³ ìš©</span>
              </div>
              <div class="summary-row">
                <span style="color: var(--gray-500);">ë“±ë¡ëœ ì§€í‘œ</span>
                <span style="font-weight: 600;">${activityLags.length}ê°œ</span>
              </div>
              <div class="summary-row">
                <span style="color: var(--gray-500);">ì´ í™œë™ íšŸìˆ˜</span>
                <span style="font-weight: 600;">${totalActivityCount.toLocaleString()}ê±´</span>
              </div>
            </div>
            <div class="summary-box result">
              <div class="summary-title">
                ğŸ’° ì´ ì„±ê³¼ì§€í‘œ
                <span style="font-size: 11px; padding: 2px 8px; background: var(--success); color: white; border-radius: 10px;">KPI ë°˜ì˜</span>
              </div>
              <div class="summary-row">
                <span style="color: var(--gray-600);">ë“±ë¡ëœ ì§€í‘œ</span>
                <span style="font-weight: 600;">${resultLags.length}ê°œ</span>
              </div>
              <div class="summary-row">
                <span style="color: var(--gray-600);">ì´ ì„±ê³¼ ê¸ˆì•¡</span>
                <span style="font-weight: 700; color: var(--success);">${formatAmountWithSummary(totalResultValue, 'ì›')}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ìë™ ê°±ì‹ ìš© ì „ì—­ ë³€ìˆ˜
    let autoRefreshInterval = null;
    let currentToken = null;
    let isRealtime = false;

    // ë°ì´í„° ê°±ì‹  í•¨ìˆ˜
    async function refreshData() {
      if (!currentToken) return;

      try {
        const result = await validateAndLoadSnapshot(currentToken);
        if (result.valid) {
          snapshotData = result.data;
          render();

          // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê° í‘œì‹œ
          const dateEl = document.getElementById('snapshotDate');
          if (dateEl && isRealtime) {
            const now = new Date();
            dateEl.textContent = `ìµœì¢… ì—…ë°ì´íŠ¸: ${now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;
          }
        }
      } catch (e) {
        console.error('ìë™ ê°±ì‹  ì‹¤íŒ¨:', e);
      }
    }

    // ì´ˆê¸°í™”
    async function init() {
      const token = getTokenFromUrl();
      currentToken = token;
      const result = await validateAndLoadSnapshot(token);

      document.getElementById('loading').style.display = 'none';

      if (!result.valid) {
        document.getElementById('errorMessage').textContent = result.error;
        document.getElementById('error').style.display = 'flex';
        return;
      }

      snapshotData = result.data;
      isRealtime = result.isRealtime;

      // ë°°ì§€ ì—…ë°ì´íŠ¸
      const badgeEl = document.getElementById('modeBadge');
      if (badgeEl) {
        if (isRealtime) {
          badgeEl.textContent = 'ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™”';
          badgeEl.style.background = 'rgba(255,255,255,0.3)';
        } else {
          badgeEl.textContent = 'ğŸ“¸ ìŠ¤ëƒ…ìƒ·';
          badgeEl.style.background = 'rgba(255,255,255,0.2)';
        }
      }

      // ë‚ ì§œ í‘œì‹œ
      const dateEl = document.getElementById('snapshotDate');
      if (dateEl) {
        if (isRealtime) {
          const now = new Date();
          dateEl.textContent = `ìµœì¢… ì—…ë°ì´íŠ¸: ${now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;

          // 1ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹ 
          autoRefreshInterval = setInterval(refreshData, 60000); // 60ì´ˆ = 1ë¶„
        } else {
          // ìŠ¤ëƒ…ìƒ· ëª¨ë“œ
          const date = new Date(result.createdAt);
          dateEl.textContent = `ìƒì„±ì¼: ${date.toLocaleDateString('ko-KR')} ${date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}`;
        }
      }

      document.getElementById('app').style.display = 'block';
      render();
    }

    init();

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ íƒ€ì´ë¨¸ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒ€ & ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ - ì™¸ë¶€ ê³µìœ </title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #3182f6;
      --primary-light: #eef4ff;
      --primary-dark: #1b64da;
      --white: #ffffff;
      --gray-900: #191f28;
      --gray-800: #333d4b;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      --success: #00c073;
      --success-light: #e8f7f0;
      --warning: #fc9600;
      --warning-light: #fff8f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --purple: #6366F1;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ë¡œë”©/ì—ëŸ¬ í™”ë©´ */
    .loading-screen, .error-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, var(--purple), #8B5CF6);
      color: white;
      padding: 24px 32px;
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .badge {
      background: rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .snapshot-date {
      font-size: 12px;
      opacity: 0.8;
    }

    /* ì»¨í…Œì´ë„ˆ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 32px;
    }

    /* ì¹´ë“œ */
    .card {
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 24px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ëª©í‘œ ì¹´ë“œ */
    .objective-card {
      background: linear-gradient(135deg, var(--primary), #8B5CF6);
      color: white;
      padding: 28px;
      border-radius: 16px;
      margin-bottom: 20px;
    }
    .objective-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .objective-period {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    .objective-rate {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 12px;
    }
    .objective-progress {
      height: 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
      overflow: hidden;
    }
    .objective-progress-fill {
      height: 100%;
      background: white;
      border-radius: 6px;
      transition: width 0.5s;
    }

    /* KR ê·¸ë¦¬ë“œ */
    .kr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .kr-card {
      padding: 16px;
      border-radius: 12px;
      background: var(--gray-50);
      cursor: pointer;
      transition: all 0.2s;
    }
    .kr-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .kr-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .kr-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .kr-badge {
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
    }
    .kr-progress {
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      overflow: hidden;
    }
    .kr-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s;
    }

    /* KPI í…Œì´ë¸” */
    .kpi-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .kpi-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--gray-600);
      border-bottom: 2px solid var(--gray-200);
      background: var(--gray-50);
    }
    .kpi-table th:nth-child(3),
    .kpi-table th:nth-child(4),
    .kpi-table th:nth-child(5) {
      text-align: right;
    }
    .kpi-table th:nth-child(6) {
      text-align: center;
    }
    .kpi-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-100);
    }
    .kpi-row {
      cursor: pointer;
      transition: background 0.15s;
    }
    .kpi-row:hover {
      background: var(--gray-50);
    }

    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--gray-500);
      cursor: pointer;
      padding: 4px;
    }
    .modal-close:hover {
      color: var(--gray-900);
    }
    .modal-body {
      padding: 24px;
    }

    /* ìƒì„¸ ì •ë³´ ìŠ¤íƒ€ì¼ */
    .detail-section {
      margin-bottom: 20px;
    }
    .detail-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }
    .detail-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-800);
    }
    .detail-progress-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    .detail-progress-fill {
      height: 100%;
      border-radius: 4px;
    }
    .indicator-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .indicator-item {
      background: var(--gray-50);
      border-radius: 10px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .indicator-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .indicator-value {
      font-size: 13px;
      font-weight: 600;
    }

    /* í™œë™ vs ì„±ê³¼ */
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .summary-box {
      border-radius: 12px;
      padding: 16px;
    }
    .summary-box.activity {
      background: var(--gray-50);
      border-left: 4px solid var(--gray-400);
    }
    .summary-box.result {
      background: var(--success-light);
      border-left: 4px solid var(--success);
    }
    .summary-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .summary-row:last-child {
      margin-bottom: 0;
    }

    /* í‘¸í„° */
    .footer {
      text-align: center;
      padding: 24px;
      color: var(--gray-500);
      font-size: 12px;
    }

    /* ë°˜ì‘í˜• - íƒœë¸”ë¦¿ (769px ~ 1024px) */
    @media (max-width: 1024px) and (min-width: 769px) {
      .container {
        padding: 24px;
      }

      .card {
        padding: 20px;
      }

      .kpi-table {
        font-size: 13px;
      }

      .kr-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ë°˜ì‘í˜• - ëª¨ë°”ì¼ (~ 768px) */
    @media (max-width: 768px) {
      .header {
        padding: 20px;
      }

      .header-inner {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }

      .header h1 {
        font-size: 18px;
      }

      .badge {
        font-size: 11px;
        padding: 4px 10px;
      }

      .snapshot-date {
        font-size: 11px;
      }

      .container {
        padding: 16px;
      }

      .card {
        padding: 16px;
        margin-bottom: 16px;
      }

      .card-title {
        font-size: 15px;
      }

      .objective-card {
        padding: 20px;
      }

      .objective-name {
        font-size: 16px;
      }

      .objective-period {
        font-size: 12px;
      }

      .objective-rate {
        font-size: 36px;
      }

      .kr-grid {
        grid-template-columns: 1fr;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
      div[style*="overflow-x: auto"] {
        position: relative;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
      }

      /* ìŠ¤í¬ë¡¤ íŒíŠ¸ */
      div[style*="overflow-x: auto"]::after {
        content: 'ğŸ‘‰ ì¢Œìš° ìŠ¤í¬ë¡¤';
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        background: rgba(49, 130, 246, 0.9);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        pointer-events: none;
        animation: fadeOut 3s forwards;
      }

      @keyframes fadeOut {
        0%, 70% { opacity: 1; }
        100% { opacity: 0; }
      }

      .kpi-table {
        min-width: 700px;
        font-size: 12px;
        table-layout: auto !important;
      }

      .kpi-table th,
      .kpi-table td {
        padding: 10px 8px;
        font-size: 11px;
        white-space: nowrap;
      }

      /* KR ì¹¼ëŸ¼ */
      .kpi-table th:nth-child(1),
      .kpi-table td:nth-child(1) {
        min-width: 90px;
        max-width: 120px;
      }

      /* KPI ì¹¼ëŸ¼ */
      .kpi-table th:nth-child(2),
      .kpi-table td:nth-child(2) {
        min-width: 100px;
        max-width: 150px;
      }

      /* ìˆ«ì ì¹¼ëŸ¼ë“¤ */
      .kpi-table th:nth-child(3),
      .kpi-table th:nth-child(4),
      .kpi-table td:nth-child(3),
      .kpi-table td:nth-child(4) {
        min-width: 70px;
      }

      .kpi-table th:nth-child(5),
      .kpi-table td:nth-child(5) {
        min-width: 50px;
      }

      .kpi-table th:nth-child(6),
      .kpi-table td:nth-child(6) {
        min-width: 80px;
      }

      /* ëª¨ë‹¬ */
      .modal-content {
        max-width: 95vw;
        max-height: 90vh;
        margin: 10px;
      }

      .detail-modal-header h3 {
        font-size: 16px;
      }

      .footer {
        padding: 20px 16px;
        font-size: 11px;
      }
    }

    /* ì•„ì£¼ ì‘ì€ í™”ë©´ (~ 375px) */
    @media (max-width: 375px) {
      .container {
        padding: 12px;
      }

      .card {
        padding: 12px;
      }

      .header h1 {
        font-size: 16px;
      }

      .objective-rate {
        font-size: 32px;
      }

      .kpi-table {
        min-width: 600px;
        font-size: 11px;
      }

      .kpi-table th,
      .kpi-table td {
        padding: 8px 6px;
        font-size: 10px;
      }

      .kr-card {
        padding: 12px;
      }

      .kr-name {
        font-size: 12px;
      }

      .kr-badge {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- ë¡œë”© í™”ë©´ -->
  <div id="loading" class="loading-screen">
    <div class="loading-spinner"></div>
    <div style="margin-top: 20px; color: var(--gray-500);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>

  <!-- ì—ëŸ¬ í™”ë©´ -->
  <div id="error" class="error-screen" style="display: none;">
    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ”’</div>
    <div style="font-size: 20px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</div>
    <div style="color: var(--gray-500);" id="errorMessage">ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë¹„í™œì„±í™”ëœ ë§í¬ì…ë‹ˆë‹¤</div>
  </div>

  <!-- ë©”ì¸ ì•± -->
  <div id="app" style="display: none;">
    <div class="header">
      <div class="header-inner">
        <div style="display: flex; align-items: center; gap: 12px;">
          <h1>ğŸ“Š ê·¸ë¡œìŠ¤ë³´ë“œ</h1>
          <button onclick="openStrategyCycleModal()" style="padding: 6px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
            â“ ì „ëµ ì‚¬ì´í´ì´ë€?
          </button>
        </div>
        <div class="header-meta">
          <div class="badge" id="modeBadge">ğŸ”’ ì½ê¸° ì „ìš©</div>
          <div class="snapshot-date" id="snapshotDate"></div>
        </div>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div style="background: white; border-bottom: 2px solid var(--gray-200); box-shadow: 0 2px 4px rgba(0,0,0,0.04);">
      <div style="max-width: 1200px; margin: 0 auto; padding: 0 32px; display: flex; gap: 8px;">
        <button id="tabTeam" onclick="switchTab('team')" style="padding: 16px 24px; border: none; background: none; font-size: 15px; font-weight: 600; color: var(--primary); cursor: pointer; position: relative; border-bottom: 3px solid var(--primary);">
          ğŸ“ˆ íŒ€ ê·¸ë¡œìŠ¤ë³´ë“œ
        </button>
        <button id="tabPersonal" onclick="switchTab('personal')" style="padding: 16px 24px; border: none; background: none; font-size: 15px; font-weight: 600; color: var(--gray-500); cursor: pointer; position: relative; border-bottom: 3px solid transparent;">
          ğŸ‘¤ ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ
        </button>
      </div>
    </div>

    <div class="container" id="content"></div>
    <div class="footer">
      <div>ì´ í˜ì´ì§€ëŠ” ì½ê¸° ì „ìš© ê³µìœ  í˜ì´ì§€ì…ë‹ˆë‹¤.</div>
      <div style="margin-top: 4px;">ë°ì´í„°ëŠ” ê³µìœ  ë§í¬ ìƒì„± ì‹œì ì˜ ìŠ¤ëƒ…ìƒ·ì…ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="modal" class="modal" onclick="if(event.target === this) closeModal()"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
      authDomain: "moyeora-deal-manager.firebaseapp.com",
      projectId: "moyeora-deal-manager",
      storageBucket: "moyeora-deal-manager.firebasestorage.app",
      messagingSenderId: "527148187832",
      appId: "1:527148187832:web:dc35b0413a7157db34744d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ìƒ‰ìƒ/ì•„ì´ì½˜ ìƒìˆ˜
    const okrColors = ['#8B5CF6', '#06B6D4', '#10B981', '#F59E0B'];
    const okrIcons = ['ğŸ¯', 'ğŸ“ˆ', 'ğŸ’°', 'ğŸš€'];

    // ìŠ¤ëƒ…ìƒ· ë°ì´í„°
    let snapshotData = null;

    // í˜„ì¬ íƒ­
    let currentTab = 'team'; // 'team' ë˜ëŠ” 'personal'

    // íƒ­ ì „í™˜
    function switchTab(tab) {
      currentTab = tab;

      // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      const teamBtn = document.getElementById('tabTeam');
      const personalBtn = document.getElementById('tabPersonal');

      if (tab === 'team') {
        teamBtn.style.color = 'var(--primary)';
        teamBtn.style.borderBottomColor = 'var(--primary)';
        personalBtn.style.color = 'var(--gray-500)';
        personalBtn.style.borderBottomColor = 'transparent';
      } else {
        teamBtn.style.color = 'var(--gray-500)';
        teamBtn.style.borderBottomColor = 'transparent';
        personalBtn.style.color = 'var(--primary)';
        personalBtn.style.borderBottomColor = 'var(--primary)';
      }

      // ì»¨í…ì¸  ë Œë”ë§
      render();
    }

    // URLì—ì„œ í† í° ì¶”ì¶œ
    function getTokenFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('token');
    }

    // í† í° ê²€ì¦ ë° ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ
    async function validateAndLoadSnapshot(token) {
      if (!token) {
        return { valid: false, error: 'í† í°ì´ ì—†ìŠµë‹ˆë‹¤' };
      }

      try {
        // ê³µìœ  ë§í¬ ì¡°íšŒ
        const snapshot = await db.collection('growthboardShareLinks')
          .where('token', '==', token)
          .get();

        if (snapshot.empty) {
          return { valid: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬ì…ë‹ˆë‹¤' };
        }

        const doc = snapshot.docs[0];
        const linkData = doc.data();

        if (!linkData.isActive) {
          return { valid: false, error: 'ë¹„í™œì„±í™”ëœ ë§í¬ì…ë‹ˆë‹¤' };
        }

        // objectiveIdê°€ ìˆìœ¼ë©´ ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ, ì—†ìœ¼ë©´ ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
        let data;
        if (linkData.objectiveId) {
          // ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ
          const objectiveDoc = await db.collection('okr_objective').doc(linkData.objectiveId).get();
          if (!objectiveDoc.exists) {
            return { valid: false, error: 'ëª©í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
          }

          const objective = { id: objectiveDoc.id, ...objectiveDoc.data() };

          // KR, KPI, ì§€í‘œ, ë¡œê·¸, ê°œì¸ëª©í‘œ ì‹¤ì‹œê°„ ë¡œë“œ
          const [krSnapshot, kpiSnapshot, lagSnapshot, logSnapshot, personalTargetSnapshot] = await Promise.all([
            db.collection('okr_keyResults').where('objectiveId', '==', linkData.objectiveId).get(),
            db.collection('okr_kpis').where('objectiveId', '==', linkData.objectiveId).get(),
            db.collection('okr_laggingIndicators').where('objectiveId', '==', linkData.objectiveId).get(),
            db.collection('okr_dailyLogs').where('objectiveId', '==', linkData.objectiveId).get(),
            db.collection('okr_personalTargets').get()
          ]);

          data = {
            objective,
            keyResults: krSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            kpis: kpiSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            laggingIndicators: lagSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            dailyLogs: logSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            personalTargets: personalTargetSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
            snapshotCreatedAt: new Date().toISOString()  // ì‹¤ì‹œê°„ ë¡œë“œ ì‹œê°
          };

          // ë°ì´í„° ì¤‘ë³µ ì œê±° (í˜¹ì‹œ Firebaseì— ì¤‘ë³µ ë°ì´í„°ê°€ ìˆì„ ê²½ìš° ëŒ€ë¹„)
          const uniqueKRs = new Map();
          data.keyResults.forEach(kr => {
            if (!uniqueKRs.has(kr.id)) {
              uniqueKRs.set(kr.id, kr);
            }
          });
          data.keyResults = Array.from(uniqueKRs.values());

          const uniqueKPIs = new Map();
          data.kpis.forEach(kpi => {
            if (!uniqueKPIs.has(kpi.id)) {
              uniqueKPIs.set(kpi.id, kpi);
            }
          });
          data.kpis = Array.from(uniqueKPIs.values());

          const uniqueLags = new Map();
          data.laggingIndicators.forEach(lag => {
            if (!uniqueLags.has(lag.id)) {
              uniqueLags.set(lag.id, lag);
            }
          });
          data.laggingIndicators = Array.from(uniqueLags.values());

          console.log('ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ:', {
            KRìˆ˜: data.keyResults.length,
            KPIìˆ˜: data.kpis.length,
            ì§€í‘œìˆ˜: data.laggingIndicators.length,
            ë¡œê·¸ìˆ˜: data.dailyLogs.length,
            ê°œì¸ëª©í‘œìˆ˜: data.personalTargets.length
          });
        } else {
          // ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· ë°ì´í„° ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
          data = linkData.snapshotData;
        }

        // ì¡°íšŒìˆ˜ ì¦ê°€
        await db.collection('growthboardShareLinks').doc(doc.id).update({
          viewCount: firebase.firestore.FieldValue.increment(1),
          lastViewedAt: new Date().toISOString()
        });

        return {
          valid: true,
          data: data,
          createdAt: linkData.createdAt,
          linkName: linkData.name,
          isRealtime: !!linkData.objectiveId  // ì‹¤ì‹œê°„ ì—¬ë¶€
        };
      } catch (e) {
        console.error('ê²€ì¦ ì˜¤ë¥˜:', e);
        return { valid: false, error: 'ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' };
      }
    }

    // ê¸ˆì•¡ í¬ë§·íŒ…
    function formatAmountWithSummary(num, unit) {
      if (num === null || num === undefined) return '-';
      const formatted = Number(num).toLocaleString();

      if (unit === 'ì›' && num >= 10000) {
        const korean = formatKoreanAmount(num);
        return `${formatted}(${korean})${unit}`;
      }
      return unit ? `${formatted}${unit}` : formatted;
    }

    function formatKoreanAmount(num) {
      if (num >= 100000000) {
        const eok = Math.floor(num / 100000000);
        const remainder = num % 100000000;
        if (remainder >= 10000000) {
          const cheonman = Math.floor(remainder / 10000000);
          return `${eok}ì–µ${cheonman}ì²œë§Œ`;
        }
        return `${eok}ì–µ`;
      } else if (num >= 10000000) {
        const cheonman = Math.floor(num / 10000000);
        return `${cheonman}ì²œë§Œ`;
      } else if (num >= 1000000) {
        const baekman = Math.floor(num / 1000000);
        return `${baekman}ë°±ë§Œ`;
      } else if (num >= 10000) {
        const man = Math.floor(num / 10000);
        return `${man}ë§Œ`;
      }
      return num.toLocaleString();
    }

    // ë‹¬ì„±ë¥  ê³„ì‚°
    function calcKRRate(krId) {
      if (!snapshotData) return 0;
      const kpisForKR = snapshotData.kpis.filter(k => k.keyResultId === krId);
      if (kpisForKR.length === 0) return 0;

      let totalRate = 0;
      kpisForKR.forEach(kpi => {
        totalRate += calcKPIRate(kpi.id);
      });
      return Math.round(totalRate / kpisForKR.length);
    }

    function calcKPIRate(kpiId) {
      if (!snapshotData) return 0;
      const kpi = snapshotData.kpis.find(k => k.id === kpiId);
      if (!kpi || !kpi.targetValue) return 0;

      const lagsForKPI = snapshotData.laggingIndicators.filter(l => l.kpiId === kpiId);
      let currentValue = 0;

      lagsForKPI.forEach(lag => {
        if (lag.type === 'result') {
          const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
          logs.forEach(log => {
            const value = lag.valuePerUnit > 0 ? (log.resultValue || 0) * lag.valuePerUnit : (log.resultValue || 0);
            currentValue += value;
          });
        }
      });

      return Math.round((currentValue / kpi.targetValue) * 100);
    }

    function calcObjectiveRate() {
      if (!snapshotData || snapshotData.keyResults.length === 0) return 0;
      let total = 0;
      snapshotData.keyResults.forEach(kr => {
        total += calcKRRate(kr.id);
      });
      return Math.round(total / snapshotData.keyResults.length);
    }

    // ì§€í‘œ ì•„ì´ì½˜
    function getLagIcon(name) {
      const lower = (name || '').toLowerCase();
      if (lower.includes('ë§¤ì¶œ') || lower.includes('ìˆ˜ìµ') || lower.includes('ê¸ˆì•¡')) return 'ğŸ’°';
      if (lower.includes('ê´‘ê³ ') || lower.includes('ë§ˆì¼€íŒ…')) return 'ğŸ“¢';
      if (lower.includes('ë¯¸íŒ…') || lower.includes('ìƒë‹´')) return 'ğŸ¤';
      if (lower.includes('ê³„ì•½') || lower.includes('ë”œ')) return 'ğŸ“';
      if (lower.includes('ì˜ì—…') || lower.includes('ì„¸ì¼ì¦ˆ')) return 'ğŸ’¼';
      if (lower.includes('ì½œ') || lower.includes('ì „í™”')) return 'ğŸ“';
      if (lower.includes('ì´ë©”ì¼') || lower.includes('ë©”ì¼')) return 'ğŸ“§';
      if (lower.includes('ë°©ë¬¸')) return 'ğŸš—';
      if (lower.includes('ë¦¬ë“œ') || lower.includes('ë°œêµ´')) return 'ğŸ¯';
      return 'ğŸ“‹';
    }

    // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    // ì „ëµ ì‚¬ì´í´ ì„¤ëª… ëª¨ë‹¬
    function openStrategyCycleModal() {
      showModal(`
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(135deg, var(--purple), #8B5CF6); color: white;">
            <h2 class="modal-title" style="color: white; display: flex; align-items: center; gap: 8px;">
              ğŸ¯ ì „ëµ ì‚¬ì´í´ì´ë€?
            </h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div class="modal-body">
            <!-- ì™œ ê·¸ë¡œìŠ¤ë³´ë“œê°€ í•„ìš”í•œê°€? -->
            <div style="background: linear-gradient(135deg, var(--primary)10, var(--success)10); padding: 20px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid var(--primary);">
              <div style="font-size: 16px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                ğŸ’¡ ì™œ ê·¸ë¡œìŠ¤ë³´ë“œê°€ í•„ìš”í•œê°€?
              </div>
              <div style="font-size: 14px; color: var(--gray-700); line-height: 1.7;">
                <strong>ëª©í‘œëŠ” ìˆì§€ë§Œ ì–´ë–»ê²Œ ë‹¬ì„±í• ì§€ ë§‰ë§‰í•œ ê²½í—˜</strong>, ëˆ„êµ¬ë‚˜ ìˆì£ ?<br>
                ê·¸ë¡œìŠ¤ë³´ë“œëŠ” <strong>í° ëª©í‘œë¥¼ ì‘ì€ í–‰ë™ìœ¼ë¡œ ì—°ê²°</strong>í•˜ëŠ” í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.<br>
                ë§¤ì¼ì˜ ì—…ë¬´ê°€ íŒ€ ëª©í‘œ ë‹¬ì„±ì— ì–´ë–»ê²Œ ê¸°ì—¬í•˜ëŠ”ì§€ í•œëˆˆì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>

            <!-- ì „ëµ ì‚¬ì´í´ 4ë‹¨ê³„ -->
            <div style="font-size: 15px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">
              ğŸ“Š ì „ëµ ì‚¬ì´í´ 4ë‹¨ê³„
            </div>

            <!-- 1. Objective -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 2px solid var(--gray-200);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8B5CF6, #6366F1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px;">1</div>
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: var(--gray-900);">ğŸ¯ O (Objective) - ëª©í‘œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ìš°ë¦¬ê°€ ì´ë£¨ê³  ì‹¶ì€ í° ê·¸ë¦¼</div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--gray-700); padding-left: 52px; line-height: 1.6;">
                <strong>ì˜ˆì‹œ:</strong> "26ë…„ë„ PMFë¥¼ ì°¾ëŠ” ë‹¨ê³„, ì—° 10ì–µ ë§¤ì¶œ ë‹¬ì„±"<br>
                â†’ íŒ€ ì „ì²´ê°€ í–¥í•˜ëŠ” <strong>ìµœì¢… ëª©ì ì§€</strong>
              </div>
            </div>

            <!-- 2. Key Results -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 2px solid var(--gray-200);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #06B6D4, #0891B2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px;">2</div>
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: var(--gray-900);">ğŸ“ˆ KR (Key Results) - í•µì‹¬ ê²°ê³¼</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œë¥¼ ë‹¬ì„±í–ˆëŠ”ì§€ ì¸¡ì •í•˜ëŠ” ì§€í‘œ</div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--gray-700); padding-left: 52px; line-height: 1.6;">
                <strong>ì˜ˆì‹œ:</strong> "ì—°ë§¤ì¶œ 10ì–µ ë‹¬ì„±", "íŒŒíŠ¸ë„ˆ 500ëª… í™•ë³´"<br>
                â†’ Objectiveë¥¼ <strong>ì¸¡ì • ê°€ëŠ¥í•œ ê²°ê³¼</strong>ë¡œ ìª¼ê°¬ (3~5ê°œ)
              </div>
            </div>

            <!-- 3. KPI -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 2px solid var(--gray-200);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10B981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px;">3</div>
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: var(--gray-900);">ğŸ’° KPI - í•µì‹¬ ì„±ê³¼ ì§€í‘œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">KRì„ ë‹¬ì„±í•˜ê¸° ìœ„í•œ êµ¬ì²´ì  ì§€í‘œ</div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--gray-700); padding-left: 52px; line-height: 1.6;">
                <strong>ì˜ˆì‹œ:</strong> "êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ 8ì–µ", "ê³µê¸‰ì‚¬ 200ê³³ í™•ë³´"<br>
                â†’ KRì„ <strong>ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ìœ„</strong>ë¡œ ì„¸ë¶„í™”
              </div>
            </div>

            <!-- 4. ì§€í‘œ (í™œë™/ì„±ê³¼) -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px; border: 2px solid var(--gray-200);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #F59E0B, #D97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 18px;">4</div>
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: var(--gray-900);">ğŸ“‹ ì§€í‘œ - ì¼ì¼ ì—…ë¬´ ê¸°ë¡</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ë§¤ì¼ í•˜ëŠ” ì‹¤ì œ í–‰ë™</div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--gray-700); padding-left: 52px; line-height: 1.6;">
                <strong>í™œë™í˜•:</strong> "ì „í™” ìƒë‹´ 3ê±´", "ë¯¸íŒ… 2íšŒ" (ê³¼ì • ì¶”ì )<br>
                <strong>ì„±ê³¼í˜•:</strong> "ê³„ì•½ ì„±ì‚¬ 5ê±´", "ë§¤ì¶œ 200ë§Œì›" (ê²°ê³¼ ì¸¡ì •)<br>
                â†’ íŒ€ì›ë“¤ì´ <strong>ë§¤ì¼ ê¸°ë¡í•˜ëŠ” ì‹¤ì œ ì—…ë¬´</strong>
              </div>
            </div>

            <!-- ìˆœí™˜ êµ¬ì¡° -->
            <div style="background: var(--gray-50); padding: 20px; border-radius: 12px; margin-top: 24px;">
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                ğŸ”„ ì´ë ‡ê²Œ ì—°ê²°ë©ë‹ˆë‹¤
              </div>
              <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8;">
                <strong>ğŸ¯ O</strong> (í° ëª©í‘œ) <br>
                â†’ <strong>ğŸ“ˆ KR</strong> (ì¸¡ì • ê°€ëŠ¥í•œ ê²°ê³¼) <br>
                â†’ <strong>ğŸ’° KPI</strong> (êµ¬ì²´ì  ì§€í‘œ) <br>
                â†’ <strong>ğŸ“‹ ì¼ì¼ ì—…ë¬´</strong> (ë§¤ì¼ì˜ í–‰ë™)<br>
                <br>
                <span style="color: var(--primary); font-weight: 600;">
                  â†’ ë§¤ì¼ì˜ ì‘ì€ í–‰ë™ì´ ëª¨ì—¬ ëª©í‘œë¥¼ ë‹¬ì„±í•©ë‹ˆë‹¤! ğŸš€
                </span>
              </div>
            </div>

            <!-- ê°œì¸ ëª©í‘œ ì„¤ëª… -->
            <div style="background: linear-gradient(135deg, var(--success)10, var(--primary)10); padding: 20px; border-radius: 12px; margin-top: 24px; border-left: 4px solid var(--success);">
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                ğŸ¯ ê°œì¸ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”?
              </div>
              <div style="font-size: 13px; color: var(--gray-700); line-height: 1.7;">
                íŒ€ KPIì™€ ë³„ê°œë¡œ <strong>ë‚˜ë§Œì˜ ë‹¤ì§</strong>ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                "ì´ë²ˆ ë‹¬ ë‚´ê°€ 3ì–µ ê¸°ì—¬í•˜ê² ë‹¤!" ê°™ì€ ê°œì¸ ëª©í‘œë¥¼ ì„¸ìš°ê³ ,<br>
                ë‹¬ì„±ë¥ ì„ ì¶”ì í•˜ë©° <strong>ì„±ì·¨ê°</strong>ì„ ëŠë‚„ ìˆ˜ ìˆì–´ìš”!<br>
                <span style="color: var(--gray-500); font-size: 12px;">(íŒ€ KPI ê³„ì‚°ì—ëŠ” ì˜í–¥ ì—†ìŒ)</span>
              </div>
            </div>
          </div>
        </div>
      `);
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) modal.className = 'modal';
    }

    function showModal(content) {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.innerHTML = content;
        modal.className = 'modal show';
      }
    }

    // KR ìƒì„¸ ëª¨ë‹¬
    function showKRDetail(krId) {
      const kr = snapshotData.keyResults.find(k => k.id === krId);
      const krIdx = snapshotData.keyResults.findIndex(k => k.id === krId);
      const kpisForKR = snapshotData.kpis.filter(k => k.keyResultId === krId);
      const krRate = calcKRRate(krId);

      showModal(`
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(135deg, ${okrColors[krIdx]}, ${okrColors[krIdx]}CC); color: white;">
            <h2 class="modal-title" style="color: white; display: flex; align-items: center; gap: 8px;">
              ${okrIcons[krIdx]} ${kr.name}
            </h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="detail-section">
              <div class="detail-label">ë‹¬ì„±ë¥ </div>
              <div class="detail-value" style="font-size: 32px; color: ${okrColors[krIdx]};">${krRate}%</div>
              <div class="detail-progress-bar">
                <div class="detail-progress-fill" style="width: ${Math.min(krRate, 100)}%; background: ${okrColors[krIdx]};"></div>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">ì—°ê²°ëœ KPI (${kpisForKR.length}ê°œ)</div>
              <div class="indicator-list" style="margin-top: 8px;">
                ${kpisForKR.map(kpi => {
                  const kpiRate = calcKPIRate(kpi.id);
                  const statusColor = kpiRate >= 80 ? 'var(--success)' : kpiRate >= 50 ? 'var(--warning)' : 'var(--danger)';
                  return `
                    <div class="indicator-item" style="cursor: pointer;" onclick="showKPIDetail('${kpi.id}')">
                      <div class="indicator-name">
                        <span style="color: ${statusColor}; font-size: 10px;">â—</span>
                        ${kpi.name}
                      </div>
                      <div class="indicator-value" style="color: ${statusColor};">${kpiRate}%</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `);
    }

    // KPI ìƒì„¸ ëª¨ë‹¬
    function showKPIDetail(kpiId) {
      const kpi = snapshotData.kpis.find(k => k.id === kpiId);
      const kr = snapshotData.keyResults.find(k => k.id === kpi.keyResultId);
      const krIdx = snapshotData.keyResults.findIndex(k => k.id === kpi.keyResultId);
      const lagsForKPI = snapshotData.laggingIndicators.filter(l => l.kpiId === kpiId);
      const kpiRate = calcKPIRate(kpiId);
      const statusColor = kpiRate >= 80 ? 'var(--success)' : kpiRate >= 50 ? 'var(--warning)' : 'var(--danger)';

      // í˜„ì¬ê°’ ê³„ì‚°
      let currentValue = 0;
      lagsForKPI.forEach(lag => {
        if (lag.type === 'result') {
          const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
          logs.forEach(log => {
            const value = lag.valuePerUnit > 0 ? (log.resultValue || 0) * lag.valuePerUnit : (log.resultValue || 0);
            currentValue += value;
          });
        }
      });

      showModal(`
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">ğŸ“Š ${kpi.name}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="detail-section" style="display: flex; gap: 16px; margin-bottom: 20px;">
              <div style="flex: 1; background: var(--gray-50); border-radius: 12px; padding: 16px; text-align: center;">
                <div class="detail-label">ëª©í‘œ</div>
                <div class="detail-value">${formatAmountWithSummary(kpi.targetValue, kpi.unit)}</div>
              </div>
              <div style="flex: 1; background: ${statusColor}15; border-radius: 12px; padding: 16px; text-align: center;">
                <div class="detail-label">í˜„ì¬</div>
                <div class="detail-value" style="color: ${statusColor};">${formatAmountWithSummary(currentValue, kpi.unit)}</div>
              </div>
              <div style="flex: 1; background: var(--gray-50); border-radius: 12px; padding: 16px; text-align: center;">
                <div class="detail-label">ë‹¬ì„±ë¥ </div>
                <div class="detail-value" style="color: ${statusColor};">${kpiRate}%</div>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">ì†Œì† KR</div>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                <span style="font-size: 16px;">${okrIcons[krIdx]}</span>
                <span style="font-size: 14px; font-weight: 600; color: ${okrColors[krIdx]};">${kr?.name || '-'}</span>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-label">ì—°ê²°ëœ ì§€í‘œ (${lagsForKPI.length}ê°œ)</div>
              <div class="indicator-list" style="margin-top: 8px;">
                ${lagsForKPI.length > 0 ? lagsForKPI.map(lag => {
                  const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
                  const totalValue = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                  return `
                    <div class="indicator-item">
                      <div class="indicator-name">
                        <span>${getLagIcon(lag.name)}</span>
                        ${lag.name}
                        <span style="font-size: 11px; padding: 2px 6px; border-radius: 10px; background: ${lag.type === 'result' ? 'var(--success-light)' : 'var(--gray-100)'}; color: ${lag.type === 'result' ? 'var(--success)' : 'var(--gray-500)'};">
                          ${lag.type === 'result' ? 'ì„±ê³¼í˜•' : 'í™œë™í˜•'}
                        </span>
                      </div>
                      <div class="indicator-value">${totalValue.toLocaleString()}${lag.type === 'result' && lag.valuePerUnit ? ` Ã— ${lag.valuePerUnit.toLocaleString()}` : ''}</div>
                    </div>
                  `;
                }).join('') : '<div style="text-align: center; color: var(--gray-400); padding: 20px;">ì—°ê²°ëœ ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤</div>'}
              </div>
            </div>

            <div class="detail-progress-bar" style="margin-top: 16px;">
              <div class="detail-progress-fill" style="width: ${Math.min(kpiRate, 100)}%; background: ${statusColor};"></div>
            </div>
          </div>
        </div>
      `);
    }

    // ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ ë Œë”ë§
    function renderPersonalGrowthboard() {
      if (!snapshotData || !snapshotData.dailyLogs) return '';

      // íŒ€ì›ë³„ í†µê³„ ì§‘ê³„
      const memberStats = {};

      snapshotData.dailyLogs.forEach(log => {
        const memberId = log.memberId || 'unknown';
        const memberName = log.memberName || 'ì•Œ ìˆ˜ ì—†ìŒ';

        if (!memberStats[memberId]) {
          memberStats[memberId] = {
            id: memberId,
            name: memberName,
            totalCount: 0,
            activityCount: 0,
            resultValue: 0,
            krContributions: {}
          };
        }

        const lag = snapshotData.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        const isActivity = lag && lag.type !== 'result';
        const value = log.resultValue || 0;

        memberStats[memberId].totalCount += value;

        if (isActivity) {
          memberStats[memberId].activityCount += value;
        } else if (lag && lag.type === 'result') {
          const resultVal = lag.valuePerUnit > 0 ? value * lag.valuePerUnit : value;
          memberStats[memberId].resultValue += resultVal;
        }

        // KRë³„ ê¸°ì—¬ë„
        const krId = log.krId;
        if (krId) {
          if (!memberStats[memberId].krContributions[krId]) {
            memberStats[memberId].krContributions[krId] = 0;
          }
          memberStats[memberId].krContributions[krId] += value;
        }
      });

      // ë°°ì—´ë¡œ ë³€í™˜ ë° ì •ë ¬
      const memberArray = Object.values(memberStats).sort((a, b) => b.totalCount - a.totalCount);

      if (memberArray.length === 0) {
        return '';
      }

      return `
        <!-- ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ -->
        <div class="card">
          <div class="card-title">ğŸ‘¤ ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ</div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">íŒ€ì›ë³„ í™œë™ í˜„í™© Â· KR ê¸°ì—¬ë„</p>
          <div style="overflow-x: auto;">
            <table class="kpi-table">
              <thead>
                <tr>
                  <th style="text-align: left; min-width: 100px;">íŒ€ì›</th>
                  <th style="text-align: center;">ì´ í™œë™</th>
                  <th style="text-align: center;">í–‰ë™ì§€í‘œ</th>
                  <th style="text-align: right;">ì„±ê³¼ì§€í‘œ</th>
                  ${snapshotData.keyResults.map((kr, idx) => `
                    <th style="text-align: center; color: ${okrColors[idx]}; min-width: 80px;">
                      ${kr.name}
                    </th>
                  `).join('')}
                </tr>
              </thead>
              <tbody>
                ${memberArray.map(member => `
                  <tr>
                    <td style="font-weight: 600; color: var(--gray-800);">${member.name}</td>
                    <td style="text-align: center; font-weight: 700; color: var(--primary);">${member.totalCount}ê±´</td>
                    <td style="text-align: center; color: var(--gray-700);">${member.activityCount}ê±´</td>
                    <td style="text-align: right; font-weight: 600; color: var(--success);">${formatAmountWithSummary(member.resultValue, 'ì›')}</td>
                    ${snapshotData.keyResults.map((kr, idx) => {
                      const krCount = member.krContributions[kr.id] || 0;
                      return `
                        <td style="text-align: center;">
                          ${krCount > 0 ? `
                            <span style="display: inline-block; padding: 4px 10px; background: ${okrColors[idx]}15; color: ${okrColors[idx]}; border-radius: 12px; font-size: 12px; font-weight: 600;">
                              ${krCount}ê±´
                            </span>
                          ` : '<span style="color: var(--gray-300);">-</span>'}
                        </td>
                      `;
                    }).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ íƒ­ ë Œë”ë§ (ë…ë¦½ íƒ­)
    function renderPersonalGrowthboardTab() {
      const container = document.getElementById('content');
      if (!container || !snapshotData) return;

      // íŒ€ì›ë³„ í†µê³„ ì§‘ê³„
      const memberStats = {};

      snapshotData.dailyLogs.forEach(log => {
        const memberId = log.memberId || 'unknown';
        const memberName = log.memberName || 'ì•Œ ìˆ˜ ì—†ìŒ';

        if (!memberStats[memberId]) {
          memberStats[memberId] = {
            id: memberId,
            name: memberName,
            totalCount: 0,
            activityCount: 0,
            resultValue: 0,
            krContributions: {},
            kpiValues: {}  // KPIë³„ ì‹¤ì œ ê°’
          };
        }

        const lag = snapshotData.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        const isActivity = lag && lag.type !== 'result';
        const value = log.resultValue || 0;

        memberStats[memberId].totalCount += value;

        if (isActivity) {
          memberStats[memberId].activityCount += value;
        } else if (lag && lag.type === 'result') {
          const resultVal = lag.valuePerUnit > 0 ? value * lag.valuePerUnit : value;
          memberStats[memberId].resultValue += resultVal;

          // KPIë³„ ì‹¤ì œ ê°’ ê³„ì‚°
          const kpi = snapshotData.kpis.find(k => k.id === lag.kpiId);
          if (kpi) {
            if (!memberStats[memberId].kpiValues[kpi.id]) {
              memberStats[memberId].kpiValues[kpi.id] = 0;
            }
            memberStats[memberId].kpiValues[kpi.id] += resultVal;
          }
        }

        // KRë³„ ê¸°ì—¬ë„
        const krId = log.krId;
        if (krId) {
          if (!memberStats[memberId].krContributions[krId]) {
            memberStats[memberId].krContributions[krId] = 0;
          }
          memberStats[memberId].krContributions[krId] += value;
        }
      });

      // ê°œì¸ ëª©í‘œê°€ ì„¤ì •ëœ íŒ€ì›ë“¤
      const personalTargets = snapshotData.personalTargets || [];

      // ê°œì¸ ëª©í‘œë¥¼ ì„¤ì •í•œ íŒ€ì›ì´ memberStatsì— ì—†ìœ¼ë©´ ì¶”ê°€
      personalTargets.forEach(pt => {
        if (!memberStats[pt.memberId]) {
          memberStats[pt.memberId] = {
            id: pt.memberId,
            name: pt.memberName || 'ì•Œ ìˆ˜ ì—†ìŒ',
            totalCount: 0,
            activityCount: 0,
            resultValue: 0,
            krContributions: {},
            kpiValues: {}
          };
        }
      });

      // ë°°ì—´ë¡œ ë³€í™˜ ë° ì •ë ¬
      const memberArray = Object.values(memberStats).sort((a, b) => b.totalCount - a.totalCount);

      container.innerHTML = `
        <!-- íŒ€ì›ë³„ í™œë™ í˜„í™© -->
        <div class="card">
          <div class="card-title">ğŸ‘¤ íŒ€ì›ë³„ í™œë™ í˜„í™©</div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">íŒ€ì›ë³„ í™œë™ í˜„í™© ë° KR ê¸°ì—¬ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
          ${memberArray.length > 0 ? `
          <div style="overflow-x: auto;">
            <table class="kpi-table">
              <thead>
                <tr>
                  <th style="text-align: left; min-width: 100px;">íŒ€ì›</th>
                  <th style="text-align: center;">ì´ í™œë™</th>
                  <th style="text-align: center;">í–‰ë™ì§€í‘œ</th>
                  <th style="text-align: right;">ì„±ê³¼ì§€í‘œ</th>
                  ${snapshotData.keyResults.map((kr, idx) => `
                    <th style="text-align: center; color: ${okrColors[idx]}; min-width: 80px;">
                      ${kr.name}
                    </th>
                  `).join('')}
                </tr>
              </thead>
              <tbody>
                ${memberArray.map(member => `
                  <tr>
                    <td style="font-weight: 600; color: var(--gray-800);">${member.name}</td>
                    <td style="text-align: center; font-weight: 700; color: var(--primary);">${member.totalCount}ê±´</td>
                    <td style="text-align: center; color: var(--gray-700);">${member.activityCount}ê±´</td>
                    <td style="text-align: right; font-weight: 600; color: var(--success);">${formatAmountWithSummary(member.resultValue, 'ì›')}</td>
                    ${snapshotData.keyResults.map((kr, idx) => {
                      const krCount = member.krContributions[kr.id] || 0;
                      return `
                        <td style="text-align: center;">
                          ${krCount > 0 ? `
                            <span style="display: inline-block; padding: 4px 10px; background: ${okrColors[idx]}15; color: ${okrColors[idx]}; border-radius: 12px; font-size: 12px; font-weight: 600;">
                              ${krCount}ê±´
                            </span>
                          ` : '<span style="color: var(--gray-300);">-</span>'}
                        </td>
                      `;
                    }).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          ` : `
          <div style="text-align: center; padding: 60px 20px; color: var(--gray-400);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¥</div>
            <div style="font-size: 15px; font-weight: 500;">íŒ€ì› í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 13px; margin-top: 8px;">ì—…ë¬´ ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
          `}
        </div>

        <!-- ì¼ì¼ ëª©í‘œ í˜„í™© -->
        <div class="card">
          <div class="card-title">ğŸ“‹ ì¼ì¼ ëª©í‘œ í˜„í™©</div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">ê° ì§€í‘œë³„ ì¼ì¼ ëª©í‘œ ì„¤ì • ë° ë‹¬ì„± í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>

          ${(() => {
            // ëª¨ë“  ì§€í‘œ ëª©ë¡
            const allLags = snapshotData.laggingIndicators || [];
            if (allLags.length === 0) {
              return `
                <div style="text-align: center; padding: 60px 20px; color: var(--gray-400);">
                  <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div>
                  <div style="font-size: 15px; font-weight: 500;">ë“±ë¡ëœ ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
              `;
            }

            // KPIë³„ë¡œ ê·¸ë£¹í™”
            const kpiGroups = {};
            allLags.forEach(lag => {
              if (!kpiGroups[lag.kpiId]) {
                const kpi = snapshotData.kpis.find(k => k.id === lag.kpiId);
                const kr = snapshotData.keyResults.find(k => k.id === kpi?.keyResultId);
                const krIdx = snapshotData.keyResults.findIndex(k => k.id === kpi?.keyResultId);
                kpiGroups[lag.kpiId] = {
                  kpi,
                  kr,
                  krIdx,
                  lags: []
                };
              }
              kpiGroups[lag.kpiId].lags.push(lag);
            });

            return Object.values(kpiGroups).map(group => {
              if (!group.kpi) return '';

              return `
                <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-50); border-radius: 12px; border-left: 4px solid ${okrColors[group.krIdx] || 'var(--gray-400)'};">
                  <div style="font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">
                    ${group.kpi.name}
                  </div>
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 12px;">
                    ${group.kr ? `${okrIcons[group.krIdx]} ${group.kr.name}` : ''}
                  </div>

                  <div style="display: grid; gap: 8px;">
                    ${group.lags.map(lag => {
                      const hasTarget = lag.target && lag.target > 0;
                      const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
                      const totalCount = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                      const achievementRate = hasTarget ? Math.min(Math.round((totalCount / lag.target) * 100), 100) : 0;
                      const statusColor = achievementRate >= 100 ? 'var(--success)' : achievementRate >= 70 ? 'var(--primary)' : achievementRate >= 40 ? 'var(--warning)' : 'var(--gray-400)';

                      return `
                        <div style="background: white; border-radius: 8px; padding: 12px; border: 1px solid ${hasTarget ? statusColor + '40' : 'var(--gray-200)'};">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1;">
                              <div style="font-size: 12px; font-weight: 600; color: var(--gray-700);">
                                ${getLagIcon(lag.name)} ${lag.name}
                              </div>
                              <div style="font-size: 10px; color: var(--gray-500); margin-top: 2px;">
                                ${lag.type === 'result' ? 'ğŸ’° ì„±ê³¼í˜•' : 'ğŸ“‹ í™œë™í˜•'}
                                ${lag.version ? ` Â· ${lag.version}ë²„ì „` : ''}
                              </div>
                            </div>
                            ${hasTarget ? `
                              <div style="padding: 4px 10px; background: ${statusColor}; color: white; border-radius: 8px; font-size: 11px; font-weight: 700;">
                                ${achievementRate}%
                              </div>
                            ` : `
                              <div style="padding: 4px 10px; background: var(--gray-200); color: var(--gray-600); border-radius: 8px; font-size: 10px; font-weight: 600;">
                                ë¯¸ì„¤ì •
                              </div>
                            `}
                          </div>

                          ${hasTarget ? `
                            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--gray-600); margin-bottom: 6px;">
                              <span>ëª©í‘œ: <strong style="color: var(--gray-800);">${lag.target}ê±´</strong></span>
                              <span>í˜„ì¬: <strong style="color: ${statusColor};">${totalCount}ê±´</strong></span>
                            </div>
                            <div style="height: 4px; background: var(--gray-200); border-radius: 2px; overflow: hidden;">
                              <div style="height: 100%; width: ${achievementRate}%; background: ${statusColor}; border-radius: 2px; transition: width 0.5s;"></div>
                            </div>
                          ` : `
                            <div style="font-size: 11px; color: var(--gray-500);">
                              í˜„ì¬ ê¸°ë¡: ${totalCount}ê±´
                            </div>
                          `}
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('');
          })()}
        </div>

        <!-- ê°œì¸ ëª©í‘œ ì„¤ì • ë° ì§„ì²™ë„ -->
        <div class="card">
          <div class="card-title">ğŸ¯ ê°œì¸ ëª©í‘œ ì„¤ì • ë° ì§„ì²™ë„</div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">íŒ€ì›ë³„ ê°œì¸ ëª©í‘œ ë‹¬ì„± í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>

          ${memberArray.length > 0 ? memberArray.map(member => {
            // ì´ íŒ€ì›ì˜ ê°œì¸ ëª©í‘œë“¤
            const memberTargets = personalTargets.filter(pt => pt.memberId === member.id);

            // ì´ íŒ€ì›ì´ ê´€ë ¨ëœ KPIë“¤ (ì£¼ ë‹´ë‹¹ì, ë¶€ ë‹´ë‹¹ì, ë˜ëŠ” ê°œì¸ ëª©í‘œë¥¼ ì„¤ì •í•œ KPI)
            const relatedKPIs = snapshotData.kpis.filter(kpi =>
              kpi.mainAssignee === member.id ||
              (kpi.subAssignees && kpi.subAssignees.includes(member.id)) ||
              memberTargets.some(pt => pt.kpiId === kpi.id)
            );

            if (relatedKPIs.length === 0 && memberTargets.length === 0) return '';

            return `
              <div style="margin-bottom: 24px; padding: 20px; background: var(--gray-50); border-radius: 12px; border-left: 4px solid var(--primary);">
                <div style="font-size: 15px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                  ğŸ‘¤ ${member.name}
                </div>

                <div style="display: grid; gap: 12px;">
                  ${relatedKPIs.map(kpi => {
                    const kr = snapshotData.keyResults.find(k => k.id === kpi.keyResultId);
                    const krIdx = snapshotData.keyResults.findIndex(k => k.id === kpi.keyResultId);
                    const personalTarget = memberTargets.find(pt => pt.kpiId === kpi.id);
                    const actualValue = member.kpiValues[kpi.id] || 0;

                    if (!personalTarget) {
                      // ëª©í‘œ ë¯¸ì„¤ì •
                      return `
                        <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid var(--gray-200);">
                          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                              <div style="font-size: 13px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">
                                ${kpi.name}
                              </div>
                              <div style="font-size: 11px; color: var(--gray-500);">
                                ${kr ? `${okrIcons[krIdx]} ${kr.name}` : ''}
                              </div>
                            </div>
                            <div style="padding: 4px 12px; background: var(--gray-200); color: var(--gray-600); border-radius: 12px; font-size: 11px; font-weight: 600;">
                              ë¯¸ì„¤ì •
                            </div>
                          </div>
                          <div style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">
                            í˜„ì¬: ${formatAmountWithSummary(actualValue, kpi.unit || '')}
                          </div>
                        </div>
                      `;
                    } else {
                      // ëª©í‘œ ì„¤ì •ë¨
                      const targetValue = personalTarget.targetValue || 0;
                      const achievementRate = targetValue > 0 ? Math.min(Math.round((actualValue / targetValue) * 100), 100) : 0;
                      const remaining = Math.max(targetValue - actualValue, 0);
                      const statusColor = achievementRate >= 100 ? 'var(--success)' : achievementRate >= 70 ? 'var(--primary)' : achievementRate >= 40 ? 'var(--warning)' : 'var(--danger)';

                      return `
                        <div style="background: white; border-radius: 10px; padding: 16px; border: 1px solid ${statusColor};">
                          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                              <div style="font-size: 13px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">
                                ${kpi.name}
                              </div>
                              <div style="font-size: 11px; color: var(--gray-500);">
                                ${kr ? `${okrIcons[krIdx]} ${kr.name}` : ''}
                              </div>
                            </div>
                            <div style="padding: 4px 12px; background: ${statusColor}; color: white; border-radius: 12px; font-size: 12px; font-weight: 700;">
                              ${achievementRate}%
                            </div>
                          </div>

                          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                            <div style="text-align: center; padding: 8px; background: var(--gray-50); border-radius: 8px;">
                              <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">ëª©í‘œ</div>
                              <div style="font-size: 12px; font-weight: 600; color: var(--gray-700);">${formatAmountWithSummary(targetValue, kpi.unit || '')}</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: ${statusColor}15; border-radius: 8px;">
                              <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">í˜„ì¬</div>
                              <div style="font-size: 12px; font-weight: 600; color: ${statusColor};">${formatAmountWithSummary(actualValue, kpi.unit || '')}</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: var(--gray-50); border-radius: 8px;">
                              <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">ë‚¨ì€ ëª©í‘œ</div>
                              <div style="font-size: 12px; font-weight: 600; color: var(--gray-600);">${formatAmountWithSummary(remaining, kpi.unit || '')}</div>
                            </div>
                          </div>

                          <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${achievementRate}%; background: ${statusColor}; border-radius: 4px; transition: width 0.5s;"></div>
                          </div>
                        </div>
                      `;
                    }
                  }).join('')}
                </div>
              </div>
            `;
          }).join('') : `
          <div style="text-align: center; padding: 60px 20px; color: var(--gray-400);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¯</div>
            <div style="font-size: 15px; font-weight: 500;">ê°œì¸ ëª©í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 13px; margin-top: 8px;">íŒ€ì›ë“¤ì´ ê°œì¸ ëª©í‘œë¥¼ ì„¤ì •í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
          `}
        </div>
      `;
    }

    // ë Œë”ë§
    function render() {
      const container = document.getElementById('content');
      if (!container || !snapshotData) return;

      if (currentTab === 'team') {
        renderTeamGrowthboard();
      } else {
        renderPersonalGrowthboardTab();
      }
    }

    // íŒ€ ê·¸ë¡œìŠ¤ë³´ë“œ ë Œë”ë§
    function renderTeamGrowthboard() {
      const container = document.getElementById('content');
      if (!container || !snapshotData) return;

      const oRate = calcObjectiveRate();
      const krRates = snapshotData.keyResults.map(kr => ({ ...kr, rate: calcKRRate(kr.id) }));

      // KPI í˜„í™© ë°ì´í„°
      const kpiStatusData = snapshotData.kpis.map(kpi => {
        const kr = snapshotData.keyResults.find(k => k.id === kpi.keyResultId);
        const krIdx = snapshotData.keyResults.findIndex(k => k.id === kpi.keyResultId);
        const rate = calcKPIRate(kpi.id);
        const lagsForKPI = snapshotData.laggingIndicators.filter(l => l.kpiId === kpi.id);
        let currentValue = 0;
        lagsForKPI.forEach(lag => {
          if (lag.type === 'result') {
            const logs = snapshotData.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
            logs.forEach(log => {
              const value = lag.valuePerUnit > 0 ? (log.resultValue || 0) * lag.valuePerUnit : (log.resultValue || 0);
              currentValue += value;
            });
          }
        });
        return { ...kpi, kr, krIdx, rate, currentValue };
      }).sort((a, b) => a.krIdx - b.krIdx);

      // í™œë™í˜•/ì„±ê³¼í˜• ìš”ì•½
      const activityLags = snapshotData.laggingIndicators.filter(l => l.type !== 'result');
      const resultLags = snapshotData.laggingIndicators.filter(l => l.type === 'result');

      const activityLogs = snapshotData.dailyLogs.filter(log => {
        const lag = snapshotData.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        return lag && lag.type !== 'result';
      });
      const totalActivityCount = activityLogs.reduce((sum, l) => sum + (l.resultValue || 0), 0);

      let totalResultValue = 0;
      snapshotData.dailyLogs.forEach(log => {
        const lag = snapshotData.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        if (lag && lag.type === 'result') {
          const value = lag.valuePerUnit > 0 ? (log.resultValue || 0) * lag.valuePerUnit : (log.resultValue || 0);
          totalResultValue += value;
        }
      });

      container.innerHTML = `
        <!-- ëª©í‘œ ì¹´ë“œ -->
        <div class="objective-card">
          <div class="objective-name">${snapshotData.objective?.name || 'ëª©í‘œ ë¯¸ì„¤ì •'}</div>
          <div class="objective-period">${snapshotData.objective?.startDate || ''} ~ ${snapshotData.objective?.endDate || ''}</div>
          <div class="objective-rate">${oRate}%</div>
          <div class="objective-progress">
            <div class="objective-progress-fill" style="width: ${Math.min(oRate, 100)}%;"></div>
          </div>
        </div>

        <!-- KR í˜„í™© -->
        <div class="card">
          <div class="card-title">ğŸ“ˆ KR í˜„í™©</div>
          <div class="kr-grid">
            ${krRates.map((kr, idx) => `
              <div class="kr-card" style="border-left: 4px solid ${okrColors[idx]};" onclick="showKRDetail('${kr.id}')">
                <div class="kr-header">
                  <div class="kr-name">
                    <span>${okrIcons[idx] || 'ğŸ“Š'}</span> ${kr.name}
                  </div>
                  <span class="kr-badge" style="background: ${okrColors[idx]}20; color: ${okrColors[idx]};">${kr.rate}%</span>
                </div>
                <div class="kr-progress">
                  <div class="kr-progress-fill" style="width: ${Math.min(kr.rate, 100)}%; background: ${okrColors[idx]};"></div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- KPI í˜„í™© í…Œì´ë¸” -->
        <div class="card">
          <div class="card-title">ğŸ“Š KPI í˜„í™©</div>
          <div style="overflow-x: auto;">
            <table class="kpi-table">
              <thead>
                <tr>
                  <th>KR</th>
                  <th>KPI</th>
                  <th style="text-align: right;">ëª©í‘œ</th>
                  <th style="text-align: right;">í˜„ì¬</th>
                  <th style="text-align: right;">ë‹¬ì„±ë¥ </th>
                  <th style="text-align: center; width: 100px;">ì§„í–‰</th>
                </tr>
              </thead>
              <tbody>
                ${(() => {
                  if (kpiStatusData.length === 0) {
                    return '<tr><td colspan="6" style="padding: 30px; text-align: center; color: var(--gray-400);">ë“±ë¡ëœ KPIê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                  }

                  const krGroups = {};
                  kpiStatusData.forEach(kpi => {
                    const krId = kpi.keyResultId;
                    if (!krGroups[krId]) krGroups[krId] = [];
                    krGroups[krId].push(kpi);
                  });

                  const renderedKRs = new Set();

                  return kpiStatusData.map((kpi, idx) => {
                    const statusColor = kpi.rate >= 80 ? 'var(--success)' : kpi.rate >= 50 ? 'var(--warning)' : 'var(--danger)';
                    const krId = kpi.keyResultId;
                    const rowspan = krGroups[krId]?.length || 1;
                    const showKrCell = !renderedKRs.has(krId);

                    if (showKrCell) renderedKRs.add(krId);

                    return `
                      <tr class="kpi-row" onclick="showKPIDetail('${kpi.id}')">
                        ${showKrCell ? `
                        <td style="vertical-align: middle; background: ${okrColors[kpi.krIdx]}10;" rowspan="${rowspan}">
                          <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${okrColors[kpi.krIdx]}20; color: ${okrColors[kpi.krIdx]}; white-space: nowrap;">
                            <span style="font-size: 10px;">â—</span> ${kpi.kr?.name || '-'}
                          </span>
                        </td>
                        ` : ''}
                        <td style="font-weight: 500; color: var(--gray-800);">
                          <div><span style="color: ${statusColor}; font-size: 10px;">â—</span> ${kpi.name}</div>
                          ${kpi.mainAssigneeName || (kpi.subAssigneeNames && kpi.subAssigneeNames.length > 0) ? `
                            <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">
                              ${kpi.mainAssigneeName ? `â­ ${kpi.mainAssigneeName}` : ''}
                              ${kpi.mainAssigneeName && kpi.subAssigneeNames && kpi.subAssigneeNames.length > 0 ? ' Â· ' : ''}
                              ${kpi.subAssigneeNames && kpi.subAssigneeNames.length > 0 ? `ğŸ“Œ ${kpi.subAssigneeNames.join(', ')}` : ''}
                            </div>
                          ` : ''}
                        </td>
                        <td style="text-align: right; color: var(--gray-500);">${formatAmountWithSummary(kpi.targetValue || 0, kpi.unit || '')}</td>
                        <td style="text-align: right; font-weight: 600; color: var(--gray-700);">${formatAmountWithSummary(kpi.currentValue, kpi.unit || '')}</td>
                        <td style="text-align: right;">
                          <span style="font-weight: 700; color: ${statusColor};">${kpi.rate}%</span>
                        </td>
                        <td style="width: 100px;">
                          <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(kpi.rate, 100)}%; background: ${statusColor}; border-radius: 3px;"></div>
                          </div>
                        </td>
                      </tr>
                    `;
                  }).join('');
                })()}
              </tbody>
            </table>
          </div>
        </div>

        <!-- í™œë™ vs ì„±ê³¼ ìš”ì•½ -->
        <div class="card">
          <div class="card-title">ğŸ“Š í™œë™ vs ì„±ê³¼ í˜„í™©</div>
          <div class="summary-grid">
            <div class="summary-box activity">
              <div class="summary-title">
                ğŸ“‹ í™œë™í˜• ì§€í‘œ
                <span style="font-size: 11px; padding: 2px 8px; background: var(--gray-200); color: var(--gray-600); border-radius: 10px;">ì°¸ê³ ìš©</span>
              </div>
              <div class="summary-row">
                <span style="color: var(--gray-500);">ë“±ë¡ëœ ì§€í‘œ</span>
                <span style="font-weight: 600;">${activityLags.length}ê°œ</span>
              </div>
              <div class="summary-row">
                <span style="color: var(--gray-500);">ì´ í™œë™ íšŸìˆ˜</span>
                <span style="font-weight: 600;">${totalActivityCount.toLocaleString()}ê±´</span>
              </div>
            </div>
            <div class="summary-box result">
              <div class="summary-title">
                ğŸ’° ì„±ê³¼í˜• ì§€í‘œ
                <span style="font-size: 11px; padding: 2px 8px; background: var(--success); color: white; border-radius: 10px;">KPI ë°˜ì˜</span>
              </div>
              <div class="summary-row">
                <span style="color: var(--gray-600);">ë“±ë¡ëœ ì§€í‘œ</span>
                <span style="font-weight: 600;">${resultLags.length}ê°œ</span>
              </div>
              <div class="summary-row">
                <span style="color: var(--gray-600);">ì´ ì„±ê³¼ ê¸ˆì•¡</span>
                <span style="font-weight: 700; color: var(--success);">${formatAmountWithSummary(totalResultValue, 'ì›')}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ìë™ ê°±ì‹ ìš© ì „ì—­ ë³€ìˆ˜
    let autoRefreshInterval = null;
    let currentToken = null;
    let isRealtime = false;

    // ë°ì´í„° ê°±ì‹  í•¨ìˆ˜
    async function refreshData() {
      if (!currentToken) return;

      try {
        const result = await validateAndLoadSnapshot(currentToken);
        if (result.valid) {
          snapshotData = result.data;
          render();

          // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê° í‘œì‹œ
          const dateEl = document.getElementById('snapshotDate');
          if (dateEl && isRealtime) {
            const now = new Date();
            dateEl.textContent = `ìµœì¢… ì—…ë°ì´íŠ¸: ${now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;
          }
        }
      } catch (e) {
        console.error('ìë™ ê°±ì‹  ì‹¤íŒ¨:', e);
      }
    }

    // ì´ˆê¸°í™”
    async function init() {
      const token = getTokenFromUrl();
      currentToken = token;
      const result = await validateAndLoadSnapshot(token);

      document.getElementById('loading').style.display = 'none';

      if (!result.valid) {
        document.getElementById('errorMessage').textContent = result.error;
        document.getElementById('error').style.display = 'flex';
        return;
      }

      snapshotData = result.data;
      isRealtime = result.isRealtime;

      // ë°°ì§€ ì—…ë°ì´íŠ¸
      const badgeEl = document.getElementById('modeBadge');
      if (badgeEl) {
        if (isRealtime) {
          badgeEl.textContent = 'ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™”';
          badgeEl.style.background = 'rgba(255,255,255,0.3)';
        } else {
          badgeEl.textContent = 'ğŸ“¸ ìŠ¤ëƒ…ìƒ·';
          badgeEl.style.background = 'rgba(255,255,255,0.2)';
        }
      }

      // ë‚ ì§œ í‘œì‹œ
      const dateEl = document.getElementById('snapshotDate');
      if (dateEl) {
        if (isRealtime) {
          const now = new Date();
          dateEl.textContent = `ìµœì¢… ì—…ë°ì´íŠ¸: ${now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;

          // 1ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹ 
          autoRefreshInterval = setInterval(refreshData, 60000); // 60ì´ˆ = 1ë¶„
        } else {
          // ìŠ¤ëƒ…ìƒ· ëª¨ë“œ
          const date = new Date(result.createdAt);
          dateEl.textContent = `ìƒì„±ì¼: ${date.toLocaleDateString('ko-KR')} ${date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}`;
        }
      }

      document.getElementById('app').style.display = 'block';
      render();
    }

    init();

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ íƒ€ì´ë¨¸ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê·¸ë¡œìŠ¤ë³´ë“œ (Growth Board) - ì „ëµì„¼í„°</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #6366F1;
      --primary-light: #E0E7FF;
      --primary-dark: #4F46E5;
      --success: #10B981;
      --success-light: #D1FAE5;
      --warning: #F59E0B;
      --warning-light: #FEF3C7;
      --danger: #EF4444;
      --danger-light: #FEE2E2;
      --white: #ffffff;
      --gray-900: #191f28;
      --gray-800: #333d4b;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      --kr1-color: #8B5CF6;
      --kr2-color: #06B6D4;
      --kr3-color: #10B981;
      --kr4-color: #F59E0B;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      background: var(--gray-100);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ë ˆì´ì•„ì›ƒ */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 280px;
      background: var(--white);
      border-right: 1px solid var(--gray-200);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px;
      border-bottom: 1px solid var(--gray-100);
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), #8B5CF6);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .logo-text small {
      display: block;
      font-size: 11px;
      font-weight: 400;
      color: var(--gray-500);
      margin-top: 2px;
    }

    /* ëª©í‘œ ìš”ì•½ */
    .objective-summary {
      padding: 20px;
      background: linear-gradient(135deg, var(--primary), #8B5CF6);
      margin: 16px;
      border-radius: 16px;
      color: white;
    }

    .objective-summary-title {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .objective-summary-rate {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .objective-summary-bar {
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      overflow: hidden;
    }

    .objective-summary-fill {
      height: 100%;
      background: white;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    /* ë„¤ë¹„ê²Œì´ì…˜ */
    .nav-section {
      padding: 16px 12px;
    }

    .nav-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-500);
      letter-spacing: -0.2px;
      padding: 0 8px;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      border-radius: 10px;
      margin-bottom: 4px;
    }

    .nav-item:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }

    .nav-item.active {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }

    .nav-item .icon {
      width: 24px;
      text-align: center;
      font-size: 18px;
    }

    .nav-item .badge {
      margin-left: auto;
      background: var(--danger);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* ê°€ì´ë“œ ì¹´ë“œ */
    .guide-card {
      margin: 16px;
      background: var(--warning-light);
      border: 1px solid var(--warning);
      border-radius: 12px;
      overflow: hidden;
    }

    .guide-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .guide-header:hover {
      background: rgba(245, 158, 11, 0.1);
    }

    .guide-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .guide-toggle {
      font-size: 11px;
      color: var(--gray-600);
    }

    .guide-content {
      display: none;
      padding: 0 16px 16px 16px;
      border-top: 1px solid rgba(245, 158, 11, 0.3);
      font-size: 12px;
      color: var(--gray-600);
      line-height: 1.6;
    }

    .guide-content.show {
      display: block;
    }

    .guide-content p {
      margin-top: 12px;
    }

    /* í•˜ë‹¨ ë§í¬ */
    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--gray-200);
      margin-top: auto;
    }

    .back-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      color: var(--gray-600);
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-link:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    /* ë©”ì¸ ì»¨í…ì¸  */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 28px 32px;
      max-width: 1200px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-subtitle {
      font-size: 14px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    /* ì¹´ë“œ */
    .card {
      background: var(--white);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ê·¸ë¦¬ë“œ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    /* O ëª©í‘œ ì¹´ë“œ */
    .objective-card {
      background: linear-gradient(135deg, var(--primary), #8B5CF6);
      color: white;
      padding: 28px;
    }

    .objective-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .objective-period {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .objective-rate {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: white;
      border-radius: 6px;
      transition: width 0.5s ease;
    }

    /* KR ì¹´ë“œ */
    .kr-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .kr-item {
      padding: 16px;
      border-radius: 12px;
      background: var(--gray-50);
      cursor: pointer;
      transition: all 0.2s;
    }

    .kr-item:hover {
      background: var(--gray-100);
    }

    .kr-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .kr-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .kr-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .kr-progress {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
    }

    .kr-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* ì—…ë¬´ ê¸°ë¡ */
    .record-section {
      margin-bottom: 28px;
    }

    .record-section-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .record-section-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .record-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .record-btn {
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 120px;
    }

    .record-btn:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    }

    .record-btn-icon {
      font-size: 28px;
    }

    .record-btn-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      text-align: center;
    }

    .record-btn-version {
      font-size: 11px;
      color: var(--gray-500);
    }

    .record-btn-action {
      background: var(--primary);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      margin-top: 4px;
    }

    /* ì˜¤ëŠ˜ ê¸°ë¡ ìš”ì•½ */
    .today-summary {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 20px;
      margin-top: 24px;
    }

    .today-summary-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-700);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .today-summary-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .today-summary-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--gray-600);
    }

    .today-summary-empty {
      color: var(--gray-400);
      font-size: 13px;
    }

    /* íŒŒì´í”„ë¼ì¸ */
    .pipeline-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .pipeline-arrow {
      color: var(--gray-400);
    }

    .pipeline-value {
      font-weight: 600;
      color: var(--success);
    }

    /* ëª©í‘œ ì„¤ì • */
    .objective-setting {
      background: linear-gradient(135deg, var(--primary-light), #DDD6FE);
      border: 2px solid var(--primary);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .objective-setting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .objective-setting-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .kr-setting-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .kr-setting-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid var(--primary);
    }

    .kr-setting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .kr-setting-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .kpi-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-left: 16px;
    }

    .kpi-item {
      padding: 12px 16px;
      background: var(--gray-50);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .kpi-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .kpi-target {
      font-size: 13px;
      color: var(--gray-500);
    }

    /* ì‹¤í—˜ ë¶„ì„ */
    .experiment-selector {
      margin-bottom: 24px;
    }

    .experiment-select {
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
      min-width: 250px;
      cursor: pointer;
      font-family: inherit;
    }

    .experiment-results {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .experiment-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      border: 1px solid var(--gray-100);
    }

    .experiment-rank {
      font-size: 32px;
    }

    .experiment-info {
      flex: 1;
    }

    .experiment-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 4px;
    }

    .experiment-stats {
      font-size: 13px;
      color: var(--gray-500);
    }

    .experiment-bar {
      flex: 2;
    }

    .experiment-bar-fill {
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      padding-left: 12px;
      color: white;
      font-size: 13px;
      font-weight: 600;
    }

    /* ë²„íŠ¼ */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-500);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-800);
      color: white;
      padding: 14px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* ëª¨ë°”ì¼ ë©”ë‰´ */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 150;
      background: var(--primary);
      color: var(--white);
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 90;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: flex;
      }

      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-overlay.show {
        display: block;
      }

      .main-content {
        margin-left: 0;
        padding: 70px 16px 20px 16px;
      }

      .page-title {
        font-size: 20px;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .record-btn {
        min-width: 100px;
        padding: 12px 14px;
      }
    }
  </style>
</head>
<body>
  <!-- ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ -->
  <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

  <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <div class="app-container">
    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar" id="sidebar">
      <div class="logo">
        <div class="logo-icon">ğŸ“Š</div>
        <div class="logo-text">
          ê·¸ë¡œìŠ¤ë³´ë“œ
          <small>Growth Board: Input/Output Metricsë¡œ ì„±ì¥ ì¶”ì </small>
        </div>
      </div>

      <!-- ëª©í‘œ ë‹¬ì„±ë¥  ìš”ì•½ -->
      <div class="objective-summary" id="objectiveSummary">
        <div class="objective-summary-title">ì „ì²´ ëª©í‘œ ë‹¬ì„±ë¥ </div>
        <div class="objective-summary-rate" id="sidebarORate">0%</div>
        <div class="objective-summary-bar">
          <div class="objective-summary-fill" id="sidebarOFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
      <nav class="nav-section">
        <div class="nav-label">ë©”ë‰´</div>
        <div class="nav-item active" data-view="dashboard" onclick="switchView('dashboard')">
          <span class="icon">ğŸ“ˆ</span>
          <span>ëŒ€ì‹œë³´ë“œ</span>
        </div>
        <div class="nav-item" data-view="record" onclick="switchView('record')">
          <span class="icon">ğŸ“</span>
          <span>ì—…ë¬´ ê¸°ë¡</span>
          <span class="badge" id="todayLogCount">0</span>
        </div>
        <div class="nav-item" data-view="settings" onclick="switchView('settings')">
          <span class="icon">ğŸ¯</span>
          <span>ëª©í‘œ ì„¤ì •</span>
        </div>
        <div class="nav-item" data-view="experiment" onclick="switchView('experiment')">
          <span class="icon">ğŸ”¬</span>
          <span>ì‹¤í—˜ ë¶„ì„</span>
        </div>
      </nav>

      <!-- ê°€ì´ë“œ ì¹´ë“œ -->
      <div class="guide-card">
        <div class="guide-header" onclick="toggleGuide()">
          <div class="guide-title">
            <span>ğŸ’¡</span>
            <span>ê·¸ë¡œìŠ¤ë³´ë“œë€?</span>
          </div>
          <div class="guide-toggle" id="guideToggle">â–¼</div>
        </div>
        <div class="guide-content" id="guideContent">
          <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 12px;">
            <b>Growth Board</b>ëŠ” ìŠ¤íƒ€íŠ¸ì—…ì˜ ì„±ì¥ì„ ì¶”ì í•˜ëŠ” ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.
            í™œë™(Input)ê³¼ ì„±ê³¼(Output)ë¥¼ ë¶„ë¦¬í•˜ì—¬ "ë¬´ì—‡ì´ ì‹¤ì œë¡œ ì„±ê³¼ë¥¼ ë§Œë“œëŠ”ê°€"ë¥¼ ë°ì´í„°ë¡œ ì¦ëª…í•©ë‹ˆë‹¤.
          </p>
          <p><b>ğŸ“Š Input/Output Metrics:</b></p>
          <p style="font-size: 12px; margin-left: 12px;">
            â€¢ <b>Input (í™œë™ì§€í‘œ):</b> í†µì œ ê°€ëŠ¥í•œ í–‰ë™ (ì „í™”, ë¯¸íŒ…, ì œì•ˆ)<br>
            â€¢ <b>Output (ì„±ê³¼ì§€í‘œ):</b> í™œë™ì˜ ê²°ê³¼ (ì •ì‚°ì™„ë£Œ, ê³„ì•½ ì„±ì‚¬, ë§¤ì¶œ)
          </p>
          <p><b>ğŸ¯ êµ¬ì¡°:</b> ëª©í‘œ â†’ ë©”ì¸ KPI â†’ ì„œë¸Œ KPI â†’ Input/Output Metrics</p>
          <p><b>âœï¸ ê¸°ë¡:</b> Outputì€ ê¸ˆì•¡ ì…ë ¥, Inputì€ +1 ì¹´ìš´íŠ¸</p>
          <p><b>ğŸ”¬ ë¶„ì„:</b> A/B ë²„ì „ë³„ íš¨ê³¼ ë¹„êµë¡œ ìµœì ì˜ ì „ëµ ë°œê²¬</p>
        </div>
      </div>

      <!-- í•˜ë‹¨ ë§í¬ -->
      <div class="sidebar-footer">
        <a href="index.html" class="back-link">
          <span>â†</span>
          <span>ì „ëµì„¼í„°ë¡œ ëŒì•„ê°€ê¸°</span>
        </a>
      </div>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
      <!-- ëŒ€ì‹œë³´ë“œ ë·° -->
      <div class="view-content active" id="view-dashboard">
        <div class="page-header">
          <h1 class="page-title">ğŸ“ˆ ëŒ€ì‹œë³´ë“œ</h1>
          <p class="page-subtitle">ëª©í‘œ ë‹¬ì„± í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div id="dashboardContent"></div>
      </div>

      <!-- ì—…ë¬´ ê¸°ë¡ ë·° -->
      <div class="view-content" id="view-record">
        <div class="page-header">
          <h1 class="page-title">ğŸ“ ì—…ë¬´ ê¸°ë¡</h1>
          <p class="page-subtitle">ë²„íŠ¼ í´ë¦­ë§Œìœ¼ë¡œ ì—…ë¬´ë¥¼ ê¸°ë¡í•˜ì„¸ìš”</p>
        </div>
        <div id="recordContent"></div>
      </div>

      <!-- ëª©í‘œ ì„¤ì • ë·° -->
      <div class="view-content" id="view-settings">
        <div class="page-header">
          <h1 class="page-title">ğŸ¯ ëª©í‘œ ì„¤ì •</h1>
          <p class="page-subtitle">ëª©í‘œ, ë©”ì¸ KPI, ì„œë¸Œ KPI, Input/Output Metricsë¥¼ ì„¤ì •í•˜ì„¸ìš”</p>
        </div>
        <div id="settingsContent"></div>
      </div>

      <!-- ì‹¤í—˜ ë¶„ì„ ë·° -->
      <div class="view-content" id="view-experiment">
        <div class="page-header">
          <h1 class="page-title">ğŸ”¬ ì‹¤í—˜ ë¶„ì„</h1>
          <p class="page-subtitle">A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¹„êµ ë¶„ì„í•˜ì„¸ìš”</p>
        </div>
        <div id="experimentContent"></div>
      </div>
    </main>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div class="modal" id="modal"></div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div class="toast" id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    // Firebase ì„¤ì • (moyeora-deal-manager)
    const firebaseConfig = {
      apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
      authDomain: "moyeora-deal-manager.firebaseapp.com",
      projectId: "moyeora-deal-manager",
      storageBucket: "moyeora-deal-manager.firebasestorage.app",
      messagingSenderId: "527148187832",
      appId: "1:527148187832:web:dc35b0413a7157db34744d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ìƒíƒœ
    let state = {
      objective: null,
      keyResults: [],
      kpis: [],
      leadingIndicators: [],
      laggingIndicators: [],
      dailyLogs: [],
      todayLogs: [],
      currentUser: null
    };

    // ì˜¤ëŠ˜ ë‚ ì§œ
    const today = new Date().toISOString().split('T')[0];

    // ========================================
    // ì´ˆê¸°í™”
    // ========================================
    async function init() {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          state.currentUser = user;
          await loadAllData();
          renderAll();
        } else {
          await loadAllData();
          renderAll();
        }
      });
    }

    async function loadAllData() {
      try {
        // ëª©í‘œ
        const objSnapshot = await db.collection('okr_objective').limit(1).get();
        state.objective = objSnapshot.docs.length > 0
          ? { id: objSnapshot.docs[0].id, ...objSnapshot.docs[0].data() }
          : null;

        // KR
        const krSnapshot = await db.collection('okr_keyResults').orderBy('order').get();
        state.keyResults = krSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // KPI
        const kpiSnapshot = await db.collection('okr_kpis').orderBy('order').get();
        state.kpis = kpiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì„ í–‰ì§€í‘œ
        const leadSnapshot = await db.collection('okr_leadingIndicators').get();
        state.leadingIndicators = leadSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // í›„í–‰ì§€í‘œ
        const lagSnapshot = await db.collection('okr_laggingIndicators').get();
        state.laggingIndicators = lagSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì—…ë¬´ì¼ì§€ (ìµœê·¼ 30ì¼)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const logSnapshot = await db.collection('okr_dailyLogs')
          .where('date', '>=', thirtyDaysAgo.toISOString().split('T')[0])
          .orderBy('date', 'desc')
          .get();
        state.dailyLogs = logSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì˜¤ëŠ˜ ë¡œê·¸
        state.todayLogs = state.dailyLogs.filter(log => log.date === today);

        // ì´ˆê¸° ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì‹œë“œ
        if (!state.objective) {
          await seedInitialData();
        }

      } catch (e) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }

    // ========================================
    // ì´ˆê¸° ë°ì´í„° ì‹œë“œ (ìš°ë¦¬ê°€ ì •ë¦¬í•œ êµ¬ì¡°)
    // ========================================
    async function seedInitialData() {
      try {
        showToast('ì´ˆê¸° ë°ì´í„° ìƒì„± ì¤‘...');

        // 1. O (ëª©í‘œ) ìƒì„±
        const objRef = await db.collection('okr_objective').add({
          name: '26ë…„ë„ PMFë¥¼ ì°¾ëŠ” ë‹¨ê³„, ë¹ ë¥¸ ë°ì´í„° ì¶”ì¶œ ë° ê°œì„ í•˜ì—¬ ì—° 10ì–µ ë§¤ì¶œ ë‹¬ì„±',
          startDate: '2026-01-01',
          endDate: '2026-12-31',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        const objId = objRef.id;

        // 2. KR 4ê°œ ìƒì„±
        const krData = [
          { name: 'ğŸ’° ì—°ë§¤ì¶œ 10ì–µ ë‹¬ì„±', targetValue: 1000000000, unit: 'ì›', order: 1 },
          { name: 'ğŸ‘¥ íŒŒíŠ¸ë„ˆ ë„¤íŠ¸ì›Œí¬ í™•ë³´', targetValue: 500, unit: 'ëª…/ê³³', order: 2 },
          { name: 'ğŸ“± í”Œë«í¼ í’ˆì§ˆ í–¥ìƒ', targetValue: 80, unit: '%', order: 3 },
          { name: 'ğŸ“¢ ë¸Œëœë“œ ì¸ì§€ë„ í™•ë¦½', targetValue: 70, unit: '%', order: 4 }
        ];

        const krIds = [];
        for (const kr of krData) {
          const krRef = await db.collection('okr_keyResults').add({
            ...kr,
            objectiveId: objId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          krIds.push(krRef.id);
        }

        // 3. KPI ìƒì„± (KRë³„)
        const kpiData = {
          // KR1: ì—°ë§¤ì¶œ 10ì–µ
          [krIds[0]]: [
            { name: 'êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ', targetValue: 800000000, unit: 'ì›', order: 1,
              lags: [
                { version: 'A', name: 'ì •ì‚°ì™„ë£Œ', type: 'output' },
                { version: 'B', name: 'ì „í™” ìƒë‹´', type: 'input' },
                { version: 'C', name: 'í˜„ì¥ ë¯¸íŒ…', type: 'input' }
              ]
            },
            { name: 'í•´ì™¸ ìˆ˜ì¶œ ë§¤ì¶œ', targetValue: 100000000, unit: 'ì›', order: 2,
              lags: [
                { version: 'A', name: 'ì •ì‚°ì™„ë£Œ', type: 'output' },
                { version: 'B', name: 'ì…€ëŸ¬ ì œì•ˆ', type: 'input' },
                { version: 'C', name: 'ê³„ì•½ í˜‘ìƒ', type: 'input' }
              ]
            },
            { name: 'í•´ì™¸ ìˆ˜ì… ë§¤ì¶œ', targetValue: 100000000, unit: 'ì›', order: 3,
              lags: [
                { version: 'A', name: 'ì •ì‚°ì™„ë£Œ', type: 'output' },
                { version: 'B', name: 'ë°”ì´ì–´ ë¯¸íŒ…', type: 'input' },
                { version: 'C', name: 'ìƒ˜í”Œ ë°œì†¡', type: 'input' }
              ]
            },
            { name: 'ë‹¹ê·¼ Ã— ëª¨ì—¬ë¼ë”œ', targetValue: 50000000, unit: 'ì›', order: 4,
              lags: [
                { version: 'A', name: 'ì •ì‚°ì™„ë£Œ', type: 'output' },
                { version: 'B', name: 'ì»¤ë®¤ë‹ˆí‹° í™ë³´', type: 'input' }
              ]
            }
          ],
          // KR2: íŒŒíŠ¸ë„ˆ ë„¤íŠ¸ì›Œí¬
          [krIds[1]]: [
            { name: 'ê³µê¸‰ì‚¬ í™•ë³´', targetValue: 200, unit: 'ê³³', order: 1,
              lags: [
                { version: 'A', name: 'ê³µê¸‰ì‚¬ ì…ì ', type: 'output' },
                { version: 'B', name: 'ê³µê¸‰ì‚¬ ì œì•ˆ', type: 'input' },
                { version: 'C', name: 'ì†Œê°œì‚¬ì´íŠ¸ ìœ ì…', type: 'input' }
              ]
            },
            { name: 'í™œì„± ì…€ëŸ¬ í™•ë³´', targetValue: 300, unit: 'ëª…', order: 2,
              lags: [
                { version: 'A', name: 'ì…€ëŸ¬ ê°€ì… ì™„ë£Œ', type: 'output' },
                { version: 'B', name: 'ê°€ì… ì œì•ˆ', type: 'input' },
                { version: 'C', name: 'ì…€ëŸ¬ êµìœ¡', type: 'input' }
              ]
            },
            { name: 'ë¸Œëœë“œ í˜‘ì—… íŒŒíŠ¸ë„ˆ', targetValue: 20, unit: 'ê±´', order: 3,
              lags: [
                { version: 'A', name: 'ê³„ì•½ ì²´ê²°', type: 'output' },
                { version: 'B', name: 'í˜‘ì—… ì œì•ˆ', type: 'input' }
              ]
            }
          ],
          // KR3: í”Œë«í¼ í’ˆì§ˆ
          [krIds[2]]: [
            { name: 'êµ¬ë§¤ ì „í™˜ìœ¨', targetValue: 80, unit: '%', order: 1,
              lags: [
                { version: 'A', name: 'ì „í™˜ìœ¨ ì¸¡ì •', type: 'output' },
                { version: 'B', name: 'UX/UI ê°œì„ ', type: 'input' },
                { version: 'C', name: 'ì•± ì„±ëŠ¥ ìµœì í™”', type: 'input' }
              ]
            },
            { name: 'ê´€ë¦¬ìì‹œìŠ¤í…œ ì™„ì„±ë„', targetValue: 70, unit: '%', order: 2,
              lags: [
                { version: 'A', name: 'ì™„ì„±ë„ í‰ê°€', type: 'output' },
                { version: 'B', name: 'ìš´ì˜ì„¼í„° ê°œë°œ', type: 'input' },
                { version: 'C', name: 'CRMì„¼í„° ê°œë°œ', type: 'input' }
              ]
            },
            { name: 'íŒŒíŠ¸ë„ˆí¬í„¸ ì™„ì„±ë„', targetValue: 70, unit: '%', order: 3,
              lags: [
                { version: 'A', name: 'ì™„ì„±ë„ í‰ê°€', type: 'output' },
                { version: 'B', name: 'í¬í„¸ ê¸°ëŠ¥ ê°œë°œ', type: 'input' }
              ]
            }
          ],
          // KR4: ë¸Œëœë“œ ì¸ì§€ë„
          [krIds[3]]: [
            { name: 'ë¸Œëœë“œ ì •ì²´ì„± í™•ë¦½', targetValue: 100, unit: '%', order: 1,
              lags: [
                { version: 'A', name: 'ì™„ì„±ë„ í‰ê°€', type: 'output' },
                { version: 'B', name: 'BI êµ¬ì¶•', type: 'input' }
              ]
            },
            { name: 'ë§ˆì¼€íŒ… ì„±ê³¼', targetValue: 70, unit: '%', order: 2,
              lags: [
                { version: 'A', name: 'ì„±ê³¼ ì¸¡ì •', type: 'output' },
                { version: 'B', name: 'ì¸í”Œë£¨ì–¸ì„œ í˜‘ì—…', type: 'input' },
                { version: 'C', name: 'í¼í¬ë¨¼ìŠ¤ ë§ˆì¼€íŒ…', type: 'input' }
              ]
            },
            { name: 'í™ë³´ ì½˜í…ì¸ ', targetValue: 50, unit: 'ê±´', order: 3,
              lags: [
                { version: 'A', name: 'ì½˜í…ì¸  ë°œí–‰', type: 'output' },
                { version: 'B', name: 'ì½˜í…ì¸  ì œì‘', type: 'input' }
              ]
            }
          ]
        };

        // KPIì™€ í›„í–‰ì§€í‘œ ìƒì„±
        for (const krId of Object.keys(kpiData)) {
          const kpis = kpiData[krId];
          for (const kpi of kpis) {
            const { lags, ...kpiInfo } = kpi;
            const kpiRef = await db.collection('okr_kpis').add({
              ...kpiInfo,
              keyResultId: krId,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Input/Output Metrics ìƒì„±
            for (const lag of lags) {
              await db.collection('okr_laggingIndicators').add({
                kpiId: kpiRef.id,
                version: lag.version,
                name: lag.name,
                type: lag.type || 'input',  // ê¸°ë³¸ê°’: input
                totalValue: 0,
                logCount: 0,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
        }

        // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        await loadAllData();
        showToast('ì´ˆê¸° ë°ì´í„° ìƒì„± ì™„ë£Œ!');

      } catch (e) {
        console.error('ì´ˆê¸° ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', e);
        showToast('ì´ˆê¸° ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ' + e.message);
      }
    }

    // ========================================
    // ë Œë”ë§
    // ========================================
    function renderAll() {
      updateSidebar();
      renderDashboard();
      renderSettings();
      renderRecord();
      renderExperiment();
    }

    // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
    function updateSidebar() {
      const oRate = calculateObjectiveRate();
      document.getElementById('sidebarORate').textContent = oRate + '%';
      document.getElementById('sidebarOFill').style.width = Math.min(oRate, 100) + '%';
      document.getElementById('todayLogCount').textContent = state.todayLogs.length;
    }

    // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    function renderDashboard() {
      const container = document.getElementById('dashboardContent');

      if (!state.objective) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¯</div>
            <div class="empty-state-title">ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
            <div class="empty-state-desc">[ëª©í‘œ ì„¤ì •] íƒ­ì—ì„œ ëª©í‘œë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div>
            <button class="btn btn-primary" onclick="switchView('settings')">ëª©í‘œ ì„¤ì •í•˜ê¸°</button>
          </div>
        `;
        return;
      }

      // O ë‹¬ì„±ë¥  ê³„ì‚°
      const oRate = calculateObjectiveRate();

      // KRë³„ ë‹¬ì„±ë¥ 
      const krRates = state.keyResults.map(kr => ({
        ...kr,
        rate: calculateKRRate(kr.id)
      }));

      container.innerHTML = `
        <!-- O ë‹¬ì„±ë¥  -->
        <div class="card objective-card">
          <div class="objective-name">${state.objective.name || 'ëª©í‘œ ë¯¸ì„¤ì •'}</div>
          <div class="objective-period">${state.objective.startDate || ''} ~ ${state.objective.endDate || ''}</div>
          <div class="objective-rate">${oRate}%</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${Math.min(oRate, 100)}%"></div>
          </div>
        </div>

        <div class="dashboard-grid">
          <!-- ë©”ì¸ KPI í˜„í™© -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ“ˆ ë©”ì¸ KPI í˜„í™©</div>
            </div>
            <div class="kr-list">
              ${krRates.map((kr, idx) => {
                const colors = ['var(--kr1-color)', 'var(--kr2-color)', 'var(--kr3-color)', 'var(--kr4-color)'];
                const icons = ['ğŸ’°', 'ğŸ‘¥', 'ğŸ“±', 'ğŸ“¢'];
                return `
                  <div class="kr-item" onclick="switchView('record')">
                    <div class="kr-header">
                      <div class="kr-name">
                        <span>${icons[idx] || 'ğŸ“Š'}</span>
                        ${kr.name}
                      </div>
                      <span class="kr-badge" style="background: ${colors[idx]}20; color: ${colors[idx]}">${kr.rate}%</span>
                    </div>
                    <div class="kr-progress">
                      <div class="kr-progress-fill" style="width: ${Math.min(kr.rate, 100)}%; background: ${colors[idx]}"></div>
                    </div>
                  </div>
                `;
              }).join('')}
              ${krRates.length === 0 ? '<div class="empty-state-desc">KRì´ ì—†ìŠµë‹ˆë‹¤</div>' : ''}
            </div>
          </div>

          <!-- ì˜¤ëŠ˜ ê¸°ì—¬ë„ -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ”„ ì˜¤ëŠ˜ ë‚´ ì—…ë¬´ ê¸°ì—¬ë„</div>
            </div>
            ${state.todayLogs.length > 0 ? `
              <div class="pipeline-list">
                ${state.todayLogs.slice(0, 5).map(log => {
                  const lag = state.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
                  const kpi = state.kpis.find(k => k.id === log.kpiId);
                  const kr = state.keyResults.find(k => k.id === log.krId);
                  // ê¸ˆì•¡ì¸ ê²½ìš° ì²œë‹¨ìœ„ ì½¤ë§ˆ í‘œì‹œ
                  const displayValue = (kpi?.unit === 'ì›' || kpi?.unit === 'ë‹¬ëŸ¬')
                    ? (log.resultValue || 0).toLocaleString()
                    : (log.resultValue || 0);
                  return `
                    <div class="pipeline-item">
                      <span>${lag?.name || 'ì—…ë¬´'}</span>
                      <span class="pipeline-arrow">â†’</span>
                      <span class="pipeline-value">+${displayValue} ${kpi?.unit || 'ê±´'}</span>
                      <span class="pipeline-arrow">â†’</span>
                      <span>${kr?.name || 'KR'}</span>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="empty-state-desc" style="padding: 20px;">ì˜¤ëŠ˜ ê¸°ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            `}
          </div>

          <!-- ëª©í‘œê¹Œì§€ -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ¯ ëª©í‘œê¹Œì§€ ì–¼ë§ˆë‚˜?</div>
            </div>
            ${krRates.filter(kr => kr.rate < 100).slice(0, 3).map(kr => {
              const avgDaily = calculateAvgDailyProgress(kr.id);
              const remaining = 100 - kr.rate;
              const daysNeeded = avgDaily > 0 ? Math.ceil(remaining / avgDaily) : 'âˆ';
              return `
                <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
                  <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">${kr.name}</div>
                  <div style="font-size: 12px; color: var(--gray-500);">
                    í˜„ì¬ ${kr.rate}% â†’ 100% ë‹¬ì„±ê¹Œì§€ ì•½ ${daysNeeded}ì¼ ì˜ˆìƒ
                  </div>
                </div>
              `;
            }).join('')}
            ${krRates.filter(kr => kr.rate < 100).length === 0 ? '<div class="empty-state-desc">ëª¨ë“  KR ë‹¬ì„±!</div>' : ''}
          </div>

          <!-- ìµœê·¼ 7ì¼ ìš”ì•½ -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ“… ìµœê·¼ 7ì¼ ìš”ì•½</div>
            </div>
            ${renderWeeklySummary()}
          </div>
        </div>
      `;
    }

    function renderWeeklySummary() {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const weekLogs = state.dailyLogs.filter(log => log.date >= sevenDaysAgo.toISOString().split('T')[0]);

      if (weekLogs.length === 0) {
        return '<div class="empty-state-desc" style="padding: 20px;">ìµœê·¼ 7ì¼ê°„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      }

      // KRë³„ ì§‘ê³„
      const krSummary = {};
      weekLogs.forEach(log => {
        if (!krSummary[log.krId]) {
          krSummary[log.krId] = { count: 0, value: 0 };
        }
        krSummary[log.krId].count += 1;
        krSummary[log.krId].value += log.resultValue || 0;
      });

      return Object.keys(krSummary).map(krId => {
        const kr = state.keyResults.find(k => k.id === krId);
        const summary = krSummary[krId];
        return `
          <div style="padding: 8px 0; border-bottom: 1px solid var(--gray-100);">
            <span style="font-size: 13px;">${kr?.name || 'KR'}</span>
            <span style="float: right; font-size: 13px; color: var(--success); font-weight: 600;">
              +${summary.value} (${summary.count}ê±´)
            </span>
          </div>
        `;
      }).join('');
    }

    // ëª©í‘œ ì„¤ì • ë Œë”ë§
    function renderSettings() {
      const container = document.getElementById('settingsContent');

      container.innerHTML = `
        <!-- ëª©í‘œ ì„¤ì • -->
        <div class="objective-setting">
          <div class="objective-setting-header">
            <div class="objective-setting-title">ğŸ¯ ìµœì¢… ëª©í‘œ</div>
            <button class="btn btn-primary" onclick="openObjectiveModal()">
              ${state.objective ? 'ìˆ˜ì •' : 'ì„¤ì •í•˜ê¸°'}
            </button>
          </div>
          ${state.objective ? `
            <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${state.objective.name}</div>
            <div style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">
              ${state.objective.startDate || ''} ~ ${state.objective.endDate || ''}
            </div>
          ` : `
            <div style="color: var(--gray-500);">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>
          `}
        </div>

        <!-- ë©”ì¸ KPI ëª©ë¡ -->
        <div class="card-header" style="margin-bottom: 16px;">
          <div class="card-title">ğŸ“ˆ ë©”ì¸ KPI</div>
          <button class="btn btn-primary" onclick="openKRModal()" ${!state.objective ? 'disabled' : ''}>+ ë©”ì¸ KPI ì¶”ê°€</button>
        </div>

        <div class="kr-setting-list">
          ${state.keyResults.map((kr, idx) => {
            const colors = ['var(--kr1-color)', 'var(--kr2-color)', 'var(--kr3-color)', 'var(--kr4-color)'];
            const kpisForKR = state.kpis.filter(k => k.keyResultId === kr.id);
            return `
              <div class="kr-setting-item" style="border-left-color: ${colors[idx]}">
                <div class="kr-setting-header">
                  <div class="kr-setting-name">${kr.name}</div>
                  <div>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openKRModal('${kr.id}')">í¸ì§‘</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openKPIModal('${kr.id}')">+ ì„œë¸Œ KPI</button>
                  </div>
                </div>
                <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">
                  ëª©í‘œ: ${kr.targetValue || 0} ${kr.unit || ''}
                </div>
                <div class="kpi-list">
                  ${kpisForKR.map(kpi => {
                    const lagsForKPI = state.laggingIndicators.filter(l => l.kpiId === kpi.id);
                    return `
                      <div class="kpi-item">
                        <div>
                          <div class="kpi-name">${kpi.name}</div>
                          <div class="kpi-target">ëª©í‘œ: ${kpi.targetValue || 0} ${kpi.unit || ''}</div>
                          <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px;">
                            Metrics: ${lagsForKPI.map(l => l.version + 'ë²„ì „ (' + (l.type === 'output' ? 'Output' : 'Input') + ')').join(', ') || 'ì—†ìŒ'}
                          </div>
                        </div>
                        <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" onclick="openKPIModal('${kr.id}', '${kpi.id}')">í¸ì§‘</button>
                      </div>
                    `;
                  }).join('')}
                  ${kpisForKR.length === 0 ? '<div style="color: var(--gray-400); font-size: 13px;">ì„œë¸Œ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>' : ''}
                </div>
              </div>
            `;
          }).join('')}
          ${state.keyResults.length === 0 ? `
            <div class="empty-state">
              <div class="empty-state-desc">ë©”ì¸ KPIë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // ì—…ë¬´ ê¸°ë¡ ë Œë”ë§
    function renderRecord() {
      const container = document.getElementById('recordContent');

      if (state.keyResults.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <div class="empty-state-title">ëª©í‘œë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div>
            <div class="empty-state-desc">[ëª©í‘œ ì„¤ì •] íƒ­ì—ì„œ ëª©í‘œ, ë©”ì¸ KPI, ì„œë¸Œ KPIë¥¼ ì„¤ì •í•˜ë©´ ì—…ë¬´ ê¸°ë¡ ë²„íŠ¼ì´ ìƒì„±ë©ë‹ˆë‹¤</div>
            <button class="btn btn-primary" onclick="switchView('settings')">ëª©í‘œ ì„¤ì •í•˜ê¸°</button>
          </div>
        `;
        return;
      }

      const colors = ['var(--kr1-color)', 'var(--kr2-color)', 'var(--kr3-color)', 'var(--kr4-color)'];
      const icons = ['ğŸ’°', 'ğŸ‘¥', 'ğŸ“±', 'ğŸ“¢'];

      container.innerHTML = `
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ ì›í´ë¦­ ì—…ë¬´ ê¸°ë¡</div>
            <div style="font-size: 14px; color: var(--gray-500);">${today}</div>
          </div>

          ${state.keyResults.map((kr, krIdx) => {
            const kpisForKR = state.kpis.filter(k => k.keyResultId === kr.id);
            return `
              <div class="record-section">
                <div class="record-section-title">
                  <span>${icons[krIdx] || 'ğŸ“Š'}</span>
                  ${kr.name}
                  <span class="record-section-badge" style="background: ${colors[krIdx]}">${calculateKRRate(kr.id)}%</span>
                </div>
                <div class="record-buttons">
                  ${kpisForKR.map(kpi => {
                    const lagsForKPI = state.laggingIndicators.filter(l => l.kpiId === kpi.id);
                    return lagsForKPI.map(lag => {
                      const isOutput = lag.type === 'output';
                      const actionText = isOutput ? 'ì…ë ¥' : '+1';
                      const typeIcon = isOutput ? 'ğŸ’°' : 'ğŸ“';
                      return `
                        <div class="record-btn" onclick="handleRecordClick('${kr.id}', '${kpi.id}', '${lag.id}')">
                          <div class="record-btn-icon">${typeIcon}</div>
                          <div class="record-btn-name">${lag.name}</div>
                          <div class="record-btn-version">${lag.version}ë²„ì „</div>
                          <div class="record-btn-action">${actionText}</div>
                        </div>
                      `;
                    }).join('');
                  }).join('')}
                  ${kpisForKR.length === 0 ? '<div style="color: var(--gray-400); font-size: 13px;">KPIë¥¼ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”</div>' : ''}
                </div>
              </div>
            `;
          }).join('')}

          <!-- ì˜¤ëŠ˜ ê¸°ë¡ ìš”ì•½ -->
          <div class="today-summary">
            <div class="today-summary-title">
              <span>ğŸ“Š</span> ì˜¤ëŠ˜ ê¸°ë¡
            </div>
            <div class="today-summary-list" id="todaySummaryList">
              ${renderTodaySummary()}
            </div>
          </div>
        </div>
      `;
    }

    function renderTodaySummary() {
      if (state.todayLogs.length === 0) {
        return '<div class="today-summary-empty">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      }

      // í›„í–‰ì§€í‘œë³„ ì§‘ê³„ (KPI ë‹¨ìœ„ í¬í•¨)
      const summary = {};
      state.todayLogs.forEach(log => {
        const lag = state.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        const kpi = state.kpis.find(k => k.id === log.kpiId);
        const key = log.laggingIndicatorId;
        if (!summary[key]) {
          summary[key] = {
            name: lag?.name || 'ì—…ë¬´',
            version: lag?.version || '',
            total: 0,
            unit: kpi?.unit || 'ê±´'
          };
        }
        summary[key].total += log.resultValue || 1;
      });

      return Object.values(summary).map(item => {
        // ê¸ˆì•¡ì¸ ê²½ìš° ì²œë‹¨ìœ„ ì½¤ë§ˆ í‘œì‹œ
        const displayValue = (item.unit === 'ì›' || item.unit === 'ë‹¬ëŸ¬')
          ? item.total.toLocaleString()
          : item.total;

        return `
          <div class="today-summary-item">
            <span>${getIconForLag(item.name)}</span>
            <span>${item.name} (${item.version}ë²„ì „): ${displayValue}${item.unit}</span>
          </div>
        `;
      }).join('');
    }

    function getIconForLag(name) {
      if (name.includes('ì „í™”') || name.includes('ìƒë‹´')) return 'ğŸ“';
      if (name.includes('ì´ë©”ì¼')) return 'ğŸ“§';
      if (name.includes('ë¯¸íŒ…') || name.includes('ë°©ë¬¸')) return 'ğŸ¤';
      if (name.includes('ë§¤ì¶œ') || name.includes('ê³„ì•½')) return 'ğŸ’µ';
      if (name.includes('ì…€ëŸ¬') || name.includes('ê°€ì…')) return 'ğŸ‘¤';
      if (name.includes('ê³µê¸‰ì‚¬')) return 'ğŸ­';
      if (name.includes('ì½˜í…ì¸ ')) return 'ğŸ“±';
      if (name.includes('ê´‘ê³ ') || name.includes('ë§ˆì¼€íŒ…')) return 'ğŸ“£';
      if (name.includes('ìˆ˜ì¶œ') || name.includes('ìˆ˜ì…')) return 'ğŸŒ';
      if (name.includes('UX') || name.includes('UI') || name.includes('ê°œì„ ')) return 'ğŸ¨';
      if (name.includes('ë¸Œëœë“œ')) return 'ğŸ·ï¸';
      if (name.includes('í¬í„¸') || name.includes('ì‹œìŠ¤í…œ')) return 'ğŸ’»';
      return 'âœ…';
    }

    // ì‹¤í—˜ ë¶„ì„ ë Œë”ë§
    function renderExperiment() {
      const container = document.getElementById('experimentContent');

      if (state.kpis.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ”¬</div>
            <div class="empty-state-title">KPIë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div>
            <div class="empty-state-desc">KPIì™€ í›„í–‰ì§€í‘œ(A/B ë²„ì „)ë¥¼ ì„¤ì •í•˜ë©´ ì‹¤í—˜ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”¬ A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
          </div>

          <div class="experiment-selector">
            <select class="experiment-select" id="experimentKPISelect" onchange="renderExperimentResults()">
              <option value="">KPI ì„ íƒ</option>
              ${state.kpis.map(kpi => `<option value="${kpi.id}">${kpi.name}</option>`).join('')}
            </select>
          </div>

          <div id="experimentResults"></div>
        </div>
      `;
    }

    function renderExperimentResults() {
      const kpiId = document.getElementById('experimentKPISelect').value;
      const container = document.getElementById('experimentResults');

      if (!kpiId) {
        container.innerHTML = '<div class="empty-state-desc">KPIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>';
        return;
      }

      const kpi = state.kpis.find(k => k.id === kpiId);
      const lagsForKPI = state.laggingIndicators.filter(l => l.kpiId === kpiId);

      if (lagsForKPI.length === 0) {
        container.innerHTML = '<div class="empty-state-desc">í›„í–‰ì§€í‘œ(ë²„ì „)ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      // ë²„ì „ë³„ ì„±ê³¼ ì§‘ê³„
      const results = lagsForKPI.map(lag => {
        const logs = state.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
        const totalValue = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
        const logCount = logs.length;
        const avgPerLog = logCount > 0 ? (totalValue / logCount) : 0;
        return {
          ...lag,
          totalValue,
          logCount,
          avgPerLog
        };
      }).sort((a, b) => b.totalValue - a.totalValue);

      const maxValue = Math.max(...results.map(r => r.totalValue), 1);
      const ranks = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
      const barColors = ['var(--success)', 'var(--primary)', 'var(--warning)', 'var(--gray-400)'];
      const unit = kpi?.unit || 'ê±´';
      const isMoneyUnit = unit === 'ì›' || unit === 'ë‹¬ëŸ¬';

      container.innerHTML = `
        <div class="experiment-results">
          ${results.map((r, idx) => {
            const displayTotal = isMoneyUnit ? r.totalValue.toLocaleString() : r.totalValue;
            const displayAvg = isMoneyUnit ? Math.round(r.avgPerLog).toLocaleString() : r.avgPerLog.toFixed(2);
            return `
              <div class="experiment-item">
                <div class="experiment-rank">${ranks[idx] || 'ğŸ“Š'}</div>
                <div class="experiment-info">
                  <div class="experiment-name">${r.version}ë²„ì „: ${r.name}</div>
                  <div class="experiment-stats">ì—…ë¬´ ${r.logCount}ê±´ | í‰ê·  ${displayAvg}${unit}/ê±´</div>
                </div>
                <div class="experiment-bar">
                  <div class="experiment-bar-fill" style="width: ${(r.totalValue / maxValue) * 100}%; background: ${barColors[idx]}">
                    ${displayTotal}${unit}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        ${results.length > 1 ? `
          <div style="margin-top: 20px; padding: 16px; background: var(--success-light); border-radius: 8px;">
            <div style="font-size: 14px; font-weight: 700; color: var(--success); margin-bottom: 8px;">ğŸ’¡ ì¸ì‚¬ì´íŠ¸</div>
            <div style="font-size: 13px; color: var(--gray-700);">
              ${results[0].version}ë²„ì „ (${results[0].name})ì´ ê°€ì¥ íš¨ê³¼ì ì…ë‹ˆë‹¤.
              í‰ê·  ${isMoneyUnit ? Math.round(results[0].avgPerLog).toLocaleString() : results[0].avgPerLog.toFixed(2)}${unit}/ê±´ìœ¼ë¡œ ${results.length > 1 ? results[1].version + 'ë²„ì „ ëŒ€ë¹„ ' + ((results[0].avgPerLog / (results[1].avgPerLog || 1) - 1) * 100).toFixed(0) + '% ë†’ìŠµë‹ˆë‹¤.' : ''}
            </div>
          </div>
        ` : ''}
      `;
    }

    // ========================================
    // ê³„ì‚° í•¨ìˆ˜
    // ========================================
    function calculateObjectiveRate() {
      if (state.keyResults.length === 0) return 0;
      const rates = state.keyResults.map(kr => calculateKRRate(kr.id));
      const avg = rates.reduce((sum, r) => sum + r, 0) / rates.length;
      return Math.round(avg);
    }

    function calculateKRRate(krId) {
      const kpisForKR = state.kpis.filter(k => k.keyResultId === krId);
      if (kpisForKR.length === 0) return 0;

      const rates = kpisForKR.map(kpi => calculateKPIRate(kpi.id));
      const avg = rates.reduce((sum, r) => sum + r, 0) / rates.length;
      return Math.round(avg);
    }

    function calculateKPIRate(kpiId) {
      const kpi = state.kpis.find(k => k.id === kpiId);
      if (!kpi || !kpi.targetValue) return 0;

      const lagsForKPI = state.laggingIndicators.filter(l => l.kpiId === kpiId);
      const totalValue = lagsForKPI.reduce((sum, lag) => {
        const logs = state.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
        return sum + logs.reduce((s, l) => s + (l.resultValue || 0), 0);
      }, 0);

      return Math.min(Math.round((totalValue / kpi.targetValue) * 100), 100);
    }

    function calculateAvgDailyProgress(krId) {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const weekLogs = state.dailyLogs.filter(log =>
        log.krId === krId && log.date >= sevenDaysAgo.toISOString().split('T')[0]
      );

      if (weekLogs.length === 0) return 0;
      return 1;
    }

    // ========================================
    // ì—…ë¬´ ê¸°ë¡
    // ========================================

    // Input/Output Metrics íƒ€ì…ì— ë”°ë¼ ì…ë ¥ ëª¨ë‹¬ ë˜ëŠ” ë°”ë¡œ ê¸°ë¡
    function handleRecordClick(krId, kpiId, lagId) {
      const lag = state.laggingIndicators.find(l => l.id === lagId);

      // Output Metric (ì„±ê³¼ì§€í‘œ): ê¸ˆì•¡ ì…ë ¥ ëª¨ë‹¬
      if (lag && lag.type === 'output') {
        openRecordModal(krId, kpiId, lagId);
      } else {
        // Input Metric (í™œë™ì§€í‘œ): +1 ì¹´ìš´íŠ¸
        recordWork(krId, kpiId, lagId, 1);
      }
    }

    // Output Metric (ì„±ê³¼ì§€í‘œ) ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
    function openRecordModal(krId, kpiId, lagId) {
      const kpi = state.kpis.find(k => k.id === kpiId);
      const lag = state.laggingIndicators.find(l => l.id === lagId);

      const modal = document.getElementById('modal');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <div class="modal-title">ğŸ’° Output Metric ê¸°ë¡</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">${kpi?.name || 'KPI'} - ${lag?.name || ''} (${lag?.version || ''}ë²„ì „)</label>
              <input type="number" class="form-input" id="recordValue"
                placeholder="ê¸ˆì•¡ ë˜ëŠ” ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”" autofocus
                style="font-size: 18px; padding: 12px;">
              <div style="margin-top: 8px; font-size: 13px; color: var(--gray-500);">
                ë‹¨ìœ„: ${kpi?.unit || ''}
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveRecord('${krId}', '${kpiId}', '${lagId}')">ì €ì¥</button>
          </div>
        </div>
      `;

      // Enter í‚¤ë¡œ ì €ì¥
      setTimeout(() => {
        const input = document.getElementById('recordValue');
        input.focus();
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            saveRecord(krId, kpiId, lagId);
          }
        });
      }, 100);
    }

    // ëª¨ë‹¬ì—ì„œ ì…ë ¥ë°›ì€ ê°’ìœ¼ë¡œ ê¸°ë¡
    async function saveRecord(krId, kpiId, lagId) {
      const value = parseFloat(document.getElementById('recordValue').value);

      if (!value || value <= 0) {
        showToast('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      closeModal();
      await recordWork(krId, kpiId, lagId, value);
    }

    async function recordWork(krId, kpiId, lagId, resultValue) {
      try {
        const log = {
          date: today,
          memberId: state.currentUser?.uid || 'anonymous',
          memberName: state.currentUser?.displayName || 'ì‚¬ìš©ì',
          krId,
          kpiId,
          laggingIndicatorId: lagId,
          resultValue: resultValue,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('okr_dailyLogs').add(log);

        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        state.dailyLogs.unshift({ ...log, id: 'temp-' + Date.now() });
        state.todayLogs = state.dailyLogs.filter(l => l.date === today);

        // UI ì—…ë°ì´íŠ¸
        renderAll();

        showToast('ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (e) {
        console.error('ê¸°ë¡ ì˜¤ë¥˜:', e);
        showToast('ê¸°ë¡ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // ëª¨ë‹¬
    // ========================================
    function openObjectiveModal() {
      const obj = state.objective;
      const modal = document.getElementById('modal');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">ğŸ¯ ìµœì¢… ëª©í‘œ ${obj ? 'ìˆ˜ì •' : 'ì„¤ì •'}</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">ëª©í‘œëª… *</label>
              <input type="text" class="form-input" id="objName" value="${obj?.name || ''}"
                placeholder="ì˜ˆ: 26ë…„ë„ PMF + ì—° 10ì–µ ë‹¬ì„±">
            </div>
            <div class="form-group">
              <label class="form-label">ì‹œì‘ì¼</label>
              <input type="date" class="form-input" id="objStartDate" value="${obj?.startDate || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">ì¢…ë£Œì¼</label>
              <input type="date" class="form-input" id="objEndDate" value="${obj?.endDate || ''}">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveObjective()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveObjective() {
      const name = document.getElementById('objName').value.trim();
      if (!name) {
        showToast('ëª©í‘œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const data = {
        name,
        startDate: document.getElementById('objStartDate').value,
        endDate: document.getElementById('objEndDate').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (state.objective) {
          await db.collection('okr_objective').doc(state.objective.id).update(data);
        } else {
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection('okr_objective').add(data);
          state.objective = { id: docRef.id, ...data };
        }

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    function openKRModal(krId = null) {
      const kr = krId ? state.keyResults.find(k => k.id === krId) : null;
      const modal = document.getElementById('modal');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">ğŸ“ˆ ë©”ì¸ KPI ${kr ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">ë©”ì¸ KPIëª… *</label>
              <input type="text" class="form-input" id="krName" value="${kr?.name || ''}"
                placeholder="ì˜ˆ: ì—°ë§¤ì¶œ 10ì–µ ë‹¬ì„±">
            </div>
            <div class="form-group">
              <label class="form-label">ëª©í‘œê°’</label>
              <input type="number" class="form-input" id="krTargetValue" value="${kr?.targetValue || ''}"
                placeholder="ì˜ˆ: 1000000000">
            </div>
            <div class="form-group">
              <label class="form-label">ë‹¨ìœ„</label>
              <input type="text" class="form-input" id="krUnit" value="${kr?.unit || ''}"
                placeholder="ì˜ˆ: ì›, ëª…, %">
            </div>
          </div>
          <div class="modal-footer">
            ${kr ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteKR('${kr.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveKR('${krId || ''}')">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveKR(krId) {
      const name = document.getElementById('krName').value.trim();
      if (!name) {
        showToast('ë©”ì¸ KPIëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const data = {
        objectiveId: state.objective.id,
        name,
        targetValue: parseFloat(document.getElementById('krTargetValue').value) || 0,
        unit: document.getElementById('krUnit').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (krId) {
          await db.collection('okr_keyResults').doc(krId).update(data);
        } else {
          data.order = state.keyResults.length + 1;
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('okr_keyResults').add(data);
        }

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteKR(krId) {
      if (!confirm('ì´ KRì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ê²°ëœ KPIì™€ í›„í–‰ì§€í‘œë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

      try {
        // ì—°ê²°ëœ KPI ì‚­ì œ
        const kpis = state.kpis.filter(k => k.keyResultId === krId);
        for (const kpi of kpis) {
          // ì—°ê²°ëœ í›„í–‰ì§€í‘œ ì‚­ì œ
          const lags = state.laggingIndicators.filter(l => l.kpiId === kpi.id);
          for (const lag of lags) {
            await db.collection('okr_laggingIndicators').doc(lag.id).delete();
          }
          await db.collection('okr_kpis').doc(kpi.id).delete();
        }

        await db.collection('okr_keyResults').doc(krId).delete();

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    function openKPIModal(krId, kpiId = null) {
      const kpi = kpiId ? state.kpis.find(k => k.id === kpiId) : null;
      const lagsForKPI = kpi ? state.laggingIndicators.filter(l => l.kpiId === kpi.id) : [];

      const modal = document.getElementById('modal');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <div class="modal-title">ğŸ“Š ì„œë¸Œ KPI ${kpi ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">ì„œë¸Œ KPIëª… *</label>
              <input type="text" class="form-input" id="kpiName" value="${kpi?.name || ''}"
                placeholder="ì˜ˆ: êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ">
            </div>
            <div class="form-group">
              <label class="form-label">ëª©í‘œê°’ *</label>
              <input type="number" class="form-input" id="kpiTargetValue" value="${kpi?.targetValue || ''}"
                placeholder="ì˜ˆ: 800000000">
            </div>
            <div class="form-group">
              <label class="form-label">ë‹¨ìœ„</label>
              <input type="text" class="form-input" id="kpiUnit" value="${kpi?.unit || ''}"
                placeholder="ì˜ˆ: ì›, ëª…, ê±´">
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--gray-200);">

            <div class="form-group">
              <label class="form-label">Input/Output Metrics</label>
              <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">
                â€¢ Output (ì„±ê³¼ì§€í‘œ): í™œë™ì˜ ê²°ê³¼ â†’ ê¸ˆì•¡ ì…ë ¥ (ì˜ˆ: ì •ì‚°ì™„ë£Œ, ê³„ì•½ ì„±ì‚¬)<br>
                â€¢ Input (í™œë™ì§€í‘œ): í†µì œ ê°€ëŠ¥í•œ í–‰ë™ â†’ ê±´ìˆ˜ ì¹´ìš´íŠ¸ (ì˜ˆ: ì œì•ˆ, ë¯¸íŒ…, ì…ì )
              </div>
              <div id="lagList">
                ${lagsForKPI.map((lag, idx) => `
                  <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" class="form-input lag-version" value="${lag.version}" style="width: 60px;" placeholder="A">
                    <input type="text" class="form-input lag-name" value="${lag.name}" style="flex: 1;" placeholder="ì •ì‚°ì™„ë£Œ">
                    <select class="form-input lag-type" style="width: 120px;">
                      <option value="output" ${lag.type === 'output' ? 'selected' : ''}>ì„±ê³¼(ê¸ˆì•¡)</option>
                      <option value="input" ${lag.type === 'input' ? 'selected' : ''}>í™œë™(ê±´ìˆ˜)</option>
                    </select>
                    <button class="btn btn-secondary" onclick="this.parentElement.remove()">Ã—</button>
                  </div>
                `).join('')}
              </div>
              <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addLagInput()">+ Metric ì¶”ê°€</button>
            </div>
          </div>
          <div class="modal-footer">
            ${kpi ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteKPI('${kpi.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveKPI('${krId}', '${kpiId || ''}')">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    function addLagInput() {
      const lagList = document.getElementById('lagList');
      const div = document.createElement('div');
      div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
      div.innerHTML = `
        <input type="text" class="form-input lag-version" style="width: 60px;" placeholder="A">
        <input type="text" class="form-input lag-name" style="flex: 1;" placeholder="ì •ì‚°ì™„ë£Œ">
        <select class="form-input lag-type" style="width: 120px;">
          <option value="output">ì„±ê³¼(ê¸ˆì•¡)</option>
          <option value="input">í™œë™(ê±´ìˆ˜)</option>
        </select>
        <button class="btn btn-secondary" onclick="this.parentElement.remove()">Ã—</button>
      `;
      lagList.appendChild(div);
    }

    async function saveKPI(krId, kpiId) {
      const name = document.getElementById('kpiName').value.trim();
      const targetValue = parseFloat(document.getElementById('kpiTargetValue').value);

      if (!name) {
        showToast('ì„œë¸Œ KPIëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      if (!targetValue) {
        showToast('ëª©í‘œê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const data = {
        keyResultId: krId,
        name,
        targetValue,
        unit: document.getElementById('kpiUnit').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        let savedKpiId = kpiId;

        if (kpiId) {
          await db.collection('okr_kpis').doc(kpiId).update(data);
        } else {
          data.order = state.kpis.filter(k => k.keyResultId === krId).length + 1;
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection('okr_kpis').add(data);
          savedKpiId = docRef.id;
        }

        // Input/Output Metrics ì €ì¥
        const versions = document.querySelectorAll('.lag-version');
        const names = document.querySelectorAll('.lag-name');
        const types = document.querySelectorAll('.lag-type');

        // ê¸°ì¡´ metrics ì‚­ì œ
        const existingLags = state.laggingIndicators.filter(l => l.kpiId === savedKpiId);
        for (const lag of existingLags) {
          await db.collection('okr_laggingIndicators').doc(lag.id).delete();
        }

        // ìƒˆ metrics ì¶”ê°€
        for (let i = 0; i < versions.length; i++) {
          const version = versions[i].value.trim();
          const lagName = names[i].value.trim();
          const type = types[i].value;
          if (version && lagName) {
            await db.collection('okr_laggingIndicators').add({
              kpiId: savedKpiId,
              version,
              name: lagName,
              type: type,  // 'input' ë˜ëŠ” 'output'
              totalValue: 0,
              logCount: 0,
              isActive: true,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteKPI(kpiId) {
      if (!confirm('ì´ KPIë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        // ì—°ê²°ëœ í›„í–‰ì§€í‘œ ì‚­ì œ
        const lags = state.laggingIndicators.filter(l => l.kpiId === kpiId);
        for (const lag of lags) {
          await db.collection('okr_laggingIndicators').doc(lag.id).delete();
        }

        await db.collection('okr_kpis').doc(kpiId).delete();

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    function closeModal() {
      document.getElementById('modal').className = 'modal';
    }

    // ========================================
    // ìœ í‹¸ë¦¬í‹°
    // ========================================
    function switchView(viewName) {
      // ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewName);
      });

      // ë·° ì»¨í…ì¸  ì—…ë°ì´íŠ¸
      document.querySelectorAll('.view-content').forEach(content => {
        content.classList.toggle('active', content.id === `view-${viewName}`);
      });

      // ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ë‹«ê¸°
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('show');
    }

    function toggleGuide() {
      const content = document.getElementById('guideContent');
      const toggle = document.getElementById('guideToggle');

      if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggle.textContent = 'â–¼';
      } else {
        content.classList.add('show');
        toggle.textContent = 'â–²';
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // CSS ì¶”ê°€: ë·° ì»¨í…ì¸  ê¸°ë³¸ ìˆ¨ê¹€
    document.head.insertAdjacentHTML('beforeend', `
      <style>
        .view-content { display: none; }
        .view-content.active { display: block; }
      </style>
    `);

    // URL í•´ì‹œ ì²˜ë¦¬ (ì „ëµì„¼í„°ì—ì„œ ì„œë¸Œë©”ë‰´ í´ë¦­ ì‹œ)
    function handleUrlHash() {
      const hash = window.location.hash.replace('#', '');
      if (hash && ['dashboard', 'record', 'settings', 'experiment'].includes(hash)) {
        switchView(hash);
      }
    }

    // í•´ì‹œ ë³€ê²½ ê°ì§€
    window.addEventListener('hashchange', handleUrlHash);

    // ì´ˆê¸°í™”
    init();

    // í˜ì´ì§€ ë¡œë“œ í›„ í•´ì‹œ ì²˜ë¦¬
    setTimeout(handleUrlHash, 100);
  </script>
</body>
</html>

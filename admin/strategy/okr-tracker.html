<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OKR íŠ¸ë˜ì»¤ - ì „ëµì„¼í„°</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #6366F1;
      --primary-light: #E0E7FF;
      --success: #10B981;
      --success-light: #D1FAE5;
      --warning: #F59E0B;
      --warning-light: #FEF3C7;
      --danger: #EF4444;
      --danger-light: #FEE2E2;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --white: #FFFFFF;
      --kr1-color: #8B5CF6;
      --kr2-color: #06B6D4;
      --kr3-color: #10B981;
      --kr4-color: #F59E0B;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50);
      color: var(--gray-800);
      min-height: 100vh;
    }

    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, var(--primary), #8B5CF6);
      color: white;
      padding: 20px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-subtitle {
      font-size: 13px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-white {
      background: white;
      color: var(--primary);
    }

    .btn-white:hover {
      background: var(--gray-100);
    }

    /* ê°€ì´ë“œ ì¹´ë“œ */
    .guide-card {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 24px;
    }

    .guide-card-inner {
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      border: 1px solid #F59E0B;
      border-radius: 12px;
      overflow: hidden;
    }

    .guide-header {
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .guide-header:hover {
      background: rgba(245, 158, 11, 0.1);
    }

    .guide-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .guide-toggle {
      font-size: 12px;
      color: var(--gray-600);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .guide-content {
      display: none;
      padding: 0 20px 20px 20px;
      border-top: 1px solid rgba(245, 158, 11, 0.3);
    }

    .guide-content.show {
      display: block;
    }

    .guide-section {
      margin-top: 16px;
    }

    .guide-section-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .guide-section p {
      font-size: 13px;
      color: var(--gray-600);
      line-height: 1.6;
    }

    .guide-steps {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .guide-step {
      background: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .guide-step-num {
      width: 20px;
      height: 20px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
    }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .tab-nav-inner {
      display: flex;
      gap: 4px;
      background: var(--gray-100);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: var(--gray-500);
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn:hover {
      color: var(--gray-700);
    }

    .tab-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* ë©”ì¸ ì»¨í…ì¸  */
    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px 40px 24px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* O ë‹¬ì„±ë¥  ê²Œì´ì§€ */
    .objective-card {
      background: linear-gradient(135deg, var(--primary), #8B5CF6);
      color: white;
    }

    .objective-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .objective-period {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .objective-rate {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: white;
      border-radius: 6px;
      transition: width 0.5s ease;
    }

    /* KR ì¹´ë“œ */
    .kr-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .kr-item {
      padding: 16px;
      border-radius: 12px;
      background: var(--gray-50);
    }

    .kr-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .kr-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .kr-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .kr-progress {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
    }

    .kr-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* ì—…ë¬´ ê¸°ë¡ */
    .record-section {
      margin-bottom: 24px;
    }

    .record-section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .record-section-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .record-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .record-btn {
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 120px;
    }

    .record-btn:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    }

    .record-btn-icon {
      font-size: 28px;
    }

    .record-btn-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .record-btn-version {
      font-size: 11px;
      color: var(--gray-500);
    }

    .record-btn-action {
      background: var(--primary);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      margin-top: 4px;
    }

    .record-btn.amount-input {
      position: relative;
    }

    .amount-input-field {
      width: 80px;
      padding: 6px 10px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      margin-top: 4px;
    }

    /* ì˜¤ëŠ˜ ê¸°ë¡ ìš”ì•½ */
    .today-summary {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 20px;
      margin-top: 24px;
    }

    .today-summary-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-700);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .today-summary-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .today-summary-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--gray-600);
    }

    .today-summary-empty {
      color: var(--gray-400);
      font-size: 13px;
    }

    /* íŒŒì´í”„ë¼ì¸ */
    .pipeline-card {
      margin-top: 20px;
    }

    .pipeline-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .pipeline-arrow {
      color: var(--gray-400);
    }

    .pipeline-value {
      font-weight: 600;
      color: var(--success);
    }

    /* ëª©í‘œ ì„¤ì • */
    .objective-setting {
      background: linear-gradient(135deg, var(--primary-light), #DDD6FE);
      border: 2px solid var(--primary);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .objective-setting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .objective-setting-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .kr-setting-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .kr-setting-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid var(--primary);
    }

    .kr-setting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .kr-setting-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .kpi-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-left: 16px;
    }

    .kpi-item {
      padding: 12px 16px;
      background: var(--gray-50);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .kpi-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .kpi-target {
      font-size: 13px;
      color: var(--gray-500);
    }

    /* ì‹¤í—˜ ë¶„ì„ */
    .experiment-selector {
      margin-bottom: 24px;
    }

    .experiment-select {
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
      min-width: 250px;
      cursor: pointer;
    }

    .experiment-results {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .experiment-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .experiment-rank {
      font-size: 32px;
    }

    .experiment-info {
      flex: 1;
    }

    .experiment-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 4px;
    }

    .experiment-stats {
      font-size: 13px;
      color: var(--gray-500);
    }

    .experiment-bar {
      flex: 2;
    }

    .experiment-bar-fill {
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      padding-left: 12px;
      color: white;
      font-size: 13px;
      font-weight: 600;
    }

    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-500);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-800);
      color: white;
      padding: 14px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 18px;
      }

      .tab-btn {
        padding: 10px 12px;
        font-size: 12px;
      }

      .record-btn {
        min-width: 100px;
        padding: 12px 14px;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header">
    <div class="header-content">
      <div>
        <h1>ğŸ“Š OKR íŠ¸ë˜ì»¤</h1>
        <div class="header-subtitle">ì—…ë¬´ì¼ì§€ â†’ ëª©í‘œ ë‹¬ì„±ë¥  ìë™ ê³„ì‚°</div>
      </div>
      <div class="header-actions">
        <button class="btn btn-white" onclick="location.href='index.html'">â† ì „ëµì„¼í„°</button>
      </div>
    </div>
  </header>

  <!-- ê°€ì´ë“œ ì¹´ë“œ -->
  <div class="guide-card">
    <div class="guide-card-inner">
      <div class="guide-header" onclick="toggleGuide()">
        <div class="guide-title">
          <span>ğŸ’¡</span>
          <span>OKR íŠ¸ë˜ì»¤ ì‚¬ìš©ë²•</span>
        </div>
        <div class="guide-toggle">
          <span id="guideToggleText">í¼ì¹˜ê¸°</span>
          <span id="guideToggleIcon">â–¼</span>
        </div>
      </div>
      <div class="guide-content" id="guideContent">
        <div class="guide-section">
          <div class="guide-section-title">ğŸ¯ ì´ ë„êµ¬ì˜ ëª©ì </div>
          <p>"ì—…ë¬´ì¼ì§€ë¥¼ ì“°ëŠ” ìˆœê°„, ëª©í‘œ ë‹¬ì„±ë¥ ì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤"</p>
        </div>
        <div class="guide-section">
          <div class="guide-section-title">ğŸ“ êµ¬ì¡°</div>
          <p>O (ëª©í‘œ) â†’ KR (í•µì‹¬ê²°ê³¼ 4ê°œ) â†’ KPI â†’ í›„í–‰ì§€í‘œ (A/B í…ŒìŠ¤íŠ¸)</p>
        </div>
        <div class="guide-section">
          <div class="guide-section-title">âœ… ì‚¬ìš© ë°©ë²•</div>
          <div class="guide-steps">
            <div class="guide-step"><span class="guide-step-num">1</span> [ëª©í‘œ ì„¤ì •] íƒ­ì—ì„œ O, KR, KPI ì„¤ì •</div>
            <div class="guide-step"><span class="guide-step-num">2</span> [ì—…ë¬´ ê¸°ë¡] íƒ­ì—ì„œ ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ê¸°ë¡</div>
            <div class="guide-step"><span class="guide-step-num">3</span> [ëŒ€ì‹œë³´ë“œ]ì—ì„œ ë‹¬ì„±ë¥  ìë™ í™•ì¸</div>
            <div class="guide-step"><span class="guide-step-num">4</span> [ì‹¤í—˜ ë¶„ì„]ì—ì„œ íš¨ê³¼ì ì¸ ë°©ë²• ë¹„êµ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="tab-nav">
    <div class="tab-nav-inner">
      <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
        <span>ğŸ“ˆ</span> ëŒ€ì‹œë³´ë“œ
      </button>
      <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">
        <span>ğŸ¯</span> ëª©í‘œ ì„¤ì •
      </button>
      <button class="tab-btn" data-tab="record" onclick="switchTab('record')">
        <span>ğŸ“</span> ì—…ë¬´ ê¸°ë¡
      </button>
      <button class="tab-btn" data-tab="experiment" onclick="switchTab('experiment')">
        <span>ğŸ”¬</span> ì‹¤í—˜ ë¶„ì„
      </button>
    </div>
  </nav>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <main class="main-content">
    <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
    <div class="tab-content active" id="tab-dashboard">
      <div id="dashboardContent"></div>
    </div>

    <!-- ëª©í‘œ ì„¤ì • íƒ­ -->
    <div class="tab-content" id="tab-settings">
      <div id="settingsContent"></div>
    </div>

    <!-- ì—…ë¬´ ê¸°ë¡ íƒ­ -->
    <div class="tab-content" id="tab-record">
      <div id="recordContent"></div>
    </div>

    <!-- ì‹¤í—˜ ë¶„ì„ íƒ­ -->
    <div class="tab-content" id="tab-experiment">
      <div id="experimentContent"></div>
    </div>
  </main>

  <!-- ëª¨ë‹¬ -->
  <div class="modal" id="modal"></div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div class="toast" id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAdJmDb-KRWS2HfexUKwZEbSqFkjjNXQ8U",
      authDomain: "netformrnd.firebaseapp.com",
      databaseURL: "https://netformrnd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "netformrnd",
      storageBucket: "netformrnd.appspot.com",
      messagingSenderId: "200888013867",
      appId: "1:200888013867:web:0764424b04160a98ec7410",
      measurementId: "G-BCQKM0GFG6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ìƒíƒœ
    let state = {
      objective: null,
      keyResults: [],
      kpis: [],
      leadingIndicators: [],
      laggingIndicators: [],
      dailyLogs: [],
      todayLogs: [],
      currentUser: null
    };

    // ì˜¤ëŠ˜ ë‚ ì§œ
    const today = new Date().toISOString().split('T')[0];

    // ========================================
    // ì´ˆê¸°í™”
    // ========================================
    async function init() {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          state.currentUser = user;
          await loadAllData();
          renderAll();
        } else {
          // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ë˜ëŠ” ìµëª… ì‚¬ìš©
          await loadAllData();
          renderAll();
        }
      });
    }

    async function loadAllData() {
      try {
        // O (ëª©í‘œ)
        const objSnapshot = await db.collection('okr_objective').limit(1).get();
        state.objective = objSnapshot.docs.length > 0
          ? { id: objSnapshot.docs[0].id, ...objSnapshot.docs[0].data() }
          : null;

        // KR
        const krSnapshot = await db.collection('okr_keyResults').orderBy('order').get();
        state.keyResults = krSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // KPI
        const kpiSnapshot = await db.collection('okr_kpis').orderBy('order').get();
        state.kpis = kpiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì„ í–‰ì§€í‘œ
        const leadSnapshot = await db.collection('okr_leadingIndicators').get();
        state.leadingIndicators = leadSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // í›„í–‰ì§€í‘œ
        const lagSnapshot = await db.collection('okr_laggingIndicators').get();
        state.laggingIndicators = lagSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì—…ë¬´ì¼ì§€ (ìµœê·¼ 30ì¼)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const logSnapshot = await db.collection('okr_dailyLogs')
          .where('date', '>=', thirtyDaysAgo.toISOString().split('T')[0])
          .orderBy('date', 'desc')
          .get();
        state.dailyLogs = logSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì˜¤ëŠ˜ ë¡œê·¸
        state.todayLogs = state.dailyLogs.filter(log => log.date === today);

      } catch (e) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }

    // ========================================
    // ë Œë”ë§
    // ========================================
    function renderAll() {
      renderDashboard();
      renderSettings();
      renderRecord();
      renderExperiment();
    }

    // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    function renderDashboard() {
      const container = document.getElementById('dashboardContent');

      if (!state.objective) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¯</div>
            <div class="empty-state-title">ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
            <div class="empty-state-desc">[ëª©í‘œ ì„¤ì •] íƒ­ì—ì„œ O(ëª©í‘œ)ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div>
            <button class="btn btn-primary" onclick="switchTab('settings')">ëª©í‘œ ì„¤ì •í•˜ê¸°</button>
          </div>
        `;
        return;
      }

      // O ë‹¬ì„±ë¥  ê³„ì‚°
      const oRate = calculateObjectiveRate();

      // KRë³„ ë‹¬ì„±ë¥ 
      const krRates = state.keyResults.map(kr => ({
        ...kr,
        rate: calculateKRRate(kr.id)
      }));

      container.innerHTML = `
        <!-- O ë‹¬ì„±ë¥  -->
        <div class="card objective-card">
          <div class="objective-name">${state.objective.name || 'ëª©í‘œ ë¯¸ì„¤ì •'}</div>
          <div class="objective-period">${state.objective.startDate || ''} ~ ${state.objective.endDate || ''}</div>
          <div class="objective-rate">${oRate}%</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${Math.min(oRate, 100)}%"></div>
          </div>
        </div>

        <div class="dashboard-grid">
          <!-- KR í˜„í™© -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ“ˆ KR í˜„í™©</div>
            </div>
            <div class="kr-list">
              ${krRates.map((kr, idx) => {
                const colors = ['var(--kr1-color)', 'var(--kr2-color)', 'var(--kr3-color)', 'var(--kr4-color)'];
                const icons = ['ğŸ’°', 'ğŸ‘¥', 'ğŸ“±', 'ğŸ“¢'];
                return `
                  <div class="kr-item">
                    <div class="kr-header">
                      <div class="kr-name">
                        <span>${icons[idx] || 'ğŸ“Š'}</span>
                        ${kr.name}
                      </div>
                      <span class="kr-badge" style="background: ${colors[idx]}20; color: ${colors[idx]}">${kr.rate}%</span>
                    </div>
                    <div class="kr-progress">
                      <div class="kr-progress-fill" style="width: ${Math.min(kr.rate, 100)}%; background: ${colors[idx]}"></div>
                    </div>
                  </div>
                `;
              }).join('')}
              ${krRates.length === 0 ? '<div class="empty-state-desc">KRì´ ì—†ìŠµë‹ˆë‹¤</div>' : ''}
            </div>
          </div>

          <!-- ì˜¤ëŠ˜ ê¸°ì—¬ë„ -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ”„ ì˜¤ëŠ˜ ë‚´ ì—…ë¬´ ê¸°ì—¬ë„</div>
            </div>
            ${state.todayLogs.length > 0 ? `
              <div class="pipeline-list">
                ${state.todayLogs.slice(0, 5).map(log => {
                  const lag = state.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
                  const kpi = state.kpis.find(k => k.id === log.kpiId);
                  const kr = state.keyResults.find(k => k.id === log.krId);
                  return `
                    <div class="pipeline-item">
                      <span>${lag?.name || 'ì—…ë¬´'}</span>
                      <span class="pipeline-arrow">â†’</span>
                      <span class="pipeline-value">+${log.resultValue} ${kpi?.unit || 'ê±´'}</span>
                      <span class="pipeline-arrow">â†’</span>
                      <span>${kr?.name || 'KR'}</span>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="empty-state-desc" style="padding: 20px;">ì˜¤ëŠ˜ ê¸°ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            `}
          </div>

          <!-- ëª©í‘œê¹Œì§€ -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ¯ ëª©í‘œê¹Œì§€ ì–¼ë§ˆë‚˜?</div>
            </div>
            ${krRates.filter(kr => kr.rate < 100).slice(0, 3).map(kr => {
              const kpisForKR = state.kpis.filter(k => k.keyResultId === kr.id);
              const avgDaily = calculateAvgDailyProgress(kr.id);
              const remaining = 100 - kr.rate;
              const daysNeeded = avgDaily > 0 ? Math.ceil(remaining / avgDaily) : 'âˆ';
              return `
                <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
                  <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">${kr.name}</div>
                  <div style="font-size: 12px; color: var(--gray-500);">
                    í˜„ì¬ ${kr.rate}% â†’ 100% ë‹¬ì„±ê¹Œì§€ ì•½ ${daysNeeded}ì¼ ì˜ˆìƒ
                  </div>
                </div>
              `;
            }).join('')}
            ${krRates.filter(kr => kr.rate < 100).length === 0 ? '<div class="empty-state-desc">ëª¨ë“  KR ë‹¬ì„±!</div>' : ''}
          </div>

          <!-- ìµœê·¼ 7ì¼ ìš”ì•½ -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ“… ìµœê·¼ 7ì¼ ìš”ì•½</div>
            </div>
            ${renderWeeklySummary()}
          </div>
        </div>
      `;
    }

    function renderWeeklySummary() {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const weekLogs = state.dailyLogs.filter(log => log.date >= sevenDaysAgo.toISOString().split('T')[0]);

      if (weekLogs.length === 0) {
        return '<div class="empty-state-desc" style="padding: 20px;">ìµœê·¼ 7ì¼ê°„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      }

      // KRë³„ ì§‘ê³„
      const krSummary = {};
      weekLogs.forEach(log => {
        if (!krSummary[log.krId]) {
          krSummary[log.krId] = { count: 0, value: 0 };
        }
        krSummary[log.krId].count += 1;
        krSummary[log.krId].value += log.resultValue || 0;
      });

      return Object.keys(krSummary).map(krId => {
        const kr = state.keyResults.find(k => k.id === krId);
        const summary = krSummary[krId];
        return `
          <div style="padding: 8px 0; border-bottom: 1px solid var(--gray-100);">
            <span style="font-size: 13px;">${kr?.name || 'KR'}</span>
            <span style="float: right; font-size: 13px; color: var(--success); font-weight: 600;">
              +${summary.value} (${summary.count}ê±´)
            </span>
          </div>
        `;
      }).join('');
    }

    // ëª©í‘œ ì„¤ì • ë Œë”ë§
    function renderSettings() {
      const container = document.getElementById('settingsContent');

      container.innerHTML = `
        <!-- O ì„¤ì • -->
        <div class="objective-setting">
          <div class="objective-setting-header">
            <div class="objective-setting-title">ğŸ¯ ìµœì¢… ëª©í‘œ (O)</div>
            <button class="btn btn-primary" onclick="openObjectiveModal()">
              ${state.objective ? 'ìˆ˜ì •' : 'ì„¤ì •í•˜ê¸°'}
            </button>
          </div>
          ${state.objective ? `
            <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${state.objective.name}</div>
            <div style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">
              ${state.objective.startDate || ''} ~ ${state.objective.endDate || ''}
            </div>
          ` : `
            <div style="color: var(--gray-500);">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>
          `}
        </div>

        <!-- KR ëª©ë¡ -->
        <div class="card-header" style="margin-bottom: 16px;">
          <div class="card-title">ğŸ“ˆ í•µì‹¬ ê²°ê³¼ (KR)</div>
          <button class="btn btn-primary" onclick="openKRModal()" ${!state.objective ? 'disabled' : ''}>+ KR ì¶”ê°€</button>
        </div>

        <div class="kr-setting-list">
          ${state.keyResults.map((kr, idx) => {
            const colors = ['var(--kr1-color)', 'var(--kr2-color)', 'var(--kr3-color)', 'var(--kr4-color)'];
            const kpisForKR = state.kpis.filter(k => k.keyResultId === kr.id);
            return `
              <div class="kr-setting-item" style="border-left-color: ${colors[idx]}">
                <div class="kr-setting-header">
                  <div class="kr-setting-name">${kr.name}</div>
                  <div>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openKRModal('${kr.id}')">í¸ì§‘</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openKPIModal('${kr.id}')">+ KPI</button>
                  </div>
                </div>
                <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">
                  ëª©í‘œ: ${kr.targetValue || 0} ${kr.unit || ''}
                </div>
                <div class="kpi-list">
                  ${kpisForKR.map(kpi => {
                    const lagsForKPI = state.laggingIndicators.filter(l => l.kpiId === kpi.id);
                    return `
                      <div class="kpi-item">
                        <div>
                          <div class="kpi-name">${kpi.name}</div>
                          <div class="kpi-target">ëª©í‘œ: ${kpi.targetValue || 0} ${kpi.unit || ''}</div>
                          <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px;">
                            í›„í–‰ì§€í‘œ: ${lagsForKPI.map(l => l.version + 'ë²„ì „').join(', ') || 'ì—†ìŒ'}
                          </div>
                        </div>
                        <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" onclick="openKPIModal('${kr.id}', '${kpi.id}')">í¸ì§‘</button>
                      </div>
                    `;
                  }).join('')}
                  ${kpisForKR.length === 0 ? '<div style="color: var(--gray-400); font-size: 13px;">KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>' : ''}
                </div>
              </div>
            `;
          }).join('')}
          ${state.keyResults.length === 0 ? `
            <div class="empty-state">
              <div class="empty-state-desc">KRì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // ì—…ë¬´ ê¸°ë¡ ë Œë”ë§
    function renderRecord() {
      const container = document.getElementById('recordContent');

      if (state.keyResults.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <div class="empty-state-title">ëª©í‘œë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div>
            <div class="empty-state-desc">[ëª©í‘œ ì„¤ì •] íƒ­ì—ì„œ O, KR, KPIë¥¼ ì„¤ì •í•˜ë©´ ì—…ë¬´ ê¸°ë¡ ë²„íŠ¼ì´ ìƒì„±ë©ë‹ˆë‹¤</div>
            <button class="btn btn-primary" onclick="switchTab('settings')">ëª©í‘œ ì„¤ì •í•˜ê¸°</button>
          </div>
        `;
        return;
      }

      const colors = ['var(--kr1-color)', 'var(--kr2-color)', 'var(--kr3-color)', 'var(--kr4-color)'];
      const icons = ['ğŸ’°', 'ğŸ‘¥', 'ğŸ“±', 'ğŸ“¢'];

      container.innerHTML = `
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ ì—…ë¬´ ê¸°ë¡</div>
            <div style="font-size: 14px; color: var(--gray-500);">${today}</div>
          </div>

          ${state.keyResults.map((kr, krIdx) => {
            const kpisForKR = state.kpis.filter(k => k.keyResultId === kr.id);
            return `
              <div class="record-section">
                <div class="record-section-title">
                  <span>${icons[krIdx] || 'ğŸ“Š'}</span>
                  ${kr.name}
                  <span class="record-section-badge" style="background: ${colors[krIdx]}">${calculateKRRate(kr.id)}%</span>
                </div>
                <div class="record-buttons">
                  ${kpisForKR.map(kpi => {
                    const lagsForKPI = state.laggingIndicators.filter(l => l.kpiId === kpi.id);
                    return lagsForKPI.map(lag => `
                      <div class="record-btn" onclick="recordWork('${kr.id}', '${kpi.id}', '${lag.id}')">
                        <div class="record-btn-icon">${getIconForLag(lag.name)}</div>
                        <div class="record-btn-name">${lag.name}</div>
                        <div class="record-btn-version">${lag.version}ë²„ì „</div>
                        <div class="record-btn-action">+1</div>
                      </div>
                    `).join('');
                  }).join('')}
                  ${kpisForKR.length === 0 ? '<div style="color: var(--gray-400); font-size: 13px;">KPIë¥¼ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”</div>' : ''}
                </div>
              </div>
            `;
          }).join('')}

          <!-- ì˜¤ëŠ˜ ê¸°ë¡ ìš”ì•½ -->
          <div class="today-summary">
            <div class="today-summary-title">
              <span>ğŸ“Š</span> ì˜¤ëŠ˜ ê¸°ë¡
            </div>
            <div class="today-summary-list" id="todaySummaryList">
              ${renderTodaySummary()}
            </div>
          </div>
        </div>
      `;
    }

    function renderTodaySummary() {
      if (state.todayLogs.length === 0) {
        return '<div class="today-summary-empty">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      }

      // í›„í–‰ì§€í‘œë³„ ì§‘ê³„
      const summary = {};
      state.todayLogs.forEach(log => {
        const lag = state.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        const key = log.laggingIndicatorId;
        if (!summary[key]) {
          summary[key] = { name: lag?.name || 'ì—…ë¬´', version: lag?.version || '', count: 0 };
        }
        summary[key].count += log.resultValue || 1;
      });

      return Object.values(summary).map(item => `
        <div class="today-summary-item">
          <span>${getIconForLag(item.name)}</span>
          <span>${item.name} (${item.version}ë²„ì „): ${item.count}ê±´</span>
        </div>
      `).join('');
    }

    function getIconForLag(name) {
      if (name.includes('ì „í™”') || name.includes('ìƒë‹´')) return 'ğŸ“';
      if (name.includes('ì´ë©”ì¼')) return 'ğŸ“§';
      if (name.includes('ë¯¸íŒ…') || name.includes('ë°©ë¬¸')) return 'ğŸ¤';
      if (name.includes('ë§¤ì¶œ') || name.includes('ê³„ì•½')) return 'ğŸ’µ';
      if (name.includes('ì…€ëŸ¬') || name.includes('ê°€ì…')) return 'ğŸ‘¤';
      if (name.includes('ê³µê¸‰ì‚¬')) return 'ğŸ­';
      if (name.includes('ì½˜í…ì¸ ')) return 'ğŸ“±';
      if (name.includes('ê´‘ê³ ')) return 'ğŸ“£';
      return 'âœ…';
    }

    // ì‹¤í—˜ ë¶„ì„ ë Œë”ë§
    function renderExperiment() {
      const container = document.getElementById('experimentContent');

      if (state.kpis.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ”¬</div>
            <div class="empty-state-title">KPIë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div>
            <div class="empty-state-desc">KPIì™€ í›„í–‰ì§€í‘œ(A/B ë²„ì „)ë¥¼ ì„¤ì •í•˜ë©´ ì‹¤í—˜ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”¬ ì‹¤í—˜ ë¶„ì„ (A/B í…ŒìŠ¤íŠ¸)</div>
          </div>

          <div class="experiment-selector">
            <select class="experiment-select" id="experimentKPISelect" onchange="renderExperimentResults()">
              <option value="">KPI ì„ íƒ</option>
              ${state.kpis.map(kpi => `<option value="${kpi.id}">${kpi.name}</option>`).join('')}
            </select>
          </div>

          <div id="experimentResults"></div>
        </div>
      `;
    }

    function renderExperimentResults() {
      const kpiId = document.getElementById('experimentKPISelect').value;
      const container = document.getElementById('experimentResults');

      if (!kpiId) {
        container.innerHTML = '<div class="empty-state-desc">KPIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>';
        return;
      }

      const lagsForKPI = state.laggingIndicators.filter(l => l.kpiId === kpiId);

      if (lagsForKPI.length === 0) {
        container.innerHTML = '<div class="empty-state-desc">í›„í–‰ì§€í‘œ(ë²„ì „)ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      // ë²„ì „ë³„ ì„±ê³¼ ì§‘ê³„
      const results = lagsForKPI.map(lag => {
        const logs = state.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
        const totalValue = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
        const logCount = logs.length;
        const avgPerLog = logCount > 0 ? (totalValue / logCount).toFixed(2) : 0;
        return {
          ...lag,
          totalValue,
          logCount,
          avgPerLog
        };
      }).sort((a, b) => b.totalValue - a.totalValue);

      const maxValue = Math.max(...results.map(r => r.totalValue), 1);
      const ranks = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
      const barColors = ['var(--success)', 'var(--primary)', 'var(--warning)', 'var(--gray-400)'];

      container.innerHTML = `
        <div class="experiment-results">
          ${results.map((r, idx) => `
            <div class="experiment-item">
              <div class="experiment-rank">${ranks[idx] || 'ğŸ“Š'}</div>
              <div class="experiment-info">
                <div class="experiment-name">${r.version}ë²„ì „: ${r.name}</div>
                <div class="experiment-stats">ì—…ë¬´ ${r.logCount}ê±´ | í‰ê·  ${r.avgPerLog}/ê±´</div>
              </div>
              <div class="experiment-bar">
                <div class="experiment-bar-fill" style="width: ${(r.totalValue / maxValue) * 100}%; background: ${barColors[idx]}">
                  ${r.totalValue}
                </div>
              </div>
            </div>
          `).join('')}
        </div>

        ${results.length > 1 ? `
          <div style="margin-top: 20px; padding: 16px; background: var(--success-light); border-radius: 8px;">
            <div style="font-size: 14px; font-weight: 700; color: var(--success); margin-bottom: 8px;">ğŸ’¡ ì¸ì‚¬ì´íŠ¸</div>
            <div style="font-size: 13px; color: var(--gray-700);">
              ${results[0].version}ë²„ì „ (${results[0].name})ì´ ê°€ì¥ íš¨ê³¼ì ì…ë‹ˆë‹¤.
              í‰ê·  ${results[0].avgPerLog}/ê±´ìœ¼ë¡œ ${results.length > 1 ? results[1].version + 'ë²„ì „ ëŒ€ë¹„ ' + ((results[0].avgPerLog / (results[1].avgPerLog || 1) - 1) * 100).toFixed(0) + '% ë†’ìŠµë‹ˆë‹¤.' : ''}
            </div>
          </div>
        ` : ''}
      `;
    }

    // ========================================
    // ê³„ì‚° í•¨ìˆ˜
    // ========================================
    function calculateObjectiveRate() {
      if (state.keyResults.length === 0) return 0;
      const rates = state.keyResults.map(kr => calculateKRRate(kr.id));
      const avg = rates.reduce((sum, r) => sum + r, 0) / rates.length;
      return Math.round(avg);
    }

    function calculateKRRate(krId) {
      const kpisForKR = state.kpis.filter(k => k.keyResultId === krId);
      if (kpisForKR.length === 0) return 0;

      const rates = kpisForKR.map(kpi => calculateKPIRate(kpi.id));
      const avg = rates.reduce((sum, r) => sum + r, 0) / rates.length;
      return Math.round(avg);
    }

    function calculateKPIRate(kpiId) {
      const kpi = state.kpis.find(k => k.id === kpiId);
      if (!kpi || !kpi.targetValue) return 0;

      const lagsForKPI = state.laggingIndicators.filter(l => l.kpiId === kpiId);
      const totalValue = lagsForKPI.reduce((sum, lag) => {
        const logs = state.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
        return sum + logs.reduce((s, l) => s + (l.resultValue || 0), 0);
      }, 0);

      return Math.min(Math.round((totalValue / kpi.targetValue) * 100), 100);
    }

    function calculateAvgDailyProgress(krId) {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const weekLogs = state.dailyLogs.filter(log =>
        log.krId === krId && log.date >= sevenDaysAgo.toISOString().split('T')[0]
      );

      if (weekLogs.length === 0) return 0;

      // ê°„ë‹¨í•˜ê²Œ ì¼í‰ê·  ì§„í–‰ë¥  ì¶”ì •
      return 1; // ì¶”í›„ ì •êµí™”
    }

    // ========================================
    // ì—…ë¬´ ê¸°ë¡
    // ========================================
    async function recordWork(krId, kpiId, lagId) {
      try {
        const log = {
          date: today,
          memberId: state.currentUser?.uid || 'anonymous',
          memberName: state.currentUser?.displayName || 'ì‚¬ìš©ì',
          krId,
          kpiId,
          laggingIndicatorId: lagId,
          resultValue: 1,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('okr_dailyLogs').add(log);

        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        state.dailyLogs.unshift({ ...log, id: 'temp-' + Date.now() });
        state.todayLogs = state.dailyLogs.filter(l => l.date === today);

        // UI ì—…ë°ì´íŠ¸
        renderAll();

        showToast('ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…');
      } catch (e) {
        console.error('ê¸°ë¡ ì˜¤ë¥˜:', e);
        showToast('ê¸°ë¡ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // ëª¨ë‹¬
    // ========================================
    function openObjectiveModal() {
      const obj = state.objective;
      const modal = document.getElementById('modal');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">ğŸ¯ ìµœì¢… ëª©í‘œ (O) ${obj ? 'ìˆ˜ì •' : 'ì„¤ì •'}</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">ëª©í‘œëª… *</label>
              <input type="text" class="form-input" id="objName" value="${obj?.name || ''}"
                placeholder="ì˜ˆ: 26ë…„ë„ PMF + ì—° 10ì–µ ë‹¬ì„±">
            </div>
            <div class="form-group">
              <label class="form-label">ì‹œì‘ì¼</label>
              <input type="date" class="form-input" id="objStartDate" value="${obj?.startDate || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">ì¢…ë£Œì¼</label>
              <input type="date" class="form-input" id="objEndDate" value="${obj?.endDate || ''}">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveObjective()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveObjective() {
      const name = document.getElementById('objName').value.trim();
      if (!name) {
        showToast('ëª©í‘œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const data = {
        name,
        startDate: document.getElementById('objStartDate').value,
        endDate: document.getElementById('objEndDate').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (state.objective) {
          await db.collection('okr_objective').doc(state.objective.id).update(data);
        } else {
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection('okr_objective').add(data);
          state.objective = { id: docRef.id, ...data };
        }

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    function openKRModal(krId = null) {
      const kr = krId ? state.keyResults.find(k => k.id === krId) : null;
      const modal = document.getElementById('modal');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">ğŸ“ˆ KR ${kr ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">KRëª… *</label>
              <input type="text" class="form-input" id="krName" value="${kr?.name || ''}"
                placeholder="ì˜ˆ: ì—°ë§¤ì¶œ 10ì–µ ë‹¬ì„±">
            </div>
            <div class="form-group">
              <label class="form-label">ëª©í‘œê°’</label>
              <input type="number" class="form-input" id="krTargetValue" value="${kr?.targetValue || ''}"
                placeholder="ì˜ˆ: 1000000000">
            </div>
            <div class="form-group">
              <label class="form-label">ë‹¨ìœ„</label>
              <input type="text" class="form-input" id="krUnit" value="${kr?.unit || ''}"
                placeholder="ì˜ˆ: ì›, ëª…, %">
            </div>
          </div>
          <div class="modal-footer">
            ${kr ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteKR('${kr.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveKR('${krId || ''}')">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveKR(krId) {
      const name = document.getElementById('krName').value.trim();
      if (!name) {
        showToast('KRëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const data = {
        objectiveId: state.objective.id,
        name,
        targetValue: parseFloat(document.getElementById('krTargetValue').value) || 0,
        unit: document.getElementById('krUnit').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (krId) {
          await db.collection('okr_keyResults').doc(krId).update(data);
        } else {
          data.order = state.keyResults.length + 1;
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('okr_keyResults').add(data);
        }

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteKR(krId) {
      if (!confirm('ì´ KRì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ê²°ëœ KPIì™€ í›„í–‰ì§€í‘œë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

      try {
        // ì—°ê²°ëœ KPI ì‚­ì œ
        const kpis = state.kpis.filter(k => k.keyResultId === krId);
        for (const kpi of kpis) {
          // ì—°ê²°ëœ í›„í–‰ì§€í‘œ ì‚­ì œ
          const lags = state.laggingIndicators.filter(l => l.kpiId === kpi.id);
          for (const lag of lags) {
            await db.collection('okr_laggingIndicators').doc(lag.id).delete();
          }
          await db.collection('okr_kpis').doc(kpi.id).delete();
        }

        await db.collection('okr_keyResults').doc(krId).delete();

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    function openKPIModal(krId, kpiId = null) {
      const kpi = kpiId ? state.kpis.find(k => k.id === kpiId) : null;
      const lagsForKPI = kpi ? state.laggingIndicators.filter(l => l.kpiId === kpi.id) : [];

      const modal = document.getElementById('modal');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <div class="modal-title">ğŸ“Š KPI ${kpi ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">KPIëª… *</label>
              <input type="text" class="form-input" id="kpiName" value="${kpi?.name || ''}"
                placeholder="ì˜ˆ: êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ">
            </div>
            <div class="form-group">
              <label class="form-label">ëª©í‘œê°’ *</label>
              <input type="number" class="form-input" id="kpiTargetValue" value="${kpi?.targetValue || ''}"
                placeholder="ì˜ˆ: 800000000">
            </div>
            <div class="form-group">
              <label class="form-label">ë‹¨ìœ„</label>
              <input type="text" class="form-input" id="kpiUnit" value="${kpi?.unit || ''}"
                placeholder="ì˜ˆ: ì›, ëª…, ê±´">
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--gray-200);">

            <div class="form-group">
              <label class="form-label">í›„í–‰ì§€í‘œ (A/B í…ŒìŠ¤íŠ¸ ë²„ì „)</label>
              <div id="lagList">
                ${lagsForKPI.map((lag, idx) => `
                  <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" class="form-input lag-version" value="${lag.version}" style="width: 60px;" placeholder="A">
                    <input type="text" class="form-input lag-name" value="${lag.name}" style="flex: 1;" placeholder="ì „í™” ìƒë‹´">
                    <button class="btn btn-secondary" onclick="this.parentElement.remove()">Ã—</button>
                  </div>
                `).join('')}
              </div>
              <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addLagInput()">+ ë²„ì „ ì¶”ê°€</button>
            </div>
          </div>
          <div class="modal-footer">
            ${kpi ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteKPI('${kpi.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveKPI('${krId}', '${kpiId || ''}')">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    function addLagInput() {
      const lagList = document.getElementById('lagList');
      const div = document.createElement('div');
      div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
      div.innerHTML = `
        <input type="text" class="form-input lag-version" style="width: 60px;" placeholder="A">
        <input type="text" class="form-input lag-name" style="flex: 1;" placeholder="ì „í™” ìƒë‹´">
        <button class="btn btn-secondary" onclick="this.parentElement.remove()">Ã—</button>
      `;
      lagList.appendChild(div);
    }

    async function saveKPI(krId, kpiId) {
      const name = document.getElementById('kpiName').value.trim();
      const targetValue = parseFloat(document.getElementById('kpiTargetValue').value);

      if (!name) {
        showToast('KPIëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      if (!targetValue) {
        showToast('ëª©í‘œê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const data = {
        keyResultId: krId,
        name,
        targetValue,
        unit: document.getElementById('kpiUnit').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        let savedKpiId = kpiId;

        if (kpiId) {
          await db.collection('okr_kpis').doc(kpiId).update(data);
        } else {
          data.order = state.kpis.filter(k => k.keyResultId === krId).length + 1;
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection('okr_kpis').add(data);
          savedKpiId = docRef.id;
        }

        // í›„í–‰ì§€í‘œ ì €ì¥
        const versions = document.querySelectorAll('.lag-version');
        const names = document.querySelectorAll('.lag-name');

        // ê¸°ì¡´ í›„í–‰ì§€í‘œ ì‚­ì œ
        const existingLags = state.laggingIndicators.filter(l => l.kpiId === savedKpiId);
        for (const lag of existingLags) {
          await db.collection('okr_laggingIndicators').doc(lag.id).delete();
        }

        // ìƒˆ í›„í–‰ì§€í‘œ ì¶”ê°€
        for (let i = 0; i < versions.length; i++) {
          const version = versions[i].value.trim();
          const lagName = names[i].value.trim();
          if (version && lagName) {
            await db.collection('okr_laggingIndicators').add({
              kpiId: savedKpiId,
              version,
              name: lagName,
              totalValue: 0,
              logCount: 0,
              isActive: true,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteKPI(kpiId) {
      if (!confirm('ì´ KPIë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        // ì—°ê²°ëœ í›„í–‰ì§€í‘œ ì‚­ì œ
        const lags = state.laggingIndicators.filter(l => l.kpiId === kpiId);
        for (const lag of lags) {
          await db.collection('okr_laggingIndicators').doc(lag.id).delete();
        }

        await db.collection('okr_kpis').doc(kpiId).delete();

        await loadAllData();
        renderAll();
        closeModal();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    function closeModal() {
      document.getElementById('modal').className = 'modal';
    }

    // ========================================
    // ìœ í‹¸ë¦¬í‹°
    // ========================================
    function switchTab(tabName) {
      // íƒ­ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });

      // íƒ­ ì»¨í…ì¸  ì—…ë°ì´íŠ¸
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
      });
    }

    function toggleGuide() {
      const content = document.getElementById('guideContent');
      const text = document.getElementById('guideToggleText');
      const icon = document.getElementById('guideToggleIcon');

      if (content.classList.contains('show')) {
        content.classList.remove('show');
        text.textContent = 'í¼ì¹˜ê¸°';
        icon.textContent = 'â–¼';
      } else {
        content.classList.add('show');
        text.textContent = 'ì ‘ê¸°';
        icon.textContent = 'â–²';
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // ì´ˆê¸°í™”
    init();
  </script>
</body>
</html>

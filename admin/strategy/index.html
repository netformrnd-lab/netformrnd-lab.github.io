<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì „ëµì„¼í„° - ëª¨ì—¬ë¼ë”œ</title>
  <link rel="manifest" href="/admin/manifest.json">
  <meta name="theme-color" content="#3182f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ì „ëµì„¼í„°">
  <link rel="apple-touch-icon" href="/admin/icon-192.png">
  <meta name="description" content="ëª¨ì—¬ë¼ë”œ ì „ëµì„¼í„° - ì˜ì—…í˜„í™©, ê·¸ë¡œìŠ¤ë³´ë“œ, ì—…ë¬´ê´€ë¦¬">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #3182f6;
      --primary-light: #eef4ff;
      --primary-dark: #1b64da;
      --white: #ffffff;
      --gray-900: #191f28;
      --gray-800: #333d4b;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      --success: #00c073;
      --success-light: #e8f7f0;
      --warning: #fc9600;
      --warning-light: #fff8f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --info: #3182f6;
      --info-light: #eef4ff;
      --card-radius: 16px;
      --card-shadow: 0 2px 8px rgba(0,0,0,0.06);
      --btn-radius: 8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      background: var(--gray-100);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    .login-screen {
      min-height: 100vh;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container { width: 100%; max-width: 400px; }

    .login-logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo img { height: 48px; }

    .login-logo-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-top: 8px;
    }

    .login-card {
      background: var(--white);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .login-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      color: var(--gray-900);
    }

    .login-error {
      background: var(--danger-light);
      border: 1px solid #fecaca;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }

    .login-error.show { display: block; }

    .login-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
      margin-bottom: 12px;
    }

    .login-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: var(--white);
      font-family: inherit;
      transition: all 0.15s ease;
    }

    .login-btn:hover { background: var(--primary-dark); }

    /* ë ˆì´ì•„ì›ƒ */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 260px;
      background: var(--white);
      border-right: 1px solid var(--gray-200);
      padding: 24px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 20px;
      margin-bottom: 32px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .nav-section { margin-bottom: 32px; }

    .nav-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-500);
      letter-spacing: -0.2px;
      padding: 0 20px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      font-weight: 500;
      color: var(--gray-700);
      position: relative;
    }

    .nav-item:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }

    .nav-item.active {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary);
    }

    .nav-item .icon {
      width: 20px;
      text-align: center;
      font-size: 16px;
    }

    /* ì„œë¸Œë©”ë‰´ */
    .nav-submenu {
      margin-left: 32px;
      border-left: 2px solid var(--gray-200);
      padding-left: 12px;
      margin-bottom: 8px;
    }

    .nav-submenu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      font-size: 13px;
      color: var(--gray-500);
      border-radius: 6px;
      transition: all 0.2s;
      text-decoration: none;
    }

    .nav-submenu-item:hover {
      background: var(--gray-50);
      color: var(--gray-700);
    }

    .nav-parent {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      transition: all 0.2s;
    }

    .nav-parent:hover {
      background: var(--gray-50);
    }

    .nav-parent .icon {
      width: 20px;
      text-align: center;
      font-size: 16px;
    }

    .nav-parent-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-badge {
      background: #EF4444;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .center-links {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      margin-top: auto;
    }

    .center-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      color: var(--gray-600);
      text-decoration: none;
      transition: all 0.2s;
      margin-bottom: 4px;
    }

    .center-link:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .center-link.active {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }

    /* ë©”ì¸ ì»¨í…ì¸  */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 28px 32px;
      max-width: 1400px;
    }

    /* ëª¨ë°”ì¼ ë©”ë‰´ */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 150;
      background: var(--primary);
      color: var(--white);
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 90;
    }

    /* í—¤ë” */
    .page-header { margin-bottom: 24px; }

    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .page-desc {
      font-size: 14px;
      color: var(--gray-500);
    }

    /* ë²„íŠ¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover { background: var(--primary-dark); }

    .btn-secondary {
      background: var(--white);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    .btn-secondary:hover { background: var(--gray-50); }

    /* ì¹´ë“œ */
    .card {
      background: var(--white);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
    }

    /* í´ë”í˜• ê³„ì¸µêµ¬ì¡° í† ê¸€ ìŠ¤íƒ€ì¼ */
    .kpi-folder {
      margin-bottom: 16px;
    }

    .kpi-folder-header {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }

    .kpi-folder-header:hover {
      opacity: 0.85;
    }

    .kpi-folder-toggle {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 12px;
      color: var(--gray-500);
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .kpi-folder-toggle.expanded {
      transform: rotate(90deg);
    }

    .kpi-folder-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      opacity: 0;
    }

    .kpi-folder-content.expanded {
      max-height: 5000px;
      opacity: 1;
      transition: max-height 0.4s ease-in, opacity 0.3s ease-in;
    }

    .kpi-subfolder-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out, opacity 0.25s ease-out;
      opacity: 0;
    }

    .kpi-subfolder-content.expanded {
      max-height: 3000px;
      opacity: 1;
      transition: max-height 0.3s ease-in, opacity 0.25s ease-in;
    }

    .kpi-indicator-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out, opacity 0.2s ease-out;
      opacity: 0;
    }

    .kpi-indicator-content.expanded {
      max-height: 2000px;
      opacity: 1;
      transition: max-height 0.25s ease-in, opacity 0.2s ease-in;
    }

    /* KPI ì¹´ë“œ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--white);
      border-radius: var(--card-radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
    }

    .kpi-card.highlight {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .kpi-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 8px;
    }

    .kpi-card.highlight .kpi-label {
      color: rgba(255,255,255,0.8);
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .kpi-card.highlight .kpi-value {
      color: white;
    }

    .kpi-change {
      font-size: 12px;
      margin-top: 4px;
    }

    .kpi-change.positive { color: var(--success); }
    .kpi-change.negative { color: var(--danger); }

    /* í…Œì´ë¸” */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    th {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-500);
      background: var(--gray-50);
    }

    td {
      font-size: 14px;
      color: var(--gray-700);
    }

    /* ì°¨íŠ¸ í”Œë ˆì´ìŠ¤í™€ë” */
    .chart-placeholder {
      height: 300px;
      background: var(--gray-50);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-500);
      font-size: 14px;
    }

    /* OKR ìŠ¤íƒ€ì¼ */
    .okr-section {
      margin-bottom: 24px;
    }

    .okr-objective {
      background: var(--white);
      border-radius: var(--card-radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--card-shadow);
    }

    .okr-objective-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .okr-key-result {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
    }

    .okr-kr-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .okr-kr-title {
      font-size: 14px;
      color: var(--gray-700);
    }

    .okr-kr-progress {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }

    .okr-progress-bar {
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      overflow: hidden;
    }

    .okr-progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      display: flex;
      gap: 4px;
      background: var(--gray-100);
      padding: 4px;
      border-radius: 10px;
      margin-bottom: 24px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: var(--white);
      color: var(--gray-900);
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* í† ìŠ¤íŠ¸ */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gray-900);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 9999;
    }

    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      border-radius: 16px;
      width: auto;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-500);
      padding: 4px;
    }

    .modal-close:hover {
      color: var(--gray-900);
    }

    /* ë°˜ì‘í˜• - íƒœë¸”ë¦¿ (769px ~ 1024px) */
    @media (max-width: 1024px) and (min-width: 769px) {
      .main-content {
        padding: 24px;
      }

      .card {
        padding: 20px;
      }

      table {
        font-size: 13px;
      }

      .kr-grid, .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ë°˜ì‘í˜• - ëª¨ë°”ì¼ (~ 768px) */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .mobile-menu-btn {
        display: flex;
      }

      .sidebar-overlay.show {
        display: block;
      }

      .main-content {
        margin-left: 0;
        padding: 70px 16px 24px;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 12px;
      }

      .page-title {
        font-size: 20px !important;
      }

      .page-desc {
        font-size: 12px !important;
      }

      .card {
        padding: 16px;
        margin-bottom: 16px;
      }

      .card-title {
        font-size: 15px !important;
      }

      /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ëª¨ë°”ì¼ ìµœì í™” */
      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .kr-grid {
        grid-template-columns: 1fr;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      /* í…Œì´ë¸” ë°˜ì‘í˜• */
      div[style*="overflow-x: auto"] {
        position: relative;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
      }

      /* ìŠ¤í¬ë¡¤ íŒíŠ¸ */
      div[style*="overflow-x: auto"]::after {
        content: 'ğŸ‘‰ ì¢Œìš° ìŠ¤í¬ë¡¤';
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        background: rgba(49, 130, 246, 0.9);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        pointer-events: none;
        animation: fadeOut 3s forwards;
        z-index: 1;
      }

      @keyframes fadeOut {
        0%, 70% { opacity: 1; }
        100% { opacity: 0; }
      }

      table {
        min-width: 700px;
        font-size: 12px;
      }

      table th,
      table td {
        padding: 10px 8px !important;
        font-size: 11px;
        white-space: nowrap;
      }

      /* ë²„íŠ¼ ê·¸ë£¹ */
      .btn-group {
        flex-direction: column;
        width: 100%;
      }

      .btn-group button {
        width: 100%;
      }

      /* ëª¨ë‹¬ ìµœì í™” */
      .modal-content {
        max-width: 95vw !important;
        margin: 10px;
      }

      .modal-header h2 {
        font-size: 16px !important;
      }

      /* ì…ë ¥ í•„ë“œ */
      input[type="text"],
      input[type="number"],
      input[type="date"],
      input[type="email"],
      textarea,
      select {
        font-size: 16px !important; /* iOS ìë™ ì¤Œ ë°©ì§€ */
      }


      /* ëª©í‘œ ì¹´ë“œ */
      .objective-card {
        padding: 20px !important;
      }

      .objective-rate {
        font-size: 36px !important;
      }

      /* ë²„ì „ ì„ íƒ ë²„íŠ¼ */
      div[style*="display: flex; gap: 6px; flex-wrap: wrap"] button {
        font-size: 12px !important;
        padding: 8px 6px !important;
      }
    }

    /* ì•„ì£¼ ì‘ì€ í™”ë©´ (~ 375px) */
    @media (max-width: 375px) {
      .main-content {
        padding: 70px 12px 20px;
      }

      .card {
        padding: 12px;
      }

      .page-title {
        font-size: 18px !important;
      }

      table {
        min-width: 600px;
        font-size: 11px;
      }

      table th,
      table td {
        padding: 8px 6px !important;
        font-size: 10px;
      }

      .btn {
        font-size: 12px !important;
        padding: 8px 12px !important;
      }
    }
  </style>
  <!-- PPT ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <div class="login-logo">
        <img src="/admin/moyeora-logo.png" alt="ëª¨ì—¬ë¼ë”œ" onerror="this.style.display='none'">
        <div class="login-logo-desc">ì „ëµì„¼í„°</div>
      </div>
      <div class="login-card">
        <div class="login-title">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
        <div id="loginError" class="login-error"></div>
        <input type="password" id="loginPassword" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter')handleLogin()">
        <button class="login-btn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì•± í™”ë©´ -->
  <div id="appScreen" class="app-container" style="display:none;">
    <!-- ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <div class="logo" style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="logo-icon">ğŸ“Š</div>
          <span class="logo-text">ì „ëµì„¼í„°</span>
        </div>
        <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
        <div id="notificationBell" onclick="toggleNotificationPanel()" style="position: relative; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
          <span style="font-size: 20px;">ğŸ””</span>
          <span id="notificationBadge" style="display: none; position: absolute; top: 4px; right: 4px; width: 18px; height: 18px; background: #EF4444; color: white; border-radius: 50%; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center;">0</span>
        </div>
      </div>

      <!-- ì•Œë¦¼ íŒ¨ë„ -->
      <div id="notificationPanel" style="display: none; position: absolute; top: 70px; left: 12px; right: 12px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 200; max-height: 400px; overflow-y: auto;">
        <div style="padding: 16px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
          <div style="font-size: 15px; font-weight: 700; color: var(--gray-900);">ğŸ”” ì•Œë¦¼</div>
          <button onclick="markAllNotificationsRead()" style="font-size: 12px; color: var(--primary); background: none; border: none; cursor: pointer; font-weight: 600;">ëª¨ë‘ ì½ìŒ</button>
        </div>
        <div id="notificationList" style="padding: 8px;">
          <div style="padding: 20px; text-align: center; color: var(--gray-500); font-size: 13px;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>

      <nav>
        <div class="nav-section">
          <div class="nav-label">í˜„í™©</div>
          <div class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
            <span class="icon">ğŸ“ˆ</span>
            <span>ì˜ì—…í˜„í™©</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-label">ì „ëµ ì‚¬ì´í´</div>

          <!-- OKR íŠ¸ë˜ì»¤ (ë©”ì¸ ë©”ë‰´ë¡œ ìŠ¹ê²©) -->
          <div class="nav-item" data-tab="okr-dashboard" onclick="switchTab('okr-dashboard')">
            <span class="icon">ğŸ“ˆ</span>
            <span>íŒ€ ê·¸ë¡œìŠ¤ë³´ë“œ</span>
          </div>
          <div class="nav-item" data-tab="okr-personal-dashboard" onclick="switchTab('okr-personal-dashboard')">
            <span class="icon">ğŸ‘¤</span>
            <span>ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ</span>
          </div>
          <div class="nav-item" data-tab="okr-record" onclick="switchTab('okr-record')">
            <span class="icon">ğŸ“</span>
            <span>ì—…ë¬´ê¸°ë¡</span>
          </div>
          <div class="nav-item" data-tab="okr-settings" onclick="switchTab('okr-settings')">
            <span class="icon">ğŸ¯</span>
            <span>ëª©í‘œì„¤ì •</span>
          </div>
          <div class="nav-item" data-tab="okr-experiment" onclick="switchTab('okr-experiment')">
            <span class="icon">ğŸ”¬</span>
            <span>ì‹¤í—˜ë¶„ì„</span>
          </div>
          <div class="nav-item" data-tab="meeting-history" onclick="switchTab('meeting-history')">
            <span class="icon">ğŸ“…</span>
            <span>ë¯¸íŒ… íˆìŠ¤í† ë¦¬</span>
          </div>
          <div class="nav-item" data-tab="change-logs" onclick="switchTab('change-logs')">
            <span class="icon">ğŸ“‹</span>
            <span>ë³€ê²½ì´ë ¥</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-label">ìë£Œ</div>
          <div class="nav-item" data-tab="guide" onclick="switchTab('guide')">
            <span class="icon">ğŸ“š</span>
            <span>ì—…ë¬´ê°€ì´ë“œ</span>
          </div>
          <div class="nav-item" data-tab="reference" onclick="switchTab('reference')">
            <span class="icon">ğŸ“‚</span>
            <span>ë ˆí¼ëŸ°ìŠ¤</span>
          </div>
          <div class="nav-item" data-tab="trendKeywords" onclick="switchTab('trendKeywords')">
            <span class="icon">ğŸ”¥</span>
            <span>íŠ¸ë Œë“œ í‚¤ì›Œë“œ</span>
          </div>
        </div>

        <!-- ì„¼í„° ì´ë™ -->
        <div class="center-links">
          <div class="nav-label">ì„¼í„° ì´ë™</div>
          <a href="/admin/" class="center-link">
            <span>âš™ï¸</span>
            <span>ìš´ì˜ì„¼í„°</span>
          </a>
          <a href="/admin/crm/" class="center-link">
            <span>ğŸ’¼</span>
            <span>CRMì„¼í„°</span>
          </a>
          <a href="/admin/strategy/" class="center-link active">
            <span>ğŸ“Š</span>
            <span>ì „ëµì„¼í„°</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
      <!-- ìƒë‹¨ ì„¼í„° ë°”ë¡œê°€ê¸° -->
      <div style="display: flex; gap: 4px; margin-bottom: 20px; padding: 4px; background: var(--gray-200); border-radius: 12px; width: fit-content;">
        <a href="/admin/" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: transparent; border-radius: 10px; text-decoration: none; color: var(--gray-600); font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
          ìš´ì˜ì„¼í„°
        </a>
        <a href="/admin/strategy/" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: var(--primary); border-radius: 10px; text-decoration: none; color: white; font-size: 13px; font-weight: 700; box-shadow: 0 2px 8px rgba(49, 130, 246, 0.3);">
          ì „ëµì„¼í„°
        </a>
        <a href="/admin/crm/" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: transparent; border-radius: 10px; text-decoration: none; color: var(--gray-600); font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
          CRMì„¼í„°
        </a>
      </div>

      <!-- ì˜ì—…í˜„í™© -->
      <div id="tab-dashboard" class="tab-content active">
        <div id="salesDashboardContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- OKR -->
      <div id="tab-okr" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">OKR</h1>
          <p class="page-desc">ëª©í‘œ ë° í•µì‹¬ ê²°ê³¼ ê´€ë¦¬</p>
        </div>

        <div class="tab-nav">
          <button class="tab-btn active" onclick="switchOkrPeriod('quarterly')">ë¶„ê¸°ë³„</button>
          <button class="tab-btn" onclick="switchOkrPeriod('monthly')">ì›”ë³„</button>
          <button class="tab-btn" onclick="switchOkrPeriod('weekly')">ì£¼ê°„</button>
        </div>

        <div class="okr-section" id="okrContent">
          <div class="okr-objective">
            <div class="okr-objective-title">
              <span>ğŸ¯</span>
              <span>Q1 ë§¤ì¶œ ëª©í‘œ ë‹¬ì„±</span>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">ì›” ë§¤ì¶œ 1ì–µì› ë‹¬ì„±</span>
                <span class="okr-kr-progress">65%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 65%"></div>
              </div>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">ì‹ ê·œ ê³µê¸‰ì‚¬ 20ê°œ í™•ë³´</span>
                <span class="okr-kr-progress">40%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 40%"></div>
              </div>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">ê³µêµ¬ ì „í™˜ìœ¨ 15% ë‹¬ì„±</span>
                <span class="okr-kr-progress">80%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 80%"></div>
              </div>
            </div>
          </div>

          <div class="okr-objective">
            <div class="okr-objective-title">
              <span>ğŸš€</span>
              <span>íŒŒíŠ¸ë„ˆ ìƒíƒœê³„ í™•ì¥</span>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">ì…€ëŸ¬ ë„¤íŠ¸ì›Œí¬ 50ê°œ í™•ë³´</span>
                <span class="okr-kr-progress">55%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 55%"></div>
              </div>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">íŒŒíŠ¸ë„ˆ ë§Œì¡±ë„ 4.5ì  ì´ìƒ</span>
                <span class="okr-kr-progress">90%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 90%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì—…ë¬´ê´€ë¦¬ -->
      <div id="tab-worklog" class="tab-content">
        <div id="worklogContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- KPIê´€ë¦¬ -->
      <div id="tab-kpi" class="tab-content">
        <div id="kpiContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- OKR íŠ¸ë˜ì»¤ - íŒ€ ê·¸ë¡œìŠ¤ë³´ë“œ -->
      <div id="tab-okr-dashboard" class="tab-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
          <div>
            <h1 class="page-title">ğŸ“ˆ íŒ€ ê·¸ë¡œìŠ¤ë³´ë“œ</h1>
          </div>
          <button onclick="showGrowthboardExplanation()" style="background: var(--gray-100); border: 1px solid var(--gray-300); border-radius: 8px; padding: 8px 14px; font-size: 13px; color: var(--gray-600); cursor: pointer; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='var(--primary-light)'; this.style.borderColor='var(--primary)'; this.style.color='var(--primary)';" onmouseout="this.style.background='var(--gray-100)'; this.style.borderColor='var(--gray-300)'; this.style.color='var(--gray-600)';">
            <span>â“</span> ì™œ ê·¸ë¡œìŠ¤ë³´ë“œê°€ í•„ìš”í•œì§€?
          </button>
        </div>
        <div id="okrDashboardContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- OKR íŠ¸ë˜ì»¤ - ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ -->
      <div id="tab-okr-personal-dashboard" class="tab-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
          <div>
            <h1 class="page-title">ğŸ‘¤ ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ</h1>
          </div>
        </div>
        <div id="okrPersonalDashboardContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- OKR íŠ¸ë˜ì»¤ - ì—…ë¬´ê¸°ë¡ -->
      <div id="tab-okr-record" class="tab-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
          <div>
            <h1 class="page-title">ğŸ“ ì—…ë¬´ê¸°ë¡</h1>
            <p class="page-desc">ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì—…ë¬´ë¥¼ ê¸°ë¡í•˜ì„¸ìš”</p>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 13px; color: var(--gray-500);">ì˜¤ëŠ˜ ê¸°ë¡:</span>
            <span id="okrTodayCount" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 700;">0ê±´</span>
          </div>
        </div>

        <!-- ì¦ê²¨ì°¾ê¸° ë° ë¹ ë¥¸ ì¶”ê°€ -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; gap: 12px; align-items: center; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="toggleFavoriteFilter()" id="favoriteFilterBtn" style="display: flex; align-items: center; gap: 6px;">
              <span>â­</span> ì¦ê²¨ì°¾ê¸°ë§Œ
            </button>
            <button class="btn btn-primary" onclick="openQuickAddModal()" style="display: flex; align-items: center; gap: 6px;">
              <span>+</span> ë¹ ë¥¸ ì¶”ê°€
            </button>
          </div>
        </div>

        <!-- ì¦ê²¨ì°¾ê¸° ê³ ì • ì˜ì—­ -->
        <div id="okrFavoritesSection" class="card" style="margin-bottom: 20px; display: none; background: linear-gradient(135deg, #FEF3C7, #FDE68A); border: 2px solid var(--warning);">
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-700); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span>â­</span> ì¦ê²¨ì°¾ê¸°
          </div>
          <div id="okrFavoritesButtons" style="display: flex; flex-wrap: wrap; gap: 10px;">
            <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
          </div>
        </div>

        <!-- Undo ì•Œë¦¼ -->
        <div id="okrUndoNotification" style="display: none; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--gray-800); color: white; padding: 12px 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000; display: none; align-items: center; gap: 16px;">
          <span id="okrUndoMessage">ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤</span>
          <button onclick="undoOkrWork()" style="background: var(--warning); color: var(--gray-800); border: none; padding: 6px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: inherit;">ì‹¤í–‰ì·¨ì†Œ</button>
          <button onclick="hideUndoNotification()" style="background: transparent; color: var(--gray-400); border: none; font-size: 18px; cursor: pointer;">âœ•</button>
        </div>

        <!-- ì—…ë¬´ ê¸°ë¡ ë²„íŠ¼ë“¤ -->
        <div id="okrRecordContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>

        <!-- ì˜¤ëŠ˜ ê¸°ë¡ ìš”ì•½ -->
        <div class="card" style="margin-top: 20px; background: var(--gray-50);">
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-700); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ“Š</span> ì˜¤ëŠ˜ ê¸°ë¡ ìš”ì•½
          </div>
          <div id="okrTodaySummary">
            <div style="color: var(--gray-400); font-size: 13px;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        </div>
      </div>

      <!-- OKR íŠ¸ë˜ì»¤ - ëª©í‘œì„¤ì • -->
      <div id="tab-okr-settings" class="tab-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
          <div>
            <h1 class="page-title">ğŸ¯ ëª©í‘œì„¤ì •</h1>
            <p class="page-desc">O, KR, KPI, ì§€í‘œ(í™œë™/ì„±ê³¼)ë¥¼ ì„¤ì •í•˜ì„¸ìš”</p>
          </div>
          <button id="okrObjectiveEditBtn" class="btn btn-primary" onclick="openOkrObjectiveModal()">ëª©í‘œ ìˆ˜ì •</button>
        </div>
        <div id="okrSettingsContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- OKR íŠ¸ë˜ì»¤ - ì‹¤í—˜ë¶„ì„ -->
      <div id="tab-okr-experiment" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">ğŸ”¬ ì‹¤í—˜ë¶„ì„</h1>
        </div>
        <div id="okrExperimentContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- ë¯¸íŒ… íˆìŠ¤í† ë¦¬ -->
      <div id="tab-meeting-history" class="tab-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
          <div>
            <h1 class="page-title">ğŸ“… ë¯¸íŒ… íˆìŠ¤í† ë¦¬</h1>
            <p class="page-desc">ëª¨ë“  ë¯¸íŒ… ì¼ì •ê³¼ íšŒì˜ë¡ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="openMeetingModal()" class="btn btn-primary">+ ë¯¸íŒ… ë“±ë¡</button>
          </div>
        </div>

        <!-- ë¯¸íŒ… ìš”ì•½ ì¹´ë“œ -->
        <div id="meetingSummaryCard" class="card" style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 24px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div>
              <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">ì „ì²´ ë¯¸íŒ…</div>
              <div id="meetingTotalCount" style="font-size: 36px; font-weight: 800;">0ê±´</div>
            </div>
            <div style="display: flex; gap: 24px;">
              <div style="text-align: center;">
                <div style="font-size: 12px; opacity: 0.8;">ì˜ˆì •</div>
                <div id="meetingScheduledCount" style="font-size: 20px; font-weight: 700; margin-top: 4px;">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; opacity: 0.8;">ì™„ë£Œ</div>
                <div id="meetingCompletedCount" style="font-size: 20px; font-weight: 700; margin-top: 4px;">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; opacity: 0.8;">ì´ë²ˆ ë‹¬</div>
                <div id="meetingThisMonthCount" style="font-size: 20px; font-weight: 700; margin-top: 4px;">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë¯¸íŒ… í•„í„° -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <input type="text" id="meetingSearch" placeholder="ë¯¸íŒ… ê²€ìƒ‰..." oninput="filterMeetingHistory()" style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="meetingTypeFilters">
              <button onclick="setMeetingTypeFilter('all')" class="meeting-type-btn active" data-type="all" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; background: var(--primary); color: white;">ì „ì²´</button>
              <button onclick="setMeetingTypeFilter('CEO_REPORT')" class="meeting-type-btn" data-type="CEO_REPORT" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; background: #EDE9FE; color: #7C3AED;">ğŸ‘” ëŒ€í‘œ ë³´ê³ </button>
              <button onclick="setMeetingTypeFilter('KPI_REVIEW')" class="meeting-type-btn" data-type="KPI_REVIEW" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; background: #E8F3FF; color: #0064FF;">ğŸ“Š KPI ì¸¡ì •</button>
              <button onclick="setMeetingTypeFilter('CONFIRM')" class="meeting-type-btn" data-type="CONFIRM" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; background: #DCFCE7; color: #16A34A;">âœ… ì»¨íŒ</button>
              <button onclick="setMeetingTypeFilter('PARTNER')" class="meeting-type-btn" data-type="PARTNER" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; background: #FEF3C7; color: #B45309;">ğŸ¤ íŒŒíŠ¸ë„ˆ</button>
            </div>
          </div>
        </div>

        <!-- ë¯¸íŒ… ëª©ë¡ -->
        <div id="meetingHistoryList">
          <div style="text-align: center; padding: 60px; background: white; border-radius: 16px;">
            ë¯¸íŒ… íˆìŠ¤í† ë¦¬ ë¡œë”©ì¤‘...
          </div>
        </div>
      </div>

      <!-- ë³€ê²½ì´ë ¥ -->
      <div id="tab-change-logs" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">ğŸ“‹ ë³€ê²½ì´ë ¥</h1>
          <p class="page-desc">ì „ëµì‚¬ì´í´ì—ì„œ ë³€ê²½ëœ ëª¨ë“  ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div id="changeLogsContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- ì„±ê³¼ë¶„ì„ -->
      <div id="tab-review" class="tab-content">
        <div id="reviewContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- ì—…ë¬´ê°€ì´ë“œ -->
      <div id="tab-guide" class="tab-content">
        <div id="guideContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
      <div id="tab-reference" class="tab-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
          <div>
            <h1 class="page-title">ğŸ“‚ ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬</h1>
            <p class="page-desc">ì´ë²¤íŠ¸, ë””ìì¸, ì œì•ˆì„œ, ìˆí¼ ë“± ì—…ë¬´ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ëª¨ì•„ë‘ì„¸ìš”</p>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="openCategoryModal()">âš™ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</button>
            <button class="btn btn-primary" onclick="openReferenceModal()">+ ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€</button>
          </div>
        </div>

        <!-- ë ˆí¼ëŸ°ìŠ¤ ìš”ì•½ ì¹´ë“œ -->
        <div id="referenceSummaryCard" class="card" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; padding: 24px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div>
              <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">ì „ì²´ ë ˆí¼ëŸ°ìŠ¤</div>
              <div id="referenceTotalCount" style="font-size: 36px; font-weight: 800;">0ê°œ</div>
            </div>
            <div id="referenceCategoryCounts" style="display: flex; gap: 16px; flex-wrap: wrap;">
              <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
            </div>
          </div>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <input type="text" id="refSearch" placeholder="ë ˆí¼ëŸ°ìŠ¤ ê²€ìƒ‰..." oninput="filterReferences()" style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
            </div>
            <div id="refCategoryFilters" style="display: flex; gap: 8px; flex-wrap: wrap;">
              <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
            </div>
          </div>
        </div>

        <!-- ë ˆí¼ëŸ°ìŠ¤ ëª©ë¡ -->
        <div id="referenceList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
          <div style="text-align: center; padding: 60px; grid-column: 1 / -1; background: var(--white); border-radius: 16px;">
            ë ˆí¼ëŸ°ìŠ¤ ë¡œë”©ì¤‘...
          </div>
        </div>
      </div>

      <!-- íŠ¸ë Œë“œ í‚¤ì›Œë“œ -->
      <div id="tab-trendKeywords" class="tab-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
          <div>
            <h1 class="page-title">ğŸ”¥ íŠ¸ë Œë“œ í‚¤ì›Œë“œ</h1>
            <p class="page-desc">ì¸ê¸° í‚¤ì›Œë“œ ì¶”ì¶œ ë° ì…€ëŸ¬ íŠ¸ë Œë“œ ê¸°ë°˜ ìƒí’ˆ ì¶”ì²œìš© ë°ì´í„° ê´€ë¦¬</p>
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="openKeywordSiteModal()" class="btn btn-secondary">ğŸŒ ì‚¬ì´íŠ¸ ê´€ë¦¬</button>
            <button onclick="openAddKeywordModal()" class="btn btn-primary">+ í‚¤ì›Œë“œ ì¶”ê°€</button>
          </div>
        </div>

        <!-- ì´ë‹¬ì˜ Top 5 í‚¤ì›Œë“œ -->
        <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid #F59E0B;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="font-size: 18px; font-weight: 700; color: #92400E; margin: 0;">ğŸ† ì´ë‹¬ì˜ ì¸ê¸° í‚¤ì›Œë“œ TOP 5</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
              <select id="topKeywordMonth" onchange="loadTopKeywords()" style="padding: 8px 12px; border: 1px solid #F59E0B; border-radius: 8px; background: white; font-size: 13px;">
                <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
              </select>
              <button onclick="openSelectTopKeywordsModal()" class="btn" style="background: #F59E0B; color: white; padding: 8px 16px; font-size: 13px;">TOP 5 ì„ ì •</button>
            </div>
          </div>
          <div id="topKeywordsList" style="display: flex; gap: 12px; flex-wrap: wrap;">
            <div style="text-align: center; padding: 20px; color: #92400E;">TOP 5 í‚¤ì›Œë“œë¥¼ ì„ ì •í•´ì£¼ì„¸ìš”</div>
          </div>
        </div>

        <!-- í‚¤ì›Œë“œ ë¶„ì„ ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸° -->
        <div style="background: linear-gradient(135deg, #EDE9FE, #DDD6FE); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid #C4B5FD;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-size: 14px; font-weight: 700; color: #6D28D9;">ğŸ”— í‚¤ì›Œë“œ ë¶„ì„ ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸°</span>
          </div>
          <div id="keywordSiteLinks" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
          </div>
        </div>

        <!-- ì‚¬ì´íŠ¸ë³„ í•„í„° ë° ê²€ìƒ‰ -->
        <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <input type="text" id="keywordSearch" placeholder="ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰..." oninput="filterKeywords()" style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="keywordSiteFilters">
              <button onclick="setKeywordSiteFilter('all')" class="keyword-site-btn active" data-site="all" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; background: var(--primary); color: white;">ì „ì²´</button>
              <!-- ì‚¬ì´íŠ¸ ë²„íŠ¼ ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
            </div>
          </div>
        </div>

        <!-- í‚¤ì›Œë“œ ëª©ë¡ -->
        <div id="keywordList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
          <div style="text-align: center; padding: 60px; grid-column: 1 / -1; background: white; border-radius: 16px;">
            í‚¤ì›Œë“œ ë¡œë”©ì¤‘...
          </div>
        </div>
      </div>

      <!-- í‚¤ì›Œë“œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
      <div id="keywordModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #F59E0B, #FBBF24); color: white;">
            <h2 id="keywordModalTitle" class="modal-title" style="color: white;">í‚¤ì›Œë“œ ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeKeywordModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="keywordId">
            <div style="display: grid; gap: 16px;">
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">í‚¤ì›Œë“œ *</label>
                <input type="text" id="keywordName" placeholder="ì˜ˆ: ë´„ì‹ ìƒ, ë‹¤ì´ì–´íŠ¸, ìº í•‘ìš©í’ˆ" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì¶œì²˜ ì‚¬ì´íŠ¸ *</label>
                <select id="keywordSiteId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
                  <option value="">ì‚¬ì´íŠ¸ ì„ íƒ</option>
                  <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
                </select>
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ê´€ë ¨ ì¹´í…Œê³ ë¦¬</label>
                <input type="text" id="keywordCategory" placeholder="ì˜ˆ: íŒ¨ì…˜, ë·°í‹°, ì‹í’ˆ" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì¶”ì¶œ ë‚ ì§œ</label>
                <input type="date" id="keywordDate" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì°¸ê³  URL</label>
                <input type="url" id="keywordUrl" placeholder="https://..." style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ë©”ëª¨</label>
                <textarea id="keywordMemo" placeholder="í‚¤ì›Œë“œ ê´€ë ¨ ë©”ëª¨, ì¶”ì²œ ìƒí’ˆ ì•„ì´ë””ì–´ ë“±" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="background: #E8F3FF; border: 2px dashed #3B82F6; border-radius: 10px; padding: 16px; text-align: center;" id="keywordPasteArea" tabindex="0" onpaste="handleKeywordPaste(event)" onclick="this.focus()">
                <div style="font-size: 13px; color: #1D4ED8; font-weight: 600;">ğŸ“‹ ìº¡ì²˜ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°</div>
                <div style="font-size: 11px; color: #3B82F6; margin-top: 4px;">ì—¬ê¸°ë¥¼ í´ë¦­ í›„ Ctrl+V (ë˜ëŠ” Cmd+V)</div>
                <div id="keywordImagePreview" style="margin-top: 12px; display: none;"></div>
              </div>
            </div>
          </div>
          <div style="padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between;">
            <button id="deleteKeywordBtn" type="button" onclick="deleteKeyword()" style="background: var(--danger-light); color: var(--danger); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; display: none;">ì‚­ì œ</button>
            <div style="display: flex; gap: 12px; margin-left: auto;">
              <button type="button" onclick="closeKeywordModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
              <button type="button" onclick="saveKeyword()" class="btn btn-primary">ì €ì¥</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì‚¬ì´íŠ¸ ê´€ë¦¬ ëª¨ë‹¬ -->
      <div id="keywordSiteModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸŒ í‚¤ì›Œë“œ ì¶œì²˜ ì‚¬ì´íŠ¸ ê´€ë¦¬</h2>
            <button class="modal-close" onclick="closeKeywordSiteModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="display: flex; gap: 8px; margin-bottom: 20px;">
              <input type="text" id="newSiteName" placeholder="ì‚¬ì´íŠ¸ëª… (ì˜ˆ: ë„¤ì´ë²„ ì‡¼í•‘)" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              <input type="url" id="newSiteUrl" placeholder="URL (ì˜ˆ: https://shopping.naver.com)" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              <input type="color" id="newSiteColor" value="#3B82F6" style="width: 50px; height: 46px; border: none; border-radius: 8px; cursor: pointer;">
              <button onclick="addKeywordSite()" class="btn btn-primary">ì¶”ê°€</button>
            </div>
            <div id="keywordSiteList" style="display: grid; gap: 8px;">
              <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
            </div>
          </div>
        </div>
      </div>

      <!-- TOP 5 ì„ ì • ëª¨ë‹¬ (ìˆ˜ë™ ì…ë ¥) -->
      <div id="selectTopKeywordsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #F59E0B, #FBBF24); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ† ì´ë‹¬ì˜ TOP 5 í‚¤ì›Œë“œ ì…ë ¥</h2>
            <button class="modal-close" onclick="closeSelectTopKeywordsModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="margin-bottom: 16px;">
              <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì„ ì • ì›”</label>
              <input type="month" id="topKeywordSelectMonth" onchange="onTopKeywordMonthChange()" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
            </div>
            <div style="background: #FEF3C7; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
              <span style="color: #92400E; font-size: 13px;">ğŸ’¡ ì˜ì—…ì— í™œìš©í•  ì´ë‹¬ì˜ ì¸ê¸° í‚¤ì›Œë“œ 5ê°œë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</span>
            </div>
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 28px; height: 28px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">1</span>
                <input type="text" id="topKeyword1" placeholder="1ìœ„ í‚¤ì›Œë“œ" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 28px; height: 28px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">2</span>
                <input type="text" id="topKeyword2" placeholder="2ìœ„ í‚¤ì›Œë“œ" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 28px; height: 28px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">3</span>
                <input type="text" id="topKeyword3" placeholder="3ìœ„ í‚¤ì›Œë“œ" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 28px; height: 28px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">4</span>
                <input type="text" id="topKeyword4" placeholder="4ìœ„ í‚¤ì›Œë“œ" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 28px; height: 28px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">5</span>
                <input type="text" id="topKeyword5" placeholder="5ìœ„ í‚¤ì›Œë“œ" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
            </div>
          </div>
          <div style="padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px;">
            <button type="button" onclick="closeSelectTopKeywordsModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
            <button type="button" onclick="saveTopKeywordsManual()" class="btn btn-primary">ì €ì¥</button>
          </div>
        </div>
      </div>

      <!-- ë ˆí¼ëŸ°ìŠ¤ ëª¨ë‹¬ -->
      <div id="referenceModal" class="modal">
        <div class="modal-content" style="max-width: 650px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
          <div class="modal-header" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white;">
            <h2 id="referenceModalTitle" class="modal-title" style="color: white;">ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeReferenceModal()" style="color: white;">Ã—</button>
          </div>
          <div style="flex: 1; overflow-y: auto; padding: 24px;">
            <input type="hidden" id="referenceId">
            <div style="display: grid; gap: 16px;">
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì œëª© *</label>
                <input type="text" id="referenceTitle" placeholder="ë ˆí¼ëŸ°ìŠ¤ ì œëª©" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì¹´í…Œê³ ë¦¬ *</label>
                <select id="referenceCategory" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
                  <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
                </select>
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì„¤ëª…</label>
                <textarea id="referenceDesc" placeholder="ë ˆí¼ëŸ°ìŠ¤ì— ëŒ€í•œ ì„¤ëª…" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="background: #E8F3FF; padding: 16px; border-radius: 10px;">
                <label style="font-size: 13px; font-weight: 600; color: #0064FF; display: block; margin-bottom: 6px;">ğŸ”— ë§í¬ URL</label>
                <input type="url" id="referenceLink" placeholder="https://..." style="width: 100%; padding: 12px; border: 1px solid #C7D2FE; border-radius: 10px; font-size: 14px; background: white;">
                <div style="font-size: 11px; color: var(--gray-600); margin-top: 6px;">ìœ íŠœë¸Œ, ì¸ìŠ¤íƒ€ê·¸ë¨, ì›¹ì‚¬ì´íŠ¸ ë“± ì™¸ë¶€ ë§í¬</div>
              </div>
              <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); padding: 16px; border-radius: 10px; border: 1px solid #F59E0B;">
                <label style="font-size: 13px; font-weight: 600; color: #B45309; display: block; margin-bottom: 10px;">ğŸ“¤ ì´ë¯¸ì§€/PDF ì—…ë¡œë“œ <span id="refImageCount" style="color: var(--gray-600); font-weight: 400;"></span></label>
                <div id="refFileUploadArea" style="background: white; border: 2px dashed #F59E0B; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('refFileInput').click()">
                  <input type="file" id="refFileInput" accept=".jpg,.jpeg,.png,.gif,.pdf" multiple style="display: none;" onchange="handleRefImageUpload(this.files)">
                  <div style="font-size: 32px; margin-bottom: 8px;">ğŸ–¼ï¸</div>
                  <div style="font-size: 14px; font-weight: 600; color: #92400E;">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ (ì—¬ëŸ¬ê°œ ê°€ëŠ¥)</div>
                  <div style="font-size: 12px; color: #B45309; margin-top: 4px;">JPG, PNG, GIF, PDF (ìµœëŒ€ 10ê°œ)</div>
                </div>
                <div id="refPasteArea" style="background: #E8F3FF; border: 2px dashed #3B82F6; border-radius: 10px; padding: 16px; text-align: center; margin-top: 12px; cursor: text;" tabindex="0" onpaste="handleRefPaste(event)" onclick="this.focus()">
                  <div style="font-size: 13px; color: #1D4ED8; font-weight: 600;">ğŸ“‹ ìº¡ì²˜ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°</div>
                  <div style="font-size: 11px; color: #3B82F6; margin-top: 4px;">ì—¬ê¸°ë¥¼ í´ë¦­ í›„ Ctrl+V (ë˜ëŠ” Cmd+V)</div>
                </div>
                <div id="refImagesPreview" style="display: none; margin-top: 12px;"></div>
              </div>
              <div style="background: #DCFCE7; padding: 16px; border-radius: 10px;">
                <label style="font-size: 13px; font-weight: 600; color: #16A34A; display: block; margin-bottom: 6px;">ğŸ“ íŒŒì¼ URL (ì™¸ë¶€ ë§í¬)</label>
                <input type="url" id="referenceFileUrl" placeholder="êµ¬ê¸€ ë“œë¼ì´ë¸Œ, Dropbox ë“± íŒŒì¼ ê³µìœ  ë§í¬" style="width: 100%; padding: 12px; border: 1px solid #86EFAC; border-radius: 10px; font-size: 14px; background: white;">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                <input type="text" id="referenceTags" placeholder="ì˜ˆ: ë´„ì‹ ìƒ, í• ì¸ì´ë²¤íŠ¸, ì¸ìŠ¤íƒ€" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
            </div>
          </div>
          <div style="padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between;">
            <button id="deleteReferenceBtn" type="button" onclick="deleteReference()" style="background: var(--danger-light); color: var(--danger); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; display: none;">ì‚­ì œ</button>
            <div style="display: flex; gap: 12px; margin-left: auto;">
              <button type="button" onclick="closeReferenceModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
              <button type="button" onclick="saveReference()" class="btn btn-primary" id="btnSaveRef">ì €ì¥</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ëª¨ë‹¬ -->
      <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h2 class="modal-title">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h2>
            <button class="modal-close" onclick="closeCategoryModal()">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
              <input type="text" id="newCatEmoji" placeholder="ğŸ‰" style="width: 60px; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; text-align: center; font-size: 20px;">
              <input type="text" id="newCatName" placeholder="ì¹´í…Œê³ ë¦¬ëª…" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              <input type="color" id="newCatColor" value="#8B5CF6" style="width: 50px; height: 46px; border: none; border-radius: 8px; cursor: pointer;">
              <button onclick="addCategory()" class="btn btn-primary">ì¶”ê°€</button>
            </div>
            <div id="categoryList" style="display: grid; gap: 8px;">
              <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
            </div>
          </div>
        </div>
      </div>

      <!-- ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ëª¨ë‹¬ -->
      <div id="referenceDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
          <div id="referenceDetailContent">
            <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
          </div>
        </div>
      </div>

      <!-- ë²”ìš© ëª¨ë‹¬ -->
      <div id="modal" class="modal"></div>
    </main>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast"></div>

  <!-- ìš´ì˜ì„¼í„° í™œë™ ë‚´ì—­ í€µë°°ë„ˆ (ìš°ì¸¡ í•˜ë‹¨) -->
  <div id="opsCenterQuickBanner" style="position: fixed; bottom: 24px; right: 24px; z-index: 900; display: none;">
    <!-- ë¯¸ë‹ˆ ë°°ë„ˆ (ì ‘íŒ ìƒíƒœ) -->
    <div id="opsBannerMini" onclick="toggleOpsBanner(true)" style="background: linear-gradient(135deg, #1E40AF, #3B82F6); color: white; padding: 12px 16px; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); display: flex; align-items: center; gap: 10px; transition: all 0.3s;">
      <span style="font-size: 20px;">ğŸ¢</span>
      <span style="font-weight: 600; font-size: 13px;">ìš´ì˜ì„¼í„°</span>
      <span id="opsBadge" style="background: var(--danger); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; display: none;">0</span>
    </div>
    <!-- í™•ì¥ íŒ¨ë„ -->
    <div id="opsBannerExpanded" style="display: none; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); width: 320px; max-height: 400px; overflow: hidden;">
      <div style="background: linear-gradient(135deg, #1E40AF, #3B82F6); color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 20px;">ğŸ¢</span>
          <span style="font-weight: 700;">ìš´ì˜ì„¼í„° í™œë™</span>
        </div>
        <button onclick="toggleOpsBanner(false)" style="background: transparent; border: none; color: white; font-size: 18px; cursor: pointer;">âœ•</button>
      </div>
      <div id="opsBannerContent" style="padding: 16px; max-height: 300px; overflow-y: auto;">
        <!-- ë™ì  ë Œë”ë§ -->
      </div>
      <div style="padding: 12px 16px; border-top: 1px solid var(--gray-100); text-align: center;">
        <a href="../operations/" style="color: var(--primary); font-size: 13px; font-weight: 600; text-decoration: none;">ìš´ì˜ì„¼í„°ë¡œ ì´ë™ â†’</a>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
      authDomain: "moyeora-deal-manager.firebaseapp.com",
      projectId: "moyeora-deal-manager",
      storageBucket: "moyeora-deal-manager.firebasestorage.app",
      messagingSenderId: "527148187832",
      appId: "1:527148187832:web:dc35b0413a7157db34744d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ìƒíƒœ ê´€ë¦¬
    let state = {
      currentTab: 'dashboard',
      deals: [],
      suppliers: [],
      sellers: [],
      sellerList: [],
      productList: [],
      projects: [],
      megaProjects: [],      // ë©”ì¸ KPI
      yearlyGoals: [],       // ì—°ë„ë³„ ëª©í‘œ
      teamKPIs: [],          // ì„ í–‰ì§€í‘œ (ë…ë¦½)
      memberKPIs: [],        // ë‚´ ì„ í–‰ì§€í‘œ (ë…ë¦½)
      tasks: [],             // ì—…ë¬´ (KPI ì—°ê²°)
      references: [],
      refCategories: [],
      teamMembers: [],
      notifications: [],     // ì•Œë¦¼ ëª©ë¡
      strategyData: {},
      strategyVersions: [],
      keywords: [],          // íŠ¸ë Œë“œ í‚¤ì›Œë“œ
      keywordSites: [],      // í‚¤ì›Œë“œ ì¶œì²˜ ì‚¬ì´íŠ¸
      topKeywords: {},       // ì›”ë³„ TOP 5 í‚¤ì›Œë“œ
      currentUser: null,
      isLoggedIn: false,
      collapsedMemberKPIs: {}  // ë‚´ ì„ í–‰ì§€í‘œ í´ë” ì ‘í˜ ìƒíƒœ
    };

    // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ (Firebaseì— ì—†ì„ ë•Œ ì‚¬ìš©)
    const DEFAULT_CATEGORIES = [
      { id: 'event', label: 'ì´ë²¤íŠ¸', emoji: 'ğŸ‰', color: '#F59E0B', bg: '#FEF3C7' },
      { id: 'design', label: 'ë””ìì¸', emoji: 'ğŸ¨', color: '#EC4899', bg: '#FCE7F3' },
      { id: 'proposal', label: 'ì œì•ˆì„œ', emoji: 'ğŸ“„', color: '#3B82F6', bg: '#DBEAFE' },
      { id: 'shortform', label: 'ìˆí¼', emoji: 'ğŸ¬', color: '#EF4444', bg: '#FEE2E2' },
      { id: 'content', label: 'ì½˜í…ì¸ ', emoji: 'âœï¸', color: '#10B981', bg: '#D1FAE5' },
      { id: 'marketing', label: 'ë§ˆì¼€íŒ…', emoji: 'ğŸ“¢', color: '#8B5CF6', bg: '#EDE9FE' },
      { id: 'etc', label: 'ê¸°íƒ€', emoji: 'ğŸ“', color: '#6B7280', bg: '#F3F4F6' }
    ];

    // ë ˆí¼ëŸ°ìŠ¤ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let refCategoryFilter = 'all';
    let refSearchQuery = '';
    let refUploadedImages = [];

    let adminPassword = 'admin1234';

    // ë¹„ë°€ë²ˆí˜¸ ë¡œë“œ
    async function loadAdminPassword() {
      try {
        const doc = await db.collection('settings').doc('admin').get();
        if (doc.exists && doc.data().password) {
          adminPassword = doc.data().password;
        }
      } catch (e) {
        console.error('ë¹„ë°€ë²ˆí˜¸ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    function checkLoginStatus() {
      const isLoggedIn = sessionStorage.getItem('moyeora_admin_logged_in') === 'true';
      if (isLoggedIn) {
        state.isLoggedIn = true;
        showApp();
      } else {
        showLogin();
      }
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    async function handleLogin() {
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');

      if (password === adminPassword) {
        state.isLoggedIn = true;
        sessionStorage.setItem('moyeora_admin_logged_in', 'true');
        showApp();
      } else {
        errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        errorEl.classList.add('show');
      }
    }

    // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
    function showLogin() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('appScreen').style.display = 'none';
    }

    // ì•± í™”ë©´ í‘œì‹œ
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appScreen').style.display = 'flex';
      setupListeners();

      // URL íŒŒë¼ë¯¸í„°ë¡œ íƒ­ ì „í™˜ (ì˜ˆ: ?tab=worklog)
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab');
      if (tabParam) {
        setTimeout(() => switchTab(tabParam), 100);
      } else {
        // ì˜ì—…í˜„í™© ì´ˆê¸° ë Œë”ë§
        setTimeout(() => renderSalesDashboard(), 100);
      }
    }

    // Firebase ë¦¬ìŠ¤ë„ˆ
    function setupListeners() {
      db.collection('deals').orderBy('startDate', 'desc').onSnapshot(snapshot => {
        state.deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      db.collection('suppliers').orderBy('name').onSnapshot(snapshot => {
        state.suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      db.collection('projects').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      db.collection('references').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.references = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'reference') renderReferences();
      });

      // ì¹´í…Œê³ ë¦¬ ë¦¬ìŠ¤ë„ˆ
      db.collection('refCategories').orderBy('order', 'asc').onSnapshot(snapshot => {
        if (snapshot.empty) {
          state.refCategories = DEFAULT_CATEGORIES;
        } else {
          state.refCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        renderCategoryFilters();
        renderCategoryOptions();
      });

      db.collection('sellers').orderBy('name').onSnapshot(snapshot => {
        state.sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      // ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° (íŒŒì´í”„ë¼ì¸/ì˜¨ë³´ë”©ìš©)
      db.collection('sellerList').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.sellerList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ì…€ëŸ¬ ì œì•ˆ ë°ì´í„° (ì•„ì›ƒë°”ìš´ë“œ íŒŒì´í”„ë¼ì¸ìš© - ì…ì  ì œì•ˆë§Œ)
      db.collection('sellerProposals').where('type', '==', 'recruitment').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.sellerProposals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° (íŒŒì´í”„ë¼ì¸/ì˜¨ë³´ë”©ìš©)
      db.collection('productList').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.productList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ì…€ëŸ¬ ì •ì‚° ë°ì´í„° (ì˜ì—…í˜„í™©ìš©)
      db.collection('sellerSettlements').orderBy('settlementDate', 'desc').onSnapshot(snapshot => {
        state.sellerSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ê³µê¸‰ì‚¬ ì •ì‚° ë°ì´í„° (ì˜ì—…í˜„í™©ìš©)
      db.collection('supplierSettlements').orderBy('settlementDate', 'desc').onSnapshot(snapshot => {
        state.supplierSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      });

      // íŒ€ì› ë°ì´í„° (ì˜ì—…í˜„í™©ìš©)
      db.collection('teamMembers').orderBy('name').onSnapshot(snapshot => {
        state.teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ì•Œë¦¼ ë°ì´í„°
      db.collection('notifications').orderBy('createdAt', 'desc').limit(50).onSnapshot(snapshot => {
        state.notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateNotificationBadge();
      });

      // ì „ëµ ì„¤ì • ë°ì´í„° (ëª©í‘œì¹˜)
      db.collection('settings').doc('strategy').onSnapshot(doc => {
        if (doc.exists) {
          state.strategyData = doc.data();
        }
      });

      // ì—°ë„ë³„ ëª©í‘œ ë°ì´í„°
      db.collection('yearlyGoals').orderBy('year', 'asc').onSnapshot(snapshot => {
        state.yearlyGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ë©”ì¸ KPI ë°ì´í„°
      db.collection('megaProjects').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.megaProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'kpi') renderKPIManagement();
      });

      // ì„ í–‰ì§€í‘œ ë°ì´í„° (ë…ë¦½ ì»¬ë ‰ì…˜)
      db.collection('teamKPIs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.teamKPIs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'kpi') renderKPIManagement();
      });

      // ë‚´ ì„ í–‰ì§€í‘œ ë°ì´í„° (ë…ë¦½ ì»¬ë ‰ì…˜)
      db.collection('memberKPIs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.memberKPIs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'kpi') renderKPIManagement();
      });

      // ì—…ë¬´ ë°ì´í„° (KPI ì—°ê²°)
      db.collection('tasks').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'worklog') renderWorkLog();
      });

      // ì „ëµ ë²„ì „ íˆìŠ¤í† ë¦¬
      db.collection('strategyVersions').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.strategyVersions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      });

      // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
      loadCurrentUser();
    }

    // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    async function loadCurrentUser() {
      try {
        const loginId = sessionStorage.getItem('moyeora_login_id');
        if (loginId) {
          const snapshot = await db.collection('teamMembers').where('loginId', '==', loginId).get();
          if (!snapshot.empty) {
            state.currentUser = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
          }
        }
        // ê¸°ë³¸ê°’ ì„¤ì • (ê´€ë¦¬ìë¡œ ê°€ì •)
        if (!state.currentUser) {
          state.currentUser = { id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin', loginId: 'admin' };
        }
      } catch (e) {
        console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', e);
        state.currentUser = { id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin', loginId: 'admin' };
      }
    }

    // íƒ­ ì „í™˜
    function switchTab(tabId) {
      state.currentTab = tabId;

      // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™” (nav-item)
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-tab') === tabId) {
          item.classList.add('active');
        }
      });

      // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™” (nav-submenu-item for OKR)
      document.querySelectorAll('.nav-submenu-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-tab') === tabId) {
          item.classList.add('active');
          item.style.background = 'var(--primary-light)';
          item.style.color = 'var(--primary)';
          item.style.fontWeight = '600';
        } else {
          item.style.background = '';
          item.style.color = '';
          item.style.fontWeight = '';
        }
      });

      // íƒ­ ì»¨í…ì¸  í‘œì‹œ
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      const tabEl = document.getElementById(`tab-${tabId}`);
      if (tabEl) tabEl.classList.add('active');

      render();

      // OKR íƒ­ ì—¬ë¶€ í™•ì¸ í›„ ìš´ì˜ì„¼í„° ë°°ë„ˆ í‘œì‹œ/ìˆ¨ê¹€
      const isOkrTab = tabId.startsWith('okr-');
      if (isOkrTab) {
        showOpsCenterBanner();
      } else {
        hideOpsCenterBanner();
      }

      // íƒ­ë³„ ë Œë”ë§
      switch(tabId) {
        case 'dashboard': renderSalesDashboard(); break;
        case 'kpi': renderKPIManagement(); break;
        case 'worklog': renderWorkLog(); break;
        case 'review': renderStrategicReview(); break;
        case 'guide': renderGuide(); break;
        case 'reference': renderReferences(); break;
        case 'trendKeywords': renderTrendKeywords(); break;
        // OKR íƒ­ë“¤
        case 'okr-dashboard': renderOkrDashboard(); break;
        case 'okr-personal-dashboard': renderPersonalGrowthboard(); break;
        case 'okr-record': renderOkrRecord(); break;
        case 'okr-settings': renderOkrSettings(); break;
        case 'okr-experiment': renderOkrExperiment(); break;
        case 'meeting-history': renderMeetingHistory(); break;
        case 'change-logs': renderChangeLogs(); break;
      }
    }

    // ========================================
    // ë¯¸íŒ… íˆìŠ¤í† ë¦¬ ê´€ë¦¬
    // ========================================

    let meetingHistoryFilter = { type: 'all', search: '' };

    // ë¯¸íŒ… íˆìŠ¤í† ë¦¬ ë Œë”ë§
    function renderMeetingHistory() {
      // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
      const meetings = okrState.meetings || [];
      const now = new Date();
      const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      const totalCount = meetings.length;
      const scheduledCount = meetings.filter(m => m.status === MEETING_STATUS.SCHEDULED).length;
      const completedCount = meetings.filter(m => m.status === MEETING_STATUS.COMPLETED).length;
      const thisMonthCount = meetings.filter(m => m.date && m.date.startsWith(thisMonth)).length;

      const totalEl = document.getElementById('meetingTotalCount');
      const scheduledEl = document.getElementById('meetingScheduledCount');
      const completedEl = document.getElementById('meetingCompletedCount');
      const thisMonthEl = document.getElementById('meetingThisMonthCount');

      if (totalEl) totalEl.textContent = totalCount + 'ê±´';
      if (scheduledEl) scheduledEl.textContent = scheduledCount;
      if (completedEl) completedEl.textContent = completedCount;
      if (thisMonthEl) thisMonthEl.textContent = thisMonthCount;

      filterMeetingHistory();
    }

    // ë¯¸íŒ… íƒ€ì… í•„í„° ì„¤ì •
    function setMeetingTypeFilter(type) {
      meetingHistoryFilter.type = type;

      // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.meeting-type-btn').forEach(btn => {
        if (btn.getAttribute('data-type') === type) {
          btn.style.background = 'var(--primary)';
          btn.style.color = 'white';
          btn.style.fontWeight = '600';
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
          const btnType = btn.getAttribute('data-type');
          if (btnType === 'all') {
            btn.style.background = 'var(--gray-100)';
            btn.style.color = 'var(--gray-700)';
          } else if (btnType === 'CEO_REPORT') {
            btn.style.background = '#EDE9FE';
            btn.style.color = '#7C3AED';
          } else if (btnType === 'KPI_REVIEW') {
            btn.style.background = '#E8F3FF';
            btn.style.color = '#0064FF';
          } else if (btnType === 'CONFIRM') {
            btn.style.background = '#DCFCE7';
            btn.style.color = '#16A34A';
          } else if (btnType === 'PARTNER') {
            btn.style.background = '#FEF3C7';
            btn.style.color = '#B45309';
          }
          btn.style.fontWeight = '500';
        }
      });

      filterMeetingHistory();
    }

    // ë¯¸íŒ… íˆìŠ¤í† ë¦¬ í•„í„°ë§
    function filterMeetingHistory() {
      const searchInput = document.getElementById('meetingSearch');
      meetingHistoryFilter.search = searchInput ? searchInput.value.toLowerCase() : '';

      const meetings = okrState.meetings || [];
      const filtered = meetings.filter(m => {
        // ë‹¤ì¤‘ íƒ€ì… í•„í„°ë§ ì§€ì›
        const mTypes = m.types || [m.type];
        const matchType = meetingHistoryFilter.type === 'all' || mTypes.includes(meetingHistoryFilter.type);
        // ê²€ìƒ‰ ë²”ìœ„ í™•ì¥: ì œëª©, ë…¼ì˜ë‚´ìš©, ëª©í‘œ, ë…¸íŠ¸, ìš”ì²­, ì°¸ì„ì
        const matchSearch = !meetingHistoryFilter.search ||
          m.title.toLowerCase().includes(meetingHistoryFilter.search) ||
          (m.preAgenda || '').toLowerCase().includes(meetingHistoryFilter.search) ||
          (m.preGoals || '').toLowerCase().includes(meetingHistoryFilter.search) ||
          (m.notes || '').toLowerCase().includes(meetingHistoryFilter.search) ||
          (m.requestsReceived || '').toLowerCase().includes(meetingHistoryFilter.search) ||
          (m.requestsMade || '').toLowerCase().includes(meetingHistoryFilter.search) ||
          (m.participants || []).some(p => p.toLowerCase().includes(meetingHistoryFilter.search));
        return matchType && matchSearch;
      });

      // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
      filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

      renderMeetingHistoryList(filtered);
    }

    // ë¯¸íŒ… íˆìŠ¤í† ë¦¬ ëª©ë¡ ë Œë”ë§
    function renderMeetingHistoryList(meetings) {
      const container = document.getElementById('meetingHistoryList');
      if (!container) return;

      if (meetings.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px; background: white; border-radius: 16px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“…</div>
            <div style="font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ë“±ë¡ëœ ë¯¸íŒ…ì´ ì—†ìŠµë‹ˆë‹¤</div>
            <p style="color: var(--gray-600); margin-bottom: 20px;">ìƒˆë¡œìš´ ë¯¸íŒ…ì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
            <button onclick="openMeetingModal()" class="btn btn-primary">+ ì²« ë¯¸íŒ… ë“±ë¡</button>
          </div>
        `;
        return;
      }

      // ì›”ë³„ë¡œ ê·¸ë£¹í™”
      const grouped = {};
      meetings.forEach(m => {
        const monthKey = m.date.substring(0, 7); // YYYY-MM
        if (!grouped[monthKey]) grouped[monthKey] = [];
        grouped[monthKey].push(m);
      });

      let html = '';
      Object.keys(grouped).sort().reverse().forEach(month => {
        const monthMeetings = grouped[month];
        const [year, mon] = month.split('-');
        html += `
          <div style="margin-bottom: 24px;">
            <div style="font-size: 14px; font-weight: 700; color: var(--gray-500); margin-bottom: 12px; padding-left: 4px;">
              ${year}ë…„ ${parseInt(mon)}ì›” (${monthMeetings.length}ê±´)
            </div>
            <div style="display: grid; gap: 12px;">
        `;

        monthMeetings.forEach(m => {
          const meetingType = Object.values(MEETING_TYPES).find(t => t.id === m.type);
          const statusColors = {
            [MEETING_STATUS.SCHEDULED]: { bg: '#E8F3FF', color: '#0064FF', label: 'ì˜ˆì •' },
            [MEETING_STATUS.IN_PROGRESS]: { bg: '#FEF3C7', color: '#B45309', label: 'ì§„í–‰ì¤‘' },
            [MEETING_STATUS.COMPLETED]: { bg: '#DCFCE7', color: '#16A34A', label: 'ì™„ë£Œ' },
            [MEETING_STATUS.CANCELLED]: { bg: '#FEE2E2', color: '#DC2626', label: 'ì·¨ì†Œ' }
          };
          const statusInfo = statusColors[m.status] || statusColors[MEETING_STATUS.SCHEDULED];

          // ì—°ê²°ëœ KR ì •ë³´
          const linkedKRs = m.isAllKRs
            ? okrState.keyResults
            : (m.krIds || [m.krId]).filter(id => id).map(id => okrState.keyResults.find(kr => kr.id === id)).filter(kr => kr);

          html += `
            <div onclick="openMeetingDetailModal('${m.id}')"
                 style="background: white; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #E5E8EB;"
                 onmouseover="this.style.borderColor='${meetingType?.color || '#6366F1'}'; this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.borderColor='#E5E8EB'; this.style.transform='none'">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 44px; height: 44px; border-radius: 12px; background: ${meetingType?.color || '#6366F1'}20; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                    ${meetingType?.icon || 'ğŸ“…'}
                  </div>
                  <div>
                    <div style="font-size: 16px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">${m.title}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">
                      ${meetingType?.name || m.type} Â· ${m.date} ${m.time || ''}
                    </div>
                  </div>
                </div>
                <span style="font-size: 11px; padding: 4px 10px; background: ${statusInfo.bg}; color: ${statusInfo.color}; border-radius: 6px; font-weight: 600;">${statusInfo.label}</span>
              </div>

              ${m.preAgenda ? `
                <div style="font-size: 13px; color: var(--gray-600); margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;">
                  ${m.preAgenda}
                </div>
              ` : ''}

              <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
                ${m.participants?.length > 0 ? `
                  <span style="font-size: 11px; padding: 4px 8px; background: var(--gray-100); color: var(--gray-600); border-radius: 4px;">
                    ğŸ‘¥ ${m.participants.join(', ')}
                  </span>
                ` : ''}
                ${linkedKRs.length > 0 ? `
                  <span style="font-size: 11px; padding: 4px 8px; background: #EDE9FE; color: #7C3AED; border-radius: 4px;">
                    ğŸ¯ ${m.isAllKRs ? 'ì „ì²´ KR' : linkedKRs.length + 'ê°œ KR ì—°ê²°'}
                  </span>
                ` : ''}
                ${m.status === MEETING_STATUS.COMPLETED && m.postSummary ? `
                  <span style="font-size: 11px; padding: 4px 8px; background: #DCFCE7; color: #16A34A; border-radius: 4px;">ğŸ“ íšŒì˜ë¡ ì‘ì„±ë¨</span>
                ` : ''}
              </div>
            </div>
          `;
        });

        html += '</div></div>';
      });

      container.innerHTML = html;
    }

    // ë³€ê²½ì´ë ¥ ë Œë”ë§
    async function renderChangeLogs() {
      const container = document.getElementById('changeLogsContent');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-500);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      try {
        const snapshot = await db.collection('okr_changeLogs')
          .orderBy('timestamp', 'desc')
          .limit(100)
          .get();

        const logs = [];
        snapshot.forEach(doc => logs.push({ id: doc.id, ...doc.data() }));

        if (logs.length === 0) {
          container.innerHTML = `
            <div class="card" style="text-align: center; padding: 60px;">
              <div style="font-size: 64px; margin-bottom: 16px;">ğŸ“‹</div>
              <div style="font-size: 18px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>
              <div style="font-size: 14px; color: var(--gray-500);">ëª©í‘œì„¤ì •, ì—…ë¬´ê¸°ë¡ ë“±ì—ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë©´<br>ì´ê³³ì— ì´ë ¥ì´ ê¸°ë¡ë©ë‹ˆë‹¤.</div>
            </div>
          `;
          return;
        }

        const getActionLabel = (action) => {
          switch (action) {
            case 'create': return { text: 'ì¶”ê°€', color: 'var(--success)', bg: 'var(--success-light)' };
            case 'update': return { text: 'ìˆ˜ì •', color: 'var(--primary)', bg: 'var(--primary-light)' };
            case 'delete': return { text: 'ì‚­ì œ', color: 'var(--danger)', bg: 'var(--danger-light)' };
            default: return { text: action, color: 'var(--gray-600)', bg: 'var(--gray-100)' };
          }
        };

        const getEntityLabel = (type) => {
          switch (type) {
            case 'laggingIndicator': return 'ì§€í‘œ';
            case 'kpi': return 'KPI';
            case 'keyResult': return 'KR';
            case 'dailyLog': return 'ì—…ë¬´ê¸°ë¡';
            default: return type;
          }
        };

        const formatTimestamp = (ts) => {
          if (!ts) return '-';
          const date = ts.toDate ? ts.toDate() : new Date(ts);
          return date.toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });
        };

        container.innerHTML = `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="font-size: 16px; font-weight: 700;">ìµœê·¼ ë³€ê²½ ì´ë ¥ (${logs.length}ê±´)</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px; max-height: 600px; overflow-y: auto;">
              ${logs.map(log => {
                const action = getActionLabel(log.action);
                const entity = getEntityLabel(log.entityType);
                let detail = '';

                if (log.data?.changes) {
                  const changes = log.data.changes;
                  if (changes.name) {
                    detail = `"${changes.name.from}" â†’ "${changes.name.to}"`;
                  }
                } else if (log.data?.name) {
                  detail = `"${log.data.name}"`;
                }

                return `
                  <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: 10px;">
                    <span style="background: ${action.bg}; color: ${action.color}; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; white-space: nowrap;">${action.text}</span>
                    <div style="flex: 1;">
                      <div style="font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">
                        ${entity} ${detail}
                      </div>
                      <div style="font-size: 12px; color: var(--gray-500);">
                        ${log.userName || 'ì‚¬ìš©ì'} Â· ${formatTimestamp(log.timestamp)}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      } catch (e) {
        console.error('ë³€ê²½ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', e);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">ë¡œë“œ ì‹¤íŒ¨</div>';
      }
    }

    // OKR ê¸°ê°„ ì „í™˜
    function switchOkrPeriod(period) {
      // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
      document.querySelectorAll('#tab-okr .tab-nav .tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // ê¸°ê°„ ìƒíƒœ ì €ì¥
      okrState.okrPeriod = period;

      // ê¸°ê°„ë³„ OKR ë°ì´í„° ë¡œë“œ
      const container = document.getElementById('okrContent');
      if (!container) return;

      // ê¸°ê°„ ì •ë³´ í‘œì‹œ
      let periodInfo = '';
      const today = new Date();

      if (period === 'quarterly') {
        const quarter = Math.floor(today.getMonth() / 3) + 1;
        periodInfo = `${today.getFullYear()}ë…„ Q${quarter}`;
      } else if (period === 'monthly') {
        periodInfo = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›”`;
      } else if (period === 'weekly') {
        const weekNum = Math.ceil((today.getDate()) / 7);
        periodInfo = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${weekNum}ì£¼ì°¨`;
      }

      // OKR ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
      if (!okrState.objective || okrState.keyResults.length === 0) {
        container.innerHTML = `
          <div class="card" style="text-align: center; padding: 60px;">
            <div style="font-size: 64px; margin-bottom: 16px;">ğŸ“…</div>
            <div style="font-size: 18px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">${periodInfo}</div>
            <div style="font-size: 14px; color: var(--gray-500); margin-bottom: 20px;">í•´ë‹¹ ê¸°ê°„ì˜ OKR ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 13px; color: var(--gray-400);">ê·¸ë¡œìŠ¤ë³´ë“œ íƒ­ì—ì„œ ì‹¤ì‹œê°„ OKR í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</div>
          </div>
        `;
        return;
      }

      // ê¸°ê°„ë³„ ë¡œê·¸ í•„í„°ë§
      let filteredLogs = okrState.dailyLogs;
      const startDate = new Date();

      if (period === 'quarterly') {
        // ë¶„ê¸°ë³„: í˜„ì¬ ë¶„ê¸°ì˜ ì²«ë‚ ë¶€í„°
        const quarter = Math.floor(today.getMonth() / 3);
        startDate.setMonth(quarter * 3, 1);
      } else if (period === 'monthly') {
        // ì›”ë³„: í˜„ì¬ ì›”ì˜ ì²«ë‚ ë¶€í„°
        startDate.setDate(1);
      } else if (period === 'weekly') {
        // ì£¼ê°„: ì´ë²ˆ ì£¼ ì›”ìš”ì¼ë¶€í„°
        const dayOfWeek = today.getDay();
        const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        startDate.setDate(today.getDate() - diff);
      }

      startDate.setHours(0, 0, 0, 0);
      const startDateStr = startDate.toISOString().split('T')[0];
      filteredLogs = okrState.dailyLogs.filter(log => log.date >= startDateStr);

      // KRë³„ ë‹¬ì„±ë¥  ê³„ì‚° (í•„í„°ë§ëœ ë¡œê·¸ ê¸°ì¤€)
      const krRates = okrState.keyResults.map(kr => {
        const kpisForKR = okrState.kpis.filter(k => k.keyResultId === kr.id);
        if (kpisForKR.length === 0) return { ...kr, rate: 0 };

        const rates = kpisForKR.map(kpi => {
          if (!kpi.targetValue) return 0;
          const lagsForKPI = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id && l.type === 'result');
          const totalValue = lagsForKPI.reduce((sum, lag) => {
            const logs = filteredLogs.filter(l => l.laggingIndicatorId === lag.id);
            const logSum = logs.reduce((s, l) => s + (l.resultValue || 0), 0);
            return sum + (lag.valuePerUnit > 0 ? logSum * lag.valuePerUnit : logSum);
          }, 0);
          return Math.min(Math.round((totalValue / kpi.targetValue) * 100), 100);
        });

        const avgRate = Math.round(rates.reduce((a, b) => a + b, 0) / rates.length);
        return { ...kr, rate: avgRate };
      });

      // OKR ì½˜í…ì¸  ë Œë”ë§
      container.innerHTML = `
        <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, var(--primary), #8B5CF6); border-radius: 12px; color: white;">
          <div style="font-size: 14px; font-weight: 600; opacity: 0.9; margin-bottom: 8px;">ğŸ“… ${periodInfo}</div>
          <div style="font-size: 18px; font-weight: 700; line-height: 1.4;">${okrState.objective.name}</div>
        </div>

        ${krRates.map((kr, idx) => `
          <div class="okr-objective" style="margin-bottom: 16px;">
            <div class="okr-objective-title" style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: ${okrColors[idx]}10; border-left: 4px solid ${okrColors[idx]}; border-radius: 8px; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span>${okrIcons[idx] || 'ğŸ“Š'}</span>
                <span style="font-weight: 600; color: var(--gray-800);">${kr.name}</span>
              </div>
              <span style="padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; background: ${okrColors[idx]}20; color: ${okrColors[idx]}">${kr.rate}%</span>
            </div>
            ${okrState.kpis.filter(k => k.keyResultId === kr.id).map(kpi => {
              const lagsForKPI = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
              const currentValue = lagsForKPI.reduce((sum, lag) => {
                const logs = filteredLogs.filter(l => l.laggingIndicatorId === lag.id);
                const logSum = logs.reduce((s, l) => s + (l.resultValue || 0), 0);
                return sum + (lag.valuePerUnit > 0 ? logSum * lag.valuePerUnit : logSum);
              }, 0);
              const kpiRate = kpi.targetValue > 0 ? Math.min(Math.round((currentValue / kpi.targetValue) * 100), 100) : 0;

              return `
                <div class="okr-key-result" style="margin-bottom: 8px; padding: 12px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);">
                  <div class="okr-kr-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="okr-kr-title" style="font-size: 14px; font-weight: 500; color: var(--gray-700);">${kpi.name}</span>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <span style="font-size: 12px; color: var(--gray-500);">${formatAmountWithSummary(currentValue, kpi.unit || '')} / ${formatAmountWithSummary(kpi.targetValue || 0, kpi.unit || '')}</span>
                      <span class="okr-kr-progress" style="font-weight: 700; color: ${kpiRate >= 80 ? 'var(--success)' : kpiRate >= 50 ? 'var(--warning)' : 'var(--danger)'};">${kpiRate}%</span>
                    </div>
                  </div>
                  <div class="okr-progress-bar" style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                    <div class="okr-progress-fill" style="height: 100%; width: ${kpiRate}%; background: ${kpiRate >= 80 ? 'var(--success)' : kpiRate >= 50 ? 'var(--warning)' : 'var(--danger)'}; border-radius: 3px; transition: width 0.5s;"></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `).join('')}

        <div style="margin-top: 20px; padding: 16px; background: var(--gray-50); border-radius: 8px; text-align: center;">
          <div style="font-size: 13px; color: var(--gray-500);">ğŸ’¡ ìì„¸í•œ í˜„í™©ì€ <a href="#" onclick="switchTab('okr-dashboard'); return false;" style="color: var(--primary); font-weight: 600; text-decoration: none;">ê·¸ë¡œìŠ¤ë³´ë“œ íƒ­</a>ì—ì„œ í™•ì¸í•˜ì„¸ìš”</div>
        </div>
      `;

      showToast(`${periodInfo} OKR ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`, 'success');
    }

    // ì‚¬ì´ë“œë°” í† ê¸€
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('show');
    }

    // ë Œë”ë§
    function render() {
      // ê·¸ë¡œìŠ¤ë³´ë“œ ì§€í‘œ (null ì²´í¬)
      const conversionRateEl = document.getElementById('conversionRate');
      const avgDealDaysEl = document.getElementById('avgDealDays');
      const repeatRateEl = document.getElementById('repeatRate');
      const npsScoreEl = document.getElementById('npsScore');

      if (conversionRateEl) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const activeDeals = state.deals.filter(deal => {
          const start = new Date(deal.startDate);
          const end = new Date(deal.endDate);
          return today >= start && today <= end;
        });
        conversionRateEl.textContent = state.deals.length > 0 ? `${((activeDeals.length / state.deals.length) * 100).toFixed(1)}%` : '-';
      }
      if (avgDealDaysEl) avgDealDaysEl.textContent = '7ì¼';
      if (repeatRateEl) repeatRateEl.textContent = '-';
      if (npsScoreEl) npsScoreEl.textContent = '-';

      // ëŒ€ì‹œë³´ë“œ - ë„ë©”ì¸ë³„ ë°ì´í„° ì—…ë°ì´íŠ¸
      const domainSuppliersEl = document.getElementById('domainSuppliers');
      if (domainSuppliersEl) {
        domainSuppliersEl.textContent = (state.suppliers?.length || 0) + 'ê°œ';
      }

      // ëŒ€ì‹œë³´ë“œ - ì˜ì—… ì‹¤ì  ì—…ë°ì´íŠ¸
      const salesStatsEl = document.getElementById('salesStats');
      if (salesStatsEl) {
        salesStatsEl.innerHTML = `
          <span style="font-size: 11px; padding: 4px 10px; background: #dbeafe; color: #2563eb; border-radius: 4px;">ğŸ‘¥ ì…€ëŸ¬ ${state.sellers?.length || 0}ëª…</span>
          <span style="font-size: 11px; padding: 4px 10px; background: #dbeafe; color: #2563eb; border-radius: 4px;">ğŸ“¦ ê³µêµ¬ ${state.deals?.length || 0}ê±´</span>
        `;
      }
    }

    // í”„ë¡œì íŠ¸ ëª¨ë‹¬ ì—´ê¸° (êµ¬ë²„ì „ - ë¯¸ì‚¬ìš©)
    function openProjectModal(project = null) {
      const modal = document.getElementById('projectModal');
      const title = document.getElementById('projectModalTitle');
      const deleteBtn = document.getElementById('deleteProjectBtn');

      // í¼ ì´ˆê¸°í™”
      document.getElementById('projectId').value = project?.id || '';
      document.getElementById('projectName').value = project?.name || '';
      document.getElementById('projectDesc').value = project?.description || '';
      document.getElementById('projectRevenueGoal').value = project?.revenueGoal || '';
      document.getElementById('projectStartDate').value = project?.startDate || '';
      document.getElementById('projectEndDate').value = project?.endDate || '';
      document.getElementById('projectStatus').value = project?.status || 'active';

      // KPI ì´ˆê¸°í™”
      document.getElementById('teamKPIList').innerHTML = '';
      document.getElementById('memberKPIList').innerHTML = '';

      if (project) {
        title.textContent = 'í”„ë¡œì íŠ¸ ìˆ˜ì •';
        deleteBtn.style.display = 'block';
        // ê¸°ì¡´ ì„ í–‰ì§€í‘œ ë¡œë“œ
        (project.teamKPIs || []).forEach(kpi => addTeamKPI(kpi));
        // ê¸°ì¡´ ê°œë³„ KPI ë¡œë“œ
        (project.memberKPIs || []).forEach(kpi => addMemberKPI(kpi));
      } else {
        title.textContent = 'í”„ë¡œì íŠ¸ ì¶”ê°€';
        deleteBtn.style.display = 'none';
        // ê¸°ë³¸ KPI í•˜ë‚˜ì”© ì¶”ê°€
        addTeamKPI();
      }

      modal.classList.add('show');
    }

    function closeProjectModal() {
      document.getElementById('projectModal').classList.remove('show');
    }

    // ë²”ìš© ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.className = 'modal';
        modal.innerHTML = '';
      }
    }

    // ========================================
    // ì•Œë¦¼ ì„¼í„° ê¸°ëŠ¥
    // ========================================

    // ì•Œë¦¼ íŒ¨ë„ í† ê¸€
    function toggleNotificationPanel() {
      const panel = document.getElementById('notificationPanel');
      if (panel) {
        const isVisible = panel.style.display !== 'none';
        panel.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) {
          renderNotificationList();
        }
      }
    }

    // ì•Œë¦¼ ë±ƒì§€ ì—…ë°ì´íŠ¸
    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      const currentUserId = state.currentUser?.id;
      if (!badge || !currentUserId) return;

      // í˜„ì¬ ì‚¬ìš©ìì—ê²Œ ì˜¨ ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜
      const unreadCount = (state.notifications || []).filter(n =>
        !n.isRead &&
        (n.recipientId === currentUserId || n.recipientId === 'all')
      ).length;

      if (unreadCount > 0) {
        badge.style.display = 'flex';
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      } else {
        badge.style.display = 'none';
      }
    }

    // ì•Œë¦¼ ëª©ë¡ ë Œë”ë§
    function renderNotificationList() {
      const container = document.getElementById('notificationList');
      if (!container) return;

      const currentUserId = state.currentUser?.id;
      const myNotifications = (state.notifications || []).filter(n =>
        n.recipientId === currentUserId || n.recipientId === 'all'
      );

      if (myNotifications.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray-500); font-size: 13px;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      container.innerHTML = myNotifications.map(notif => {
        const timeAgo = getTimeAgo(notif.createdAt);
        const isUnread = !notif.isRead;

        return `
          <div onclick="handleNotificationClick('${notif.id}', '${notif.type || ''}', '${notif.targetId || ''}')"
               style="padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; transition: background 0.2s;
                      background: ${isUnread ? 'var(--primary-light)' : 'white'}; border-left: 3px solid ${isUnread ? 'var(--primary)' : 'transparent'};"
               onmouseover="this.style.background='var(--gray-100)'"
               onmouseout="this.style.background='${isUnread ? 'var(--primary-light)' : 'white'}'">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <span style="font-size: 18px;">${getNotificationIcon(notif.type)}</span>
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 13px; font-weight: ${isUnread ? '600' : '500'}; color: var(--gray-800); margin-bottom: 4px; line-height: 1.4;">
                  ${notif.message}
                </div>
                <div style="font-size: 11px; color: var(--gray-500);">${timeAgo}</div>
              </div>
              ${isUnread ? '<span style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%; flex-shrink: 0;"></span>' : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // ì•Œë¦¼ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
    function getNotificationIcon(type) {
      switch (type) {
        case 'meeting_reminder': return 'ğŸ“…';
        case 'meeting_invite': return 'ğŸ“¬';
        case 'task_assigned': return 'ğŸ“‹';
        case 'task_completed': return 'âœ…';
        case 'kpi_update': return 'ğŸ“Š';
        default: return 'ğŸ””';
      }
    }

    // ì‹œê°„ í¬ë§·íŒ…
    function getTimeAgo(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
      if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
      if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
      if (diffDays < 7) return `${diffDays}ì¼ ì „`;
      return date.toLocaleDateString('ko-KR');
    }

    // ì•Œë¦¼ í´ë¦­ ì²˜ë¦¬
    async function handleNotificationClick(notifId, type, targetId) {
      // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
      try {
        await db.collection('notifications').doc(notifId).update({ isRead: true });
      } catch (e) {
        console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
      }

      // íƒ€ì…ì— ë”°ë¥¸ ë™ì‘
      if (type === 'meeting_reminder' || type === 'meeting_invite') {
        toggleNotificationPanel();
        if (targetId) {
          openMeetingDetailModal(targetId);
        }
      }
    }

    // ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
    async function markAllNotificationsRead() {
      const currentUserId = state.currentUser?.id;
      if (!currentUserId) return;

      const myUnreadNotifs = (state.notifications || []).filter(n =>
        !n.isRead && (n.recipientId === currentUserId || n.recipientId === 'all')
      );

      try {
        const batch = db.batch();
        myUnreadNotifs.forEach(notif => {
          batch.update(db.collection('notifications').doc(notif.id), { isRead: true });
        });
        await batch.commit();
        showToast('ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤', 'success');
        renderNotificationList();
      } catch (e) {
        console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
      }
    }

    // ì•Œë¦¼ ìƒì„± í•¨ìˆ˜
    async function createNotification(recipientId, type, message, targetId = null) {
      try {
        await db.collection('notifications').add({
          recipientId: recipientId,
          type: type,
          message: message,
          targetId: targetId,
          isRead: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        console.error('ì•Œë¦¼ ìƒì„± ì˜¤ë¥˜:', e);
      }
    }

    // ë¯¸íŒ… ì•Œë¦¼ ìƒì„± (ë¯¸íŒ… ì €ì¥ ì‹œ í˜¸ì¶œ)
    async function createMeetingNotifications(meetingData, meetingId) {
      const participantIds = meetingData.participantIds || [];
      const meetingTitle = meetingData.title;
      const meetingDate = meetingData.date;
      const meetingTime = meetingData.time || '';

      for (const participantId of participantIds) {
        // ë¯¸íŒ… ì´ˆëŒ€ ì•Œë¦¼
        await createNotification(
          participantId,
          'meeting_invite',
          `"${meetingTitle}" ë¯¸íŒ…ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤ (${meetingDate} ${meetingTime})`,
          meetingId
        );
      }
    }

    // ë¯¸íŒ… ë¦¬ë§ˆì¸ë” ì²´í¬ (í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰)
    async function checkMeetingReminders() {
      const now = new Date();
      const currentUserId = state.currentUser?.id;
      if (!currentUserId) return;

      const meetings = okrState.meetings || [];

      for (const meeting of meetings) {
        if (meeting.status === 'completed') continue;

        const participantIds = meeting.participantIds || [];
        if (!participantIds.includes(currentUserId)) continue;

        const reminders = meeting.reminders || [60]; // ê¸°ë³¸ 1ì‹œê°„ ì „
        const meetingDateTime = new Date(`${meeting.date}T${meeting.time || '09:00'}`);

        for (const reminderMin of reminders) {
          if (reminderMin === 0) continue; // ì•Œë¦¼ ì—†ìŒ

          const reminderTime = new Date(meetingDateTime.getTime() - reminderMin * 60000);
          const diffMs = reminderTime - now;

          // ì•Œë¦¼ ì‹œê°„ì´ ì§€ë‚¬ê³ , ë¯¸íŒ… ì‹œê°„ì€ ì•„ì§ ì•ˆ ì§€ë‚œ ê²½ìš°
          if (diffMs < 0 && meetingDateTime > now) {
            // ì´ë¯¸ ìƒì„±ëœ ë¦¬ë§ˆì¸ë”ì¸ì§€ í™•ì¸
            const existingReminder = (state.notifications || []).find(n =>
              n.type === 'meeting_reminder' &&
              n.targetId === meeting.id &&
              n.recipientId === currentUserId &&
              n.reminderMin === reminderMin
            );

            if (!existingReminder) {
              const timeLabel = reminderMin === 10 ? '10ë¶„' : reminderMin === 30 ? '30ë¶„' : reminderMin === 60 ? '1ì‹œê°„' : reminderMin === 1440 ? '1ì¼' : `${reminderMin}ë¶„`;
              await db.collection('notifications').add({
                recipientId: currentUserId,
                type: 'meeting_reminder',
                message: `"${meeting.title}" ë¯¸íŒ…ì´ ${timeLabel} í›„ì— ì‹œì‘ë©ë‹ˆë‹¤`,
                targetId: meeting.id,
                reminderMin: reminderMin,
                isRead: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
        }
      }
    }

    // í˜ì´ì§€ ì™¸ë¶€ í´ë¦­ ì‹œ ì•Œë¦¼ íŒ¨ë„ ë‹«ê¸°
    document.addEventListener('click', function(e) {
      const panel = document.getElementById('notificationPanel');
      const bell = document.getElementById('notificationBell');
      if (panel && bell && !panel.contains(e.target) && !bell.contains(e.target)) {
        panel.style.display = 'none';
      }
    });

    // ë²”ìš© ëª¨ë‹¬ ì—´ê¸°
    function showModal(content) {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.innerHTML = `<div class="modal-content">${content}</div>`;
        modal.className = 'modal show';
      }
    }

    // ê·¸ë¡œìŠ¤ë³´ë“œ ì„¤ëª… ëª¨ë‹¬
    function showGrowthboardExplanation() {
      showModal(`
        <div style="padding: 32px; max-width: 900px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-size: 22px; font-weight: 700; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 28px;">ğŸ“Š</span> ì™œ ê·¸ë¡œìŠ¤ë³´ë“œê°€ í•„ìš”í•œì§€?
            </h2>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-400);">âœ•</button>
          </div>

          <!-- 1. ì „ëµ ì‚¬ì´í´ ì›Œí¬í”Œë¡œìš° -->
          <div style="background: var(--gray-900); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white;">
            <div style="font-size: 14px; font-weight: 600; color: var(--gray-400); margin-bottom: 16px;">1. ì „ëµ ì‚¬ì´í´ ì›Œí¬í”Œë¡œìš°</div>

            <!-- O (ëª©í‘œ) -->
            <div style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 16px; text-align: center; margin-bottom: 20px;">
              <div style="font-size: 15px; font-weight: 600;">O: 26ë…„ PMF ì°¾ê¸° + ì—° 10ì–µ ë§¤ì¶œ ë‹¬ì„±</div>
            </div>

            <div style="text-align: center; margin-bottom: 16px; font-size: 20px;">â”‚</div>

            <!-- KR 4ê°œ -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
              <div style="background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.4); border-radius: 10px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; margin-bottom: 4px;">ğŸ’°</div>
                <div style="font-size: 12px; font-weight: 600;">ì—°ë§¤ì¶œ 10ì–µ</div>
                <div style="font-size: 10px; color: var(--gray-400);">(ë§¤ì¶œKR)</div>
              </div>
              <div style="background: rgba(6,182,212,0.2); border: 1px solid rgba(6,182,212,0.4); border-radius: 10px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; margin-bottom: 4px;">ğŸ‘¥</div>
                <div style="font-size: 12px; font-weight: 600;">íŒŒíŠ¸ë„ˆ ë„¤íŠ¸ì›Œí¬</div>
                <div style="font-size: 10px; color: var(--gray-400);">(ê·¸ë¡œìŠ¤KR)</div>
              </div>
              <div style="background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.4); border-radius: 10px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; margin-bottom: 4px;">ğŸ“±</div>
                <div style="font-size: 12px; font-weight: 600;">í”Œë«í¼ í’ˆì§ˆí–¥ìƒ</div>
                <div style="font-size: 10px; color: var(--gray-400);">(ê·¸ë¡œìŠ¤KR)</div>
              </div>
              <div style="background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.4); border-radius: 10px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; margin-bottom: 4px;">ğŸ“¢</div>
                <div style="font-size: 12px; font-weight: 600;">ë¸Œëœë“œ ì¸ì§€ë„</div>
                <div style="font-size: 10px; color: var(--gray-400);">(ê·¸ë¡œìŠ¤KR)</div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center; font-size: 16px; margin-bottom: 12px;">
              <div>â†“</div><div>â†“</div><div>â†“</div><div>â†“</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center; font-size: 13px; color: var(--gray-300); margin-bottom: 12px;">
              <div>KPIs</div><div>KPIs</div><div>KPIs</div><div>KPIs</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center; font-size: 16px; margin-bottom: 12px;">
              <div>â†“</div><div>â†“</div><div>â†“</div><div>â†“</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center; font-size: 13px; color: var(--warning);">
              <div>ì§€í‘œ</div><div>ì§€í‘œ</div><div>ì§€í‘œ</div><div>ì§€í‘œ</div>
            </div>
          </div>

          <!-- 2. ì¼ìƒ ì—…ë¬´ íë¦„ -->
          <div style="background: var(--gray-50); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
            <div style="font-size: 14px; font-weight: 600; color: var(--gray-600); margin-bottom: 16px;">2. ì¼ìƒ ì—…ë¬´ íë¦„</div>

            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead>
                <tr style="background: var(--gray-200);">
                  <th style="padding: 12px; text-align: left; border-radius: 8px 0 0 0;">ë‹¨ê³„</th>
                  <th style="padding: 12px; text-align: left;">ë©”ë‰´</th>
                  <th style="padding: 12px; text-align: left; border-radius: 0 8px 0 0;">í™œìš©</th>
                </tr>
              </thead>
              <tbody>
                <tr style="border-bottom: 1px solid var(--gray-200);">
                  <td style="padding: 12px; font-weight: 600;">1. ëª©í‘œ ì„¤ì •</td>
                  <td style="padding: 12px; color: var(--primary);">ëª©í‘œì„¤ì •</td>
                  <td style="padding: 12px;">O/KR/KPI/ì§€í‘œ êµ¬ì¡° ì •ì˜</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--gray-200); background: var(--primary-light);">
                  <td style="padding: 12px; font-weight: 600;">2. ë§¤ì¼ ê¸°ë¡</td>
                  <td style="padding: 12px; color: var(--primary);">ì—…ë¬´ê¸°ë¡</td>
                  <td style="padding: 12px;">ì§€í‘œ ì„ íƒ â†’ ìˆ˜ëŸ‰+ë©”ëª¨+ì¦ë¹™ ì²¨ë¶€</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--gray-200);">
                  <td style="padding: 12px; font-weight: 600;">3. í˜„í™© íŒŒì•…</td>
                  <td style="padding: 12px; color: var(--primary);">ëŒ€ì‹œë³´ë“œ</td>
                  <td style="padding: 12px;">KRë³„ ë‹¬ì„±ë¥ , ì˜¤ëŠ˜ ê¸°ë¡ í˜„í™©</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--gray-200);">
                  <td style="padding: 12px; font-weight: 600;">4. ì‹¤í—˜ ë¶„ì„</td>
                  <td style="padding: 12px; color: var(--primary);">ì‹¤í—˜ë¶„ì„</td>
                  <td style="padding: 12px;">A/B í…ŒìŠ¤íŠ¸, ê°€ì„¤ ê²€ì¦</td>
                </tr>
                <tr>
                  <td style="padding: 12px; font-weight: 600;">5. ì´ë ¥ ì¶”ì </td>
                  <td style="padding: 12px; color: var(--primary);">ë³€ê²½ì´ë ¥</td>
                  <td style="padding: 12px;">ëˆ„ê°€ ì–¸ì œ ë¬´ì—‡ì„ ë³€ê²½í–ˆëŠ”ì§€</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 3. ë°ì´í„° ì¶•ì  â†’ ì˜ì‚¬ê²°ì • -->
          <div style="background: var(--gray-900); border-radius: 16px; padding: 24px; color: white;">
            <div style="font-size: 14px; font-weight: 600; color: var(--gray-400); margin-bottom: 16px;">3. ë°ì´í„° ì¶•ì  â†’ ì˜ì‚¬ê²°ì •</div>

            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
              <div style="background: rgba(49,130,246,0.2); border: 1px solid rgba(49,130,246,0.4); border-radius: 10px; padding: 14px 28px; font-size: 14px; font-weight: 500;">
                ğŸ“ ë§¤ì¼ ì—…ë¬´ê¸°ë¡ (í–‰ë™+ì¦ë¹™)
              </div>
              <div style="font-size: 18px;">â†“</div>
              <div style="background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.4); border-radius: 10px; padding: 14px 28px; font-size: 14px; font-weight: 500;">
                ğŸ“Š ì •ëŸ‰ ë°ì´í„° ì¶•ì 
              </div>
              <div style="font-size: 18px;">â†“</div>
              <div style="background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.4); border-radius: 10px; padding: 14px 28px; font-size: 14px; font-weight: 500;">
                ğŸ“ˆ KPI/KR ë‹¬ì„±ë¥  ìë™ê³„ì‚°
              </div>
              <div style="font-size: 18px;">â†“</div>
              <div style="background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.4); border-radius: 10px; padding: 14px 28px; font-size: 14px; font-weight: 500;">
                ğŸ’¡ ì„±ê³¼ ê¸°ë°˜ ì˜ì‚¬ê²°ì •
              </div>
            </div>
          </div>

          <!-- OKR+KPI ê²°í•© êµ¬ì¡° -->
          <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 16px; border: 1px solid #0ea5e9;">
            <div style="font-size: 14px; font-weight: 700; color: #0369a1; margin-bottom: 16px;">ğŸ“ OKR + KPI ê²°í•© êµ¬ì¡°</div>

            <div style="font-family: monospace; font-size: 13px; color: var(--gray-800); background: white; padding: 16px; border-radius: 12px; line-height: 2;">
              <div><b>O</b> (ëª©í‘œ) â€” 26ë…„ PMF ì°¾ê¸° + ì—° 10ì–µ ë§¤ì¶œ ë‹¬ì„±</div>
              <div style="padding-left: 20px;">â””â”€ <b>KR</b> (í•µì‹¬ê²°ê³¼) â€” ì—°ë§¤ì¶œ 10ì–µ / íŒŒíŠ¸ë„ˆ ë„¤íŠ¸ì›Œí¬ ë“±</div>
              <div style="padding-left: 44px;">â””â”€ <b>KPI</b> (í•µì‹¬ì„±ê³¼ì§€í‘œ) â€” ê³µë™êµ¬ë§¤, ì‹ ê·œíŒŒíŠ¸ë„ˆ ë“±</div>
              <div style="padding-left: 68px;">â”œâ”€ ğŸ“‹ <span style="color: var(--gray-600);">í™œë™ì§€í‘œ</span> (ì°¸ê³ ìš©, KPI ë¯¸ë°˜ì˜)</div>
              <div style="padding-left: 68px;">â””â”€ ğŸ’° <span style="color: var(--success); font-weight: 600;">ì„±ê³¼ì§€í‘œ</span> (KPI ë‹¬ì„±ë¥  ë°˜ì˜)</div>
              <div style="padding-left: 92px;">â””â”€ <b>ì—…ë¬´ê¸°ë¡</b> (ì¼ë³„ ì‹¤ì  + ì¦ë¹™)</div>
            </div>
          </div>

          <!-- ì™œ í™œë™í˜•/ì„±ê³¼í˜•ì¸ê°€? -->
          <div style="margin-top: 16px; padding: 20px; background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-radius: 16px; border: 1px solid #eab308;">
            <div style="font-size: 14px; font-weight: 700; color: #a16207; margin-bottom: 12px;">ğŸ’¡ ì™œ "í™œë™í˜•/ì„±ê³¼í˜•"ìœ¼ë¡œ êµ¬ë¶„í•˜ë‚˜ìš”?</div>

            <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8;">
              <p style="margin: 0 0 12px 0;">OKRê³¼ KPIë¥¼ ê²°í•©í•˜ë©´ì„œ ê¸°ì¡´ "ì„ í–‰ì§€í‘œ/í›„í–‰ì§€í‘œ" ìš©ì–´ì˜ í•„ìš”ì„±ì´ ëª¨í˜¸í•´ì¡ŒìŠµë‹ˆë‹¤.</p>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div style="background: white; padding: 12px; border-radius: 8px;">
                  <div style="font-weight: 600; color: var(--gray-600); margin-bottom: 6px;">ğŸ“‹ í™œë™í˜• ì§€í‘œ</div>
                  <div style="font-size: 12px; color: var(--gray-600);">
                    â€¢ ì¼ìƒ ì—…ë¬´ í™œë™ ì¶”ì  (ì°¸ê³ ìš©)<br>
                    â€¢ KPI ë‹¬ì„±ë¥ ì— ì§ì ‘ ë°˜ì˜ ì•ˆë¨<br>
                    â€¢ ì˜ˆ: ë¯¸íŒ…íšŸìˆ˜, ì—°ë½ê±´ìˆ˜ ë“±
                  </div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px;">
                  <div style="font-weight: 600; color: var(--success); margin-bottom: 6px;">ğŸ’° ì„±ê³¼í˜• ì§€í‘œ</div>
                  <div style="font-size: 12px; color: var(--gray-600);">
                    â€¢ ì‹¤ì œ ì„±ê³¼ë¥¼ ì¸¡ì •<br>
                    â€¢ KPI ë‹¬ì„±ë¥ ì— ì§ì ‘ ë°˜ì˜<br>
                    â€¢ ì˜ˆ: ê³µë™êµ¬ë§¤ ì§„í–‰, ê³„ì•½ê±´ìˆ˜ ë“±
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 3ê°€ì§€ ëª©í‘œì˜ ì°¨ì´ì  -->
          <div style="margin-top: 16px; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; border: 1px solid #f59e0b;">
            <div style="font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 12px;">ğŸ¯ 3ê°€ì§€ ëª©í‘œì˜ ì°¨ì´ì </div>

            <div style="font-size: 13px; color: var(--gray-700); line-height: 1.8; margin-bottom: 12px;">
              ê·¸ë¡œìŠ¤ë³´ë“œì—ëŠ” 3ê°€ì§€ ì¢…ë¥˜ì˜ ëª©í‘œê°€ ìˆìŠµë‹ˆë‹¤. ê°ê° ìš©ë„ì™€ ì˜í–¥ ë²”ìœ„ê°€ ë‹¤ë¦…ë‹ˆë‹¤:
            </div>

            <div style="display: grid; gap: 12px;">
              <!-- íŒ€ KPI ëª©í‘œ -->
              <div style="background: white; padding: 14px; border-radius: 10px; border-left: 4px solid var(--primary);">
                <div style="font-weight: 700; color: var(--primary); margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                  <span>ğŸ“Š</span> íŒ€ KPI ëª©í‘œ
                </div>
                <div style="font-size: 12px; color: var(--gray-600); line-height: 1.6;">
                  â€¢ <strong>ì„¤ì • ìœ„ì¹˜:</strong> ëª©í‘œì„¤ì • > KPI ìƒì„± ì‹œ targetValue<br>
                  â€¢ <strong>ìš©ë„:</strong> íŒ€ ì „ì²´ì˜ ì„±ê³¼ ëª©í‘œ<br>
                  â€¢ <strong>ì˜í–¥ ë²”ìœ„:</strong> <span style="color: var(--danger); font-weight: 600;">KPI/KR/O ë‹¬ì„±ë¥  ìë™ ê³„ì‚°ì— ì‚¬ìš©</span><br>
                  â€¢ <strong>ì˜ˆì‹œ:</strong> "êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ 8ì–µì›"
                </div>
              </div>

              <!-- ì¼ì¼ ëª©í‘œ -->
              <div style="background: white; padding: 14px; border-radius: 10px; border-left: 4px solid var(--warning);">
                <div style="font-weight: 700; color: var(--warning); margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                  <span>ğŸ“‹</span> ì¼ì¼ ëª©í‘œ (ì§€í‘œë³„)
                </div>
                <div style="font-size: 12px; color: var(--gray-600); line-height: 1.6;">
                  â€¢ <strong>ì„¤ì • ìœ„ì¹˜:</strong> ëª©í‘œì„¤ì • > ì§€í‘œ ìˆ˜ì • ì‹œ target<br>
                  â€¢ <strong>ìš©ë„:</strong> í•˜ë£¨ ê¶Œì¥ ì—…ë¬´ëŸ‰ ê°€ì´ë“œ<br>
                  â€¢ <strong>ì˜í–¥ ë²”ìœ„:</strong> <span style="color: var(--gray-500); font-weight: 600;">ì—†ìŒ (ì°¸ê³ ìš©ë§Œ)</span><br>
                  â€¢ <strong>ì˜ˆì‹œ:</strong> "ì „í™” ìƒë‹´ 10ê±´/ì¼"<br>
                  â€¢ <strong>í‘œì‹œ:</strong> ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ > ì¼ì¼ ëª©í‘œ í˜„í™©
                </div>
              </div>

              <!-- ê°œì¸ ëª©í‘œ -->
              <div style="background: white; padding: 14px; border-radius: 10px; border-left: 4px solid var(--success);">
                <div style="font-weight: 700; color: var(--success); margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                  <span>ğŸ¯</span> ê°œì¸ ëª©í‘œ (KPIë³„)
                </div>
                <div style="font-size: 12px; color: var(--gray-600); line-height: 1.6;">
                  â€¢ <strong>ì„¤ì • ìœ„ì¹˜:</strong> ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ > ğŸ¯ ëª©í‘œì„¤ì • ë²„íŠ¼<br>
                  â€¢ <strong>ìš©ë„:</strong> ê°œì¸ì˜ ì„±ì·¨ê° ì¶”ì <br>
                  â€¢ <strong>ì˜í–¥ ë²”ìœ„:</strong> <span style="color: var(--gray-500); font-weight: 600;">ì—†ìŒ (ê°œì¸ ë™ê¸°ë¶€ì—¬ìš©)</span><br>
                  â€¢ <strong>ì˜ˆì‹œ:</strong> "ë‚´ê°€ 3ì–µ ê¸°ì—¬í•˜ê² ë‹¤!"<br>
                  â€¢ <strong>íŠ¹ì§•:</strong> íŒ€ ëª©í‘œë³´ë‹¤ í¬ê²Œ ì„¤ì • ê°€ëŠ¥ (ë„ì „!)
                </div>
              </div>
            </div>

            <div style="margin-top: 12px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px; font-size: 12px; color: var(--gray-700);">
              <strong>ğŸ’¡ í•µì‹¬:</strong> íŒ€ KPI ëª©í‘œë§Œ ì‹¤ì œ ë‹¬ì„±ë¥  ê³„ì‚°ì— ì‚¬ìš©ë©ë‹ˆë‹¤. ì¼ì¼ ëª©í‘œì™€ ê°œì¸ ëª©í‘œëŠ” ê°ìì˜ ì˜ì—­ì—ì„œë§Œ í‘œì‹œë˜ë©°, íŒ€ ì„±ê³¼ ê³„ì‚°ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
          </div>

          <!-- í•µì‹¬ í¬ì¸íŠ¸ -->
          <div style="margin-top: 16px; padding: 16px; background: var(--success-light); border-left: 4px solid var(--success); border-radius: 8px;">
            <div style="font-size: 14px; font-weight: 700; color: var(--success); margin-bottom: 8px;">í•µì‹¬ í¬ì¸íŠ¸</div>
            <ul style="font-size: 13px; color: var(--gray-700); margin: 0; padding-left: 20px; line-height: 1.8;">
              <li>ì§€í‘œ ê¸°ë¡ ì‹œ <b>ìˆ˜ëŸ‰ + ë©”ëª¨ + ì¦ë¹™íŒŒì¼</b>ì´ í•¨ê»˜ ì €ì¥ë˜ì–´ ë‚˜ì¤‘ì— "ì™œ ì´ ìˆ«ìì¸ê°€?" ì¶”ì  ê°€ëŠ¥</li>
              <li><b>ì„±ê³¼í˜• ì§€í‘œ</b>ë§Œ KPI ë‹¬ì„±ë¥ ì— ë°˜ì˜, <b>í™œë™í˜•</b>ì€ ì—…ë¬´ ë§¥ë½ íŒŒì•…ìš© (ì°¸ê³ )</li>
              <li><b>íŒ€ KPI ëª©í‘œ</b>ë§Œ ì‹¤ì œ ë‹¬ì„±ë¥  ê³„ì‚°, ì¼ì¼/ê°œì¸ ëª©í‘œëŠ” ì°¸ê³ ìš©</li>
              <li>ë³€ê²½ì´ë ¥ìœ¼ë¡œ <b>ë°ì´í„° ì‹ ë¢°ì„±</b> í™•ë³´</li>
              <li><b>í–‰ë™ ê¸°ë¡ â†’ ì¦ë¹™ í™•ë³´ â†’ ì •ëŸ‰ ë°ì´í„° ì¶•ì </b>ì˜ ì„ ìˆœí™˜ êµ¬ì¡°</li>
            </ul>
          </div>

          <div style="text-align: center; margin-top: 24px;">
            <button onclick="closeModal()" class="btn btn-primary" style="padding: 12px 32px;">í™•ì¸</button>
          </div>
        </div>
      `);
    }

    // ì„ í–‰ì§€í‘œ ì¶”ê°€
    function addTeamKPI(kpi = null) {
      const list = document.getElementById('teamKPIList');
      const idx = list.children.length;
      const div = document.createElement('div');
      div.style.cssText = 'display: grid; grid-template-columns: 1fr 80px 80px 40px; gap: 8px; align-items: center; background: var(--gray-50); padding: 12px; border-radius: 8px;';
      div.innerHTML = `
        <input type="text" class="team-kpi-name" placeholder="KPI í•­ëª© (ì˜ˆ: ê³µê¸‰ì‚¬ ê³„ì•½)" value="${kpi?.name || ''}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <input type="number" class="team-kpi-target" placeholder="ëª©í‘œ" value="${kpi?.target || ''}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <input type="number" class="team-kpi-current" placeholder="í˜„ì¬" value="${kpi?.current || 0}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <button type="button" onclick="this.parentElement.remove()" style="background: var(--danger-light); color: var(--danger); border: none; padding: 8px; border-radius: 6px; cursor: pointer;">âœ•</button>
      `;
      list.appendChild(div);
    }

    // ê°œë³„ KPI ì¶”ê°€
    function addMemberKPI(kpi = null) {
      const list = document.getElementById('memberKPIList');
      const div = document.createElement('div');
      div.style.cssText = 'display: grid; grid-template-columns: 100px 1fr 70px 70px 40px; gap: 8px; align-items: center; background: var(--info-light); padding: 12px; border-radius: 8px;';
      div.innerHTML = `
        <select class="member-kpi-member" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
          <option value="songhee" ${kpi?.memberId === 'songhee' ? 'selected' : ''}>ê¹€ì†¡í¬</option>
          <option value="chaeeun" ${kpi?.memberId === 'chaeeun' ? 'selected' : ''}>ì´ì±„ì€</option>
        </select>
        <input type="text" class="member-kpi-name" placeholder="KPI í•­ëª©" value="${kpi?.name || ''}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <input type="number" class="member-kpi-target" placeholder="ëª©í‘œ" value="${kpi?.target || ''}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <input type="number" class="member-kpi-current" placeholder="í˜„ì¬" value="${kpi?.current || 0}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <button type="button" onclick="this.parentElement.remove()" style="background: var(--danger-light); color: var(--danger); border: none; padding: 8px; border-radius: 6px; cursor: pointer;">âœ•</button>
      `;
      list.appendChild(div);
    }

    // í”„ë¡œì íŠ¸ ì €ì¥
    async function saveProject() {
      const id = document.getElementById('projectId').value;
      const name = document.getElementById('projectName').value.trim();

      if (!name) {
        showToast('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      // ì„ í–‰ì§€í‘œ ìˆ˜ì§‘
      const teamKPIs = [];
      document.querySelectorAll('#teamKPIList > div').forEach(row => {
        const kpiName = row.querySelector('.team-kpi-name').value.trim();
        const target = parseInt(row.querySelector('.team-kpi-target').value) || 0;
        const current = parseInt(row.querySelector('.team-kpi-current').value) || 0;
        if (kpiName) {
          teamKPIs.push({ name: kpiName, target, current });
        }
      });

      // ê°œë³„ KPI ìˆ˜ì§‘
      const memberKPIs = [];
      document.querySelectorAll('#memberKPIList > div').forEach(row => {
        const memberId = row.querySelector('.member-kpi-member').value;
        const kpiName = row.querySelector('.member-kpi-name').value.trim();
        const target = parseInt(row.querySelector('.member-kpi-target').value) || 0;
        const current = parseInt(row.querySelector('.member-kpi-current').value) || 0;
        if (kpiName) {
          memberKPIs.push({ memberId, name: kpiName, target, current });
        }
      });

      const projectData = {
        name,
        description: document.getElementById('projectDesc').value.trim(),
        revenueGoal: parseInt(document.getElementById('projectRevenueGoal').value) || 0,
        startDate: document.getElementById('projectStartDate').value,
        endDate: document.getElementById('projectEndDate').value,
        status: document.getElementById('projectStatus').value,
        teamKPIs,
        memberKPIs,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('projects').doc(id).update(projectData);
        } else {
          projectData.createdAt = new Date().toISOString();
          await db.collection('projects').add(projectData);
        }
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeProjectModal();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    // í”„ë¡œì íŠ¸ ì‚­ì œ
    async function deleteProject() {
      const id = document.getElementById('projectId').value;
      if (!id) return;

      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('projects').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeProjectModal();
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // KPI ë¹ ë¥¸ ì—…ë°ì´íŠ¸
    async function quickUpdateKPI(projectId, kpiType, kpiIndex, newValue) {
      const project = state.projects.find(p => p.id === projectId);
      if (!project) return;

      const kpiList = kpiType === 'team' ? project.teamKPIs : project.memberKPIs;
      if (kpiList && kpiList[kpiIndex]) {
        kpiList[kpiIndex].current = parseInt(newValue) || 0;

        try {
          await db.collection('projects').doc(projectId).update({
            [kpiType === 'team' ? 'teamKPIs' : 'memberKPIs']: kpiList
          });
          showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        } catch (e) {
          showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
      }
    }

    // í”„ë¡œì íŠ¸ ëª©ë¡ ë Œë”ë§
    function renderProjects() {
      const list = document.getElementById('projectList');
      if (!list) return;

      const projects = state.projects || [];
      const activeProjects = projects.filter(p => p.status === 'active');

      // ìš”ì•½ ì—…ë°ì´íŠ¸ (null ì²´í¬)
      const totalGoal = projects.reduce((sum, p) => sum + (p.revenueGoal || 0), 0);
      const totalRevenueGoalEl = document.getElementById('totalRevenueGoal');
      const activeProjectsEl = document.getElementById('activeProjects');
      const completedKPIsEl = document.getElementById('completedKPIs');

      if (totalRevenueGoalEl) {
        totalRevenueGoalEl.textContent = totalGoal >= 100000000
          ? (totalGoal / 100000000).toFixed(1) + 'ì–µì›'
          : (totalGoal / 10000).toLocaleString() + 'ë§Œì›';
      }
      if (activeProjectsEl) {
        activeProjectsEl.textContent = activeProjects.length;
      }

      // KPI ì™„ë£Œ ê³„ì‚°
      let totalKPIs = 0, completedKPIs = 0;
      projects.forEach(p => {
        (p.teamKPIs || []).forEach(k => {
          totalKPIs++;
          if (k.current >= k.target) completedKPIs++;
        });
        (p.memberKPIs || []).forEach(k => {
          totalKPIs++;
          if (k.current >= k.target) completedKPIs++;
        });
      });
      if (completedKPIsEl) {
        completedKPIsEl.textContent = `${completedKPIs}/${totalKPIs}`;
      }

      if (projects.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 60px; background: var(--gray-50); border-radius: 16px; border: 2px dashed var(--gray-300);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div>
            <div style="font-size: 16px; color: var(--gray-600); margin-bottom: 16px;">ì•„ì§ ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <button class="btn btn-primary" onclick="openProjectModal()">+ ì²« í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</button>
          </div>
        `;
        return;
      }

      list.innerHTML = projects.map(project => {
        const statusColors = {
          active: { bg: '#dcfce7', text: '#16a34a', icon: 'ğŸŸ¢' },
          paused: { bg: '#fef3c7', text: '#d97706', icon: 'ğŸŸ¡' },
          completed: { bg: '#dbeafe', text: '#2563eb', icon: 'âœ…' }
        };
        const status = statusColors[project.status] || statusColors.active;

        // ì„ í–‰ì§€í‘œ ì§„í–‰ë¥ 
        const teamKPIs = project.teamKPIs || [];
        const memberKPIs = project.memberKPIs || [];
        const allKPIs = [...teamKPIs, ...memberKPIs];
        const kpiProgress = allKPIs.length > 0
          ? Math.round(allKPIs.reduce((sum, k) => sum + Math.min(100, (k.current / k.target) * 100), 0) / allKPIs.length)
          : 0;

        return `
          <div class="card" style="cursor: pointer;" onclick="openProjectModal(state.projects.find(p=>p.id==='${project.id}'))">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
              <div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <span style="font-size: 20px; font-weight: 700;">${project.name}</span>
                  <span style="background: ${status.bg}; color: ${status.text}; padding: 2px 8px; border-radius: 12px; font-size: 11px;">${status.icon} ${project.status === 'active' ? 'ì§„í–‰ì¤‘' : project.status === 'paused' ? 'ì¼ì‹œì •ì§€' : 'ì™„ë£Œ'}</span>
                </div>
                <div style="font-size: 13px; color: var(--gray-500);">${project.description || ''}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 24px; font-weight: 800; color: var(--primary);">${formatTargetValue(project.targetValue || (project.revenueGoal ? (project.revenueGoal >= 100000000 ? project.revenueGoal/100000000 : project.revenueGoal/10000) : 0), project.targetUnitType || (project.revenueGoal && project.revenueGoal < 100000000 ? 'won' : 'revenue'))}</div>
                <div style="font-size: 11px; color: var(--gray-500);">${getTargetUnitInfo(project.targetUnitType || 'revenue').label} ëª©í‘œ</div>
              </div>
            </div>

            <!-- KPI ì§„í–‰ë¥  ë°” -->
            <div style="margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                <span style="color: var(--gray-600);">KPI ì§„í–‰ë¥ </span>
                <span style="font-weight: 600; color: ${kpiProgress >= 70 ? 'var(--success)' : kpiProgress >= 40 ? 'var(--warning)' : 'var(--gray-600)'};">${kpiProgress}%</span>
              </div>
              <div style="background: var(--gray-200); height: 8px; border-radius: 4px;">
                <div style="background: ${kpiProgress >= 70 ? 'var(--success)' : kpiProgress >= 40 ? 'var(--warning)' : 'var(--primary)'}; height: 100%; width: ${kpiProgress}%; border-radius: 4px; transition: width 0.3s;"></div>
              </div>
            </div>

            <!-- ì„ í–‰ì§€í‘œ -->
            ${teamKPIs.length > 0 ? `
            <div style="margin-bottom: 12px;">
              <div style="font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 8px;">ğŸ“‹ ì„ í–‰ì§€í‘œ</div>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${teamKPIs.map((kpi, idx) => {
                  const progress = Math.min(100, Math.round((kpi.current / kpi.target) * 100));
                  return `
                    <div style="background: var(--gray-50); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;" onclick="event.stopPropagation()">
                      <span style="font-size: 13px;">${kpi.name}</span>
                      <span style="font-weight: 700; color: ${progress >= 100 ? 'var(--success)' : 'var(--gray-900)'};">${kpi.current}/${kpi.target}</span>
                      <button onclick="event.stopPropagation(); quickUpdateKPI('${project.id}', 'team', ${idx}, ${kpi.current + 1})" style="background: var(--primary); color: white; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 14px;">+</button>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            ` : ''}

            <!-- ê°œë³„ KPI -->
            ${memberKPIs.length > 0 ? `
            <div>
              <div style="font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 8px;">ğŸ‘¤ ê°œë³„ KPI</div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                ${memberKPIs.map((kpi, idx) => {
                  const progress = Math.min(100, Math.round((kpi.current / kpi.target) * 100));
                  const memberName = kpi.memberId === 'songhee' ? 'ê¹€ì†¡í¬' : 'ì´ì±„ì€';
                  return `
                    <div style="background: var(--info-light); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;" onclick="event.stopPropagation()">
                      <div>
                        <span style="font-size: 11px; color: var(--info);">${memberName}</span>
                        <div style="font-size: 13px;">${kpi.name}</div>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-weight: 700; color: ${progress >= 100 ? 'var(--success)' : 'var(--gray-900)'};">${kpi.current}/${kpi.target}</span>
                        <button onclick="event.stopPropagation(); quickUpdateKPI('${project.id}', 'member', ${idx}, ${kpi.current + 1})" style="background: var(--info); color: white; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; font-size: 12px;">+</button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            ` : ''}

            <!-- ê¸°ê°„ -->
            ${project.startDate || project.endDate ? `
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); font-size: 12px; color: var(--gray-500);">
              ğŸ“… ${project.startDate || '?'} ~ ${project.endDate || '?'}
            </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // ========================================
    // ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹œìŠ¤í…œ
    // ========================================

    // ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸° í—¬í¼
    function getCategories() {
      return state.refCategories.length > 0 ? state.refCategories : DEFAULT_CATEGORIES;
    }

    function getCategoryById(catId) {
      const cats = getCategories();
      return cats.find(c => c.id === catId) || cats[cats.length - 1];
    }

    // ì¹´í…Œê³ ë¦¬ í•„í„° ë²„íŠ¼ ë Œë”ë§
    function renderCategoryFilters() {
      const container = document.getElementById('refCategoryFilters');
      if (!container) return;

      const cats = getCategories();
      let html = `<button onclick="setRefCategoryFilter('all')" class="ref-cat-btn ${refCategoryFilter === 'all' ? 'active' : ''}"
                          style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600;
                          background: ${refCategoryFilter === 'all' ? '#0064FF' : '#F2F4F6'};
                          color: ${refCategoryFilter === 'all' ? 'white' : '#6B7684'};">ì „ì²´</button>`;

      cats.forEach(c => {
        const isActive = refCategoryFilter === c.id;
        html += `<button onclick="setRefCategoryFilter('${c.id}')" class="ref-cat-btn ${isActive ? 'active' : ''}"
                         style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;
                         background: ${isActive ? c.color : c.bg}; color: ${isActive ? 'white' : c.color};">
                   ${c.emoji} ${c.label}
                 </button>`;
      });
      container.innerHTML = html;
    }

    // ì¹´í…Œê³ ë¦¬ ì…€ë ‰íŠ¸ ì˜µì…˜ ë Œë”ë§
    function renderCategoryOptions() {
      const select = document.getElementById('referenceCategory');
      if (!select) return;

      const cats = getCategories();
      select.innerHTML = cats.map(c => `<option value="${c.id}">${c.emoji} ${c.label}</option>`).join('');
    }

    // ì¹´í…Œê³ ë¦¬ í•„í„° ì„¤ì •
    function setRefCategoryFilter(category) {
      refCategoryFilter = category;
      renderCategoryFilters();
      filterReferences();
    }

    // ë ˆí¼ëŸ°ìŠ¤ í•„í„°ë§
    function filterReferences() {
      const searchInput = document.getElementById('refSearch');
      const search = searchInput ? searchInput.value.toLowerCase() : '';
      refSearchQuery = search;

      const filtered = state.references.filter(ref => {
        const matchCategory = refCategoryFilter === 'all' || ref.category === refCategoryFilter;
        const matchSearch = !search ||
          ref.title.toLowerCase().includes(search) ||
          (ref.description || '').toLowerCase().includes(search) ||
          (ref.tags || []).some(t => t.toLowerCase().includes(search));
        return matchCategory && matchSearch;
      });
      renderReferenceList(filtered);
    }

    // ë ˆí¼ëŸ°ìŠ¤ ëª©ë¡ ë Œë”ë§
    function renderReferences() {
      // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
      const totalEl = document.getElementById('referenceTotalCount');
      const categoryCountsEl = document.getElementById('referenceCategoryCounts');

      if (totalEl) {
        totalEl.textContent = state.references.length + 'ê°œ';
      }

      if (categoryCountsEl) {
        // ì¹´í…Œê³ ë¦¬ë³„ ê°œìˆ˜ ê³„ì‚°
        const categoryCounts = {};
        state.references.forEach(ref => {
          const catId = ref.category || 'etc';
          categoryCounts[catId] = (categoryCounts[catId] || 0) + 1;
        });

        // ìƒìœ„ 4ê°œ ì¹´í…Œê³ ë¦¬ë§Œ í‘œì‹œ
        const sortedCategories = Object.entries(categoryCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 4);

        categoryCountsEl.innerHTML = sortedCategories.map(([catId, count]) => {
          const cat = getCategoryById(catId);
          return `
            <div style="text-align: center;">
              <div style="font-size: 12px; opacity: 0.8;">${cat.emoji} ${cat.label}</div>
              <div style="font-size: 20px; font-weight: 700; margin-top: 4px;">${count}</div>
            </div>
          `;
        }).join('');
      }

      renderCategoryFilters();
      filterReferences();
    }

    function renderReferenceList(references) {
      const container = document.getElementById('referenceList');
      if (!container) return;

      if (references.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px; grid-column: 1 / -1; background: white; border-radius: 16px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
            <div style="font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ë“±ë¡ëœ ë ˆí¼ëŸ°ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <p style="color: var(--gray-600); margin-bottom: 20px;">ìƒˆë¡œìš´ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
            <button onclick="openReferenceModal()" class="btn btn-primary">+ ì²« ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€</button>
          </div>`;
        return;
      }

      let html = '';
      references.forEach(ref => {
        const cat = getCategoryById(ref.category);
        const date = ref.createdAt ? ref.createdAt.substring(0, 10) : '';
        const allFiles = ref.images || [];
        const imageFiles = allFiles.filter(f => !f.isPdf);
        const pdfFiles = allFiles.filter(f => f.isPdf);
        const hasImages = imageFiles.length > 0;
        const hasPdfs = pdfFiles.length > 0;
        const firstImage = hasImages ? imageFiles[0].data : null;
        const tags = (ref.tags || []).slice(0, 3);

        html += `
          <div onclick="openReferenceDetail('${ref.id}')"
               style="background: white; border-radius: 16px; overflow: hidden; cursor: pointer; transition: all 0.2s;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #E5E8EB;"
               onmouseover="this.style.borderColor='#8B5CF6'; this.style.transform='translateY(-2px)'"
               onmouseout="this.style.borderColor='#E5E8EB'; this.style.transform='none'">
            ${firstImage ? `
              <div style="position: relative; width: 100%; height: 140px; background: #F2F4F6;">
                <img src="${firstImage}" style="width: 100%; height: 100%; object-fit: cover;">
                ${imageFiles.length > 1 ? `<span style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">+${imageFiles.length - 1}</span>` : ''}
              </div>
            ` : hasPdfs ? `
              <div style="position: relative; width: 100%; height: 140px; background: linear-gradient(135deg, #FEE2E2, #FECACA); display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center;">
                  <div style="font-size: 48px;">ğŸ“„</div>
                  <div style="font-size: 12px; color: #DC2626; font-weight: 600;">PDF ${pdfFiles.length}ê°œ</div>
                </div>
              </div>
            ` : ''}
            <div style="padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 11px; padding: 4px 10px; background: ${cat.bg}; color: ${cat.color}; border-radius: 6px; font-weight: 600;">${cat.emoji} ${cat.label}</span>
                <span style="font-size: 11px; color: #8B95A1;">${date}</span>
              </div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px; line-height: 1.4;">${ref.title}</div>
              ${ref.description ? `<div style="font-size: 12px; color: #6B7684; margin-bottom: 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${ref.description}</div>` : ''}
              <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                ${ref.linkUrl ? `<span style="font-size: 10px; padding: 3px 8px; background: #E8F3FF; color: #0064FF; border-radius: 4px;">ğŸ”— ë§í¬</span>` : ''}
                ${hasImages ? `<span style="font-size: 10px; padding: 3px 8px; background: #FEF3C7; color: #B45309; border-radius: 4px;">ğŸ–¼ï¸ ${imageFiles.length}ì¥</span>` : ''}
                ${hasPdfs ? `<span style="font-size: 10px; padding: 3px 8px; background: #FEE2E2; color: #DC2626; border-radius: 4px;">ğŸ“„ PDF ${pdfFiles.length}ê°œ</span>` : ''}
                ${ref.fileUrl && !hasImages && !hasPdfs ? `<span style="font-size: 10px; padding: 3px 8px; background: #DCFCE7; color: #16A34A; border-radius: 4px;">ğŸ“ íŒŒì¼</span>` : ''}
                ${tags.map(t => `<span style="font-size: 11px; padding: 4px 8px; background: #F2F4F6; color: #6B7684; border-radius: 4px;">#${t}</span>`).join('')}
              </div>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ë ˆí¼ëŸ°ìŠ¤ ëª¨ë‹¬ ì—´ê¸°
    function openReferenceModal(refId = null) {
      refUploadedImages = [];
      const modal = document.getElementById('referenceModal');
      const title = document.getElementById('referenceModalTitle');
      const deleteBtn = document.getElementById('deleteReferenceBtn');

      renderCategoryOptions();

      // í¼ ì´ˆê¸°í™”
      document.getElementById('referenceId').value = '';
      document.getElementById('referenceTitle').value = '';
      document.getElementById('referenceCategory').value = 'event';
      document.getElementById('referenceDesc').value = '';
      document.getElementById('referenceLink').value = '';
      document.getElementById('referenceFileUrl').value = '';
      document.getElementById('referenceTags').value = '';
      document.getElementById('refImagesPreview').style.display = 'none';
      document.getElementById('refImagesPreview').innerHTML = '';

      if (refId) {
        title.textContent = 'ë ˆí¼ëŸ°ìŠ¤ ìˆ˜ì •';
        deleteBtn.style.display = 'block';
        loadReferenceForEdit(refId);
      } else {
        title.textContent = 'ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€';
        deleteBtn.style.display = 'none';
      }

      modal.classList.add('show');
    }

    // ìˆ˜ì •ìš© ë°ì´í„° ë¡œë“œ
    async function loadReferenceForEdit(refId) {
      try {
        const doc = await db.collection('references').doc(refId).get();
        if (doc.exists) {
          const ref = doc.data();
          document.getElementById('referenceId').value = refId;
          document.getElementById('referenceTitle').value = ref.title || '';
          document.getElementById('referenceCategory').value = ref.category || 'etc';
          document.getElementById('referenceDesc').value = ref.description || '';
          document.getElementById('referenceLink').value = ref.linkUrl || '';
          document.getElementById('referenceFileUrl').value = ref.fileUrl || '';
          document.getElementById('referenceTags').value = (ref.tags || []).join(', ');

          if (ref.images && ref.images.length > 0) {
            refUploadedImages = ref.images;
            renderRefImagesPreview();
          }
        }
      } catch (e) {
        console.error('ë ˆí¼ëŸ°ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }

    function closeReferenceModal() {
      document.getElementById('referenceModal').classList.remove('show');
    }

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
    async function handleRefImageUpload(files) {
      if (!files || files.length === 0) return;

      const maxImages = 10;
      const currentCount = refUploadedImages.length;
      if (currentCount >= maxImages) {
        showToast('ìµœëŒ€ ' + maxImages + 'ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
        return;
      }

      const filesToProcess = Array.from(files).slice(0, maxImages - currentCount);
      const btn = document.getElementById('btnSaveRef');
      if (btn) btn.disabled = true;

      for (const file of filesToProcess) {
        const result = await processRefImage(file);
        if (result) refUploadedImages.push(result);
      }

      renderRefImagesPreview();
      if (btn) btn.disabled = false;
      document.getElementById('refFileInput').value = '';
      showToast(`${filesToProcess.length}ì¥ ì¶”ê°€ë¨`);
    }

    async function processRefImage(file) {
      const allowedImageTypes = ['image/jpeg', 'image/png', 'image/gif'];
      const ext = file.name.split('.').pop().toLowerCase();
      const isPdf = file.type === 'application/pdf' || ext === 'pdf';
      const isImage = allowedImageTypes.includes(file.type) || ['jpg', 'jpeg', 'png', 'gif'].includes(ext);

      if (!isImage && !isPdf) return null;
      if (file.size > 15 * 1024 * 1024) return null; // PDFëŠ” 15MBê¹Œì§€ í—ˆìš©

      try {
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        // PDFëŠ” ì••ì¶• ì—†ì´ ë°”ë¡œ ë°˜í™˜
        if (isPdf) {
          return { data: base64, name: file.name, type: 'application/pdf', isPdf: true };
        }

        // ì´ë¯¸ì§€: ê°„ë‹¨í•œ ì••ì¶• (700KB ì´í•˜ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        if (base64.length <= 700000) {
          return { data: base64, name: file.name, type: file.type, isPdf: false };
        }

        // ì••ì¶• í•„ìš”ì‹œ canvas ì‚¬ìš©
        const compressed = await compressImage(base64, 1200, 0.7);
        return { data: compressed, name: file.name, type: 'image/jpeg', isPdf: false };
      } catch (e) {
        console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
        return null;
      }
    }

    // í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬
    async function handleRefPaste(event) {
      event.preventDefault();

      const clipboardData = event.clipboardData || window.clipboardData;
      if (!clipboardData) return;

      const items = clipboardData.items;
      const maxImages = 10;
      const currentCount = refUploadedImages.length;

      if (currentCount >= maxImages) {
        showToast('ìµœëŒ€ ' + maxImages + 'ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'warning');
        return;
      }

      let addedCount = 0;
      const btn = document.getElementById('btnSaveRef');
      if (btn) btn.disabled = true;

      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          if (refUploadedImages.length >= maxImages) break;

          const file = item.getAsFile();
          if (file) {
            const result = await processRefImage(file);
            if (result) {
              // ë¶™ì—¬ë„£ê¸°í•œ ì´ë¯¸ì§€ëŠ” íŒŒì¼ëª… ìë™ ìƒì„±
              result.name = `ìº¡ì²˜_${new Date().toISOString().slice(0,19).replace(/[-:T]/g,'')}.png`;
              refUploadedImages.push(result);
              addedCount++;
            }
          }
        }
      }

      if (addedCount > 0) {
        renderRefImagesPreview();
        showToast(`${addedCount}ì¥ ë¶™ì—¬ë„£ê¸° ì™„ë£Œ`, 'success');
      } else {
        showToast('ë¶™ì—¬ë„£ì„ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
      }

      if (btn) btn.disabled = false;
    }

    function compressImage(base64, maxSize, quality) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let { width, height } = img;
          if (width > maxSize || height > maxSize) {
            if (width > height) {
              height = Math.round(height * maxSize / width);
              width = maxSize;
            } else {
              width = Math.round(width * maxSize / height);
              height = maxSize;
            }
          }
          canvas.width = width;
          canvas.height = height;
          canvas.getContext('2d').drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = base64;
      });
    }

    function renderRefImagesPreview() {
      const preview = document.getElementById('refImagesPreview');
      const count = document.getElementById('refImageCount');

      const imageCount = refUploadedImages.filter(f => !f.isPdf).length;
      const pdfCount = refUploadedImages.filter(f => f.isPdf).length;
      let countText = '';
      if (imageCount > 0 && pdfCount > 0) {
        countText = `(ì´ë¯¸ì§€ ${imageCount}ì¥, PDF ${pdfCount}ê°œ)`;
      } else if (imageCount > 0) {
        countText = `(${imageCount}ì¥)`;
      } else if (pdfCount > 0) {
        countText = `(PDF ${pdfCount}ê°œ)`;
      }
      if (count) count.textContent = countText;

      if (!preview) return;
      if (refUploadedImages.length === 0) {
        preview.style.display = 'none';
        return;
      }

      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px;">';
      refUploadedImages.forEach((img, i) => {
        if (img.isPdf) {
          // PDF íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
          html += `
            <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 1px solid #EF4444; background: linear-gradient(135deg, #FEE2E2, #FECACA); display: flex; flex-direction: column; align-items: center; justify-content: center;">
              <div style="font-size: 24px;">ğŸ“„</div>
              <div style="font-size: 9px; color: #DC2626; font-weight: 600; text-align: center; padding: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 90%;">PDF</div>
              <div style="font-size: 8px; color: #991B1B; text-align: center; padding: 0 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 90%;" title="${img.name}">${img.name.length > 10 ? img.name.substring(0, 8) + '...' : img.name}</div>
              <button onclick="removeRefImage(${i})" style="position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; background: rgba(220,38,38,0.9); color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
            </div>`;
        } else {
          // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
          html += `
            <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 1px solid #F59E0B;">
              <img src="${img.data}" style="width: 100%; height: 100%; object-fit: cover;">
              <button onclick="removeRefImage(${i})" style="position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; background: rgba(220,38,38,0.9); color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
            </div>`;
        }
      });
      html += '</div>';
      preview.innerHTML = html;
      preview.style.display = 'block';
    }

    function removeRefImage(index) {
      refUploadedImages.splice(index, 1);
      renderRefImagesPreview();
    }

    // ë ˆí¼ëŸ°ìŠ¤ ì €ì¥
    async function saveReference() {
      const id = document.getElementById('referenceId').value;
      const title = document.getElementById('referenceTitle').value.trim();
      const linkUrl = document.getElementById('referenceLink').value.trim();
      const fileUrl = document.getElementById('referenceFileUrl').value.trim();

      if (!title) { showToast('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (!linkUrl && refUploadedImages.length === 0 && !fileUrl) {
        showToast('ë§í¬ ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”');
        return;
      }

      const tagsStr = document.getElementById('referenceTags').value.trim();
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : [];

      const data = {
        title,
        category: document.getElementById('referenceCategory').value,
        description: document.getElementById('referenceDesc').value.trim(),
        linkUrl: linkUrl || null,
        fileUrl: refUploadedImages.length > 0 ? null : (fileUrl || null),
        images: refUploadedImages,
        tags,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('references').doc(id).update(data);
        } else {
          data.createdAt = new Date().toISOString();
          data.createdBy = 'admin';
          data.createdByName = 'ê´€ë¦¬ì';
          await db.collection('references').add(data);
        }
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeReferenceModal();
        renderReferences();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    // ë ˆí¼ëŸ°ìŠ¤ ì‚­ì œ
    async function deleteReference() {
      const id = document.getElementById('referenceId').value;
      if (!id || !confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('references').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeReferenceModal();
        renderReferences();
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ë³´ê¸°
    async function openReferenceDetail(refId) {
      const ref = state.references.find(r => r.id === refId);
      if (!ref) return;

      const cat = getCategoryById(ref.category);
      const allFiles = ref.images || [];
      const imageFiles = allFiles.filter(f => !f.isPdf);
      const pdfFiles = allFiles.filter(f => f.isPdf);
      const tags = ref.tags || [];

      let html = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 20px 24px; border-bottom: 1px solid var(--gray-200);">
          <span style="font-size: 13px; padding: 6px 14px; background: ${cat.bg}; color: ${cat.color}; border-radius: 8px; font-weight: 600;">${cat.emoji} ${cat.label}</span>
          <button onclick="closeReferenceDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
        </div>
        <div style="padding: 24px;">
          <h2 style="font-size: 22px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">${ref.title}</h2>
          ${imageFiles.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <div style="width: 100%; max-height: 350px; border-radius: 12px; overflow: hidden; background: #F2F4F6; margin-bottom: 10px;">
                <img id="detailMainImg" src="${imageFiles[0].data}" style="width: 100%; height: 100%; object-fit: contain; max-height: 350px;">
              </div>
              ${imageFiles.length > 1 ? `
                <div style="display: flex; gap: 8px; overflow-x: auto;">
                  ${imageFiles.map((img, i) => `<img src="${img.data}" onclick="document.getElementById('detailMainImg').src='${img.data}'" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid ${i === 0 ? '#8B5CF6' : '#E5E8EB'};">`).join('')}
                </div>
              ` : ''}
            </div>
          ` : ''}
          ${pdfFiles.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <div style="font-size: 14px; font-weight: 600; color: #DC2626; margin-bottom: 10px;">ğŸ“„ PDF íŒŒì¼ (${pdfFiles.length}ê°œ)</div>
              <div style="display: grid; gap: 8px;">
                ${pdfFiles.map((pdf, i) => `
                  <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: linear-gradient(135deg, #FEE2E2, #FECACA); border-radius: 10px; border: 1px solid #FECACA;">
                    <span style="font-size: 28px;">ğŸ“„</span>
                    <div style="flex: 1; overflow: hidden;">
                      <div style="font-size: 14px; font-weight: 600; color: #991B1B; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;" title="${pdf.name}">${pdf.name}</div>
                    </div>
                    <button onclick="downloadRefPdf(${i}, '${refId}')" style="padding: 8px 16px; background: #DC2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ë‹¤ìš´ë¡œë“œ</button>
                    <button onclick="openRefPdf(${i}, '${refId}')" style="padding: 8px 16px; background: #EF4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ì—´ê¸°</button>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          ${ref.description ? `<div style="font-size: 15px; color: var(--gray-700); line-height: 1.7; margin-bottom: 20px; padding: 16px; background: var(--gray-100); border-radius: 10px;">${ref.description}</div>` : ''}
          ${ref.linkUrl ? `
            <a href="${ref.linkUrl}" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #E8F3FF; border-radius: 12px; margin-bottom: 12px; text-decoration: none;">
              <span style="font-size: 24px;">ğŸ”—</span>
              <div style="flex: 1;"><div style="font-size: 14px; font-weight: 600; color: #0064FF;">ì™¸ë¶€ ë§í¬ ì—´ê¸°</div></div>
              <span style="color: #0064FF;">â†’</span>
            </a>
          ` : ''}
          ${ref.fileUrl && allFiles.length === 0 ? `
            <a href="${ref.fileUrl}" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #DCFCE7; border-radius: 12px; margin-bottom: 12px; text-decoration: none;">
              <span style="font-size: 24px;">ğŸ“</span>
              <div style="flex: 1;"><div style="font-size: 14px; font-weight: 600; color: #16A34A;">íŒŒì¼ ì—´ê¸°</div></div>
              <span style="color: #16A34A;">â†’</span>
            </a>
          ` : ''}
          ${tags.length > 0 ? `<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">${tags.map(t => `<span style="font-size: 12px; padding: 6px 12px; background: var(--gray-100); color: var(--gray-600); border-radius: 6px;">#${t}</span>`).join('')}</div>` : ''}
          <div style="padding: 16px; background: var(--gray-50); border-radius: 10px; font-size: 13px; color: var(--gray-500);">
            ğŸ“… ${ref.createdAt ? ref.createdAt.substring(0, 10) : ''}
          </div>
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button onclick="closeReferenceDetail(); openReferenceModal('${ref.id}')" class="btn btn-primary" style="flex: 1;">âœï¸ ìˆ˜ì •</button>
            <button onclick="if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { db.collection('references').doc('${ref.id}').delete(); closeReferenceDetail(); showToast('ì‚­ì œë¨'); renderReferences(); }" class="btn btn-secondary" style="flex: 1; color: var(--danger);">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </div>
      `;

      document.getElementById('referenceDetailContent').innerHTML = html;
      document.getElementById('referenceDetailModal').classList.add('show');
    }

    function closeReferenceDetail() {
      document.getElementById('referenceDetailModal').classList.remove('show');
    }

    // PDF ë‹¤ìš´ë¡œë“œ
    function downloadRefPdf(pdfIndex, refId) {
      const ref = state.references.find(r => r.id === refId);
      if (!ref) return;

      const pdfFiles = (ref.images || []).filter(f => f.isPdf);
      const pdf = pdfFiles[pdfIndex];
      if (!pdf) return;

      // base64 ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜ í›„ ë‹¤ìš´ë¡œë“œ
      const byteString = atob(pdf.data.split(',')[1]);
      const mimeType = 'application/pdf';
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      const blob = new Blob([ab], { type: mimeType });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = pdf.name || 'document.pdf';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // PDF ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
    function openRefPdf(pdfIndex, refId) {
      const ref = state.references.find(r => r.id === refId);
      if (!ref) return;

      const pdfFiles = (ref.images || []).filter(f => f.isPdf);
      const pdf = pdfFiles[pdfIndex];
      if (!pdf) return;

      // base64 ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜ í›„ ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
      const byteString = atob(pdf.data.split(',')[1]);
      const mimeType = 'application/pdf';
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      const blob = new Blob([ab], { type: mimeType });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }

    // ========================================
    // ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ì‹œìŠ¤í…œ
    // ========================================

    function openCategoryModal() {
      renderCategoryList();
      document.getElementById('categoryModal').classList.add('show');
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('show');
    }

    function renderCategoryList() {
      const list = document.getElementById('categoryList');
      const cats = getCategories();

      list.innerHTML = cats.map((c, i) => `
        <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: ${c.bg}; border-radius: 8px;">
          <span style="font-size: 20px;">${c.emoji}</span>
          <span style="flex: 1; font-weight: 500; color: ${c.color};">${c.label}</span>
          <button onclick="editCategory('${c.id}')" style="background: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">ìˆ˜ì •</button>
          <button onclick="deleteCategory('${c.id}')" style="background: #FEE2E2; color: #DC2626; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    async function addCategory() {
      const emoji = document.getElementById('newCatEmoji').value.trim() || 'ğŸ“';
      const name = document.getElementById('newCatName').value.trim();
      const color = document.getElementById('newCatColor').value;

      if (!name) { showToast('ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      const id = name.toLowerCase().replace(/\s+/g, '_');
      const bg = color + '20'; // ì—°í•œ ë°°ê²½ìƒ‰

      try {
        await db.collection('refCategories').doc(id).set({
          id, label: name, emoji, color, bg,
          order: state.refCategories.length,
          createdAt: new Date().toISOString()
        });
        showToast('ì¹´í…Œê³ ë¦¬ ì¶”ê°€ë¨');
        document.getElementById('newCatEmoji').value = '';
        document.getElementById('newCatName').value = '';
      } catch (e) {
        showToast('ì¶”ê°€ ì‹¤íŒ¨');
      }
    }

    async function editCategory(catId) {
      const cat = getCategoryById(catId);
      const newEmoji = prompt('ì´ëª¨ì§€:', cat.emoji);
      const newLabel = prompt('ì´ë¦„:', cat.label);
      const newColor = prompt('ìƒ‰ìƒ (hex):', cat.color);

      if (!newLabel) return;

      try {
        await db.collection('refCategories').doc(catId).update({
          emoji: newEmoji || cat.emoji,
          label: newLabel,
          color: newColor || cat.color,
          bg: (newColor || cat.color) + '20'
        });
        showToast('ìˆ˜ì •ë¨');
      } catch (e) {
        showToast('ìˆ˜ì • ì‹¤íŒ¨');
      }
    }

    async function deleteCategory(catId) {
      if (!confirm('ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('refCategories').doc(catId).delete();
        showToast('ì‚­ì œë¨');
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ìˆ«ì í¬ë§·
    function formatNumber(num) {
      if (num === null || num === undefined) return '0';
      return Number(num).toLocaleString('ko-KR');
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 2500);
    }

    // ========================================
    // ì˜ì—…í˜„í™© ì‹œìŠ¤í…œ
    // ========================================
    function getStrategyTarget() {
      const saved = state.strategyData || {};
      return {
        annualRevenue: saved.annualRevenue || 500000000,
        successRate: saved.successRate || 30,
        avgDealRevenue: saved.avgDealRevenue || 4630000,
        targetSuccessDeals: saved.targetSuccessDeals || 108,
        monthlySuccessDeals: saved.monthlySuccessDeals || 9,
        monthlyProfit: saved.monthlyProfit || 4000000,
        annualProfit: saved.annualProfit || 48000000,
        commission30Ratio: saved.commission30Ratio || 70,
        monthlyNewSuppliers: saved.monthlyNewSuppliers || 3,
        monthlyNewSellers: saved.monthlyNewSellers || 15,
        get requiredTotalDeals() { return Math.ceil(this.targetSuccessDeals / (this.successRate / 100)); },
        get monthlyRequiredDeals() { return Math.ceil(this.requiredTotalDeals / 12); },
        get weeklyRequiredDeals() { return Math.ceil(this.requiredTotalDeals / 52); }
      };
    }

    // íŒŒì´í”„ë¼ì¸ ì†Œìš”ì‹œê°„ ê³„ì‚° í•¨ìˆ˜ (ê³µê¸‰ì‚¬/ìƒí’ˆìš©)
    function calculatePipelineDurations(productList) {
      // ì œì•ˆâ†’ì˜¨ë³´ë”©ì™„ë£Œ ì†Œìš”ì‹œê°„ ê³„ì‚°
      const proposalToOnboardingDurations = [];
      // ì œì•ˆâ†’ê³„ì•½ì™„ë£Œ ì†Œìš”ì‹œê°„ ê³„ì‚°
      const proposalToContractDurations = [];

      productList.forEach(p => {
        // ì œì•ˆâ†’ì˜¨ë³´ë”©ì™„ë£Œ ì†Œìš”ì‹œê°„
        if (p.proposedAt && p.onboardingCompletedAt) {
          const proposedDate = new Date(p.proposedAt);
          const onboardingDate = new Date(p.onboardingCompletedAt);
          const diffMs = onboardingDate - proposedDate;
          if (diffMs > 0) {
            proposalToOnboardingDurations.push(diffMs);
          }
        }

        // ì œì•ˆâ†’ê³„ì•½ì™„ë£Œ ì†Œìš”ì‹œê°„
        if (p.proposedAt && p.contractedAt) {
          const proposedDate = new Date(p.proposedAt);
          const contractedDate = new Date(p.contractedAt);
          const diffMs = contractedDate - proposedDate;
          if (diffMs > 0) {
            proposalToContractDurations.push(diffMs);
          }
        }
      });

      // í‰ê·  ê³„ì‚° (ë°€ë¦¬ì´ˆ â†’ ì¼ ë‹¨ìœ„)
      const msToDay = 1000 * 60 * 60 * 24;
      const avgProposalToOnboarding = proposalToOnboardingDurations.length > 0
        ? proposalToOnboardingDurations.reduce((sum, d) => sum + d, 0) / proposalToOnboardingDurations.length / msToDay
        : null;
      const avgProposalToContract = proposalToContractDurations.length > 0
        ? proposalToContractDurations.reduce((sum, d) => sum + d, 0) / proposalToContractDurations.length / msToDay
        : null;

      return {
        proposalToOnboarding: {
          avg: avgProposalToOnboarding,
          count: proposalToOnboardingDurations.length
        },
        proposalToContract: {
          avg: avgProposalToContract,
          count: proposalToContractDurations.length
        }
      };
    }

    // ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸ ì†Œìš”ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
    function calculateSellerPipelineDurations(sellerProposals) {
      // ì œì•ˆâ†’ì˜¨ë³´ë”©ì™„ë£Œ ì†Œìš”ì‹œê°„ ê³„ì‚°
      const proposalToOnboardingDurations = [];
      // ì œì•ˆâ†’ì…ì ì™„ë£Œ ì†Œìš”ì‹œê°„ ê³„ì‚°
      const proposalToListedDurations = [];

      sellerProposals.forEach(s => {
        // ì œì•ˆâ†’ì˜¨ë³´ë”©ì™„ë£Œ ì†Œìš”ì‹œê°„
        const proposalAt = s.proposalAt || s.createdAt;
        if (proposalAt && s.onboardingCompletedAt) {
          const proposedDate = new Date(proposalAt);
          const onboardingDate = new Date(s.onboardingCompletedAt);
          const diffMs = onboardingDate - proposedDate;
          if (diffMs > 0) {
            proposalToOnboardingDurations.push(diffMs);
          }
        }

        // ì œì•ˆâ†’ì…ì ì™„ë£Œ ì†Œìš”ì‹œê°„
        if (proposalAt && s.listedAt) {
          const proposedDate = new Date(proposalAt);
          const listedDate = new Date(s.listedAt);
          const diffMs = listedDate - proposedDate;
          if (diffMs > 0) {
            proposalToListedDurations.push(diffMs);
          }
        }
      });

      // í‰ê·  ê³„ì‚° (ë°€ë¦¬ì´ˆ â†’ ì¼ ë‹¨ìœ„)
      const msToDay = 1000 * 60 * 60 * 24;
      const avgProposalToOnboarding = proposalToOnboardingDurations.length > 0
        ? proposalToOnboardingDurations.reduce((sum, d) => sum + d, 0) / proposalToOnboardingDurations.length / msToDay
        : null;
      const avgProposalToListed = proposalToListedDurations.length > 0
        ? proposalToListedDurations.reduce((sum, d) => sum + d, 0) / proposalToListedDurations.length / msToDay
        : null;

      return {
        proposalToOnboarding: {
          avg: avgProposalToOnboarding,
          count: proposalToOnboardingDurations.length
        },
        proposalToListed: {
          avg: avgProposalToListed,
          count: proposalToListedDurations.length
        }
      };
    }

    // ì†Œìš”ì‹œê°„ì„ ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    function formatDuration(days) {
      if (days === null || days === undefined) return '-';
      if (days < 1) {
        const hours = Math.round(days * 24);
        return hours + 'ì‹œê°„';
      } else if (days < 7) {
        return days.toFixed(1) + 'ì¼';
      } else {
        const weeks = Math.floor(days / 7);
        const remainingDays = Math.round(days % 7);
        if (remainingDays === 0) {
          return weeks + 'ì£¼';
        }
        return weeks + 'ì£¼ ' + remainingDays + 'ì¼';
      }
    }

    function renderSalesDashboard() {
      const container = document.getElementById('salesDashboardContent');
      if (!container) return;

      container.innerHTML = `
        <div style="text-align: center; padding: 60px;">
          <div class="loading-spinner"></div>
          <p style="color: var(--gray-500); margin-top: 16px;">ì˜ì—…í˜„í™© ë¡œë”©ì¤‘...</p>
        </div>
      `;

      loadSalesDashboardData();
    }

    async function loadSalesDashboardData() {
      try {
        // í•„ìš”í•œ ë°ì´í„° ë¡œë“œ
        if (!state.deals) state.deals = [];
        if (!state.sellerSettlements) state.sellerSettlements = [];
        if (!state.supplierSettlements) state.supplierSettlements = [];
        if (!state.sellers) state.sellers = [];
        if (!state.suppliers) state.suppliers = [];
        if (!state.teamMembers) state.teamMembers = [];

        renderSalesDashboardContent();
      } catch (error) {
        console.error('ì˜ì—…í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('salesDashboardContent').innerHTML = '<div style="text-align: center; padding: 60px; color: var(--danger);">ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜</div>';
      }
    }

    function renderSalesDashboardContent() {
      const container = document.getElementById('salesDashboardContent');
      if (!container) return;

      const members = state.teamMembers || [];
      const currentUser = state.currentUser || {};
      const isAdmin = currentUser.role === 'admin';

      const now = new Date();
      const currentYear = now.getFullYear();
      const thisMonth = now.toISOString().slice(0, 7);
      const thisYearStr = String(currentYear);

      const allSettlements = state.sellerSettlements || [];
      const allDeals = state.deals || [];

      const yearDeals = allDeals.filter(d => (d.startDate || d.createdAt || '').startsWith(thisYearStr));
      const yearSettlements = allSettlements.filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
      const monthDeals = allDeals.filter(d => (d.endDate || '').startsWith(thisMonth));
      const monthSettlements = allSettlements.filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisMonth));

      const successfulDeals = yearDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');
      const monthSuccessfulDeals = monthDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');

      const deals30Percent = yearDeals.filter(d => Number(d.commissionRate || d.supplierCommission || 0) >= 30);
      const commission30Ratio = yearDeals.length > 0 ? Math.round((deals30Percent.length / yearDeals.length) * 100) : 0;

      const totalSalesAmount = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
      const monthSalesAmount = monthSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);

      // ìˆœìµ ê³„ì‚°
      const yearInhouseSettlements = yearSettlements.filter(s => s.productType !== 'external');
      const inhouseSalesAmt = yearInhouseSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
      const inhouseSellerPayout = yearInhouseSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
      const inhousePgFeeAmt = Math.round(inhouseSalesAmt * 0.04);
      const inhouseProfitAmt = inhouseSalesAmt - inhouseSellerPayout - inhousePgFeeAmt;

      const yearExternalSettlements = yearSettlements.filter(s => s.productType === 'external');
      const externalSalesAmt = yearExternalSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
      const externalSellerPayout = yearExternalSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
      const externalPgFeeAmt = Math.round(externalSalesAmt * 0.04);

      const yearSupplierSettlements = (state.supplierSettlements || []).filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
      const supplierPayoutAmt = yearSupplierSettlements.reduce((sum, s) => sum + (Number(s.totalSupplyAmount) || Number(s.supplyAmount) || 0) + (Number(s.totalVatAmount) || Number(s.vatAmount) || 0), 0);
      const externalProfitAmt = externalSalesAmt - externalSellerPayout - supplierPayoutAmt - externalPgFeeAmt;

      const totalProfitAmount = inhouseProfitAmt + externalProfitAmt;

      const completedDeals = yearDeals.filter(d => d.status === 'completed' || d.isSuccess !== undefined || d.ë‹¬ì„±ì—¬ë¶€);
      const currentSuccessRate = completedDeals.length > 0 ? Math.round((successfulDeals.length / completedDeals.length) * 100) : 0;

      const T = getStrategyTarget();
      const revenueProgress = Math.min(100, Math.round((totalSalesAmount / T.annualRevenue) * 100));
      const profitProgress = Math.min(100, Math.round((totalProfitAmount / T.annualProfit) * 100));
      const successDealsProgress = Math.min(100, Math.round((successfulDeals.length / T.targetSuccessDeals) * 100));
      const totalDealsProgress = Math.min(100, Math.round((yearDeals.length / T.requiredTotalDeals) * 100));

      const yearEnd = new Date(currentYear, 11, 31);
      const remainingDays = Math.ceil((yearEnd - now) / (1000 * 60 * 60 * 24));
      const remainingWeeks = Math.ceil(remainingDays / 7);
      const remainingMonths = 12 - now.getMonth();

      const remainingTotalDeals = Math.max(T.requiredTotalDeals - yearDeals.length, 0);
      const weeklyNeededDeals = Math.ceil(remainingTotalDeals / Math.max(remainingWeeks, 1));
      const monthlyNeededDeals = Math.ceil(remainingTotalDeals / Math.max(remainingMonths, 1));

      // ì´ë²ˆ ì£¼ ë°ì´í„°
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay());
      weekStart.setHours(0, 0, 0, 0);
      const thisWeekDeals = allDeals.filter(d => {
        if (!d.endDate) return false;
        const endDate = new Date(d.endDate);
        return endDate >= weekStart && endDate <= now;
      });

      const weeklyTargetDeals = T.weeklyRequiredDeals;
      const monthlyTargetDeals = T.monthlyRequiredDeals;
      const weeklyProgress = Math.min(100, Math.round((thisWeekDeals.length / weeklyTargetDeals) * 100));
      const monthlyProgress = Math.min(100, Math.round((monthDeals.length / monthlyTargetDeals) * 100));

      // ì…€ëŸ¬/ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë°ì´í„°
      const allSellerList = state.sellerList || [];
      const allProductList = state.productList || [];

      // ğŸ“‹ ì˜¨ë³´ë”© ì§„ì²™ë„ ê³„ì‚° (ì…€ëŸ¬ë¦¬ìŠ¤íŠ¸)
      const sellerOnboardingItems = allSellerList.filter(s => s.onboarding || s.contacted);
      const sellerOnboardingStats = {
        total: sellerOnboardingItems.length,
        obContact: sellerOnboardingItems.filter(s => s.obContact).length,
        obGuide: sellerOnboardingItems.filter(s => s.obGuide).length,
        obForm: sellerOnboardingItems.filter(s => s.obForm).length,
        obBank: sellerOnboardingItems.filter(s => s.obBank).length,
        obIdCard: sellerOnboardingItems.filter(s => s.obIdCard).length
      };
      const sellerOnboardingProgress = sellerOnboardingStats.total > 0
        ? Math.round(((sellerOnboardingStats.obContact + sellerOnboardingStats.obGuide + sellerOnboardingStats.obForm + sellerOnboardingStats.obBank + sellerOnboardingStats.obIdCard) / (sellerOnboardingStats.total * 5)) * 100)
        : 0;

      // ğŸ“‹ ì˜¨ë³´ë”© ì§„ì²™ë„ ê³„ì‚° (ìƒí’ˆë¦¬ìŠ¤íŠ¸/ê³µê¸‰ì‚¬)
      const supplierOnboardingItems = allProductList.filter(p => p.onboarding || p.contacted);
      const supplierOnboardingStats = {
        total: supplierOnboardingItems.length,
        obContact: supplierOnboardingItems.filter(p => p.obContact).length,
        obGuide: supplierOnboardingItems.filter(p => p.obGuide).length,
        obProductInfo: supplierOnboardingItems.filter(p => p.obProductInfo).length,
        obBizLicense: supplierOnboardingItems.filter(p => p.obBizLicense).length,
        obBank: supplierOnboardingItems.filter(p => p.obBank).length
      };
      const supplierOnboardingProgress = supplierOnboardingStats.total > 0
        ? Math.round(((supplierOnboardingStats.obContact + supplierOnboardingStats.obGuide + supplierOnboardingStats.obProductInfo + supplierOnboardingStats.obBizLicense + supplierOnboardingStats.obBank) / (supplierOnboardingStats.total * 5)) * 100)
        : 0;

      // íŒ€ì›ë³„ ì‹¤ì 
      const memberStats = members.filter(m => m.role !== 'ceo').map(member => {
        const mSuppliers = (state.suppliers || []).filter(s => s.registeredBy === member.id);
        const mSellers = (state.sellers || []).filter(s => s.registeredBy === member.id);

        // ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸ (sellerList ê¸°ë°˜)
        const mSellerList = allSellerList.filter(s => s.createdBy === member.loginId || s.createdBy === member.id);
        const sellerPipeline = {
          total: mSellerList.length,
          proposed: mSellerList.filter(s => s.proposed).length,
          onboarding: mSellerList.filter(s => s.onboarding || s.contacted).length,
          contracted: mSellerList.filter(s => s.contracted).length
        };

        // ìƒí’ˆ íŒŒì´í”„ë¼ì¸ (productList ê¸°ë°˜)
        const mProductList = allProductList.filter(s => s.createdBy === member.loginId || s.createdBy === member.id);
        const supplierPipeline = {
          total: mProductList.length,
          proposed: mProductList.filter(s => s.proposed).length,
          onboarding: mProductList.filter(s => s.onboarding || s.contacted).length,
          contracted: mProductList.filter(s => s.contracted).length
        };

        // íŒŒì´í”„ë¼ì¸ ì†Œìš”ì‹œê°„ ê³„ì‚° (ìƒí’ˆ íŒŒì´í”„ë¼ì¸ ê¸°ì¤€)
        const pipelineDurations = calculatePipelineDurations(mProductList);

        // ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸ ì†Œìš”ì‹œê°„ ê³„ì‚° (sellerProposals ê¸°ì¤€)
        const allSellerProposals = state.sellerProposals || [];
        const mSellerProposals = allSellerProposals.filter(s => s.createdBy === member.loginId || s.createdBy === member.id);
        const sellerPipelineDurations = calculateSellerPipelineDurations(mSellerProposals);

        const mDeals = allDeals.filter(d => d.registeredBy === member.id);
        const mYearDeals = mDeals.filter(d => (d.startDate || d.createdAt || '').startsWith(thisYearStr));
        const mMonthDeals = mDeals.filter(d => (d.endDate || '').startsWith(thisMonth));
        const mSuccessDeals = mYearDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');

        const sellerNames = mSellers.map(s => s.name).filter(Boolean);
        const mSettlements = allSettlements.filter(s => {
          if (s.registeredBy === member.id) return true;
          const sName = s.sellerName || '';
          return sellerNames.some(name => name && (sName.includes(name.split('/')[0]) || sName.includes(name)));
        });

        const mYearSettlements = mSettlements.filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
        const totalSales = mYearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
        const totalProfit = mYearSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);

        const mCompletedDeals = mYearDeals.filter(d => d.status === 'completed' || d.isSuccess !== undefined || d.ë‹¬ì„±ì—¬ë¶€);
        const mSuccessRate = mCompletedDeals.length > 0 ? Math.round((mSuccessDeals.length / mCompletedDeals.length) * 100) : 0;

        return {
          ...member,
          suppliers: mSuppliers.length,
          sellers: mSellers.length,
          yearDeals: mYearDeals.length,
          monthDeals: mMonthDeals.length,
          successDeals: mSuccessDeals.length,
          successRate: mSuccessRate,
          sales: totalSales,
          profit: totalProfit,
          sellerPipeline,
          supplierPipeline,
          pipelineDurations,
          sellerPipelineDurations
        };
      });

      // TOP ë­í‚¹
      const supplierSalesMap = {};
      allSettlements.forEach(s => {
        const brand = s.brandName || s.supplierName || 'ë¯¸ì§€ì •';
        if (!supplierSalesMap[brand]) supplierSalesMap[brand] = { name: brand, sales: 0, count: 0 };
        supplierSalesMap[brand].sales += Number(s.salesAmount) || 0;
        supplierSalesMap[brand].count += 1;
      });
      const topSuppliers = Object.values(supplierSalesMap).filter(s => s.sales > 0).sort((a, b) => b.sales - a.sales).slice(0, 5);

      const sellerSalesMap = {};
      allSettlements.forEach(s => {
        const seller = s.sellerName || 'ë¯¸ì§€ì •';
        if (!sellerSalesMap[seller]) sellerSalesMap[seller] = { name: seller, sales: 0, margin: 0, count: 0 };
        sellerSalesMap[seller].sales += Number(s.salesAmount) || 0;
        sellerSalesMap[seller].margin += Number(s.marginAmount) || 0;
        sellerSalesMap[seller].count += 1;
      });
      const topSellers = Object.values(sellerSalesMap).filter(s => s.sales > 0).sort((a, b) => b.sales - a.sales).slice(0, 5);

      const C = {
        primary: '#3182f6',
        orange: '#fc9600',
        blue: '#0064FF',
        blueLight: '#E8F3FF',
        green: '#00C471',
        greenLight: '#E8F8F0',
        red: '#F04452',
        redLight: '#FEE2E4',
        yellow: '#F59E0B',
        yellowLight: '#FEF3C7',
        black: '#191F28',
        gray900: '#191F28',
        gray700: '#333D4B',
        gray600: '#4E5968',
        gray500: '#6B7684',
        gray400: '#8B95A1',
        gray300: '#B0B8C1',
        gray200: '#D1D6DB',
        gray100: '#E5E8EB',
        gray50: '#F2F4F6',
        white: '#FFFFFF'
      };

      const getProgressColor = (progress) => progress >= 80 ? C.green : progress >= 50 ? C.yellow : C.red;
      const getProgressBg = (progress) => progress >= 80 ? C.greenLight : progress >= 50 ? C.yellowLight : C.redLight;

      container.innerHTML = `
        <div style="max-width: 1400px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <h1 style="font-size: 24px; font-weight: 700; color: ${C.black}; margin: 0;">ì˜ì—…í˜„í™©</h1>
              <p style="color: ${C.gray500}; margin-top: 4px; font-size: 13px;">
                ì—° ${(T.annualRevenue / 100000000)}ì–µ = ê³µêµ¬ ${T.requiredTotalDeals}ê±´ (ì›”${T.monthlyRequiredDeals}/ì£¼${T.weeklyRequiredDeals}) â†’ ì„±ê³µ ${T.targetSuccessDeals}ê±´
              </p>
            </div>
            <div style="display: flex; gap: 8px;">
              ${isAdmin ? `<button onclick="openGoalCalculator()" style="padding: 8px 14px; font-size: 12px; font-weight: 600; background: ${C.white}; color: ${C.primary}; border: 1px solid ${C.gray200}; border-radius: 8px; cursor: pointer;">ğŸ§® ê³„ì‚°ê¸°</button>` : ''}
            </div>
          </div>

          <!-- ì—°ë„ë³„ ëª©í‘œ ëŒ€ì‹œë³´ë“œ -->
          ${renderYearlyGoalsDashboard()}

          <!-- í•µì‹¬ í˜„í™© ë°°ë„ˆ -->
          <div style="background: linear-gradient(135deg, ${C.primary}, #1b64da); border-radius: 14px; padding: 16px 20px; margin-bottom: 16px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div><div style="font-size: 11px; opacity: 0.85;">ê³µêµ¬</div><div style="font-size: 20px; font-weight: 700;">${yearDeals.length}<span style="font-size: 13px; opacity: 0.8;">/${T.requiredTotalDeals}</span></div></div>
                <div><div style="font-size: 11px; opacity: 0.85;">ì„±ê³µ</div><div style="font-size: 20px; font-weight: 700;">${successfulDeals.length}<span style="font-size: 13px; opacity: 0.8;">/${T.targetSuccessDeals}</span></div></div>
                <div><div style="font-size: 11px; opacity: 0.85;">ë§¤ì¶œ</div><div style="font-size: 20px; font-weight: 700;">${(totalSalesAmount / 100000000).toFixed(1)}<span style="font-size: 13px; opacity: 0.8;">/${(T.annualRevenue / 100000000)}ì–µ</span></div></div>
                <div><div style="font-size: 11px; opacity: 0.85;">ì„±ê³µë¥ </div><div style="font-size: 20px; font-weight: 700;">${currentSuccessRate}%</div></div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 11px; opacity: 0.8;">ë‚¨ì€ ê¸°ê°„</div>
                <div style="font-size: 18px; font-weight: 700;">${remainingMonths}ê°œì›” ${remainingDays % 30}ì¼</div>
              </div>
            </div>
          </div>

          <!-- KPI ì¹´ë“œ -->
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 16px;">
            <div style="background: ${C.white}; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <div style="font-size: 11px; color: ${C.gray500}; margin-bottom: 6px;">ì—° ë§¤ì¶œ</div>
              <div style="font-size: 20px; font-weight: 700; color: ${C.black};">${(totalSalesAmount / 100000000).toFixed(2)}ì–µ</div>
              <div style="background: ${C.gray100}; height: 4px; border-radius: 2px; margin-top: 8px;"><div style="background: ${getProgressColor(revenueProgress)}; height: 100%; width: ${revenueProgress}%; border-radius: 2px;"></div></div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <div style="font-size: 11px; color: ${C.gray500}; margin-bottom: 6px;">ì—° ìˆœìµ</div>
              <div style="font-size: 20px; font-weight: 700; color: ${totalProfitAmount >= 0 ? C.green : C.red};">${formatNumber(totalProfitAmount)}ì›</div>
              <div style="display: flex; justify-content: space-between; font-size: 9px; color: ${C.gray400}; margin-top: 4px;">
                <span>ìì‚¬ ${formatNumber(inhouseProfitAmt)}ì›</span>
                <span>íƒ€ì‚¬ ${formatNumber(externalProfitAmt)}ì›</span>
              </div>
            </div>
            <div style="background: ${weeklyProgress >= 100 ? C.greenLight : C.blueLight}; border-radius: 12px; padding: 14px;">
              <div style="font-size: 11px; color: ${C.gray600}; margin-bottom: 6px;">ğŸ“… ì´ë²ˆ ì£¼</div>
              <div style="font-size: 20px; font-weight: 700; color: ${weeklyProgress >= 100 ? C.green : C.blue};">${thisWeekDeals.length}<span style="font-size: 12px; color: ${C.gray500};">/${weeklyTargetDeals}</span></div>
              <div style="font-size: 10px; color: ${C.gray600}; margin-top: 4px;">${weeklyProgress >= 100 ? 'âœ… ë‹¬ì„±' : `${Math.max(weeklyTargetDeals - thisWeekDeals.length, 0)}ê±´ í•„ìš”`}</div>
            </div>
            <div style="background: ${monthlyProgress >= 100 ? C.greenLight : C.gray50}; border-radius: 12px; padding: 14px;">
              <div style="font-size: 11px; color: ${C.gray600}; margin-bottom: 6px;">ğŸ“† ì´ë²ˆ ë‹¬</div>
              <div style="font-size: 20px; font-weight: 700; color: ${monthlyProgress >= 100 ? C.green : C.black};">${monthDeals.length}<span style="font-size: 12px; color: ${C.gray500};">/${monthlyTargetDeals}</span></div>
              <div style="font-size: 10px; color: ${C.gray600}; margin-top: 4px;">${monthlyProgress >= 100 ? 'âœ… ë‹¬ì„±' : `${Math.max(monthlyTargetDeals - monthDeals.length, 0)}ê±´ í•„ìš”`}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <div style="font-size: 11px; color: ${C.gray500}; margin-bottom: 6px;">ë‚¨ì€ ê³µêµ¬</div>
              <div style="font-size: 20px; font-weight: 700; color: ${C.black};">${remainingTotalDeals}ê±´</div>
              <div style="font-size: 10px; color: ${C.gray500}; margin-top: 4px;">ì£¼ ${weeklyNeededDeals} / ì›” ${monthlyNeededDeals}</div>
            </div>
            <div style="background: ${commission30Ratio >= T.commission30Ratio ? C.greenLight : C.white}; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <div style="font-size: 11px; color: ${C.gray500}; margin-bottom: 6px;">30% ìˆ˜ìˆ˜ë£Œ</div>
              <div style="font-size: 20px; font-weight: 700; color: ${commission30Ratio >= T.commission30Ratio ? C.green : C.yellow};">${commission30Ratio}%</div>
              <div style="font-size: 10px; color: ${C.gray500}; margin-top: 4px;">ëª©í‘œ ${T.commission30Ratio}%</div>
            </div>
          </div>

          <!-- íŒ€ì›ë³„ ì˜ì—… ì„±ê³¼ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.black};">ğŸ‘¥ íŒ€ì›ë³„ ì˜ì—… ì„±ê³¼ (${currentYear}ë…„)</div>
              <div style="font-size: 12px; color: ${C.gray400};">ì „ì²´ ê³µê¸‰ì‚¬ ${state.suppliers?.length || 0}ê°œ Â· ì…€ëŸ¬ ${state.sellers?.length || 0}ëª…</div>
            </div>

            ${memberStats.length === 0 ? `
              <div style="text-align: center; padding: 40px; color: ${C.gray500};">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            ` : `
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead>
                    <tr style="background: ${C.gray50}; border-bottom: 2px solid ${C.gray200};">
                      <th style="padding: 14px 12px; text-align: left; font-weight: 600; color: ${C.gray700};">íŒ€ì›</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ê³µê¸‰ì‚¬</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì…€ëŸ¬</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì—° ê³µêµ¬</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì´ë²ˆë‹¬</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì„±ê³µ</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì„±ê³µë¥ </th>
                      <th style="padding: 14px 12px; text-align: right; font-weight: 600; color: ${C.gray700};">ë§¤ì¶œ</th>
                      <th style="padding: 14px 12px; text-align: right; font-weight: 600; color: ${C.gray700};">ìˆœìµ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${memberStats.map(m => {
                      const rateColor = m.successRate >= 30 ? C.green : m.successRate >= 20 ? C.yellow : C.red;
                      const rateBg = m.successRate >= 30 ? C.greenLight : m.successRate >= 20 ? C.yellowLight : C.redLight;
                      return `
                        <tr style="border-bottom: 1px solid ${C.gray100};">
                          <td style="padding: 14px 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, ${C.primary}, #3B82F6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px;">
                                ${(m.name || m.id || '?').charAt(0)}
                              </div>
                              <div>
                                <div style="font-weight: 600; color: ${C.black};">${m.name || m.id}</div>
                                <div style="font-size: 11px; color: ${C.gray400};">${m.role === 'admin' ? 'ê´€ë¦¬ì' : m.role === 'manager' ? 'ë§¤ë‹ˆì €' : 'íŒ€ì›'}</div>
                              </div>
                            </div>
                          </td>
                          <td style="padding: 14px 12px; text-align: center; font-weight: 500;">${m.suppliers}</td>
                          <td style="padding: 14px 12px; text-align: center; font-weight: 500;">${m.sellers}</td>
                          <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.black};">${m.yearDeals}</td>
                          <td style="padding: 14px 12px; text-align: center; color: ${C.blue}; font-weight: 600;">${m.monthDeals}</td>
                          <td style="padding: 14px 12px; text-align: center; color: ${C.green}; font-weight: 600;">${m.successDeals}</td>
                          <td style="padding: 14px 12px; text-align: center;">
                            <span style="background: ${rateBg}; color: ${rateColor}; padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 12px;">${m.successRate}%</span>
                          </td>
                          <td style="padding: 14px 12px; text-align: right; font-weight: 500; color: ${C.gray700};">${formatNumber(m.sales)}ì›</td>
                          <td style="padding: 14px 12px; text-align: right; font-weight: 600; color: ${C.green};">${formatNumber(m.profit)}ì›</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                  <tfoot>
                    <tr style="background: ${C.gray50}; border-top: 2px solid ${C.gray200};">
                      <td style="padding: 14px 12px; font-weight: 700; color: ${C.black};">í•©ê³„</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700;">${state.suppliers?.length || 0}</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700;">${state.sellers?.length || 0}</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700;">${yearDeals.length}</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: ${C.blue};">${monthDeals.length}</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: ${C.green};">${successfulDeals.length}</td>
                      <td style="padding: 14px 12px; text-align: center;">
                        <span style="background: ${currentSuccessRate >= 30 ? C.greenLight : currentSuccessRate >= 20 ? C.yellowLight : C.redLight}; color: ${currentSuccessRate >= 30 ? C.green : currentSuccessRate >= 20 ? C.yellow : C.red}; padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 12px;">${currentSuccessRate}%</span>
                      </td>
                      <td style="padding: 14px 12px; text-align: right; font-weight: 700; color: ${C.gray900};">${formatNumber(totalSalesAmount)}ì›</td>
                      <td style="padding: 14px 12px; text-align: right; font-weight: 700; color: ${C.green};">${formatNumber(totalProfitAmount)}ì›</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            `}
          </div>

          <!-- TOP ì„±ê³¼ ë­í‚¹ -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <!-- ê³µê¸‰ì‚¬ TOP -->
            <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 15px; font-weight: 700; color: ${C.black};">ğŸ­ ê³µê¸‰ì‚¬ íŒë§¤ TOP</div>
              </div>
              ${topSuppliers.length === 0 ? `
                <div style="text-align: center; padding: 24px; color: ${C.gray400}; font-size: 13px;">ë°ì´í„° ì—†ìŒ</div>
              ` : topSuppliers.map((s, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; ${i < topSuppliers.length - 1 ? `border-bottom: 1px solid ${C.gray100};` : ''}">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: ${i < 3 ? C.primary : C.gray200}; color: ${i < 3 ? 'white' : C.gray600}; border-radius: 50%; font-size: 11px; font-weight: 700;">${i + 1}</span>
                    <span style="font-size: 13px; color: ${C.gray700};">${s.name}</span>
                  </div>
                  <span style="font-size: 12px; font-weight: 600; color: ${C.gray600};">${formatNumber(s.sales)}ì›</span>
                </div>
              `).join('')}
            </div>

            <!-- ì…€ëŸ¬ TOP -->
            <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 15px; font-weight: 700; color: ${C.black};">ğŸ‘¤ ì…€ëŸ¬ íŒë§¤ TOP</div>
              </div>
              ${topSellers.length === 0 ? `
                <div style="text-align: center; padding: 24px; color: ${C.gray400}; font-size: 13px;">ë°ì´í„° ì—†ìŒ</div>
              ` : topSellers.map((s, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; ${i < topSellers.length - 1 ? `border-bottom: 1px solid ${C.gray100};` : ''}">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: ${i < 3 ? C.green : C.gray200}; color: ${i < 3 ? 'white' : C.gray600}; border-radius: 50%; font-size: 11px; font-weight: 700;">${i + 1}</span>
                    <span style="font-size: 13px; color: ${C.gray700};">${s.name}</span>
                  </div>
                  <span style="font-size: 12px; font-weight: 600; color: ${C.gray600};">${formatNumber(s.sales)}ì›</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- ğŸ“‹ ì˜¨ë³´ë”© ì§„ì²™ë„ -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 20px;">
            <!-- ì…€ëŸ¬ ì˜¨ë³´ë”© ì§„ì²™ë„ -->
            <div style="background: ${C.white}; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 15px; font-weight: 700; color: #B45309;">ğŸ¤ ì…€ëŸ¬ ì˜¨ë³´ë”© ì§„ì²™ë„</div>
                <span style="font-size: 20px; font-weight: 800; color: ${sellerOnboardingProgress >= 70 ? C.green : sellerOnboardingProgress >= 40 ? C.yellow : C.red};">${sellerOnboardingProgress}%</span>
              </div>
              <div style="background: ${C.gray100}; border-radius: 8px; height: 8px; margin-bottom: 16px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #F59E0B, #D97706); height: 100%; width: ${sellerOnboardingProgress}%; border-radius: 8px; transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 12px;">ì˜¨ë³´ë”© ì§„í–‰ ì¤‘: <strong style="color: #B45309;">${sellerOnboardingStats.total}ê±´</strong></div>
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 11px;">
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obContact > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“</div>
                  <div style="color: ${C.gray600};">ì»¨íƒ</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obContact}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obGuide > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“˜</div>
                  <div style="color: ${C.gray600};">ê°€ì´ë“œ</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obGuide}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obForm > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“„</div>
                  <div style="color: ${C.gray600};">ì‹ ì²­ì„œ</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obForm}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obBank > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ¦</div>
                  <div style="color: ${C.gray600};">ê³„ì¢Œ</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obBank}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obIdCard > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸªª</div>
                  <div style="color: ${C.gray600};">ì‹ ë¶„ì¦</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obIdCard}</div>
                </div>
              </div>
            </div>

            <!-- ê³µê¸‰ì‚¬ ì˜¨ë³´ë”© ì§„ì²™ë„ -->
            <div style="background: ${C.white}; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 15px; font-weight: 700; color: #4338CA;">ğŸ¤ ê³µê¸‰ì‚¬ ì˜¨ë³´ë”© ì§„ì²™ë„</div>
                <span style="font-size: 20px; font-weight: 800; color: ${supplierOnboardingProgress >= 70 ? C.green : supplierOnboardingProgress >= 40 ? C.yellow : C.red};">${supplierOnboardingProgress}%</span>
              </div>
              <div style="background: ${C.gray100}; border-radius: 8px; height: 8px; margin-bottom: 16px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #6366F1, #4338CA); height: 100%; width: ${supplierOnboardingProgress}%; border-radius: 8px; transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 12px;">ì˜¨ë³´ë”© ì§„í–‰ ì¤‘: <strong style="color: #4338CA;">${supplierOnboardingStats.total}ê±´</strong></div>
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 11px;">
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obContact > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“</div>
                  <div style="color: ${C.gray600};">ì»¨íƒ</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obContact}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obGuide > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“˜</div>
                  <div style="color: ${C.gray600};">ê°€ì´ë“œ</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obGuide}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obProductInfo > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“¦</div>
                  <div style="color: ${C.gray600};">ìƒí’ˆì •ë³´</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obProductInfo}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obBizLicense > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ¢</div>
                  <div style="color: ${C.gray600};">ì‚¬ì—…ì</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obBizLicense}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obBank > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ¦</div>
                  <div style="color: ${C.gray600};">í†µì¥</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obBank}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ğŸ“Š íŒ€ì›ë³„ íŒŒì´í”„ë¼ì¸ ì„±ê³¼ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.black};">ğŸ“Š íŒ€ì›ë³„ íŒŒì´í”„ë¼ì¸ ì„±ê³¼</div>
            </div>

            ${memberStats.length === 0 ? `
              <div style="text-align: center; padding: 40px; color: ${C.gray500};">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            ` : `
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                  <thead>
                    <tr style="background: linear-gradient(135deg, #EEF2FF, #FEF3C7);">
                      <th rowspan="2" style="padding: 10px 8px; text-align: left; font-weight: 600; color: ${C.gray700}; border-bottom: 2px solid ${C.gray200};">íŒ€ì›</th>
                      <th colspan="4" style="padding: 8px; text-align: center; font-weight: 700; color: #B45309; border-bottom: 1px solid #FCD34D; background: #FEF3C7;">
                        ğŸ‘¤ ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸
                      </th>
                      <th colspan="4" style="padding: 8px; text-align: center; font-weight: 700; color: #4338CA; border-bottom: 1px solid #C7D2FE; background: #EEF2FF;">
                        ğŸ“¦ ìƒí’ˆ íŒŒì´í”„ë¼ì¸
                      </th>
                    </tr>
                    <tr style="background: ${C.gray50};">
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ë¦¬ìŠ¤íŠ¸ì—…</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ì œì•ˆ</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ì˜¨ë³´ë”©</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: #B45309; border-bottom: 2px solid ${C.gray200};">ê³„ì•½</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ë¦¬ìŠ¤íŠ¸ì—…</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ì œì•ˆ</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ì˜¨ë³´ë”©</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: #4338CA; border-bottom: 2px solid ${C.gray200};">ê³„ì•½</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${memberStats.map(m => `
                      <tr style="border-bottom: 1px solid ${C.gray100};">
                        <td style="padding: 12px 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, ${C.primary}, #3B82F6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">
                              ${(m.name || m.id || '?').charAt(0)}
                            </div>
                            <span style="font-weight: 600; color: ${C.black};">${m.name || m.id}</span>
                          </div>
                        </td>
                        <td style="padding: 8px 6px; text-align: center; font-weight: 600;">${m.sellerPipeline.total}</td>
                        <td style="padding: 8px 6px; text-align: center; color: ${m.sellerPipeline.proposed > 0 ? C.green : C.gray400};">${m.sellerPipeline.proposed}</td>
                        <td style="padding: 8px 6px; text-align: center; color: ${m.sellerPipeline.onboarding > 0 ? C.blue : C.gray400};">${m.sellerPipeline.onboarding}</td>
                        <td style="padding: 8px 6px; text-align: center;"><span style="background: ${m.sellerPipeline.contracted > 0 ? '#FEF3C7' : C.gray100}; color: ${m.sellerPipeline.contracted > 0 ? '#B45309' : C.gray400}; padding: 2px 8px; border-radius: 10px; font-weight: 700;">${m.sellerPipeline.contracted}</span></td>
                        <td style="padding: 8px 6px; text-align: center; font-weight: 600;">${m.supplierPipeline.total}</td>
                        <td style="padding: 8px 6px; text-align: center; color: ${m.supplierPipeline.proposed > 0 ? C.green : C.gray400};">${m.supplierPipeline.proposed}</td>
                        <td style="padding: 8px 6px; text-align: center; color: ${m.supplierPipeline.onboarding > 0 ? C.blue : C.gray400};">${m.supplierPipeline.onboarding}</td>
                        <td style="padding: 8px 6px; text-align: center;"><span style="background: ${m.supplierPipeline.contracted > 0 ? '#EEF2FF' : C.gray100}; color: ${m.supplierPipeline.contracted > 0 ? '#4338CA' : C.gray400}; padding: 2px 8px; border-radius: 10px; font-weight: 700;">${m.supplierPipeline.contracted}</span></td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    <tr style="background: ${C.gray50}; border-top: 2px solid ${C.gray200};">
                      <td style="padding: 12px 8px; font-weight: 700;">í•©ê³„</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700;">${memberStats.reduce((sum, m) => sum + m.sellerPipeline.total, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${C.green};">${memberStats.reduce((sum, m) => sum + m.sellerPipeline.proposed, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${C.blue};">${memberStats.reduce((sum, m) => sum + m.sellerPipeline.onboarding, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: #B45309;">${memberStats.reduce((sum, m) => sum + m.sellerPipeline.contracted, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700;">${memberStats.reduce((sum, m) => sum + m.supplierPipeline.total, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${C.green};">${memberStats.reduce((sum, m) => sum + m.supplierPipeline.proposed, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${C.blue};">${memberStats.reduce((sum, m) => sum + m.supplierPipeline.onboarding, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: #4338CA;">${memberStats.reduce((sum, m) => sum + m.supplierPipeline.contracted, 0)}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            `}
          </div>

          <!-- â±ï¸ íŒ€ì›ë³„ íŒŒì´í”„ë¼ì¸ ì†Œìš”ì‹œê°„ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.black};">â±ï¸ íŒ€ì›ë³„ íŒŒì´í”„ë¼ì¸ ì†Œìš”ì‹œê°„</div>
              <div style="font-size: 12px; color: ${C.gray500};">ìƒí’ˆ íŒŒì´í”„ë¼ì¸ ê¸°ì¤€</div>
            </div>

            ${memberStats.length === 0 ? `
              <div style="text-align: center; padding: 40px; color: ${C.gray500};">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            ` : `
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                  <thead>
                    <tr style="background: linear-gradient(135deg, #F0FDF4, #DBEAFE);">
                      <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: ${C.gray700}; border-bottom: 2px solid ${C.gray200};">íŒ€ì›</th>
                      <th colspan="2" style="padding: 10px; text-align: center; font-weight: 700; color: #16a34a; border-bottom: 1px solid #86efac; background: #F0FDF4;">
                        ğŸ“ ì œì•ˆ â†’ ğŸ¤ ì˜¨ë³´ë”©ì™„ë£Œ
                      </th>
                      <th colspan="2" style="padding: 10px; text-align: center; font-weight: 700; color: #8b5cf6; border-bottom: 1px solid #c4b5fd; background: #DBEAFE;">
                        ğŸ“ ì œì•ˆ â†’ ğŸ“„ ê³„ì•½ì™„ë£Œ
                      </th>
                    </tr>
                    <tr style="background: ${C.gray50};">
                      <th style="padding: 8px; border-bottom: 2px solid ${C.gray200};"></th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">í‰ê·  ì†Œìš”ì‹œê°„</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ê±´ìˆ˜</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">í‰ê·  ì†Œìš”ì‹œê°„</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ê±´ìˆ˜</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${memberStats.map(m => `
                      <tr style="border-bottom: 1px solid ${C.gray100};">
                        <td style="padding: 12px 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, ${C.primary}, #3B82F6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">
                              ${(m.name || m.id || '?').charAt(0)}
                            </div>
                            <span style="font-weight: 600; color: ${C.black};">${m.name || m.id}</span>
                          </div>
                        </td>
                        <td style="padding: 8px 6px; text-align: center;">
                          <span style="font-weight: 600; color: ${m.pipelineDurations?.proposalToOnboarding?.avg !== null ? '#16a34a' : C.gray400};">
                            ${formatDuration(m.pipelineDurations?.proposalToOnboarding?.avg)}
                          </span>
                        </td>
                        <td style="padding: 8px 6px; text-align: center; color: ${C.gray500};">
                          ${m.pipelineDurations?.proposalToOnboarding?.count || 0}ê±´
                        </td>
                        <td style="padding: 8px 6px; text-align: center;">
                          <span style="font-weight: 600; color: ${m.pipelineDurations?.proposalToContract?.avg !== null ? '#8b5cf6' : C.gray400};">
                            ${formatDuration(m.pipelineDurations?.proposalToContract?.avg)}
                          </span>
                        </td>
                        <td style="padding: 8px 6px; text-align: center; color: ${C.gray500};">
                          ${m.pipelineDurations?.proposalToContract?.count || 0}ê±´
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    ${(() => {
                      // ì „ì²´ í‰ê·  ê³„ì‚°
                      const totalDurations = calculatePipelineDurations(allProductList);
                      return `
                        <tr style="background: ${C.gray50}; border-top: 2px solid ${C.gray200};">
                          <td style="padding: 12px 8px; font-weight: 700;">ì „ì²´ í‰ê· </td>
                          <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: #16a34a;">
                            ${formatDuration(totalDurations.proposalToOnboarding.avg)}
                          </td>
                          <td style="padding: 8px 6px; text-align: center; font-weight: 600; color: ${C.gray600};">
                            ${totalDurations.proposalToOnboarding.count}ê±´
                          </td>
                          <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: #8b5cf6;">
                            ${formatDuration(totalDurations.proposalToContract.avg)}
                          </td>
                          <td style="padding: 8px 6px; text-align: center; font-weight: 600; color: ${C.gray600};">
                            ${totalDurations.proposalToContract.count}ê±´
                          </td>
                        </tr>
                      `;
                    })()}
                  </tfoot>
                </table>
              </div>

              <!-- ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ (ê³µê¸‰ì‚¬) -->
              ${(() => {
                const totalDurations = calculatePipelineDurations(allProductList);
                const hasData = totalDurations.proposalToOnboarding.count > 0 || totalDurations.proposalToContract.count > 0;
                if (!hasData) return '';

                return `
                  <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    ${totalDurations.proposalToOnboarding.avg !== null ? `
                      <div style="background: linear-gradient(135deg, #F0FDF4, #DCFCE7); border-radius: 12px; padding: 16px; border: 1px solid #86efac;">
                        <div style="font-size: 11px; color: #15803d; font-weight: 600; margin-bottom: 4px;">ğŸ“ â†’ ğŸ¤ í‰ê·  ì˜¨ë³´ë”© ì™„ë£Œ</div>
                        <div style="font-size: 24px; font-weight: 700; color: #16a34a;">${formatDuration(totalDurations.proposalToOnboarding.avg)}</div>
                        <div style="font-size: 11px; color: #22c55e; margin-top: 4px;">${totalDurations.proposalToOnboarding.count}ê±´ ë°ì´í„° ê¸°ì¤€</div>
                      </div>
                    ` : ''}
                    ${totalDurations.proposalToContract.avg !== null ? `
                      <div style="background: linear-gradient(135deg, #F5F3FF, #EDE9FE); border-radius: 12px; padding: 16px; border: 1px solid #c4b5fd;">
                        <div style="font-size: 11px; color: #7c3aed; font-weight: 600; margin-bottom: 4px;">ğŸ“ â†’ ğŸ“„ í‰ê·  ê³„ì•½ ì™„ë£Œ</div>
                        <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;">${formatDuration(totalDurations.proposalToContract.avg)}</div>
                        <div style="font-size: 11px; color: #a78bfa; margin-top: 4px;">${totalDurations.proposalToContract.count}ê±´ ë°ì´í„° ê¸°ì¤€</div>
                      </div>
                    ` : ''}
                  </div>
                `;
              })()}
            `}
          </div>

          <!-- â±ï¸ íŒ€ì›ë³„ ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸ ì†Œìš”ì‹œê°„ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.black};">ğŸ‘©â€ğŸ’¼ íŒ€ì›ë³„ ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸ ì†Œìš”ì‹œê°„</div>
              <div style="font-size: 12px; color: ${C.gray500};">ì…€ëŸ¬ ì œì•ˆ ê¸°ì¤€ (ì•„ì›ƒë°”ìš´ë“œ)</div>
            </div>

            ${memberStats.length === 0 ? `
              <div style="text-align: center; padding: 40px; color: ${C.gray500};">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            ` : `
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                  <thead>
                    <tr style="background: linear-gradient(135deg, #FEF3C7, #FDE68A);">
                      <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: ${C.gray700}; border-bottom: 2px solid ${C.gray200};">íŒ€ì›</th>
                      <th colspan="2" style="padding: 10px; text-align: center; font-weight: 700; color: #d97706; border-bottom: 1px solid #fcd34d; background: #FEF3C7;">
                        ğŸ“ ì œì•ˆ â†’ ğŸ¤ ì˜¨ë³´ë”©ì™„ë£Œ
                      </th>
                      <th colspan="2" style="padding: 10px; text-align: center; font-weight: 700; color: #ff6b35; border-bottom: 1px solid #ffb5a0; background: #FFF1EB;">
                        ğŸ“ ì œì•ˆ â†’ âœ… ì…ì ì™„ë£Œ
                      </th>
                    </tr>
                    <tr style="background: ${C.gray50};">
                      <th style="padding: 8px; border-bottom: 2px solid ${C.gray200};"></th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">í‰ê·  ì†Œìš”ì‹œê°„</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ê±´ìˆ˜</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">í‰ê·  ì†Œìš”ì‹œê°„</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ê±´ìˆ˜</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${memberStats.map(m => `
                      <tr style="border-bottom: 1px solid ${C.gray100};">
                        <td style="padding: 12px 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #ff6b35, #ff9500); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">
                              ${(m.name || m.id || '?').charAt(0)}
                            </div>
                            <span style="font-weight: 600; color: ${C.black};">${m.name || m.id}</span>
                          </div>
                        </td>
                        <td style="padding: 8px 6px; text-align: center;">
                          <span style="font-weight: 600; color: ${m.sellerPipelineDurations?.proposalToOnboarding?.avg !== null ? '#d97706' : C.gray400};">
                            ${formatDuration(m.sellerPipelineDurations?.proposalToOnboarding?.avg)}
                          </span>
                        </td>
                        <td style="padding: 8px 6px; text-align: center; color: ${C.gray500};">
                          ${m.sellerPipelineDurations?.proposalToOnboarding?.count || 0}ê±´
                        </td>
                        <td style="padding: 8px 6px; text-align: center;">
                          <span style="font-weight: 600; color: ${m.sellerPipelineDurations?.proposalToListed?.avg !== null ? '#ff6b35' : C.gray400};">
                            ${formatDuration(m.sellerPipelineDurations?.proposalToListed?.avg)}
                          </span>
                        </td>
                        <td style="padding: 8px 6px; text-align: center; color: ${C.gray500};">
                          ${m.sellerPipelineDurations?.proposalToListed?.count || 0}ê±´
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    ${(() => {
                      // ì „ì²´ í‰ê·  ê³„ì‚° (ì…€ëŸ¬)
                      const allSellerProposals = state.sellerProposals || [];
                      const totalSellerDurations = calculateSellerPipelineDurations(allSellerProposals);
                      return `
                        <tr style="background: ${C.gray50}; border-top: 2px solid ${C.gray200};">
                          <td style="padding: 12px 8px; font-weight: 700;">ì „ì²´ í‰ê· </td>
                          <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: #d97706;">
                            ${formatDuration(totalSellerDurations.proposalToOnboarding.avg)}
                          </td>
                          <td style="padding: 8px 6px; text-align: center; font-weight: 600; color: ${C.gray600};">
                            ${totalSellerDurations.proposalToOnboarding.count}ê±´
                          </td>
                          <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: #ff6b35;">
                            ${formatDuration(totalSellerDurations.proposalToListed.avg)}
                          </td>
                          <td style="padding: 8px 6px; text-align: center; font-weight: 600; color: ${C.gray600};">
                            ${totalSellerDurations.proposalToListed.count}ê±´
                          </td>
                        </tr>
                      `;
                    })()}
                  </tfoot>
                </table>
              </div>

              <!-- ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ (ì…€ëŸ¬) -->
              ${(() => {
                const allSellerProposals = state.sellerProposals || [];
                const totalSellerDurations = calculateSellerPipelineDurations(allSellerProposals);
                const hasData = totalSellerDurations.proposalToOnboarding.count > 0 || totalSellerDurations.proposalToListed.count > 0;
                if (!hasData) return '';

                return `
                  <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    ${totalSellerDurations.proposalToOnboarding.avg !== null ? `
                      <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 12px; padding: 16px; border: 1px solid #fcd34d;">
                        <div style="font-size: 11px; color: #92400e; font-weight: 600; margin-bottom: 4px;">ğŸ“ â†’ ğŸ¤ ì…€ëŸ¬ í‰ê·  ì˜¨ë³´ë”©</div>
                        <div style="font-size: 24px; font-weight: 700; color: #d97706;">${formatDuration(totalSellerDurations.proposalToOnboarding.avg)}</div>
                        <div style="font-size: 11px; color: #b45309; margin-top: 4px;">${totalSellerDurations.proposalToOnboarding.count}ê±´ ë°ì´í„° ê¸°ì¤€</div>
                      </div>
                    ` : ''}
                    ${totalSellerDurations.proposalToListed.avg !== null ? `
                      <div style="background: linear-gradient(135deg, #FFF1EB, #FFE4D6); border-radius: 12px; padding: 16px; border: 1px solid #ffb5a0;">
                        <div style="font-size: 11px; color: #c2410c; font-weight: 600; margin-bottom: 4px;">ğŸ“ â†’ âœ… ì…€ëŸ¬ í‰ê·  ì…ì ì™„ë£Œ</div>
                        <div style="font-size: 24px; font-weight: 700; color: #ff6b35;">${formatDuration(totalSellerDurations.proposalToListed.avg)}</div>
                        <div style="font-size: 11px; color: #ea580c; margin-top: 4px;">${totalSellerDurations.proposalToListed.count}ê±´ ë°ì´í„° ê¸°ì¤€</div>
                      </div>
                    ` : ''}
                  </div>
                `;
              })()}
            `}
          </div>
        </div>
      `;
    }

    function openGoalCalculator() {
      const currentYear = new Date().getFullYear();
      const goals = state.yearlyGoals || [];
      const currentGoal = goals.find(g => g.year === currentYear) || { revenueTarget: 1000000000 };
      const annualTarget = currentGoal.revenueTarget || 1000000000;

      // ì €ì¥ëœ ê³„ì‚°ê¸° ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
      const saved = state.strategyData || {};
      const defaultAvgDeal = saved.avgDealRevenue || 4630000;
      const defaultSuccessRate = saved.successRate || 30;
      const defaultAvgProfit = saved.avgDealProfit || 200000;

      // í˜„ì¬ ì§„í–‰ ìƒí™©
      const thisYearStr = String(currentYear);
      const yearDeals = (state.deals || []).filter(d => (d.startDate || d.createdAt || '').startsWith(thisYearStr));
      const successDeals = yearDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');
      const yearSettlements = (state.sellerSettlements || []).filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
      const currentRevenue = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);

      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), #1b64da); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ§® ê³µêµ¬ì„¤ê³„ ê³„ì‚°ê¸°</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; max-height: 75vh; overflow-y: auto;">

            <!-- ì—°ë„ë³„ ëª©í‘œ ì—°ë™ í‘œì‹œ -->
            <div style="background: linear-gradient(135deg, #1e3a5f, #0f2744); border-radius: 12px; padding: 16px; margin-bottom: 20px; color: white;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <div>
                  <div style="font-size: 12px; opacity: 0.8;">ğŸ“… ${currentYear}ë…„ ëª©í‘œ (ì—°ë„ë³„ ëª©í‘œì—ì„œ ì—°ë™)</div>
                  <div style="font-size: 28px; font-weight: 700;">${(annualTarget / 100000000).toFixed(0)}ì–µì›</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; opacity: 0.8;">í˜„ì¬ ë‹¬ì„±</div>
                  <div style="font-size: 20px; font-weight: 600;">${(currentRevenue / 100000000).toFixed(2)}ì–µ <span style="font-size: 14px; opacity: 0.8;">(${Math.round(currentRevenue / annualTarget * 100)}%)</span></div>
                </div>
              </div>
              <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; margin-top: 12px; overflow: hidden;">
                <div style="background: ${currentRevenue >= annualTarget ? '#00C471' : '#F59E0B'}; height: 100%; width: ${Math.min(100, currentRevenue / annualTarget * 100)}%;"></div>
              </div>
            </div>

            <!-- ì‹œë®¬ë ˆì´ì…˜ ì…ë ¥ -->
            <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 16px; font-size: 15px;">âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                <div>
                  <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px;">ê³µêµ¬ë‹¹ í‰ê·  íŒë§¤ì•¡</label>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <input type="number" id="calcAvgDeal" value="${defaultAvgDeal / 10000}"
                      oninput="updateGoalCalculation()"
                      style="flex: 1; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                    <span style="font-size: 14px; color: var(--gray-600);">ë§Œì›</span>
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px;">ëª©í‘œ ì„±ê³µë¥ </label>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <input type="number" id="calcSuccessRate" value="${defaultSuccessRate}" min="1" max="100"
                      oninput="updateGoalCalculation()"
                      style="flex: 1; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                    <span style="font-size: 14px; color: var(--gray-600);">%</span>
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px;">ê³µêµ¬ë‹¹ í‰ê·  ìˆœìµ</label>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <input type="number" id="calcAvgProfit" value="${defaultAvgProfit / 10000}"
                      oninput="updateGoalCalculation()"
                      style="flex: 1; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                    <span style="font-size: 14px; color: var(--gray-600);">ë§Œì›</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- ê³„ì‚° ê²°ê³¼ -->
            <div id="calcResultArea">
              <!-- updateGoalCalculation()ì—ì„œ ë™ì  ë Œë”ë§ -->
            </div>

            <!-- í˜„ì¬ ì§„í–‰ ìƒí™© ë¹„êµ -->
            <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-top: 20px;">
              <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 16px; font-size: 15px;">ğŸ“Š í˜„ì¬ ì§„í–‰ ìƒí™©</div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                <div style="background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--gray-200);">
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">ì§„í–‰ ê³µêµ¬</div>
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${yearDeals.length}</div>
                </div>
                <div style="background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--gray-200);">
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">ì„±ê³µ ê³µêµ¬</div>
                  <div style="font-size: 24px; font-weight: 700; color: #00C471;">${successDeals.length}</div>
                </div>
                <div style="background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--gray-200);">
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">í˜„ì¬ ì„±ê³µë¥ </div>
                  <div style="font-size: 24px; font-weight: 700; color: #F59E0B;">${yearDeals.length > 0 ? Math.round(successDeals.length / yearDeals.length * 100) : 0}%</div>
                </div>
                <div style="background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--gray-200);">
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">ë‹¬ì„± ë§¤ì¶œ</div>
                  <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">${(currentRevenue / 100000000).toFixed(1)}ì–µ</div>
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer" style="border-top: 1px solid var(--gray-200); padding: 16px 20px; display: flex; justify-content: space-between;">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            <button class="btn btn-primary" onclick="saveCalculatorSettings()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
          </div>
        </div>
      `;

      // ì´ˆê¸° ê³„ì‚° ì‹¤í–‰
      updateGoalCalculation();
    }

    function updateGoalCalculation() {
      const currentYear = new Date().getFullYear();
      const goals = state.yearlyGoals || [];
      const currentGoal = goals.find(g => g.year === currentYear) || { revenueTarget: 1000000000 };
      const annualTarget = currentGoal.revenueTarget || 1000000000;

      const avgDeal = (parseFloat(document.getElementById('calcAvgDeal')?.value) || 463) * 10000;
      const successRate = parseFloat(document.getElementById('calcSuccessRate')?.value) || 30;
      const avgProfit = (parseFloat(document.getElementById('calcAvgProfit')?.value) || 20) * 10000;

      // ê³„ì‚°
      const requiredSuccessDeals = Math.ceil(annualTarget / avgDeal);
      const requiredTotalDeals = Math.ceil(requiredSuccessDeals / (successRate / 100));
      const monthlyDeals = Math.ceil(requiredTotalDeals / 12);
      const weeklyDeals = Math.ceil(requiredTotalDeals / 52);
      const monthlySuccess = Math.ceil(requiredSuccessDeals / 12);
      const expectedProfit = requiredSuccessDeals * avgProfit;

      // ë‚¨ì€ ê¸°ê°„ ê³„ì‚°
      const now = new Date();
      const yearEnd = new Date(currentYear, 11, 31);
      const remainingDays = Math.ceil((yearEnd - now) / (1000 * 60 * 60 * 24));
      const remainingWeeks = Math.ceil(remainingDays / 7);
      const remainingMonths = 12 - now.getMonth();

      // í˜„ì¬ ì§„í–‰ ìƒí™©
      const thisYearStr = String(currentYear);
      const yearDeals = (state.deals || []).filter(d => (d.startDate || d.createdAt || '').startsWith(thisYearStr));
      const successDeals = yearDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');
      const yearSettlements = (state.sellerSettlements || []).filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
      const currentRevenue = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);

      // ë‚¨ì€ ëª©í‘œ ê³„ì‚°
      const remainingRevenue = Math.max(0, annualTarget - currentRevenue);
      const remainingSuccessDeals = Math.max(0, requiredSuccessDeals - successDeals.length);
      const remainingTotalDeals = Math.ceil(remainingSuccessDeals / (successRate / 100));
      const neededWeeklyDeals = Math.ceil(remainingTotalDeals / Math.max(remainingWeeks, 1));
      const neededMonthlyDeals = Math.ceil(remainingTotalDeals / Math.max(remainingMonths, 1));

      // ë‹¬ì„± ê°€ëŠ¥ì„± íŒë‹¨
      const isOnTrack = neededWeeklyDeals <= weeklyDeals * 1.5;
      const statusColor = isOnTrack ? '#00C471' : '#F04452';
      const statusBg = isOnTrack ? '#E8F8F0' : '#FEE2E4';
      const statusText = isOnTrack ? 'ë‹¬ì„± ê°€ëŠ¥' : 'âš ï¸ ì£¼ì˜ í•„ìš”';

      const container = document.getElementById('calcResultArea');
      if (!container) return;

      container.innerHTML = `
        <!-- ëª©í‘œ ë‹¬ì„± ê°€ì´ë“œ -->
        <div style="background: linear-gradient(135deg, var(--primary), #1b64da); border-radius: 16px; padding: 24px; color: white; margin-bottom: 20px;">
          <div style="font-weight: 700; margin-bottom: 16px; font-size: 15px;">ğŸ“Š ëª©í‘œ ë‹¬ì„± ê°€ì´ë“œ</div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 16px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;">${requiredTotalDeals}</div>
              <div style="font-size: 11px; opacity: 0.8;">ì—° í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 16px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;">${monthlyDeals}</div>
              <div style="font-size: 11px; opacity: 0.8;">ì›” í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 16px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;">${weeklyDeals}</div>
              <div style="font-size: 11px; opacity: 0.8;">ì£¼ í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 16px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;">${requiredSuccessDeals}</div>
              <div style="font-size: 11px; opacity: 0.8;">ì—° ì„±ê³µ ëª©í‘œ</div>
            </div>
          </div>
        </div>

        <!-- ì„±ê³µ ê³µì‹ -->
        <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="font-weight: 700; color: #2E7D32; margin-bottom: 8px;">âœ… ì„±ê³µ ê³µì‹</div>
          <div style="font-size: 13px; color: #388E3C; line-height: 1.8;">
            <strong>ê³„ì‚°:</strong> ${(annualTarget/100000000).toFixed(0)}ì–µ Ã· ${(avgDeal/10000).toFixed(0)}ë§Œì› = <strong>${requiredSuccessDeals}ê±´</strong> ì„±ê³µ í•„ìš”<br>
            <strong>ì‹¤íŒ¨ìœ¨ ê³ ë ¤:</strong> ${requiredSuccessDeals}ê±´ Ã· ${successRate}% = <strong>${requiredTotalDeals}ê±´</strong> ì´ ì§„í–‰ í•„ìš”<br>
            <strong>ì›”ë³„:</strong> ${monthlyDeals}ê±´ ì§„í–‰ Ã— ${successRate}% = ì›” ${monthlySuccess}ê±´ ì„±ê³µ<br>
            <strong>ì˜ˆìƒ ìˆœìµ:</strong> ${requiredSuccessDeals}ê±´ Ã— ${(avgProfit/10000).toFixed(0)}ë§Œì› = <strong>${(expectedProfit/100000000).toFixed(1)}ì–µì›</strong>
          </div>
        </div>

        <!-- ë‚¨ì€ ëª©í‘œ & ê²½ê³  -->
        <div style="background: ${statusBg}; border: 2px solid ${statusColor}; border-radius: 12px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-weight: 700; color: ${statusColor};">ğŸ“… ë‚¨ì€ ëª©í‘œ (${remainingMonths}ê°œì›” ${remainingDays % 30}ì¼)</div>
            <div style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${statusText}</div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: var(--gray-500);">ë‚¨ì€ ë§¤ì¶œ</div>
              <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${(remainingRevenue/100000000).toFixed(1)}ì–µ</div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: var(--gray-500);">ë‚¨ì€ ì„±ê³µ</div>
              <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${remainingSuccessDeals}ê±´</div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: var(--gray-500);">ì£¼ë‹¹ í•„ìš”</div>
              <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${neededWeeklyDeals}ê±´</div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: var(--gray-500);">ì›”ë‹¹ í•„ìš”</div>
              <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${neededMonthlyDeals}ê±´</div>
            </div>
          </div>
          ${!isOnTrack ? `
            <div style="background: #F04452; color: white; border-radius: 8px; padding: 12px; margin-top: 12px; font-size: 13px;">
              <strong>âš ï¸ ê²½ê³ :</strong> í˜„ì¬ ì†ë„ë¡œëŠ” ëª©í‘œ ë‹¬ì„±ì´ ì–´ë µìŠµë‹ˆë‹¤.
              ì£¼ë‹¹ ${neededWeeklyDeals}ê±´ í•„ìš” (ê¸°ì¡´ ëª©í‘œ ${weeklyDeals}ê±´ ëŒ€ë¹„ ${Math.round((neededWeeklyDeals/weeklyDeals - 1) * 100)}% ì¦ê°€ í•„ìš”)
            </div>
          ` : ''}
        </div>
      `;
    }

    async function saveCalculatorSettings() {
      try {
        const avgDeal = (parseFloat(document.getElementById('calcAvgDeal')?.value) || 463) * 10000;
        const successRate = parseFloat(document.getElementById('calcSuccessRate')?.value) || 30;
        const avgProfit = (parseFloat(document.getElementById('calcAvgProfit')?.value) || 20) * 10000;

        const currentYear = new Date().getFullYear();
        const goals = state.yearlyGoals || [];
        const currentGoal = goals.find(g => g.year === currentYear) || { revenueTarget: 1000000000 };
        const annualTarget = currentGoal.revenueTarget || 1000000000;

        const requiredSuccessDeals = Math.ceil(annualTarget / avgDeal);
        const requiredTotalDeals = Math.ceil(requiredSuccessDeals / (successRate / 100));

        const settings = {
          avgDealRevenue: avgDeal,
          avgDealProfit: avgProfit,
          successRate: successRate,
          annualRevenue: annualTarget,
          annualProfit: requiredSuccessDeals * avgProfit,
          targetSuccessDeals: requiredSuccessDeals,
          monthlySuccessDeals: Math.ceil(requiredSuccessDeals / 12),
          requiredTotalDeals: requiredTotalDeals,
          monthlyRequiredDeals: Math.ceil(requiredTotalDeals / 12),
          weeklyRequiredDeals: Math.ceil(requiredTotalDeals / 52),
          updatedAt: new Date().toISOString()
        };

        await db.collection('settings').doc('strategy').set(settings, { merge: true });
        state.strategyData = { ...state.strategyData, ...settings };

        showToast('ê³„ì‚°ê¸° ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();

        // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
        if (state.currentTab === 'dashboard') {
          renderSalesDashboard();
        }
      } catch (e) {
        console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ========================================
    // ì—…ë¬´ê°€ì´ë“œ ì‹œìŠ¤í…œ
    // ========================================
    let guideTab = 'essence';

    function renderGuide() {
      const container = document.getElementById('guideContent');
      if (!container) return;

      container.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="background: linear-gradient(135deg, var(--primary), #e08600); color: white; padding: 28px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 16px rgba(49, 130, 246, 0.2);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="font-size: 36px;">ğŸ“š</div>
              <div>
                <div style="font-size: 24px; font-weight: 700;">ëª¨ì—¬ë¼ë”œ ì—…ë¬´ ê°€ì´ë“œ</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">ì‹ ê·œ íŒ€ì›ì„ ìœ„í•œ ìƒì„¸ ê°€ì´ë“œ - ë³¸ì§ˆë¶€í„° ì‹¤ë¬´ê¹Œì§€</div>
              </div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; margin-top: 12px;">
              <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px;">ğŸ’¡ ëª¨ì—¬ë¼ë”œ í•µì‹¬ ì •ì˜</div>
              <div style="font-size: 15px; line-height: 1.6;">"<strong>ì‚¬ëŒì˜ ì‹ ë¢°</strong>ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼"</div>
            </div>
          </div>

          <!-- íƒ­ ë©”ë‰´ -->
          <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--gray-200); padding-bottom: 8px; flex-wrap: wrap;">
            <button onclick="switchGuideTab('essence')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'essence' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ¯ ë³¸ì§ˆ ë©”ì‹œì§€
            </button>
            <button onclick="switchGuideTab('process')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'process' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ“‹ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤
            </button>
            <button onclick="switchGuideTab('partner')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'partner' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ¤ íŒŒíŠ¸ë„ˆ ì‘ëŒ€
            </button>
            <button onclick="switchGuideTab('menu')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'menu' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ“‘ ë©”ë‰´ ì„¤ëª…
            </button>
            <button onclick="switchGuideTab('feature')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'feature' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              âš™ï¸ ì£¼ìš” ê¸°ëŠ¥
            </button>
            <button onclick="switchGuideTab('pipeline')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'pipeline' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ“Š íŒŒì´í”„ë¼ì¸
            </button>
            <button onclick="switchGuideTab('cafe24')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'cafe24' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ›’ ì¹´í˜24 í˜ì´ì§€
            </button>
          </div>

          <!-- ì»¨í…ì¸  ì˜ì—­ -->
          <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
            ${getGuideContent(guideTab)}
          </div>
        </div>
      `;
    }

    function switchGuideTab(tab) {
      guideTab = tab;
      renderGuide();
    }

    function getGuideContent(tab) {
      switch(tab) {
        case 'essence': return getGuideEssenceContent();
        case 'process': return getGuideProcessContent();
        case 'partner': return getGuidePartnerContent();
        case 'menu': return getGuideMenuContent();
        case 'feature': return getGuideFeatureContent();
        case 'pipeline': return getGuidePipelineContent();
        case 'cafe24': return getGuideCafe24Content();
        default: return getGuideEssenceContent();
      }
    }

    function getGuideEssenceContent() {
      return `
        <!-- í•µì‹¬ ê°€ì¹˜ -->
        <div style="text-align: center; padding: 20px 0 30px;">
          <div style="font-size: 28px; font-weight: 700; color: #191F28; margin-bottom: 12px;">ì™œ ëª¨ì—¬ë¼ë”œì¸ê°€?</div>
          <div style="font-size: 16px; color: #6B7684; max-width: 600px; margin: 0 auto; line-height: 1.6;">
            ê´‘ê³  ì‹ ë¢°ë„ëŠ” í•˜ë½í•˜ê³ , 'ì‚¬ëŒ ì¶”ì²œ'ì˜ ê°€ì¹˜ëŠ” ìƒìŠ¹í•©ë‹ˆë‹¤.<br>
            ëª¨ì—¬ë¼ë”œì€ <strong>"ì‹ ë¢° â†’ êµ¬ë§¤"</strong> êµ¬ì¡°ì— ìµœì í™”ëœ í”Œë«í¼ì…ë‹ˆë‹¤.
          </div>
        </div>

        <!-- 3ëŒ€ ê³ ê° ê°€ì¹˜ ì¹´ë“œ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <!-- ê³µê¸‰ì‚¬ -->
          <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border-radius: 16px; padding: 24px; border: 1px solid #C7D2FE;">
            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ­</div>
            <div style="font-size: 18px; font-weight: 700; color: #4338CA; margin-bottom: 8px;">ê³µê¸‰ì‚¬</div>
            <div style="font-size: 13px; color: #6366F1; font-weight: 600; margin-bottom: 16px;">"ì¢‹ì€ ì œí’ˆì´ ë” ë¹ ë¥´ê³  íš¨ìœ¨ì ìœ¼ë¡œ íŒ”ë¦¬ëŠ” êµ¬ì¡°"</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
              âœ“ ì´ˆê¸°ë¹„ìš© <strong>0ì›</strong><br>
              âœ“ í”„ë¦¬ë¯¸ì—„ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬ë¡œ <strong>ë¹ ë¥¸ í™•ì‚°</strong><br>
              âœ“ ì´ë²¤íŠ¸ ê¸°íšÂ·ì‚¬ì€í’ˆÂ·íŒ¨í‚¤ì§•Â·ê²°ì œì°½ <strong>ì¼ê´„ ì§€ì›</strong><br>
              âœ“ <strong>3~7ì¼ ë‚´ ë¹ ë¥¸ ì •ì‚°</strong>, ì¶”ê°€ ê´€ë¦¬ë¹„ ì—†ìŒ<br>
              âœ“ ì½˜í…ì¸  <strong>2ì°¨ ë§ˆì¼€íŒ… í™œìš©</strong> ê°€ëŠ¥
            </div>
          </div>

          <!-- ì…€ëŸ¬ -->
          <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 24px; border: 1px solid #FCD34D;">
            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ‘©â€ğŸ’¼</div>
            <div style="font-size: 18px; font-weight: 700; color: #B45309; margin-bottom: 8px;">ì…€ëŸ¬</div>
            <div style="font-size: 13px; color: #D97706; font-weight: 600; margin-bottom: 16px;">"ì½˜í…ì¸ ëŠ” ì…€ëŸ¬ê°€, êµ¬ì¡°ëŠ” ëª¨ì—¬ë¼ë”œì´"</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
              âœ“ ì´ˆê¸°ë¹„ìš© <strong>0ì›</strong><br>
              âœ“ ê¸°íšÂ·ë””ìì¸Â·ê²°ì œÂ·ì •ì‚°ê¹Œì§€ <strong>í’€ì„œí¬íŠ¸</strong><br>
              âœ“ ì „ì† ê³„ì•½ ê¸°ë°˜ <strong>ìˆ˜ìµ ì•ˆì •ì„±</strong> í™•ë³´<br>
              âœ“ ë¸Œëœë“œ ì§ê±°ë˜/ì •ì‚° <strong>ë¦¬ìŠ¤í¬ ì°¨ë‹¨</strong><br>
              âœ“ ì„±ì¥ ì‹œ ìˆ˜ìˆ˜ë£Œ ìƒìŠ¹, <strong>ë¸Œëœë“œí™”ê¹Œì§€ í™•ì¥</strong>
            </div>
          </div>

          <!-- ì†Œë¹„ì -->
          <div style="background: linear-gradient(135deg, #DCFCE7, #BBF7D0); border-radius: 16px; padding: 24px; border: 1px solid #86EFAC;">
            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ›’</div>
            <div style="font-size: 18px; font-weight: 700; color: #166534; margin-bottom: 8px;">ì†Œë¹„ì</div>
            <div style="font-size: 13px; color: #16A34A; font-weight: 600; margin-bottom: 16px;">"ì‹ ë¢°ë¥¼ ì „ì œë¡œ í•œ ê³µë™êµ¬ë§¤ ê²½í—˜"</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
              âœ“ ê´‘ê³ ê°€ ì•„ë‹Œ, <strong>ì‹¤ì œ ì‚¬ìš© ê¸°ë°˜ ì¶”ì²œ</strong><br>
              âœ“ ê³µì‹ ë¸Œëœë“œ ì—°ë™ìœ¼ë¡œ <strong>ê°€ê²©Â·í’ˆì§ˆ ì‹ ë¢°</strong><br>
              âœ“ <strong>ë³µì¡í•œ ê²½ë¡œ ì—†ëŠ”</strong> ê°„í¸ êµ¬ë§¤<br>
              âœ“ ì…€ëŸ¬ê°€ ì§ì ‘ ì¨ë³´ê³  ì¢‹ì•˜ë˜ ì œí’ˆ<br>
              âœ“ <strong>í•©ë¦¬ì ì¸ ê°€ê²©</strong>ì— ë§Œë‚˜ëŠ” í’ˆì§ˆ
            </div>
          </div>
        </div>

        <!-- ë³¸ì§ˆì  ì°¨ë³„ì  -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 16px;">ğŸ† ëª¨ì—¬ë¼ë”œì˜ ë³¸ì§ˆì  ì°¨ë³„ì  (MOAT)</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
              <div style="width: 40px; height: 40px; background: #E8F3FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ“Š</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28;">ì…€ëŸ¬ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬ & ë¹…ë°ì´í„°</div>
                <div style="font-size: 12px; color: #6B7684;">ì–´ë–¤ ìƒí’ˆì´ ì˜ íŒ”ë¦¬ëŠ”ì§€ ë°ì´í„° ê¸°ë°˜ ë¶„ì„</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
              <div style="width: 40px; height: 40px; background: #FEF3C7; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ“</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28;">ì „ì† ê³„ì•½ ê¸°ë°˜ì˜ ì•ˆì •ì  êµ¬ì¡°</div>
                <div style="font-size: 12px; color: #6B7684;">1ë…„ ì „ì†ê³„ì•½ìœ¼ë¡œ ì§ê±°ë˜ ìœ„í—˜ ì°¨ë‹¨</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
              <div style="width: 40px; height: 40px; background: #DCFCE7; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">âš¡</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28;">í’€ìŠ¤íƒ ìœ í†µ ìš´ì˜</div>
                <div style="font-size: 12px; color: #6B7684;">ì´ë²¤íŠ¸Â·ì •ì‚°Â·ê²°ì œê¹Œì§€ ì›ìŠ¤í†± ì§€ì›</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
              <div style="width: 40px; height: 40px; background: #FCE7F3; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ’</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28;">"ì‹ ë¢° â†’ êµ¬ë§¤" êµ¬ì¡°</div>
                <div style="font-size: 12px; color: #6B7684;">ê´‘ê³ â†’ì „í™˜ì´ ì•„ë‹Œ, ì‹ ë¢° ê¸°ë°˜ í”Œë«í¼</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë¹„ì „ -->
        <div style="background: linear-gradient(135deg, var(--primary), #e08600); border-radius: 12px; padding: 24px; color: white; text-align: center;">
          <div style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">ğŸš€ ëª¨ì—¬ë¼ë”œì´ ë§Œë“œëŠ” ë¯¸ë˜</div>
          <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
            <div>
              <div style="font-size: 24px; margin-bottom: 4px;">ğŸ­</div>
              <div style="font-size: 13px; opacity: 0.9;">ë¸Œëœë“œì—ê²ŒëŠ”</div>
              <div style="font-size: 14px; font-weight: 600;">ê°€ì¥ íš¨ìœ¨ì ì¸ ìœ í†µ ì±„ë„</div>
            </div>
            <div>
              <div style="font-size: 24px; margin-bottom: 4px;">ğŸ‘©â€ğŸ’¼</div>
              <div style="font-size: 13px; opacity: 0.9;">ì…€ëŸ¬ì—ê²ŒëŠ”</div>
              <div style="font-size: 14px; font-weight: 600;">ì§€ì† ê°€ëŠ¥í•œ ìˆ˜ìµ ì¸í”„ë¼</div>
            </div>
            <div>
              <div style="font-size: 24px; margin-bottom: 4px;">ğŸ›’</div>
              <div style="font-size: 13px; opacity: 0.9;">ì†Œë¹„ìì—ê²ŒëŠ”</div>
              <div style="font-size: 14px; font-weight: 600;">ê°€ì¥ ë¯¿ì„ ìˆ˜ ìˆëŠ” ì¶”ì²œ ê³µê°„</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuideProcessContent() {
      return `
        <!-- ì „ì²´ íë¦„ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--gray-200);">
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-800); margin-bottom: 12px;">ì „ì²´ íë¦„</div>
          <div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; font-size: 12px; font-weight: 600;">
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ìƒí’ˆ ì¤€ë¹„</span>
            <span style="color: var(--gray-400);">â†’</span>
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ì…€ëŸ¬ ì¤€ë¹„</span>
            <span style="color: var(--gray-400);">â†’</span>
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ê³µêµ¬ ë“±ë¡</span>
            <span style="color: var(--gray-400);">â†’</span>
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">íŒë§¤</span>
            <span style="color: var(--gray-400);">â†’</span>
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ì •ì‚°</span>
          </div>
        </div>

        <!-- ë‹¨ê³„ë³„ ì„¤ëª… -->
        <div style="display: grid; gap: 12px;">
          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">1</div>
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ìƒí’ˆ ì¤€ë¹„</div>
              <span style="font-size: 11px; color: var(--gray-500); background: var(--gray-100); padding: 2px 8px; border-radius: 4px;">êµ¬ë§¤íŒ€</span>
            </div>
            <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
              <div>â‘  ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê³µê¸‰ì‚¬ ì°¾ê¸°</div>
              <div>â‘¡ ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ</div>
              <div>â‘¢ ìƒí’ˆ DBì— ë“±ë¡</div>
            </div>
          </div>

          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">2</div>
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ì…€ëŸ¬ ì¤€ë¹„</div>
              <span style="font-size: 11px; color: var(--gray-500); background: var(--gray-100); padding: 2px 8px; border-radius: 4px;">ë§ˆì¼€íŒ…íŒ€</span>
            </div>
            <div style="padding-left: 38px;">
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 11px; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-weight: 600;">A. ì‹ ê·œ ì…€ëŸ¬ ë°œêµ´</span>
              </div>
              <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); margin-bottom: 12px; flex-wrap: wrap;">
                <div>â‘  ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¸í”Œë£¨ì–¸ì„œ ì°¾ê¸°</div>
                <div>â‘¡ ì»¨íƒ â†’ ì œì•ˆ â†’ ê³„ì•½</div>
                <div>â‘¢ ì…€ëŸ¬ DBì— ë“±ë¡</div>
              </div>
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 11px; background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-weight: 600;">B. ê¸°ì¡´ ì…€ëŸ¬ì—ê²Œ ì œì•ˆ</span>
              </div>
              <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); flex-wrap: wrap;">
                <div>â‘  ì…€ëŸ¬ DBì—ì„œ ì í•©í•œ ì…€ëŸ¬ ì„ íƒ</div>
                <div>â‘¡ ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ì…€ëŸ¬ ë§ˆì§„ í˜‘ìƒ</div>
                <div>â‘¢ ì…€ëŸ¬ ì œì•ˆì„œ ì „ë‹¬</div>
              </div>
            </div>
          </div>

          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">3</div>
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ê³µêµ¬ ë“±ë¡</div>
            </div>
            <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
              <div>â‘  ê³µêµ¬ ìº˜ë¦°ë”ì—ì„œ ê³µêµ¬ ë“±ë¡</div>
              <div>â‘¡ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ê°€ì´ë“œ ì „ë‹¬</div>
              <div>â‘¢ ì…€ëŸ¬ê°€ SNSì— í™ë³´</div>
            </div>
          </div>

          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">4</div>
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">íŒë§¤ & ì •ì‚°</div>
            </div>
            <div style="display: flex; gap: 16px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
              <div>â‘  ì†Œë¹„ìê°€ ëª¨ì—¬ë¼ë”œì—ì„œ ê²°ì œ</div>
              <div>â‘¡ ê³µê¸‰ì‚¬ì—ê²Œ ë°œì£¼ì„œ ì „ë‹¬</div>
              <div>â‘¢ ê³µê¸‰ì‚¬ê°€ ìƒí’ˆ ë°°ì†¡</div>
              <div>â‘£ ê³µê¸‰ì‚¬ê°€ ì†¡ì¥ ëª¨ì—¬ë¼ë”œì—ê²Œ ì „ë‹¬</div>
              <div>â‘¤ ê³µêµ¬ ì¢…ë£Œ í›„ ì…€ëŸ¬, ê³µê¸‰ì‚¬ì—ê²Œ 3~7ì¼ ë‚´ ì •ì‚°</div>
            </div>
          </div>
        </div>

        <!-- ìˆ˜ìµ êµ¬ì¡° -->
        <div style="background: var(--gray-50); border-radius: 10px; padding: 16px; margin-top: 16px; border: 1px solid var(--gray-200);">
          <div style="font-size: 13px; font-weight: 700; color: var(--gray-800); margin-bottom: 10px;">ìˆ˜ìµ êµ¬ì¡°</div>
          <div style="display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 11px; flex-wrap: wrap;">
            <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
              <div style="font-weight: 600; color: var(--gray-700);">ê³µê¸‰ì‚¬</div>
              <div style="color: var(--gray-500);">ê³µê¸‰ê°€</div>
            </div>
            <span style="color: var(--gray-400);">+</span>
            <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
              <div style="font-weight: 600; color: var(--gray-700);">ì…€ëŸ¬</div>
              <div style="color: var(--gray-500);">ë§ˆì§„(-3.3%)</div>
            </div>
            <span style="color: var(--gray-400);">+</span>
            <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
              <div style="font-weight: 600; color: var(--gray-700);">PGì‚¬</div>
              <div style="color: var(--gray-500);">4%</div>
            </div>
            <span style="color: var(--gray-400);">+</span>
            <div style="text-align: center; padding: 8px 12px; background: var(--primary); border-radius: 6px; color: white;">
              <div style="font-weight: 600;">ëª¨ì—¬ë¼ë”œ</div>
              <div style="opacity: 0.9;">ë‚˜ë¨¸ì§€ ì „ë¶€</div>
            </div>
            <span style="color: var(--gray-400);">=</span>
            <div style="text-align: center; padding: 8px 12px; background: var(--gray-900); border-radius: 6px; color: white;">
              <div style="font-weight: 600;">íŒë§¤ê°€</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuidePartnerContent() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 20px;">ğŸ¤ íŒŒíŠ¸ë„ˆ ì‘ëŒ€ ê°€ì´ë“œ</div>

        <!-- ê³µê¸‰ì‚¬ ì‘ëŒ€ -->
        <div style="background: #EEF2FF; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #C7D2FE;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
            <span style="font-size: 24px;">ğŸ­</span>
            <span style="font-size: 16px; font-weight: 700; color: #4338CA;">ê³µê¸‰ì‚¬ ì‘ëŒ€ ì‹œ í•µì‹¬ í¬ì¸íŠ¸</span>
          </div>

          <div style="background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
            <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸ“Œ ì²« ì»¨íƒ ì‹œ ì „ë‹¬í•  ë©”ì‹œì§€</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8; padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 3px solid #4338CA;">
              "ëª¨ì—¬ë¼ë”œì€ ë‹¨ìˆœ ë²¤ë”ì‚¬ê°€ ì•„ë‹ˆë¼,<br>
              <strong>ì œí’ˆì´ ì‹œì¥ì— ë¹ ë¥´ê²Œ ë…¸ì¶œë˜ê³  ì‹¤êµ¬ë§¤ë¡œ ì´ì–´ì§€ëŠ” êµ¬ì¡°</strong>ë¥¼ ë§Œë“œëŠ” ê³³ì…ë‹ˆë‹¤."
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <div style="background: white; border-radius: 8px; padding: 14px;">
              <div style="font-size: 13px; font-weight: 600; color: #4338CA; margin-bottom: 8px;">âœ… ê°•ì¡°í•´ì•¼ í•  ê²ƒ</div>
              <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
                â€¢ ì´ˆê¸°ë¹„ìš© 0ì›<br>
                â€¢ í”„ë¦¬ë¯¸ì—„ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬<br>
                â€¢ ì´ë²¤íŠ¸ ê¸°íšÂ·ì‚¬ì€í’ˆÂ·ê²°ì œì°½ ì§€ì›<br>
                â€¢ 3~7ì¼ ë‚´ ë¹ ë¥¸ ì •ì‚°<br>
                â€¢ ì½˜í…ì¸  2ì°¨ ë§ˆì¼€íŒ… í™œìš© ê°€ëŠ¥
              </div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 14px;">
              <div style="font-size: 13px; font-weight: 600; color: #DC2626; margin-bottom: 8px;">âŒ í”¼í•´ì•¼ í•  ê²ƒ</div>
              <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
                â€¢ ë‹¨ìˆœ "ê³µë™êµ¬ë§¤ ì§„í–‰í•´ìš”" ì‹ ì ‘ê·¼<br>
                â€¢ ìˆ˜ìˆ˜ë£Œë§Œ ê°•ì¡°í•˜ëŠ” ì„¤ëª…<br>
                â€¢ íŒë§¤ ë³´ì¥ ì•½ì†<br>
                â€¢ ê²½ìŸì‚¬ ë¹„ë°©
              </div>
            </div>
          </div>
        </div>

        <!-- ì…€ëŸ¬ ì‘ëŒ€ -->
        <div style="background: #FEF3C7; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #FCD34D;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
            <span style="font-size: 24px;">ğŸ‘©â€ğŸ’¼</span>
            <span style="font-size: 16px; font-weight: 700; color: #B45309;">ì…€ëŸ¬ ì‘ëŒ€ ì‹œ í•µì‹¬ í¬ì¸íŠ¸</span>
          </div>

          <div style="background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
            <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸ“Œ ì²« ì»¨íƒ ì‹œ ì „ë‹¬í•  ë©”ì‹œì§€</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8; padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 3px solid #B45309;">
              "ëª¨ì—¬ë¼ë”œì€ ì…€ëŸ¬ê°€ <strong>'ì§€ì†ì ìœ¼ë¡œ ì˜ íŒ” ìˆ˜ ìˆëŠ” êµ¬ì¡°'</strong>ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ì„±ì¥ í”Œë«í¼ì…ë‹ˆë‹¤.<br>
              ì½˜í…ì¸ ëŠ” ì…€ëŸ¬ê°€, êµ¬ì¡°ëŠ” ëª¨ì—¬ë¼ë”œì´ ì±…ì„ì§‘ë‹ˆë‹¤."
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <div style="background: white; border-radius: 8px; padding: 14px;">
              <div style="font-size: 13px; font-weight: 600; color: #B45309; margin-bottom: 8px;">âœ… ê°•ì¡°í•´ì•¼ í•  ê²ƒ</div>
              <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
                â€¢ ì´ˆê¸°ë¹„ìš© 0ì›, í’€ì„œí¬íŠ¸<br>
                â€¢ ì „ì†ê³„ì•½ìœ¼ë¡œ ìˆ˜ìµ ì•ˆì •ì„±<br>
                â€¢ ë¸Œëœë“œ í˜‘ìƒ/ì •ì‚° ìœ„í—˜ ì°¨ë‹¨<br>
                â€¢ ì„±ì¥ ì‹œ ìˆ˜ìˆ˜ë£Œ ìë™ ìƒìŠ¹<br>
                â€¢ ODM/OEM ë¸Œëœë“œí™” ì§€ì›
              </div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 14px;">
              <div style="font-size: 13px; font-weight: 600; color: #DC2626; margin-bottom: 8px;">âŒ í”¼í•´ì•¼ í•  ê²ƒ</div>
              <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
                â€¢ "ë§ì´ íŒ”ë©´ ëˆ ë©ë‹ˆë‹¤" ì‹ ì ‘ê·¼<br>
                â€¢ ìˆ˜ìµë§Œ ê°•ì¡°í•˜ëŠ” ì„¤ëª…<br>
                â€¢ ì „ì†ê³„ì•½ ë¶€ë‹´ê° ì£¼ê¸°<br>
                â€¢ ì„±ê¸‰í•œ ê³„ì•½ ìš”êµ¬
              </div>
            </div>
          </div>

          <div style="background: white; border-radius: 8px; padding: 14px; margin-top: 12px;">
            <div style="font-size: 13px; font-weight: 600; color: #B45309; margin-bottom: 8px;">ğŸ’° ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ êµ¬ì¡° ì„¤ëª…</div>
            <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
              â€¢ ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ: í˜‘ì˜ (ìƒí’ˆ/ì…€ëŸ¬ë³„ ìƒì´)<br>
              â€¢ 500ê°œ ì´ìƒ íŒë§¤ ì‹œ: ë³´ë„ˆìŠ¤ ë§ˆì§„ +1%ì”© (ëª¨ì—¬ë¼ë”œ ë¶€ë‹´)<br>
              â€¢ ì •ì‚°: ê³µêµ¬ ì¢…ë£Œ í›„ 3~7ì¼ ë‚´ ë¹ ë¥¸ ì…ê¸ˆ
            </div>
          </div>
        </div>

        <!-- FAQ -->
        <div style="background: #F2F4F6; border-radius: 12px; padding: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 16px;">â“ ìì£¼ ë°›ëŠ” ì§ˆë¬¸ & ë‹µë³€</div>

          <div style="display: grid; gap: 12px;">
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ì™œ ì´ˆê¸°ë¹„ìš©ì´ 0ì›ì¸ê°€ìš”?</div>
              <div style="font-size: 13px; color: #4B5563;">A. ëª¨ì—¬ë¼ë”œì€ íŒë§¤ ìˆ˜ìˆ˜ë£Œ ê¸°ë°˜ ìˆ˜ìµ êµ¬ì¡°ì…ë‹ˆë‹¤. íŒŒíŠ¸ë„ˆì˜ ì„±ê³µì´ ê³§ ìš°ë¦¬ì˜ ì„±ê³µì´ê¸° ë•Œë¬¸ì—, ì§„ì… ì¥ë²½ì„ ë‚®ì¶”ê³  í•¨ê»˜ ì„±ì¥í•˜ëŠ” êµ¬ì¡°ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.</div>
            </div>
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ë‹¤ë¥¸ ê³µë™êµ¬ë§¤ í”Œë«í¼ê³¼ ë­ê°€ ë‹¤ë¥¸ê°€ìš”?</div>
              <div style="font-size: 13px; color: #4B5563;">A. ëª¨ì—¬ë¼ë”œì€ 'ì‹ ë¢° â†’ êµ¬ë§¤' êµ¬ì¡°ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¨ìˆœ ì¤‘ê°œê°€ ì•„ë‹ˆë¼, ì´ë²¤íŠ¸ ê¸°íšë¶€í„° ì •ì‚°ê¹Œì§€ í’€ìŠ¤íƒ ìœ í†µ ìš´ì˜ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
            </div>
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ì „ì†ê³„ì•½ì´ë©´ ë‹¤ë¥¸ ê³³ì—ì„œ ëª» íŒŒë‚˜ìš”?</div>
              <div style="font-size: 13px; color: #4B5563;">A. ì „ì†ê³„ì•½ì€ 'ëª¨ì—¬ë¼ë”œ ì±„ë„ ë‚´'ì—ì„œì˜ ë…ì ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì…€ëŸ¬ë‹˜ì˜ ë‹¤ë¥¸ ì±„ë„ í™œë™ì—ëŠ” ì œí•œì´ ì—†ìœ¼ë©°, ì˜¤íˆë ¤ ì•ˆì •ì ì¸ ìˆ˜ìµ ë³´í˜¸ë¥¼ ìœ„í•œ ì¥ì¹˜ì…ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuideMenuContent() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 20px;">ğŸ“‘ ë©”ë‰´ ì„¤ëª…</div>
        <div style="font-size: 14px; color: #6B7684; margin-bottom: 24px;">ìš´ì˜ì„¼í„° & ì „ëµì„¼í„°ì˜ ê° ë©”ë‰´ ê¸°ëŠ¥ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</div>

        <!-- ìš´ì˜ì„¼í„° -->
        <div style="background: #E8F3FF; border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid #3182f6;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ¢</span>
            <span style="font-size: 18px; font-weight: 700; color: #3182f6;">ìš´ì˜ì„¼í„°</span>
            <span style="font-size: 12px; color: #6B7684; background: white; padding: 4px 10px; border-radius: 12px;">ì¼ìƒ ì—…ë¬´ ì²˜ë¦¬</span>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“¦</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ìƒí’ˆ ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ê³µê¸‰ì‚¬ë¡œë¶€í„° ë°›ì€ ìƒí’ˆ DB ê´€ë¦¬<br>ìƒí’ˆ ë“±ë¡, ìˆ˜ì •, ìƒíƒœ ë³€ê²½</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ‘©â€ğŸ’¼</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì…€ëŸ¬ ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì¸í”Œë£¨ì–¸ì„œ/ì…€ëŸ¬ DB ê´€ë¦¬<br>ê³„ì•½ í˜„í™©, ë“±ê¸‰, íˆìŠ¤í† ë¦¬</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ›’</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ê³µêµ¬ ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ê³µë™êµ¬ë§¤ ì¼ì • ê´€ë¦¬<br>ìƒí’ˆ-ì…€ëŸ¬ ë§¤ì¹­, ì§„í–‰ í˜„í™©</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ­</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ê³µê¸‰ì‚¬ ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ê³µê¸‰ì‚¬/ë¸Œëœë“œ DB ê´€ë¦¬<br>ê³„ì•½ ì¡°ê±´, ê±°ë˜ íˆìŠ¤í† ë¦¬</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ’°</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì •ì‚° ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° ì²˜ë¦¬<br>ìˆ˜ìµ ë¶„ë°°, ì§€ê¸‰ í˜„í™©</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“Š</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ë§ˆì§„ê³„ì‚°ê¸°</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ ì‹œë®¬ë ˆì´ì…˜<br>ìˆ˜ìµ êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸°</div>
            </div>
          </div>
        </div>

        <!-- ì „ëµì„¼í„° -->
        <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 24px; border: 1px solid #F59E0B;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ¯</span>
            <span style="font-size: 18px; font-weight: 700; color: #B45309;">ì „ëµì„¼í„°</span>
            <span style="font-size: 12px; color: #6B7684; background: white; padding: 4px 10px; border-radius: 12px;">ì „ëµ ìˆ˜ë¦½ & ì„±ê³¼ ê´€ë¦¬</span>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“ˆ</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì˜ì—…í˜„í™©</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì‹¤ì‹œê°„ ë§¤ì¶œ, ì˜¨ë³´ë”© í˜„í™©<br>íŒ€ì›ë³„ ì„±ê³¼ ëŒ€ì‹œë³´ë“œ</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸš€</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ê·¸ë¡œìŠ¤ë³´ë“œ</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">íŒ€KPIâ†’ì„ í–‰ì§€í‘œâ†’ë‚´ ì—…ë¬´<br>ê³„ì¸µí˜• ëª©í‘œ ê´€ë¦¬, AI ì¶”ì²œ</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ““</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì—…ë¬´ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì¹¸ë°˜/íƒ€ì„ë¼ì¸ ì—…ë¬´ì¼ì§€<br>ìš´ì˜ì„¼í„° í™œë™ ìë™ ê¸°ë¡</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ”</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì„±ê³¼ë¶„ì„</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ëª©í‘œ vs ê²°ê³¼ ë¶„ì„<br>A/B í…ŒìŠ¤íŠ¸, ê°œì¸ PPT ìƒì„±</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“š</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì—…ë¬´ê°€ì´ë“œ</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì‹ ê·œ íŒ€ì› ì˜¨ë³´ë”©<br>ë³¸ì§ˆ, í”„ë¡œì„¸ìŠ¤, FAQ</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuideFeatureContent() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 20px;">âš™ï¸ ì£¼ìš” ê¸°ëŠ¥</div>
        <div style="font-size: 14px; color: #6B7684; margin-bottom: 24px;">ëª¨ì—¬ë¼ë”œ ì‹œìŠ¤í…œì˜ í•µì‹¬ ê¸°ëŠ¥ë“¤ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</div>

        <div style="display: grid; gap: 20px;">
          <!-- ë§ˆì§„ê³„ì‚°ê¸° -->
          <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border-radius: 16px; padding: 24px; border: 1px solid #C7D2FE;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: #6366F1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ’°</div>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: #4338CA;">ë§ˆì§„ê³„ì‚°ê¸°</div>
                <div style="font-size: 13px; color: #6366F1;">ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ ì‹œë®¬ë ˆì´ì…˜</div>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px; font-size: 13px; color: #4B5563; line-height: 1.8;">
              <strong>ì‚¬ìš© ì‹œì :</strong> ê³µê¸‰ì‚¬ì™€ ë‹¨ê°€ í˜‘ìƒ ì „<br>
              <strong>ì…ë ¥ í•­ëª©:</strong> ê³µê¸‰ê°€, íŒë§¤ê°€, ìˆ˜ìˆ˜ë£Œìœ¨, ë°°ì†¡ë¹„<br>
              <strong>ê²°ê³¼:</strong> ì˜ˆìƒ ë§ˆì§„, ìˆ˜ìµ ë¶„ë°° êµ¬ì¡° ìë™ ê³„ì‚°<br>
              <strong>ê¿€íŒ:</strong> 30% ìˆ˜ìˆ˜ë£Œ êµ¬ì¡°ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ê¶Œì¥
            </div>
          </div>

          <!-- ìë™ ê¸°ë¡ -->
          <div style="background: linear-gradient(135deg, #DCFCE7, #BBF7D0); border-radius: 16px; padding: 24px; border: 1px solid #86EFAC;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: #10B981; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ“</div>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: #166534;">ìë™ ì—…ë¬´ ê¸°ë¡</div>
                <div style="font-size: 13px; color: #16A34A;">ìš´ì˜ì„¼í„° í™œë™ â†’ ì—…ë¬´ì¼ì§€ ìë™ ì—°ë™</div>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px; font-size: 13px; color: #4B5563; line-height: 1.8;">
              <strong>ìë™ ê¸°ë¡ ëŒ€ìƒ:</strong><br>
              â€¢ ìƒí’ˆ ë“±ë¡/ìˆ˜ì •/ìƒíƒœ ë³€ê²½<br>
              â€¢ ì…€ëŸ¬ ë“±ë¡/ê³„ì•½/ë“±ê¸‰ ë³€ê²½<br>
              â€¢ ê³µê¸‰ì‚¬ ë“±ë¡/ê³„ì•½/ìƒíƒœ ë³€ê²½<br>
              â€¢ ê³µêµ¬ ìƒì„±/ë§¤ì¹­/ì§„í–‰/ì™„ë£Œ<br>
              <strong>í™•ì¸:</strong> ì „ëµì„¼í„° â†’ ì—…ë¬´ê´€ë¦¬ì—ì„œ í™•ì¸
            </div>
          </div>

          <!-- ì—°ë„ë³„ ëª©í‘œ ê´€ë¦¬ -->
          <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 24px; border: 1px solid #FCD34D;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: #F59E0B; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ¯</div>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: #B45309;">ì—°ë„ë³„ ëª©í‘œ ê´€ë¦¬</div>
                <div style="font-size: 13px; color: #D97706;">2026-2028 ë§¤ì¶œ ëª©í‘œ ì„¤ì •</div>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px; font-size: 13px; color: #4B5563; line-height: 1.8;">
              <strong>ëª©ì :</strong> 100ì–µ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì—°ë„ë³„ ëª©í‘œ ê´€ë¦¬<br>
              <strong>ê¸°ëŠ¥:</strong><br>
              â€¢ ì—°ë„ë³„ ë§¤ì¶œ ëª©í‘œ ì„¤ì • ë° ì§„ì²™ë„ í™•ì¸<br>
              â€¢ ê·¸ë¡œìŠ¤(90%)/ì˜ì—…(10%) ë¹„ìœ¨ ìë™ ë°°ë¶„<br>
              â€¢ ë©”ì¸ KPI â†’ ì„ í–‰ì§€í‘œ ì—­ì „íŒŒ ëª©í‘œ ì¶”ì <br>
              <strong>ìœ„ì¹˜:</strong> ì „ëµì„¼í„° â†’ ëŒ€ì‹œë³´ë“œ â†’ ì—°ë„ë³„ ëª©í‘œ
            </div>
          </div>

          <!-- PPT ìƒì„± -->
          <div style="background: linear-gradient(135deg, #FCE7F3, #FBCFE8); border-radius: 16px; padding: 24px; border: 1px solid #F9A8D4;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: #EC4899; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ“Š</div>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: #BE185D;">PPT ìë™ ìƒì„±</div>
                <div style="font-size: 13px; color: #DB2777;">CEO ë³´ê³ ìš© ìë£Œ ìë™í™”</div>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px; font-size: 13px; color: #4B5563; line-height: 1.8;">
              <strong>ìƒì„± ê°€ëŠ¥ PPT:</strong><br>
              â€¢ ì „ëµ ë³´ê³ ì„œ (ë³¸ì§ˆëª©í‘œ, ì—°ê°„ëª©í‘œ, KPI)<br>
              â€¢ ê°œì¸ ì„±ê³¼ PPT (ëª©í‘œâ†’KPIâ†’ì‹¤í–‰â†’ê²°ê³¼)<br>
              <strong>ì‚¬ìš©ë²•:</strong> ì„±ê³¼ë¶„ì„ â†’ PPT ìƒì„± ë²„íŠ¼<br>
              <strong>ë¯¸ë¦¬ë³´ê¸°:</strong> ë‹¤ìš´ë¡œë“œ ì „ ìŠ¬ë¼ì´ë“œ ë¯¸ë¦¬ë³´ê¸° ê°€ëŠ¥
            </div>
          </div>
        </div>
      `;
    }

    function getGuidePipelineContent() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 8px;">ğŸ“Š ì˜ì—… íŒŒì´í”„ë¼ì¸ ê°€ì´ë“œ</div>
        <div style="font-size: 14px; color: #6B7684; margin-bottom: 24px;">ê° íŒŒì´í”„ë¼ì¸ì˜ ë‹¨ê³„ë³„ ì •ì˜ì™€ ë‹´ë‹¹ì ì—­í• ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</div>

        <!-- ìƒí’ˆ íŒŒì´í”„ë¼ì¸ -->
        <div style="background: #F2F4F6; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ“¦</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: #191F28;">ìƒí’ˆ íŒŒì´í”„ë¼ì¸</div>
              <div style="font-size: 13px; color: #6B7684;">ìƒí’ˆ ë°œêµ´ë¶€í„° ê³„ì•½ê¹Œì§€ì˜ ì—¬ì •</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #E5E8EB;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ“‹</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">1. ë¦¬ìŠ¤íŠ¸ì—…</div>
              <div style="font-size: 12px; color: #6B7684;">ì ì¬ ìƒí’ˆ/ê³µê¸‰ì‚¬ ë°œêµ´</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #10B981;">
              <div style="font-size: 28px; margin-bottom: 12px;">âœ…</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">2. ì œì•ˆ</div>
              <div style="font-size: 12px; color: #6B7684;">ì—°ë½/ì œì•ˆ ì™„ë£Œ</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #F59E0B;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ¤</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">3. ì˜¨ë³´ë”©</div>
              <div style="font-size: 12px; color: #6B7684; line-height: 1.5;">ë¯¸íŒ…/ìƒë‹´ Â· ì¡°ê±´í˜‘ì˜<br>ì„œë¥˜ìˆ˜ë ¹ Â· ìƒí’ˆì •ë³´</div>
            </div>
            <div style="background: #6366F1; border-radius: 12px; padding: 20px; text-align: center; color: white;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ‰</div>
              <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">4. ê³„ì•½</div>
              <div style="font-size: 12px; opacity: 0.9;">ê³„ì•½ ì™„ë£Œ</div>
            </div>
          </div>
        </div>

        <!-- ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸ -->
        <div style="background: #FEF9E7; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ‘©â€ğŸ’¼</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: #191F28;">ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸</div>
              <div style="font-size: 13px; color: #6B7684;">ì…€ëŸ¬ ë°œêµ´ë¶€í„° ê³„ì•½ê¹Œì§€ì˜ ì—¬ì •</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #E5E8EB;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ“‹</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">1. ë¦¬ìŠ¤íŠ¸ì—…</div>
              <div style="font-size: 12px; color: #6B7684;">ì…€ëŸ¬ í›„ë³´ ë“±ë¡</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #10B981;">
              <div style="font-size: 28px; margin-bottom: 12px;">âœ…</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">2. ì œì•ˆ</div>
              <div style="font-size: 12px; color: #6B7684;">DM/ì—°ë½ Â· ì œì•ˆ ì™„ë£Œ</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #F59E0B;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ¤</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">3. ì˜¨ë³´ë”©</div>
              <div style="font-size: 12px; color: #6B7684; line-height: 1.5;">ì„œë¹„ìŠ¤ ì•ˆë‚´ Â· ì¡°ê±´í˜‘ì˜<br>ì •ì‚°ì •ë³´ ìˆ˜ë ¹</div>
            </div>
            <div style="background: #B45309; border-radius: 12px; padding: 20px; text-align: center; color: white;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ‰</div>
              <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">4. ê³„ì•½</div>
              <div style="font-size: 12px; opacity: 0.9;">ê³„ì•½ ì™„ë£Œ</div>
            </div>
          </div>
        </div>

        <!-- íŒŒì´í”„ë¼ì¸ ê´€ë¦¬ íŒ -->
        <div style="background: linear-gradient(135deg, #3182f6, #1b64da); border-radius: 16px; padding: 24px; color: white;">
          <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">ğŸ’¡ íŒŒì´í”„ë¼ì¸ ê´€ë¦¬ íŒ</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ“Š ì£¼ê°„ ì²´í¬í¬ì¸íŠ¸</div>
              <div style="font-size: 12px; opacity: 0.9; line-height: 1.6;">ë§¤ì£¼ ì›”ìš”ì¼ íŒŒì´í”„ë¼ì¸ í˜„í™© ì ê²€<br>ì •ì²´ëœ ê±´ ì§‘ì¤‘ íŒ”ë¡œì—…</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">â° ì ì • ì²´ë¥˜ ê¸°ê°„</div>
              <div style="font-size: 12px; opacity: 0.9; line-height: 1.6;">ë¦¬ìŠ¤íŠ¸ì—…â†’ì œì•ˆ: 3ì¼ ì´ë‚´<br>ì œì•ˆâ†’ì˜¨ë³´ë”©: 7ì¼ ì´ë‚´<br>ì˜¨ë³´ë”©â†’ê³„ì•½: 14ì¼ ì´ë‚´</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ¯ ì „í™˜ìœ¨ ëª©í‘œ</div>
              <div style="font-size: 12px; opacity: 0.9; line-height: 1.6;">ë¦¬ìŠ¤íŠ¸ì—…â†’ì œì•ˆ: 50%+<br>ì œì•ˆâ†’ì˜¨ë³´ë”©: 30%+<br>ì˜¨ë³´ë”©â†’ê³„ì•½: 60%+</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuideCafe24Content() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 8px;">ğŸ›’ ì¹´í˜24 ì†Œë¹„ì í˜ì´ì§€ ê´€ë¦¬</div>
        <div style="font-size: 14px; color: #6B7684; margin-bottom: 24px;">ì¹´í˜24ì— í˜¸ìŠ¤íŒ…ëœ ì†Œë¹„ì í˜ì´ì§€ì˜ ìˆ˜ì • ë° ì¶”ê°€ ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</div>

        <!-- í´ë” êµ¬ì¡° -->
        <div style="background: #F2F4F6; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ“</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: #191F28;">ì¹´í˜24 í´ë” êµ¬ì¡°</div>
              <div style="font-size: 13px; color: #6B7684;">ë””ìì¸ í¸ì§‘ê¸° ë‚´ consumer í´ë”</div>
            </div>
          </div>
          <div style="background: #1E293B; border-radius: 12px; padding: 20px; font-family: monospace; font-size: 13px; color: #E2E8F0; line-height: 1.8;">
            <div style="color: #94A3B8;">consumer/</div>
            <div style="margin-left: 20px;">â”œâ”€â”€ <span style="color: #60A5FA;">product/</span></div>
            <div style="margin-left: 40px;">â”‚   â””â”€â”€ index.html <span style="color: #6B7280;"># ìƒí’ˆ ìƒì„¸ í˜ì´ì§€</span></div>
            <div style="margin-left: 20px;">â”œâ”€â”€ <span style="color: #60A5FA;">events/</span></div>
            <div style="margin-left: 40px;">â”‚   â””â”€â”€ index.html <span style="color: #6B7280;"># ì´ë²¤íŠ¸ í˜ì´ì§€</span></div>
            <div style="margin-left: 20px;">â”œâ”€â”€ <span style="color: #F472B6;">secret-seller/</span></div>
            <div style="margin-left: 40px;">â”‚   â””â”€â”€ index.html <span style="color: #6B7280;"># ì…€ëŸ¬ ì „ìš© ìƒí’ˆ í˜ì´ì§€</span></div>
            <div style="margin-left: 20px;">â””â”€â”€ <span style="color: #60A5FA;">my-cashback/</span></div>
            <div style="margin-left: 40px;">    â””â”€â”€ index.html <span style="color: #6B7280;"># ìºì‹œë°± ì¡°íšŒ í˜ì´ì§€</span></div>
          </div>
        </div>

        <!-- í˜ì´ì§€ ìˆ˜ì • ë°©ë²• -->
        <div style="background: white; border: 2px solid #E5E8EB; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 20px;">ğŸ”§ í˜ì´ì§€ ìˆ˜ì • ë°©ë²•</div>
          <div style="display: grid; gap: 16px;">
            <div style="display: flex; align-items: flex-start; gap: 16px; padding: 16px; background: #F9FAFB; border-radius: 12px;">
              <div style="width: 32px; height: 32px; background: #3182F6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; flex-shrink: 0;">1</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 4px;">ì¹´í˜24 ê´€ë¦¬ì ì ‘ì†</div>
                <div style="font-size: 13px; color: #6B7684;">moyeora02.cafe24.com/disp/admin/ ì ‘ì†</div>
              </div>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 16px; padding: 16px; background: #F9FAFB; border-radius: 12px;">
              <div style="width: 32px; height: 32px; background: #3182F6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; flex-shrink: 0;">2</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 4px;">ë””ìì¸ í¸ì§‘ê¸° ì—´ê¸°</div>
                <div style="font-size: 13px; color: #6B7684;"><strong>ë””ìì¸</strong> â†’ <strong>ë””ìì¸ í¸ì§‘</strong> ë˜ëŠ” Ctrl + D</div>
              </div>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 16px; padding: 16px; background: #F9FAFB; border-radius: 12px;">
              <div style="width: 32px; height: 32px; background: #3182F6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; flex-shrink: 0;">3</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 4px;">íŒŒì¼ ì°¾ê¸° ë° ìˆ˜ì •</div>
                <div style="font-size: 13px; color: #6B7684;">ì™¼ìª½ í´ë” íŠ¸ë¦¬ì—ì„œ consumer â†’ í´ë” â†’ index.html ë”ë¸”í´ë¦­</div>
              </div>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 16px; padding: 16px; background: #F9FAFB; border-radius: 12px;">
              <div style="width: 32px; height: 32px; background: #3182F6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; flex-shrink: 0;">4</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 4px;">ì €ì¥ ë° í™•ì¸</div>
                <div style="font-size: 13px; color: #6B7684;">ìˆ˜ì • í›„ <strong>ì €ì¥</strong> (Ctrl + S) â†’ <strong>ë¯¸ë¦¬ë³´ê¸°</strong>ë¡œ í™•ì¸</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ìƒˆ í˜ì´ì§€ ì¶”ê°€ -->
        <div style="background: #EEF2FF; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 28px;">â•</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: #191F28;">ìƒˆ í˜ì´ì§€ ì¶”ê°€ ë°©ë²•</div>
              <div style="font-size: 13px; color: #6B7684;">í´ë¦° URLì„ ìœ„í•´ í´ë” ë°©ì‹ ê¶Œì¥</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div style="background: white; border-radius: 12px; padding: 20px;">
              <div style="font-size: 14px; font-weight: 700; color: #4F46E5; margin-bottom: 12px;">ë°©ë²• 1: í´ë” ë°©ì‹ (ê¶Œì¥)</div>
              <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
                1. consumer í´ë” ìš°í´ë¦­ â†’ <strong>ìƒˆ í´ë”</strong><br>
                2. í´ë”ëª… ì…ë ¥ (ì˜ˆ: faq)<br>
                3. í´ë” ì•ˆì— index.html ìƒì„±<br>
                4. ê²°ê³¼: <code style="background: #F3F4F6; padding: 2px 6px; border-radius: 4px;">/consumer/faq/</code>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px;">
              <div style="font-size: 14px; font-weight: 700; color: #6B7280; margin-bottom: 12px;">ë°©ë²• 2: íŒŒì¼ ë°©ì‹</div>
              <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
                1. consumer í´ë” ìš°í´ë¦­ â†’ <strong>ìƒˆ íŒŒì¼</strong><br>
                2. íŒŒì¼ëª… ì…ë ¥ (ì˜ˆ: about.html)<br>
                3. ê²°ê³¼: <code style="background: #F3F4F6; padding: 2px 6px; border-radius: 4px;">/consumer/about.html</code>
              </div>
            </div>
          </div>
        </div>

        <!-- ì…€ëŸ¬ ì „ìš© ë§í¬ -->
        <div style="background: linear-gradient(135deg, #7C3AED, #5B21B6); border-radius: 16px; padding: 24px; color: white; margin-bottom: 24px;">
          <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">ğŸ”— ì…€ëŸ¬ ì „ìš© ë§í¬ ìƒì„±</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">1. ì–´ë“œë¯¼ ì ‘ì†</div>
              <div style="font-size: 12px; opacity: 0.9;">ìš´ì˜ì„¼í„° â†’ ê³µêµ¬ ê´€ë¦¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">2. ê³µêµ¬ ì„ íƒ</div>
              <div style="font-size: 12px; opacity: 0.9;">ìˆ˜ì •í•  ê³µêµ¬ í´ë¦­</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">3. ë§í¬ ë³µì‚¬</div>
              <div style="font-size: 12px; opacity: 0.9;">ëª¨ë‹¬ í•˜ë‹¨ "ì…€ëŸ¬ ì „ìš© ë§í¬" ì„¹ì…˜ì—ì„œ ë³µì‚¬</div>
            </div>
          </div>
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-top: 16px; font-family: monospace; font-size: 12px;">
            URL í˜•ì‹: /consumer/secret-seller/?seller={ì…€ëŸ¬ID}&deal={ê³µêµ¬ID}
          </div>
        </div>

        <!-- URL ì •ë¦¬ -->
        <div style="background: white; border: 2px solid #E5E8EB; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 16px;">ğŸ“‹ í˜ì´ì§€ë³„ URL ì •ë¦¬</div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead>
                <tr style="background: #F9FAFB;">
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E5E8EB; font-weight: 600;">í˜ì´ì§€</th>
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E5E8EB; font-weight: 600;">URL</th>
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #E5E8EB; font-weight: 600;">íŒŒë¼ë¯¸í„°</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB;">ìƒí’ˆ ìƒì„¸</td>
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB;"><code style="background: #F3F4F6; padding: 2px 8px; border-radius: 4px;">/consumer/product/</code></td>
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB; color: #6B7684;">?id={dealId}&ref={refCode}</td>
                </tr>
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB;">ì´ë²¤íŠ¸</td>
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB;"><code style="background: #F3F4F6; padding: 2px 8px; border-radius: 4px;">/consumer/events/</code></td>
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB; color: #6B7684;">-</td>
                </tr>
                <tr style="background: #FEF3FF;">
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB; font-weight: 600; color: #7C3AED;">ì…€ëŸ¬ ì „ìš©</td>
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB;"><code style="background: #F3E8FF; padding: 2px 8px; border-radius: 4px; color: #7C3AED;">/consumer/secret-seller/</code></td>
                  <td style="padding: 12px; border-bottom: 1px solid #E5E8EB; color: #7C3AED;">?seller={sellerId}&deal={dealId}</td>
                </tr>
                <tr>
                  <td style="padding: 12px;">ìºì‹œë°± ì¡°íšŒ</td>
                  <td style="padding: 12px;"><code style="background: #F3F4F6; padding: 2px 8px; border-radius: 4px;">/consumer/my-cashback/</code></td>
                  <td style="padding: 12px; color: #6B7684;">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ì£¼ì˜ì‚¬í•­ -->
        <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 16px; padding: 24px;">
          <div style="font-size: 16px; font-weight: 700; color: #DC2626; margin-bottom: 16px;">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸš« ê²½ë¡œ ì¶©ëŒ ë°©ì§€</div>
              <div style="font-size: 12px; color: #6B7684; line-height: 1.6;">
                ì¹´í˜24 ê¸°ë³¸ ê²½ë¡œ ì‚¬ìš© ê¸ˆì§€:<br>
                <code style="color: #DC2626;">/product/</code>, <code style="color: #DC2626;">/board/</code>, <code style="color: #DC2626;">/member/</code><br>
                â†’ <strong>/consumer/</strong> í•˜ìœ„ë§Œ ì‚¬ìš©
              </div>
            </div>
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸ”„ ìºì‹œ ë¬¸ì œ</div>
              <div style="font-size: 12px; color: #6B7684; line-height: 1.6;">
                ìˆ˜ì • ë°˜ì˜ ì•ˆ ë˜ë©´:<br>
                â€¢ Ctrl + Shift + R (ê°•ë ¥ ìƒˆë¡œê³ ì¹¨)<br>
                â€¢ ì¹´í˜24 ìºì‹œ ì´ˆê¸°í™”
              </div>
            </div>
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸ“± ëª¨ë°”ì¼ ëŒ€ì‘ í•„ìˆ˜</div>
              <div style="font-size: 12px; color: #6B7684; line-height: 1.6;">
                ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ ì ìš©:<br>
                <code>@media (max-width: 768px)</code>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========================================
    // ì—…ë¬´ì¼ì§€ ì‹œìŠ¤í…œ
    // ========================================
    const TASK_COLUMNS = [
      { id: 'waiting', label: 'ëŒ€ê¸°', color: '#f59e0b', bg: '#fef3c7', icon: 'â³' },
      { id: 'progress', label: 'ì§„í–‰ì¤‘', color: '#3b82f6', bg: '#dbeafe', icon: 'ğŸ”„' },
      { id: 'complete', label: 'ì™„ë£Œ', color: '#10b981', bg: '#d1fae5', icon: 'âœ…' },
      { id: 'hold', label: 'ë³´ë¥˜', color: '#6b7280', bg: '#f3f4f6', icon: 'â¸ï¸' }
    ];

    let workLogView = 'kanban';
    let memberFilter = 'all';  // ê¸°ë³¸ê°’ì„ 'all'ë¡œ ë³€ê²½ - ëª¨ë“  ì—…ë¬´ í‘œì‹œ
    let selectedMemberId = null;
    // ========================================
    // [DEPRECATED] ì „ëµê¸°íš ì‹œìŠ¤í…œ - ì´ ê¸°ëŠ¥ì€ ì‚­ì œë¨
    // ëŒ€ì‹œë³´ë“œì˜ ì—°ë„ë³„ ëª©í‘œì™€ ê·¸ë¡œìŠ¤ë³´ë“œë¡œ ëŒ€ì²´ë¨
    // ========================================
    let currentStrategyVersion = 'v1.0';
    let strategyVersions = [];

    function renderStrategicPlanning() {
      const container = document.getElementById('planningContent');
      if (!container) return;

      const versions = state.strategyVersions || [{ id: 'v1.0', name: 'v1.0', createdAt: new Date().toISOString(), status: 'active' }];
      const currentVersion = versions.find(v => v.status === 'active') || versions[0];
      const strategyData = state.strategyData || {};

      const C = {
        primary: '#3182f6',
        green: '#00C471',
        yellow: '#F59E0B',
        red: '#F04452',
        gray50: '#F2F4F6',
        gray100: '#E5E8EB',
        gray200: '#D1D6DB',
        gray500: '#6B7684',
        gray700: '#333D4B',
        gray900: '#191F28',
        white: '#FFFFFF'
      };

      container.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 style="font-size: 24px; font-weight: 700; color: ${C.gray900}; margin: 0; display: flex; align-items: center; gap: 12px;">
                ğŸ¯ ì „ëµê¸°íš
                <span style="font-size: 14px; background: ${C.primary}; color: white; padding: 4px 12px; border-radius: 20px;">${currentVersion?.name || 'v1.0'}</span>
              </h1>
              <p style="color: ${C.gray500}; margin-top: 4px; font-size: 13px;">ëª©í‘œ ì„¤ì • ë° ì „ëµ ë°©í–¥ ê´€ë¦¬ Â· ë²„ì „ë³„ íˆìŠ¤í† ë¦¬ ë³´ê´€</p>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="openStrategySettingsModal()" style="padding: 12px 20px; font-size: 14px; font-weight: 700; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 12px rgba(16,185,129,0.3); display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 18px;">âš™ï¸</span> ì „ëµ ì„¤ì •
              </button>
              <button onclick="openVersionHistoryModal()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.white}; color: ${C.gray700}; border: 1px solid ${C.gray200}; border-radius: 8px; cursor: pointer;">
                ğŸ“œ ë²„ì „ íˆìŠ¤í† ë¦¬
              </button>
              <button onclick="downloadStrategyPPT()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.primary}; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ğŸ“¥ PPT ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
          </div>

          <!-- ë³¸ì§ˆ ëª©í‘œ (ì¸ë¼ì¸ í¸ì§‘ ê°€ëŠ¥) -->
          <div style="background: linear-gradient(135deg, ${C.primary}, #1b64da); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
              <div style="font-size: 16px; font-weight: 700; opacity: 0.9;">ğŸ“Œ ë³¸ì§ˆ ëª©í‘œ (Why)</div>
              <button onclick="toggleEditMode('essence')" style="background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                âœï¸ í¸ì§‘
              </button>
            </div>
            <div id="essenceGoal" class="editable-field" data-field="essenceGoal" style="font-size: 20px; font-weight: 600; line-height: 1.5; min-height: 60px;">
              ${strategyData.essenceGoal || 'ì‚¬ëŒì˜ ì‹ ë¢°ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼'}
            </div>
          </div>

          <!-- ì—°ê°„ ëª©í‘œ ì¹´ë“œ (ì¸ë¼ì¸ í¸ì§‘ ê°€ëŠ¥) -->
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ì—°ê°„ ë§¤ì¶œ ëª©í‘œ</div>
              <div class="editable-number" data-field="annualRevenue" onclick="enableInlineEdit(this)" style="font-size: 28px; font-weight: 700; color: ${C.gray900}; cursor: pointer;">
                ${((strategyData.annualRevenue || 500000000) / 100000000).toFixed(1)}ì–µ
              </div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ì—°ê°„ ìˆœìµ ëª©í‘œ</div>
              <div class="editable-number" data-field="annualProfit" onclick="enableInlineEdit(this)" style="font-size: 28px; font-weight: 700; color: ${C.green}; cursor: pointer;">
                ${((strategyData.annualProfit || 50000000) / 10000).toLocaleString()}ë§Œ
              </div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ëª©í‘œ ì„±ê³µë¥ </div>
              <div class="editable-number" data-field="successRate" onclick="enableInlineEdit(this)" style="font-size: 28px; font-weight: 700; color: ${C.yellow}; cursor: pointer;">
                ${strategyData.successRate || 30}%
              </div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">30% ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨</div>
              <div class="editable-number" data-field="commission30Ratio" onclick="enableInlineEdit(this)" style="font-size: 28px; font-weight: 700; color: ${C.primary}; cursor: pointer;">
                ${strategyData.commission30Ratio || 30}%
              </div>
            </div>
          </div>

          <!-- ì„±ì¥ vs ì˜ì—… ë¹„ìœ¨ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.gray900};">âš–ï¸ ë¦¬ì†ŒìŠ¤ ë°°ë¶„ ì „ëµ</div>
              <button onclick="toggleEditMode('allocation')" style="background: ${C.gray50}; border: 1px solid ${C.gray200}; padding: 6px 12px; border-radius: 6px; color: ${C.gray700}; cursor: pointer; font-size: 12px;">
                âœï¸ í¸ì§‘
              </button>
            </div>
            <div style="display: flex; gap: 24px; align-items: center;">
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 14px; font-weight: 600; color: #10B981;">ğŸŒ± ì„±ì¥ (Growth)</span>
                  <span id="growthRatio" class="editable-number" data-field="growthRatio" onclick="enableInlineEdit(this)" style="font-size: 14px; font-weight: 700; color: #10B981; cursor: pointer;">${strategyData.growthRatio || 90}%</span>
                </div>
                <div style="background: ${C.gray100}; border-radius: 8px; height: 24px; overflow: hidden;">
                  <div style="background: linear-gradient(90deg, #10B981, #34D399); height: 100%; width: ${strategyData.growthRatio || 90}%; transition: width 0.3s;"></div>
                </div>
                <div style="font-size: 12px; color: ${C.gray500}; margin-top: 8px;">ì‹ ê·œ ê³µê¸‰ì‚¬/ì…€ëŸ¬ í™•ë³´, ì‹œì¥ í™•ì¥</div>
              </div>
              <div style="font-size: 24px; color: ${C.gray300};">âŸ·</div>
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 14px; font-weight: 600; color: #3B82F6;">ğŸ’° ì˜ì—… (Sales)</span>
                  <span id="salesRatio" style="font-size: 14px; font-weight: 700; color: #3B82F6;">${100 - (strategyData.growthRatio || 90)}%</span>
                </div>
                <div style="background: ${C.gray100}; border-radius: 8px; height: 24px; overflow: hidden;">
                  <div style="background: linear-gradient(90deg, #3B82F6, #60A5FA); height: 100%; width: ${100 - (strategyData.growthRatio || 90)}%; transition: width 0.3s;"></div>
                </div>
                <div style="font-size: 12px; color: ${C.gray500}; margin-top: 8px;">ê¸°ì¡´ íŒŒíŠ¸ë„ˆ ê´€ë¦¬, ë§¤ì¶œ ê·¹ëŒ€í™”</div>
              </div>
            </div>
          </div>

          <!-- 4ì¶• ë„ë©”ì¸ ì „ëµ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.gray900};">ğŸ§­ 4ì¶• ë„ë©”ì¸ ì „ëµ</div>
              <button onclick="openDomainStrategyModal()" style="background: ${C.gray50}; border: 1px solid ${C.gray200}; padding: 6px 12px; border-radius: 6px; color: ${C.gray700}; cursor: pointer; font-size: 12px;">
                âš™ï¸ ì „ëµ í¸ì§‘
              </button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              ${renderDomainCard('domestic', 'ğŸ‡°ğŸ‡· êµ­ë‚´ ê³µê¸‰ì‚¬', strategyData.domesticStrategy || 'êµ­ë‚´ ìš°ìˆ˜ ë¸Œëœë“œ ë°œêµ´ ë° ë…ì  ê³„ì•½', '#6366F1')}
              ${renderDomainCard('import', 'âœˆï¸ í•´ì™¸ ì§ìˆ˜ì…', strategyData.importStrategy || 'ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ìƒí’ˆ ì„ ì œ í™•ë³´', '#F59E0B')}
              ${renderDomainCard('export', 'ğŸŒ í•´ì™¸ ìˆ˜ì¶œ', strategyData.exportStrategy || 'K-ë¸Œëœë“œ ê¸€ë¡œë²Œ ì§„ì¶œ ì§€ì›', '#10B981')}
              ${renderDomainCard('platform', 'ğŸ¥• ë‹¹ê·¼ Ã— ëª¨ì—¬ë¼ë”œ', strategyData.platformStrategy || 'ì§€ì—­ ê¸°ë°˜ ê³µë™êµ¬ë§¤ í™œì„±í™”', '#EF4444')}
            </div>
          </div>

          <!-- KPI ì—°ê²° ì•ˆë‚´ -->
          <div style="background: ${C.gray50}; border: 2px dashed ${C.gray200}; border-radius: 16px; padding: 24px; margin-top: 24px; text-align: center;">
            <div style="font-size: 14px; color: ${C.gray500}; margin-bottom: 12px;">ì´ ì „ëµì— ì—°ê²°ëœ KPIë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>
            <button onclick="switchTab('kpi'); event.stopPropagation();" style="background: ${C.primary}; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
              ğŸ“Š KPIê´€ë¦¬ë¡œ ì´ë™ â†’
            </button>
          </div>
        </div>
      `;
    }

    function renderDomainCard(domain, title, description, color) {
      return `
        <div style="background: ${color}10; border: 1px solid ${color}30; border-radius: 12px; padding: 16px;">
          <div style="font-size: 14px; font-weight: 700; color: ${color}; margin-bottom: 8px;">${title}</div>
          <div style="font-size: 13px; color: #4B5563; line-height: 1.5;">${description}</div>
        </div>
      `;
    }

    // ì¸ë¼ì¸ í¸ì§‘ í™œì„±í™”
    function enableInlineEdit(element) {
      if (element.querySelector('input')) return; // ì´ë¯¸ í¸ì§‘ ì¤‘

      const field = element.dataset.field;
      const currentValue = element.textContent.replace(/[^0-9.]/g, '');

      element.innerHTML = `
        <input type="number" value="${currentValue}"
          style="width: 80px; font-size: inherit; font-weight: inherit; color: inherit; background: rgba(255,255,255,0.9); border: 2px solid var(--primary); border-radius: 6px; padding: 4px 8px; text-align: center;"
          onblur="saveInlineEdit(this, '${field}')"
          onkeypress="if(event.key==='Enter') this.blur();"
          autofocus>
      `;
      element.querySelector('input').focus();
    }

    // ì¸ë¼ì¸ í¸ì§‘ ì €ì¥
    async function saveInlineEdit(input, field) {
      const value = parseFloat(input.value);
      const parent = input.parentElement;

      try {
        let updateData = {};
        if (field === 'annualRevenue') {
          updateData[field] = value * 100000000;
          parent.textContent = value.toFixed(1) + 'ì–µ';
        } else if (field === 'annualProfit') {
          updateData[field] = value * 10000;
          parent.textContent = value.toLocaleString() + 'ë§Œ';
        } else if (field === 'growthRatio') {
          updateData[field] = value;
          parent.textContent = value + '%';
          document.getElementById('salesRatio').textContent = (100 - value) + '%';
        } else {
          updateData[field] = value;
          parent.textContent = value + '%';
        }

        await db.collection('settings').doc('strategy').set(updateData, { merge: true });
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    // ë²„ì „ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬
    // ì „ëµ ì„¤ì • ëª¨ë‹¬
    function openStrategySettingsModal() {
      const strategy = state.strategyData || {};
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header" style="background: #10B981; color: white;">
            <h2 class="modal-title" style="color: white;">âš™ï¸ ì „ëµ ì„¤ì •</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; max-height: 70vh; overflow-y: auto;">
            <!-- ë³¸ì§ˆ ëª©í‘œ -->
            <div style="margin-bottom: 24px;">
              <label style="display: block; font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 8px;">ğŸ“Œ ë³¸ì§ˆ ëª©í‘œ (Why)</label>
              <textarea id="setting-essenceGoal" class="form-input" rows="2" style="width: 100%;">${strategy.essenceGoal || 'ì‚¬ëŒì˜ ì‹ ë¢°ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼'}</textarea>
            </div>

            <!-- ì—°ê°„ ëª©í‘œ -->
            <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 12px;">ğŸ“Š ì—°ê°„ ëª©í‘œ</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ì—°ê°„ ë§¤ì¶œ ëª©í‘œ (ì–µ)</label>
                <input type="number" id="setting-annualRevenue" class="form-input" step="0.1" value="${((strategy.annualRevenue || 500000000) / 100000000).toFixed(1)}" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ì—°ê°„ ìˆœìµ ëª©í‘œ (ë§Œì›)</label>
                <input type="number" id="setting-annualProfit" class="form-input" value="${(strategy.annualProfit || 50000000) / 10000}" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ëª©í‘œ ì„±ê³µë¥  (%)</label>
                <input type="number" id="setting-successRate" class="form-input" value="${strategy.successRate || 30}" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">30% ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨ (%)</label>
                <input type="number" id="setting-commission30Ratio" class="form-input" value="${strategy.commission30Ratio || 30}" style="width: 100%;">
              </div>
            </div>

            <!-- ë¦¬ì†ŒìŠ¤ ë°°ë¶„ -->
            <div style="margin-bottom: 24px;">
              <label style="display: block; font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 8px;">âš–ï¸ ë¦¬ì†ŒìŠ¤ ë°°ë¶„ (ì„±ì¥ ë¹„ìœ¨ %)</label>
              <div style="display: flex; align-items: center; gap: 16px;">
                <input type="range" id="setting-growthRatio" min="0" max="100" value="${strategy.growthRatio || 90}" style="flex: 1;" oninput="document.getElementById('growthRatioDisplay').textContent = this.value + '%'">
                <span id="growthRatioDisplay" style="font-weight: 700; color: #10B981; min-width: 50px;">${strategy.growthRatio || 90}%</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6B7684; margin-top: 4px;">
                <span>ğŸŒ± ì„±ì¥ ì¤‘ì‹¬</span>
                <span>ğŸ’° ì˜ì—… ì¤‘ì‹¬</span>
              </div>
            </div>

            <!-- 4ì¶• ë„ë©”ì¸ ì „ëµ -->
            <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 12px;">ğŸ§­ 4ì¶• ë„ë©”ì¸ ì „ëµ</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ğŸ‡°ğŸ‡· êµ­ë‚´ ê³µê¸‰ì‚¬</label>
                <textarea id="setting-domesticStrategy" class="form-input" rows="2" style="width: 100%;">${strategy.domesticStrategy || 'êµ­ë‚´ ìš°ìˆ˜ ë¸Œëœë“œ ë°œêµ´ ë° ë…ì  ê³„ì•½'}</textarea>
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">âœˆï¸ í•´ì™¸ ì§ìˆ˜ì…</label>
                <textarea id="setting-importStrategy" class="form-input" rows="2" style="width: 100%;">${strategy.importStrategy || 'ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ìƒí’ˆ ì„ ì œ í™•ë³´'}</textarea>
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ğŸŒ í•´ì™¸ ìˆ˜ì¶œ</label>
                <textarea id="setting-exportStrategy" class="form-input" rows="2" style="width: 100%;">${strategy.exportStrategy || 'K-ë¸Œëœë“œ ê¸€ë¡œë²Œ ì§„ì¶œ ì§€ì›'}</textarea>
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ğŸ¥• ë‹¹ê·¼ Ã— ëª¨ì—¬ë¼ë”œ</label>
                <textarea id="setting-platformStrategy" class="form-input" rows="2" style="width: 100%;">${strategy.platformStrategy || 'ì§€ì—­ ê¸°ë°˜ ê³µë™êµ¬ë§¤ í™œì„±í™”'}</textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveStrategySettings()">ğŸ’¾ ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveStrategySettings() {
      try {
        const updateData = {
          essenceGoal: document.getElementById('setting-essenceGoal').value.trim(),
          annualRevenue: parseFloat(document.getElementById('setting-annualRevenue').value) * 100000000,
          annualProfit: parseFloat(document.getElementById('setting-annualProfit').value) * 10000,
          successRate: parseFloat(document.getElementById('setting-successRate').value),
          commission30Ratio: parseFloat(document.getElementById('setting-commission30Ratio').value),
          growthRatio: parseInt(document.getElementById('setting-growthRatio').value),
          domesticStrategy: document.getElementById('setting-domesticStrategy').value.trim(),
          importStrategy: document.getElementById('setting-importStrategy').value.trim(),
          exportStrategy: document.getElementById('setting-exportStrategy').value.trim(),
          platformStrategy: document.getElementById('setting-platformStrategy').value.trim(),
          updatedAt: new Date().toISOString()
        };

        await db.collection('settings').doc('strategy').set(updateData, { merge: true });
        state.strategyData = { ...state.strategyData, ...updateData };

        closeModal();
        renderStrategicPlanning();
        showToast('ì „ëµ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì „ëµ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // PPT ì§ì ‘ ë‹¤ìš´ë¡œë“œ
    function downloadStrategyPPT() {
      try {
        const pptx = new PptxGenJS();
        pptx.author = 'ëª¨ì—¬ë¼ë”œ';
        pptx.title = 'ì „ëµ ë³´ê³ ì„œ';
        pptx.subject = 'ëª¨ì—¬ë¼ë”œ ì „ëµ ë³´ê³ ì„œ';

        const strategy = state.strategyData || {};
        const versions = state.strategyVersions || [];
        const currentVersion = versions.find(v => v.status === 'active') || { name: 'v1.0' };

        // ìŠ¬ë¼ì´ë“œ 1: íƒ€ì´í‹€
        let slide = pptx.addSlide();
        slide.addText('ì „ëµ ë³´ê³ ì„œ', { x: 0.5, y: 2, w: '90%', h: 1, fontSize: 44, bold: true, color: '191F28', align: 'center' });
        slide.addText(`${currentVersion.name} Â· ${new Date().toLocaleDateString('ko-KR')}`, { x: 0.5, y: 3.2, w: '90%', h: 0.5, fontSize: 18, color: '6B7684', align: 'center' });
        slide.addText('ëª¨ì—¬ë¼ë”œ', { x: 0.5, y: 4.5, w: '90%', h: 0.5, fontSize: 16, color: '3182f6', align: 'center' });

        // ìŠ¬ë¼ì´ë“œ 2: ë³¸ì§ˆ ëª©í‘œ
        slide = pptx.addSlide();
        slide.addText('ë³¸ì§ˆ ëª©í‘œ (Why)', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });
        slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 1.5, w: 9, h: 1.5, fill: { color: '3182f6' }, line: { color: '3182f6' } });
        slide.addText(strategy.essenceGoal || 'ì‚¬ëŒì˜ ì‹ ë¢°ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼', { x: 0.7, y: 1.7, w: 8.6, h: 1.1, fontSize: 18, color: 'FFFFFF', valign: 'middle' });

        // ìŠ¬ë¼ì´ë“œ 3: ì—°ê°„ ëª©í‘œ
        slide = pptx.addSlide();
        slide.addText('ì—°ê°„ ëª©í‘œ', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });

        const targets = [
          { label: 'ì—°ë§¤ì¶œ ëª©í‘œ', value: `${((strategy.annualRevenue || 500000000) / 100000000).toFixed(1)}ì–µ`, color: '191F28' },
          { label: 'ìˆœìµ ëª©í‘œ', value: `${((strategy.annualProfit || 50000000) / 10000).toLocaleString()}ë§Œ`, color: '00C471' },
          { label: 'ì„±ê³µë¥  ëª©í‘œ', value: `${strategy.successRate || 30}%`, color: 'F59E0B' },
          { label: '30% ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨', value: `${strategy.commission30Ratio || 30}%`, color: '3182f6' }
        ];

        targets.forEach((t, i) => {
          const x = 0.5 + (i * 2.3);
          slide.addShape(pptx.ShapeType.rect, { x, y: 1.5, w: 2.1, h: 1.8, fill: { color: 'F2F4F6' }, line: { color: 'E5E8EB' } });
          slide.addText(t.label, { x, y: 1.6, w: 2.1, h: 0.5, fontSize: 11, color: '6B7684', align: 'center' });
          slide.addText(t.value, { x, y: 2.1, w: 2.1, h: 0.8, fontSize: 24, bold: true, color: t.color, align: 'center' });
        });

        // ìŠ¬ë¼ì´ë“œ 4: ë¦¬ì†ŒìŠ¤ ë°°ë¶„ + 4ì¶• ì „ëµ
        slide = pptx.addSlide();
        slide.addText('ë¦¬ì†ŒìŠ¤ ë°°ë¶„ & ë„ë©”ì¸ ì „ëµ', { x: 0.5, y: 0.3, w: '90%', h: 0.6, fontSize: 24, bold: true, color: '191F28' });

        const growthRatio = strategy.growthRatio || 90;
        slide.addText(`ì„±ì¥ ${growthRatio}% : ì˜ì—… ${100-growthRatio}%`, { x: 0.5, y: 1, w: 9, h: 0.4, fontSize: 14, color: '6B7684' });

        const domains = [
          { icon: 'ğŸ‡°ğŸ‡·', title: 'êµ­ë‚´ ê³µê¸‰ì‚¬', desc: strategy.domesticStrategy || '' },
          { icon: 'âœˆï¸', title: 'í•´ì™¸ ì§ìˆ˜ì…', desc: strategy.importStrategy || '' },
          { icon: 'ğŸŒ', title: 'í•´ì™¸ ìˆ˜ì¶œ', desc: strategy.exportStrategy || '' },
          { icon: 'ğŸ¥•', title: 'ë‹¹ê·¼Ã—ëª¨ì—¬ë¼ë”œ', desc: strategy.platformStrategy || '' }
        ];

        domains.forEach((d, i) => {
          const x = 0.5 + (i % 2) * 4.7;
          const y = 1.6 + Math.floor(i / 2) * 1.6;
          slide.addShape(pptx.ShapeType.rect, { x, y, w: 4.4, h: 1.4, fill: { color: 'F2F4F6' }, line: { color: 'E5E8EB' } });
          slide.addText(`${d.icon} ${d.title}`, { x: x + 0.2, y: y + 0.1, w: 4, h: 0.4, fontSize: 12, bold: true, color: '191F28' });
          slide.addText(d.desc, { x: x + 0.2, y: y + 0.5, w: 4, h: 0.8, fontSize: 10, color: '6B7684' });
        });

        // ë‹¤ìš´ë¡œë“œ
        const fileName = `ì „ëµë³´ê³ ì„œ_${currentVersion.name}_${new Date().toISOString().split('T')[0]}.pptx`;
        pptx.writeFile({ fileName });
        showToast('PPT ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤');
      } catch (e) {
        console.error('PPT ìƒì„± ì˜¤ë¥˜:', e);
        showToast('PPT ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    function openVersionHistoryModal() {
      const versions = state.strategyVersions || [{ id: 'v1.0', name: 'v1.0', createdAt: new Date().toISOString(), status: 'active' }];
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">ğŸ“œ ì „ëµ ë²„ì „ íˆìŠ¤í† ë¦¬</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
            ${versions.map((v, i) => `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: ${v.status === 'active' ? 'var(--primary-light)' : 'var(--gray-50)'}; border-radius: 12px; margin-bottom: 12px; border: ${v.status === 'active' ? '2px solid var(--primary)' : '1px solid var(--gray-200)'};">
                <div>
                  <div style="font-weight: 700; color: var(--gray-900);">${v.name}</div>
                  <div style="font-size: 12px; color: var(--gray-500);">${formatDateKR(v.createdAt)}</div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  ${v.status === 'active' ? '<span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">í˜„ì¬ ë²„ì „</span>' : `<button onclick="activateVersion('${v.id}')" style="padding: 6px 12px; font-size: 12px; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer;">ì ìš©</button>`}
                  <button onclick="viewVersionDetail('${v.id}')" style="padding: 6px 12px; font-size: 12px; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer;">ìƒì„¸</button>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          </div>
        </div>
      `;
    }

    // ìƒˆ ë²„ì „ ìƒì„± ëª¨ë‹¬
    function openNewVersionModal() {
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h2 class="modal-title">+ ìƒˆ ì „ëµ ë²„ì „ ìƒì„±</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë²„ì „ ì´ë¦„</label>
              <input type="text" id="newVersionName" class="form-input" placeholder="ì˜ˆ: v1.1, v2.0, 2026 Q2" value="">
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë³€ê²½ ì‚¬ìœ </label>
              <textarea id="newVersionReason" class="form-input" rows="3" placeholder="ì´ ë²„ì „ì„ ìƒì„±í•˜ëŠ” ì´ìœ ë¥¼ ê¸°ë¡í•˜ì„¸ìš”"></textarea>
            </div>
            <div style="background: var(--yellow-light); border-radius: 8px; padding: 12px; font-size: 12px; color: #B45309;">
              âš ï¸ ìƒˆ ë²„ì „ ìƒì„± ì‹œ í˜„ì¬ ì „ëµ ì„¤ì •ì´ ë³µì‚¬ë˜ë©°, ê¸°ì¡´ ë²„ì „ì€ íˆìŠ¤í† ë¦¬ì— ë³´ê´€ë©ë‹ˆë‹¤.
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="createNewVersion()">ìƒì„±</button>
          </div>
        </div>
      `;
    }

    // ìƒˆ ë²„ì „ ìƒì„±
    async function createNewVersion() {
      const name = document.getElementById('newVersionName').value.trim();
      const reason = document.getElementById('newVersionReason').value.trim();
      if (!name) { showToast('ë²„ì „ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

      try {
        const currentStrategy = state.strategyData || {};
        const newVersion = {
          name,
          reason,
          createdAt: new Date().toISOString(),
          status: 'active',
          data: { ...currentStrategy }
        };

        // ê¸°ì¡´ ë²„ì „ë“¤ ë¹„í™œì„±í™”
        const versions = state.strategyVersions || [];
        versions.forEach(v => v.status = 'archived');
        versions.unshift(newVersion);

        await db.collection('settings').doc('strategyVersions').set({ versions });
        state.strategyVersions = versions;

        closeModal();
        renderStrategicPlanning();
        showToast(`${name} ë²„ì „ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`);
      } catch (e) {
        console.error(e);
        showToast('ë²„ì „ ìƒì„± ì‹¤íŒ¨');
      }
    }

    // PPT ìƒì„±
    function generateStrategyPPT() {
      const strategyData = state.strategyData || {};
      const kpis = state.projects?.flatMap(p => [...(p.teamKPIs || []), ...(p.memberKPIs || [])]) || [];

      if (kpis.length === 0) {
        if (confirm('KPIê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. KPIê´€ë¦¬ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          switchTab('kpi');
        }
        return;
      }

      // PPT ë°ì´í„° êµ¬ì„±
      const pptData = {
        title: 'ì „ëµ ë³´ê³ ì„œ',
        version: currentStrategyVersion,
        date: new Date().toLocaleDateString('ko-KR'),
        essenceGoal: strategyData.essenceGoal || '',
        annualRevenue: strategyData.annualRevenue || 0,
        annualProfit: strategyData.annualProfit || 0,
        successRate: strategyData.successRate || 0,
        growthRatio: strategyData.growthRatio || 90,
        domains: {
          domestic: strategyData.domesticStrategy || '',
          import: strategyData.importStrategy || '',
          export: strategyData.exportStrategy || '',
          platform: strategyData.platformStrategy || ''
        },
        kpis: kpis
      };

      // PPT ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬
      showPPTPreviewModal(pptData);
    }

    function showPPTPreviewModal(data) {
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header" style="background: var(--primary); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ“Š ì „ëµ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; background: #f0f0f0;">
            <!-- ìŠ¬ë¼ì´ë“œ ë¯¸ë¦¬ë³´ê¸° -->
            <div style="background: white; aspect-ratio: 16/9; border-radius: 8px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
              <div style="text-align: center; margin-bottom: 40px;">
                <h1 style="font-size: 32px; color: var(--gray-900); margin-bottom: 8px;">${data.title}</h1>
                <div style="color: var(--gray-500);">${data.version} Â· ${data.date}</div>
              </div>
              <div style="background: var(--primary); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 24px;">
                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 8px;">ë³¸ì§ˆ ëª©í‘œ</div>
                <div style="font-size: 18px; font-weight: 600;">${data.essenceGoal || 'ë¯¸ì„¤ì •'}</div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">${(data.annualRevenue / 100000000).toFixed(1)}ì–µ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ì—°ë§¤ì¶œ ëª©í‘œ</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--green);">${(data.annualProfit / 10000).toLocaleString()}ë§Œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ìˆœìµ ëª©í‘œ</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--yellow);">${data.successRate}%</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ì„±ê³µë¥  ëª©í‘œ</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${data.kpis.length}ê°œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ì—°ê²° KPI</div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            <button class="btn btn-primary" onclick="downloadPPT()">ğŸ“¥ PPT ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
      `;
    }

    function downloadPPT() {
      try {
        const pptx = new PptxGenJS();
        pptx.author = 'ëª¨ì—¬ë¼ë”œ';
        pptx.title = 'ì „ëµ ë³´ê³ ì„œ';
        pptx.subject = 'ëª¨ì—¬ë¼ë”œ ì „ëµ ë³´ê³ ì„œ';

        const strategy = state.strategyData || {};
        const versions = state.strategyVersions || [];
        const currentVersion = versions.find(v => v.status === 'active') || { name: 'v1.0' };

        // ìŠ¬ë¼ì´ë“œ 1: íƒ€ì´í‹€
        let slide = pptx.addSlide();
        slide.addText('ì „ëµ ë³´ê³ ì„œ', { x: 0.5, y: 2, w: '90%', h: 1, fontSize: 44, bold: true, color: '191F28', align: 'center' });
        slide.addText(`${currentVersion.name} Â· ${new Date().toLocaleDateString('ko-KR')}`, { x: 0.5, y: 3.2, w: '90%', h: 0.5, fontSize: 18, color: '6B7684', align: 'center' });
        slide.addText('ëª¨ì—¬ë¼ë”œ', { x: 0.5, y: 4.5, w: '90%', h: 0.5, fontSize: 16, color: '3182f6', align: 'center' });

        // ìŠ¬ë¼ì´ë“œ 2: ë³¸ì§ˆ ëª©í‘œ
        slide = pptx.addSlide();
        slide.addText('ë³¸ì§ˆ ëª©í‘œ (Why)', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });
        slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 1.5, w: 9, h: 1.5, fill: { color: '3182f6' }, line: { color: '3182f6' } });
        slide.addText(strategy.essenceGoal || 'ì‚¬ëŒì˜ ì‹ ë¢°ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼', { x: 0.7, y: 1.7, w: 8.6, h: 1.1, fontSize: 18, color: 'FFFFFF', valign: 'middle' });

        // ìŠ¬ë¼ì´ë“œ 3: ì—°ê°„ ëª©í‘œ
        slide = pptx.addSlide();
        slide.addText('ì—°ê°„ ëª©í‘œ', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });

        const targets = [
          { label: 'ì—°ë§¤ì¶œ ëª©í‘œ', value: `${((strategy.annualRevenue || 500000000) / 100000000).toFixed(1)}ì–µ`, color: '191F28' },
          { label: 'ìˆœìµ ëª©í‘œ', value: `${((strategy.annualProfit || 50000000) / 10000).toLocaleString()}ë§Œ`, color: '00C471' },
          { label: 'ì„±ê³µë¥  ëª©í‘œ', value: `${strategy.successRate || 30}%`, color: 'F59E0B' },
          { label: '30% ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨', value: `${strategy.commission30Ratio || 30}%`, color: '3182f6' }
        ];

        targets.forEach((t, i) => {
          const x = 0.5 + (i * 2.3);
          slide.addShape(pptx.ShapeType.rect, { x, y: 1.5, w: 2.1, h: 1.8, fill: { color: 'F2F4F6' }, line: { color: 'E5E8EB' } });
          slide.addText(t.label, { x, y: 1.6, w: 2.1, h: 0.5, fontSize: 11, color: '6B7684', align: 'center' });
          slide.addText(t.value, { x, y: 2.1, w: 2.1, h: 0.8, fontSize: 24, bold: true, color: t.color, align: 'center' });
        });

        // ìŠ¬ë¼ì´ë“œ 4: ë¦¬ì†ŒìŠ¤ ë°°ë¶„
        slide = pptx.addSlide();
        slide.addText('ë¦¬ì†ŒìŠ¤ ë°°ë¶„ ì „ëµ', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });
        const growthRatio = strategy.growthRatio || 90;
        slide.addText(`ì„±ì¥ (Growth): ${growthRatio}%`, { x: 0.5, y: 1.8, w: 4, h: 0.5, fontSize: 16, color: '10B981' });
        slide.addText(`ì˜ì—… (Sales): ${100 - growthRatio}%`, { x: 5, y: 1.8, w: 4, h: 0.5, fontSize: 16, color: '3B82F6' });

        // ë‹¤ìš´ë¡œë“œ
        pptx.writeFile({ fileName: `ì „ëµë³´ê³ ì„œ_${currentVersion.name}_${new Date().toISOString().split('T')[0]}.pptx` });
        showToast('PPT ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error('PPT ìƒì„± ì˜¤ë¥˜:', e);
        showToast('PPT ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ========================================
    // KPIê´€ë¦¬ ì‹œìŠ¤í…œ (ìƒˆ êµ¬ì¡°: íŒ€ KPI â†’ ì„ í–‰ì§€í‘œ â†’ ë‚´ ì—…ë¬´)
    // ========================================
    let kpiViewMode = 'hierarchy'; // hierarchy, team, member
    let kpiMemberFilter = 'all';
    let kpiSortBy = 'priority'; // priority, progress, name

    function renderKPIManagement() {
      const container = document.getElementById('kpiContent');
      if (!container) return;

      let megaProjects = [...(state.megaProjects || [])];
      let projects = [...(state.projects || [])];
      let teamKPIs = [...(state.teamKPIs || [])];
      const memberKPIs = state.memberKPIs || [];
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');

      // ì •ë ¬ ì ìš©
      if (kpiSortBy === 'priority') {
        megaProjects.sort((a, b) => (a.priority || 999) - (b.priority || 999));
        teamKPIs.sort((a, b) => (a.priority || 999) - (b.priority || 999));
      } else if (kpiSortBy === 'progress') {
        teamKPIs.sort((a, b) => {
          const progressA = a.target > 0 ? (a.current / a.target) : 0;
          const progressB = b.target > 0 ? (b.current / b.target) : 0;
          return progressA - progressB; // ë‚®ì€ ë‹¬ì„±ë¥  ë¨¼ì €
        });
      }

      const C = {
        primary: '#3182f6',
        purple: '#6366F1',
        green: '#00C471',
        yellow: '#F59E0B',
        red: '#F04452',
        gray50: '#F2F4F6',
        gray100: '#E5E8EB',
        gray200: '#D1D6DB',
        gray500: '#6B7684',
        gray700: '#333D4B',
        gray900: '#191F28',
        white: '#FFFFFF'
      };

      // ë‹¬ì„±ë¥  ê³„ì‚°
      const totalKPIs = teamKPIs.length + memberKPIs.length;
      const achievedKPIs = [...teamKPIs, ...memberKPIs].filter(k => k.current >= k.target).length;
      const achievementRate = totalKPIs > 0 ? Math.round((achievedKPIs / totalKPIs) * 100) : 0;

      // ì£¼ëª© í•„ìš” ì„ í–‰ì§€í‘œ (ìš°ì„ ìˆœìœ„ 1ìˆœìœ„ ë©”ì¸ KPIì— ì—°ê²°ëœ ì„ í–‰ì§€í‘œ ì¤‘ ë‹¬ì„±ë¥  30% ë¯¸ë§Œ)
      const priority1MegaProjects = megaProjects.filter(m => m.priority === 1);
      const priority1ProjectIds = projects
        .filter(p => priority1MegaProjects.some(m => m.id === p.megaProjectId))
        .map(p => p.id);
      const attentionKPIs = teamKPIs.filter(k => {
        const progress = k.target > 0 ? (k.current / k.target) * 100 : 0;
        const isLinkedToPriority1 = priority1ProjectIds.includes(k.projectId);
        return isLinkedToPriority1 && progress < 30 && k.target > 0;
      }).slice(0, 5);

      // ìš°ì„ ìˆœìœ„ ì„¤ì •ëœ ë©”ì¸ KPI (1ìˆœìœ„ë¶€í„° ì •ë ¬)
      const priorityMegaKPIs = megaProjects
        .filter(m => m.priority && m.priority <= 3)
        .sort((a, b) => a.priority - b.priority);

      container.innerHTML = `
        <div style="max-width: 1400px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 style="font-size: 24px; font-weight: 700; color: ${C.gray900}; margin: 0;">ğŸ“Š ê·¸ë¡œìŠ¤ë³´ë“œ</h1>
              <p style="color: ${C.gray500}; margin-top: 4px; font-size: 13px;">íŒ€ KPI â†’ ì„ í–‰ì§€í‘œ â†’ ë‚´ ì—…ë¬´</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="openSecretLinkModal()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.gray100}; color: ${C.gray700}; border: 1px solid ${C.gray300}; border-radius: 8px; cursor: pointer;">
                ğŸ”— ê³µìœ  ë§í¬
              </button>
              <button onclick="openMegaProjectModal()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.purple}; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ğŸ¯ íŒ€ KPI ì¶”ê°€
              </button>
              <button onclick="openTeamKPIModal()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.green}; color: white; border: none; border-radius: 8px; cursor: pointer;">
                + ì„ í–‰ì§€í‘œ ì¶”ê°€
              </button>
            </div>
          </div>

          <!-- ë¹ ë¥¸ ì ‘ê·¼ íŒ¨ë„ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <!-- ì£¼ëª© í•„ìš” -->
            <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 20px; border: 1px solid #F59E0B;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 14px; font-weight: 700; color: #92400E;">âš ï¸ ì£¼ëª© í•„ìš” (1ìˆœìœ„ ì¤‘ ë‹¬ì„±ë¥  30% ë¯¸ë§Œ)</div>
                <span style="font-size: 12px; color: #B45309;">${attentionKPIs.length}ê°œ</span>
              </div>
              ${attentionKPIs.length > 0 ? `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${attentionKPIs.map(kpi => {
                    const progress = kpi.target > 0 ? Math.round((kpi.current / kpi.target) * 100) : 0;
                    return `
                      <div onclick="openTeamKPIModal(state.teamKPIs.find(k=>k.id==='${kpi.id}'))" style="background: white; padding: 10px 14px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <span style="font-size: 13px; font-weight: 600; color: #333;">${kpi.name}</span>
                        <span style="font-size: 11px; padding: 2px 8px; background: ${C.red}; color: white; border-radius: 10px;">${progress}%</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : `<div style="color: #92400E; font-size: 13px;">1ìˆœìœ„ ì„ í–‰ì§€í‘œ ëª¨ë‘ ì–‘í˜¸í•©ë‹ˆë‹¤ ğŸ‘</div>`}
            </div>

            <!-- ìš°ì„ ìˆœìœ„ TOP -->
            <div style="background: linear-gradient(135deg, #EDE9FE, #DDD6FE); border-radius: 16px; padding: 20px; border: 1px solid ${C.purple};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 14px; font-weight: 700; color: #5B21B6;">â­ ìš°ì„ ìˆœìœ„ TOP (íŒ€ KPI)</div>
                <span style="font-size: 12px; color: #7C3AED;">${priorityMegaKPIs.length}ê°œ</span>
              </div>
              ${priorityMegaKPIs.length > 0 ? `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${priorityMegaKPIs.map((mega) => {
                    // ë©”ì¸ KPIì˜ ì§„í–‰ë¥  ê³„ì‚° (í•˜ìœ„ ì„œë¸Œ KPI ê¸°ì¤€)
                    const childProjects = projects.filter(p => p.megaProjectId === mega.id);
                    let progress = 0;
                    if (childProjects.length > 0) {
                      const avgProgress = childProjects.reduce((sum, p) => sum + (p.progress || 0), 0) / childProjects.length;
                      progress = Math.round(avgProgress);
                    }
                    return `
                      <div onclick="openMegaProjectModal(state.megaProjects.find(m=>m.id==='${mega.id}'))" style="background: white; padding: 10px 14px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <span style="font-size: 12px; font-weight: 700; color: ${C.purple};">#${mega.priority}</span>
                        <span style="font-size: 13px; font-weight: 600; color: #333;">${mega.name}</span>
                        <span style="font-size: 11px; padding: 2px 8px; background: ${progress >= 70 ? C.green : progress >= 40 ? C.yellow : C.red}; color: white; border-radius: 10px;">${progress}%</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : `<div style="color: #5B21B6; font-size: 13px;">íŒ€ KPI í¸ì§‘ì—ì„œ ìš°ì„ ìˆœìœ„ë¥¼ ì„¤ì •í•˜ì„¸ìš”</div>`}
            </div>
          </div>

          <!-- KPI ìš”ì•½ ì¹´ë“œ -->
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: linear-gradient(135deg, ${C.purple}, #8B5CF6); border-radius: 12px; padding: 20px; color: white; cursor: pointer;" onclick="setKPIViewMode('hierarchy')">
              <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px;">ğŸ¯ íŒ€ KPI</div>
              <div style="font-size: 28px; font-weight: 700;">${megaProjects.length}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer;" onclick="setKPIViewMode('team')">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ“‹ ì„ í–‰ì§€í‘œ</div>
              <div style="font-size: 28px; font-weight: 700; color: ${C.green};">${projects.length + teamKPIs.length}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer;" onclick="setKPIViewMode('member')">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ‘¤ ë‚´ ì—…ë¬´</div>
              <div style="font-size: 28px; font-weight: 700; color: ${C.yellow};">${memberKPIs.length}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ“ˆ ë‹¬ì„±ë¥ </div>
              <div style="font-size: 28px; font-weight: 700; color: ${achievementRate >= 70 ? C.green : achievementRate >= 40 ? C.yellow : C.red};">${achievementRate}%</div>
            </div>
          </div>

          <!-- ë·° ëª¨ë“œ & ì •ë ¬ -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
            <div style="display: flex; gap: 8px; background: ${C.gray50}; padding: 4px; border-radius: 10px;">
              <button onclick="setKPIViewMode('hierarchy')" style="background: ${kpiViewMode === 'hierarchy' ? C.primary : 'transparent'}; color: ${kpiViewMode === 'hierarchy' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                ğŸ—ï¸ ê³„ì¸µ êµ¬ì¡°
              </button>
              <button onclick="setKPIViewMode('team')" style="background: ${kpiViewMode === 'team' ? C.primary : 'transparent'}; color: ${kpiViewMode === 'team' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                ğŸ“‹ ì„ í–‰ì§€í‘œ
              </button>
              <button onclick="setKPIViewMode('member')" style="background: ${kpiViewMode === 'member' ? C.primary : 'transparent'}; color: ${kpiViewMode === 'member' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                ğŸ‘¤ ë‚´ ì—…ë¬´
              </button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              ${(kpiViewMode === 'hierarchy' || kpiViewMode === 'team') ? `
                <button onclick="expandAllKPIFolders()" style="padding: 8px 12px; border: 1px solid ${C.gray200}; background: ${C.white}; border-radius: 8px; font-size: 12px; cursor: pointer; color: ${C.gray700};">ğŸ“‚ ëª¨ë‘ í¼ì¹˜ê¸°</button>
                <button onclick="collapseAllKPIFolders()" style="padding: 8px 12px; border: 1px solid ${C.gray200}; background: ${C.white}; border-radius: 8px; font-size: 12px; cursor: pointer; color: ${C.gray700};">ğŸ“ ëª¨ë‘ ì ‘ê¸°</button>
              ` : ''}
              <span style="font-size: 12px; color: ${C.gray500};">ì •ë ¬:</span>
              <select onchange="setKPISortBy(this.value)" style="padding: 8px 12px; border: 1px solid ${C.gray200}; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <option value="priority" ${kpiSortBy === 'priority' ? 'selected' : ''}>â­ ìš°ì„ ìˆœìœ„</option>
                <option value="progress" ${kpiSortBy === 'progress' ? 'selected' : ''}>ğŸ“Š ë‹¬ì„±ë¥  ë‚®ì€ìˆœ</option>
                <option value="name" ${kpiSortBy === 'name' ? 'selected' : ''}>ğŸ”¤ ì´ë¦„ìˆœ</option>
              </select>
            </div>
          </div>

          <!-- ë©”ì¸ ì»¨í…ì¸  -->
          <div id="kpi-main-content">
            ${kpiViewMode === 'hierarchy' ? renderKPIHierarchyView(megaProjects, projects, teamKPIs, memberKPIs, C) :
              kpiViewMode === 'team' ? renderTeamKPIView(teamKPIs, projects, memberKPIs, C) :
              renderMemberKPIView(memberKPIs, teamKPIs, projects, members, C)}
          </div>
        </div>
      `;
    }

    function setKPISortBy(sortBy) {
      kpiSortBy = sortBy;
      renderKPIManagement();
    }

    function setKPIViewMode(mode) {
      kpiViewMode = mode;
      renderKPIManagement();
    }

    function renderKPIHierarchyView(megaProjects, projects, teamKPIs, memberKPIs, C) {
      if (megaProjects.length === 0) {
        return `
          <div style="text-align: center; padding: 60px; background: ${C.white}; border-radius: 16px; border: 2px dashed ${C.gray200};">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¢</div>
            <div style="font-size: 18px; font-weight: 600; color: ${C.gray900}; margin-bottom: 8px;">íŒ€ KPIë¥¼ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”</div>
            <div style="font-size: 14px; color: ${C.gray500}; margin-bottom: 20px;">ì˜ˆ: í•´ì™¸ ìˆ˜ì¶œ (K-ë¸Œëœë“œ í™•ì¥), êµ­ë‚´ í™•ì¥ ë“±</div>
            <button onclick="openMegaProjectModal()" style="padding: 12px 24px; background: ${C.purple}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ğŸ¯ ì²« íŒ€ KPI ë§Œë“¤ê¸°
            </button>
          </div>
        `;
      }

      return megaProjects.map((mega, megaIdx) => {
        const childProjects = projects.filter(p => p.megaProjectId === mega.id);
        const megaProgress = calculateMegaProjectProgress(mega, childProjects, teamKPIs, memberKPIs);
        const megaFolderId = 'mega-folder-' + megaIdx;

        return `
          <div class="kpi-folder" style="background: ${C.white}; border-radius: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;">
            <!-- ë©”ì¸ KPI í—¤ë” (í´ë”í˜•) -->
            <div class="kpi-folder-header" onclick="toggleKPIFolder('${megaFolderId}')" style="padding: 20px 24px; border-left: 4px solid ${C.purple}; background: ${C.white};">
              <button class="kpi-folder-toggle" id="${megaFolderId}-toggle">â–¶</button>
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, ${C.purple}, #8B5CF6); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px;">ğŸ¢</div>
              <div style="flex: 1;">
                <div style="font-size: 18px; font-weight: 700; color: ${C.gray900};">${mega.name}</div>
                <div style="font-size: 12px; color: ${C.gray500}; margin-top: 2px;">${mega.description || ''} Â· ì„ í–‰ì§€í‘œ ${childProjects.length}ê°œ</div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px;">
                ${(mega.targetValue || mega.revenueTarget) ? `<div style="text-align: right;"><div style="font-size: 10px; color: ${C.gray500};">ëª©í‘œ</div><div style="font-size: 16px; font-weight: 700; color: ${C.purple};">${formatTargetValue(mega.targetValue || (mega.revenueTarget / 100000000), mega.targetUnitType || 'revenue')}</div></div>` : ''}
                <div style="text-align: right;">
                  <div style="font-size: 10px; color: ${C.gray500};">ì§„í–‰ë¥ </div>
                  <div style="font-size: 16px; font-weight: 700; color: ${megaProgress >= 70 ? C.green : megaProgress >= 40 ? C.yellow : C.red};">${megaProgress}%</div>
                </div>
                <button onclick="event.stopPropagation(); openMegaProjectModal(state.megaProjects.find(m=>m.id==='${mega.id}'))" style="padding: 6px 10px; background: ${C.gray50}; border: 1px solid ${C.gray200}; border-radius: 6px; cursor: pointer; font-size: 11px;">í¸ì§‘</button>
              </div>
            </div>

            <!-- ë©”ì¸ KPI ë‚´ìš© (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
            <div class="kpi-folder-content" id="${megaFolderId}" style="padding: 0 24px 20px 24px;">
              <div style="margin-left: 30px; border-left: 2px solid ${C.gray200}; padding-left: 20px; padding-top: 12px;">
                ${childProjects.length === 0 ? `
                  <div style="padding: 20px; background: ${C.gray50}; border-radius: 12px; text-align: center;">
                    <div style="color: ${C.gray500}; margin-bottom: 12px;">ì„ í–‰ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    <button onclick="openProjectModalV2(null, '${mega.id}')" style="padding: 8px 16px; background: ${C.primary}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">+ í”„ë¡œì íŠ¸ ì¶”ê°€</button>
                  </div>
                ` : childProjects.map((project, projIdx) => {
                  const projectTeamKPIs = teamKPIs.filter(k => k.projectId === project.id);
                  const projectMemberKPIs = memberKPIs.filter(k => k.projectId === project.id);
                  const projectProgress = calculateProjectProgress(projectTeamKPIs, projectMemberKPIs);
                  const subFolderId = megaFolderId + '-sub-' + projIdx;

                  return `
                    <div class="kpi-folder" style="background: ${C.gray50}; border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                      <!-- ì„œë¸Œ KPI í—¤ë” (í´ë”í˜•) -->
                      <div class="kpi-folder-header" onclick="toggleKPISubFolder('${subFolderId}')" style="padding: 14px 16px;">
                        <button class="kpi-folder-toggle" id="${subFolderId}-toggle" style="font-size: 10px;">â–¶</button>
                        <div style="font-size: 16px; margin-right: 8px;">ğŸ“</div>
                        <div style="flex: 1;">
                          <div style="font-size: 15px; font-weight: 600; color: ${C.gray900};">${project.name}</div>
                          <div style="font-size: 11px; color: ${C.gray500};">ì„ í–‰ì§€í‘œ ${projectTeamKPIs.length}ê°œ${(project.targetValue || project.revenueGoal) ? ' Â· ëª©í‘œ ' + formatTargetValue(project.targetValue || (project.revenueGoal / 100000000), project.targetUnitType || 'revenue') : ''}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                          <div style="background: ${projectProgress >= 70 ? C.green : projectProgress >= 40 ? C.yellow : C.red}20; padding: 4px 10px; border-radius: 10px; font-size: 12px; font-weight: 600; color: ${projectProgress >= 70 ? C.green : projectProgress >= 40 ? C.yellow : C.red};">
                            ${projectProgress}%
                          </div>
                          <button onclick="event.stopPropagation(); openProjectModalV2(state.projects.find(p=>p.id==='${project.id}'))" style="padding: 5px 8px; background: ${C.white}; border: 1px solid ${C.gray200}; border-radius: 4px; cursor: pointer; font-size: 10px;">í¸ì§‘</button>
                          <button onclick="event.stopPropagation(); openTeamKPIModal(null, '${project.id}')" style="padding: 5px 8px; background: ${C.green}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">+ ì„ í–‰ì§€í‘œ</button>
                        </div>
                      </div>

                      <!-- ì„œë¸Œ KPI ë‚´ìš© (ì„ í–‰ì§€í‘œ ëª©ë¡) -->
                      <div class="kpi-subfolder-content" id="${subFolderId}" style="padding: 0 16px 14px 16px;">
                        ${projectTeamKPIs.length > 0 ? `
                          <div style="margin-left: 24px; padding-top: 8px;">
                            ${projectTeamKPIs.map((kpi, kpiIdx) => {
                              const progress = kpi.target > 0 ? Math.min(100, Math.round((kpi.current / kpi.target) * 100)) : 0;
                              const kpiMemberKPIs = memberKPIs.filter(mk => mk.teamKpiId === kpi.id);
                              const indicatorId = subFolderId + '-ind-' + kpiIdx;

                              return `
                                <div class="kpi-folder" style="background: ${C.white}; border-radius: 10px; margin-bottom: 8px; border-left: 3px solid ${C.green}; overflow: hidden;">
                                  <!-- ì„ í–‰ì§€í‘œ í—¤ë” -->
                                  <div class="kpi-folder-header" onclick="toggleKPIIndicator('${indicatorId}')" style="padding: 12px 14px;">
                                    <button class="kpi-folder-toggle" id="${indicatorId}-toggle" style="font-size: 9px; width: 22px; height: 22px;">â–¶</button>
                                    <span style="font-size: 13px; margin-right: 6px;">ğŸ‘¥</span>
                                    <span style="flex: 1; font-weight: 600; color: ${C.gray900}; font-size: 14px;">${kpi.name}</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                      <span style="font-size: 13px; font-weight: 700; color: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red};">${kpi.current}/${kpi.target} ${kpi.unit || ''}</span>
                                      <button onclick="event.stopPropagation(); openTeamKPIModal(state.teamKPIs.find(k=>k.id==='${kpi.id}'))" style="padding: 3px 6px; background: ${C.gray50}; border: none; border-radius: 4px; cursor: pointer; font-size: 9px;">í¸ì§‘</button>
                                    </div>
                                  </div>

                                  <!-- ì„ í–‰ì§€í‘œ ìƒì„¸ (ë‚´ ì„ í–‰ì§€í‘œ) -->
                                  <div class="kpi-indicator-content" id="${indicatorId}" style="padding: 0 14px 12px 14px;">
                                    <div style="background: ${C.gray100}; height: 6px; border-radius: 3px; margin-bottom: 10px; margin-left: 28px;">
                                      <div style="background: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red}; height: 100%; width: ${progress}%; border-radius: 3px;"></div>
                                    </div>
                                    ${kpiMemberKPIs.length > 0 ? `
                                      <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-left: 28px;">
                                        ${kpiMemberKPIs.map(mk => {
                                          const mkProgress = mk.target > 0 ? Math.min(100, Math.round((mk.current / mk.target) * 100)) : 0;
                                          return `
                                            <div style="background: ${C.gray50}; padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                                              <span style="font-size: 12px; color: ${C.primary}; font-weight: 500;">ğŸ‘¤ ${mk.memberName}</span>
                                              <span style="font-size: 12px; font-weight: 600; color: ${mkProgress >= 100 ? C.green : C.gray700};">${mk.current}/${mk.target}</span>
                                              <button onclick="event.stopPropagation(); quickUpdateMemberKPI('${mk.id}', ${mk.current + 1})" style="background: ${C.primary}; color: white; border: none; width: 20px; height: 20px; border-radius: 4px; cursor: pointer; font-size: 12px;">+</button>
                                            </div>
                                          `;
                                        }).join('')}
                                      </div>
                                    ` : `
                                      <div style="text-align: center; padding: 12px; margin-left: 28px; background: ${C.gray50}; border-radius: 8px;">
                                        <span style="font-size: 12px; color: ${C.gray500};">ë‚´ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</span>
                                        <button onclick="event.stopPropagation(); openMemberKPIModal(null, '${kpi.id}')" style="margin-left: 8px; padding: 4px 8px; background: ${C.yellow}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">+ ì¶”ê°€</button>
                                      </div>
                                    `}
                                  </div>
                                </div>
                              `;
                            }).join('')}
                          </div>
                        ` : `
                          <div style="text-align: center; padding: 16px; margin-left: 24px; background: ${C.white}; border-radius: 8px;">
                            <span style="font-size: 13px; color: ${C.gray500};">ì„ í–‰ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤</span>
                            <button onclick="openTeamKPIModal(null, '${project.id}')" style="margin-left: 8px; padding: 6px 12px; background: ${C.green}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">+ ì„ í–‰ì§€í‘œ ì¶”ê°€</button>
                          </div>
                        `}
                      </div>
                    </div>
                  `;
                }).join('')}
                <button onclick="openProjectModalV2(null, '${mega.id}')" style="width: 100%; padding: 10px; background: transparent; border: 2px dashed ${C.gray300}; border-radius: 10px; color: ${C.gray500}; cursor: pointer; font-size: 12px; margin-top: 8px;">
                  + í”„ë¡œì íŠ¸ ì¶”ê°€
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // í´ë” í† ê¸€ í•¨ìˆ˜ë“¤
    function toggleKPIFolder(folderId) {
      const content = document.getElementById(folderId);
      const toggle = document.getElementById(folderId + '-toggle');
      if (content && toggle) {
        content.classList.toggle('expanded');
        toggle.classList.toggle('expanded');
      }
    }

    function toggleKPISubFolder(folderId) {
      const content = document.getElementById(folderId);
      const toggle = document.getElementById(folderId + '-toggle');
      if (content && toggle) {
        content.classList.toggle('expanded');
        toggle.classList.toggle('expanded');
      }
    }

    function toggleKPIIndicator(folderId) {
      const content = document.getElementById(folderId);
      const toggle = document.getElementById(folderId + '-toggle');
      if (content && toggle) {
        content.classList.toggle('expanded');
        toggle.classList.toggle('expanded');
      }
    }

    // ëª¨ë“  í´ë” í¼ì¹˜ê¸°/ì ‘ê¸°
    function expandAllKPIFolders() {
      document.querySelectorAll('.kpi-folder-content, .kpi-subfolder-content, .kpi-indicator-content').forEach(el => {
        el.classList.add('expanded');
      });
      document.querySelectorAll('.kpi-folder-toggle').forEach(el => {
        el.classList.add('expanded');
      });
    }

    function collapseAllKPIFolders() {
      document.querySelectorAll('.kpi-folder-content, .kpi-subfolder-content, .kpi-indicator-content').forEach(el => {
        el.classList.remove('expanded');
      });
      document.querySelectorAll('.kpi-folder-toggle').forEach(el => {
        el.classList.remove('expanded');
      });
    }

    // ì„ í–‰ì§€í‘œ ë·° ë Œë”ë§
    function renderTeamKPIView(teamKPIs, projects, memberKPIs, C) {
      if (teamKPIs.length === 0) {
        return `
          <div style="text-align: center; padding: 60px; background: ${C.white}; border-radius: 16px; border: 2px dashed ${C.gray200};">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¥</div>
            <div style="font-size: 18px; font-weight: 600; color: ${C.gray900}; margin-bottom: 8px;">ë“±ë¡ëœ ì„ í–‰ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 14px; color: ${C.gray500}; margin-bottom: 20px;">ì„ í–‰ì§€í‘œë¥¼ ì¶”ê°€í•˜ì—¬ ëª©í‘œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>
            <button onclick="openTeamKPIModal()" style="padding: 12px 24px; background: ${C.green}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              + ì²« ì„ í–‰ì§€í‘œ ë§Œë“¤ê¸°
            </button>
          </div>
        `;
      }

      // í”„ë¡œì íŠ¸ë³„ë¡œ ê·¸ë£¹í•‘
      const kpisByProject = {};
      teamKPIs.forEach(kpi => {
        const projectId = kpi.projectId || 'unassigned';
        if (!kpisByProject[projectId]) {
          kpisByProject[projectId] = [];
        }
        kpisByProject[projectId].push(kpi);
      });

      return Object.keys(kpisByProject).map((projectId, projIdx) => {
        const project = projects.find(p => p.id === projectId);
        const kpis = kpisByProject[projectId];
        const projectFolderId = 'team-project-folder-' + projIdx;

        return `
          <div class="kpi-folder" style="background: ${C.white}; border-radius: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;">
            <!-- í”„ë¡œì íŠ¸ í´ë” í—¤ë” -->
            <div class="kpi-folder-header" onclick="toggleKPIFolder('${projectFolderId}')" style="padding: 20px 24px;">
              <button class="kpi-folder-toggle" id="${projectFolderId}-toggle">â–¶</button>
              <div style="width: 40px; height: 40px; background: ${C.green}20; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px;">ğŸ“</div>
              <div style="flex: 1;">
                <div style="font-size: 18px; font-weight: 700; color: ${C.gray900};">${project ? project.name : 'ë¯¸ë°°ì • KPI'}</div>
                <div style="font-size: 12px; color: ${C.gray500}; margin-top: 2px;">ì„ í–‰ì§€í‘œ ${kpis.length}ê°œ</div>
              </div>
              <button onclick="event.stopPropagation(); openTeamKPIModal(null, '${projectId}')" style="padding: 8px 16px; background: ${C.green}; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">+ ì„ í–‰ì§€í‘œ ì¶”ê°€</button>
            </div>

            <!-- í”„ë¡œì íŠ¸ í´ë” ë‚´ìš© -->
            <div class="kpi-folder-content" id="${projectFolderId}" style="padding: 0 24px 20px 24px;">
              <div style="display: grid; gap: 12px;">
                ${kpis.map((kpi, kpiIdx) => {
                  const progress = kpi.target > 0 ? Math.min(100, Math.round((kpi.current / kpi.target) * 100)) : 0;
                  const kpiMemberKPIs = memberKPIs.filter(mk => mk.teamKpiId === kpi.id);
                  const kpiFolderId = projectFolderId + '-kpi-' + kpiIdx;

                  return `
                    <div class="kpi-folder" style="background: ${C.gray50}; border-radius: 12px; border-left: 4px solid ${C.green}; overflow: hidden;">
                      <!-- ì„ í–‰ì§€í‘œ í—¤ë” -->
                      <div class="kpi-folder-header" onclick="toggleKPISubFolder('${kpiFolderId}')" style="padding: 16px 20px;">
                        <button class="kpi-folder-toggle" id="${kpiFolderId}-toggle" style="font-size: 10px;">â–¶</button>
                        <span style="font-size: 15px; margin-right: 8px;">ğŸ‘¥</span>
                        <div style="flex: 1;">
                          <div style="font-size: 15px; font-weight: 700; color: ${C.gray900};">${kpi.name}</div>
                          ${kpi.description ? `<div style="font-size: 12px; color: ${C.gray500}; margin-top: 2px;">${kpi.description}</div>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                          <span style="font-size: 15px; font-weight: 700; color: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red};">
                            ${kpi.current}/${kpi.target} ${kpi.unit || ''}
                          </span>
                          <button onclick="event.stopPropagation(); openTeamKPIModal(state.teamKPIs.find(k=>k.id==='${kpi.id}'))" style="padding: 5px 10px; background: ${C.white}; border: 1px solid ${C.gray200}; border-radius: 6px; cursor: pointer; font-size: 11px;">í¸ì§‘</button>
                        </div>
                      </div>

                      <!-- ì„ í–‰ì§€í‘œ ìƒì„¸ ë‚´ìš© -->
                      <div class="kpi-subfolder-content" id="${kpiFolderId}" style="padding: 0 20px 16px 20px;">
                        <div style="margin-left: 28px;">
                          <!-- ì§„í–‰ë¥  ë°” -->
                          <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                              <span style="font-size: 12px; color: ${C.gray500};">íŒ€ ëª©í‘œ ì§„í–‰ë¥ </span>
                              <span style="font-size: 13px; font-weight: 600; color: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red};">${progress}%</span>
                            </div>
                            <div style="background: ${C.gray200}; height: 8px; border-radius: 4px;">
                              <div style="background: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red}; height: 100%; width: ${progress}%; border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                          </div>

                          <!-- ë‚´ ì„ í–‰ì§€í‘œ ëª©ë¡ -->
                          ${kpiMemberKPIs.length > 0 ? `
                            <div style="padding-top: 12px; border-top: 1px dashed ${C.gray200};">
                              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 10px;">ğŸ‘¤ ì—°ê²°ëœ ë‚´ ì—…ë¬´ (${kpiMemberKPIs.length}ê°œ)</div>
                              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${kpiMemberKPIs.map(mk => {
                                  const mkProgress = mk.target > 0 ? Math.min(100, Math.round((mk.current / mk.target) * 100)) : 0;
                                  return `
                                    <div style="background: ${C.white}; padding: 10px 14px; border-radius: 8px; display: flex; align-items: center; gap: 10px; border: 1px solid ${C.gray200};">
                                      <span style="font-size: 13px; color: ${C.primary}; font-weight: 600;">ğŸ‘¤ ${mk.memberName}</span>
                                      <span style="font-size: 12px; color: ${C.gray500};">${mk.name}</span>
                                      <span style="font-size: 13px; font-weight: 600; color: ${mkProgress >= 100 ? C.green : mkProgress >= 70 ? C.yellow : C.red};">${mk.current}/${mk.target}</span>
                                      <button onclick="event.stopPropagation(); quickUpdateMemberKPI('${mk.id}', ${mk.current + 1})" style="background: ${C.primary}; color: white; border: none; width: 24px; height: 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">+</button>
                                    </div>
                                  `;
                                }).join('')}
                              </div>
                            </div>
                          ` : `
                            <div style="padding: 12px; background: ${C.white}; border-radius: 8px; text-align: center;">
                              <span style="font-size: 12px; color: ${C.gray500};">ì—°ê²°ëœ ë‚´ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</span>
                              <button onclick="event.stopPropagation(); openMemberKPIModal(null, '${kpi.id}')" style="margin-left: 8px; padding: 6px 12px; background: ${C.yellow}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">+ ë‚´ ì—…ë¬´ ì¶”ê°€</button>
                            </div>
                          `}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ë‚´ ì„ í–‰ì§€í‘œ ë·° ë Œë”ë§
    function renderMemberKPIView(memberKPIs, teamKPIs, projects, members, C) {
      if (memberKPIs.length === 0) {
        return `
          <div style="text-align: center; padding: 60px; background: ${C.white}; border-radius: 16px; border: 2px dashed ${C.gray200};">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¤</div>
            <div style="font-size: 18px; font-weight: 600; color: ${C.gray900}; margin-bottom: 8px;">ë“±ë¡ëœ ë‚´ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 14px; color: ${C.gray500}; margin-bottom: 20px;">ë‚´ ì—…ë¬´ë¥¼ ì¶”ê°€í•˜ì—¬ ê°œì¸ ëª©í‘œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>
            <button onclick="openMemberKPIModal()" style="padding: 12px 24px; background: ${C.yellow}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              + ì²« ë‚´ ì—…ë¬´ ë§Œë“¤ê¸°
            </button>
          </div>
        `;
      }

      // ë‹´ë‹¹ìë³„ë¡œ ê·¸ë£¹í•‘
      const kpisByMember = {};
      memberKPIs.forEach(kpi => {
        const memberName = kpi.memberName || 'ë¯¸ë°°ì •';
        if (!kpisByMember[memberName]) {
          kpisByMember[memberName] = [];
        }
        kpisByMember[memberName].push(kpi);
      });

      return Object.keys(kpisByMember).map(memberName => {
        const kpis = kpisByMember[memberName];
        const totalProgress = kpis.length > 0
          ? Math.round(kpis.reduce((sum, k) => sum + (k.target > 0 ? Math.min(100, (k.current / k.target) * 100) : 0), 0) / kpis.length)
          : 0;
        const achievedCount = kpis.filter(k => k.target > 0 && k.current >= k.target).length;
        const isCollapsed = state.collapsedMemberKPIs[memberName] || false;

        return `
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; ${isCollapsed ? '' : 'margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid ' + C.gray100 + ';'}">
              <div style="display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1;" onclick="toggleMemberKPIFolder('${memberName}')">
                <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: ${C.gray500}; transition: transform 0.2s; transform: rotate(${isCollapsed ? '0deg' : '90deg'});">â–¶</div>
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, ${C.yellow}, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">ğŸ‘¤</div>
                <div>
                  <div style="font-size: 18px; font-weight: 700; color: ${C.gray900};">${memberName}</div>
                  <div style="font-size: 13px; color: ${C.gray500};">ë‚´ ì—…ë¬´ ${kpis.length}ê°œ Â· ë‹¬ì„± ${achievedCount}ê°œ</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: ${C.gray500};">í‰ê·  ë‹¬ì„±ë¥ </div>
                  <div style="font-size: 24px; font-weight: 700; color: ${totalProgress >= 100 ? C.green : totalProgress >= 70 ? C.yellow : C.red};">${totalProgress}%</div>
                </div>
                <button onclick="openMemberKPIModal()" style="padding: 8px 16px; background: ${C.yellow}; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">+ KPI ì¶”ê°€</button>
              </div>
            </div>

            <div style="display: ${isCollapsed ? 'none' : 'grid'}; gap: 12px;">
              ${kpis.map(kpi => {
                const progress = kpi.target > 0 ? Math.min(100, Math.round((kpi.current / kpi.target) * 100)) : 0;
                const teamKPI = teamKPIs.find(tk => tk.id === kpi.teamKpiId);
                const project = projects.find(p => p.id === kpi.projectId);

                return `
                  <div style="background: ${C.gray50}; border-radius: 12px; padding: 16px; border-left: 4px solid ${C.yellow};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                      <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                          <span style="font-size: 15px; font-weight: 600; color: ${C.gray900};">${kpi.name}</span>
                          ${teamKPI ? `<span style="font-size: 11px; background: ${C.green}20; color: ${C.green}; padding: 2px 8px; border-radius: 10px;">ğŸ‘¥ ${teamKPI.name}</span>` : ''}
                          ${project ? `<span style="font-size: 11px; background: ${C.primary}20; color: ${C.primary}; padding: 2px 8px; border-radius: 10px;">ğŸ“ ${project.name}</span>` : ''}
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                          <div style="flex: 1; max-width: 300px;">
                            <div style="background: ${C.gray200}; height: 8px; border-radius: 4px;">
                              <div style="background: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red}; height: 100%; width: ${progress}%; border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                          </div>
                          <span style="font-size: 14px; font-weight: 700; color: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red};">
                            ${kpi.current}/${kpi.target} ${kpi.unit || ''}
                          </span>
                        </div>
                      </div>

                      <div style="display: flex; align-items: center; gap: 8px; margin-left: 16px;">
                        <button onclick="quickUpdateMemberKPI('${kpi.id}', ${Math.max(0, kpi.current - 1)})" style="background: ${C.gray200}; color: ${C.gray700}; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">-</button>
                        <button onclick="quickUpdateMemberKPI('${kpi.id}', ${kpi.current + 1})" style="background: ${C.primary}; color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">+</button>
                        <button onclick="openMemberKPIModal(state.memberKPIs.find(k=>k.id==='${kpi.id}'))" style="padding: 8px 12px; background: ${C.white}; border: 1px solid ${C.gray200}; border-radius: 6px; cursor: pointer; font-size: 12px;">í¸ì§‘</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function calculateMegaProjectProgress(mega, childProjects, teamKPIs, memberKPIs) {
      const allKPIs = [];
      childProjects.forEach(p => {
        teamKPIs.filter(k => k.projectId === p.id).forEach(k => allKPIs.push(k));
        memberKPIs.filter(k => k.projectId === p.id).forEach(k => allKPIs.push(k));
      });
      if (allKPIs.length === 0) return 0;
      const totalProgress = allKPIs.reduce((sum, k) => sum + Math.min(100, (k.current / k.target) * 100), 0);
      return Math.round(totalProgress / allKPIs.length);
    }

    function calculateProjectProgress(projectTeamKPIs, projectMemberKPIs) {
      const allKPIs = [...projectTeamKPIs, ...projectMemberKPIs];
      if (allKPIs.length === 0) return 0;
      const totalProgress = allKPIs.reduce((sum, k) => sum + Math.min(100, (k.current / k.target) * 100), 0);
      return Math.round(totalProgress / allKPIs.length);
    }

    async function quickUpdateMemberKPI(kpiId, newValue) {
      try {
        await db.collection('memberKPIs').doc(kpiId).update({ current: newValue, updatedAt: new Date().toISOString() });
        showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ');
      } catch (e) {
        showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
      }
    }

    function toggleMemberKPIFolder(memberName) {
      state.collapsedMemberKPIs[memberName] = !state.collapsedMemberKPIs[memberName];
      renderKPIManagement();
    }

    function renderKPICard(kpi, type) {
      const progress = kpi.target > 0 ? Math.min(100, Math.round((kpi.current / kpi.target) * 100)) : 0;
      const color = progress >= 100 ? '#00C471' : progress >= 70 ? '#F59E0B' : '#F04452';

      return `
        <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-weight: 600; color: var(--gray-900);">${kpi.name}</span>
              ${kpi.memberName ? `<span style="font-size: 11px; background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 10px;">${kpi.memberName}</span>` : ''}
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="flex: 1; background: var(--gray-200); border-radius: 4px; height: 8px;">
                <div style="background: ${color}; height: 100%; width: ${progress}%; border-radius: 4px; transition: width 0.3s;"></div>
              </div>
              <span style="font-size: 13px; font-weight: 600; color: ${color};">${kpi.current}/${kpi.target} ${kpi.unit || ''}</span>
            </div>
          </div>
        </div>
      `;
    }

    function calculateKPIAchievementRate(teamKPIs, memberKPIs) {
      const allKPIs = [...teamKPIs, ...memberKPIs];
      if (allKPIs.length === 0) return 0;
      const achieved = allKPIs.filter(k => k.current >= k.target).length;
      return Math.round((achieved / allKPIs.length) * 100);
    }

    // AI KPI ì¶”ì²œ
    function suggestKPIs() {
      const strategy = state.strategyData || {};
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), #6366F1); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ¤– AI KPI ì¶”ì²œ</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
              <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">í˜„ì¬ ì „ëµ ëª©í‘œ ê¸°ë°˜ ì¶”ì²œ</div>
              <div style="font-size: 14px; color: var(--gray-700);">ì—° ë§¤ì¶œ ${((strategy.annualRevenue || 500000000) / 100000000).toFixed(1)}ì–µ Â· ì„±ê³µë¥  ${strategy.successRate || 30}%</div>
            </div>

            <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 12px;">ğŸ“‹ ì¶”ì²œ KPI</div>
            <div style="display: grid; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 12px; cursor: pointer;">
                <input type="checkbox" checked style="width: 18px; height: 18px;">
                <div>
                  <div style="font-weight: 600;">ì›”ê°„ ê³µêµ¬ ìˆ˜</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œ: ì›” 30ê±´</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 12px; cursor: pointer;">
                <input type="checkbox" checked style="width: 18px; height: 18px;">
                <div>
                  <div style="font-weight: 600;">ì‹ ê·œ ê³µê¸‰ì‚¬ ê³„ì•½</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œ: ì›” 5ê°œ</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 12px; cursor: pointer;">
                <input type="checkbox" checked style="width: 18px; height: 18px;">
                <div>
                  <div style="font-weight: 600;">ì‹ ê·œ ì…€ëŸ¬ ì˜¨ë³´ë”©</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œ: ì›” 10ëª…</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 12px; cursor: pointer;">
                <input type="checkbox" style="width: 18px; height: 18px;">
                <div>
                  <div style="font-weight: 600;">ê³µêµ¬ ì„±ê³µë¥ </div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œ: ${strategy.successRate || 30}%</div>
                </div>
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="applyRecommendedKPIs()">ì„ íƒí•œ KPI ì ìš©</button>
          </div>
        </div>
      `;
    }

    function applyRecommendedKPIs() {
      showToast('KPIê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤');
      closeModal();
      renderKPIManagement();
    }

    function openKPIModal() {
      showToast('KPI ì¶”ê°€ ëª¨ë‹¬ ì¤€ë¹„ ì¤‘...');
    }

    function openKPIEditModal(type, name) {
      showToast(`${name} KPI í¸ì§‘ ëª¨ë‹¬ ì¤€ë¹„ ì¤‘...`);
    }

    function filterKPIByMember(memberId) {
      // íŒ€ì›ë³„ KPI í•„í„°ë§
      okrState.kpiFilter.memberId = memberId;
      localStorage.setItem('okrKpiFilter', JSON.stringify(okrState.kpiFilter));

      // OKR ëŒ€ì‹œë³´ë“œ ì¬ë Œë”ë§
      renderOkrDashboard();

      // ì„ íƒëœ íŒ€ì› ì •ë³´ í‘œì‹œ
      if (memberId === 'all') {
        showToast('ì „ì²´ íŒ€ì› KPIë¥¼ í‘œì‹œí•©ë‹ˆë‹¤', 'info');
      } else {
        const member = (state.teamMembers || []).find(m => m.id === memberId);
        if (member) {
          showToast(`${member.name}ì˜ KPIë¥¼ í‘œì‹œí•©ë‹ˆë‹¤`, 'info');
        }
      }
    }

    // ========================================
    // ê°œì¸ ëª©í‘œ ì„¤ì • (íŒ€ KPIì™€ ë³„ê°œì˜ ê°œì¸ ë‹¤ì§)
    // ========================================

    // ê°œì¸ ëª©í‘œ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
    function openPersonalTargetModal(kpiId, memberId) {
      const kpi = okrState.kpis.find(k => k.id === kpiId);
      const member = (state.teamMembers || []).find(m => m.id === memberId);
      if (!kpi || !member) {
        showToast('KPI ë˜ëŠ” íŒ€ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }

      const existingTarget = okrState.personalTargets.find(pt => pt.kpiId === kpiId && pt.memberId === memberId);
      const currentTargetValue = existingTarget?.targetValue || '';

      showModal(`
        <div style="padding: 24px; max-width: 500px;">
          <div style="font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
            ğŸ¯ ë‚´ ëª©í‘œ ì„¤ì •
          </div>

          <div style="background: var(--gray-50); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">KPI</div>
            <div style="font-size: 15px; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">${kpi.name}</div>
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">íŒ€ ëª©í‘œ</div>
            <div style="font-size: 14px; font-weight: 600; color: var(--primary);">${formatAmountWithSummary(kpi.targetValue || 0, kpi.unit || '')}</div>
          </div>

          <div style="background: linear-gradient(135deg, var(--primary)10, var(--success)10); padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
            <div style="font-size: 13px; color: var(--gray-700); margin-bottom: 8px;">ğŸ’¡ ê°œì¸ ëª©í‘œë€?</div>
            <div style="font-size: 12px; color: var(--gray-600); line-height: 1.6;">
              íŒ€ KPIì™€ ë³„ê°œë¡œ <strong>ë‚˜ë§Œì˜ ë‹¤ì§</strong>ì…ë‹ˆë‹¤.<br>
              ë‚´ê°€ ê¸°ì—¬í•˜ê³  ì‹¶ì€ ëª©í‘œë¥¼ ì„¤ì •í•˜ê³  ë‹¬ì„±í•´ë³´ì„¸ìš”!<br>
              <span style="color: var(--gray-500);">(íŒ€ KPI ê³„ì‚°ì—ëŠ” ì˜í–¥ ì—†ìŒ)</span>
            </div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
              ${member.name}ë‹˜ì˜ ëª©í‘œ *
            </label>
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="number" id="personalTargetValue" value="${currentTargetValue}" placeholder="300000000" style="flex: 1; padding: 12px 16px; border: 2px solid var(--primary); border-radius: 8px; font-size: 14px; font-family: inherit;">
              <span style="font-size: 14px; color: var(--gray-600); min-width: 40px;">${kpi.unit || ''}</span>
            </div>
            ${currentTargetValue ? `
              <div style="font-size: 11px; color: var(--gray-500); margin-top: 8px;">
                í˜„ì¬ ì„¤ì •: ${formatAmountWithSummary(currentTargetValue, kpi.unit || '')}
              </div>
            ` : ''}
          </div>

          <div style="display: flex; justify-content: ${existingTarget ? 'space-between' : 'flex-end'}; gap: 12px;">
            ${existingTarget ? `
              <button class="btn" style="background: var(--danger-light, #FEE2E2); color: var(--danger);" onclick="deletePersonalTarget('${existingTarget.id}')">
                ëª©í‘œ ì‚­ì œ
              </button>
            ` : ''}
            <div style="display: flex; gap: 12px;">
              <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
              <button class="btn btn-primary" onclick="savePersonalTarget('${kpiId}', '${memberId}', '${existingTarget?.id || ''}')">ì €ì¥</button>
            </div>
          </div>
        </div>
      `);
    }

    // ê°œì¸ ëª©í‘œ ì €ì¥
    async function savePersonalTarget(kpiId, memberId, targetId = '') {
      const targetValueInput = document.getElementById('personalTargetValue');
      const targetValue = parseFloat(targetValueInput?.value);

      if (!targetValue || targetValue <= 0) {
        showToast('ëª©í‘œê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      const kpi = okrState.kpis.find(k => k.id === kpiId);
      const member = (state.teamMembers || []).find(m => m.id === memberId);

      if (!kpi || !member) {
        showToast('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }

      const data = {
        kpiId: kpiId,
        memberId: memberId,
        targetValue: targetValue,
        kpiName: kpi.name,
        memberName: member.name,
        unit: kpi.unit || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (targetId) {
          // ê¸°ì¡´ ëª©í‘œ ìˆ˜ì •
          await db.collection('okr_personalTargets').doc(targetId).update(data);
        } else {
          // ìƒˆ ëª©í‘œ ìƒì„±
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('okr_personalTargets').add(data);
        }

        await loadOkrData();
        renderPersonalGrowthboard();
        closeModal();
        showToast(`ë‚´ ëª©í‘œê°€ ${targetId ? 'ìˆ˜ì •' : 'ì„¤ì •'}ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¯`, 'success');
      } catch (e) {
        console.error('ê°œì¸ ëª©í‘œ ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
      }
    }

    // ê°œì¸ ëª©í‘œ ì‚­ì œ
    async function deletePersonalTarget(targetId) {
      if (!confirm('ë‚´ ëª©í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('okr_personalTargets').doc(targetId).delete();
        await loadOkrData();
        renderPersonalGrowthboard();
        closeModal();
        showToast('ë‚´ ëª©í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (e) {
        console.error('ê°œì¸ ëª©í‘œ ì‚­ì œ ì˜¤ë¥˜:', e);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
      }
    }

    // ê°œì¸ ëª©í‘œ ê°€ì ¸ì˜¤ê¸°
    function getPersonalTarget(kpiId, memberId) {
      return okrState.personalTargets.find(pt => pt.kpiId === kpiId && pt.memberId === memberId);
    }

    // ê°œì¸ ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚°
    function calcPersonalTargetRate(kpiId, memberId, actualValue) {
      const personalTarget = getPersonalTarget(kpiId, memberId);
      if (!personalTarget || !personalTarget.targetValue) return null;

      const rate = Math.min(Math.round((actualValue / personalTarget.targetValue) * 100), 100);
      return {
        target: personalTarget.targetValue,
        actual: actualValue,
        rate: rate,
        remaining: Math.max(personalTarget.targetValue - actualValue, 0)
      };
    }

    // ========================================
    // ë¯¸íŒ… ì¼ì§€ ê´€ë¦¬
    // ========================================

    // ë¯¸íŒ… ë“±ë¡ ì¹´ìš´í„° (ì—°ì† ë“±ë¡ìš©)
    let meetingRegistrationCount = 0;

    // ë¯¸íŒ… ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
    function openMeetingModal(krId = null, kpiId = null) {
      meetingRegistrationCount = 0;
      showMeetingModalContent(krId, kpiId);
    }

    // ë¯¸íŒ… ëª¨ë‹¬ ë‚´ìš© í‘œì‹œ
    function showMeetingModalContent(krId = null, kpiId = null) {
      const kr = krId ? okrState.keyResults.find(k => k.id === krId) : null;
      const kpi = kpiId ? okrState.kpis.find(k => k.id === kpiId) : null;

      const meetingTypesHtml = Object.values(MEETING_TYPES).map(type => `
        <option value="${type.id}">${type.icon} ${type.name}</option>
      `).join('');

      const krOptionsHtml = okrState.keyResults.map(k => `
        <option value="${k.id}" ${kr && kr.id === k.id ? 'selected' : ''}>${k.name}</option>
      `).join('');

      const kpiOptionsHtml = kpiId ? okrState.kpis
        .filter(k => !krId || k.keyResultId === krId)
        .map(k => `
          <option value="${k.id}" ${kpi && kpi.id === k.id ? 'selected' : ''}>${k.name}</option>
        `).join('') : '';

      showModal(`
        <div style="max-width: 620px; margin: 0 auto; padding: 28px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-weight: 700; margin: 0;">ğŸ“… ë¯¸íŒ… ë“±ë¡</h3>
            ${meetingRegistrationCount > 0 ? `
              <span style="background: var(--success-light); color: var(--success); padding: 6px 14px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                âœ“ ${meetingRegistrationCount}ê±´ ë“±ë¡ ì™„ë£Œ
              </span>
            ` : ''}
          </div>

          <div style="display: grid; gap: 18px;">
            <!-- ë¯¸íŒ… íƒ€ì… (ë‹¤ì¤‘ ì„ íƒ íƒœê·¸) -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--gray-700); font-size: 14px;">ë¯¸íŒ… íƒ€ì… *</label>
              <div id="newMeetingTypes" style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${Object.values(MEETING_TYPES).map((type, idx) => `
                  <label style="display: inline-flex; align-items: center; padding: 10px 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 13px; font-weight: 600;
                                background: var(--gray-50); color: var(--gray-600); border: 2px solid transparent;"
                         onclick="toggleNewMeetingType(this, '${type.id}', '${type.color}')">
                    <input type="checkbox" class="new-meeting-type-checkbox" value="${type.id}" style="display: none;" />
                    <span>${type.icon} ${type.name}</span>
                  </label>
                `).join('')}
              </div>
            </div>

            <!-- ë¯¸íŒ… ì œëª© -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ë¯¸íŒ… ì œëª© *</label>
              <input type="text" id="meetingTitle" placeholder="ì˜ˆ: ëŒ€í‘œë‹˜ 1ì›” ì›”ê°„ ë³´ê³ " style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; font-size: 14px;" />
            </div>

            <!-- ë‚ ì§œ & ì‹œê°„ & ì°¸ì„ì (í•œ ì¤„) -->
            <div style="display: grid; grid-template-columns: 140px 110px 1fr; gap: 14px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ë‚ ì§œ *</label>
                <input type="date" id="meetingDate" value="${okrToday}" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; font-size: 14px;" />
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ì‹œê°„</label>
                <input type="time" id="meetingTime" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; font-size: 14px;" />
              </div>
            </div>

            <!-- ì°¸ì„ì (íŒ€ì› ì„ íƒ) -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ğŸ‘¥ ì°¸ì„ì ì„ íƒ</label>
              <div id="meetingParticipantsContainer" style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${(state.teamMembers || []).filter(m => m.role !== 'guest').map(member => `
                  <label style="display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; background: var(--gray-50); color: var(--gray-600); border: 2px solid transparent; transition: all 0.2s;"
                         onclick="toggleParticipant(this, '${member.id}', '${member.name}')">
                    <input type="checkbox" class="participant-checkbox" value="${member.id}" data-name="${member.name}" style="display: none;" />
                    <span>${member.name}${member.role === 'admin' ? ' ğŸ‘‘' : ''}</span>
                  </label>
                `).join('')}
                ${(state.teamMembers || []).filter(m => m.role !== 'guest').length === 0 ? '<div style="color: var(--gray-500); font-size: 13px; padding: 8px;">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤. ìš´ì˜ì„¼í„° > íŒ€ì›ê´€ë¦¬ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>' : ''}
              </div>
            </div>

            <!-- ì—°ê²°í•  KR -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--gray-700); font-size: 13px;">ì—°ê²°í•  KR</label>
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <label style="display: flex; align-items: center; padding: 8px 12px; background: var(--gray-50); border-radius: 6px; cursor: pointer; font-size: 13px;">
                  <input type="radio" name="krSelection" value="all" onchange="toggleKRSelection()" style="margin-right: 6px;" />
                  <span style="font-weight: 500; color: var(--gray-700);">ì „ì²´ KR</span>
                </label>
                <label style="display: flex; align-items: center; padding: 8px 12px; background: var(--gray-50); border-radius: 6px; cursor: pointer; font-size: 13px;">
                  <input type="radio" name="krSelection" value="specific" checked onchange="toggleKRSelection()" style="margin-right: 6px;" />
                  <span style="font-weight: 500; color: var(--gray-700);">íŠ¹ì • KR ì„ íƒ</span>
                </label>
              </div>
              <div id="krCheckboxContainer" style="padding: 10px; background: white; border: 1px solid var(--gray-300); border-radius: 8px; max-height: 150px; overflow-y: auto;">
                ${okrState.keyResults.map((k, idx) => `
                  <label style="display: flex; align-items: center; padding: 6px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;"
                         onmouseover="this.style.background='var(--gray-50)'"
                         onmouseout="this.style.background='white'">
                    <input type="checkbox" class="kr-checkbox" value="${k.id}" onchange="updateMeetingKpiOptions()"
                           ${kr && kr.id === k.id ? 'checked' : ''}
                           style="margin-right: 8px;" />
                    <span style="font-size: 13px; color: var(--gray-800);">${okrIcons[idx] || 'ğŸ“Š'} ${k.name}</span>
                  </label>
                `).join('')}
              </div>
            </div>

            <!-- ì—°ê²°í•  KPI (ì„ íƒ) -->
            <div id="meetingKpiContainer" style="display: none;">
              <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--gray-700); font-size: 13px;">ì—°ê²°í•  KPI</label>
              <div id="kpiCheckboxContainer" style="padding: 10px; background: white; border: 1px solid var(--gray-300); border-radius: 8px; max-height: 150px; overflow-y: auto;">
              </div>
            </div>

            <!-- ë¯¸íŒ… ëª©í‘œ -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--gray-700); font-size: 13px;">ğŸ¯ ë¯¸íŒ… ëª©í‘œ</label>
              <textarea id="meetingPreGoals" rows="2" placeholder="ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ëª©í‘œ" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; resize: vertical; font-size: 13px;"></textarea>
            </div>

            <!-- ì•ŒëŒ ì„¤ì • -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--gray-700); font-size: 14px;">ğŸ”” ë¯¸íŒ… ì „ ì•Œë¦¼</label>
              <div id="meetingReminderOptions" style="display: flex; flex-wrap: wrap; gap: 8px;">
                <label style="display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; background: var(--gray-50); color: var(--gray-600); border: 2px solid transparent; transition: all 0.2s;"
                       onclick="toggleReminderOption(this, 10)">
                  <input type="checkbox" class="reminder-checkbox" value="10" style="display: none;" />
                  10ë¶„ ì „
                </label>
                <label style="display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; background: var(--gray-50); color: var(--gray-600); border: 2px solid transparent; transition: all 0.2s;"
                       onclick="toggleReminderOption(this, 30)">
                  <input type="checkbox" class="reminder-checkbox" value="30" style="display: none;" />
                  30ë¶„ ì „
                </label>
                <label style="display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; background: #FEF3C720; color: #F59E0B; border: 2px solid #F59E0B;"
                       onclick="toggleReminderOption(this, 60)">
                  <input type="checkbox" class="reminder-checkbox" value="60" checked style="display: none;" />
                  1ì‹œê°„ ì „
                </label>
                <label style="display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; background: var(--gray-50); color: var(--gray-600); border: 2px solid transparent; transition: all 0.2s;"
                       onclick="toggleReminderOption(this, 1440)">
                  <input type="checkbox" class="reminder-checkbox" value="1440" style="display: none;" />
                  1ì¼ ì „
                </label>
                <label style="display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; background: var(--gray-50); color: var(--gray-600); border: 2px solid transparent; transition: all 0.2s;"
                       onclick="toggleReminderOption(this, 0)">
                  <input type="checkbox" class="reminder-checkbox" value="0" style="display: none;" />
                  ì•Œë¦¼ ì—†ìŒ
                </label>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 24px;">
            <button onclick="closeModal()" style="padding: 12px 20px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; font-weight: 600; cursor: pointer; font-size: 14px;">ë‹«ê¸°</button>
            <div style="flex: 1;"></div>
            <button onclick="saveMeetingAndContinue()" style="padding: 12px 20px; border: 1px solid var(--primary); border-radius: 8px; background: var(--primary-light); color: var(--primary); font-weight: 600; cursor: pointer; font-size: 14px;">ì €ì¥ í›„ ê³„ì† ë“±ë¡</button>
            <button onclick="saveMeeting()" style="padding: 12px 20px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; font-size: 14px;">ì €ì¥</button>
          </div>
        </div>
      `);
    }

    // ì €ì¥ í›„ ê³„ì† ë“±ë¡
    async function saveMeetingAndContinue() {
      const success = await saveMeeting(null, true);
      if (success) {
        meetingRegistrationCount++;
        showMeetingModalContent();
      }
    }

    // KR ì „ì²´/íŠ¹ì • ì„ íƒ í† ê¸€
    function toggleKRSelection() {
      const selectionType = document.querySelector('input[name="krSelection"]:checked')?.value;
      const krCheckboxContainer = document.getElementById('krCheckboxContainer');
      const kpiContainer = document.getElementById('meetingKpiContainer');

      if (selectionType === 'all') {
        krCheckboxContainer.style.display = 'none';
        kpiContainer.style.display = 'none';
      } else {
        krCheckboxContainer.style.display = 'block';
        updateMeetingKpiOptions();
      }
    }

    // KR ì„ íƒ ì‹œ KPI ì˜µì…˜ ì—…ë°ì´íŠ¸
    function updateMeetingKpiOptions() {
      const selectedKRIds = Array.from(document.querySelectorAll('.kr-checkbox:checked')).map(cb => cb.value);
      const kpiContainer = document.getElementById('meetingKpiContainer');
      const kpiCheckboxContainer = document.getElementById('kpiCheckboxContainer');

      if (selectedKRIds.length === 0) {
        kpiContainer.style.display = 'none';
        return;
      }

      kpiContainer.style.display = 'block';

      // ì„ íƒëœ KRë“¤ì˜ KPI í•„í„°ë§
      const kpis = okrState.kpis.filter(k => selectedKRIds.includes(k.keyResultId));

      if (kpis.length === 0) {
        kpiCheckboxContainer.innerHTML = '<div style="color: var(--gray-500); font-size: 13px; padding: 8px;">ì„ íƒí•œ KRì— ì—°ê²°ëœ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      kpiCheckboxContainer.innerHTML = kpis.map(kpi => {
        const kr = okrState.keyResults.find(k => k.id === kpi.keyResultId);
        const krIdx = okrState.keyResults.findIndex(k => k.id === kpi.keyResultId);
        return `
          <label style="display: flex; align-items: flex-start; padding: 8px; margin-bottom: 4px; cursor: pointer; border-radius: 6px; transition: background 0.2s;"
                 onmouseover="this.style.background='var(--gray-50)'"
                 onmouseout="this.style.background='white'">
            <input type="checkbox" class="kpi-checkbox" value="${kpi.id}" style="margin-right: 8px; margin-top: 2px;" />
            <div>
              <div style="font-size: 14px; font-weight: 600; color: var(--gray-800);">${kpi.name}</div>
              <div style="font-size: 11px; color: var(--gray-500); margin-top: 2px;">${okrIcons[krIdx] || 'ğŸ“Š'} ${kr?.name || ''}</div>
            </div>
          </label>
        `;
      }).join('');
    }

    // ë¯¸íŒ… íƒ€ì… í† ê¸€ (ë“±ë¡ ëª¨ë‹¬ìš©)
    function toggleNewMeetingType(label, typeId, color) {
      const checkbox = label.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        label.style.background = color + '20';
        label.style.color = color;
        label.style.borderColor = color;
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.color = 'var(--gray-600)';
        label.style.borderColor = 'transparent';
      }
    }

    // ì•ŒëŒ ì˜µì…˜ í† ê¸€
    function toggleReminderOption(label, minutes) {
      const checkbox = label.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        label.style.background = '#FEF3C720';
        label.style.color = '#F59E0B';
        label.style.borderColor = '#F59E0B';
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.color = 'var(--gray-600)';
        label.style.borderColor = 'transparent';
      }
    }

    // ì°¸ì„ì í† ê¸€
    function toggleParticipant(label, memberId, memberName) {
      const checkbox = label.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        label.style.background = 'var(--primary-light)';
        label.style.color = 'var(--primary)';
        label.style.borderColor = 'var(--primary)';
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.color = 'var(--gray-600)';
        label.style.borderColor = 'transparent';
      }
    }

    // ì°¸ì„ì í† ê¸€ (ìˆ˜ì • ëª¨ë‹¬ìš©)
    function toggleEditParticipant(label, memberId, memberName) {
      const checkbox = label.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        label.style.background = 'var(--primary-light)';
        label.style.color = 'var(--primary)';
        label.style.borderColor = 'var(--primary)';
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.color = 'var(--gray-600)';
        label.style.borderColor = 'transparent';
      }
    }

    // ë¯¸íŒ… ì €ì¥
    async function saveMeeting(meetingId = null, continueRegistration = false) {
      // ë‹¤ì¤‘ íƒ€ì… ì„ íƒ
      const types = Array.from(document.querySelectorAll('.new-meeting-type-checkbox:checked')).map(cb => cb.value);
      const title = document.getElementById('meetingTitle')?.value.trim();
      const date = document.getElementById('meetingDate')?.value;
      const time = document.getElementById('meetingTime')?.value;

      // ì°¸ì„ì (ì²´í¬ë°•ìŠ¤ì—ì„œ ìˆ˜ì§‘)
      const participantCheckboxes = document.querySelectorAll('.participant-checkbox:checked');
      const participantIds = Array.from(participantCheckboxes).map(cb => cb.value);
      const participants = Array.from(participantCheckboxes).map(cb => cb.dataset.name);
      const preAgenda = document.getElementById('meetingPreAgenda')?.value.trim() || '';
      const preGoals = document.getElementById('meetingPreGoals')?.value.trim() || '';

      // ì•ŒëŒ ì„¤ì • ìˆ˜ì§‘
      const reminders = Array.from(document.querySelectorAll('.reminder-checkbox:checked')).map(cb => parseInt(cb.value));

      // KR ì„ íƒ íƒ€ì… í™•ì¸
      const krSelectionType = document.querySelector('input[name="krSelection"]:checked')?.value;
      const isAllKRs = krSelectionType === 'all';

      // ì„ íƒëœ KR/KPI ìˆ˜ì§‘
      const selectedKRIds = isAllKRs ? okrState.keyResults.map(kr => kr.id) :
        Array.from(document.querySelectorAll('.kr-checkbox:checked')).map(cb => cb.value);
      const selectedKPIIds = Array.from(document.querySelectorAll('.kpi-checkbox:checked')).map(cb => cb.value);

      if (types.length === 0 || !title || !date) {
        showToast('ë¯¸íŒ… íƒ€ì…, ì œëª©, ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤', 'error');
        return false;
      }

      const meetingData = {
        objectiveId: okrState.objective?.id || '',
        isAllKRs: isAllKRs,
        krIds: selectedKRIds,
        kpiIds: selectedKPIIds,
        // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ë‹¨ì¼ ê°’ë„ ì €ì¥ (ì²« ë²ˆì§¸ ê°’)
        krId: selectedKRIds.length > 0 ? selectedKRIds[0] : null,
        kpiId: selectedKPIIds.length > 0 ? selectedKPIIds[0] : null,
        types: types,           // ë‹¤ì¤‘ íƒ€ì…
        type: types[0],         // í•˜ìœ„ í˜¸í™˜ì„± (ì²« ë²ˆì§¸ íƒ€ì…)
        title: title,
        date: date,
        time: time || null,
        reminders: reminders,   // ì•ŒëŒ ì„¤ì • (ë¶„ ë‹¨ìœ„)
        participantIds: participantIds, // ì°¸ì„ì ID ëª©ë¡ (ì•Œë¦¼ìš©)
        participants: participants,     // ì°¸ì„ì ì´ë¦„ ëª©ë¡
        preAgenda: preAgenda,
        preGoals: preGoals,
        requestsReceived: '',  // ë¯¸íŒ… í›„ ì •ë¦¬ì—ì„œ ì…ë ¥
        requestsMade: '',      // ë¯¸íŒ… í›„ ì •ë¦¬ì—ì„œ ì…ë ¥
        preStatus: preAgenda || preGoals ? 'ì¤€ë¹„ ì™„ë£Œ' : 'ë¯¸ì‘ì„±',
        status: MEETING_STATUS.SCHEDULED,
        postSummary: '',
        postDecisions: [],
        postActionItems: [],
        createdBy: state.user?.uid || 'unknown',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (meetingId) {
          await db.collection('okr_meetings').doc(meetingId).update(meetingData);
          showToast('ë¯¸íŒ…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          const docRef = await db.collection('okr_meetings').add(meetingData);
          showToast('ë¯¸íŒ…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

          // ì°¸ì„ìì—ê²Œ ì•Œë¦¼ ì „ì†¡
          if (participantIds.length > 0) {
            await createMeetingNotifications(meetingData, docRef.id);
          }
        }

        await loadOkrData();
        renderOkrDashboard();

        if (!continueRegistration) {
          closeModal();
        }
        return true;
      } catch (error) {
        console.error('ë¯¸íŒ… ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ë¯¸íŒ… ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        return false;
      }
    }

    // ë¯¸íŒ… ìƒì„¸ ë³´ê¸° (ë¯¸íŒ… í›„ ì •ë¦¬ í¬í•¨)
    function openMeetingDetailModal(meetingId) {
      const meeting = okrState.meetings.find(m => m.id === meetingId);
      if (!meeting) return;

      const meetingType = Object.values(MEETING_TYPES).find(t => t.id === meeting.type);
      const meetingTypes = meeting.types || [meeting.type]; // ë‹¤ì¤‘ íƒ€ì… ì§€ì›
      const isCompleted = meeting.status === MEETING_STATUS.COMPLETED;

      showModal(`
        <div style="max-width: 700px; margin: 0 auto; padding: 28px;">
          <!-- í—¤ë” -->
          <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 24px;">
            <div style="width: 52px; height: 52px; border-radius: 14px; background: ${meetingType?.color || '#6366F1'}15; display: flex; align-items: center; justify-content: center; font-size: 26px; flex-shrink: 0;">
              ${meetingType?.icon || 'ğŸ“…'}
            </div>
            <div style="flex: 1; min-width: 0;">
              <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700; color: var(--gray-900);">${meeting.title}</h3>
              <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                ${meetingTypes.map(typeId => {
                  const type = Object.values(MEETING_TYPES).find(t => t.id === typeId);
                  return type ? `<span style="padding: 4px 10px; background: ${type.color}15; color: ${type.color}; border-radius: 6px; font-size: 12px; font-weight: 600;">${type.icon} ${type.name}</span>` : '';
                }).join('')}
                <span style="font-size: 13px; color: var(--gray-500);">Â· ${meeting.date} ${meeting.time || ''}</span>
              </div>
            </div>
            <!-- ë²„íŠ¼ ê·¸ë£¹ -->
            <div style="display: flex; gap: 8px;">
              <button onclick="printMeeting('${meetingId}')" style="padding: 8px 14px; background: var(--gray-100); border: none; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--gray-700); cursor: pointer; display: flex; align-items: center; gap: 4px;" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'">
                ğŸ–¨ï¸ ì¸ì‡„
              </button>
              <button onclick="openEditMeetingModal('${meetingId}')" style="padding: 8px 14px; background: var(--gray-100); border: none; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--gray-700); cursor: pointer; display: flex; align-items: center; gap: 4px;" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'">
                âœï¸ ìˆ˜ì •
              </button>
            </div>
          </div>

          <!-- ë¯¸íŒ… ì •ë³´ -->
          <div style="background: var(--gray-50); padding: 20px; border-radius: 14px; margin-bottom: 24px;">
            ${(() => {
              // ê³„íšëœ KR
              const plannedKRIds = meeting.krIds || [meeting.krId].filter(id => id);
              const plannedKRs = meeting.isAllKRs
                ? okrState.keyResults
                : plannedKRIds.map(krId => okrState.keyResults.find(k => k.id === krId)).filter(kr => kr);

              // ì‹¤ì œ ë…¼ì˜ëœ KR (ì™„ë£Œëœ ê²½ìš°ì—ë§Œ)
              const actualKRIds = meeting.actualKRIds || plannedKRIds;
              const actualKRs = meeting.status === MEETING_STATUS.COMPLETED && meeting.actualKRIds
                ? actualKRIds.map(krId => okrState.keyResults.find(k => k.id === krId)).filter(kr => kr)
                : plannedKRs;

              // ì—°ê²°ëœ KPI í‘œì‹œ
              const linkedKPIs = (meeting.kpiIds || [meeting.kpiId]).filter(id => id).map(kpiId => okrState.kpis.find(k => k.id === kpiId)).filter(kpi => kpi);

              // ì¶”ê°€ëœ KR (ì‹¤ì œ - ê³„íš)
              const addedKRs = actualKRs.filter(kr => !plannedKRIds.includes(kr.id));
              // ì œê±°ëœ KR (ê³„íš - ì‹¤ì œ)
              const removedKRs = plannedKRs.filter(kr => !actualKRIds.includes(kr.id));

              return `
                ${meeting.status === MEETING_STATUS.COMPLETED && (addedKRs.length > 0 || removedKRs.length > 0) ? `
                  <div style="margin-bottom: 16px; padding: 12px; background: #FEF3C7; border-left: 4px solid #F59E0B; border-radius: 8px;">
                    <div style="font-size: 13px; font-weight: 700; color: #92400E; margin-bottom: 8px;">
                      âš¡ ê³„íšê³¼ ì‹¤ì œ ë…¼ì˜ê°€ ë‹¬ëìŠµë‹ˆë‹¤
                    </div>
                    ${addedKRs.length > 0 ? `
                      <div style="font-size: 12px; color: #78350F; margin-bottom: 4px;">
                        ì¶”ê°€ ë…¼ì˜: ${addedKRs.map(kr => {
                          const krIdx = okrState.keyResults.findIndex(k => k.id === kr.id);
                          return `${okrIcons[krIdx]} ${kr.name}`;
                        }).join(', ')}
                      </div>
                    ` : ''}
                    ${removedKRs.length > 0 ? `
                      <div style="font-size: 12px; color: #78350F;">
                        ë…¼ì˜ ì•ˆ í•¨: ${removedKRs.map(kr => {
                          const krIdx = okrState.keyResults.findIndex(k => k.id === kr.id);
                          return `${okrIcons[krIdx]} ${kr.name}`;
                        }).join(', ')}
                      </div>
                    ` : ''}
                  </div>
                ` : ''}
                ${actualKRs.length > 0 ? `
                  <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">
                      ${meeting.status === MEETING_STATUS.COMPLETED ? 'ì‹¤ì œ ë…¼ì˜ëœ KR' : 'ì—°ê²°ëœ KR'}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                      ${meeting.isAllKRs ? `
                        <span style="padding: 4px 10px; background: var(--primary); color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">
                          ì „ì²´ KR (${actualKRs.length}ê°œ)
                        </span>
                      ` : actualKRs.map((kr, idx) => {
                        const krIdx = okrState.keyResults.findIndex(k => k.id === kr.id);
                        const wasAdded = addedKRs.some(akr => akr.id === kr.id);
                        return `
                          <span style="padding: 4px 10px; background: ${okrColors[krIdx]}20; color: ${okrColors[krIdx]}; border-radius: 6px; font-size: 12px; font-weight: 600; ${wasAdded ? 'border: 2px solid #F59E0B;' : ''}">
                            ${okrIcons[krIdx] || 'ğŸ“Š'} ${kr.name}
                            ${wasAdded ? ' âš¡' : ''}
                          </span>
                        `;
                      }).join('')}
                    </div>
                  </div>
                ` : ''}
                ${linkedKPIs.length > 0 ? `
                  <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">ì—°ê²°ëœ KPI</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                      ${linkedKPIs.map(kpi => `
                        <span style="padding: 4px 10px; background: var(--gray-100); color: var(--gray-700); border-radius: 6px; font-size: 12px;">
                          ${kpi.name}
                        </span>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
                ${meeting.participants && meeting.participants.length > 0 ? `
                  <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">ì°¸ì„ì</div>
                    <div style="font-size: 14px; color: var(--gray-800);">${meeting.participants.join(', ')}</div>
                  </div>
                ` : ''}
                ${meeting.reminders && meeting.reminders.length > 0 ? `
                  <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">ğŸ”” ì•Œë¦¼ ì„¤ì •</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                      ${meeting.reminders.map(min => {
                        const label = min === 0 ? 'ì•Œë¦¼ ì—†ìŒ' : min === 10 ? '10ë¶„ ì „' : min === 30 ? '30ë¶„ ì „' : min === 60 ? '1ì‹œê°„ ì „' : min === 1440 ? '1ì¼ ì „' : min + 'ë¶„ ì „';
                        return `<span style="padding: 4px 10px; background: #FEF3C720; color: #F59E0B; border-radius: 6px; font-size: 12px; font-weight: 600;">${label}</span>`;
                      }).join('')}
                    </div>
                  </div>
                ` : ''}
                <div style="display: inline-block; padding: 4px 12px; background: ${getStatusColor(meeting.status)}20; color: ${getStatusColor(meeting.status)}; border-radius: 6px; font-size: 12px; font-weight: 600;">
                  ${getStatusLabel(meeting.status)}
                </div>
              `;
            })()}
          </div>

          <!-- ì‚¬ì „ ê³„íš -->
          <div style="margin-bottom: 28px;">
            <h4 style="font-size: 15px; font-weight: 700; margin-bottom: 14px; color: var(--gray-800);">ğŸ“ ì‚¬ì „ ê³„íš</h4>
            ${meeting.preAgenda ? `
              <div style="margin-bottom: 14px;">
                <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 6px;">ë…¼ì˜ ë‚´ìš©</div>
                <div style="padding: 14px 16px; background: white; border: 1px solid var(--gray-200); border-radius: 10px; white-space: pre-wrap; font-size: 14px; line-height: 1.7; color: var(--gray-800);">${meeting.preAgenda}</div>
              </div>
            ` : '<div style="color: var(--gray-400); font-size: 13px; padding: 12px 0;">ì‘ì„±ëœ ë…¼ì˜ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
            ${meeting.preGoals ? `
              <div>
                <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 6px;">ë¯¸íŒ… ëª©í‘œ</div>
                <div style="padding: 14px 16px; background: white; border: 1px solid var(--gray-200); border-radius: 10px; white-space: pre-wrap; font-size: 14px; line-height: 1.7; color: var(--gray-800);">${meeting.preGoals}</div>
              </div>
            ` : ''}
            ${(meeting.requestsReceived || meeting.requestsMade) ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 14px;">
                <div>
                  <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 6px;">ğŸ“¥ ë‚´ê°€ ìš”ì²­ ë°›ì€ ê²ƒ</div>
                  <div style="padding: 14px 16px; background: white; border: 1px solid var(--gray-200); border-radius: 10px; white-space: pre-wrap; font-size: 14px; line-height: 1.7; color: var(--gray-800); min-height: 60px;">${meeting.requestsReceived || '-'}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 6px;">ğŸ“¤ ë‚´ê°€ ìš”ì²­í•œ ê²ƒ</div>
                  <div style="padding: 14px 16px; background: white; border: 1px solid var(--gray-200); border-radius: 10px; white-space: pre-wrap; font-size: 14px; line-height: 1.7; color: var(--gray-800); min-height: 60px;">${meeting.requestsMade || '-'}</div>
                </div>
              </div>
            ` : ''}
          </div>

          <!-- ì‚¬í›„ ì •ë¦¬ -->
          <div style="margin-bottom: 28px; padding: 24px; background: #F0FDF4; border-radius: 14px; border: 2px solid #10B981;">
            <h4 style="font-size: 15px; font-weight: 700; margin-bottom: 16px; color: var(--gray-800);">âœ… ë¯¸íŒ… í›„ ì •ë¦¬</h4>

            <!-- ì‹¤ì œ ë…¼ì˜ëœ KR -->
            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 10px; border: 1px solid var(--gray-200);">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">
                ğŸ“Š ì‹¤ì œ ë…¼ì˜ëœ KR (ê³„íšê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
              </label>
              <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 12px;">
                ë¯¸íŒ… ì¤‘ ì¦‰í¥ì ìœ¼ë¡œ ì¶”ê°€ ë…¼ì˜ëœ KRì´ ìˆë‹¤ë©´ ì²´í¬í•˜ì„¸ìš”
              </div>
              <div style="display: grid; gap: 8px; max-height: 200px; overflow-y: auto;">
                ${(() => {
                  const plannedKRIds = meeting.krIds || [meeting.krId].filter(id => id);
                  const actualKRIds = meeting.actualKRIds || plannedKRIds;

                  return okrState.keyResults.map((kr, idx) => {
                    const wasPlanned = plannedKRIds.includes(kr.id);
                    const isChecked = actualKRIds.includes(kr.id);

                    return `
                      <label style="display: flex; align-items: center; padding: 8px; border-radius: 6px; cursor: pointer; background: ${wasPlanned ? '#FEF3C7' : 'white'}; transition: all 0.2s;"
                             onmouseover="this.style.background='${wasPlanned ? '#FDE68A' : 'var(--gray-50)'}'"
                             onmouseout="this.style.background='${wasPlanned ? '#FEF3C7' : 'white'}'">
                        <input type="checkbox" class="actual-kr-checkbox" value="${kr.id}" ${isChecked ? 'checked' : ''}
                               style="margin-right: 8px;" />
                        <div style="flex: 1;">
                          <span style="font-size: 14px; font-weight: 600; color: var(--gray-800);">
                            ${okrIcons[idx] || 'ğŸ“Š'} ${kr.name}
                          </span>
                          ${wasPlanned ? `
                            <span style="margin-left: 8px; padding: 2px 6px; background: #F59E0B; color: white; border-radius: 4px; font-size: 10px; font-weight: 600;">
                              ê³„íšë¨
                            </span>
                          ` : ''}
                        </div>
                      </label>
                    `;
                  }).join('');
                })()}
              </div>
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ë¯¸íŒ… ìš”ì•½</label>
              <textarea id="postSummary" rows="4" placeholder="ë¯¸íŒ…ì—ì„œ ë…¼ì˜ëœ ì£¼ìš” ë‚´ìš©ì„ ì •ë¦¬í•˜ì„¸ìš”" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; resize: vertical; font-size: 14px; line-height: 1.6;">${meeting.postSummary || ''}</textarea>
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ğŸ’¡ ì£¼ìš” ì˜ì‚¬ê²°ì •</label>
              <textarea id="postDecisions" rows="3" placeholder="ê° ê²°ì •ì‚¬í•­ì„ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; resize: vertical; font-size: 14px; line-height: 1.6;">${meeting.postDecisions && meeting.postDecisions.length > 0 ? meeting.postDecisions.join('\n') : ''}</textarea>
              <div style="font-size: 11px; color: var(--gray-500); margin-top: 6px;">ê° ê²°ì •ì‚¬í•­ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">âœ”ï¸ ì•¡ì…˜ ì•„ì´í…œ</label>
              <textarea id="postActionItems" rows="3" placeholder="ë‹´ë‹¹ìì™€ ì‘ì—…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: [@ê¹€ì†¡í¬] íŒŒíŠ¸ë„ˆ ì „ëµ ì¬ìˆ˜ë¦½)" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; resize: vertical; font-size: 14px; line-height: 1.6;">${meeting.postActionItems && meeting.postActionItems.length > 0 ? meeting.postActionItems.map(a => `[@${a.assignee}] ${a.task}`).join('\n') : ''}</textarea>
              <div style="font-size: 11px; color: var(--gray-500); margin-top: 6px;">[@ë‹´ë‹¹ì] ì‘ì—…ë‚´ìš© í˜•ì‹ìœ¼ë¡œ ì…ë ¥</div>
            </div>

            <!-- ìš”ì²­ ë°›ì€ ê²ƒ / ìš”ì²­í•œ ê²ƒ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ğŸ“¥ ë‚´ê°€ ìš”ì²­ ë°›ì€ ê²ƒ</label>
                <textarea id="postRequestsReceived" rows="3" placeholder="ìƒëŒ€ë°©ì´ ë‚˜ì—ê²Œ ìš”ì²­í•œ ë‚´ìš©" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; resize: vertical; font-size: 14px; line-height: 1.6;">${meeting.requestsReceived || ''}</textarea>
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ğŸ“¤ ë‚´ê°€ ìš”ì²­í•œ ê²ƒ</label>
                <textarea id="postRequestsMade" rows="3" placeholder="ë‚´ê°€ ìƒëŒ€ë°©ì—ê²Œ ìš”ì²­í•œ ë‚´ìš©" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; resize: vertical; font-size: 14px; line-height: 1.6;">${meeting.requestsMade || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- í•˜ë‹¨ ë²„íŠ¼ -->
          <div style="display: flex; gap: 12px; padding-top: 4px;">
            <button onclick="closeModal()" style="padding: 14px 24px; border: 1px solid var(--gray-300); border-radius: 10px; background: white; font-weight: 600; cursor: pointer; font-size: 14px;">ë‹«ê¸°</button>
            <div style="flex: 1;"></div>
            ${!isCompleted ? `
              <button onclick="completeMeeting('${meetingId}')" style="padding: 14px 28px; border: none; border-radius: 10px; background: #10B981; color: white; font-weight: 600; cursor: pointer; font-size: 14px;">âœ… ë¯¸íŒ… ì™„ë£Œ</button>
            ` : `
              <button onclick="updateMeetingPost('${meetingId}')" style="padding: 14px 28px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; font-size: 14px;">ğŸ’¾ ì €ì¥</button>
            `}
          </div>
        </div>
      `);
    }

    // ë¯¸íŒ… ì¸ì‡„ ê¸°ëŠ¥
    function printMeeting(meetingId) {
      const meeting = okrState.meetings.find(m => m.id === meetingId);
      if (!meeting) return;

      const meetingTypes = meeting.types || [meeting.type];
      const typeLabels = meetingTypes.map(typeId => {
        const type = Object.values(MEETING_TYPES).find(t => t.id === typeId);
        return type ? `${type.icon} ${type.name}` : typeId;
      }).join(', ');

      // ì—°ê²°ëœ KPI
      const kpiIds = (meeting.kpiIds || [meeting.kpiId]).filter(id => id);
      const kpis = kpiIds.map(kpiId => okrState.kpis.find(k => k.id === kpiId)).filter(kpi => kpi);
      const kpiLabels = kpis.map(kpi => kpi.name).join(', ') || '-';

      // ì°¸ì„ì
      const participants = meeting.participants || [];

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>ë¯¸íŒ… - ${meeting.title}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
              font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
              padding: 24px;
              color: #1F2937;
              line-height: 1.5;
              max-width: 100%;
            }
            .header {
              text-align: center;
              border-bottom: 2px solid #1F2937;
              padding-bottom: 12px;
              margin-bottom: 16px;
            }
            .title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
            .meeting-type { font-size: 12px; color: #6B7280; }
            .info-row {
              display: flex;
              gap: 16px;
              margin-bottom: 12px;
              padding: 10px;
              background: #F9FAFB;
              border-radius: 6px;
              font-size: 13px;
            }
            .info-item { display: flex; gap: 6px; }
            .info-label { font-weight: 600; color: #6B7280; white-space: nowrap; }
            .info-value { color: #1F2937; }
            .section {
              margin-bottom: 12px;
            }
            .section-title {
              font-size: 13px;
              font-weight: 700;
              color: #1F2937;
              padding: 6px 0;
              border-bottom: 1px solid #E5E7EB;
              margin-bottom: 8px;
            }
            .content-box {
              border: 1px solid #E5E7EB;
              border-radius: 6px;
              padding: 10px;
              min-height: 50px;
              background: #FAFAFA;
              font-size: 13px;
            }
            .note-lines {
              border: 1px solid #E5E7EB;
              border-radius: 6px;
              padding: 10px;
              min-height: 300px;
              background: repeating-linear-gradient(
                transparent,
                transparent 23px,
                #E5E7EB 23px,
                #E5E7EB 24px
              );
            }
            .two-col {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 12px;
            }
            .request-box {
              border: 1px solid #E5E7EB;
              border-radius: 6px;
              padding: 10px;
              min-height: 80px;
              background: #FAFAFA;
            }
            .print-date {
              text-align: right;
              font-size: 10px;
              color: #9CA3AF;
              margin-top: 12px;
            }
            @media print {
              body { padding: 16px; }
              @page { margin: 10mm; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="title">${meeting.title}</div>
            <div class="meeting-type">${typeLabels}</div>
          </div>

          <div class="info-row">
            <div class="info-item"><span class="info-label">ğŸ“… ì¼ì‹œ:</span><span class="info-value">${meeting.date} ${meeting.time || ''}</span></div>
            <div class="info-item"><span class="info-label">ğŸ‘¥ ì°¸ì„ì:</span><span class="info-value">${participants.length > 0 ? participants.join(', ') : '-'}</span></div>
            <div class="info-item"><span class="info-label">ğŸ“Š KPI:</span><span class="info-value">${kpiLabels}</span></div>
          </div>

          <div class="section">
            <div class="section-title">ğŸ¯ ë¯¸íŒ… ëª©í‘œ</div>
            <div class="content-box">${meeting.preGoals || '&nbsp;'}</div>
          </div>

          <div class="section">
            <div class="section-title">ğŸ’¬ ë…¼ì˜ ë‚´ìš©</div>
            <div class="content-box">${meeting.preAgenda || '&nbsp;'}</div>
          </div>

          <div class="section">
            <div class="section-title">ğŸ“‹ ë¯¸íŒ… ë…¸íŠ¸</div>
            <div class="note-lines">${meeting.notes || ''}</div>
          </div>

          <div class="two-col">
            <div class="section">
              <div class="section-title">ğŸ“¥ ë‚´ê°€ ìš”ì²­ ë°›ì€ ê²ƒ</div>
              <div class="request-box">${meeting.requestsReceived || '&nbsp;'}</div>
            </div>
            <div class="section">
              <div class="section-title">ğŸ“¤ ë‚´ê°€ ìš”ì²­í•œ ê²ƒ</div>
              <div class="request-box">${meeting.requestsMade || '&nbsp;'}</div>
            </div>
          </div>

          <div class="print-date">ì¶œë ¥ì¼: ${new Date().toLocaleDateString('ko-KR')}</div>
        </body>
        </html>
      `);

      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => { printWindow.print(); }, 300);
    }

    // ë¯¸íŒ… ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function openEditMeetingModal(meetingId) {
      const meeting = okrState.meetings.find(m => m.id === meetingId);
      if (!meeting) return;

      const meetingTypes = meeting.types || [meeting.type]; // ë‹¤ì¤‘ íƒ€ì… ì§€ì›

      showModal(`
        <div style="max-width: 600px; margin: 0 auto; padding: 28px;">
          <h3 style="font-size: 20px; font-weight: 700; margin: 0 0 24px 0;">âœï¸ ë¯¸íŒ… ìˆ˜ì •</h3>

          <div style="display: grid; gap: 18px;">
            <!-- ë¯¸íŒ… íƒ€ì… (ë‹¤ì¤‘ ì„ íƒ íƒœê·¸) -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--gray-700); font-size: 14px;">ë¯¸íŒ… íƒ€ì… *</label>
              <div id="editMeetingTypes" style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${Object.values(MEETING_TYPES).map(type => {
                  const isSelected = meetingTypes.includes(type.id);
                  return `
                    <label style="display: inline-flex; align-items: center; padding: 10px 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 13px; font-weight: 600;
                                  background: ${isSelected ? type.color + '20' : 'var(--gray-50)'}; color: ${isSelected ? type.color : 'var(--gray-600)'}; border: 2px solid ${isSelected ? type.color : 'transparent'};"
                           onclick="toggleEditMeetingType(this, '${type.id}', '${type.color}')">
                      <input type="checkbox" class="edit-meeting-type-checkbox" value="${type.id}" ${isSelected ? 'checked' : ''} style="display: none;" />
                      <span>${type.icon} ${type.name}</span>
                    </label>
                  `;
                }).join('')}
              </div>
            </div>

            <!-- ë¯¸íŒ… ì œëª© -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ë¯¸íŒ… ì œëª© *</label>
              <input type="text" id="editMeetingTitle" value="${meeting.title}" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; font-size: 14px;" />
            </div>

            <!-- ë‚ ì§œ & ì‹œê°„ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ë‚ ì§œ *</label>
                <input type="date" id="editMeetingDate" value="${meeting.date}" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; font-size: 14px;" />
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ì‹œê°„</label>
                <input type="time" id="editMeetingTime" value="${meeting.time || ''}" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; font-size: 14px;" />
              </div>
            </div>

            <!-- ì°¸ì„ì (íŒ€ì› ì„ íƒ) -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ğŸ‘¥ ì°¸ì„ì ì„ íƒ</label>
              <div id="editMeetingParticipantsContainer" style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${(state.teamMembers || []).filter(m => m.role !== 'guest').map(member => {
                  const isSelected = (meeting.participantIds || []).includes(member.id) || (meeting.participants || []).includes(member.name);
                  return `
                    <label style="display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;
                                  background: ${isSelected ? 'var(--primary-light)' : 'var(--gray-50)'}; color: ${isSelected ? 'var(--primary)' : 'var(--gray-600)'}; border: 2px solid ${isSelected ? 'var(--primary)' : 'transparent'}; transition: all 0.2s;"
                           onclick="toggleEditParticipant(this, '${member.id}', '${member.name}')">
                      <input type="checkbox" class="edit-participant-checkbox" value="${member.id}" data-name="${member.name}" ${isSelected ? 'checked' : ''} style="display: none;" />
                      <span>${member.name}${member.role === 'admin' ? ' ğŸ‘‘' : ''}</span>
                    </label>
                  `;
                }).join('')}
                ${(state.teamMembers || []).filter(m => m.role !== 'guest').length === 0 ? '<div style="color: var(--gray-500); font-size: 13px; padding: 8px;">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>' : ''}
              </div>
            </div>

            <!-- ë…¼ì˜ ë‚´ìš© -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ğŸ“ ë…¼ì˜ ë‚´ìš©</label>
              <textarea id="editMeetingPreAgenda" rows="3" placeholder="ë¯¸íŒ…ì—ì„œ ë…¼ì˜í•  ë‚´ìš©" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; resize: vertical; font-size: 14px; line-height: 1.6;">${meeting.preAgenda || ''}</textarea>
            </div>

            <!-- ë¯¸íŒ… ëª©í‘œ -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 14px;">ğŸ¯ ë¯¸íŒ… ëª©í‘œ</label>
              <textarea id="editMeetingPreGoals" rows="2" placeholder="ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ëª©í‘œ" style="width: 100%; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 10px; resize: vertical; font-size: 14px; line-height: 1.6;">${meeting.preGoals || ''}</textarea>
            </div>

            <!-- ì•ŒëŒ ì„¤ì • -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--gray-700); font-size: 14px;">ğŸ”” ë¯¸íŒ… ì „ ì•Œë¦¼</label>
              <div id="editMeetingReminderOptions" style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${[
                  { value: 10, label: '10ë¶„ ì „' },
                  { value: 30, label: '30ë¶„ ì „' },
                  { value: 60, label: '1ì‹œê°„ ì „' },
                  { value: 1440, label: '1ì¼ ì „' },
                  { value: 0, label: 'ì•Œë¦¼ ì—†ìŒ' }
                ].map(opt => {
                  const isSelected = (meeting.reminders || [60]).includes(opt.value);
                  return `
                    <label style="display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;
                                  background: ${isSelected ? '#FEF3C720' : 'var(--gray-50)'}; color: ${isSelected ? '#F59E0B' : 'var(--gray-600)'}; border: 2px solid ${isSelected ? '#F59E0B' : 'transparent'}; transition: all 0.2s;"
                           onclick="toggleEditReminderOption(this, ${opt.value})">
                      <input type="checkbox" class="edit-reminder-checkbox" value="${opt.value}" ${isSelected ? 'checked' : ''} style="display: none;" />
                      ${opt.label}
                    </label>
                  `;
                }).join('')}
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 12px; margin-top: 28px;">
            <button onclick="deleteMeeting('${meetingId}')" style="padding: 14px 20px; border: 1px solid #EF4444; border-radius: 10px; background: white; color: #EF4444; font-weight: 600; cursor: pointer; font-size: 14px;">ğŸ—‘ï¸ ì‚­ì œ</button>
            <div style="flex: 1;"></div>
            <button onclick="closeModal(); openMeetingDetailModal('${meetingId}');" style="padding: 14px 24px; border: 1px solid var(--gray-300); border-radius: 10px; background: white; font-weight: 600; cursor: pointer; font-size: 14px;">ì·¨ì†Œ</button>
            <button onclick="updateMeetingInfo('${meetingId}')" style="padding: 14px 28px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; font-size: 14px;">ğŸ’¾ ì €ì¥</button>
          </div>
        </div>
      `);
    }

    // ë¯¸íŒ… íƒ€ì… í† ê¸€ (ìˆ˜ì • ëª¨ë‹¬ìš©)
    function toggleEditMeetingType(label, typeId, color) {
      const checkbox = label.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        label.style.background = color + '20';
        label.style.color = color;
        label.style.borderColor = color;
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.color = 'var(--gray-600)';
        label.style.borderColor = 'transparent';
      }
    }

    // ì•ŒëŒ ì˜µì…˜ í† ê¸€ (ìˆ˜ì • ëª¨ë‹¬ìš©)
    function toggleEditReminderOption(label, minutes) {
      const checkbox = label.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        label.style.background = '#FEF3C720';
        label.style.color = '#F59E0B';
        label.style.borderColor = '#F59E0B';
      } else {
        label.style.background = 'var(--gray-50)';
        label.style.color = 'var(--gray-600)';
        label.style.borderColor = 'transparent';
      }
    }

    // ë¯¸íŒ… ê¸°ë³¸ ì •ë³´ ìˆ˜ì •
    async function updateMeetingInfo(meetingId) {
      const types = Array.from(document.querySelectorAll('.edit-meeting-type-checkbox:checked')).map(cb => cb.value);
      const reminders = Array.from(document.querySelectorAll('.edit-reminder-checkbox:checked')).map(cb => parseInt(cb.value));
      const title = document.getElementById('editMeetingTitle')?.value.trim();
      const date = document.getElementById('editMeetingDate')?.value;
      const time = document.getElementById('editMeetingTime')?.value;

      // ì°¸ì„ì (ì²´í¬ë°•ìŠ¤ì—ì„œ ìˆ˜ì§‘)
      const participantCheckboxes = document.querySelectorAll('.edit-participant-checkbox:checked');
      const participantIds = Array.from(participantCheckboxes).map(cb => cb.value);
      const participants = Array.from(participantCheckboxes).map(cb => cb.dataset.name);

      const preAgenda = document.getElementById('editMeetingPreAgenda')?.value.trim();
      const preGoals = document.getElementById('editMeetingPreGoals')?.value.trim();

      if (types.length === 0 || !title || !date) {
        showToast('ë¯¸íŒ… íƒ€ì…, ì œëª©, ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤', 'error');
        return;
      }

      try {
        await db.collection('okr_meetings').doc(meetingId).update({
          types: types,
          type: types[0], // í•˜ìœ„ í˜¸í™˜ì„±
          reminders: reminders, // ì•ŒëŒ ì„¤ì • (ë¶„ ë‹¨ìœ„)
          title: title,
          date: date,
          time: time || null,
          participantIds: participantIds, // ì°¸ì„ì ID ëª©ë¡
          participants: participants,     // ì°¸ì„ì ì´ë¦„ ëª©ë¡
          preAgenda: preAgenda || '',
          preGoals: preGoals || '',
          preStatus: preAgenda || preGoals ? 'ì¤€ë¹„ ì™„ë£Œ' : 'ë¯¸ì‘ì„±',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('ë¯¸íŒ…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        await loadOkrData();
        renderOkrDashboard();
        if (state.currentTab === 'meeting-history') renderMeetingHistory();
        closeModal();
        openMeetingDetailModal(meetingId);
      } catch (error) {
        console.error('ë¯¸íŒ… ìˆ˜ì • ì˜¤ë¥˜:', error);
        showToast('ë¯¸íŒ… ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // ë¯¸íŒ… ì‚­ì œ
    async function deleteMeeting(meetingId) {
      if (!confirm('ì •ë§ë¡œ ì´ ë¯¸íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('okr_meetings').doc(meetingId).delete();
        showToast('ë¯¸íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        await loadOkrData();
        renderOkrDashboard();
        if (state.currentTab === 'meeting-history') renderMeetingHistory();
        closeModal();
      } catch (error) {
        console.error('ë¯¸íŒ… ì‚­ì œ ì˜¤ë¥˜:', error);
        showToast('ë¯¸íŒ… ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // ë¯¸íŒ… ìƒíƒœë³„ ìƒ‰ìƒ
    function getStatusColor(status) {
      const colors = {
        [MEETING_STATUS.SCHEDULED]: '#F59E0B',
        [MEETING_STATUS.IN_PROGRESS]: '#3B82F6',
        [MEETING_STATUS.COMPLETED]: '#10B981',
        [MEETING_STATUS.CANCELLED]: '#EF4444'
      };
      return colors[status] || '#6B7280';
    }

    // ë¯¸íŒ… ìƒíƒœë³„ ë¼ë²¨
    function getStatusLabel(status) {
      const labels = {
        [MEETING_STATUS.SCHEDULED]: 'ì˜ˆì •',
        [MEETING_STATUS.IN_PROGRESS]: 'ì§„í–‰ì¤‘',
        [MEETING_STATUS.COMPLETED]: 'ì™„ë£Œ',
        [MEETING_STATUS.CANCELLED]: 'ì·¨ì†Œ'
      };
      return labels[status] || status;
    }

    // ë¯¸íŒ… ì™„ë£Œ ì²˜ë¦¬
    async function completeMeeting(meetingId) {
      const postSummary = document.getElementById('postSummary')?.value.trim();
      const postDecisionsStr = document.getElementById('postDecisions')?.value.trim();
      const postActionItemsStr = document.getElementById('postActionItems')?.value.trim();
      const requestsReceived = document.getElementById('postRequestsReceived')?.value.trim() || '';
      const requestsMade = document.getElementById('postRequestsMade')?.value.trim() || '';

      // ì‹¤ì œ ë…¼ì˜ëœ KR ìˆ˜ì§‘
      const actualKRIds = Array.from(document.querySelectorAll('.actual-kr-checkbox:checked')).map(cb => cb.value);

      const postDecisions = postDecisionsStr ? postDecisionsStr.split('\n').map(d => d.trim()).filter(d => d) : [];

      // ì•¡ì…˜ ì•„ì´í…œ íŒŒì‹± ([@ë‹´ë‹¹ì] ì‘ì—…ë‚´ìš©)
      const postActionItems = [];
      if (postActionItemsStr) {
        const lines = postActionItemsStr.split('\n').map(l => l.trim()).filter(l => l);
        lines.forEach(line => {
          const match = line.match(/\[@([^\]]+)\]\s*(.+)/);
          if (match) {
            postActionItems.push({
              assignee: match[1],
              task: match[2],
              status: 'pending'
            });
          }
        });
      }

      try {
        await db.collection('okr_meetings').doc(meetingId).update({
          status: MEETING_STATUS.COMPLETED,
          actualKRIds: actualKRIds,  // ì‹¤ì œ ë…¼ì˜ëœ KR ì €ì¥
          postSummary: postSummary || '',
          postDecisions: postDecisions,
          postActionItems: postActionItems,
          requestsReceived: requestsReceived,
          requestsMade: requestsMade,
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('ë¯¸íŒ…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        await loadOkrData();
        renderOkrDashboard();
        closeModal();
      } catch (error) {
        console.error('ë¯¸íŒ… ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        showToast('ë¯¸íŒ… ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // ë¯¸íŒ… ì‚¬í›„ ì •ë¦¬ ìˆ˜ì •
    async function updateMeetingPost(meetingId) {
      const postSummary = document.getElementById('postSummary')?.value.trim();
      const postDecisionsStr = document.getElementById('postDecisions')?.value.trim();
      const postActionItemsStr = document.getElementById('postActionItems')?.value.trim();
      const requestsReceived = document.getElementById('postRequestsReceived')?.value.trim() || '';
      const requestsMade = document.getElementById('postRequestsMade')?.value.trim() || '';

      // ì‹¤ì œ ë…¼ì˜ëœ KR ìˆ˜ì§‘
      const actualKRIds = Array.from(document.querySelectorAll('.actual-kr-checkbox:checked')).map(cb => cb.value);

      const postDecisions = postDecisionsStr ? postDecisionsStr.split('\n').map(d => d.trim()).filter(d => d) : [];

      const postActionItems = [];
      if (postActionItemsStr) {
        const lines = postActionItemsStr.split('\n').map(l => l.trim()).filter(l => l);
        lines.forEach(line => {
          const match = line.match(/\[@([^\]]+)\]\s*(.+)/);
          if (match) {
            postActionItems.push({
              assignee: match[1],
              task: match[2],
              status: 'pending'
            });
          }
        });
      }

      try {
        await db.collection('okr_meetings').doc(meetingId).update({
          actualKRIds: actualKRIds,  // ì‹¤ì œ ë…¼ì˜ëœ KR ì €ì¥
          postSummary: postSummary || '',
          postDecisions: postDecisions,
          postActionItems: postActionItems,
          requestsReceived: requestsReceived,
          requestsMade: requestsMade,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('ë¯¸íŒ… ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        await loadOkrData();
        renderOkrDashboard();
        closeModal();
      } catch (error) {
        console.error('ë¯¸íŒ… ìˆ˜ì • ì˜¤ë¥˜:', error);
        showToast('ë¯¸íŒ… ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // ========================================
    // ì„±ê³¼ë¶„ì„ ì‹œìŠ¤í…œ (ì—­ìˆœ ë°ì´í„° í™•ì¸ + ê°œì¸ë³„ ì„±ê³µë¥ )
    // ========================================
    let reviewViewMode = 'summary'; // summary, reverse, member

    function renderStrategicReview() {
      const container = document.getElementById('reviewContent');
      if (!container) return;

      const C = {
        primary: '#3182f6',
        purple: '#6366F1',
        green: '#00C471',
        yellow: '#F59E0B',
        red: '#F04452',
        gray50: '#F2F4F6',
        gray100: '#E5E8EB',
        gray200: '#D1D6DB',
        gray500: '#6B7684',
        gray700: '#333D4B',
        gray900: '#191F28',
        white: '#FFFFFF'
      };

      // ë°ì´í„° ì§‘ê³„
      const currentYear = new Date().getFullYear();
      const yearGoal = (state.yearlyGoals || []).find(g => g.year === currentYear) || {};
      const megaProjects = state.megaProjects || [];
      const projects = state.projects || [];
      const teamKPIs = state.teamKPIs || [];
      const memberKPIs = state.memberKPIs || [];
      const tasks = state.tasks || [];
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');

      // ì—°ë„ë³„ ëª©í‘œ ë‹¬ì„±ë¥ 
      const yearTarget = yearGoal.revenueTarget || 1000000000;
      const yearSettlements = (state.sellerSettlements || []).filter(s =>
        (s.settlementDate || s.createdAt || '').startsWith(String(currentYear))
      );
      const yearAchieved = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
      const revenueProgress = Math.round((yearAchieved / yearTarget) * 100);

      // KPI ë‹¬ì„±ë¥ 
      const allKPIs = [...teamKPIs, ...memberKPIs];
      const kpiAchieved = allKPIs.filter(k => k.current >= k.target).length;
      const kpiProgress = allKPIs.length > 0 ? Math.round((kpiAchieved / allKPIs.length) * 100) : 0;

      // ì—…ë¬´ ì„±ê³µë¥  (ê¸°í•œ ë‚´ ì™„ë£Œ)
      const completedTasks = tasks.filter(t => t.status === 'complete');
      const successTasks = completedTasks.filter(t => t.isSuccess === true);
      const taskSuccessRate = completedTasks.length > 0 ? Math.round((successTasks.length / completedTasks.length) * 100) : 0;

      // íŒ€ì›ë³„ ì„±ê³µë¥  ê³„ì‚°
      const memberStats = members.map(member => {
        const memberTasks = tasks.filter(t => t.assigneeId === member.id || t.assignee === member.name);
        const memberCompleted = memberTasks.filter(t => t.status === 'complete');
        const memberSuccess = memberCompleted.filter(t => t.isSuccess === true);
        const successRate = memberCompleted.length > 0 ? Math.round((memberSuccess.length / memberCompleted.length) * 100) : 0;

        const myKPIs = memberKPIs.filter(k => k.memberId === member.id);
        const kpiAchievedCount = myKPIs.filter(k => k.current >= k.target).length;

        return {
          ...member,
          totalTasks: memberTasks.length,
          completedTasks: memberCompleted.length,
          successTasks: memberSuccess.length,
          successRate,
          totalKPIs: myKPIs.length,
          kpiAchieved: kpiAchievedCount
        };
      });

      container.innerHTML = `
        <div style="max-width: 1400px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 style="font-size: 24px; font-weight: 700; color: ${C.gray900}; margin: 0;">ğŸ” ì„±ê³¼ë¶„ì„</h1>
              <p style="color: ${C.gray500}; margin-top: 4px; font-size: 13px;">ì—­ìˆœ ë°ì´í„° í™•ì¸ Â· ê°œì¸ë³„ ì„±ê³µë¥  Â· ë³´ê³ ì„œ ìë™ ìƒì„±</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="generateMemberReport()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.white}; color: ${C.primary}; border: 1px solid ${C.primary}; border-radius: 8px; cursor: pointer;">
                ğŸ“„ ê°œì¸ ë³´ê³ ì„œ
              </button>
              <button onclick="generateAdminReport()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.purple}; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ğŸ“Š ê´€ë¦¬ì ë³´ê³ ì„œ
              </button>
            </div>
          </div>

          <!-- ë·° ëª¨ë“œ ì „í™˜ -->
          <div style="display: flex; gap: 8px; margin-bottom: 20px; background: ${C.gray50}; padding: 4px; border-radius: 10px; width: fit-content;">
            <button onclick="setReviewViewMode('summary')" style="background: ${reviewViewMode === 'summary' ? C.primary : 'transparent'}; color: ${reviewViewMode === 'summary' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ“ˆ ëª©í‘œ ë‹¬ì„± í˜„í™©
            </button>
            <button onclick="setReviewViewMode('reverse')" style="background: ${reviewViewMode === 'reverse' ? C.primary : 'transparent'}; color: ${reviewViewMode === 'reverse' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ”„ ì—­ìˆœ ë°ì´í„°
            </button>
            <button onclick="setReviewViewMode('member')" style="background: ${reviewViewMode === 'member' ? C.primary : 'transparent'}; color: ${reviewViewMode === 'member' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ‘¤ ê°œì¸ë³„ ì„±ê³µë¥ 
            </button>
          </div>

          <!-- ëª©í‘œ ë‹¬ì„± ìš”ì•½ -->
          <div style="background: linear-gradient(135deg, #1e3a5f, #0f2744); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white;">
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 20px; opacity: 0.9;">ğŸ¯ ${currentYear}ë…„ ëª©í‘œ ë‹¬ì„± í˜„í™© â†’ ìµœì¢… 100ì–µ ë‹¬ì„±</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
              <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">ë§¤ì¶œ ë‹¬ì„±ë¥ </div>
                <div style="font-size: 28px; font-weight: 700; color: ${revenueProgress >= 70 ? C.green : revenueProgress >= 40 ? C.yellow : C.red};">${revenueProgress}%</div>
                <div style="font-size: 11px; opacity: 0.8;">${(yearAchieved / 100000000).toFixed(1)}ì–µ / ${(yearTarget / 100000000).toFixed(0)}ì–µ</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">KPI ë‹¬ì„±ë¥ </div>
                <div style="font-size: 28px; font-weight: 700; color: ${kpiProgress >= 70 ? C.green : kpiProgress >= 40 ? C.yellow : C.red};">${kpiProgress}%</div>
                <div style="font-size: 11px; opacity: 0.8;">${kpiAchieved} / ${allKPIs.length}ê°œ</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">ì—…ë¬´ ì„±ê³µë¥ </div>
                <div style="font-size: 28px; font-weight: 700; color: ${taskSuccessRate >= 70 ? C.green : taskSuccessRate >= 40 ? C.yellow : C.red};">${taskSuccessRate}%</div>
                <div style="font-size: 11px; opacity: 0.8;">${successTasks.length} / ${completedTasks.length}ê±´ (ê¸°í•œ ë‚´ ì™„ë£Œ)</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">í”„ë¡œì íŠ¸ ì§„í–‰</div>
                <div style="font-size: 28px; font-weight: 700;">${projects.length}</div>
                <div style="font-size: 11px; opacity: 0.8;">íŒ€ KPI ${megaProjects.length}ê°œ</div>
              </div>
            </div>
          </div>

          <!-- ë©”ì¸ ì»¨í…ì¸  -->
          <div id="review-main-content">
            ${reviewViewMode === 'summary' ? renderReviewSummary(megaProjects, projects, teamKPIs, memberKPIs, tasks, C) :
              reviewViewMode === 'reverse' ? renderReverseDataView(yearGoal, megaProjects, projects, teamKPIs, memberKPIs, tasks, C) :
              renderMemberSuccessRates(memberStats, C)}
          </div>

          <!-- ë³´ê³ ì„œ ìƒì„± ì•ˆë‚´ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 24px;">
            <div style="background: linear-gradient(135deg, ${C.primary}, #1b64da); border-radius: 16px; padding: 24px; color: white;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">ğŸ“„ ê°œì¸ë³„ ì„±ê³¼ë¶„ì„ PPT</div>
                  <div style="font-size: 13px; opacity: 0.9;">ë‚´ ì—…ë¬´ â†’ ì„±ê³µë¥ ì„ ì •ë¦¬í•œ ë°œí‘œ ìë£Œ</div>
                </div>
                <button onclick="generateMemberReport()" style="padding: 12px 20px; background: white; color: ${C.primary}; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                  ìƒì„±í•˜ê¸°
                </button>
              </div>
            </div>
            <div style="background: linear-gradient(135deg, ${C.purple}, #8B5CF6); border-radius: 16px; padding: 24px; color: white;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">ğŸ“Š ê´€ë¦¬ì í˜„í™© ë³´ê³ ì„œ</div>
                  <div style="font-size: 13px; opacity: 0.9;">ì „ì²´ ì „ëµ í˜„í™© ë° íŒ€ì›ë³„ ë¶„ì„ ë³´ê³ ì„œ</div>
                </div>
                <button onclick="generateAdminReport()" style="padding: 12px 20px; background: white; color: ${C.purple}; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                  ìƒì„±í•˜ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function setReviewViewMode(mode) {
      reviewViewMode = mode;
      renderStrategicReview();
    }

    function renderReviewSummary(megaProjects, projects, teamKPIs, memberKPIs, tasks, C) {
      return `
        <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <div style="font-size: 16px; font-weight: 700; color: ${C.gray900}; margin-bottom: 20px;">ğŸ”„ ì „ëµ â†’ ê²°ê³¼ íë¦„</div>
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ¢</div>
              <div style="font-weight: 600; color: ${C.gray900};">íŒ€ KPI</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.purple}; margin-top: 8px;">${megaProjects.length}</div>
            </div>
            <div style="font-size: 20px; color: ${C.gray300};">â†’</div>
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“</div>
              <div style="font-weight: 600; color: ${C.gray900};">í”„ë¡œì íŠ¸</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.primary}; margin-top: 8px;">${projects.length}</div>
            </div>
            <div style="font-size: 20px; color: ${C.gray300};">â†’</div>
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ‘¥</div>
              <div style="font-weight: 600; color: ${C.gray900};">ì„ í–‰ì§€í‘œ</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.green}; margin-top: 8px;">${teamKPIs.length}</div>
            </div>
            <div style="font-size: 20px; color: ${C.gray300};">â†’</div>
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ‘¤</div>
              <div style="font-weight: 600; color: ${C.gray900};">ë‚´ ì—…ë¬´</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.yellow}; margin-top: 8px;">${memberKPIs.length}</div>
            </div>
            <div style="font-size: 20px; color: ${C.gray300};">â†’</div>
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“</div>
              <div style="font-weight: 600; color: ${C.gray900};">ì—…ë¬´</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.primary}; margin-top: 8px;">${tasks.length}</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderReverseDataView(yearGoal, megaProjects, projects, teamKPIs, memberKPIs, tasks, C) {
      // ì—­ìˆœ: ìµœì¢…ëª©í‘œ â† ë©”ì¸ KPI â† ì„œë¸Œ KPI â† ì„ í–‰ì§€í‘œ â† ì—…ë¬´
      const yearTarget = yearGoal.revenueTarget || 1000000000;

      // ë¯¸í¡ ì˜ì—­ ë¶„ì„
      const lowPerformingKPIs = [...teamKPIs, ...memberKPIs].filter(k => {
        const progress = k.target > 0 ? (k.current / k.target) * 100 : 0;
        return progress < 50;
      });

      const overdueTasks = tasks.filter(t => {
        if (t.status === 'complete') return false;
        const deadline = t.deadline || t.dueDate;
        if (!deadline) return false;
        return new Date(deadline) < new Date();
      });

      return `
        <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <div style="font-size: 16px; font-weight: 700; color: ${C.gray900}; margin-bottom: 20px;">ğŸ”„ ì—­ìˆœ ë°ì´í„° ë¶„ì„ (ê²°ê³¼ â†’ ì›ì¸)</div>

          <!-- ìµœì¢… ëª©í‘œ -->
          <div style="background: linear-gradient(135deg, #1e3a5f, #0f2744); border-radius: 12px; padding: 20px; color: white; margin-bottom: 16px;">
            <div style="font-size: 14px; opacity: 0.8;">ğŸ¯ ìµœì¢… ëª©í‘œ</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 8px;">${(yearTarget / 100000000).toFixed(0)}ì–µ ë‹¬ì„±</div>
            <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">ì–´ë–¤ ë¶€ë¶„ì´ ë¯¸í¡í•œì§€ í™•ì¸í•˜ê³  ë¹ ë¥´ê²Œ ìˆ˜ì •, ë³´ì™„</div>
          </div>

          <!-- ë¯¸í¡ ì˜ì—­ -->
          <div style="background: ${C.red}10; border: 1px solid ${C.red}30; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
            <div style="font-size: 14px; font-weight: 700; color: ${C.red}; margin-bottom: 12px;">âš ï¸ ë¯¸í¡ ì˜ì—­ (ê¸´ê¸‰ ì¡°ì¹˜ í•„ìš”)</div>

            ${lowPerformingKPIs.length > 0 ? `
              <div style="margin-bottom: 16px;">
                <div style="font-size: 13px; font-weight: 600; color: ${C.gray700}; margin-bottom: 8px;">ğŸ“Š ì§„í–‰ë¥  50% ë¯¸ë§Œ KPI (${lowPerformingKPIs.length}ê±´)</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  ${lowPerformingKPIs.slice(0, 5).map(k => {
                    const progress = k.target > 0 ? Math.round((k.current / k.target) * 100) : 0;
                    return `
                      <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 14px; border-radius: 8px;">
                        <span style="font-size: 13px; color: ${C.gray900};">${k.name}</span>
                        <span style="font-size: 13px; font-weight: 600; color: ${C.red};">${k.current}/${k.target} (${progress}%)</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            ${overdueTasks.length > 0 ? `
              <div>
                <div style="font-size: 13px; font-weight: 600; color: ${C.gray700}; margin-bottom: 8px;">â° ê¸°í•œ ì´ˆê³¼ ì—…ë¬´ (${overdueTasks.length}ê±´)</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  ${overdueTasks.slice(0, 5).map(t => `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 14px; border-radius: 8px;">
                      <span style="font-size: 13px; color: ${C.gray900};">${t.title}</span>
                      <span style="font-size: 12px; color: ${C.red};">ê¸°í•œ: ${t.deadline || t.dueDate}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${lowPerformingKPIs.length === 0 && overdueTasks.length === 0 ? `
              <div style="text-align: center; padding: 20px; color: ${C.green};">
                <div style="font-size: 24px; margin-bottom: 8px;">âœ…</div>
                <div>í˜„ì¬ ê¸´ê¸‰ ì¡°ì¹˜ê°€ í•„ìš”í•œ ë¯¸í¡ ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤!</div>
              </div>
            ` : ''}
          </div>

          <!-- ì—­ìˆœ íë¦„ -->
          <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 16px;">
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">ìµœì¢…ëª©í‘œ</div>
              <div style="font-weight: 600; color: ${C.gray900};">${(yearTarget / 100000000).toFixed(0)}ì–µ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">íŒ€ KPI</div>
              <div style="font-weight: 600; color: ${C.purple};">${megaProjects.length}ê°œ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">í”„ë¡œì íŠ¸</div>
              <div style="font-weight: 600; color: ${C.primary};">${projects.length}ê°œ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">ì„ í–‰ì§€í‘œ</div>
              <div style="font-weight: 600; color: ${C.green};">${teamKPIs.length}ê°œ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">ë‚´ ì—…ë¬´</div>
              <div style="font-weight: 600; color: ${C.yellow};">${memberKPIs.length}ê°œ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">ì—…ë¬´</div>
              <div style="font-weight: 600; color: ${C.primary};">${tasks.length}ê±´</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMemberSuccessRates(memberStats, C) {
      return `
        <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <div style="font-size: 16px; font-weight: 700; color: ${C.gray900}; margin-bottom: 20px;">ğŸ‘¤ ê°œì¸ë³„ ì—…ë¬´ ì„±ê³µë¥ </div>

          <div style="display: grid; gap: 16px;">
            ${memberStats.map(m => {
              const rateColor = m.successRate >= 80 ? C.green : m.successRate >= 50 ? C.yellow : C.red;
              return `
                <div style="background: ${C.gray50}; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 20px;">
                  <div style="width: 60px; height: 60px; background: linear-gradient(135deg, ${C.primary}, #1b64da); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
                    ${m.name?.charAt(0) || '?'}
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 18px; font-weight: 700; color: ${C.gray900}; margin-bottom: 8px;">${m.name}</div>
                    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                      <div>
                        <div style="font-size: 11px; color: ${C.gray500};">ì—…ë¬´ ì„±ê³µë¥ </div>
                        <div style="font-size: 16px; font-weight: 700; color: ${rateColor};">${m.successRate}%</div>
                      </div>
                      <div>
                        <div style="font-size: 11px; color: ${C.gray500};">ì™„ë£Œ ì—…ë¬´</div>
                        <div style="font-size: 16px; font-weight: 600; color: ${C.gray900};">${m.completedTasks}ê±´</div>
                      </div>
                      <div>
                        <div style="font-size: 11px; color: ${C.gray500};">ê¸°í•œ ë‚´ ì™„ë£Œ</div>
                        <div style="font-size: 16px; font-weight: 600; color: ${C.green};">${m.successTasks}ê±´</div>
                      </div>
                      <div>
                        <div style="font-size: 11px; color: ${C.gray500};">KPI ë‹¬ì„±</div>
                        <div style="font-size: 16px; font-weight: 600; color: ${C.primary};">${m.kpiAchieved}/${m.totalKPIs}</div>
                      </div>
                    </div>
                  </div>
                  <div style="text-align: center;">
                    <div style="font-size: 36px; font-weight: 700; color: ${rateColor};">${m.successRate}%</div>
                    <div style="font-size: 11px; color: ${C.gray500};">ì„±ê³µë¥ </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          ${memberStats.length === 0 ? `
            <div style="text-align: center; padding: 40px; color: ${C.gray500};">
              <div style="font-size: 32px; margin-bottom: 12px;">ğŸ‘¤</div>
              <div>íŒ€ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function openABTestModal() {
      showToast('A/B í…ŒìŠ¤íŠ¸ ê¸°ë¡ì€ ì—…ë¬´ ë“±ë¡ ì‹œ ë©”ëª¨ì— ì‘ì„±í•´ì£¼ì„¸ìš”');
    }

    function generatePersonalPPT() {
      generateMemberReport();
    }

    // ========================================
    // ì—…ë¬´ì¼ì§€ ì‹œìŠ¤í…œ
    // ========================================
    let workLogTasks = [];
    let workLogMonth = '';

    function getCurrentMember() {
      return {
        id: state.currentUser?.odooId || state.currentUser?.id || 'unknown',
        loginId: state.currentUser?.loginId || '',
        name: state.currentUser?.name || 'ë¯¸ì§€ì •'
      };
    }

    // ë¯¸ì—°ê²° ì—…ë¬´ í•„í„° ìƒíƒœ
    let unlinkedFilter = false;

    function renderWorkLog() {
      const container = document.getElementById('worklogContent');
      if (!container) return;

      const now = new Date();
      workLogMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      const currentMember = getCurrentMember();
      const isAdmin = state.currentUser?.role === 'admin';

      container.innerHTML = `
        <div style="max-width: 1400px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
              <h1 style="font-size: 26px; font-weight: 700; color: #191F28; margin: 0;">ğŸ““ ì—…ë¬´ê´€ë¦¬</h1>
              <p style="color: #6B7684; margin-top: 8px; font-size: 15px;">ì—…ë¬´ ì‹¤í–‰ â†’ ì§€í‘œ ê¸°ë¡ â†’ ìë™ ì§‘ê³„</p>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="openQuickTaskModal()" style="padding: 12px 20px; font-size: 14px; font-weight: 600; background: #0064FF; color: white; border: none; border-radius: 12px; cursor: pointer;">
                â• ìƒˆ ì—…ë¬´
              </button>
            </div>
          </div>

          <!-- ì§€í‘œ ìš”ì•½ ì¹´ë“œ -->
          <div id="lagging-indicator-summary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 16px; font-weight: 700;">ğŸ“Š ì§€í‘œ í˜„í™© (ì‹¤ì œ ì‹¤í–‰)</div>
              <div style="font-size: 12px; opacity: 0.8;">ì§€í‘œë³„ ì™„ë£Œ ì—…ë¬´ ì§‘ê³„</div>
            </div>
            <div id="lagging-stats" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px;">
              <div style="text-align: center; padding: 12px 20px; background: rgba(255,255,255,0.15); border-radius: 12px; min-width: 100px;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">ë¡œë”©ì¤‘...</div>
              </div>
            </div>
          </div>

          <!-- ì»¨íŠ¸ë¡¤ ë°” -->
          <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
              <!-- ì›” ì„ íƒ -->
              <div style="display: flex; align-items: center; gap: 10px;">
                <button onclick="changeWorkLogMonth(-1)" style="background: #E5E8EB; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 18px;">â†</button>
                <input type="month" id="worklog-month" value="${workLogMonth}" onchange="loadWorkLogData()" style="padding: 10px 16px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px; font-weight: 600;" />
                <button onclick="changeWorkLogMonth(1)" style="background: #E5E8EB; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 18px;">â†’</button>
              </div>

              <!-- ì—°ê²° í•„í„° -->
              <div style="display: flex; gap: 8px; align-items: center;">
                <button id="filter-unlinked" onclick="toggleUnlinkedFilter()" style="background: ${unlinkedFilter ? '#F04452' : '#F2F4F6'}; color: ${unlinkedFilter ? 'white' : '#6B7684'}; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                  ğŸ”— ë¯¸ì—°ê²°ë§Œ
                </button>
                <div style="display: flex; gap: 4px; background: #F2F4F6; padding: 4px; border-radius: 10px;">
                  <button id="filter-my" onclick="setMemberFilter('my')" style="background: ${memberFilter === 'my' ? '#0064FF' : 'transparent'}; color: ${memberFilter === 'my' ? 'white' : '#6B7684'}; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ‘¤ ë‚´ ì—…ë¬´</button>
                  <button id="filter-all" onclick="setMemberFilter('all')" style="background: ${memberFilter === 'all' ? '#0064FF' : 'transparent'}; color: ${memberFilter === 'all' ? 'white' : '#6B7684'}; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ‘¥ ì „ì²´ íŒ€</button>
                </div>
                <select id="member-select" onchange="setMemberFilter('member', this.value)" style="padding: 10px 14px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 13px; font-weight: 600; background: ${memberFilter === 'member' ? '#E8F3FF' : 'white'}; color: #191F28; cursor: pointer;">
                  <option value="">íŒ€ì› ì„ íƒ</option>
                  ${(state.teamMembers || []).filter(m => m.role !== 'ceo' && m.id !== currentMember.id).map(m => `<option value="${m.id}" ${selectedMemberId === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                </select>
              </div>

              <!-- ë·° ì „í™˜ -->
              <div style="display: flex; gap: 8px; background: #F2F4F6; padding: 4px; border-radius: 10px;">
                <button id="view-kanban" onclick="setWorkLogView('kanban')" style="background: ${workLogView === 'kanban' ? '#0064FF' : 'transparent'}; color: ${workLogView === 'kanban' ? 'white' : '#6B7684'}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“‹ ì¹¸ë°˜</button>
                <button id="view-timeline" onclick="setWorkLogView('timeline')" style="background: ${workLogView === 'timeline' ? '#0064FF' : 'transparent'}; color: ${workLogView === 'timeline' ? 'white' : '#6B7684'}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“ íƒ€ì„ë¼ì¸</button>
              </div>
            </div>
          </div>

          <!-- ì‚¬ìš©ì ì¹´ë“œ -->
          <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; align-items: center; gap: 14px;">
              <div style="width: 48px; height: 48px; background: ${memberFilter === 'all' ? '#FEF3C7' : memberFilter === 'member' ? '#E0E7FF' : '#E8F3FF'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: ${memberFilter === 'all' ? '#F59E0B' : memberFilter === 'member' ? '#6366F1' : '#0064FF'};">${memberFilter === 'all' ? 'ğŸ‘¥' : 'ğŸ‘¤'}</div>
              <div>
                <div style="font-size: 18px; font-weight: 700; color: #191F28;" id="worklog-title">${memberFilter === 'all' ? 'ì „ì²´ íŒ€ ì—…ë¬´' : memberFilter === 'member' ? getSelectedMemberName() + ' ì—…ë¬´' : currentMember.name + ' (ë‚˜)'}</div>
                <div style="font-size: 13px; color: #6B7684;" id="today-summary">ì—…ë¬´ í˜„í™© ë¡œë”©ì¤‘...</div>
              </div>
            </div>
            ${memberFilter !== 'my' ? `<span style="font-size: 12px; padding: 6px 12px; background: #F2F4F6; border-radius: 20px; color: #6B7684;">${memberFilter === 'all' ? 'ì „ì²´ íŒ€ì› ì—…ë¬´ ì¡°íšŒ ì¤‘' : 'ë‹¤ë¥¸ íŒ€ì› ì—…ë¬´ ì¡°íšŒ ì¤‘'}</span>` : ''}
          </div>

          <!-- í†µê³„ ì¹´ë“œ -->
          <div id="worklog-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;"></div>

          <!-- ë©”ì¸ ì»¨í…ì¸  -->
          <div id="worklog-main-content">
            <div style="text-align: center; padding: 60px;"><div class="loading-spinner"></div></div>
          </div>
        </div>
      `;

      loadWorkLogData();
    }

    function toggleUnlinkedFilter() {
      unlinkedFilter = !unlinkedFilter;
      renderWorkLog();
    }

    async function loadWorkLogData() {
      const monthInput = document.getElementById('worklog-month');
      if (!monthInput) return;

      workLogMonth = monthInput.value;
      const [year, month] = workLogMonth.split('-').map(Number);
      const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0];
      const endDate = new Date(year, month, 0).toISOString().split('T')[0];
      const currentMember = getCurrentMember();

      try {
        const snapshot = await db.collection('tasks').get();
        const allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        console.log('ğŸ“‹ [ì—…ë¬´ ë¡œë”©] ì „ì²´:', allTasks.length, 'ê±´');
        console.log('ğŸ“‹ [í˜„ì¬ ì‚¬ìš©ì] id:', currentMember.id, 'loginId:', currentMember.loginId, 'name:', currentMember.name);
        console.log('ğŸ“‹ [í•„í„°] ì›”:', workLogMonth, 'ë‹´ë‹¹ì í•„í„°:', memberFilter);

        // ë‚´ ì—…ë¬´ ë§¤ì¹­ í—¬í¼ í•¨ìˆ˜
        const isMyTask = (task) => {
          // ì´ë¦„ ë§¤ì¹­
          if (task.assignee === currentMember.name) return true;
          // ID ë§¤ì¹­ (ì—¬ëŸ¬ ID í˜•ì‹ í™•ì¸)
          if (task.assigneeId === currentMember.id) return true;
          if (task.assigneeId === currentMember.loginId) return true;
          // loginId í•„ë“œ ë§¤ì¹­
          if (task.assigneeLoginId === currentMember.loginId) return true;
          // ë‹´ë‹¹ì ë¯¸ì§€ì • = ë‚´ ì—…ë¬´
          if (!task.assignee && !task.assigneeId) return true;
          return false;
        };

        // ì›”ë³„ + ë‹´ë‹¹ì í•„í„°
        workLogTasks = allTasks.filter(t => {
          // ë‚ ì§œ í•„í„°: dueDate ë˜ëŠ” createdAt ê¸°ì¤€ (ë‚ ì§œ ì—†ìœ¼ë©´ í†µê³¼)
          const taskDate = t.dueDate || (t.createdAt ? t.createdAt.split('T')[0] : null);
          const inMonth = !taskDate || (taskDate >= startDate && taskDate <= endDate);

          // ë‹´ë‹¹ì í•„í„°
          if (memberFilter === 'all') {
            return inMonth; // ì „ì²´ íŒ€: ë‚ ì§œë§Œ í•„í„°
          } else if (memberFilter === 'member' && selectedMemberId) {
            // íŠ¹ì • íŒ€ì› ì„ íƒ
            const selectedMember = (state.teamMembers || []).find(m => m.id === selectedMemberId);
            const isSelectedMember = t.assignee === selectedMember?.name ||
                                     t.assigneeId === selectedMemberId ||
                                     t.assigneeLoginId === selectedMember?.loginId;
            return inMonth && isSelectedMember;
          } else {
            // ë‚´ ì—…ë¬´
            return inMonth && isMyTask(t);
          }
        });

        // ë¯¸ì—°ê²° í•„í„° ì ìš©
        if (unlinkedFilter) {
          workLogTasks = workLogTasks.filter(t => !t.teamKpiId && !t.kpiId);
        }

        console.log('ğŸ“‹ [ê²°ê³¼] í•„í„°ë§ í›„:', workLogTasks.length, 'ê±´');
        if (allTasks.length > 0 && workLogTasks.length === 0) {
          console.log('ğŸ“‹ [ì°¸ê³ ] ì „ì²´ ì—…ë¬´ ìƒ˜í”Œ:', allTasks.slice(0, 3));
        }

        renderWorkLogStats();
        renderLaggingIndicators(allTasks);
        renderWorkLogContent();
      } catch (e) {
        console.error('ì—…ë¬´ì¼ì§€ ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }

    // ì§€í‘œ ì§‘ê³„ ë Œë”ë§
    function renderLaggingIndicators(allTasks) {
      const container = document.getElementById('lagging-stats');
      if (!container) return;

      const teamKPIs = state.teamKPIs || [];
      const completedTasks = allTasks.filter(t => t.status === 'complete');

      // ì„ í–‰ì§€í‘œë³„ ì™„ë£Œ ì—…ë¬´ ì§‘ê³„
      const kpiStats = {};
      let unlinkedCount = 0;

      completedTasks.forEach(task => {
        if (task.teamKpiId) {
          if (!kpiStats[task.teamKpiId]) {
            const kpi = teamKPIs.find(k => k.id === task.teamKpiId);
            kpiStats[task.teamKpiId] = {
              name: kpi?.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
              target: kpi?.target || 0,
              count: 0
            };
          }
          kpiStats[task.teamKpiId].count++;
        } else {
          unlinkedCount++;
        }
      });

      const statsArray = Object.values(kpiStats);

      if (statsArray.length === 0 && unlinkedCount === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 12px 20px; background: rgba(255,255,255,0.15); border-radius: 12px; min-width: 200px;">
            <div style="font-size: 13px; opacity: 0.9;">ì™„ë£Œëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">ì—…ë¬´ë¥¼ ì™„ë£Œí•˜ë©´ ì—¬ê¸°ì— ì§‘ê³„ë©ë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        ${statsArray.map(stat => `
          <div style="text-align: center; padding: 12px 20px; background: rgba(255,255,255,0.15); border-radius: 12px; min-width: 120px;">
            <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;" title="${stat.name}">${stat.name}</div>
            <div style="font-size: 24px; font-weight: 700;">${stat.count}</div>
            <div style="font-size: 10px; opacity: 0.7;">${stat.target > 0 ? `ëª©í‘œ: ${stat.target}` : 'ì‹¤í–‰'}</div>
          </div>
        `).join('')}
        ${unlinkedCount > 0 ? `
          <div style="text-align: center; padding: 12px 20px; background: rgba(255,100,100,0.2); border-radius: 12px; min-width: 100px; cursor: pointer;" onclick="toggleUnlinkedFilter()">
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">ğŸ”— ë¯¸ì—°ê²°</div>
            <div style="font-size: 24px; font-weight: 700;">${unlinkedCount}</div>
            <div style="font-size: 10px; opacity: 0.7;">ì—°ê²° í•„ìš”</div>
          </div>
        ` : ''}
      `;
    }

    function renderWorkLogStats() {
      const statsEl = document.getElementById('worklog-stats');
      const summaryEl = document.getElementById('today-summary');
      if (!statsEl) return;

      const counts = { waiting: 0, progress: 0, complete: 0, hold: 0 };
      workLogTasks.forEach(t => {
        const status = t.status || 'waiting';
        if (counts[status] !== undefined) counts[status]++;
      });

      statsEl.innerHTML = TASK_COLUMNS.map(col => `
        <div style="background: ${col.bg}; border-radius: 12px; padding: 16px; text-align: center;">
          <div style="font-size: 24px; margin-bottom: 8px;">${col.icon}</div>
          <div style="font-size: 28px; font-weight: 700; color: ${col.color};">${counts[col.id]}</div>
          <div style="font-size: 13px; color: #6B7684;">${col.label}</div>
        </div>
      `).join('');

      if (summaryEl) {
        const today = new Date().toISOString().split('T')[0];
        const todayComplete = workLogTasks.filter(t => t.status === 'complete' && t.completedAt?.startsWith(today)).length;
        summaryEl.textContent = `ì˜¤ëŠ˜ ì™„ë£Œ: ${todayComplete}ê±´ | ì§„í–‰ì¤‘: ${counts.progress}ê±´`;
      }
    }

    function renderWorkLogContent() {
      const container = document.getElementById('worklog-main-content');
      if (!container) return;

      if (workLogView === 'kanban') {
        renderKanbanView(container);
      } else {
        renderTimelineView(container);
      }
    }

    function renderKanbanView(container) {
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
          ${TASK_COLUMNS.map(col => {
            const tasks = workLogTasks.filter(t => (t.status || 'waiting') === col.id);
            return `
              <div style="background: ${col.bg}; border-radius: 16px; padding: 16px; min-height: 400px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <div style="font-weight: 700; color: ${col.color};">${col.icon} ${col.label}</div>
                  <span style="background: ${col.color}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${tasks.length}</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  ${tasks.length === 0 ? `
                    <div style="text-align: center; padding: 40px 20px; color: #8B95A1; font-size: 13px;">ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                  ` : tasks.map(task => {
                    const deadline = task.deadline || task.dueDate;
                    let deadlineBadge = '';
                    let cardBorder = '';
                    if (deadline && task.status !== 'complete') {
                      const now = new Date();
                      const deadlineDate = new Date(deadline);
                      const diffDays = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
                      if (diffDays < 0) {
                        deadlineBadge = '<span style="background: #F04452; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">ì´ˆê³¼</span>';
                        cardBorder = 'border-left: 3px solid #F04452;';
                      } else if (diffDays === 0) {
                        deadlineBadge = '<span style="background: #F59E0B; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">ì˜¤ëŠ˜</span>';
                        cardBorder = 'border-left: 3px solid #F59E0B;';
                      } else if (diffDays <= 3) {
                        deadlineBadge = `<span style="background: #F59E0B20; color: #F59E0B; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">D-${diffDays}</span>`;
                        cardBorder = 'border-left: 3px solid #F59E0B;';
                      }
                    }
                    if (task.isSuccess === true) {
                      deadlineBadge = '<span style="background: #00C47120; color: #00C471; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">âœ“ ì„±ê³µ</span>';
                    } else if (task.isSuccess === false) {
                      deadlineBadge = '<span style="background: #F0445220; color: #F04452; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">ê¸°í•œì´ˆê³¼</span>';
                    }

                    const linkedBadge = task.teamKpiId
                      ? `<span style="font-size: 10px; padding: 2px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; color: white;">ğŸ“‹ ${task.teamKpiName || 'ì„ í–‰ì§€í‘œ'}</span>`
                      : `<span style="font-size: 10px; padding: 2px 8px; background: #FEF3C7; border-radius: 4px; color: #92400E;">ğŸ”— ë¯¸ì—°ê²°</span>`;

                    return `
                      <div onclick="openTaskDetailModal('${task.id}')" style="background: white; border-radius: 12px; padding: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.06); ${cardBorder} ${!task.teamKpiId ? 'border-right: 3px solid #F59E0B;' : ''}">
                        <div style="font-weight: 600; color: #191F28; margin-bottom: 8px; font-size: 14px;">${task.title || 'ì œëª© ì—†ìŒ'}</div>
                        ${deadline ? `<div style="font-size: 12px; color: #8B95A1; display: flex; align-items: center;">ğŸ“… ${deadline} ${deadlineBadge}</div>` : ''}
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px;">
                          ${linkedBadge}
                          ${task.category ? `<span style="font-size: 10px; padding: 2px 8px; background: #F2F4F6; border-radius: 4px; color: #6B7684;">${task.category}</span>` : ''}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderTimelineView(container) {
      const sortedTasks = [...workLogTasks].sort((a, b) => (b.dueDate || '').localeCompare(a.dueDate || ''));

      container.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 24px;">
          ${sortedTasks.length === 0 ? `
            <div style="text-align: center; padding: 60px; color: #8B95A1;">ì´ë²ˆ ë‹¬ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          ` : sortedTasks.map(task => {
            const col = TASK_COLUMNS.find(c => c.id === (task.status || 'waiting')) || TASK_COLUMNS[0];
            const linkedBadge = task.teamKpiId
              ? `<span style="font-size: 11px; padding: 2px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; color: white; margin-left: 8px;">ğŸ“‹ ${task.teamKpiName || 'ì„ í–‰ì§€í‘œ'}</span>`
              : `<span style="font-size: 11px; padding: 2px 8px; background: #FEF3C7; border-radius: 4px; color: #92400E; margin-left: 8px;">ğŸ”— ë¯¸ì—°ê²°</span>`;
            return `
              <div onclick="openTaskDetailModal('${task.id}')" style="display: flex; gap: 16px; padding: 16px; border-bottom: 1px solid #E5E8EB; cursor: pointer; ${!task.teamKpiId ? 'background: #FFFBEB;' : ''}">
                <div style="font-size: 20px;">${col.icon}</div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #191F28; display: flex; align-items: center; flex-wrap: wrap;">${task.title || 'ì œëª© ì—†ìŒ'}${linkedBadge}</div>
                  <div style="font-size: 13px; color: #8B95A1; margin-top: 4px;">
                    ${task.dueDate || 'ë‚ ì§œ ë¯¸ì •'} ${task.category ? `Â· ${task.category}` : ''}
                  </div>
                </div>
                <span style="background: ${col.bg}; color: ${col.color}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; height: fit-content;">${col.label}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function setWorkLogView(view) {
      workLogView = view;
      ['kanban', 'timeline'].forEach(v => {
        const btn = document.getElementById('view-' + v);
        if (btn) {
          btn.style.background = view === v ? '#0064FF' : 'transparent';
          btn.style.color = view === v ? 'white' : '#6B7684';
        }
      });
      renderWorkLogContent();
    }

    function setMemberFilter(filter, memberId = null) {
      memberFilter = filter;
      selectedMemberId = memberId;

      // íŒ€ì› ì„ íƒ ë“œë¡­ë‹¤ìš´ ë¦¬ì…‹
      const memberSelect = document.getElementById('member-select');
      if (memberSelect) {
        if (filter === 'member' && memberId) {
          memberSelect.style.background = '#E8F3FF';
        } else {
          memberSelect.value = '';
          memberSelect.style.background = 'white';
        }
      }

      // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      ['all', 'my'].forEach(f => {
        const btn = document.getElementById('filter-' + f);
        if (btn) {
          const isActive = filter === f;
          btn.style.background = isActive ? '#0064FF' : 'transparent';
          btn.style.color = isActive ? 'white' : '#6B7684';
        }
      });

      renderWorkLog(); // ì „ì²´ ì¬ë Œë”ë§ (ì¹´ë“œ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸ ìœ„í•´)
    }

    function getSelectedMemberName() {
      if (!selectedMemberId) return '';
      const member = (state.teamMembers || []).find(m => m.id === selectedMemberId);
      return member?.name || 'íŒ€ì›';
    }

    function changeWorkLogMonth(delta) {
      const input = document.getElementById('worklog-month');
      if (!input) return;

      let [year, month] = input.value.split('-').map(Number);
      month += delta;
      if (month > 12) { month = 1; year++; }
      if (month < 1) { month = 12; year--; }
      input.value = year + '-' + String(month).padStart(2, '0');
      loadWorkLogData();
    }

    function openQuickTaskModal() {
      const today = new Date().toISOString().split('T')[0];
      const currentMember = getCurrentMember();
      const isAdmin = state.currentUser?.role === 'admin';

      // ì„ í–‰ì§€í‘œ ëª©ë¡ (teamKPIs)
      const teamKPIs = state.teamKPIs || [];

      // í”„ë¡œì íŠ¸ë³„ë¡œ ê·¸ë£¹í™”
      const projects = state.projects || [];
      const groupedKPIs = {};
      teamKPIs.forEach(kpi => {
        const project = projects.find(p => p.id === kpi.projectId);
        const projectName = project?.name || 'ë¯¸ë¶„ë¥˜';
        if (!groupedKPIs[projectName]) groupedKPIs[projectName] = [];
        groupedKPIs[projectName].push(kpi);
      });

      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
          <div class="modal-header" style="background: #0064FF; color: white;">
            <h2 class="modal-title" style="color: white;">â• ìƒˆ ì—…ë¬´ ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ì—…ë¬´ ì œëª© *</label>
              <input type="text" id="taskTitle" placeholder="ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
            </div>

            <!-- ì„ í–‰ì§€í‘œ ì—°ê²° -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“‹ ì„ í–‰ì§€í‘œ ì—°ê²°</label>
              <select id="taskTeamKpiId" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
                <option value="">ì—°ê²° ì•ˆí•¨ (ë‚˜ì¤‘ì— ì—°ê²° ê°€ëŠ¥)</option>
                ${Object.entries(groupedKPIs).map(([projectName, kpis]) => `
                  <optgroup label="ğŸ“ ${projectName}">
                    ${kpis.map(k => `<option value="${k.id}">${k.name}</option>`).join('')}
                  </optgroup>
                `).join('')}
              </select>
              <div style="font-size: 11px; color: #8B95A1; margin-top: 4px;">ğŸ’¡ ì§€í‘œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“… ì™„ë£Œ ëª©í‘œ ê¸°í•œ *</label>
                <input type="date" id="taskDeadline" value="${today}" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;" required>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ìƒíƒœ</label>
                <select id="taskStatus" onchange="handleStatusChange()" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
                  <option value="waiting">â³ ëŒ€ê¸°</option>
                  <option value="progress">ğŸ”„ ì§„í–‰ì¤‘</option>
                  <option value="complete">âœ… ì™„ë£Œ</option>
                  <option value="hold">â¸ï¸ ë³´ë¥˜</option>
                </select>
              </div>
            </div>

            <div id="startDateContainer" style="margin-bottom: 16px; display: none;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸš€ ì‹œì‘ì¼ (ìë™ ì„¤ì •)</label>
              <input type="date" id="taskStartDate" value="${today}" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px; background: #F2F4F6;" readonly>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">êµ¬ë¶„</label>
              <input type="text" id="taskCategory" placeholder="ì˜ˆ: ì˜ì—…, ê°œë°œ, ë§ˆì¼€íŒ…" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“ ì‹œí–‰ì°©ì˜¤ / AÂ·B í…ŒìŠ¤íŠ¸ ë©”ëª¨</label>
              <textarea id="taskNotes" rows="3" placeholder="ì—…ë¬´ ì§„í–‰ ì¤‘ ë°°ìš´ ì , ì‹œí–‰ì°©ì˜¤, A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”"
                style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;"></textarea>
            </div>
          </div>
          <div class="modal-footer" style="border-top: 1px solid #E5E8EB; padding: 16px 24px;">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveQuickTask()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    function handleStatusChange() {
      const status = document.getElementById('taskStatus').value;
      const startDateContainer = document.getElementById('startDateContainer');
      const startDateInput = document.getElementById('taskStartDate');

      if (status === 'progress') {
        startDateContainer.style.display = 'block';
        startDateInput.value = new Date().toISOString().split('T')[0];
      } else {
        startDateContainer.style.display = 'none';
      }
    }

    async function saveQuickTask() {
      const title = document.getElementById('taskTitle').value.trim();
      const deadline = document.getElementById('taskDeadline').value;
      const status = document.getElementById('taskStatus').value;
      const category = document.getElementById('taskCategory').value.trim();
      const teamKpiId = document.getElementById('taskTeamKpiId')?.value || '';
      const notes = document.getElementById('taskNotes').value.trim();
      const startDate = document.getElementById('taskStartDate')?.value || '';

      if (!title) { showToast('ì—…ë¬´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
      if (!deadline) { showToast('ì™„ë£Œ ëª©í‘œ ê¸°í•œì„ ì„¤ì •í•˜ì„¸ìš”'); return; }

      const currentMember = getCurrentMember();

      try {
        const taskData = {
          title,
          deadline,
          dueDate: deadline,
          status,
          category,
          notes,
          assignee: currentMember.name,
          assigneeId: currentMember.id,
          createdAt: new Date().toISOString(),
          source: 'strategy-worklog'
        };

        // ì„ í–‰ì§€í‘œ ì—°ê²° (teamKPI â†’ ìë™ìœ¼ë¡œ ë‚´ ì„ í–‰ì§€í‘œì— ì—°ê²°)
        if (teamKpiId) {
          const teamKpi = (state.teamKPIs || []).find(k => k.id === teamKpiId);
          if (teamKpi) {
            taskData.teamKpiId = teamKpiId;
            taskData.teamKpiName = teamKpi.name;
            taskData.projectId = teamKpi.projectId;

            // ë‚´ ì„ í–‰ì§€í‘œ ìë™ ì—°ê²° (ë‹´ë‹¹ì ê¸°ì¤€)
            const myMemberKpi = (state.memberKPIs || []).find(k =>
              k.teamKpiId === teamKpiId &&
              (k.memberId === currentMember.id || k.memberName === currentMember.name)
            );
            if (myMemberKpi) {
              taskData.kpiId = myMemberKpi.id;
              taskData.kpiName = myMemberKpi.name;
            }
          }
        }

        // ì§„í–‰ì¤‘ ìƒíƒœë©´ ì‹œì‘ì¼ ìë™ ì„¤ì •
        if (status === 'progress') {
          taskData.startDate = startDate || new Date().toISOString().split('T')[0];
        }

        // ì™„ë£Œ ìƒíƒœë©´ ì™„ë£Œì¼, ì„±ê³µ/ì‹¤íŒ¨ íŒì •
        if (status === 'complete') {
          const now = new Date();
          const deadlineDate = new Date(deadline);
          taskData.completedAt = now.toISOString();
          taskData.isSuccess = now <= deadlineDate; // ê¸°í•œ ë‚´ ì™„ë£Œ = ì„±ê³µ
        }

        await db.collection('tasks').add(taskData);
        showToast('ì—…ë¬´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        loadWorkLogData();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    function openTaskDetailModal(taskId) {
      const task = workLogTasks.find(t => t.id === taskId);
      if (!task) return;

      const col = TASK_COLUMNS.find(c => c.id === (task.status || 'waiting')) || TASK_COLUMNS[0];
      const currentMember = getCurrentMember();
      const isAdmin = state.currentUser?.role === 'admin';
      const allMembers = state.teamMembers || [];

      // ì„ í–‰ì§€í‘œ ëª©ë¡ (teamKPIs)
      const teamKPIs = state.teamKPIs || [];
      const projects = state.projects || [];
      const groupedKPIs = {};
      teamKPIs.forEach(kpi => {
        const project = projects.find(p => p.id === kpi.projectId);
        const projectName = project?.name || 'ë¯¸ë¶„ë¥˜';
        if (!groupedKPIs[projectName]) groupedKPIs[projectName] = [];
        groupedKPIs[projectName].push(kpi);
      });

      // ë§ˆê°ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
      const deadline = task.deadline || task.dueDate;
      let deadlineInfo = '';
      if (deadline) {
        const now = new Date();
        const deadlineDate = new Date(deadline);
        const diffDays = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) {
          deadlineInfo = `<span style="color: #F04452; font-weight: 600;">${Math.abs(diffDays)}ì¼ ì´ˆê³¼</span>`;
        } else if (diffDays === 0) {
          deadlineInfo = `<span style="color: #F59E0B; font-weight: 600;">ì˜¤ëŠ˜ ë§ˆê°!</span>`;
        } else if (diffDays <= 3) {
          deadlineInfo = `<span style="color: #F59E0B;">D-${diffDays}</span>`;
        } else {
          deadlineInfo = `<span style="color: #00C471;">D-${diffDays}</span>`;
        }
      }

      // ë³€ê²½ íˆìŠ¤í† ë¦¬ ë Œë”ë§
      const history = task.history || [];
      const historyHtml = history.length > 0 ? `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E8EB;">
          <div style="font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
            <span>ğŸ“‹</span> ë³€ê²½ íˆìŠ¤í† ë¦¬ (${history.length})
          </div>
          <div style="max-height: 150px; overflow-y: auto; font-size: 12px;">
            ${history.slice().reverse().map(h => `
              <div style="padding: 8px 10px; background: #F9FAFB; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid ${h.type === 'assignee' ? '#8B5CF6' : '#F59E0B'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #6B7684;">${h.type === 'assignee' ? 'ğŸ‘¤ ë‹´ë‹¹ì ë³€ê²½' : 'ğŸ“… ê¸°í•œ ë³€ê²½'}</span>
                  <span style="color: #8B95A1; font-size: 11px;">${new Date(h.changedAt).toLocaleString('ko-KR')}</span>
                </div>
                <div style="margin-top: 4px; color: #333D4B;">
                  <span style="text-decoration: line-through; color: #8B95A1;">${h.from || 'ì—†ìŒ'}</span>
                  <span style="color: #8B95A1;"> â†’ </span>
                  <span style="font-weight: 600;">${h.to || 'ì—†ìŒ'}</span>
                </div>
                <div style="font-size: 11px; color: #8B95A1; margin-top: 2px;">ë³€ê²½ì: ${h.changedBy || 'ì‹œìŠ¤í…œ'}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : '';

      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
          <div class="modal-header" style="background: ${col.color}; color: white;">
            <h2 class="modal-title" style="color: white;">${col.icon} ${task.title || 'ì—…ë¬´ ìƒì„¸'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; max-height: 70vh; overflow-y: auto;">
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div style="background: #F2F4F6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                <div><span style="color: #6B7684;">ğŸ“… ì™„ë£Œ ê¸°í•œ:</span> <strong>${deadline || 'ë¯¸ì •'}</strong> ${deadlineInfo}</div>
                <div><span style="color: #6B7684;">ğŸ‘¤ ë‹´ë‹¹ì:</span> <strong>${task.assignee || 'ë¯¸ì •'}</strong></div>
                ${task.startDate ? `<div><span style="color: #6B7684;">ğŸš€ ì‹œì‘ì¼:</span> ${task.startDate}</div>` : ''}
                ${task.completedAt ? `<div><span style="color: #6B7684;">âœ… ì™„ë£Œì¼:</span> ${task.completedAt.split('T')[0]}</div>` : ''}
                ${task.category ? `<div><span style="color: #6B7684;">ğŸ·ï¸ êµ¬ë¶„:</span> ${task.category}</div>` : ''}
                ${task.isSuccess !== undefined ? `<div><span style="color: #6B7684;">ğŸ“Š ê²°ê³¼:</span> ${task.isSuccess ? '<span style="color: #00C471; font-weight: 600;">ì„±ê³µ âœ“</span>' : '<span style="color: #F04452; font-weight: 600;">ê¸°í•œ ì´ˆê³¼</span>'}</div>` : ''}
              </div>
            </div>

            <!-- ê´€ë¦¬ì ì „ìš©: ë‹´ë‹¹ì ë°°ì • -->
            ${isAdmin ? `
              <div style="background: linear-gradient(135deg, #8B5CF6, #A78BFA); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">ğŸ‘‘ ê´€ë¦¬ì ì „ìš©</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: white; margin-bottom: 4px;">ğŸ‘¤ ë‹´ë‹¹ì ë°°ì •</label>
                    <select id="editTaskAssignee" style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 14px;">
                      <option value="">ë¯¸ë°°ì •</option>
                      ${allMembers.filter(m => m.role !== 'ceo').map(m => `
                        <option value="${m.id}" ${task.assigneeId === m.id ? 'selected' : ''}>${m.name || m.id}</option>
                      `).join('')}
                    </select>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: white; margin-bottom: 4px;">ğŸ“… ì™„ë£Œê¸°í•œ ìˆ˜ì •</label>
                    <input type="date" id="editTaskDeadline" value="${deadline || ''}"
                      style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 14px;">
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- ì„ í–‰ì§€í‘œ ì—°ê²° ì •ë³´ -->
            ${task.teamKpiId ? `
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; color: white;">
                <span style="font-size: 16px;">ğŸ“‹</span>
                <div>
                  <div style="font-size: 12px; opacity: 0.8;">ì—°ê²°ëœ ì„ í–‰ì§€í‘œ</div>
                  <div style="font-weight: 600;">${task.teamKpiName || teamKPIs.find(k => k.id === task.teamKpiId)?.name || 'ì„ í–‰ì§€í‘œ ì—°ê²°ë¨'}</div>
                </div>
              </div>
            ` : `
              <div style="background: #FEF3C7; border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 16px;">âš ï¸</span>
                <div>
                  <div style="font-size: 12px; color: #92400E;">ë¯¸ì—°ê²° ì—…ë¬´</div>
                  <div style="font-weight: 600; color: #78350F;">ì•„ë˜ì—ì„œ ì„ í–‰ì§€í‘œë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”</div>
                </div>
              </div>
            `}

            <!-- ìƒíƒœ ë³€ê²½ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ìƒíƒœ ë³€ê²½</label>
              <select id="editTaskStatus" onchange="handleDetailStatusChange('${taskId}')" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
                ${TASK_COLUMNS.map(c => `<option value="${c.id}" ${task.status === c.id ? 'selected' : ''}>${c.icon} ${c.label}</option>`).join('')}
              </select>
            </div>

            <!-- ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½ ì‹œ ì‹œì‘ì¼ í‘œì‹œ -->
            <div id="detailStartDateContainer" style="display: ${task.status === 'progress' ? 'block' : 'none'}; margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸš€ ì‹œì‘ì¼</label>
              <input type="date" id="editTaskStartDate" value="${task.startDate || new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px; background: #F2F4F6;">
            </div>

            <!-- ì„ í–‰ì§€í‘œ ì—°ê²° ë³€ê²½ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“‹ ì„ í–‰ì§€í‘œ ì—°ê²°</label>
              <select id="editTaskTeamKpiId" style="width: 100%; padding: 12px; border: 1px solid ${task.teamKpiId ? '#E5E8EB' : '#F59E0B'}; border-radius: 10px; font-size: 15px; ${!task.teamKpiId ? 'background: #FFFBEB;' : ''}">
                <option value="">ì—°ê²° ì•ˆí•¨</option>
                ${Object.entries(groupedKPIs).map(([projectName, kpis]) => `
                  <optgroup label="ğŸ“ ${projectName}">
                    ${kpis.map(k => `<option value="${k.id}" ${task.teamKpiId === k.id ? 'selected' : ''}>${k.name}</option>`).join('')}
                  </optgroup>
                `).join('')}
              </select>
              <div style="font-size: 11px; color: #8B95A1; margin-top: 4px;">ğŸ’¡ ì§€í‘œë¥¼ ì—°ê²°í•˜ë©´ ìë™ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤</div>
            </div>

            <!-- ì‹œí–‰ì°©ì˜¤/ë©”ëª¨ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“ ì‹œí–‰ì°©ì˜¤ / ë©”ëª¨</label>
              <textarea id="editTaskNotes" rows="3" placeholder="ì—…ë¬´ ì§„í–‰ ì¤‘ ë°°ìš´ ì , ì‹œí–‰ì°©ì˜¤ ë“±"
                style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;">${task.notes || ''}</textarea>
            </div>

            <!-- ë³€ê²½ íˆìŠ¤í† ë¦¬ -->
            ${historyHtml}
          </div>
          <div class="modal-footer" style="border-top: 1px solid #E5E8EB; padding: 16px 24px; display: flex; justify-content: space-between;">
            <button onclick="deleteTask('${taskId}')" style="background: #FEE2E4; color: #F04452; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">ì‚­ì œ</button>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
              <button class="btn btn-primary" onclick="updateTaskStatus('${taskId}')">ì €ì¥</button>
            </div>
          </div>
        </div>
      `;
    }

    function handleDetailStatusChange(taskId) {
      const status = document.getElementById('editTaskStatus').value;
      const startDateContainer = document.getElementById('detailStartDateContainer');
      const startDateInput = document.getElementById('editTaskStartDate');

      if (status === 'progress') {
        startDateContainer.style.display = 'block';
        if (!startDateInput.value) {
          startDateInput.value = new Date().toISOString().split('T')[0];
        }
      } else {
        startDateContainer.style.display = 'none';
      }
    }

    async function updateTaskStatus(taskId) {
      const status = document.getElementById('editTaskStatus').value;
      const teamKpiId = document.getElementById('editTaskTeamKpiId')?.value || '';
      const notes = document.getElementById('editTaskNotes')?.value || '';
      const startDate = document.getElementById('editTaskStartDate')?.value || '';

      // ê´€ë¦¬ì ì „ìš© í•„ë“œ
      const newAssigneeId = document.getElementById('editTaskAssignee')?.value || '';
      const newDeadline = document.getElementById('editTaskDeadline')?.value || '';

      const task = workLogTasks.find(t => t.id === taskId);
      if (!task) return;

      const isAdmin = state.currentUser?.role === 'admin';
      const currentUser = state.currentUser;
      const allMembers = state.teamMembers || [];

      try {
        const updateData = {
          status,
          notes,
          updatedAt: new Date().toISOString()
        };

        // ë³€ê²½ íˆìŠ¤í† ë¦¬ ë°°ì—´ ì´ˆê¸°í™”
        const history = task.history || [];

        // ê´€ë¦¬ì ì „ìš©: ë‹´ë‹¹ì ë³€ê²½ ì²˜ë¦¬
        if (isAdmin && newAssigneeId !== undefined) {
          const oldAssigneeId = task.assigneeId || '';
          if (newAssigneeId !== oldAssigneeId) {
            const oldMember = allMembers.find(m => m.id === oldAssigneeId);
            const newMember = allMembers.find(m => m.id === newAssigneeId);

            // íˆìŠ¤í† ë¦¬ ê¸°ë¡
            history.push({
              type: 'assignee',
              from: oldMember?.name || task.assignee || 'ë¯¸ë°°ì •',
              to: newMember?.name || 'ë¯¸ë°°ì •',
              changedBy: currentUser?.name || currentUser?.loginId || 'ê´€ë¦¬ì',
              changedAt: new Date().toISOString()
            });

            // ë‹´ë‹¹ì ì •ë³´ ì—…ë°ì´íŠ¸
            if (newAssigneeId) {
              updateData.assigneeId = newAssigneeId;
              updateData.assignee = newMember?.name || '';
              updateData.assigneeLoginId = newMember?.loginId || '';
            } else {
              updateData.assigneeId = null;
              updateData.assignee = null;
              updateData.assigneeLoginId = null;
            }
          }
        }

        // ê´€ë¦¬ì ì „ìš©: ì™„ë£Œê¸°í•œ ë³€ê²½ ì²˜ë¦¬
        if (isAdmin && newDeadline !== undefined) {
          const oldDeadline = task.deadline || task.dueDate || '';
          if (newDeadline !== oldDeadline) {
            // íˆìŠ¤í† ë¦¬ ê¸°ë¡
            history.push({
              type: 'deadline',
              from: oldDeadline || 'ë¯¸ì •',
              to: newDeadline || 'ë¯¸ì •',
              changedBy: currentUser?.name || currentUser?.loginId || 'ê´€ë¦¬ì',
              changedAt: new Date().toISOString()
            });

            // ê¸°í•œ ì—…ë°ì´íŠ¸
            updateData.deadline = newDeadline || null;
            updateData.dueDate = newDeadline || null;
          }
        }

        // íˆìŠ¤í† ë¦¬ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì €ì¥
        if (history.length > (task.history?.length || 0)) {
          updateData.history = history;
        }

        // ì„ í–‰ì§€í‘œ ì—°ê²° ì—…ë°ì´íŠ¸
        const currentMember = getCurrentMember();
        if (teamKpiId) {
          const teamKpi = (state.teamKPIs || []).find(k => k.id === teamKpiId);
          if (teamKpi) {
            updateData.teamKpiId = teamKpiId;
            updateData.teamKpiName = teamKpi.name;
            updateData.projectId = teamKpi.projectId;

            // ë‚´ ì„ í–‰ì§€í‘œ ìë™ ì—°ê²° (ë‹´ë‹¹ì ê¸°ì¤€)
            const myMemberKpi = (state.memberKPIs || []).find(k =>
              k.teamKpiId === teamKpiId &&
              (k.memberId === currentMember.id || k.memberName === currentMember.name)
            );
            if (myMemberKpi) {
              updateData.kpiId = myMemberKpi.id;
              updateData.kpiName = myMemberKpi.name;
            }
          }
        } else {
          updateData.teamKpiId = null;
          updateData.teamKpiName = null;
          updateData.kpiId = null;
          updateData.kpiName = null;
        }

        // ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½ ì‹œ ì‹œì‘ì¼ ìë™ ì„¤ì •
        if (status === 'progress' && task.status !== 'progress') {
          updateData.startDate = startDate || new Date().toISOString().split('T')[0];
        }

        // ì™„ë£Œ ì‹œ ì™„ë£Œì¼ ë° ì„±ê³µ/ì‹¤íŒ¨ íŒì •
        if (status === 'complete' && task.status !== 'complete') {
          const now = new Date();
          const deadline = task.deadline || task.dueDate;
          updateData.completedAt = now.toISOString();

          if (deadline) {
            const deadlineDate = new Date(deadline);
            updateData.isSuccess = now <= deadlineDate;
          } else {
            updateData.isSuccess = true; // ë§ˆê°ì¼ ì—†ìœ¼ë©´ ì„±ê³µìœ¼ë¡œ
          }

          // ë‚´ ì„ í–‰ì§€í‘œ ìë™ ì—…ë°ì´íŠ¸ (ì—°ê²°ëœ ê²½ìš°, ì„±ê³µ ì‹œì—ë§Œ)
          if (updateData.kpiId && updateData.isSuccess) {
            const kpi = (state.memberKPIs || []).find(k => k.id === updateData.kpiId);
            if (kpi) {
              await db.collection('memberKPIs').doc(updateData.kpiId).update({
                current: (kpi.current || 0) + 1,
                updatedAt: new Date().toISOString()
              });
            }
          }
        }

        await db.collection('tasks').doc(taskId).update(updateData);

        const statusMsg = status === 'complete'
          ? (updateData.isSuccess ? 'ì—…ë¬´ ì™„ë£Œ! ğŸ‰ (ê¸°í•œ ë‚´ ì„±ê³µ)' : 'ì—…ë¬´ ì™„ë£Œ (ê¸°í•œ ì´ˆê³¼)')
          : 'ì—…ë¬´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤';
        showToast(statusMsg);
        closeModal();
        loadWorkLogData();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteTask(taskId) {
      if (!confirm('ì´ ì—…ë¬´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        await db.collection('tasks').doc(taskId).delete();
        showToast('ì—…ë¬´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        loadWorkLogData();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // [DEPRECATED] ì „ëµê¸°íš í—¬í¼ í•¨ìˆ˜ - ë¯¸ì‚¬ìš©
    // ========================================
    function toggleEditMode(section) {
      if (section === 'essence') {
        const el = document.getElementById('essenceGoal');
        if (!el) return;
        if (el.querySelector('textarea')) {
          // ì €ì¥ ëª¨ë“œ
          const textarea = el.querySelector('textarea');
          const value = textarea.value.trim();
          el.innerHTML = value;
          db.collection('settings').doc('strategy').set({ essenceGoal: value }, { merge: true })
            .then(() => showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤'))
            .catch(e => showToast('ì €ì¥ ì‹¤íŒ¨'));
        } else {
          // í¸ì§‘ ëª¨ë“œ
          const currentValue = el.textContent.trim();
          el.innerHTML = `<textarea style="width: 100%; min-height: 80px; font-size: inherit; font-weight: inherit; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; color: white; resize: vertical;">${currentValue}</textarea>`;
          el.querySelector('textarea').focus();
        }
      } else if (section === 'allocation') {
        showToast('ì„±ì¥/ì˜ì—… ë¹„ìœ¨ì€ ìˆ«ìë¥¼ í´ë¦­í•˜ì—¬ í¸ì§‘í•˜ì„¸ìš”');
      }
    }

    function openDomainStrategyModal() {
      const strategy = state.strategyData || {};
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">ğŸ§­ 4ì¶• ë„ë©”ì¸ ì „ëµ í¸ì§‘</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div style="padding: 20px; display: grid; gap: 16px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ‡°ğŸ‡· êµ­ë‚´ ê³µê¸‰ì‚¬</label>
              <textarea id="domainDomestic" class="form-input" rows="2" placeholder="êµ­ë‚´ ê³µê¸‰ì‚¬ ì „ëµ">${strategy.domesticStrategy || 'êµ­ë‚´ ìš°ìˆ˜ ë¸Œëœë“œ ë°œêµ´ ë° ë…ì  ê³„ì•½'}</textarea>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">âœˆï¸ í•´ì™¸ ì§ìˆ˜ì…</label>
              <textarea id="domainImport" class="form-input" rows="2" placeholder="í•´ì™¸ ì§ìˆ˜ì… ì „ëµ">${strategy.importStrategy || 'ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ìƒí’ˆ ì„ ì œ í™•ë³´'}</textarea>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸŒ í•´ì™¸ ìˆ˜ì¶œ</label>
              <textarea id="domainExport" class="form-input" rows="2" placeholder="í•´ì™¸ ìˆ˜ì¶œ ì „ëµ">${strategy.exportStrategy || 'K-ë¸Œëœë“œ ê¸€ë¡œë²Œ ì§„ì¶œ ì§€ì›'}</textarea>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ¥• ë‹¹ê·¼ Ã— ëª¨ì—¬ë¼ë”œ</label>
              <textarea id="domainPlatform" class="form-input" rows="2" placeholder="í”Œë«í¼ ì „ëµ">${strategy.platformStrategy || 'ì§€ì—­ ê¸°ë°˜ ê³µë™êµ¬ë§¤ í™œì„±í™”'}</textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveDomainStrategy()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveDomainStrategy() {
      try {
        await db.collection('settings').doc('strategy').set({
          domesticStrategy: document.getElementById('domainDomestic').value.trim(),
          importStrategy: document.getElementById('domainImport').value.trim(),
          exportStrategy: document.getElementById('domainExport').value.trim(),
          platformStrategy: document.getElementById('domainPlatform').value.trim()
        }, { merge: true });
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderStrategicPlanning();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    function formatDateKR(dateString) {
      if (!dateString) return 'ë‚ ì§œ ì—†ìŒ';
      try {
        const d = new Date(dateString);
        return d.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
      } catch (e) {
        return dateString;
      }
    }

    async function activateVersion(versionId) {
      if (!confirm('ì´ ë²„ì „ì„ í˜„ì¬ ë²„ì „ìœ¼ë¡œ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const versions = state.strategyVersions || [];
        versions.forEach(v => {
          v.status = v.id === versionId ? 'active' : 'archived';
        });
        await db.collection('settings').doc('strategyVersions').set({ versions });
        state.strategyVersions = versions;

        // í•´ë‹¹ ë²„ì „ì˜ ë°ì´í„° ë³µì›
        const activeVersion = versions.find(v => v.id === versionId);
        if (activeVersion?.data) {
          await db.collection('settings').doc('strategy').set(activeVersion.data, { merge: true });
          state.strategyData = { ...state.strategyData, ...activeVersion.data };
        }

        closeModal();
        renderStrategicPlanning();
        showToast('ë²„ì „ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error(e);
        showToast('ë²„ì „ ì ìš© ì‹¤íŒ¨');
      }
    }

    function viewVersionDetail(versionId) {
      const versions = state.strategyVersions || [];
      const version = versions.find(v => v.id === versionId);
      if (!version) return;

      const data = version.data || {};
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">ğŸ“‹ ë²„ì „ ìƒì„¸: ${version.name}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom: 20px;">
              <div style="font-size: 13px; color: var(--gray-500);">ìƒì„±ì¼</div>
              <div style="font-weight: 600; color: var(--gray-900);">${formatDateKR(version.createdAt)}</div>
            </div>
            ${version.reason ? `
              <div style="margin-bottom: 20px;">
                <div style="font-size: 13px; color: var(--gray-500);">ë³€ê²½ ì‚¬ìœ </div>
                <div style="color: var(--gray-700);">${version.reason}</div>
              </div>
            ` : ''}
            <div style="background: var(--gray-50); border-radius: 12px; padding: 16px;">
              <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">ğŸ“Š ì €ì¥ëœ ì„¤ì •</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                <div>ì—°ë§¤ì¶œ ëª©í‘œ: <strong>${((data.annualRevenue || 0) / 100000000).toFixed(1)}ì–µ</strong></div>
                <div>ìˆœìµ ëª©í‘œ: <strong>${((data.annualProfit || 0) / 10000).toLocaleString()}ë§Œ</strong></div>
                <div>ì„±ê³µë¥  ëª©í‘œ: <strong>${data.successRate || 0}%</strong></div>
                <div>ì„±ì¥/ì˜ì—…: <strong>${data.growthRatio || 90}:${100 - (data.growthRatio || 90)}</strong></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="openVersionHistoryModal()">â† ë’¤ë¡œ</button>
            ${version.status !== 'active' ? `<button class="btn btn-primary" onclick="activateVersion('${versionId}')">ì´ ë²„ì „ ì ìš©</button>` : ''}
          </div>
        </div>
      `;
    }

    // ========================================
    // ì—°ë„ë³„ ëª©í‘œ ê´€ë¦¬ ì‹œìŠ¤í…œ
    // ========================================
    function renderYearlyGoalsDashboard() {
      const goals = state.yearlyGoals || [];
      const currentYear = new Date().getFullYear();
      const isAdmin = state.currentUser?.role === 'admin';

      // ì—°ë„ë³„ ëª©í‘œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ìƒì„± ì•ˆë‚´
      const displayYears = [2026, 2027, 2028];

      // ê° ì—°ë„ë³„ ë°ì´í„° ì¤€ë¹„
      const yearData = displayYears.map(year => {
        const goal = goals.find(g => g.year === year) || {
          year,
          revenueTarget: year === 2026 ? 1000000000 : year === 2027 ? 3000000000 : 6000000000,
          salesRatio: 70,
          growthRatio: 30,
          achieved: 0
        };

        // í•´ë‹¹ ì—°ë„ ë‹¬ì„±ì•¡ ê³„ì‚° (ì •ì‚° ë°ì´í„° ê¸°ë°˜)
        const yearStr = String(year);
        const yearSettlements = (state.sellerSettlements || []).filter(s =>
          (s.settlementDate || s.createdAt || '').startsWith(yearStr)
        );
        const achieved = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
        goal.achieved = achieved;

        return goal;
      });

      // ìµœì¢… ëª©í‘œ (2028ë…„ 100ì–µ)
      const finalGoal = 10000000000;
      const totalAchieved = yearData.reduce((sum, y) => sum + (y.achieved || 0), 0);
      const totalTarget = yearData.reduce((sum, y) => sum + (y.revenueTarget || 0), 0);

      return `
        <div style="background: linear-gradient(135deg, #1e3a5f, #0f2744); border-radius: 16px; padding: 24px; margin-bottom: 20px; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px;">ğŸ¯ ë³¸ì§ˆì˜ ëª©í‘œ</div>
              <div style="font-size: 22px; font-weight: 700;">2028ë…„ê¹Œì§€ 100ì–µ ë‹¬ì„±</div>
            </div>
            ${isAdmin ? `<button onclick="openYearlyGoalModal()" style="padding: 10px 18px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">âš™ï¸ ëª©í‘œ ì„¤ì •</button>` : ''}
          </div>

          <!-- ì—°ë„ë³„ ëª©í‘œ ì¹´ë“œ -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
            ${yearData.map(goal => {
              const progress = goal.revenueTarget > 0 ? Math.min(100, Math.round((goal.achieved / goal.revenueTarget) * 100)) : 0;
              const isCurrentYear = goal.year === currentYear;
              return `
                <div style="background: ${isCurrentYear ? 'rgba(255,255,255,0.15)' : 'rgba(255,255,255,0.08)'}; border-radius: 12px; padding: 16px; ${isCurrentYear ? 'border: 2px solid rgba(255,255,255,0.4);' : ''}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 18px; font-weight: 700;">${goal.year}ë…„</div>
                    ${isCurrentYear ? '<span style="font-size: 10px; background: #00C471; padding: 2px 8px; border-radius: 10px;">í˜„ì¬</span>' : ''}
                  </div>
                  <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">${(goal.revenueTarget / 100000000).toFixed(0)}ì–µ</div>
                  <div style="font-size: 11px; opacity: 0.7; margin-bottom: 12px;">
                    ì˜ì—… ${goal.salesRatio || 70}% Â· ì„±ì¥ ${goal.growthRatio || 30}%
                  </div>
                  <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: ${progress >= 70 ? '#00C471' : progress >= 40 ? '#F59E0B' : '#F04452'}; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                    <span>ë‹¬ì„± ${(goal.achieved / 100000000).toFixed(1)}ì–µ</span>
                    <span style="font-weight: 600;">${progress}%</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <!-- ìµœì¢… ëª©í‘œ ì§„í–‰ë¥  -->
          <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-size: 14px;">ğŸ† ìµœì¢… ëª©í‘œ ì§„í–‰ë¥ </span>
              <span style="font-size: 14px; font-weight: 700;">${(totalAchieved / 100000000).toFixed(1)}ì–µ / 100ì–µ</span>
            </div>
            <div style="background: rgba(255,255,255,0.2); height: 12px; border-radius: 6px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #00C471, #10B981); height: 100%; width: ${Math.min(100, (totalAchieved / finalGoal) * 100)}%; border-radius: 6px;"></div>
            </div>
          </div>
        </div>
      `;
    }

    function openYearlyGoalModal() {
      const goals = state.yearlyGoals || [];
      const displayYears = [2025, 2026, 2027, 2028, 2029, 2030];

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #1e3a5f, #0f2744); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ¯ ì—°ë„ë³„ ëª©í‘œ ì„¤ì •</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; max-height: 70vh; overflow-y: auto;">
            <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
              <div style="font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ğŸ“Œ ë³¸ì§ˆ ëª©í‘œ</div>
              <div style="font-size: 13px; color: var(--gray-600);">2028ë…„ê¹Œì§€ 100ì–µ ë‹¬ì„± Â· ì´í›„ 150ì–µ ëª©í‘œ ê²€í† </div>
            </div>

            <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">ì—°ë„ë³„ ëª©í‘œì•¡ ë° ë¹„ìœ¨ ì„¤ì •</div>
            <div style="display: grid; gap: 16px;">
              ${displayYears.map(year => {
                const existing = goals.find(g => g.year === year) || {};
                const defaultTarget = year === 2026 ? 10 : year === 2027 ? 30 : year === 2028 ? 60 : 0;
                return `
                  <div style="background: var(--gray-50); border-radius: 12px; padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                      <div style="font-size: 16px; font-weight: 700; color: var(--gray-900); min-width: 60px;">${year}ë…„</div>
                      <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="goal-${year}-revenue" value="${existing.revenueTarget ? existing.revenueTarget / 100000000 : defaultTarget}"
                          style="width: 80px; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                        <span style="font-size: 14px; color: var(--gray-600);">ì–µì›</span>
                      </div>
                    </div>
                    <div style="display: flex; gap: 16px;">
                      <div style="flex: 1;">
                        <label style="display: block; font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ğŸ’° ì˜ì—… ë¹„ìœ¨ (%)</label>
                        <input type="number" id="goal-${year}-sales" value="${existing.salesRatio || 70}" min="0" max="100"
                          style="width: 100%; padding: 8px; border: 1px solid var(--gray-300); border-radius: 6px;"
                          onchange="document.getElementById('goal-${year}-growth').value = 100 - this.value">
                      </div>
                      <div style="flex: 1;">
                        <label style="display: block; font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ğŸŒ± ì„±ì¥ ë¹„ìœ¨ (%)</label>
                        <input type="number" id="goal-${year}-growth" value="${existing.growthRatio || 30}" min="0" max="100"
                          style="width: 100%; padding: 8px; border: 1px solid var(--gray-300); border-radius: 6px;"
                          onchange="document.getElementById('goal-${year}-sales').value = 100 - this.value">
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveYearlyGoals()">ğŸ’¾ ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveYearlyGoals() {
      const displayYears = [2025, 2026, 2027, 2028, 2029, 2030];

      try {
        for (const year of displayYears) {
          const revenueEl = document.getElementById(`goal-${year}-revenue`);
          const salesEl = document.getElementById(`goal-${year}-sales`);
          const growthEl = document.getElementById(`goal-${year}-growth`);

          if (!revenueEl) continue;

          const revenue = parseFloat(revenueEl.value) || 0;
          if (revenue <= 0) continue;

          const goalData = {
            year,
            revenueTarget: revenue * 100000000,
            salesRatio: parseInt(salesEl?.value) || 70,
            growthRatio: parseInt(growthEl?.value) || 30,
            updatedAt: new Date().toISOString()
          };

          // ê¸°ì¡´ ë¬¸ì„œ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒˆë¡œ ìƒì„±
          const existing = (state.yearlyGoals || []).find(g => g.year === year);
          if (existing?.id) {
            await db.collection('yearlyGoals').doc(existing.id).update(goalData);
          } else {
            goalData.createdAt = new Date().toISOString();
            await db.collection('yearlyGoals').add(goalData);
          }
        }

        showToast('ì—°ë„ë³„ ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error('ì—°ë„ë³„ ëª©í‘œ ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ========================================
    // KPI ëª©í‘œ ë‹¨ìœ„ íƒ€ì… í—¬í¼ í•¨ìˆ˜
    // ========================================
    const KPI_UNIT_TYPES = {
      revenue: { label: 'ë§¤ì¶œì•¡', unit: 'ì–µ', suffix: 'ì–µ' },
      percent: { label: 'í¼ì„¼íŠ¸', unit: '%', suffix: '%' },
      count: { label: 'ê°œìˆ˜', unit: 'ê°œ', suffix: 'ê°œ' },
      case: { label: 'ê±´ìˆ˜', unit: 'ê±´', suffix: 'ê±´' },
      won: { label: 'ê¸ˆì•¡', unit: 'ë§Œì›', suffix: 'ë§Œì›' }
    };

    function getTargetUnitInfo(unitType) {
      return KPI_UNIT_TYPES[unitType] || KPI_UNIT_TYPES.revenue;
    }

    function formatTargetValue(value, unitType) {
      const info = getTargetUnitInfo(unitType);
      if (value === null || value === undefined || value === 0) return '-';
      if (unitType === 'percent') return `${value}%`;
      return `${value}${info.suffix}`;
    }

    function updateMegaProjectTargetLabel() {
      const unitType = document.getElementById('megaProjectUnitType')?.value || 'revenue';
      const info = getTargetUnitInfo(unitType);
      const label = document.getElementById('megaProjectTargetLabel');
      if (label) {
        label.textContent = `ëª©í‘œê°’ (${info.unit})`;
      }
    }

    function updateProjectTargetLabel() {
      const unitType = document.getElementById('projectUnitTypeV2')?.value || 'revenue';
      const info = getTargetUnitInfo(unitType);
      const label = document.getElementById('projectTargetLabelV2');
      if (label) {
        label.textContent = `ëª©í‘œê°’ (${info.unit})`;
      }
    }

    function updateTeamKpiUnitDisplay() {
      const unit = document.getElementById('teamKpiUnit')?.value || 'ê±´';
      const unitDisplays = document.querySelectorAll('.member-unit-display');
      unitDisplays.forEach(el => {
        el.textContent = unit;
      });
    }

    // ========================================
    // ì‹œí¬ë¦¿ ë§í¬ ê´€ë¦¬ (ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ ê³µìœ )
    // ========================================
    async function loadSecretLinks() {
      try {
        const snapshot = await db.collection('growthboardShareLinks').orderBy('createdAt', 'desc').get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (e) {
        console.error('ì‹œí¬ë¦¿ ë§í¬ ë¡œë“œ ì˜¤ë¥˜:', e);
        return [];
      }
    }

    function generateSecretToken() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
      let token = '';
      for (let i = 0; i < 24; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return token;
    }

    // í˜„ì¬ OKR ìƒíƒœë¥¼ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ìƒì„±
    function createOkrSnapshot() {
      return {
        objective: okrState.objective ? { ...okrState.objective } : null,
        keyResults: okrState.keyResults.map(kr => ({ ...kr })),
        kpis: okrState.kpis.map(kpi => ({ ...kpi })),
        laggingIndicators: okrState.laggingIndicators.map(lag => ({ ...lag })),
        dailyLogs: okrState.dailyLogs.map(log => ({ ...log })),
        personalTargets: okrState.personalTargets.map(pt => ({ ...pt })),  // ê°œì¸ ëª©í‘œ ì¶”ê°€
        snapshotCreatedAt: new Date().toISOString()
      };
    }

    async function openSecretLinkModal() {
      const links = await loadSecretLinks();
      const baseUrl = window.location.origin + '/admin/strategy/growthboard-share.html';

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 650px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ”— ê·¸ë¡œìŠ¤ë³´ë“œ ê³µìœ  ë§í¬</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="background: #EFF6FF; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
              <div style="font-size: 14px; font-weight: 600; color: #1E40AF; margin-bottom: 8px;">ğŸ“‹ ê³µìœ  ë§í¬ë€?</div>
              <div style="font-size: 13px; color: #3B82F6; line-height: 1.6;">
                â€¢ ë§í¬ë¥¼ ì•„ëŠ” ì‚¬ëŒë§Œ ê·¸ë¡œìŠ¤ë³´ë“œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                â€¢ ì½ê¸° ì „ìš©ìœ¼ë¡œ ìˆ˜ì •/í¸ì§‘ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤<br>
                â€¢ ë§í¬ ìƒì„± ì‹œì ì˜ <b>ìŠ¤ëƒ…ìƒ· ë°ì´í„°</b>ê°€ ì €ì¥ë©ë‹ˆë‹¤<br>
                â€¢ ê¸°ì—…/íˆ¬ìì ê³µìœ ìš© ê²½ì˜ ëŒ€ì‹œë³´ë“œë¡œ í™œìš©í•˜ì„¸ìš”
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 14px; font-weight: 600; color: var(--gray-700);">í™œì„± ë§í¬ ëª©ë¡</div>
              <button onclick="createSecretLink()" style="padding: 8px 16px; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                + ìƒˆ ë§í¬ ìƒì„±
              </button>
            </div>

            <div id="secretLinkList" style="max-height: 300px; overflow-y: auto;">
              ${links.length === 0 ? `
                <div style="text-align: center; padding: 40px 20px; color: var(--gray-500);">
                  <div style="font-size: 40px; margin-bottom: 12px;">ğŸ“¸</div>
                  <div>ìƒì„±ëœ ê³µìœ  ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                  <div style="font-size: 12px; margin-top: 4px;">ìƒˆ ë§í¬ë¥¼ ìƒì„±í•˜ì—¬ í˜„ì¬ ë°ì´í„°ë¥¼ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì €ì¥í•˜ì„¸ìš”</div>
                </div>
              ` : links.map(link => {
                const snapshotDate = link.lastUpdatedAt || link.createdAt;
                const snapshotDateStr = new Date(snapshotDate).toLocaleDateString('ko-KR') + ' ' + new Date(snapshotDate).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                return `
                <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--gray-200);">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                      <div style="font-size: 14px; font-weight: 600; color: var(--gray-900);">${link.name || 'ì´ë¦„ ì—†ìŒ'}</div>
                      <div style="font-size: 11px; color: var(--gray-500); margin-top: 2px;">
                        ğŸ“¸ ìŠ¤ëƒ…ìƒ·: ${snapshotDateStr}
                        ${link.viewCount > 0 ? `&nbsp;Â·&nbsp;ğŸ‘ï¸ ${link.viewCount}íšŒ ì¡°íšŒ` : ''}
                      </div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                      <span style="padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; ${link.isActive ? 'background: #D1FAE5; color: #059669;' : 'background: #FEE2E2; color: #DC2626;'}">
                        ${link.isActive ? 'í™œì„±' : 'ë¹„í™œì„±'}
                      </span>
                    </div>
                  </div>
                  <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 8px;">
                    <input type="text" value="${baseUrl}?token=${link.token}" readonly
                      style="flex: 1; border: none; font-size: 12px; color: var(--gray-600); background: transparent; outline: none;"
                      id="link-${link.id}">
                    <button onclick="copySecretLink('${link.id}')" style="padding: 6px 12px; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">
                      ğŸ“‹ ë³µì‚¬
                    </button>
                  </div>
                  <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px;">
                    <button onclick="refreshSnapshotLink('${link.id}')" style="padding: 6px 12px; background: #DBEAFE; color: #1D4ED8; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;">
                      ğŸ”„ ìŠ¤ëƒ…ìƒ· ê°±ì‹ 
                    </button>
                    <button onclick="toggleSecretLink('${link.id}', ${!link.isActive})" style="padding: 6px 12px; background: ${link.isActive ? '#FEF3C7' : '#D1FAE5'}; color: ${link.isActive ? '#92400E' : '#059669'}; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;">
                      ${link.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}
                    </button>
                    <button onclick="deleteSecretLink('${link.id}')" style="padding: 6px 12px; background: #FEE2E2; color: #DC2626; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;">
                      ì‚­ì œ
                    </button>
                  </div>
                </div>
              `}).join('')}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          </div>
        </div>
      `;
    }

    async function createSecretLink() {
      const name = prompt('ë§í¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: íˆ¬ìì ê³µìœ ìš©, íŒŒíŠ¸ë„ˆì‚¬ ê³µìœ )');
      if (!name) return;

      // ëª©í‘œê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
      if (!okrState.objective) {
        showToast('ëª©í‘œë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');
        return;
      }

      const token = generateSecretToken();

      try {
        await db.collection('growthboardShareLinks').add({
          name,
          token,
          objectiveId: okrState.objective.id,  // ëª©í‘œ ID ì €ì¥ (ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™ìš©)
          isActive: true,
          createdAt: new Date().toISOString(),
          viewCount: 0
        });
        showToast('ê³µìœ  ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™)');
        openSecretLinkModal(); // ìƒˆë¡œê³ ì¹¨
      } catch (e) {
        console.error(e);
        showToast('ë§í¬ ìƒì„± ì‹¤íŒ¨');
      }
    }

    function copySecretLink(linkId) {
      const input = document.getElementById(`link-${linkId}`);
      if (input) {
        input.select();
        document.execCommand('copy');
        showToast('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    async function toggleSecretLink(linkId, isActive) {
      try {
        await db.collection('growthboardShareLinks').doc(linkId).update({ isActive });
        showToast(isActive ? 'ë§í¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ë§í¬ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
        openSecretLinkModal();
      } catch (e) {
        console.error(e);
        showToast('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
      }
    }

    async function deleteSecretLink(linkId) {
      if (!confirm('ì´ ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ì´ ë§í¬ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

      try {
        await db.collection('growthboardShareLinks').doc(linkId).delete();
        showToast('ë§í¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        openSecretLinkModal();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ìŠ¤ëƒ…ìƒ· ê°±ì‹  ê¸°ëŠ¥
    async function refreshSnapshotLink(linkId) {
      if (!confirm('ì´ ë§í¬ì˜ ìŠ¤ëƒ…ìƒ·ì„ í˜„ì¬ ë°ì´í„°ë¡œ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ìŠ¤ëƒ…ìƒ·ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return;

      if (!okrState.objective) {
        showToast('ëª©í‘œë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');
        return;
      }

      const snapshotData = createOkrSnapshot();

      try {
        await db.collection('growthboardShareLinks').doc(linkId).update({
          snapshotData: snapshotData,
          lastUpdatedAt: new Date().toISOString()
        });
        showToast('ìŠ¤ëƒ…ìƒ·ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤');
        openSecretLinkModal();
      } catch (e) {
        console.error(e);
        showToast('ìŠ¤ëƒ…ìƒ· ê°±ì‹  ì‹¤íŒ¨');
      }
    }

    // ========================================
    // ë©”ì¸ KPI â†’ ì„œë¸Œ KPI ê³„ì¸µ êµ¬ì¡°
    // ========================================
    function openMegaProjectModal(megaProject = null) {
      const isEdit = !!megaProject;
      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white;">
            <h2 class="modal-title" style="color: white;">${isEdit ? 'ğŸ¯ íŒ€ KPI ìˆ˜ì •' : 'ğŸ¯ íŒ€ KPI ì¶”ê°€'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="megaProjectId" value="${megaProject?.id || ''}">

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">í”„ë¡œì íŠ¸ëª… *</label>
              <input type="text" id="megaProjectName" value="${megaProject?.name || ''}" placeholder="ì˜ˆ: í•´ì™¸ ìˆ˜ì¶œ (K-ë¸Œëœë“œ í™•ì¥)"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì„¤ëª…</label>
              <textarea id="megaProjectDesc" rows="2" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª…"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">${megaProject?.description || ''}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œ ë‹¨ìœ„</label>
                <select id="megaProjectUnitType" onchange="updateMegaProjectTargetLabel()" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
                  <option value="revenue" ${!megaProject?.targetUnitType || megaProject?.targetUnitType === 'revenue' ? 'selected' : ''}>ë§¤ì¶œì•¡ (ì–µì›)</option>
                  <option value="percent" ${megaProject?.targetUnitType === 'percent' ? 'selected' : ''}>í¼ì„¼íŠ¸ (%)</option>
                  <option value="count" ${megaProject?.targetUnitType === 'count' ? 'selected' : ''}>ê°œìˆ˜ (ê°œ)</option>
                  <option value="case" ${megaProject?.targetUnitType === 'case' ? 'selected' : ''}>ê±´ìˆ˜ (ê±´)</option>
                  <option value="won" ${megaProject?.targetUnitType === 'won' ? 'selected' : ''}>ê¸ˆì•¡ (ë§Œì›)</option>
                </select>
              </div>
              <div>
                <label id="megaProjectTargetLabel" style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œê°’</label>
                <input type="number" id="megaProjectTargetValue" value="${megaProject?.targetUnitType && megaProject.targetUnitType !== 'revenue' ? (megaProject.targetValue || '') : (megaProject?.revenueTarget ? megaProject.revenueTarget / 100000000 : '')}" placeholder="ëª©í‘œê°’ ì…ë ¥"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">â­ ìš°ì„ ìˆœìœ„</label>
                <select id="megaProjectPriority" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
                  <option value="">ë¯¸ì„¤ì •</option>
                  <option value="1" ${megaProject?.priority === 1 ? 'selected' : ''}>1ìˆœìœ„ â­â­â­</option>
                  <option value="2" ${megaProject?.priority === 2 ? 'selected' : ''}>2ìˆœìœ„ â­â­</option>
                  <option value="3" ${megaProject?.priority === 3 ? 'selected' : ''}>3ìˆœìœ„ â­</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì—°ê²° ì—°ë„</label>
                <select id="megaProjectYear" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
                  <option value="">ì„ íƒ</option>
                  ${[2025, 2026, 2027, 2028, 2029, 2030].map(y => `<option value="${y}" ${megaProject?.year === y ? 'selected' : ''}>${y}ë…„</option>`).join('')}
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ìƒíƒœ</label>
                <select id="megaProjectStatus" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
                  <option value="active" ${megaProject?.status === 'active' || !megaProject ? 'selected' : ''}>ì§„í–‰ì¤‘</option>
                  <option value="completed" ${megaProject?.status === 'completed' ? 'selected' : ''}>ì™„ë£Œ</option>
                  <option value="paused" ${megaProject?.status === 'paused' ? 'selected' : ''}>ë³´ë¥˜</option>
                </select>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì‹œì‘ì¼</label>
                <input type="date" id="megaProjectStart" value="${megaProject?.startDate || ''}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì¢…ë£Œì¼</label>
                <input type="date" id="megaProjectEnd" value="${megaProject?.endDate || ''}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteMegaProject('${megaProject.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveMegaProject()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveMegaProject() {
      const id = document.getElementById('megaProjectId').value;
      const name = document.getElementById('megaProjectName').value.trim();

      if (!name) {
        showToast('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const targetUnitType = document.getElementById('megaProjectUnitType').value || 'revenue';
      const targetValue = parseFloat(document.getElementById('megaProjectTargetValue').value) || 0;

      // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ revenueTargetë„ ìœ ì§€ (ë§¤ì¶œì•¡ íƒ€ì…ì¼ ë•Œë§Œ)
      const revenueTarget = targetUnitType === 'revenue' ? targetValue * 100000000 : 0;

      const data = {
        name,
        description: document.getElementById('megaProjectDesc').value.trim(),
        targetUnitType,
        targetValue,
        revenueTarget, // í•˜ìœ„ í˜¸í™˜ì„±
        priority: parseInt(document.getElementById('megaProjectPriority').value) || null,
        year: parseInt(document.getElementById('megaProjectYear').value) || null,
        status: document.getElementById('megaProjectStatus').value || 'active',
        startDate: document.getElementById('megaProjectStart').value,
        endDate: document.getElementById('megaProjectEnd').value,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('megaProjects').doc(id).update(data);
        } else {
          data.createdAt = new Date().toISOString();
          data.status = 'active';
          await db.collection('megaProjects').add(data);
        }
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteMegaProject(id) {
      if (!confirm('ì´ íŒ€ KPIë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•˜ìœ„ ì„ í–‰ì§€í‘œ ì—°ê²°ì´ í•´ì œë©ë‹ˆë‹¤.')) return;

      try {
        await db.collection('megaProjects').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ì„œë¸Œ KPI ëª¨ë‹¬ (ë©”ì¸ KPI ì—°ê²°)
    function openProjectModalV2(project = null, megaProjectId = null) {
      const isEdit = !!project;
      const megaProjects = state.megaProjects || [];

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header" style="background: var(--primary); color: white;">
            <h2 class="modal-title" style="color: white;">${isEdit ? 'ğŸ“ í”„ë¡œì íŠ¸ ìˆ˜ì •' : 'ğŸ“ í”„ë¡œì íŠ¸ ì¶”ê°€'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="projectIdV2" value="${project?.id || ''}">

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ìƒìœ„ íŒ€ KPI *</label>
              <select id="projectMegaId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${megaProjects.map(mp => `<option value="${mp.id}" ${(project?.megaProjectId === mp.id || megaProjectId === mp.id) ? 'selected' : ''}>${mp.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">í”„ë¡œì íŠ¸ëª… *</label>
              <input type="text" id="projectNameV2" value="${project?.name || ''}" placeholder="ì˜ˆ: ì¼ë³¸ ìˆ˜ì¶œ ì§„í–‰"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì„¤ëª…</label>
              <textarea id="projectDescV2" rows="2" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª…"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">${project?.description || ''}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œ ë‹¨ìœ„</label>
                <select id="projectUnitTypeV2" onchange="updateProjectTargetLabel()" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
                  <option value="revenue" ${!project?.targetUnitType || project?.targetUnitType === 'revenue' ? 'selected' : ''}>ë§¤ì¶œì•¡ (ì–µì›)</option>
                  <option value="percent" ${project?.targetUnitType === 'percent' ? 'selected' : ''}>í¼ì„¼íŠ¸ (%)</option>
                  <option value="count" ${project?.targetUnitType === 'count' ? 'selected' : ''}>ê°œìˆ˜ (ê°œ)</option>
                  <option value="case" ${project?.targetUnitType === 'case' ? 'selected' : ''}>ê±´ìˆ˜ (ê±´)</option>
                  <option value="won" ${project?.targetUnitType === 'won' ? 'selected' : ''}>ê¸ˆì•¡ (ë§Œì›)</option>
                </select>
              </div>
              <div>
                <label id="projectTargetLabelV2" style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œê°’</label>
                <input type="number" id="projectTargetValueV2" value="${project?.targetUnitType && project.targetUnitType !== 'revenue' ? (project.targetValue || '') : (project?.revenueGoal ? project.revenueGoal / 100000000 : '')}" placeholder="ëª©í‘œê°’ ì…ë ¥"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì‹œì‘ì¼</label>
                <input type="date" id="projectStartV2" value="${project?.startDate || ''}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì¢…ë£Œì¼</label>
                <input type="date" id="projectEndV2" value="${project?.endDate || ''}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteProjectV2('${project.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveProjectV2()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveProjectV2() {
      const id = document.getElementById('projectIdV2').value;
      const megaProjectId = document.getElementById('projectMegaId').value;
      const name = document.getElementById('projectNameV2').value.trim();

      if (!megaProjectId) {
        showToast('ìƒìœ„ íŒ€ KPIë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      if (!name) {
        showToast('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const targetUnitType = document.getElementById('projectUnitTypeV2').value || 'revenue';
      const targetValue = parseFloat(document.getElementById('projectTargetValueV2').value) || 0;

      // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ revenueGoalë„ ìœ ì§€ (ë§¤ì¶œì•¡ íƒ€ì…ì¼ ë•Œë§Œ)
      const revenueGoal = targetUnitType === 'revenue' ? targetValue * 100000000 : 0;

      const data = {
        megaProjectId,
        name,
        description: document.getElementById('projectDescV2').value.trim(),
        targetUnitType,
        targetValue,
        revenueGoal, // í•˜ìœ„ í˜¸í™˜ì„±
        startDate: document.getElementById('projectStartV2').value,
        endDate: document.getElementById('projectEndV2').value,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('projects').doc(id).update(data);
        } else {
          data.createdAt = new Date().toISOString();
          data.status = 'active';
          await db.collection('projects').add(data);
        }
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteProjectV2(id) {
      if (!confirm('ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('projects').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // ì„ í–‰ì§€í‘œ â†’ ë‚´ ì„ í–‰ì§€í‘œ ì—°ê²° ì‹œìŠ¤í…œ
    // ========================================
    function openTeamKPIModal(kpi = null, projectId = null) {
      const isEdit = !!kpi;
      const projects = state.projects || [];
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');

      // ê¸°ì¡´ ë°°ì •ëœ ë©¤ë²„
      const assignedMembers = kpi?.assignedMembers || [];

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 650px;">
          <div class="modal-header" style="background: #10B981; color: white;">
            <h2 class="modal-title" style="color: white;">${isEdit ? 'ğŸ“‹ ì„ í–‰ì§€í‘œ ìˆ˜ì •' : 'ğŸ“‹ ì„ í–‰ì§€í‘œ ì¶”ê°€'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="teamKpiId" value="${kpi?.id || ''}">

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì—°ê²° í”„ë¡œì íŠ¸ *</label>
              <select id="teamKpiProjectId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${projects.map(p => `<option value="${p.id}" ${(kpi?.projectId === p.id || projectId === p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">KPI ì´ë¦„ *</label>
              <input type="text" id="teamKpiName" value="${kpi?.name || ''}" placeholder="ì˜ˆ: ì¼ë³¸ ì¸í”Œë£¨ì–¸ì„œ 20ëª… í™•ë³´"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œê°’ *</label>
                <input type="number" id="teamKpiTarget" value="${kpi?.target || ''}" placeholder="20"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">í˜„ì¬ê°’</label>
                <input type="number" id="teamKpiCurrent" value="${kpi?.current || 0}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ë‹¨ìœ„</label>
                <select id="teamKpiUnit" onchange="updateTeamKpiUnitDisplay()" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                  <option value="ê±´" ${kpi?.unit === 'ê±´' || !kpi?.unit ? 'selected' : ''}>ê±´ìˆ˜ (ê±´)</option>
                  <option value="ê°œ" ${kpi?.unit === 'ê°œ' ? 'selected' : ''}>ê°œìˆ˜ (ê°œ)</option>
                  <option value="ëª…" ${kpi?.unit === 'ëª…' ? 'selected' : ''}>ì¸ì› (ëª…)</option>
                  <option value="%" ${kpi?.unit === '%' ? 'selected' : ''}>í¼ì„¼íŠ¸ (%)</option>
                  <option value="ë§Œì›" ${kpi?.unit === 'ë§Œì›' ? 'selected' : ''}>ê¸ˆì•¡ (ë§Œì›)</option>
                  <option value="ì–µ" ${kpi?.unit === 'ì–µ' ? 'selected' : ''}>ë§¤ì¶œ (ì–µ)</option>
                  <option value="íšŒ" ${kpi?.unit === 'íšŒ' ? 'selected' : ''}>íšŸìˆ˜ (íšŒ)</option>
                  <option value="ê³³" ${kpi?.unit === 'ê³³' ? 'selected' : ''}>ì¥ì†Œ (ê³³)</option>
                </select>
              </div>
            </div>

            <!-- íŒ€ì› ë°°ì • -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ğŸ‘¤ ë‹´ë‹¹ íŒ€ì› ë°°ì • (ë‚´ ì—…ë¬´ë¡œ ë¶„ë°°)</label>
              <div style="background: var(--gray-50); border-radius: 12px; padding: 16px;">
                ${members.map(member => {
                  const assigned = assignedMembers.find(a => a.memberId === member.id);
                  return `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px;">
                      <input type="checkbox" id="assign-${member.id}" ${assigned ? 'checked' : ''} onchange="toggleMemberAssignment('${member.id}')"
                        style="width: 18px; height: 18px;">
                      <span style="flex: 1; font-weight: 500;">${member.name}</span>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="assign-target-${member.id}" value="${assigned?.target || ''}" placeholder="ëª©í‘œ"
                          style="width: 70px; padding: 8px; border: 1px solid var(--gray-300); border-radius: 6px; ${!assigned ? 'opacity: 0.5;' : ''}"
                          ${!assigned ? 'disabled' : ''}>
                        <span class="member-unit-display" style="font-size: 12px; color: var(--gray-500);">${kpi?.unit || 'ê±´'}</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              <div style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">
                ğŸ’¡ ì²´í¬í•œ íŒ€ì›ì—ê²Œ ë‚´ ì—…ë¬´ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤. ê°œì¸ ëª©í‘œ í•©ê³„ê°€ ì„ í–‰ì§€í‘œ ëª©í‘œê°€ ë©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteTeamKPI('${kpi.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveTeamKPI()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    function toggleMemberAssignment(memberId) {
      const checkbox = document.getElementById(`assign-${memberId}`);
      const targetInput = document.getElementById(`assign-target-${memberId}`);

      if (checkbox.checked) {
        targetInput.disabled = false;
        targetInput.style.opacity = '1';
      } else {
        targetInput.disabled = true;
        targetInput.style.opacity = '0.5';
        targetInput.value = '';
      }
    }

    async function saveTeamKPI() {
      const id = document.getElementById('teamKpiId').value;
      const projectId = document.getElementById('teamKpiProjectId').value;
      const name = document.getElementById('teamKpiName').value.trim();
      const target = parseInt(document.getElementById('teamKpiTarget').value) || 0;
      const current = parseInt(document.getElementById('teamKpiCurrent').value) || 0;
      const unit = document.getElementById('teamKpiUnit').value.trim() || 'ê±´';

      if (!projectId) {
        showToast('í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      if (!name) {
        showToast('KPI ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      // ë°°ì •ëœ ë©¤ë²„ ìˆ˜ì§‘
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');
      const assignedMembers = [];

      members.forEach(member => {
        const checkbox = document.getElementById(`assign-${member.id}`);
        const targetInput = document.getElementById(`assign-target-${member.id}`);

        if (checkbox?.checked) {
          assignedMembers.push({
            memberId: member.id,
            memberName: member.name,
            target: parseInt(targetInput?.value) || 0
          });
        }
      });

      const teamKpiData = {
        projectId,
        name,
        target,
        current,
        unit,
        assignedMembers,
        updatedAt: new Date().toISOString()
      };

      try {
        let teamKpiId = id;

        if (id) {
          await db.collection('teamKPIs').doc(id).update(teamKpiData);
        } else {
          teamKpiData.createdAt = new Date().toISOString();
          const docRef = await db.collection('teamKPIs').add(teamKpiData);
          teamKpiId = docRef.id;
        }

        // ë‚´ ì„ í–‰ì§€í‘œ ìë™ ìƒì„±/ì—…ë°ì´íŠ¸
        for (const assigned of assignedMembers) {
          const memberKpiData = {
            teamKpiId,
            projectId,
            memberId: assigned.memberId,
            memberName: assigned.memberName,
            name: `${name} (${assigned.memberName})`,
            target: assigned.target,
            current: 0,
            unit,
            updatedAt: new Date().toISOString()
          };

          // ê¸°ì¡´ ë‚´ ì„ í–‰ì§€í‘œ ì°¾ê¸°
          const existingQuery = await db.collection('memberKPIs')
            .where('teamKpiId', '==', teamKpiId)
            .where('memberId', '==', assigned.memberId)
            .get();

          if (!existingQuery.empty) {
            await db.collection('memberKPIs').doc(existingQuery.docs[0].id).update(memberKpiData);
          } else {
            memberKpiData.createdAt = new Date().toISOString();
            await db.collection('memberKPIs').add(memberKpiData);
          }
        }

        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderKPIManagement();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteTeamKPI(id) {
      if (!confirm('ì´ ì„ í–‰ì§€í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ê²°ëœ ë‚´ ì—…ë¬´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

      try {
        // ì—°ê²°ëœ ë‚´ ì„ í–‰ì§€í‘œ ì‚­ì œ
        const memberKPIs = await db.collection('memberKPIs').where('teamKpiId', '==', id).get();
        const batch = db.batch();
        memberKPIs.docs.forEach(doc => batch.delete(doc.ref));
        batch.delete(db.collection('teamKPIs').doc(id));
        await batch.commit();

        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderKPIManagement();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // ë‚´ ì„ í–‰ì§€í‘œ ëª¨ë‹¬ ì‹œìŠ¤í…œ
    // ========================================
    function openMemberKPIModal(kpi = null, teamKpiId = null) {
      const isEdit = !!kpi;
      const projects = state.projects || [];
      const teamKPIs = state.teamKPIs || [];
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
          <div class="modal-header" style="background: #F59E0B; color: white;">
            <h2 class="modal-title" style="color: white;">${isEdit ? 'ğŸ‘¤ ë‚´ ì—…ë¬´ ìˆ˜ì •' : 'ğŸ‘¤ ë‚´ ì—…ë¬´ ì¶”ê°€'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="memberKpiId" value="${kpi?.id || ''}">

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ë‹´ë‹¹ì *</label>
              <select id="memberKpiMemberId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${members.map(member => `<option value="${member.id}" data-name="${member.name}" ${kpi?.memberId === member.id ? 'selected' : ''}>${member.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì—°ê²° ì„ í–‰ì§€í‘œ (ì„ íƒ)</label>
              <select id="memberKpiTeamKpiId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                <option value="">ì—†ìŒ (ë…ë¦½ ë‚´ ì—…ë¬´)</option>
                ${teamKPIs.map(tk => `<option value="${tk.id}" data-project="${tk.projectId}" ${(kpi?.teamKpiId === tk.id || teamKpiId === tk.id) ? 'selected' : ''}>${tk.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì—°ê²° í”„ë¡œì íŠ¸ (ì„ íƒ)</label>
              <select id="memberKpiProjectId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${projects.map(p => `<option value="${p.id}" ${kpi?.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">KPI ì´ë¦„ *</label>
              <input type="text" id="memberKpiName" value="${kpi?.name || ''}" placeholder="ì˜ˆ: ì¸í”Œë£¨ì–¸ì„œ 5ëª… í™•ë³´"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œê°’ *</label>
                <input type="number" id="memberKpiTarget" value="${kpi?.target || ''}" placeholder="10"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">í˜„ì¬ê°’</label>
                <input type="number" id="memberKpiCurrent" value="${kpi?.current || 0}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ë‹¨ìœ„</label>
                <input type="text" id="memberKpiUnit" value="${kpi?.unit || 'ê±´'}" placeholder="ëª…, ê±´, ê°œ"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteMemberKPI('${kpi.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveMemberKPI()">ì €ì¥</button>
          </div>
        </div>
      `;

      // ì„ í–‰ì§€í‘œ ì„ íƒ ì‹œ ì„œë¸Œ KPI ìë™ ì—°ê²°
      document.getElementById('memberKpiTeamKpiId').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const projectId = selectedOption.dataset.project;
        if (projectId) {
          document.getElementById('memberKpiProjectId').value = projectId;
        }
      });
    }

    async function saveMemberKPI() {
      const id = document.getElementById('memberKpiId').value;
      const memberSelect = document.getElementById('memberKpiMemberId');
      const memberId = memberSelect.value;
      const memberName = memberSelect.options[memberSelect.selectedIndex]?.dataset?.name || '';
      const teamKpiId = document.getElementById('memberKpiTeamKpiId').value || null;
      const projectId = document.getElementById('memberKpiProjectId').value || null;
      const name = document.getElementById('memberKpiName').value.trim();
      const target = parseInt(document.getElementById('memberKpiTarget').value) || 0;
      const current = parseInt(document.getElementById('memberKpiCurrent').value) || 0;
      const unit = document.getElementById('memberKpiUnit').value.trim() || 'ê±´';

      if (!memberId) {
        showToast('ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      if (!name) {
        showToast('KPI ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      if (target <= 0) {
        showToast('ëª©í‘œê°’ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const memberKpiData = {
        memberId,
        memberName,
        teamKpiId,
        projectId,
        name,
        target,
        current,
        unit,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('memberKPIs').doc(id).update(memberKpiData);
        } else {
          memberKpiData.createdAt = new Date().toISOString();
          await db.collection('memberKPIs').add(memberKpiData);
        }

        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderKPIManagement();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteMemberKPI(id) {
      if (!confirm('ì´ ë‚´ ì—…ë¬´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('memberKPIs').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderKPIManagement();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // ë³´ê³ ì„œ ìë™ ìƒì„± ì‹œìŠ¤í…œ
    // ========================================
    function generateMemberReport() {
      const member = state.currentUser;
      const memberName = member?.name || 'ì‚¬ìš©ì';
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];

      // ë‚´ ì„ í–‰ì§€í‘œ ë°ì´í„°
      const myKPIs = (state.memberKPIs || []).filter(k =>
        k.memberId === member?.id || k.memberName === memberName
      );

      // ë‚´ ì—…ë¬´ ë°ì´í„°
      const myTasks = (state.tasks || []).filter(t =>
        t.assignee === member?.id || t.assigneeName === memberName
      );

      const completedTasks = myTasks.filter(t => t.status === 'done');
      const inProgressTasks = myTasks.filter(t => t.status === 'progress');
      const pendingTasks = myTasks.filter(t => t.status === 'todo');

      // ì„±ê³µë¥  ê³„ì‚°
      const tasksWithDeadline = myTasks.filter(t => t.deadline && t.status === 'done');
      const successTasks = tasksWithDeadline.filter(t => {
        const completed = t.completedAt || t.updatedAt;
        return completed && completed <= t.deadline;
      });
      const successRate = tasksWithDeadline.length > 0
        ? Math.round((successTasks.length / tasksWithDeadline.length) * 100)
        : 0;

      // HTML ë³´ê³ ì„œ ìƒì„±
      const reportHTML = `
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°œì¸ ì„±ê³¼ ë³´ê³ ì„œ - ${memberName} (${dateStr})</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Pretendard', -apple-system, sans-serif; background: #f5f7fa; padding: 40px; color: #1e293b; }
    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #1e3a5f, #0f2744); color: white; padding: 32px; }
    .header h1 { font-size: 24px; margin-bottom: 8px; }
    .header .subtitle { opacity: 0.8; font-size: 14px; }
    .content { padding: 32px; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 16px; font-weight: 700; color: #1e3a5f; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .stat-card { background: #f8fafc; border-radius: 12px; padding: 20px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; color: #1e3a5f; }
    .stat-label { font-size: 12px; color: #64748b; margin-top: 4px; }
    .kpi-list, .task-list { background: #f8fafc; border-radius: 12px; overflow: hidden; }
    .kpi-item, .task-item { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .kpi-item:last-child, .task-item:last-child { border-bottom: none; }
    .kpi-name, .task-name { font-weight: 600; }
    .kpi-progress { font-size: 14px; color: #64748b; }
    .progress-bar { width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-left: 12px; }
    .progress-fill { height: 100%; background: #00C471; }
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .badge-success { background: #dcfce7; color: #16a34a; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-danger { background: #fee2e2; color: #dc2626; }
    .footer { background: #f8fafc; padding: 20px 32px; text-align: center; font-size: 12px; color: #64748b; }
    @media print { body { padding: 0; background: white; } .container { box-shadow: none; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ê°œì¸ ì„±ê³¼ ë³´ê³ ì„œ</h1>
      <div class="subtitle">${memberName} | ìƒì„±ì¼: ${today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
    </div>
    <div class="content">
      <div class="section">
        <div class="section-title">ğŸ“ˆ ì„±ê³¼ ìš”ì•½</div>
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-value">${myKPIs.length}</div>
            <div class="stat-label">í• ë‹¹ëœ KPI</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${completedTasks.length}</div>
            <div class="stat-label">ì™„ë£Œ ì—…ë¬´</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${inProgressTasks.length}</div>
            <div class="stat-label">ì§„í–‰ ì¤‘</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: ${successRate >= 80 ? '#16a34a' : successRate >= 50 ? '#d97706' : '#dc2626'};">${successRate}%</div>
            <div class="stat-label">ì—…ë¬´ ì„±ê³µë¥ </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">ğŸ¯ KPI ë‹¬ì„± í˜„í™©</div>
        <div class="kpi-list">
          ${myKPIs.length === 0 ? '<div class="kpi-item" style="color: #94a3b8;">í• ë‹¹ëœ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>' : myKPIs.map(kpi => {
            const progress = kpi.target > 0 ? Math.round((kpi.current / kpi.target) * 100) : 0;
            return `
              <div class="kpi-item">
                <div class="kpi-name">${kpi.name || 'ì´ë¦„ì—†ìŒ'}</div>
                <div style="display: flex; align-items: center;">
                  <span class="kpi-progress">${kpi.current || 0}/${kpi.target || 0} ${kpi.unit || ''}</span>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(100, progress)}%; background: ${progress >= 100 ? '#16a34a' : progress >= 70 ? '#00C471' : progress >= 40 ? '#f59e0b' : '#ef4444'};"></div>
                  </div>
                  <span style="margin-left: 8px; font-weight: 600; font-size: 14px;">${progress}%</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>

      <div class="section">
        <div class="section-title">âœ… ìµœê·¼ ì™„ë£Œ ì—…ë¬´</div>
        <div class="task-list">
          ${completedTasks.slice(0, 10).length === 0 ? '<div class="task-item" style="color: #94a3b8;">ì™„ë£Œëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : completedTasks.slice(0, 10).map(task => `
            <div class="task-item">
              <div class="task-name">${task.title || task.name || 'ì œëª©ì—†ìŒ'}</div>
              <span class="badge ${task.success ? 'badge-success' : 'badge-danger'}">${task.success ? 'ì„±ê³µ' : 'ì§€ì—°'}</span>
            </div>
          `).join('')}
        </div>
      </div>

      <div class="section">
        <div class="section-title">â³ ì§„í–‰ ì¤‘ ì—…ë¬´</div>
        <div class="task-list">
          ${inProgressTasks.length === 0 ? '<div class="task-item" style="color: #94a3b8;">ì§„í–‰ ì¤‘ì¸ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : inProgressTasks.map(task => {
            const deadline = task.deadline;
            const daysLeft = deadline ? Math.ceil((new Date(deadline) - today) / (1000 * 60 * 60 * 24)) : null;
            return `
              <div class="task-item">
                <div class="task-name">${task.title || task.name || 'ì œëª©ì—†ìŒ'}</div>
                ${daysLeft !== null ? `<span class="badge ${daysLeft < 0 ? 'badge-danger' : daysLeft <= 3 ? 'badge-warning' : 'badge-success'}">${daysLeft < 0 ? 'D+' + Math.abs(daysLeft) : daysLeft === 0 ? 'D-Day' : 'D-' + daysLeft}</span>` : ''}
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
    <div class="footer">
      NetformRND ì „ëµì„¼í„° | ìë™ ìƒì„±ëœ ë³´ê³ ì„œ | ${today.toISOString()}
    </div>
  </div>
</body>
</html>`;

      // ìƒˆ ì°½ì—ì„œ ë³´ê³ ì„œ ì—´ê¸°
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(reportHTML);
      reportWindow.document.close();

      showToast('ê°œì¸ ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function generateAdminReport() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];

      // íŒ€ ì „ì²´ ë°ì´í„°
      const teamMembers = [
        { id: 'chaeeun', name: 'ì´ì±„ì€', role: 'manager' },
        { id: 'songhee', name: 'ê¹€ì†¡í¬', role: 'admin' }
      ];

      // ì—°ë„ë³„ ëª©í‘œ
      const yearlyGoals = state.yearlyGoals || [];
      const currentYearGoal = yearlyGoals.find(g => g.year === today.getFullYear());

      // ë©”ì¸ KPI
      const megaProjects = state.megaProjects || [];

      // ì„ í–‰ì§€í‘œ
      const teamKPIs = state.teamKPIs || [];

      // ë‚´ ì„ í–‰ì§€í‘œ
      const memberKPIs = state.memberKPIs || [];

      // ì „ì²´ ì—…ë¬´
      const allTasks = state.tasks || [];
      const completedTasks = allTasks.filter(t => t.status === 'done');
      const inProgressTasks = allTasks.filter(t => t.status === 'progress');
      const overdueTasks = allTasks.filter(t => {
        if (!t.deadline || t.status === 'done') return false;
        return new Date(t.deadline) < today;
      });

      // íŒ€ì›ë³„ ì„±ê³¼ ê³„ì‚°
      const memberStats = teamMembers.map(member => {
        const kpis = memberKPIs.filter(k => k.memberId === member.id || k.memberName === member.name);
        const tasks = allTasks.filter(t => t.assignee === member.id || t.assigneeName === member.name);
        const completed = tasks.filter(t => t.status === 'done');
        const successTasks = completed.filter(t => t.success === true);
        const successRate = completed.length > 0 ? Math.round((successTasks.length / completed.length) * 100) : 0;

        const kpiProgress = kpis.length > 0
          ? Math.round(kpis.reduce((sum, k) => sum + (k.target > 0 ? (k.current / k.target) * 100 : 0), 0) / kpis.length)
          : 0;

        return {
          ...member,
          kpiCount: kpis.length,
          kpiProgress,
          taskCount: tasks.length,
          completedCount: completed.length,
          successRate
        };
      });

      // ë©”ì¸ KPIë³„ ì§„í–‰ë¥ 
      const projectStats = megaProjects.map(mp => {
        const projects = (state.projects || []).filter(p => p.megaProjectId === mp.id);
        const kpis = teamKPIs.filter(k => projects.some(p => p.id === k.projectId));
        const totalProgress = kpis.length > 0
          ? Math.round(kpis.reduce((sum, k) => sum + (k.target > 0 ? (k.current / k.target) * 100 : 0), 0) / kpis.length)
          : 0;
        return {
          name: mp.name,
          projectCount: projects.length,
          kpiCount: kpis.length,
          progress: totalProgress
        };
      });

      // HTML ë³´ê³ ì„œ ìƒì„±
      const reportHTML = `
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì ì¢…í•© ë³´ê³ ì„œ (${dateStr})</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Pretendard', -apple-system, sans-serif; background: #f5f7fa; padding: 40px; color: #1e293b; }
    .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; padding: 32px; }
    .header h1 { font-size: 24px; margin-bottom: 8px; }
    .header .subtitle { opacity: 0.8; font-size: 14px; }
    .content { padding: 32px; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 16px; font-weight: 700; color: #1e3a5f; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; display: flex; align-items: center; gap: 8px; }
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .stat-card { background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #e2e8f0; }
    .stat-value { font-size: 28px; font-weight: 700; color: #1e3a5f; }
    .stat-label { font-size: 12px; color: #64748b; margin-top: 4px; }
    .table { width: 100%; border-collapse: collapse; background: #f8fafc; border-radius: 12px; overflow: hidden; }
    .table th { background: #1e3a5f; color: white; padding: 14px 16px; text-align: left; font-size: 13px; font-weight: 600; }
    .table td { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
    .table tr:last-child td { border-bottom: none; }
    .table tr:hover { background: #f1f5f9; }
    .progress-bar { width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; display: inline-block; vertical-align: middle; }
    .progress-fill { height: 100%; }
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-success { background: #dcfce7; color: #16a34a; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-danger { background: #fee2e2; color: #dc2626; }
    .badge-info { background: #dbeafe; color: #2563eb; }
    .alert { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
    .alert-danger { background: #fee2e2; border-color: #ef4444; }
    .alert-icon { font-size: 24px; }
    .goal-card { background: linear-gradient(135deg, #1e3a5f, #0f2744); color: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; }
    .goal-title { font-size: 14px; opacity: 0.8; margin-bottom: 8px; }
    .goal-value { font-size: 32px; font-weight: 700; }
    .footer { background: #f8fafc; padding: 20px 32px; text-align: center; font-size: 12px; color: #64748b; }
    @media print { body { padding: 0; background: white; } .container { box-shadow: none; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ê´€ë¦¬ì ì¢…í•© ë³´ê³ ì„œ</h1>
      <div class="subtitle">NetformRND ì „ëµì„¼í„° | ${today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
    </div>
    <div class="content">
      ${overdueTasks.length > 0 ? `
      <div class="alert alert-danger">
        <span class="alert-icon">âš ï¸</span>
        <div>
          <strong>ì£¼ì˜: ë§ˆê° ì´ˆê³¼ ì—…ë¬´ ${overdueTasks.length}ê±´</strong>
          <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
        </div>
      </div>
      ` : ''}

      <div class="section">
        <div class="section-title">ğŸ¯ ì—°ê°„ ëª©í‘œ í˜„í™©</div>
        ${currentYearGoal ? `
        <div class="goal-card">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div class="goal-title">${today.getFullYear()}ë…„ ëª©í‘œ</div>
              <div class="goal-value">${((currentYearGoal.revenueTarget || 0) / 100000000).toFixed(0)}ì–µ</div>
            </div>
            <div style="text-align: right;">
              <div class="goal-title">ì˜ì—… / ì„±ì¥ ë¹„ìœ¨</div>
              <div style="font-size: 20px; font-weight: 600;">${currentYearGoal.salesRatio || 70}% : ${currentYearGoal.growthRatio || 30}%</div>
            </div>
          </div>
        </div>
        ` : '<div style="color: #94a3b8; padding: 20px; text-align: center;">ì—°ê°„ ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>'}
      </div>

      <div class="section">
        <div class="section-title">ğŸ“ˆ ì „ì²´ í˜„í™©</div>
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-value">${megaProjects.length}</div>
            <div class="stat-label">ëŒ€í˜• í”„ë¡œì íŠ¸</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${teamKPIs.length}</div>
            <div class="stat-label">ì„ í–‰ì§€í‘œ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${completedTasks.length}/${allTasks.length}</div>
            <div class="stat-label">ì—…ë¬´ ì™„ë£Œìœ¨</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: ${overdueTasks.length === 0 ? '#16a34a' : '#dc2626'};">${overdueTasks.length}</div>
            <div class="stat-label">ë§ˆê° ì´ˆê³¼</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">ğŸ‘¥ íŒ€ì›ë³„ ì„±ê³¼</div>
        <table class="table">
          <tr>
            <th>ì´ë¦„</th>
            <th>ì—­í• </th>
            <th>KPI ìˆ˜</th>
            <th>KPI ë‹¬ì„±ë¥ </th>
            <th>ì™„ë£Œ ì—…ë¬´</th>
            <th>ì„±ê³µë¥ </th>
          </tr>
          ${memberStats.map(m => `
            <tr>
              <td><strong>${m.name}</strong></td>
              <td><span class="badge ${m.role === 'admin' ? 'badge-info' : 'badge-warning'}">${m.role === 'admin' ? 'ê´€ë¦¬ì' : 'ë§¤ë‹ˆì €'}</span></td>
              <td>${m.kpiCount}</td>
              <td>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${Math.min(100, m.kpiProgress)}%; background: ${m.kpiProgress >= 80 ? '#16a34a' : m.kpiProgress >= 50 ? '#f59e0b' : '#ef4444'};"></div>
                </div>
                <span style="margin-left: 8px;">${m.kpiProgress}%</span>
              </td>
              <td>${m.completedCount}/${m.taskCount}</td>
              <td><span class="badge ${m.successRate >= 80 ? 'badge-success' : m.successRate >= 50 ? 'badge-warning' : 'badge-danger'}">${m.successRate}%</span></td>
            </tr>
          `).join('')}
        </table>
      </div>

      ${megaProjects.length > 0 ? `
      <div class="section">
        <div class="section-title">ğŸ¢ ëŒ€í˜• í”„ë¡œì íŠ¸ë³„ í˜„í™©</div>
        <table class="table">
          <tr>
            <th>í”„ë¡œì íŠ¸ëª…</th>
            <th>ì„ í–‰ì§€í‘œ</th>
            <th>KPI ìˆ˜</th>
            <th>ì§„í–‰ë¥ </th>
          </tr>
          ${projectStats.map(p => `
            <tr>
              <td><strong>${p.name}</strong></td>
              <td>${p.projectCount}ê°œ</td>
              <td>${p.kpiCount}ê°œ</td>
              <td>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${Math.min(100, p.progress)}%; background: ${p.progress >= 80 ? '#16a34a' : p.progress >= 50 ? '#f59e0b' : '#ef4444'};"></div>
                </div>
                <span style="margin-left: 8px;">${p.progress}%</span>
              </td>
            </tr>
          `).join('')}
        </table>
      </div>
      ` : ''}

      ${overdueTasks.length > 0 ? `
      <div class="section">
        <div class="section-title" style="color: #dc2626;">âš ï¸ ë§ˆê° ì´ˆê³¼ ì—…ë¬´ ëª©ë¡</div>
        <table class="table">
          <tr>
            <th>ì—…ë¬´ëª…</th>
            <th>ë‹´ë‹¹ì</th>
            <th>ë§ˆê°ì¼</th>
            <th>ì´ˆê³¼ ì¼ìˆ˜</th>
          </tr>
          ${overdueTasks.slice(0, 10).map(t => {
            const daysOver = Math.ceil((today - new Date(t.deadline)) / (1000 * 60 * 60 * 24));
            return `
              <tr>
                <td><strong>${t.title || t.name || 'ì œëª©ì—†ìŒ'}</strong></td>
                <td>${t.assigneeName || '-'}</td>
                <td>${t.deadline}</td>
                <td><span class="badge badge-danger">+${daysOver}ì¼</span></td>
              </tr>
            `;
          }).join('')}
        </table>
      </div>
      ` : ''}
    </div>
    <div class="footer">
      NetformRND ì „ëµì„¼í„° | ê´€ë¦¬ììš© ìë™ ìƒì„± ë³´ê³ ì„œ | ${today.toISOString()}
    </div>
  </div>
</body>
</html>`;

      // ìƒˆ ì°½ì—ì„œ ë³´ê³ ì„œ ì—´ê¸°
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(reportHTML);
      reportWindow.document.close();

      showToast('ê´€ë¦¬ì ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ========================================
    // ê³µí†µ UI: ëª¨ë”” ì±—ë´‡ ì‹œìŠ¤í…œ
    // ========================================
    function toggleChatbot() {
      const chatbot = document.getElementById('chatbot-window');
      if (chatbot.style.display === 'none' || chatbot.style.display === '') {
        chatbot.style.display = 'flex';
        initChatbot();
      } else {
        chatbot.style.display = 'none';
      }
    }

    function initChatbot() {
      const messages = document.getElementById('chatbot-messages');
      if (!messages) return;

      // ë§ˆê° ì„ë°• ì—…ë¬´ í™•ì¸
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const upcomingTasks = (state.tasks || []).filter(t => {
        if (!t.deadline || t.status === 'done') return false;
        const deadline = new Date(t.deadline);
        const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
        return daysLeft <= 3 && daysLeft >= 0;
      });

      const overdueTasks = (state.tasks || []).filter(t => {
        if (!t.deadline || t.status === 'done') return false;
        return new Date(t.deadline) < today;
      });

      let alertHTML = '';
      if (overdueTasks.length > 0) {
        alertHTML += `
          <div style="background: #fee2e2; border: 1px solid #fca5a5; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 700; color: #dc2626; margin-bottom: 4px;">âš ï¸ ë§ˆê° ì´ˆê³¼ ì—…ë¬´ ${overdueTasks.length}ê±´</div>
            <div style="font-size: 11px; color: #991b1b;">ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!</div>
          </div>
        `;
      }
      if (upcomingTasks.length > 0) {
        alertHTML += `
          <div style="background: #fef3c7; border: 1px solid #fcd34d; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 700; color: #d97706; margin-bottom: 4px;">ğŸ“… ì˜¤ëŠ˜ ë§ˆê° ì—…ë¬´ ${upcomingTasks.filter(t => t.deadline === todayStr).length}ê±´</div>
            <div style="font-size: 11px; color: #92400e;">3ì¼ ë‚´ ë§ˆê°: ${upcomingTasks.length}ê±´</div>
          </div>
        `;
      }

      messages.innerHTML = `
        <div style="margin-bottom: 16px;">
          ${alertHTML}
          <div style="background: white; padding: 12px 16px; border-radius: 12px 12px 12px 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 12px; max-width: 85%;">
            <div style="font-size: 13px; color: var(--gray-800); line-height: 1.6;">
              ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹<br>
              ì „ëµì„¼í„° ë„ìš°ë¯¸ <strong>ëª¨ë””</strong>ì…ë‹ˆë‹¤.<br>
              ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
          </div>
          <div style="font-size: 11px; color: var(--gray-400); margin-bottom: 12px;">ë¹ ë¥¸ ë©”ë‰´</div>
          <div style="display: grid; gap: 6px;">
            <button onclick="askQuestion('KPI ê´€ë¦¬ ë°©ë²•')" style="background: linear-gradient(135deg, #fff8f0, #ffe8cc); border: 1px solid var(--primary); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--primary); font-weight: 600; transition: all 0.2s;">
              ğŸ¯ KPI ê´€ë¦¬ëŠ” ì–´ë–»ê²Œ í•˜ë‚˜ìš”?
            </button>
            <button onclick="askQuestion('í”„ë¡œì íŠ¸ ë“±ë¡ ë°©ë²•')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;">
              ğŸ“‹ í”„ë¡œì íŠ¸ ë“±ë¡ ë°©ë²•
            </button>
            <button onclick="askQuestion('ì—…ë¬´ ê´€ë¦¬ íŒ')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;">
              âœ… ì—…ë¬´ ê´€ë¦¬ íŒ
            </button>
            <button onclick="askQuestion('ì„±ê³¼ë¶„ì„ í™œìš©ë²•')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;">
              ğŸ“Š ì„±ê³¼ë¶„ì„ í™œìš©ë²•
            </button>
            <button onclick="window.open('../', '_self')" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 1px solid #3b82f6; padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: #1d4ed8; font-weight: 600; transition: all 0.2s;">
              ğŸ  ìš´ì˜ì„¼í„°ë¡œ ì´ë™
            </button>
          </div>
        </div>
      `;
    }

    function askQuestion(question) {
      addUserMessage(question);
      setTimeout(() => {
        const answer = getChatbotAnswer(question);
        addBotMessage(answer);
      }, 300);
    }

    function addUserMessage(message) {
      const messages = document.getElementById('chatbot-messages');
      if (!messages) return;
      const userMsg = document.createElement('div');
      userMsg.style.cssText = 'display: flex; justify-content: flex-end; margin-bottom: 12px;';
      userMsg.innerHTML = `
        <div style="background: var(--primary); color: white; padding: 10px 14px; border-radius: 12px 12px 4px 12px; max-width: 75%; font-size: 13px;">
          ${message}
        </div>
      `;
      messages.appendChild(userMsg);
      messages.scrollTop = messages.scrollHeight;
    }

    function addBotMessage(message) {
      const messages = document.getElementById('chatbot-messages');
      if (!messages) return;
      const botMsg = document.createElement('div');
      botMsg.style.cssText = 'margin-bottom: 12px;';
      botMsg.innerHTML = `
        <div style="background: white; padding: 12px 16px; border-radius: 12px 12px 12px 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 85%; font-size: 13px; color: var(--gray-800); line-height: 1.7;">
          ${message}
        </div>
      `;
      messages.appendChild(botMsg);
      messages.scrollTop = messages.scrollHeight;
    }

    function sendChatMessage() {
      const input = document.getElementById('chatbot-input');
      if (!input) return;
      const message = input.value.trim();
      if (!message) return;
      askQuestion(message);
      input.value = '';
    }

    function getChatbotAnswer(question) {
      const q = question.toLowerCase();

      if (q.includes('kpi') || q.includes('ê´€ë¦¬')) {
        return `<strong>ğŸ¯ KPI ê´€ë¦¬ ë°©ë²•</strong><br><br>
          1ï¸âƒ£ <strong>KPIê´€ë¦¬</strong> ë©”ë‰´ë¡œ ì´ë™<br>
          2ï¸âƒ£ ê³„ì¸µ ë·°ì—ì„œ ì „ì²´ KPI í˜„í™© í™•ì¸<br>
          3ï¸âƒ£ ì„ í–‰ì§€í‘œ í´ë¦­ â†’ ëª©í‘œ/í˜„ì¬ê°’ ìˆ˜ì •<br>
          4ï¸âƒ£ ë‚´ ì—…ë¬´ì˜ +1 ë²„íŠ¼ìœ¼ë¡œ ë¹ ë¥¸ ì—…ë°ì´íŠ¸<br><br>
          ğŸ’¡ <strong>íŒ:</strong> ì—…ë¬´ ì™„ë£Œ ì‹œ ì—°ê²°ëœ KPIê°€ ìë™ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤!`;
      }

      if (q.includes('í”„ë¡œì íŠ¸') || q.includes('ë“±ë¡')) {
        return `<strong>ğŸ“‹ í”„ë¡œì íŠ¸ ë“±ë¡ ë°©ë²•</strong><br><br>
          1ï¸âƒ£ <strong>ëŒ€ì‹œë³´ë“œ</strong>ì—ì„œ "ğŸ¯ íŒ€ KPI ì¶”ê°€" í´ë¦­<br>
          2ï¸âƒ£ íŒ€ ëª©í‘œëª…, ëª©í‘œ ë§¤ì¶œ, ê¸°ê°„ ì…ë ¥<br>
          3ï¸âƒ£ ì„ í–‰ì§€í‘œ ì¶”ê°€<br>
          4ï¸âƒ£ ë‚´ ì—…ë¬´ ì—°ê²°<br><br>
          ğŸ’¡ <strong>êµ¬ì¡°:</strong> íŒ€ KPI â†’ ì„ í–‰ì§€í‘œ â†’ ë‚´ ì—…ë¬´`;
      }

      if (q.includes('ì—…ë¬´') || q.includes('ê´€ë¦¬') || q.includes('íŒ')) {
        return `<strong>âœ… ì—…ë¬´ ê´€ë¦¬ íŒ</strong><br><br>
          <strong>1. ì¹¸ë°˜ ë·° í™œìš©</strong><br>
          â€¢ ë“œë˜ê·¸ë¡œ ìƒíƒœ ë³€ê²½<br>
          â€¢ "ì§„í–‰ì¤‘"ìœ¼ë¡œ ì´ë™ ì‹œ ìë™ ì‹œì‘ì¼ ê¸°ë¡<br><br>
          <strong>2. ë§ˆê°ì¼ í•„ìˆ˜ ì„¤ì •</strong><br>
          â€¢ D-day ë°°ì§€ë¡œ ë§ˆê° í™•ì¸<br>
          â€¢ ë§ˆê° ì¤€ìˆ˜ ì‹œ ì„±ê³µìœ¼ë¡œ ê¸°ë¡<br><br>
          <strong>3. KPI ì—°ê²°</strong><br>
          â€¢ ì—…ë¬´ ì™„ë£Œ ì‹œ KPI ìë™ +1<br><br>
          ğŸ’¡ ë¹¨ê°„ í…Œë‘ë¦¬ = ë§ˆê° ì„ë°•!`;
      }

      if (q.includes('ì „ëµ') || q.includes('ë¦¬ë·°') || q.includes('í™œìš©')) {
        return `<strong>ğŸ“Š ì„±ê³¼ë¶„ì„ í™œìš©ë²•</strong><br><br>
          <strong>1. ìš”ì•½ ë·°</strong><br>
          ëª©í‘œ ë‹¬ì„± í˜„í™© í•œëˆˆì— í™•ì¸<br><br>
          <strong>2. ì—­ìˆœ ë°ì´í„°</strong><br>
          ì—…ë¬´ â†’ ë‚´ ì—…ë¬´ â†’ ì„ í–‰ì§€í‘œ â†’ íŒ€ KPI<br>
          âš ï¸ ê²½ê³  ì˜ì—­ì—ì„œ ì·¨ì•½ì  íŒŒì•…<br><br>
          <strong>3. ê°œì¸ë³„ ì„±ê³µë¥ </strong><br>
          íŒ€ì›ë³„ ì—…ë¬´ ì™„ìˆ˜ìœ¨ í™•ì¸<br><br>
          ğŸ’¡ <strong>ë³´ê³ ì„œ ìë™ ìƒì„±</strong> ë²„íŠ¼ìœ¼ë¡œ PDF ì¶œë ¥!`;
      }

      return `ì£„ì†¡í•©ë‹ˆë‹¤, í•´ë‹¹ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ğŸ˜…<br><br>
        ë‹¤ìŒ ë©”ë‰´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”:<br>
        â€¢ <strong>ì—…ë¬´ê°€ì´ë“œ</strong> - ìƒì„¸ ê°€ì´ë“œ<br>
        â€¢ <strong>ëŒ€ì‹œë³´ë“œ</strong> - ì „ì²´ í˜„í™©<br><br>
        ë˜ëŠ” ìš´ì˜ì„¼í„°ì˜ ëª¨ë”” ì±—ë´‡ì„ ì´ìš©í•´ë³´ì„¸ìš”!`;
    }

    // ëª¨ë”” ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateChatbotBadge() {
      const badge = document.getElementById('chatbot-notification-badge');
      if (!badge) return;

      const today = new Date();
      const overdueTasks = (state.tasks || []).filter(t => {
        if (!t.deadline || t.status === 'done') return false;
        return new Date(t.deadline) < today;
      });

      if (overdueTasks.length > 0) {
        badge.style.display = 'flex';
        badge.textContent = overdueTasks.length > 9 ? '9+' : overdueTasks.length;
      } else {
        badge.style.display = 'none';
      }
    }

    // ========================================
    // ê³µí†µ UI: ê°„í¸ ë§ˆì§„ê³„ì‚°ê¸°
    // ========================================
    function openSimpleMarginCalculator() {
      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ§® ê°„í¸ ë§ˆì§„ ê³„ì‚°ê¸°</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="background: #fef3c7; border-radius: 10px; padding: 12px 16px; margin-bottom: 20px; font-size: 12px; color: #92400e;">
              ğŸ’¡ <strong>ëª©í‘œ:</strong> ê±´ë‹¹ ìˆœë§ˆì§„ 2,000ì› ì´ìƒ | íŒë§¤ìˆ˜ëŸ‰ 200~300ê°œ
            </div>

            <div style="display: grid; gap: 16px; margin-bottom: 20px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ê³µê¸‰ë‹¨ê°€ (ì›)</label>
                <input type="number" id="calcSupplyPrice" value="10000" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;" oninput="calculateMargin()">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">íŒë§¤ê°€ (ì›)</label>
                <input type="number" id="calcSalePrice" value="15000" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;" oninput="calculateMargin()">
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì…€ëŸ¬ ë§ˆì§„ìœ¨ (%)</label>
                  <input type="number" id="calcSellerRate" value="20" min="0" max="50" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;" oninput="calculateMargin()">
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰</label>
                  <input type="number" id="calcQty" value="250" min="1" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;" oninput="calculateMargin()">
                </div>
              </div>
            </div>

            <div id="marginResult" style="background: var(--gray-50); border-radius: 12px; padding: 20px;">
              <!-- ê³„ì‚° ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            <a href="../" class="btn btn-primary" style="text-decoration: none;">ğŸ§® ìƒì„¸ ê³„ì‚°ê¸° (ìš´ì˜ì„¼í„°)</a>
          </div>
        </div>
      `;
      calculateMargin();
    }

    function calculateMargin() {
      const supplyPrice = Number(document.getElementById('calcSupplyPrice')?.value) || 0;
      const salePrice = Number(document.getElementById('calcSalePrice')?.value) || 0;
      const sellerRate = Number(document.getElementById('calcSellerRate')?.value) || 20;
      const qty = Number(document.getElementById('calcQty')?.value) || 1;

      const totalMargin = salePrice - supplyPrice;
      const sellerMargin = Math.round(salePrice * (sellerRate / 100));
      const pgFee = Math.round(salePrice * 0.04); // 4% PGìˆ˜ìˆ˜ë£Œ
      const ourMargin = totalMargin - sellerMargin - pgFee;

      const totalSales = salePrice * qty;
      const totalOurMargin = ourMargin * qty;

      const isGood = ourMargin >= 2000;
      const marginColor = isGood ? '#16a34a' : '#dc2626';

      const resultEl = document.getElementById('marginResult');
      if (!resultEl) return;

      resultEl.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div style="text-align: center; background: white; padding: 16px; border-radius: 10px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì´ ë§ˆì§„</div>
            <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${formatAmountWithSummary(totalMargin, 'ì›')}</div>
          </div>
          <div style="text-align: center; background: white; padding: 16px; border-radius: 10px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì…€ëŸ¬ ë§ˆì§„</div>
            <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${formatAmountWithSummary(sellerMargin, 'ì›')}</div>
          </div>
          <div style="text-align: center; background: white; padding: 16px; border-radius: 10px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">PG ìˆ˜ìˆ˜ë£Œ (4%)</div>
            <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${formatAmountWithSummary(pgFee, 'ì›')}</div>
          </div>
          <div style="text-align: center; background: ${isGood ? '#dcfce7' : '#fee2e2'}; padding: 16px; border-radius: 10px; border: 2px solid ${marginColor};">
            <div style="font-size: 12px; color: ${marginColor}; margin-bottom: 4px;">ğŸ¯ ìš°ë¦¬ ìˆœë§ˆì§„</div>
            <div style="font-size: 24px; font-weight: 700; color: ${marginColor};">${formatAmountWithSummary(ourMargin, 'ì›')}</div>
          </div>
        </div>
        <div style="margin-top: 16px; padding: 16px; background: ${isGood ? '#dcfce7' : '#fee2e2'}; border-radius: 10px; text-align: center;">
          <div style="font-size: 14px; font-weight: 700; color: ${marginColor};">
            ${isGood ? 'âœ… ìˆ˜ìµì„± ì¶©ë¶„' : 'âš ï¸ ë§ˆì§„ ë¶€ì¡± - ì¡°ì • í•„ìš”'}
          </div>
          <div style="font-size: 13px; color: var(--gray-600); margin-top: 8px;">
            ì˜ˆìƒ ë§¤ì¶œ: <strong>${formatAmountWithSummary(totalSales, 'ì›')}</strong> |
            ì˜ˆìƒ ìˆœìµ: <strong style="color: ${marginColor};">${formatAmountWithSummary(totalOurMargin, 'ì›')}</strong>
          </div>
        </div>
      `;
    }

    // ========================================
    // íŠ¸ë Œë“œ í‚¤ì›Œë“œ ê´€ë¦¬ ì‹œìŠ¤í…œ
    // ========================================

    // í‚¤ì›Œë“œ í•„í„° ì „ì—­ ë³€ìˆ˜
    let keywordSiteFilter = 'all';
    let keywordSearchQuery = '';
    let selectedTopKeywords = [];
    let keywordPastedImage = null; // í‚¤ì›Œë“œ ëª¨ë‹¬ì— ë¶™ì—¬ë„£ì€ ì´ë¯¸ì§€

    // ê¸°ë³¸ í‚¤ì›Œë“œ ë¶„ì„ ì‚¬ì´íŠ¸
    const DEFAULT_KEYWORD_SITES = [
      { id: 'itemscout', name: 'ì•„ì´í…œìŠ¤ì¹´ìš°íŠ¸', url: 'https://itemscout.io', color: '#6366F1' },
      { id: 'blackkiwi', name: 'ë¸”ë™í‚¤ìœ„', url: 'https://blackkiwi.net', color: '#1F2937' },
      { id: 'datalab', name: 'ë„¤ì´ë²„ ë°ì´í„°ë©', url: 'https://datalab.naver.com', color: '#03C75A' },
      { id: 'sometrend', name: 'ì¸íŠ¸ë Œë“œ', url: 'https://some.co.kr', color: '#EC4899' }
    ];

    // íŠ¸ë Œë“œ í‚¤ì›Œë“œ í˜ì´ì§€ ë Œë”ë§
    async function renderTrendKeywords() {
      await loadKeywordSites();
      await loadKeywords();
      await loadTopKeywordsData();
      renderKeywordSiteLinks();
      renderKeywordSiteFilters();
      initTopKeywordMonthSelect();
      loadTopKeywords();
    }

    // í‚¤ì›Œë“œ ë¶„ì„ ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸° ë Œë”ë§
    function renderKeywordSiteLinks() {
      const container = document.getElementById('keywordSiteLinks');
      if (!container) return;

      if (state.keywordSites.length === 0) {
        container.innerHTML = '<span style="color: #7C3AED; font-size: 13px;">ì‚¬ì´íŠ¸ ê´€ë¦¬ì—ì„œ í‚¤ì›Œë“œ ë¶„ì„ ì‚¬ì´íŠ¸ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”</span>';
        return;
      }

      let html = '';
      state.keywordSites.forEach(site => {
        if (site.url) {
          html += `
            <a href="${site.url}" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: white; border-radius: 10px; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='none'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
              <div style="width: 10px; height: 10px; background: ${site.color}; border-radius: 3px;"></div>
              <span style="font-size: 13px; font-weight: 600; color: ${site.color};">${site.name}</span>
              <span style="font-size: 12px; color: var(--gray-400);">â†—</span>
            </a>
          `;
        }
      });

      if (!html) {
        html = '<span style="color: #7C3AED; font-size: 13px;">ë“±ë¡ëœ ì‚¬ì´íŠ¸ì— URLì´ ì—†ìŠµë‹ˆë‹¤</span>';
      }

      container.innerHTML = html;
    }

    // í‚¤ì›Œë“œ ì‚¬ì´íŠ¸ ë¡œë“œ
    async function loadKeywordSites() {
      try {
        const snapshot = await db.collection('keywordSites').orderBy('createdAt', 'asc').get();
        state.keywordSites = [];
        snapshot.forEach(doc => {
          state.keywordSites.push({ id: doc.id, ...doc.data() });
        });
        // ê¸°ë³¸ ì‚¬ì´íŠ¸ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
        if (state.keywordSites.length === 0) {
          for (const site of DEFAULT_KEYWORD_SITES) {
            await db.collection('keywordSites').doc(site.id).set({
              name: site.name,
              url: site.url,
              color: site.color,
              createdAt: new Date().toISOString()
            });
          }
          state.keywordSites = DEFAULT_KEYWORD_SITES.map(s => ({ ...s, createdAt: new Date().toISOString() }));
        }
      } catch (error) {
        console.error('í‚¤ì›Œë“œ ì‚¬ì´íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        state.keywordSites = DEFAULT_KEYWORD_SITES;
      }
    }

    // í‚¤ì›Œë“œ ëª©ë¡ ë¡œë“œ
    async function loadKeywords() {
      try {
        const snapshot = await db.collection('trendKeywords').orderBy('createdAt', 'desc').get();
        state.keywords = [];
        snapshot.forEach(doc => {
          state.keywords.push({ id: doc.id, ...doc.data() });
        });
        renderKeywordList(state.keywords);
      } catch (error) {
        console.error('í‚¤ì›Œë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('keywordList').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-600);">í‚¤ì›Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
      }
    }

    // TOP í‚¤ì›Œë“œ ë°ì´í„° ë¡œë“œ
    async function loadTopKeywordsData() {
      try {
        const snapshot = await db.collection('topKeywords').get();
        state.topKeywords = {};
        snapshot.forEach(doc => {
          state.topKeywords[doc.id] = doc.data();
        });
      } catch (error) {
        console.error('TOP í‚¤ì›Œë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function initTopKeywordMonthSelect() {
      const select = document.getElementById('topKeywordMonth');
      if (!select) return;

      const now = new Date();
      let html = '';
      for (let i = 0; i < 12; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        const label = `${d.getFullYear()}ë…„ ${d.getMonth() + 1}ì›”`;
        html += `<option value="${val}" ${i === 0 ? 'selected' : ''}>${label}</option>`;
      }
      select.innerHTML = html;
    }

    // TOP 5 í‚¤ì›Œë“œ ë¡œë“œ ë° í‘œì‹œ
    function loadTopKeywords() {
      const select = document.getElementById('topKeywordMonth');
      const container = document.getElementById('topKeywordsList');
      if (!select || !container) return;

      const month = select.value;
      const topData = state.topKeywords[month];

      // ìˆ˜ë™ ì…ë ¥ í˜•ì‹ í™•ì¸ (manualKeywords ë°°ì—´)
      const manualKeywords = topData?.manualKeywords || [];
      // ê¸°ì¡´ ì„ íƒ í˜•ì‹ í™•ì¸ (keywords ë°°ì—´)
      const legacyKeywords = topData?.keywords || [];

      if (manualKeywords.length === 0 && legacyKeywords.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #92400E; width: 100%;">TOP 5 í‚¤ì›Œë“œë¥¼ ì„ ì •í•´ì£¼ì„¸ìš”</div>';
        return;
      }

      let html = '';

      // ìˆ˜ë™ ì…ë ¥ í˜•ì‹ (ìš°ì„ )
      if (manualKeywords.length > 0) {
        manualKeywords.forEach((keyword, idx) => {
          html += `
            <div style="background: white; border-radius: 12px; padding: 16px 20px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-width: 200px;">
              <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px;">${idx + 1}</div>
              <div style="font-weight: 600; font-size: 15px; color: var(--gray-900);">${keyword}</div>
            </div>
          `;
        });
      } else {
        // ê¸°ì¡´ ì„ íƒ í˜•ì‹ (í•˜ìœ„ í˜¸í™˜)
        legacyKeywords.forEach((kw, idx) => {
          const site = state.keywordSites.find(s => s.id === kw.siteId);
          html += `
            <div style="background: white; border-radius: 12px; padding: 16px 20px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-width: 200px;">
              <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px;">${idx + 1}</div>
              <div>
                <div style="font-weight: 600; font-size: 15px; color: var(--gray-900);">${kw.keyword}</div>
                <div style="font-size: 12px; color: var(--gray-500);">${site?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'} Â· ${kw.category || 'ë¯¸ë¶„ë¥˜'}</div>
              </div>
            </div>
          `;
        });
      }
      container.innerHTML = html;
    }

    // ì‚¬ì´íŠ¸ í•„í„° ë²„íŠ¼ ë Œë”ë§
    function renderKeywordSiteFilters() {
      const container = document.getElementById('keywordSiteFilters');
      if (!container) return;

      let html = '<button onclick="setKeywordSiteFilter(\'all\')" class="keyword-site-btn active" data-site="all" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; background: var(--primary); color: white;">ì „ì²´</button>';

      state.keywordSites.forEach(site => {
        html += `<button onclick="setKeywordSiteFilter('${site.id}')" class="keyword-site-btn" data-site="${site.id}" style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; background: ${site.color}20; color: ${site.color};">${site.name}</button>`;
      });

      container.innerHTML = html;
    }

    // ì‚¬ì´íŠ¸ í•„í„° ì„¤ì •
    function setKeywordSiteFilter(siteId) {
      keywordSiteFilter = siteId;

      document.querySelectorAll('.keyword-site-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.site === siteId) {
          btn.classList.add('active');
          if (siteId === 'all') {
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';
          } else {
            const site = state.keywordSites.find(s => s.id === siteId);
            btn.style.background = site?.color || 'var(--primary)';
            btn.style.color = 'white';
          }
        } else {
          if (btn.dataset.site === 'all') {
            btn.style.background = 'var(--gray-100)';
            btn.style.color = 'var(--gray-600)';
          } else {
            const site = state.keywordSites.find(s => s.id === btn.dataset.site);
            btn.style.background = (site?.color || '#6B7280') + '20';
            btn.style.color = site?.color || '#6B7280';
          }
        }
      });

      filterKeywords();
    }

    // í‚¤ì›Œë“œ í•„í„°ë§
    function filterKeywords() {
      const search = document.getElementById('keywordSearch')?.value.toLowerCase() || '';
      keywordSearchQuery = search;

      const filtered = state.keywords.filter(kw => {
        const matchSite = keywordSiteFilter === 'all' || kw.siteId === keywordSiteFilter;
        const matchSearch = !search ||
          (kw.keyword || '').toLowerCase().includes(search) ||
          (kw.category || '').toLowerCase().includes(search) ||
          (kw.memo || '').toLowerCase().includes(search);
        return matchSite && matchSearch;
      });

      renderKeywordList(filtered);
    }

    // í‚¤ì›Œë“œ ëª©ë¡ ë Œë”ë§ (ë ˆí¼ëŸ°ìŠ¤ ì¹´ë“œ ìŠ¤íƒ€ì¼)
    function renderKeywordList(keywords) {
      const container = document.getElementById('keywordList');
      if (!container) return;

      if (keywords.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px; grid-column: 1 / -1; background: white; border-radius: 16px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
            <div style="font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ë“±ë¡ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <p style="color: var(--gray-600); margin-bottom: 20px;">ì¸ê¸° í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
            <button onclick="openAddKeywordModal()" class="btn btn-primary">+ ì²« í‚¤ì›Œë“œ ì¶”ê°€</button>
          </div>
        `;
        return;
      }

      let html = '';
      keywords.forEach(kw => {
        const site = state.keywordSites.find(s => s.id === kw.siteId);
        const date = kw.extractDate || kw.createdAt?.substring(0, 10) || '';
        const hasImage = kw.image;

        html += `
          <div onclick="openEditKeywordModal('${kw.id}')"
               style="background: white; border-radius: 16px; overflow: hidden; cursor: pointer; transition: all 0.2s;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #E5E8EB;"
               onmouseover="this.style.borderColor='${site?.color || '#F59E0B'}'; this.style.transform='translateY(-2px)'"
               onmouseout="this.style.borderColor='#E5E8EB'; this.style.transform='none'">
            ${hasImage ? `
              <div style="position: relative; width: 100%; height: 140px; background: #1a1a2e;">
                <img src="${kw.image}" style="width: 100%; height: 100%; object-fit: cover;">
              </div>
            ` : `
              <div style="position: relative; width: 100%; height: 140px; background: linear-gradient(135deg, #1a1a2e, #16213e); display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center;">
                  <div style="font-size: 48px; opacity: 0.7;">ğŸ”¥</div>
                </div>
              </div>
            `}
            <div style="padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 11px; padding: 4px 10px; background: ${site?.color || '#F59E0B'}20; color: ${site?.color || '#F59E0B'}; border-radius: 6px; font-weight: 600;">${site?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                <span style="font-size: 11px; color: #8B95A1;">${date}</span>
              </div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px; line-height: 1.4;">${kw.keyword}</div>
              ${kw.memo ? `<div style="font-size: 12px; color: #6B7684; margin-bottom: 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${kw.memo}</div>` : ''}
              <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                ${kw.url ? `<span style="font-size: 10px; padding: 3px 8px; background: #E8F3FF; color: #0064FF; border-radius: 4px;">ğŸ”— ë§í¬</span>` : ''}
                ${hasImage ? `<span style="font-size: 10px; padding: 3px 8px; background: #FEF3C7; color: #B45309; border-radius: 4px;">ğŸ–¼ï¸ 1ì¥</span>` : ''}
                ${kw.category ? `<span style="font-size: 11px; padding: 4px 8px; background: #F2F4F6; color: #6B7684; border-radius: 4px;">#${kw.category}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // í‚¤ì›Œë“œ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function openAddKeywordModal() {
      document.getElementById('keywordId').value = '';
      document.getElementById('keywordName').value = '';
      document.getElementById('keywordCategory').value = '';
      document.getElementById('keywordDate').value = new Date().toISOString().substring(0, 10);
      document.getElementById('keywordUrl').value = '';
      document.getElementById('keywordMemo').value = '';
      document.getElementById('deleteKeywordBtn').style.display = 'none';
      document.getElementById('keywordModalTitle').textContent = 'í‚¤ì›Œë“œ ì¶”ê°€';

      // ì´ë¯¸ì§€ ì´ˆê¸°í™”
      clearKeywordImage();

      // ì‚¬ì´íŠ¸ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
      const siteSelect = document.getElementById('keywordSiteId');
      siteSelect.innerHTML = '<option value="">ì‚¬ì´íŠ¸ ì„ íƒ</option>' +
        state.keywordSites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

      document.getElementById('keywordModal').classList.add('show');
    }

    // í‚¤ì›Œë“œ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    async function openEditKeywordModal(keywordId) {
      const kw = state.keywords.find(k => k.id === keywordId);
      if (!kw) return;

      document.getElementById('keywordId').value = kw.id;
      document.getElementById('keywordName').value = kw.keyword || '';
      document.getElementById('keywordCategory').value = kw.category || '';
      document.getElementById('keywordDate').value = kw.extractDate || '';
      document.getElementById('keywordUrl').value = kw.url || '';
      document.getElementById('keywordMemo').value = kw.memo || '';
      document.getElementById('deleteKeywordBtn').style.display = 'block';
      document.getElementById('keywordModalTitle').textContent = 'í‚¤ì›Œë“œ ìˆ˜ì •';

      // ì´ë¯¸ì§€ ë³µì›
      if (kw.image) {
        keywordPastedImage = kw.image;
        const preview = document.getElementById('keywordImagePreview');
        preview.innerHTML = `
          <div style="position: relative; display: inline-block;">
            <img src="${kw.image}" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
            <button onclick="clearKeywordImage(); event.stopPropagation();" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #EF4444; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">Ã—</button>
          </div>
        `;
        preview.style.display = 'block';
      } else {
        clearKeywordImage();
      }

      // ì‚¬ì´íŠ¸ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
      const siteSelect = document.getElementById('keywordSiteId');
      siteSelect.innerHTML = '<option value="">ì‚¬ì´íŠ¸ ì„ íƒ</option>' +
        state.keywordSites.map(s => `<option value="${s.id}" ${s.id === kw.siteId ? 'selected' : ''}>${s.name}</option>`).join('');

      document.getElementById('keywordModal').classList.add('show');
    }

    // í‚¤ì›Œë“œ ëª¨ë‹¬ ë‹«ê¸°
    function closeKeywordModal() {
      document.getElementById('keywordModal').classList.remove('show');
    }

    // í‚¤ì›Œë“œ ì €ì¥
    async function saveKeyword() {
      const id = document.getElementById('keywordId').value;
      const keyword = document.getElementById('keywordName').value.trim();
      const siteId = document.getElementById('keywordSiteId').value;
      const category = document.getElementById('keywordCategory').value.trim();
      const extractDate = document.getElementById('keywordDate').value;
      const url = document.getElementById('keywordUrl').value.trim();
      const memo = document.getElementById('keywordMemo').value.trim();

      if (!keyword || !siteId) {
        showToast('í‚¤ì›Œë“œì™€ ì¶œì²˜ ì‚¬ì´íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      try {
        const data = {
          keyword,
          siteId,
          category,
          extractDate,
          url,
          memo,
          image: keywordPastedImage || null,
          updatedAt: new Date().toISOString()
        };

        if (id) {
          await db.collection('trendKeywords').doc(id).update(data);
          showToast('í‚¤ì›Œë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          data.createdAt = new Date().toISOString();
          await db.collection('trendKeywords').add(data);
          showToast('í‚¤ì›Œë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        closeKeywordModal();
        clearKeywordImage();
        await loadKeywords();
      } catch (error) {
        console.error('í‚¤ì›Œë“œ ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // í‚¤ì›Œë“œ ì‚­ì œ
    async function deleteKeyword() {
      const id = document.getElementById('keywordId').value;
      if (!id) return;

      if (!confirm('ì´ í‚¤ì›Œë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('trendKeywords').doc(id).delete();
        showToast('í‚¤ì›Œë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        closeKeywordModal();
        await loadKeywords();
      } catch (error) {
        console.error('í‚¤ì›Œë“œ ì‚­ì œ ì˜¤ë¥˜:', error);
        showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // í‚¤ì›Œë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° í•¸ë“¤ëŸ¬
    function handleKeywordPaste(event) {
      const items = (event.clipboardData || event.originalEvent.clipboardData).items;

      for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
          const blob = item.getAsFile();
          const reader = new FileReader();

          reader.onload = function(e) {
            keywordPastedImage = e.target.result;
            const preview = document.getElementById('keywordImagePreview');
            preview.innerHTML = `
              <div style="position: relative; display: inline-block;">
                <img src="${keywordPastedImage}" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <button onclick="clearKeywordImage(); event.stopPropagation();" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #EF4444; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">Ã—</button>
              </div>
            `;
            preview.style.display = 'block';
            showToast('ì´ë¯¸ì§€ê°€ ë¶™ì—¬ë„£ì–´ì¡ŒìŠµë‹ˆë‹¤', 'success');
          };

          reader.readAsDataURL(blob);
          event.preventDefault();
          return;
        }
      }
    }

    // í‚¤ì›Œë“œ ì´ë¯¸ì§€ ì´ˆê¸°í™”
    function clearKeywordImage() {
      keywordPastedImage = null;
      const preview = document.getElementById('keywordImagePreview');
      if (preview) {
        preview.innerHTML = '';
        preview.style.display = 'none';
      }
    }

    // ì‚¬ì´íŠ¸ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
    function openKeywordSiteModal() {
      renderKeywordSiteList();
      document.getElementById('keywordSiteModal').classList.add('show');
    }

    // ì‚¬ì´íŠ¸ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
    function closeKeywordSiteModal() {
      document.getElementById('keywordSiteModal').classList.remove('show');
      renderKeywordSiteLinks();
      renderKeywordSiteFilters();
    }

    // ì‚¬ì´íŠ¸ ëª©ë¡ ë Œë”ë§
    function renderKeywordSiteList() {
      const container = document.getElementById('keywordSiteList');
      if (!container) return;

      if (state.keywordSites.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">ë“±ë¡ëœ ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      let html = '';
      state.keywordSites.forEach(site => {
        html += `
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--gray-50); border-radius: 10px;">
            <div style="width: 12px; height: 12px; background: ${site.color}; border-radius: 3px;"></div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px;">${site.name}</div>
              <div style="font-size: 12px; color: var(--gray-500);">${site.url || 'ë§í¬ ì—†ìŒ'}</div>
            </div>
            ${site.url ? `<a href="${site.url}" target="_blank" style="background: var(--info); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; text-decoration: none;">ë°”ë¡œê°€ê¸°</a>` : ''}
            <button onclick="deleteKeywordSite('${site.id}')" style="background: var(--danger-light); color: var(--danger); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // ì‚¬ì´íŠ¸ ì¶”ê°€
    async function addKeywordSite() {
      const name = document.getElementById('newSiteName').value.trim();
      const url = document.getElementById('newSiteUrl').value.trim();
      const color = document.getElementById('newSiteColor').value;

      if (!name) {
        showToast('ì‚¬ì´íŠ¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      try {
        await db.collection('keywordSites').add({
          name,
          url,
          color,
          createdAt: new Date().toISOString()
        });

        document.getElementById('newSiteName').value = '';
        document.getElementById('newSiteUrl').value = '';

        await loadKeywordSites();
        renderKeywordSiteList();
        showToast('ì‚¬ì´íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (error) {
        console.error('ì‚¬ì´íŠ¸ ì¶”ê°€ ì˜¤ë¥˜:', error);
        showToast('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // ì‚¬ì´íŠ¸ ì‚­ì œ
    async function deleteKeywordSite(siteId) {
      if (!confirm('ì´ ì‚¬ì´íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ì‚¬ì´íŠ¸ì˜ í‚¤ì›Œë“œëŠ” ìœ ì§€ë©ë‹ˆë‹¤.')) return;

      try {
        await db.collection('keywordSites').doc(siteId).delete();
        await loadKeywordSites();
        renderKeywordSiteList();
        showToast('ì‚¬ì´íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (error) {
        console.error('ì‚¬ì´íŠ¸ ì‚­ì œ ì˜¤ë¥˜:', error);
        showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // TOP 5 ì„ ì • ëª¨ë‹¬ ì—´ê¸°
    function openSelectTopKeywordsModal() {
      // í˜„ì¬ ì›” ê¸°ë³¸ ì„¤ì •
      const now = new Date();
      const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const monthInput = document.getElementById('topKeywordSelectMonth');
      monthInput.value = month;

      // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¡œë“œ
      const topData = state.topKeywords[month];
      const manualKeywords = topData?.manualKeywords || [];

      // 5ê°œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      for (let i = 1; i <= 5; i++) {
        const input = document.getElementById(`topKeyword${i}`);
        if (input) {
          input.value = manualKeywords[i - 1] || '';
        }
      }

      document.getElementById('selectTopKeywordsModal').classList.add('show');
    }

    // ì›” ì„ íƒ ë³€ê²½ì‹œ ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
    function onTopKeywordMonthChange() {
      const month = document.getElementById('topKeywordSelectMonth').value;
      const topData = state.topKeywords[month];
      const manualKeywords = topData?.manualKeywords || [];

      for (let i = 1; i <= 5; i++) {
        const input = document.getElementById(`topKeyword${i}`);
        if (input) {
          input.value = manualKeywords[i - 1] || '';
        }
      }
    }

    // TOP 5 ì„ ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeSelectTopKeywordsModal() {
      document.getElementById('selectTopKeywordsModal').classList.remove('show');
    }

    // TOP í‚¤ì›Œë“œ ì„ íƒ ëª©ë¡ ë Œë”ë§
    function renderTopKeywordSelectionList() {
      const container = document.getElementById('topKeywordSelectionList');
      const searchInput = document.getElementById('topKeywordSearchInput');
      const search = searchInput?.value.toLowerCase() || '';

      const filtered = state.keywords.filter(kw => {
        return !search ||
          (kw.keyword || '').toLowerCase().includes(search) ||
          (kw.category || '').toLowerCase().includes(search);
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      let html = '';
      filtered.forEach(kw => {
        const site = state.keywordSites.find(s => s.id === kw.siteId);
        const isSelected = selectedTopKeywords.some(s => s.id === kw.id);

        html += `
          <div onclick="toggleTopKeywordSelection('${kw.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: ${isSelected ? '#FEF3C7' : 'var(--gray-50)'}; border: 2px solid ${isSelected ? '#F59E0B' : 'transparent'}; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
            <div style="width: 24px; height: 24px; border: 2px solid ${isSelected ? '#F59E0B' : 'var(--gray-300)'}; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: ${isSelected ? '#F59E0B' : 'white'}; color: white; font-size: 14px;">${isSelected ? 'âœ“' : ''}</div>
            <div style="width: 8px; height: 30px; background: ${site?.color || '#6B7280'}; border-radius: 4px;"></div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px;">${kw.keyword}</div>
              <div style="font-size: 12px; color: var(--gray-500);">${site?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'} Â· ${kw.category || 'ë¯¸ë¶„ë¥˜'}</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // TOP í‚¤ì›Œë“œ ì„ íƒ í•„í„°ë§
    function filterTopKeywordSelection() {
      renderTopKeywordSelectionList();
    }

    // TOP í‚¤ì›Œë“œ ì„ íƒ/í•´ì œ í† ê¸€
    function toggleTopKeywordSelection(keywordId) {
      const kw = state.keywords.find(k => k.id === keywordId);
      if (!kw) return;

      const idx = selectedTopKeywords.findIndex(s => s.id === keywordId);
      if (idx >= 0) {
        selectedTopKeywords.splice(idx, 1);
      } else {
        if (selectedTopKeywords.length >= 5) {
          showToast('ìµœëŒ€ 5ê°œê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'warning');
          return;
        }
        selectedTopKeywords.push({
          id: kw.id,
          keyword: kw.keyword,
          siteId: kw.siteId,
          category: kw.category
        });
      }

      renderTopKeywordSelectionList();
      updateSelectedTopCount();
    }

    // ì„ íƒëœ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    function updateSelectedTopCount() {
      const el = document.getElementById('selectedTopCount');
      if (el) {
        el.textContent = `ì„ íƒ: ${selectedTopKeywords.length}/5`;
      }
    }

    // TOP 5 ì €ì¥ (ê¸°ì¡´ ì„ íƒ ë°©ì‹ - ë¯¸ì‚¬ìš©)
    async function saveTopKeywords() {
      if (selectedTopKeywords.length === 0) {
        showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ í‚¤ì›Œë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      const month = document.getElementById('topKeywordSelectMonth').value;
      if (!month) {
        showToast('ì„ ì • ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      try {
        await db.collection('topKeywords').doc(month).set({
          keywords: selectedTopKeywords,
          updatedAt: new Date().toISOString(),
          updatedBy: state.currentUser?.name || 'Unknown'
        });

        state.topKeywords[month] = {
          keywords: selectedTopKeywords,
          updatedAt: new Date().toISOString()
        };

        showToast('TOP 5 í‚¤ì›Œë“œê°€ ì„ ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        closeSelectTopKeywordsModal();

        // ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì €ì¥í•œ ì›”ë¡œ ë³€ê²½í•˜ê³  í‘œì‹œ
        const monthSelect = document.getElementById('topKeywordMonth');
        if (monthSelect) {
          monthSelect.value = month;
        }
        loadTopKeywords();
      } catch (error) {
        console.error('TOP í‚¤ì›Œë“œ ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // TOP 5 ìˆ˜ë™ ì…ë ¥ ì €ì¥
    async function saveTopKeywordsManual() {
      const month = document.getElementById('topKeywordSelectMonth').value;
      if (!month) {
        showToast('ì„ ì • ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      // 5ê°œ ì…ë ¥ í•„ë“œì—ì„œ ê°’ ìˆ˜ì§‘
      const manualKeywords = [];
      for (let i = 1; i <= 5; i++) {
        const input = document.getElementById(`topKeyword${i}`);
        const value = input?.value.trim() || '';
        if (value) {
          manualKeywords.push(value);
        }
      }

      if (manualKeywords.length === 0) {
        showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      try {
        await db.collection('topKeywords').doc(month).set({
          manualKeywords: manualKeywords,
          updatedAt: new Date().toISOString(),
          updatedBy: state.currentUser?.name || 'Unknown'
        });

        state.topKeywords[month] = {
          manualKeywords: manualKeywords,
          updatedAt: new Date().toISOString()
        };

        showToast('TOP 5 í‚¤ì›Œë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        closeSelectTopKeywordsModal();

        // ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì €ì¥í•œ ì›”ë¡œ ë³€ê²½í•˜ê³  í‘œì‹œ
        const monthSelect = document.getElementById('topKeywordMonth');
        if (monthSelect) {
          monthSelect.value = month;
        }
        loadTopKeywords();
      } catch (error) {
        console.error('TOP í‚¤ì›Œë“œ ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // ========================================
    // OKR íŠ¸ë˜ì»¤ ê¸°ëŠ¥
    // ========================================

    // ë¯¸íŒ… íƒ€ì… ì •ì˜
    const MEETING_TYPES = {
      CEO_REPORT: { id: 'ceo_report', name: 'ëŒ€í‘œ ë³´ê³ ', icon: 'ğŸ‘”', color: '#8B5CF6' },
      KPI_REVIEW: { id: 'kpi_review', name: 'íŒ€ KPI ì¸¡ì •', icon: 'ğŸ“Š', color: '#3B82F6' },
      CONFIRM: { id: 'confirm', name: 'ì»¨íŒ', icon: 'âœ…', color: '#10B981' },
      PARTNER: { id: 'partner', name: 'íŒŒíŠ¸ë„ˆ ë¯¸íŒ…', icon: 'ğŸ¤', color: '#F59E0B' },
      INTERNAL: { id: 'internal', name: 'ë‚´ë¶€ íšŒì˜', icon: 'ğŸ’¬', color: '#6366F1' },
      ONE_ON_ONE: { id: 'one_on_one', name: '1:1', icon: 'ğŸ‘¥', color: '#EC4899' }
    };

    const MEETING_STATUS = {
      SCHEDULED: 'scheduled',    // ì˜ˆì •
      IN_PROGRESS: 'in_progress', // ì§„í–‰ì¤‘
      COMPLETED: 'completed',     // ì™„ë£Œ
      CANCELLED: 'cancelled'      // ì·¨ì†Œ
    };

    let okrState = {
      objective: null,
      keyResults: [],
      kpis: [],
      laggingIndicators: [],
      dailyLogs: [],
      todayLogs: [],
      personalTargets: [],  // ê°œì¸ ëª©í‘œ (íŒ€ KPIì™€ ë³„ê°œ)
      meetings: [],  // ë¯¸íŒ… ì¼ì§€
      favorites: JSON.parse(localStorage.getItem('okrFavorites') || '[]'),
      expandedKRs: [],
      searchQuery: '',
      showFavoritesOnly: false,
      // KPI í•„í„° ì„¤ì • (localStorage ìœ ì§€)
      kpiFilter: JSON.parse(localStorage.getItem('okrKpiFilter') || JSON.stringify({
        period: 'all',      // all, thisWeek, thisMonth, custom
        krId: 'all',        // all ë˜ëŠ” íŠ¹ì • KR ID
        status: 'all',      // all, inProgress, completed, behind
        memberId: 'all'     // all ë˜ëŠ” íŠ¹ì • íŒ€ì› ID
      })),
      okrPeriod: 'quarterly',  // quarterly, monthly, weekly
      // ë²„ì „ ê´€ë¦¬ (localStorage ìœ ì§€)
      versions: JSON.parse(localStorage.getItem('okrVersions') || JSON.stringify([
        { id: 'A', name: 'A', description: '', fixed: true }
      ]))
    };

    const okrToday = new Date().toISOString().split('T')[0];
    const okrColors = ['#8B5CF6', '#06B6D4', '#10B981', '#F59E0B'];
    const okrIcons = ['ğŸ’°', 'ğŸ‘¥', 'ğŸ“±', 'ğŸ“¢'];

    // ê¸ˆì•¡ì„ í•œêµ­ì–´ ìš”ì•½ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì˜ˆ: 800000000 -> "8ì–µ")
    function formatKoreanAmount(num) {
      if (!num || num === 0) return '';
      const absNum = Math.abs(num);
      if (absNum >= 100000000) { // ì–µ ë‹¨ìœ„
        const eok = absNum / 100000000;
        return eok % 1 === 0 ? `${eok}ì–µ` : `${eok.toFixed(1)}ì–µ`;
      } else if (absNum >= 10000000) { // ì²œë§Œ ë‹¨ìœ„
        const cheonman = absNum / 10000000;
        return cheonman % 1 === 0 ? `${cheonman}ì²œë§Œ` : `${cheonman.toFixed(1)}ì²œë§Œ`;
      } else if (absNum >= 1000000) { // ë°±ë§Œ ë‹¨ìœ„
        const baekman = absNum / 1000000;
        return baekman % 1 === 0 ? `${baekman}ë°±ë§Œ` : `${baekman.toFixed(1)}ë°±ë§Œ`;
      } else if (absNum >= 10000) { // ë§Œ ë‹¨ìœ„
        const man = absNum / 10000;
        return man % 1 === 0 ? `${man}ë§Œ` : `${man.toFixed(1)}ë§Œ`;
      }
      return num.toLocaleString();
    }

    // ê¸ˆì•¡ í‘œì‹œ (ì›ë³¸ + ìš”ì•½) - ë‹¨ìœ„ê°€ 'ì›'ì¼ ë•Œë§Œ ìš”ì•½ í‘œì‹œ
    function formatAmountWithSummary(num, unit = '') {
      if (!num && num !== 0) return '-';
      const formatted = num.toLocaleString();
      if (unit === 'ì›' && num >= 10000) {
        return `${formatted}(${formatKoreanAmount(num)})${unit}`;
      }
      return `${formatted} ${unit}`.trim();
    }

    // OKR ë°ì´í„° ë¡œë“œ
    async function loadOkrData() {
      try {
        // O (ëª©í‘œ)
        const objSnapshot = await db.collection('okr_objective').limit(1).get();
        okrState.objective = objSnapshot.docs.length > 0
          ? { id: objSnapshot.docs[0].id, ...objSnapshot.docs[0].data() }
          : null;

        // KR
        const krSnapshot = await db.collection('okr_keyResults').orderBy('order').get();
        okrState.keyResults = krSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // KPI
        const kpiSnapshot = await db.collection('okr_kpis').orderBy('order').get();
        okrState.kpis = kpiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì§€í‘œ (í™œë™/ì„±ê³¼)
        const lagSnapshot = await db.collection('okr_laggingIndicators').get();
        okrState.laggingIndicators = lagSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì—…ë¬´ì¼ì§€ (ìµœê·¼ 30ì¼)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const logSnapshot = await db.collection('okr_dailyLogs')
          .where('date', '>=', thirtyDaysAgo.toISOString().split('T')[0])
          .orderBy('date', 'desc')
          .get();
        okrState.dailyLogs = logSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        okrState.todayLogs = okrState.dailyLogs.filter(log => log.date === okrToday);

        // ê°œì¸ ëª©í‘œ ë¡œë“œ
        const personalTargetSnapshot = await db.collection('okr_personalTargets').get();
        okrState.personalTargets = personalTargetSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ë¯¸íŒ… ì¼ì§€ ë¡œë“œ (ìµœê·¼ 90ì¼)
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
        const meetingSnapshot = await db.collection('okr_meetings')
          .where('date', '>=', ninetyDaysAgo.toISOString().split('T')[0])
          .orderBy('date', 'desc')
          .get();
        okrState.meetings = meetingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // ì´ˆê¸° ë°ì´í„° ì—†ìœ¼ë©´ ì‹œë“œ
        if (!okrState.objective) {
          await seedOkrInitialData();
        }

        // ë¯¸íŒ… ë¦¬ë§ˆì¸ë” ì²´í¬ (ì•Œë¦¼ ìƒì„±)
        setTimeout(() => checkMeetingReminders(), 1000);

      } catch (e) {
        console.error('OKR ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }

    // OKR ì´ˆê¸° ë°ì´í„° ì‹œë“œ
    async function seedOkrInitialData() {
      try {
        showToast('OKR ì´ˆê¸° ë°ì´í„° ìƒì„± ì¤‘...', 'info');

        const objRef = await db.collection('okr_objective').add({
          name: '26ë…„ë„ PMFë¥¼ ì°¾ëŠ” ë‹¨ê³„, ë¹ ë¥¸ ë°ì´í„° ì¶”ì¶œ ë° ê°œì„ í•˜ì—¬ ì—° 10ì–µ ë§¤ì¶œ ë‹¬ì„±',
          startDate: '2026-01-01',
          endDate: '2026-12-31',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        const krData = [
          { name: 'ğŸ’° ì—°ë§¤ì¶œ 10ì–µ ë‹¬ì„±', targetValue: 1000000000, unit: 'ì›', order: 1 },
          { name: 'ğŸ‘¥ íŒŒíŠ¸ë„ˆ ë„¤íŠ¸ì›Œí¬ í™•ë³´', targetValue: 500, unit: 'ëª…/ê³³', order: 2 },
          { name: 'ğŸ“± í”Œë«í¼ í’ˆì§ˆ í–¥ìƒ', targetValue: 80, unit: '%', order: 3 },
          { name: 'ğŸ“¢ ë¸Œëœë“œ ì¸ì§€ë„ í™•ë¦½', targetValue: 70, unit: '%', order: 4 }
        ];

        const krIds = [];
        for (const kr of krData) {
          const krRef = await db.collection('okr_keyResults').add({
            ...kr, objectiveId: objRef.id,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          krIds.push(krRef.id);
        }

        const kpiData = {
          [krIds[0]]: [
            { name: 'êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ', targetValue: 800000000, unit: 'ì›', order: 1, lags: [{version:'A',name:'ì „í™” ìƒë‹´'},{version:'B',name:'ì´ë©”ì¼ ìº í˜ì¸'},{version:'C',name:'í˜„ì¥ ë¯¸íŒ…'}] },
            { name: 'í•´ì™¸ ìˆ˜ì¶œ ë§¤ì¶œ', targetValue: 100000000, unit: 'ì›', order: 2, lags: [{version:'A',name:'ëŒ€ë§Œ ìˆ˜ì¶œ'},{version:'B',name:'ë² íŠ¸ë‚¨ ìˆ˜ì¶œ'}] },
            { name: 'í•´ì™¸ ìˆ˜ì… ë§¤ì¶œ', targetValue: 100000000, unit: 'ì›', order: 3, lags: [{version:'A',name:'ë¯¸êµ­ ìˆ˜ì…'},{version:'B',name:'ì¼ë³¸ ìˆ˜ì…'}] }
          ],
          [krIds[1]]: [
            { name: 'ê³µê¸‰ì‚¬ í™•ë³´', targetValue: 200, unit: 'ê³³', order: 1, lags: [{version:'A',name:'ì‹ ê·œ ë°œêµ´'},{version:'B',name:'ì†Œê°œì‚¬ì´íŠ¸ ìœ ì…'}] },
            { name: 'í™œì„± ì…€ëŸ¬ í™•ë³´', targetValue: 300, unit: 'ëª…', order: 2, lags: [{version:'A',name:'ì‹ ê·œ ê°€ì…'},{version:'B',name:'ì— ë²„ì„œë” ì „í™˜'}] }
          ],
          [krIds[2]]: [
            { name: 'êµ¬ë§¤ ì „í™˜ìœ¨', targetValue: 80, unit: '%', order: 1, lags: [{version:'A',name:'UX/UI ê°œì„ '},{version:'B',name:'ì•± ìµœì í™”'}] },
            { name: 'ì‹œìŠ¤í…œ ì™„ì„±ë„', targetValue: 70, unit: '%', order: 2, lags: [{version:'A',name:'ìš´ì˜ì„¼í„° ê³ ë„í™”'},{version:'B',name:'CRMì„¼í„° ê³ ë„í™”'}] }
          ],
          [krIds[3]]: [
            { name: 'ë§ˆì¼€íŒ… ì„±ê³¼', targetValue: 70, unit: '%', order: 1, lags: [{version:'A',name:'ì¸í”Œë£¨ì–¸ì„œ í˜‘ì—…'},{version:'B',name:'í¼í¬ë¨¼ìŠ¤ ë§ˆì¼€íŒ…'}] },
            { name: 'í™ë³´ ì½˜í…ì¸ ', targetValue: 50, unit: 'ê±´', order: 2, lags: [{version:'A',name:'ì½˜í…ì¸  ì œì‘'},{version:'B',name:'ê³µì‹ í™ë³´'}] }
          ]
        };

        for (const krId of Object.keys(kpiData)) {
          for (const kpi of kpiData[krId]) {
            const { lags, ...kpiInfo } = kpi;
            const kpiRef = await db.collection('okr_kpis').add({
              ...kpiInfo, keyResultId: krId,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            for (const lag of lags) {
              await db.collection('okr_laggingIndicators').add({
                kpiId: kpiRef.id, version: lag.version, name: lag.name,
                totalValue: 0, logCount: 0, isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
        }

        await loadOkrData();
        showToast('OKR ì´ˆê¸° ë°ì´í„° ìƒì„± ì™„ë£Œ!', 'success');
      } catch (e) {
        console.error('OKR ì´ˆê¸° ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', e);
      }
    }

    // OKR ê³„ì‚° í•¨ìˆ˜ë“¤
    function calcOkrObjectiveRate() {
      if (okrState.keyResults.length === 0) return 0;
      const rates = okrState.keyResults.map(kr => calcOkrKRRate(kr.id));
      return Math.round(rates.reduce((a, b) => a + b, 0) / rates.length);
    }

    function calcOkrKRRate(krId) {
      const kpisForKR = okrState.kpis.filter(k => k.keyResultId === krId);
      if (kpisForKR.length === 0) return 0;
      const rates = kpisForKR.map(kpi => calcOkrKPIRate(kpi.id));
      return Math.round(rates.reduce((a, b) => a + b, 0) / rates.length);
    }

    function calcOkrKPIRate(kpiId) {
      const kpi = okrState.kpis.find(k => k.id === kpiId);
      if (!kpi || !kpi.targetValue) return 0;

      // ì„±ê³¼í˜•(result) ì§€í‘œë§Œ KPI ë‹¬ì„±ë¥ ì— ë°˜ì˜
      const resultLags = okrState.laggingIndicators.filter(l => l.kpiId === kpiId && l.type === 'result');

      const totalValue = resultLags.reduce((sum, lag) => {
        const logs = okrState.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
        const logSum = logs.reduce((s, l) => s + (l.resultValue || 0), 0);

        // ê±´ë‹¹ ì˜ˆìƒ ê¸ˆì•¡ì´ ìˆìœ¼ë©´ ê³±í•˜ê¸°, ì—†ìœ¼ë©´ ì§ì ‘ í•©ì‚°
        if (lag.valuePerUnit && lag.valuePerUnit > 0) {
          return sum + (logSum * lag.valuePerUnit);
        }
        return sum + logSum;
      }, 0);

      return Math.min(Math.round((totalValue / kpi.targetValue) * 100), 100);
    }

    // í™œë™í˜• ì§€í‘œ í†µê³„ ê³„ì‚°
    function calcActivityStats(kpiId) {
      const activityLags = okrState.laggingIndicators.filter(l => l.kpiId === kpiId && l.type !== 'result');
      return activityLags.reduce((sum, lag) => {
        const logs = okrState.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
        return sum + logs.reduce((s, l) => s + (l.resultValue || 0), 0);
      }, 0);
    }

    // OKR ì•„ì´ì½˜ ë°˜í™˜
    function getOkrLagIcon(name) {
      if (name.includes('ì „í™”') || name.includes('ìƒë‹´')) return 'ğŸ“';
      if (name.includes('ì´ë©”ì¼')) return 'ğŸ“§';
      if (name.includes('ë¯¸íŒ…') || name.includes('ë°©ë¬¸')) return 'ğŸ¤';
      if (name.includes('ë§¤ì¶œ') || name.includes('ê³„ì•½')) return 'ğŸ’µ';
      if (name.includes('ì…€ëŸ¬') || name.includes('ê°€ì…')) return 'ğŸ‘¤';
      if (name.includes('ê³µê¸‰ì‚¬') || name.includes('ë°œêµ´')) return 'ğŸ­';
      if (name.includes('ì½˜í…ì¸ ')) return 'ğŸ“±';
      if (name.includes('ê´‘ê³ ') || name.includes('ë§ˆì¼€íŒ…')) return 'ğŸ“£';
      if (name.includes('ìˆ˜ì¶œ') || name.includes('ìˆ˜ì…')) return 'ğŸŒ';
      if (name.includes('UX') || name.includes('UI') || name.includes('ê°œì„ ') || name.includes('ìµœì í™”')) return 'ğŸ¨';
      if (name.includes('ë¸Œëœë“œ') || name.includes('í™ë³´')) return 'ğŸ·ï¸';
      if (name.includes('í¬í„¸') || name.includes('ì‹œìŠ¤í…œ') || name.includes('ì„¼í„°')) return 'ğŸ’»';
      return 'âœ…';
    }

    // OKR ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    function renderOkrDashboard() {
      const container = document.getElementById('okrDashboardContent');
      if (!container) return;

      if (!okrState.objective) {
        container.innerHTML = `<div class="card" style="text-align: center; padding: 60px;"><div style="font-size: 64px; margin-bottom: 16px;">ğŸ¯</div><div style="font-size: 18px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div><div style="font-size: 14px; color: var(--gray-500); margin-bottom: 20px;">[ëª©í‘œ ì„¤ì •] íƒ­ì—ì„œ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div><button class="btn btn-primary" onclick="switchTab('okr-settings')">ëª©í‘œ ì„¤ì •í•˜ê¸°</button></div>`;
        return;
      }

      const oRate = calcOkrObjectiveRate();
      const krRates = okrState.keyResults.map(kr => ({ ...kr, rate: calcOkrKRRate(kr.id) }));

      // KPI í˜„í™© ë°ì´í„° ì¤€ë¹„
      const kpiStatusData = okrState.kpis.map(kpi => {
        const kr = okrState.keyResults.find(k => k.id === kpi.keyResultId);
        const krIdx = okrState.keyResults.findIndex(k => k.id === kpi.keyResultId);
        const rate = calcOkrKPIRate(kpi.id);
        const lagsForKPI = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
        const currentValue = lagsForKPI.reduce((sum, lag) => {
          const lagLogs = okrState.dailyLogs.filter(log => log.laggingIndicatorId === lag.id);
          return sum + lagLogs.reduce((s, l) => s + (l.resultValue || 0), 0);
        }, 0);
        return { ...kpi, kr, krIdx, rate, currentValue };
      });

      container.innerHTML = `
        <!-- í—¤ë” -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <h2 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin: 0;">ğŸ“ˆ íŒ€ ê·¸ë¡œìŠ¤ë³´ë“œ</h2>
            <p style="color: var(--gray-500); margin-top: 4px; font-size: 13px;">ëª©í‘œ â†’ KR â†’ KPI â†’ ì§€í‘œ</p>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="openMeetingModal()" style="padding: 10px 18px; font-size: 13px; font-weight: 600; background: #10B981; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
              ğŸ“… ë¯¸íŒ… ë“±ë¡
            </button>
            <button onclick="openSecretLinkModal()" style="padding: 10px 18px; font-size: 13px; font-weight: 600; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
              ğŸ”— ì™¸ë¶€ ê³µìœ 
            </button>
          </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, var(--primary), #8B5CF6); color: white; padding: 28px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
              <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px; line-height: 1.4;">${okrState.objective.name}</div>
              <div style="font-size: 13px; opacity: 0.9; margin-bottom: 20px;">${okrState.objective.startDate || ''} ~ ${okrState.objective.endDate || ''}</div>
            </div>
            <div style="position: relative;">
              <span onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'" style="width: 24px; height: 24px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: 700;">?</span>
              <div style="display: none; position: absolute; top: 32px; right: 0; background: white; color: var(--gray-700); padding: 16px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 280px; z-index: 100; font-size: 12px; line-height: 1.6;">
                <div style="font-weight: 700; color: var(--gray-900); margin-bottom: 10px; font-size: 13px;">ğŸ“Š O ë‹¬ì„±ë¥  ì‚°ì • ë°©ì‹</div>
                <div style="margin-bottom: 8px;"><strong>â€¢ O ë‹¬ì„±ë¥ </strong> = ëª¨ë“  KR ë‹¬ì„±ë¥ ì˜ í‰ê· </div>
                <div style="margin-bottom: 8px;"><strong>â€¢ KR ë‹¬ì„±ë¥ </strong> = í•´ë‹¹ KRì˜ ëª¨ë“  KPI ë‹¬ì„±ë¥  í‰ê· </div>
                <div><strong>â€¢ KPI ë‹¬ì„±ë¥ </strong> = (í˜„ì¬ ëˆ„ì ê°’ Ã· ëª©í‘œê°’) Ã— 100</div>
                <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--gray-200); color: var(--gray-500); font-size: 11px;">
                  ğŸ’¡ ì„±ê³¼í˜• ì§€í‘œë§Œ KPI ë‹¬ì„±ë¥ ì— ë°˜ì˜ë©ë‹ˆë‹¤
                </div>
              </div>
            </div>
          </div>
          <div style="font-size: 48px; font-weight: 800; margin-bottom: 12px;">${oRate}%</div>
          <div style="height: 12px; background: rgba(255,255,255,0.2); border-radius: 6px; overflow: hidden;">
            <div style="height: 100%; width: ${Math.min(oRate, 100)}%; background: white; border-radius: 6px; transition: width 0.5s;"></div>
          </div>
        </div>

        <!-- KR í˜„í™© -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">ğŸ“ˆ KR í˜„í™©</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            ${krRates.map((kr, idx) => {
              const krMeetings = okrState.meetings.filter(m => {
                // ì™„ë£Œëœ ë¯¸íŒ…ì€ actualKRIds ì‚¬ìš©, ì˜ˆì •/ì§„í–‰ì¤‘ì€ krIds ì‚¬ìš©
                const relevantKRIds = m.status === MEETING_STATUS.COMPLETED && m.actualKRIds
                  ? m.actualKRIds
                  : (m.krIds || [m.krId].filter(id => id));

                return m.isAllKRs || relevantKRIds.includes(kr.id);
              }).slice(0, 3);
              return `
              <div style="padding: 16px; border-radius: 12px; background: var(--gray-50); border-left: 4px solid ${okrColors[idx]};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;" onclick="switchTab('okr-record')" style="cursor: pointer;">
                  <div style="font-size: 13px; font-weight: 600; color: var(--gray-800); display: flex; align-items: center; gap: 6px;">
                    <span>${okrIcons[idx] || 'ğŸ“Š'}</span> ${kr.name}
                  </div>
                  <span style="padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; background: ${okrColors[idx]}20; color: ${okrColors[idx]}">${kr.rate}%</span>
                </div>
                <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; margin-bottom: 12px;">
                  <div style="height: 100%; width: ${Math.min(kr.rate, 100)}%; background: ${okrColors[idx]}; border-radius: 3px; transition: width 0.5s;"></div>
                </div>
                ${krMeetings.length > 0 ? `
                  <div style="padding-top: 12px; border-top: 1px solid var(--gray-200);">
                    <div style="font-size: 11px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px;">ğŸ“… ê´€ë ¨ ë¯¸íŒ… ${krMeetings.length}ê±´</div>
                    ${krMeetings.map(meeting => {
                      const meetingType = Object.values(MEETING_TYPES).find(t => t.id === meeting.type);
                      return `
                        <div onclick="event.stopPropagation(); openMeetingDetailModal('${meeting.id}')" style="padding: 6px 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 6px; border-left: 3px solid ${meetingType?.color || '#6366F1'};">
                          <span>${meetingType?.icon || 'ğŸ“…'}</span>
                          <span style="flex: 1; font-weight: 500; color: var(--gray-700);">${meeting.title}</span>
                          <span style="font-size: 10px; color: var(--gray-500);">${meeting.date}</span>
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : ''}
              </div>
            `;
            }).join('')}
          </div>
        </div>

        <!-- KPI í˜„í™© (í•„í„° ê¸°ëŠ¥ ì¶”ê°€) -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
            <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 8px;">ğŸ“Š KPI í˜„í™©</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <select id="kpiFilterPeriod" onchange="updateKpiFilter('period', this.value)" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 12px; cursor: pointer; background: white;">
                <option value="all" ${okrState.kpiFilter.period === 'all' ? 'selected' : ''}>ì „ì²´ ê¸°ê°„</option>
                <option value="thisWeek" ${okrState.kpiFilter.period === 'thisWeek' ? 'selected' : ''}>ì´ë²ˆ ì£¼</option>
                <option value="thisMonth" ${okrState.kpiFilter.period === 'thisMonth' ? 'selected' : ''}>ì´ë²ˆ ë‹¬</option>
              </select>
              <select id="kpiFilterKR" onchange="updateKpiFilter('krId', this.value)" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 12px; cursor: pointer; background: white;">
                <option value="all" ${okrState.kpiFilter.krId === 'all' ? 'selected' : ''}>ì „ì²´ KR</option>
                ${okrState.keyResults.map((kr, idx) => `<option value="${kr.id}" ${okrState.kpiFilter.krId === kr.id ? 'selected' : ''}>â— ${kr.name}</option>`).join('')}
              </select>
              <select id="kpiFilterStatus" onchange="updateKpiFilter('status', this.value)" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 12px; cursor: pointer; background: white;">
                <option value="all" ${okrState.kpiFilter.status === 'all' ? 'selected' : ''}>ì „ì²´ ìƒíƒœ</option>
                <option value="completed" ${okrState.kpiFilter.status === 'completed' ? 'selected' : ''}>âœ… ë‹¬ì„± (80%+)</option>
                <option value="inProgress" ${okrState.kpiFilter.status === 'inProgress' ? 'selected' : ''}>ğŸ”„ ì§„í–‰ ì¤‘ (50-79%)</option>
                <option value="behind" ${okrState.kpiFilter.status === 'behind' ? 'selected' : ''}>âš ï¸ ë¯¸ë‹¬ (50% ë¯¸ë§Œ)</option>
              </select>
              <select id="kpiFilterMember" onchange="updateKpiFilter('memberId', this.value)" style="padding: 6px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 12px; cursor: pointer; background: white;">
                <option value="all" ${okrState.kpiFilter.memberId === 'all' ? 'selected' : ''}>ì „ì²´ íŒ€ì›</option>
                ${(state.teamMembers || []).filter(m => m.role !== 'guest').map(member => `<option value="${member.id}" ${okrState.kpiFilter.memberId === member.id ? 'selected' : ''}>${member.name}${member.role === 'admin' ? ' ğŸ‘‘' : ''}</option>`).join('')}
              </select>
            </div>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead>
                <tr style="background: var(--gray-50);">
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">KR</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">KPI</th>
                  <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">ëª©í‘œ</th>
                  <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">í˜„ì¬</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">ë‹¬ì„±ë¥ </th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">ì§„í–‰</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); width: 50px;"></th>
                </tr>
              </thead>
              <tbody>
                ${(() => {
                  // í•„í„° ì ìš©
                  let filtered = kpiStatusData;
                  if (okrState.kpiFilter.krId !== 'all') {
                    filtered = filtered.filter(kpi => kpi.keyResultId === okrState.kpiFilter.krId);
                  }
                  if (okrState.kpiFilter.status !== 'all') {
                    if (okrState.kpiFilter.status === 'completed') filtered = filtered.filter(kpi => kpi.rate >= 80);
                    else if (okrState.kpiFilter.status === 'inProgress') filtered = filtered.filter(kpi => kpi.rate >= 50 && kpi.rate < 80);
                    else if (okrState.kpiFilter.status === 'behind') filtered = filtered.filter(kpi => kpi.rate < 50);
                  }
                  // íŒ€ì› í•„í„° ì ìš© (ì£¼ë‹´ë‹¹ ë˜ëŠ” ì„œë¸Œë‹´ë‹¹)
                  if (okrState.kpiFilter.memberId !== 'all') {
                    filtered = filtered.filter(kpi => {
                      const isMainAssignee = kpi.mainAssignee === okrState.kpiFilter.memberId;
                      const isSubAssignee = (kpi.subAssignees || []).includes(okrState.kpiFilter.memberId);
                      return isMainAssignee || isSubAssignee;
                    });
                  }
                  // KR ìˆœì„œëŒ€ë¡œ ì •ë ¬
                  filtered = filtered.sort((a, b) => a.krIdx - b.krIdx);

                  if (filtered.length === 0) {
                    return '<tr><td colspan="7" style="padding: 30px; text-align: center; color: var(--gray-400);">í•„í„° ì¡°ê±´ì— ë§ëŠ” KPIê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                  }

                  // KRë³„ rowspan ê³„ì‚°
                  const krGroups = {};
                  filtered.forEach(kpi => {
                    const krId = kpi.keyResultId;
                    if (!krGroups[krId]) krGroups[krId] = [];
                    krGroups[krId].push(kpi);
                  });

                  // ì´ë¯¸ ë Œë”ë§ëœ KR ì¶”ì 
                  const renderedKRs = new Set();

                  return filtered.map((kpi, idx) => {
                    const statusColor = kpi.rate >= 80 ? 'var(--success)' : kpi.rate >= 50 ? 'var(--warning)' : 'var(--danger)';
                    const krId = kpi.keyResultId;
                    const rowspan = krGroups[krId]?.length || 1;
                    const showKrCell = !renderedKRs.has(krId);

                    if (showKrCell) {
                      renderedKRs.add(krId);
                    }

                    return `
                      <tr style="border-bottom: 1px solid var(--gray-100);">
                        ${showKrCell ? `
                        <td style="padding: 12px; text-align: left; vertical-align: middle; background: ${okrColors[kpi.krIdx]}10;" rowspan="${rowspan}">
                          <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${okrColors[kpi.krIdx]}20; color: ${okrColors[kpi.krIdx]}; white-space: nowrap;">
                            <span style="font-size: 10px;">â—</span> ${kpi.kr?.name || '-'}
                          </span>
                        </td>
                        ` : ''}
                        <td style="padding: 12px; font-weight: 500; color: var(--gray-800);">
                          <div><span style="color: ${statusColor}; font-size: 10px;">â—</span> ${kpi.name}</div>
                          ${kpi.mainAssigneeName || (kpi.subAssigneeNames && kpi.subAssigneeNames.length > 0) ? `
                            <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">
                              ${kpi.mainAssigneeName ? `â­ ${kpi.mainAssigneeName}` : ''}
                              ${kpi.mainAssigneeName && kpi.subAssigneeNames && kpi.subAssigneeNames.length > 0 ? ' Â· ' : ''}
                              ${kpi.subAssigneeNames && kpi.subAssigneeNames.length > 0 ? `ğŸ“Œ ${kpi.subAssigneeNames.join(', ')}` : ''}
                            </div>
                          ` : ''}
                        </td>
                        <td style="padding: 12px; text-align: right; color: var(--gray-500);">${formatAmountWithSummary(kpi.targetValue || 0, kpi.unit || '')}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--gray-700);">${formatAmountWithSummary(kpi.currentValue, kpi.unit || '')}</td>
                        <td style="padding: 12px; text-align: center;">
                          <span style="font-weight: 700; color: ${statusColor};">${kpi.rate}%</span>
                        </td>
                        <td style="padding: 12px; width: 100px;">
                          <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(kpi.rate, 100)}%; background: ${statusColor}; border-radius: 3px;"></div>
                          </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                          <button onclick="showEditKPIModal('${kpi.id}')" style="padding: 4px 8px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; color: var(--gray-600); font-size: 11px; cursor: pointer;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='white'" title="KPI í¸ì§‘">âœï¸</button>
                        </td>
                      </tr>
                    `;
                  }).join('');
                })()}
              </tbody>
            </table>
          </div>
        </div>

        <!-- í™œë™ vs ì„±ê³¼ ìš”ì•½ -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">ğŸ“Š í™œë™ vs ì„±ê³¼ í˜„í™©</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <!-- í™œë™í˜• ìš”ì•½ -->
            <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; border-left: 4px solid var(--gray-400);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 14px; font-weight: 600; color: var(--gray-700); display: flex; align-items: center; gap: 6px;">
                  ğŸ“‹ í™œë™í˜• ì§€í‘œ
                </div>
                <span style="font-size: 11px; padding: 2px 8px; background: var(--gray-200); color: var(--gray-600); border-radius: 10px;">ì°¸ê³ ìš©</span>
              </div>
              ${(() => {
                const activityLags = okrState.laggingIndicators.filter(l => l.type !== 'result');
                const activityLogs = okrState.dailyLogs.filter(log => {
                  const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
                  return lag && lag.type !== 'result';
                });
                const totalActivityCount = activityLogs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
                const todayActivityCount = activityLogs.filter(l => l.date === okrToday).reduce((sum, l) => sum + (l.resultValue || 0), 0);
                return `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 13px; color: var(--gray-500);">ë“±ë¡ëœ ì§€í‘œ</span>
                    <span style="font-size: 14px; font-weight: 600;">${activityLags.length}ê°œ</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 13px; color: var(--gray-500);">ì´ í™œë™ íšŸìˆ˜</span>
                    <span style="font-size: 14px; font-weight: 600;">${totalActivityCount.toLocaleString()}ê±´</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 13px; color: var(--gray-500);">ì˜¤ëŠ˜ í™œë™</span>
                    <span style="font-size: 14px; font-weight: 600; color: var(--primary);">${todayActivityCount}ê±´</span>
                  </div>
                `;
              })()}
            </div>
            <!-- ì„±ê³¼í˜• ìš”ì•½ -->
            <div style="background: var(--success-light); border-radius: 12px; padding: 16px; border-left: 4px solid var(--success);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 14px; font-weight: 600; color: var(--gray-700); display: flex; align-items: center; gap: 6px;">
                  ğŸ’° ì„±ê³¼í˜• ì§€í‘œ
                </div>
                <span style="font-size: 11px; padding: 2px 8px; background: var(--success); color: white; border-radius: 10px;">KPI ë°˜ì˜</span>
              </div>
              ${(() => {
                const resultLags = okrState.laggingIndicators.filter(l => l.type === 'result');
                const resultLogs = okrState.dailyLogs.filter(log => {
                  const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
                  return lag && lag.type === 'result';
                });
                let totalResultValue = 0;
                let todayResultValue = 0;
                resultLogs.forEach(log => {
                  const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
                  const value = lag?.valuePerUnit > 0 ? (log.resultValue || 0) * lag.valuePerUnit : (log.resultValue || 0);
                  totalResultValue += value;
                  if (log.date === okrToday) todayResultValue += value;
                });
                return `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 13px; color: var(--gray-600);">ë“±ë¡ëœ ì§€í‘œ</span>
                    <span style="font-size: 14px; font-weight: 600;">${resultLags.length}ê°œ</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 13px; color: var(--gray-600);">ì´ ì„±ê³¼ ê¸ˆì•¡</span>
                    <span style="font-size: 14px; font-weight: 700; color: var(--success);">${formatAmountWithSummary(totalResultValue, 'ì›')}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 13px; color: var(--gray-600);">ì˜¤ëŠ˜ ì„±ê³¼</span>
                    <span style="font-size: 14px; font-weight: 700; color: var(--success);">${formatAmountWithSummary(todayResultValue, 'ì›')}</span>
                  </div>
                `;
              })()}
            </div>
          </div>
        </div>

        <!-- ì˜¤ëŠ˜ ë‚´ ì—…ë¬´ ê¸°ì—¬ë„ -->
        <div class="card">
          <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">ğŸ”„ ì˜¤ëŠ˜ ë‚´ ì—…ë¬´ ê¸°ì—¬ë„</div>
          ${okrState.todayLogs.length > 0 ? `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
              ${okrState.todayLogs.slice(0, 8).map(log => {
                const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
                const kpi = okrState.kpis.find(k => k.id === log.kpiId);
                const kr = okrState.keyResults.find(k => k.id === log.krId);
                const krIdx = okrState.keyResults.findIndex(k => k.id === log.krId);
                return `<div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 13px; border-left: 3px solid ${okrColors[krIdx] || 'var(--gray-300)'};">
                  <span style="font-size: 16px;">${getOkrLagIcon(lag?.name || '')}</span>
                  <span style="flex: 1;">${lag?.name || 'ì—…ë¬´'}</span>
                  <span style="font-weight: 700; color: var(--success);">+${log.resultValue}</span>
                </div>`;
              }).join('')}
            </div>
            ${okrState.todayLogs.length > 8 ? `<div style="text-align: center; margin-top: 12px; color: var(--gray-500); font-size: 12px;">ì™¸ ${okrState.todayLogs.length - 8}ê±´ ë”ë³´ê¸°</div>` : ''}
          ` : '<div style="color: var(--gray-400); font-size: 13px; padding: 30px; text-align: center;">ì˜¤ëŠ˜ ê¸°ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤<br><span style="font-size: 12px;">ì—…ë¬´ê¸°ë¡ íƒ­ì—ì„œ ê¸°ë¡í•´ë³´ì„¸ìš”</span></div>'}
        </div>
      `;
    }

    // ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ ìƒíƒœ
    let personalDashboardState = {
      selectedMemberId: null,
      periodFilter: 'all' // all, thisWeek, thisMonth
    };

    // ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ ë Œë”ë§
    function renderPersonalGrowthboard() {
      const container = document.getElementById('okrPersonalDashboardContent');
      if (!container) return;

      if (!okrState.objective) {
        container.innerHTML = `
          <div class="card" style="text-align: center; padding: 60px;">
            <div style="font-size: 64px; margin-bottom: 16px;">ğŸ¯</div>
            <div style="font-size: 18px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 14px; color: var(--gray-500); margin-bottom: 20px;">[ëª©í‘œ ì„¤ì •] íƒ­ì—ì„œ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div>
            <button class="btn btn-primary" onclick="switchTab('okr-settings')">ëª©í‘œ ì„¤ì •í•˜ê¸°</button>
          </div>
        `;
        return;
      }

      // ê²ŒìŠ¤íŠ¸ ì œì™¸í•œ íŒ€ì› ëª©ë¡
      const teamMembers = (state.teamMembers || []).filter(m => m.role !== 'guest');

      if (teamMembers.length === 0) {
        container.innerHTML = `
          <div class="card" style="text-align: center; padding: 60px;">
            <div style="font-size: 64px; margin-bottom: 16px;">ğŸ‘¥</div>
            <div style="font-size: 18px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">íŒ€ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 14px; color: var(--gray-500);">ìš´ì˜ì„¼í„° > ì‹œìŠ¤í…œê´€ë¦¬ > íŒ€ì›ê´€ë¦¬ì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”</div>
          </div>
        `;
        return;
      }

      // ê¸°ê°„ í•„í„°ë§ ë¡œì§
      const getFilteredLogs = () => {
        let filtered = okrState.dailyLogs;
        if (personalDashboardState.periodFilter === 'thisWeek') {
          const today = new Date();
          const thisMonday = new Date(today.setDate(today.getDate() - today.getDay() + 1));
          const mondayStr = thisMonday.toISOString().split('T')[0];
          filtered = filtered.filter(log => log.date >= mondayStr);
        } else if (personalDashboardState.periodFilter === 'thisMonth') {
          const today = new Date();
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          const firstDayStr = firstDay.toISOString().split('T')[0];
          filtered = filtered.filter(log => log.date >= firstDayStr);
        }
        return filtered;
      };

      const filteredLogs = getFilteredLogs();

      // íŒ€ì›ë³„ ë°ì´í„° ì§‘ê³„
      const memberStats = teamMembers.map(member => {
        const memberLogs = filteredLogs.filter(log => log.memberId === member.id);

        // í™œë™í˜• ì§€í‘œ
        const activityLogs = memberLogs.filter(log => {
          const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
          return lag && lag.type !== 'result';
        });
        const activityCount = activityLogs.reduce((sum, log) => sum + (log.resultValue || 0), 0);

        // ì„±ê³¼í˜• ì§€í‘œ
        const resultLogs = memberLogs.filter(log => {
          const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
          return lag && lag.type === 'result';
        });
        let resultValue = 0;
        resultLogs.forEach(log => {
          const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
          const value = lag?.valuePerUnit > 0 ? (log.resultValue || 0) * lag.valuePerUnit : (log.resultValue || 0);
          resultValue += value;
        });

        // KRë³„ ê¸°ì—¬ë„ ê³„ì‚°
        const krContributions = okrState.keyResults.map((kr, krIdx) => {
          const krLogs = memberLogs.filter(log => log.krId === kr.id);
          const krCount = krLogs.reduce((sum, log) => sum + (log.resultValue || 0), 0);
          return { kr, krIdx, count: krCount };
        });

        const totalCount = memberLogs.reduce((sum, log) => sum + (log.resultValue || 0), 0);

        return {
          ...member,
          activityCount,
          resultValue,
          totalCount,
          krContributions,
          logsCount: memberLogs.length
        };
      });

      // ì´ í™œë™ëŸ‰ ê¸°ì¤€ ì •ë ¬
      memberStats.sort((a, b) => b.totalCount - a.totalCount);

      container.innerHTML = `
        <!-- í—¤ë” -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div>
            <h2 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin: 0;">ğŸ‘¤ ê°œì¸ ê·¸ë¡œìŠ¤ë³´ë“œ</h2>
            <p style="color: var(--gray-500); margin-top: 4px; font-size: 13px;">íŒ€ì›ë³„ í™œë™ í˜„í™© Â· KR ê¸°ì—¬ë„</p>
          </div>
          <div style="display: flex; gap: 8px;">
            <select id="personalPeriodFilter" onchange="updatePersonalPeriodFilter(this.value)" style="padding: 8px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 13px; cursor: pointer; background: white;">
              <option value="all" ${personalDashboardState.periodFilter === 'all' ? 'selected' : ''}>ì „ì²´ ê¸°ê°„</option>
              <option value="thisWeek" ${personalDashboardState.periodFilter === 'thisWeek' ? 'selected' : ''}>ì´ë²ˆ ì£¼</option>
              <option value="thisMonth" ${personalDashboardState.periodFilter === 'thisMonth' ? 'selected' : ''}>ì´ë²ˆ ë‹¬</option>
            </select>
          </div>
        </div>

        <!-- íŒ€ì› ìš”ì•½ í…Œì´ë¸” -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
            ğŸ“Š íŒ€ì›ë³„ í™œë™ ìš”ì•½
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead>
                <tr style="background: var(--gray-50);">
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); min-width: 100px;">íŒ€ì›</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">ì´ í™œë™</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">í–‰ë™ì§€í‘œ</th>
                  <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);">ì„±ê³¼ì§€í‘œ</th>
                  ${okrState.keyResults.map((kr, idx) => `
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: ${okrColors[idx]}; border-bottom: 2px solid var(--gray-200); min-width: 80px;">
                      ${kr.name}
                    </th>
                  `).join('')}
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); width: 50px;"></th>
                </tr>
              </thead>
              <tbody>
                ${memberStats.map(member => `
                  <tr style="border-bottom: 1px solid var(--gray-100); cursor: pointer;" onclick="selectMemberForDetail('${member.id}')" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
                    <td style="padding: 12px; font-weight: 600; color: var(--gray-800);">
                      ${member.name}
                      ${member.role === 'admin' ? '<span style="font-size: 10px; color: var(--primary); margin-left: 4px;">ğŸ‘‘</span>' : ''}
                    </td>
                    <td style="padding: 12px; text-align: center; font-weight: 700; color: var(--primary);">${member.totalCount}ê±´</td>
                    <td style="padding: 12px; text-align: center; color: var(--gray-700);">${member.activityCount}ê±´</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--success);">${formatAmountWithSummary(member.resultValue, 'ì›')}</td>
                    ${member.krContributions.map(krc => {
                      return `
                      <td style="padding: 12px; text-align: center;">
                        ${krc.count > 0 ? `
                          <span style="display: inline-block; padding: 4px 10px; background: ${okrColors[krc.krIdx]}15; color: ${okrColors[krc.krIdx]}; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${krc.count}ê±´
                          </span>
                        ` : '<span style="color: var(--gray-300);">-</span>'}
                      </td>
                    `;
                    }).join('')}
                    <td style="padding: 12px; text-align: center;">
                      <button onclick="event.stopPropagation(); selectMemberForDetail('${member.id}')" style="padding: 4px 8px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; color: var(--gray-600); font-size: 11px; cursor: pointer;" onmouseover="this.style.background='var(--primary)'; this.style.color='white'; this.style.borderColor='var(--primary)'" onmouseout="this.style.background='white'; this.style.color='var(--gray-600)'; this.style.borderColor='var(--gray-300)'">ìƒì„¸</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- ì„ íƒëœ íŒ€ì› ìƒì„¸ ëŒ€ì‹œë³´ë“œ -->
        <div id="memberDetailDashboard">
          ${personalDashboardState.selectedMemberId ? renderMemberDetailDashboard(personalDashboardState.selectedMemberId, filteredLogs) : `
            <div class="card" style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 12px;">ğŸ‘†</div>
              <div style="font-size: 15px; color: var(--gray-600);">ìœ„ í…Œì´ë¸”ì—ì„œ íŒ€ì›ì„ ì„ íƒí•˜ë©´ ìƒì„¸ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
            </div>
          `}
        </div>
      `;
    }

    // íŒ€ì› ìƒì„¸ ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    function renderMemberDetailDashboard(memberId, filteredLogs) {
      const member = (state.teamMembers || []).find(m => m.id === memberId);
      if (!member) return '';

      const memberLogs = filteredLogs.filter(log => log.memberId === memberId);

      // KRë³„ ìƒì„¸ ë¶„ì„ (í™œë™ ì—¬ë¶€ ê´€ê³„ì—†ì´ ëª¨ë“  KPI í‘œì‹œ)
      const krDetails = okrState.keyResults.map((kr, krIdx) => {
        const krLogs = memberLogs.filter(log => log.krId === kr.id);
        const kpisForKR = okrState.kpis.filter(k => k.keyResultId === kr.id);

        const kpiDetails = kpisForKR.map(kpi => {
          const kpiLogs = krLogs.filter(log => log.kpiId === kpi.id);
          const lagsForKPI = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);

          const lagDetails = lagsForKPI.map(lag => {
            const lagLogs = kpiLogs.filter(log => log.laggingIndicatorId === lag.id);
            const lagCount = lagLogs.reduce((sum, log) => sum + (log.resultValue || 0), 0);
            return { lag, count: lagCount, logsCount: lagLogs.length };
          }).filter(ld => ld.count > 0);

          const kpiCount = kpiLogs.reduce((sum, log) => sum + (log.resultValue || 0), 0);
          return { kpi, count: kpiCount, lagDetails };
        }); // filter ì œê±° - ëª¨ë“  KPI í‘œì‹œ

        const krCount = krLogs.reduce((sum, log) => sum + (log.resultValue || 0), 0);
        return { kr, krIdx, count: krCount, kpiDetails };
      }).filter(krd => krd.kpiDetails.length > 0); // KPIê°€ ìˆëŠ” KRë§Œ í‘œì‹œ

      // í™œë™ í†µê³„
      const activityLogs = memberLogs.filter(log => {
        const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        return lag && lag.type !== 'result';
      });
      const activityCount = activityLogs.reduce((sum, log) => sum + (log.resultValue || 0), 0);

      const resultLogs = memberLogs.filter(log => {
        const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        return lag && lag.type === 'result';
      });
      let resultValue = 0;
      resultLogs.forEach(log => {
        const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        const value = lag?.valuePerUnit > 0 ? (log.resultValue || 0) * lag.valuePerUnit : (log.resultValue || 0);
        resultValue += value;
      });

      return `
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--gray-200);">
            <div>
              <div style="font-size: 18px; font-weight: 700; color: var(--gray-900); display: flex; align-items: center; gap: 8px;">
                ğŸ‘¤ ${member.name}ë‹˜ì˜ ìƒì„¸ í˜„í™©
                ${member.role === 'admin' ? '<span style="font-size: 14px; color: var(--primary);">ğŸ‘‘</span>' : ''}
              </div>
              <div style="font-size: 13px; color: var(--gray-500); margin-top: 4px;">
                ${personalDashboardState.periodFilter === 'all' ? 'ì „ì²´ ê¸°ê°„' : personalDashboardState.periodFilter === 'thisWeek' ? 'ì´ë²ˆ ì£¼' : 'ì´ë²ˆ ë‹¬'}
              </div>
            </div>
            <button onclick="clearMemberSelection()" style="padding: 8px 16px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; color: var(--gray-600); font-size: 13px; cursor: pointer;">ë‹«ê¸°</button>
          </div>

          <!-- í™œë™ ìš”ì•½ ì¹´ë“œ -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, var(--primary), #8B5CF6); color: white; padding: 20px; border-radius: 12px;">
              <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">ì´ í™œë™</div>
              <div style="font-size: 32px; font-weight: 800;">${memberLogs.reduce((sum, log) => sum + (log.resultValue || 0), 0)}ê±´</div>
            </div>
            <div style="background: var(--gray-50); border-left: 4px solid var(--gray-400); padding: 20px; border-radius: 12px;">
              <div style="font-size: 13px; color: var(--gray-600); margin-bottom: 8px;">ğŸ“‹ í–‰ë™ì§€í‘œ</div>
              <div style="font-size: 28px; font-weight: 700; color: var(--gray-800);">${activityCount}ê±´</div>
            </div>
            <div style="background: var(--success-light); border-left: 4px solid var(--success); padding: 20px; border-radius: 12px;">
              <div style="font-size: 13px; color: var(--gray-600); margin-bottom: 8px;">ğŸ’° ì„±ê³¼ì§€í‘œ</div>
              <div style="font-size: 20px; font-weight: 700; color: var(--success);">${formatAmountWithSummary(resultValue, 'ì›')}</div>
            </div>
          </div>

          <!-- KRë³„ ê¸°ì—¬ ìƒì„¸ -->
          ${krDetails.length > 0 ? `
            <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
              ğŸ“ˆ KRë³„ ê¸°ì—¬ ìƒì„¸
            </div>
            ${krDetails.map(krd => `
              <div style="margin-bottom: 20px; padding: 16px; background: ${okrColors[krd.krIdx]}08; border-radius: 12px; border-left: 4px solid ${okrColors[krd.krIdx]};">
                <div style="font-size: 15px; font-weight: 700; color: ${okrColors[krd.krIdx]}; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                  <span>${okrIcons[krd.krIdx] || 'ğŸ“Š'} ${krd.kr.name}</span>
                  <span style="font-size: 16px; padding: 4px 12px; background: ${okrColors[krd.krIdx]}20; border-radius: 12px;">${krd.count}ê±´</span>
                </div>
                ${krd.kpiDetails.map(kpd => {
                  // ì‹¤ì œ ê¸°ì—¬ëŸ‰ ê³„ì‚°
                  const actualValue = kpd.lagDetails.reduce((sum, ld) => {
                    const lag = ld.lag;
                    if (lag.type === 'result') {
                      return sum + (lag.valuePerUnit > 0 ? ld.count * lag.valuePerUnit : ld.count);
                    }
                    return sum;
                  }, 0);

                  // ê°œì¸ ëª©í‘œ ë‹¬ì„±ë¥ 
                  const personalTarget = calcPersonalTargetRate(kpd.kpi.id, memberId, actualValue);

                  return `
                  <div style="margin-left: 16px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border: ${personalTarget ? '2px solid var(--primary)20' : '1px solid var(--gray-100)'};">
                    <div style="font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                      <span>â— ${kpd.kpi.name}</span>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${okrColors[krd.krIdx]};">${kpd.count}ê±´</span>
                        <button onclick="openPersonalTargetModal('${kpd.kpi.id}', '${memberId}')" style="padding: 4px 8px; border: 1px solid var(--primary); border-radius: 6px; background: white; color: var(--primary); font-size: 10px; cursor: pointer; font-weight: 600;" onmouseover="this.style.background='var(--primary)'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='var(--primary)'" title="ë‚´ ëª©í‘œ ì„¤ì •">
                          ğŸ¯ ${personalTarget ? 'ëª©í‘œ' : 'ëª©í‘œì„¤ì •'}
                        </button>
                      </div>
                    </div>

                    ${personalTarget ? `
                      <div style="background: linear-gradient(135deg, var(--primary)05, var(--success)05); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                          <div style="font-size: 11px; color: var(--gray-600);">ğŸ¯ ë‚´ ëª©í‘œ</div>
                          <div style="font-size: 15px; font-weight: 700; color: var(--primary);">${personalTarget.rate}%</div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                          <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 9px; color: var(--gray-500); margin-bottom: 4px;">ì‹¤ì œ ê¸°ì—¬</div>
                            <div style="font-size: 11px; font-weight: 700; color: var(--gray-800);">${formatAmountWithSummary(personalTarget.actual, kpd.kpi.unit || '')}</div>
                          </div>
                          <div style="background: var(--primary)10; padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 9px; color: var(--gray-500); margin-bottom: 4px;">ë‚´ ëª©í‘œ</div>
                            <div style="font-size: 11px; font-weight: 700; color: var(--primary);">${formatAmountWithSummary(personalTarget.target, kpd.kpi.unit || '')}</div>
                          </div>
                        </div>

                        <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; margin-bottom: 6px;">
                          <div style="height: 100%; width: ${personalTarget.rate}%; background: ${personalTarget.rate >= 100 ? 'var(--success)' : 'var(--primary)'}; border-radius: 3px; transition: width 0.5s;"></div>
                        </div>
                        ${personalTarget.remaining > 0 ? `
                          <div style="font-size: 10px; color: var(--gray-500); text-align: center;">
                            ${personalTarget.rate >= 100 ? 'ğŸ‰ ëª©í‘œ ë‹¬ì„±!' : `ğŸ’ª ëª©í‘œê¹Œì§€ ${formatAmountWithSummary(personalTarget.remaining, kpd.kpi.unit || '')} ë‚¨ìŒ!`}
                          </div>
                        ` : '<div style="font-size: 10px; color: var(--success); text-align: center; font-weight: 600;">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!</div>'}
                      </div>
                    ` : ''}

                    ${kpd.lagDetails.length > 0 ? kpd.lagDetails.map(ld => `
                      <div style="margin-left: 16px; font-size: 12px; color: var(--gray-600); padding: 6px 0; display: flex; justify-content: space-between; border-bottom: 1px solid var(--gray-100);">
                        <span>${getOkrLagIcon(ld.lag.name)} ${ld.lag.name}</span>
                        <span style="font-weight: 600; color: var(--gray-700);">${ld.count}ê±´ (${ld.logsCount}íšŒ)</span>
                      </div>
                    `).join('') : `
                      <div style="margin-left: 16px; padding: 12px; background: var(--gray-50); border-radius: 6px; text-align: center;">
                        <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div style="font-size: 11px; color: var(--gray-400);">ëª©í‘œë¥¼ ë¨¼ì € ì„¤ì •í•˜ê³  ì—…ë¬´ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”!</div>
                      </div>
                    `}
                  </div>
                `;
                }).join('')}
              </div>
            `).join('')}
          ` : `
            <div style="text-align: center; padding: 30px; color: var(--gray-400); font-size: 13px;">
              ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤
            </div>
          `}
        </div>
      `;
    }

    // íŒ€ì› ì„ íƒ
    function selectMemberForDetail(memberId) {
      personalDashboardState.selectedMemberId = memberId;
      renderPersonalGrowthboard();

      // ìƒì„¸ ëŒ€ì‹œë³´ë“œë¡œ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        const detailEl = document.getElementById('memberDetailDashboard');
        if (detailEl) detailEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    // íŒ€ì› ì„ íƒ í•´ì œ
    function clearMemberSelection() {
      personalDashboardState.selectedMemberId = null;
      renderPersonalGrowthboard();
    }

    // ê¸°ê°„ í•„í„° ì—…ë°ì´íŠ¸
    function updatePersonalPeriodFilter(period) {
      personalDashboardState.periodFilter = period;
      renderPersonalGrowthboard();
    }

    // OKR ì—…ë¬´ê¸°ë¡ ë Œë”ë§
    function renderOkrRecord() {
      const container = document.getElementById('okrRecordContent');
      if (!container) return;

      // ì˜¤ëŠ˜ ê¸°ë¡ ìˆ˜ ì—…ë°ì´íŠ¸
      const todayCountEl = document.getElementById('okrTodayCount');
      if (todayCountEl) todayCountEl.textContent = okrState.todayLogs.length + 'ê±´';

      if (okrState.keyResults.length === 0) {
        container.innerHTML = `<div class="card" style="text-align: center; padding: 60px;"><div style="font-size: 64px; margin-bottom: 16px;">ğŸ“</div><div style="font-size: 18px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ëª©í‘œë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div><button class="btn btn-primary" onclick="switchTab('okr-settings')">ëª©í‘œ ì„¤ì •í•˜ê¸°</button></div>`;
        return;
      }

      // ì¦ê²¨ì°¾ê¸° ìƒë‹¨ ê³ ì • ì˜ì—­ ë Œë”ë§
      updateOkrFavoritesSection();

      // KR ì¹´ë“œ 3ì¹¸ ë°°ì—´ (í´ë¦­ ì‹œ ëª¨ë‹¬ ì„ íƒ)
      let krCardsHtml = `
        <div style="font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 16px;">ğŸ“Š KR ì„ íƒ â†’ KPI â†’ ì§€í‘œ ê¸°ë¡</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px;">
      `;

      okrState.keyResults.forEach((kr, krIdx) => {
        const kpisForKR = okrState.kpis.filter(k => k.keyResultId === kr.id);
        const krRate = calcOkrKRRate(kr.id);
        const lagCount = kpisForKR.reduce((sum, kpi) => sum + okrState.laggingIndicators.filter(l => l.kpiId === kpi.id).length, 0);
        const todayLogsForKR = okrState.todayLogs.filter(log => log.krId === kr.id);

        krCardsHtml += `
          <div onclick="openKrSelectionModal('${kr.id}')" style="background: white; border: 2px solid var(--gray-200); border-radius: 16px; overflow: hidden; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
               onmouseover="this.style.borderColor='${okrColors[krIdx]}'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.12)';"
               onmouseout="this.style.borderColor='var(--gray-200)'; this.style.transform='none'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.04)';">
            <!-- KR í—¤ë” -->
            <div style="background: linear-gradient(135deg, ${okrColors[krIdx]}, ${okrColors[krIdx]}CC); color: white; padding: 20px;">
              <div style="font-size: 36px; margin-bottom: 12px;">${okrIcons[krIdx] || 'ğŸ“Š'}</div>
              <div style="font-size: 16px; font-weight: 700; margin-bottom: 4px; line-height: 1.3;">${kr.name}</div>
              <div style="font-size: 24px; font-weight: 800;">${krRate}%</div>
            </div>
            <!-- KR ì •ë³´ -->
            <div style="padding: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <div style="font-size: 12px; color: var(--gray-500);">KPI ${kpisForKR.length}ê°œ</div>
                <div style="font-size: 12px; color: var(--gray-500);">ê¸°ë¡í•­ëª© ${lagCount}ê°œ</div>
              </div>
              <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; margin-bottom: 12px;">
                <div style="height: 100%; width: ${Math.min(krRate, 100)}%; background: ${okrColors[krIdx]}; border-radius: 3px;"></div>
              </div>
              ${todayLogsForKR.length > 0 ? `
                <div style="font-size: 11px; color: var(--success); font-weight: 600; display: flex; align-items: center; gap: 4px;">
                  âœ… ì˜¤ëŠ˜ ${todayLogsForKR.length}ê±´ ê¸°ë¡
                </div>
              ` : `
                <div style="font-size: 11px; color: var(--gray-400);">ì˜¤ëŠ˜ ê¸°ë¡ ì—†ìŒ</div>
              `}
            </div>
            <!-- í´ë¦­ ìœ ë„ -->
            <div style="background: var(--gray-50); padding: 12px 16px; text-align: center; border-top: 1px solid var(--gray-100);">
              <span style="font-size: 13px; color: ${okrColors[krIdx]}; font-weight: 600;">í´ë¦­í•˜ì—¬ ê¸°ë¡í•˜ê¸° â†’</span>
            </div>
          </div>
        `;
      });

      krCardsHtml += '</div>';

      // ì˜¤ëŠ˜ ê¸°ë¡ ë‚´ì—­ (ì‚­ì œ ê¸°ëŠ¥ í¬í•¨)
      let todayRecordsHtml = '';
      if (okrState.todayLogs.length > 0) {
        todayRecordsHtml = `
          <div class="card" style="background: var(--gray-50);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 15px; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 8px;">
                ğŸ“‹ ì˜¤ëŠ˜ ê¸°ë¡ ë‚´ì—­ (${okrState.todayLogs.length}ê±´)
              </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">
              ${okrState.todayLogs.map(log => {
                const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
                const kpi = okrState.kpis.find(k => k.id === log.kpiId);
                const kr = okrState.keyResults.find(k => k.id === log.krId);
                const krIdx = okrState.keyResults.findIndex(k => k.id === log.krId);
                const logTime = log.registeredTime || '';
                const hasAttachments = log.attachments && log.attachments.length > 0;
                const hasMemo = log.memo && log.memo.trim();
                return `
                  <div style="background: white; border-radius: 10px; border-left: 3px solid ${okrColors[krIdx] || 'var(--gray-300)'}; overflow: hidden;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px;">
                      <span style="font-size: 20px;">${getOkrLagIcon(lag?.name || '')}</span>
                      <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--gray-800);">${lag?.name || 'ì—…ë¬´'}</div>
                        <div style="font-size: 11px; color: var(--gray-500);">${kr?.name || ''} â†’ ${kpi?.name || ''}</div>
                      </div>
                      <div style="text-align: right;">
                        <div style="font-size: 13px; font-weight: 700; color: var(--success);">+${log.resultValue || 1}</div>
                        ${logTime ? `<div style="font-size: 10px; color: var(--gray-400);">${logTime}</div>` : ''}
                      </div>
                      ${hasAttachments ? `<span style="font-size: 14px; color: var(--gray-400);" title="ì¦ë¹™ìë£Œ ${log.attachments.length}ê°œ">ğŸ“</span>` : ''}
                      <button onclick="viewWorkRecordDetail('${log.id}')" style="background: none; border: none; color: var(--gray-400); cursor: pointer; padding: 4px 8px; font-size: 14px;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-400)'" title="ìƒì„¸ë³´ê¸°">ğŸ‘ï¸</button>
                      <button onclick="deleteOkrLog('${log.id}')" style="background: none; border: none; color: var(--gray-400); cursor: pointer; padding: 4px 8px; font-size: 14px;" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--gray-400)'" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </div>
                    ${hasMemo ? `<div style="padding: 0 16px 12px 48px; font-size: 12px; color: var(--gray-600);">${log.memo}</div>` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      container.innerHTML = krCardsHtml + todayRecordsHtml;

      // ì˜¤ëŠ˜ ê¸°ë¡ ìš”ì•½ ì—…ë°ì´íŠ¸
      updateOkrTodaySummary();
    }

    // ì¦ê²¨ì°¾ê¸° ìƒë‹¨ ê³ ì • ì„¹ì…˜ ì—…ë°ì´íŠ¸
    function updateOkrFavoritesSection() {
      const section = document.getElementById('okrFavoritesSection');
      const container = document.getElementById('okrFavoritesButtons');
      if (!section || !container) return;

      if (okrState.favorites.length === 0) {
        section.style.display = 'none';
        return;
      }

      const favoriteLags = okrState.laggingIndicators.filter(l => okrState.favorites.includes(l.id));
      if (favoriteLags.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      container.innerHTML = favoriteLags.map(lag => {
        const kpi = okrState.kpis.find(k => k.id === lag.kpiId);
        const kr = okrState.keyResults.find(k => k.id === kpi?.keyResultId);
        const krIdx = okrState.keyResults.findIndex(k => k.id === kpi?.keyResultId);
        return `
          <div onclick="openWorkRecordInputModal('${kr?.id}', '${kpi?.id}', '${lag.id}')" style="background: white; border: 2px solid ${okrColors[krIdx] || 'var(--gray-200)'}; border-radius: 10px; padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.08);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='none'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
            <span style="font-size: 20px;">${getOkrLagIcon(lag.name)}</span>
            <span style="font-size: 13px; font-weight: 600;">${lag.name}</span>
            <span style="font-size: 11px; color: var(--gray-500);">${lag.version}ë²„ì „</span>
            <span style="background: ${okrColors[krIdx] || 'var(--primary)'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700;">ê¸°ë¡</span>
          </div>
        `;
      }).join('');
    }

    // KR ì˜ì—­ ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€
    function toggleKRExpand(krId) {
      if (!okrState.expandedKRs) okrState.expandedKRs = [];
      const idx = okrState.expandedKRs.indexOf(krId);
      if (idx === -1) {
        okrState.expandedKRs.push(krId);
      } else {
        okrState.expandedKRs.splice(idx, 1);
      }
      renderOkrRecord();
    }

    // ì˜¤ëŠ˜ ê¸°ë¡ ìš”ì•½ ì—…ë°ì´íŠ¸
    function updateOkrTodaySummary() {
      const container = document.getElementById('okrTodaySummary');
      if (!container) return;

      if (okrState.todayLogs.length === 0) {
        container.innerHTML = '<div style="color: var(--gray-400); font-size: 13px;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      const summary = {};
      okrState.todayLogs.forEach(log => {
        const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
        const key = log.laggingIndicatorId;
        if (!summary[key]) summary[key] = { name: lag?.name || 'ì—…ë¬´', version: lag?.version || '', count: 0 };
        summary[key].count += log.resultValue || 1;
      });

      container.innerHTML = Object.values(summary).map(item => `
        <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--gray-600); margin-bottom: 6px;">
          <span>${getOkrLagIcon(item.name)}</span>
          <span>${item.name} (${item.version}ë²„ì „): <b>${item.count}ê±´</b></span>
        </div>
      `).join('');
    }

    // KPI í•„í„° ì—…ë°ì´íŠ¸
    function updateKpiFilter(key, value) {
      okrState.kpiFilter[key] = value;
      localStorage.setItem('okrKpiFilter', JSON.stringify(okrState.kpiFilter));
      renderOkrDashboard();
    }

    // KR ì„ íƒ ëª¨ë‹¬ ì—´ê¸° (ì—…ë¬´ê¸°ë¡ìš©) - 2ë‹¨ ë ˆì´ì•„ì›ƒ
    function openKrSelectionModal(krId) {
      const kr = okrState.keyResults.find(k => k.id === krId);
      const krIdx = okrState.keyResults.findIndex(k => k.id === krId);
      const kpisForKR = okrState.kpis.filter(k => k.keyResultId === krId);

      if (!kr) return;

      // ì²¨ë¶€íŒŒì¼ ì´ˆê¸°í™”
      workRecordAttachments = [];

      showModal(`
        <div style="padding: 24px; width: 1100px; max-width: 95vw; box-sizing: border-box;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid ${okrColors[krIdx]};">
            <span style="font-size: 28px;">${okrIcons[krIdx] || 'ğŸ“Š'}</span>
            <div style="flex: 1;">
              <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${kr.name}</div>
              <div style="font-size: 13px; color: var(--gray-500);">ë‹¬ì„±ë¥ : ${calcOkrKRRate(kr.id)}%</div>
            </div>
            <button class="btn btn-secondary" onclick="closeModal()" style="padding: 8px 16px;">ë‹«ê¸°</button>
          </div>

          <div style="display: flex; gap: 24px;">
            <!-- ì™¼ìª½: KPI/ì§€í‘œ ëª©ë¡ -->
            <div style="flex: 1; min-width: 0; max-height: 480px; overflow-y: auto; padding-right: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                <div style="font-size: 14px; font-weight: 600; color: var(--gray-700);">ğŸ“Š KPI ì„ íƒ â†’ ì§€í‘œ ê¸°ë¡</div>
                <div style="display: flex; gap: 6px; align-items: center;">
                  <select id="lagTypeFilter" onchange="filterLagsByType(this.value, '${krId}')" style="padding: 4px 8px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 11px; cursor: pointer; background: white;">
                    <option value="all">ì „ì²´ ìœ í˜•</option>
                    <option value="activity">ğŸ“‹ í™œë™í˜•</option>
                    <option value="result">ğŸ’° ì„±ê³¼í˜•</option>
                  </select>
                  <button onclick="toggleAllKpiFolders(true)" style="padding: 4px 8px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 11px; cursor: pointer; background: white;" title="ëª¨ë‘ í¼ì¹˜ê¸°">í¼ì¹˜ê¸°</button>
                  <button onclick="toggleAllKpiFolders(false)" style="padding: 4px 8px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 11px; cursor: pointer; background: white;" title="ëª¨ë‘ ì ‘ê¸°">ì ‘ê¸°</button>
                </div>
              </div>
              <div id="kpiListContainer" style="display: flex; flex-direction: column; gap: 12px;">
                ${kpisForKR.map((kpi, kpiIdx) => {
                  const lagsForKPI = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
                  const activityCount = lagsForKPI.filter(l => l.type !== 'result').length;
                  const resultCount = lagsForKPI.filter(l => l.type === 'result').length;
                  const kpiRate = calcOkrKPIRate(kpi.id);
                  return `
                    <div class="kpi-folder" style="background: var(--gray-50); border-radius: 12px; overflow: hidden;">
                      <!-- KPI í—¤ë” (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
                      <div onclick="toggleKpiFolderInModal('${kpi.id}')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; cursor: pointer; user-select: none;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <span id="kpi-arrow-${kpi.id}" style="font-size: 10px; color: var(--gray-500); transition: transform 0.2s;">â–¼</span>
                          <div>
                            <div style="font-size: 13px; font-weight: 600; color: var(--gray-800);">ğŸ“‚ ${kpi.name}</div>
                            ${kpi.targetValue ? `<div style="font-size: 10px; color: var(--gray-500);">ëª©í‘œ: ${kpi.targetValue.toLocaleString()}${kpi.unit || ''}</div>` : ''}
                          </div>
                          <span style="font-size: 10px; color: var(--gray-400);">ğŸ“‹${activityCount}</span>
                          <span style="font-size: 10px; color: var(--success);">ğŸ’°${resultCount}</span>
                        </div>
                        <span style="font-size: 12px; color: ${kpiRate >= 80 ? 'var(--success)' : kpiRate >= 50 ? 'var(--warning)' : 'var(--danger)'}; font-weight: 600;">${kpiRate}%</span>
                      </div>
                      <!-- KPI ë‚´ìš© (ì§€í‘œ ëª©ë¡) -->
                      <div id="kpi-content-${kpi.id}" style="padding: 0 14px 14px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); gap: 8px;">
                          ${[...lagsForKPI].sort((a, b) => (b.type === 'result' ? 1 : 0) - (a.type === 'result' ? 1 : 0)).map(lag => {
                            const isFavorite = okrState.favorites.includes(lag.id);
                            const isResult = lag.type === 'result';
                            const typeBadge = isResult
                              ? '<span style="position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); font-size: 8px; padding: 1px 4px; background: var(--success); color: white; border-radius: 4px;">ğŸ’°ì„±ê³¼</span>'
                              : '<span style="position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); font-size: 8px; padding: 1px 4px; background: var(--gray-400); color: white; border-radius: 4px;">ğŸ“‹í™œë™</span>';
                            return `
                              <div id="lag-btn-${lag.id}" style="background: white; border: 2px solid ${isResult ? 'var(--success-light)' : 'var(--gray-200)'}; border-radius: 8px; padding: 10px 6px 18px; cursor: pointer; text-align: center; transition: all 0.2s; position: relative;" onmouseover="this.style.borderColor='${okrColors[krIdx]}'" onmouseout="if(!this.classList.contains('selected')) this.style.borderColor='${isResult ? 'var(--success-light)' : 'var(--gray-200)'}'" ${isResult ? 'title="ì„±ê³¼í˜•: KPIì— ë°˜ì˜ë¨"' : 'title="í™œë™í˜•: ì°¸ê³ ìš©"'}>
                                <div onclick="event.stopPropagation(); showEditLagForm('${lag.id}')" style="position: absolute; top: 2px; left: 2px; font-size: 10px; color: var(--gray-400); cursor: pointer; padding: 2px;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-400)'" title="ìˆ˜ì •">âœï¸</div>
                                <div style="position: absolute; top: 2px; right: 2px; font-size: 10px; opacity: ${isFavorite ? 1 : 0.3};">â­</div>
                                <div onclick="selectLagForRecord('${kr.id}', '${kpi.id}', '${lag.id}', ${krIdx})" style="font-size: 20px; margin-bottom: 4px;">${getOkrLagIcon(lag.name)}</div>
                                <div onclick="selectLagForRecord('${kr.id}', '${kpi.id}', '${lag.id}', ${krIdx})" style="font-size: 11px; font-weight: 600; color: var(--gray-700); word-break: keep-all;">${lag.name}</div>
                                <div onclick="selectLagForRecord('${kr.id}', '${kpi.id}', '${lag.id}', ${krIdx})" style="font-size: 9px; color: var(--gray-500);">${lag.version}ë²„ì „</div>
                                ${typeBadge}
                              </div>
                            `;
                          }).join('')}
                          <!-- ì¶”ê°€ ë²„íŠ¼ -->
                          <div onclick="showAddLagForm('${kr.id}', '${kpi.id}', ${krIdx})" style="background: white; border: 2px dashed var(--gray-300); border-radius: 8px; padding: 10px 6px; cursor: pointer; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70px;" onmouseover="this.style.borderColor='${okrColors[krIdx]}'; this.style.background='${okrColors[krIdx]}10'" onmouseout="this.style.borderColor='var(--gray-300)'; this.style.background='white'">
                            <div style="font-size: 20px; color: var(--gray-400);">+</div>
                            <div style="font-size: 10px; color: var(--gray-500);">ì¶”ê°€</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì…ë ¥ í¼ ì˜ì—­ -->
            <div id="workRecordFormArea" style="width: 340px; flex-shrink: 0; background: var(--gray-50); border-radius: 16px; padding: 20px; display: flex; align-items: center; justify-content: center; min-height: 400px; box-sizing: border-box;">
              <div style="text-align: center; color: var(--gray-400);">
                <div style="font-size: 40px; margin-bottom: 12px;">ğŸ‘ˆ</div>
                <div style="font-size: 14px;">ì™¼ìª½ì—ì„œ ê¸°ë¡í• <br>í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</div>
              </div>
            </div>
          </div>
        </div>
      `);

      // ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.addEventListener('paste', handleWorkRecordPaste);
    }

    // KPI í´ë” ì ‘ê¸°/í¼ì¹˜ê¸°
    function toggleKpiFolderInModal(kpiId) {
      const content = document.getElementById(`kpi-content-${kpiId}`);
      const arrow = document.getElementById(`kpi-arrow-${kpiId}`);
      if (!content) return;

      if (content.style.display === 'none') {
        content.style.display = 'block';
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      } else {
        content.style.display = 'none';
        if (arrow) arrow.style.transform = 'rotate(-90deg)';
      }
    }

    // ëª¨ë“  KPI í´ë” ì ‘ê¸°/í¼ì¹˜ê¸°
    function toggleAllKpiFolders(expand) {
      const folders = document.querySelectorAll('.kpi-folder');
      folders.forEach(folder => {
        const content = folder.querySelector('[id^="kpi-content-"]');
        const arrow = folder.querySelector('[id^="kpi-arrow-"]');
        if (content) {
          content.style.display = expand ? 'block' : 'none';
        }
        if (arrow) {
          arrow.style.transform = expand ? 'rotate(0deg)' : 'rotate(-90deg)';
        }
      });
    }

    // ì§€í‘œ ìœ í˜•ë³„ í•„í„°ë§
    function filterLagsByType(type, krId) {
      const lagButtons = document.querySelectorAll('[id^="lag-btn-"]');
      lagButtons.forEach(btn => {
        const lagId = btn.id.replace('lag-btn-', '');
        const lag = okrState.laggingIndicators.find(l => l.id === lagId);
        if (!lag) return;

        const isResult = lag.type === 'result';
        let show = true;

        if (type === 'activity' && isResult) show = false;
        if (type === 'result' && !isResult) show = false;

        btn.style.display = show ? 'block' : 'none';
      });

      // í•„í„°ë§ í›„ ë¹ˆ KPI í´ë” ì²˜ë¦¬ (ì¶”ê°€ ë²„íŠ¼ë§Œ ìˆëŠ” ê²½ìš°ë„ í‘œì‹œ)
      const folders = document.querySelectorAll('.kpi-folder');
      folders.forEach(folder => {
        const visibleLags = folder.querySelectorAll('[id^="lag-btn-"]:not([style*="display: none"])');
        const header = folder.querySelector('[onclick^="toggleKpiFolderInModal"]');
        // ë¹ˆ í´ë”ë„ í‘œì‹œ (ì¶”ê°€ ë²„íŠ¼ì´ ìˆìœ¼ë¯€ë¡œ)
      });
    }

    // ì§€í‘œ ì¶”ê°€ í¼ í‘œì‹œ (ì˜¤ë¥¸ìª½ ì˜ì—­ì—)
    function showAddLagForm(krId, kpiId, krIdx) {
      const kr = okrState.keyResults.find(k => k.id === krId);
      const kpi = okrState.kpis.find(k => k.id === kpiId);
      if (!kr || !kpi) return;

      const formArea = document.getElementById('workRecordFormArea');
      if (!formArea) return;

      formArea.innerHTML = `
        <div style="width: 100%;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid ${okrColors[krIdx]};">
            <span style="font-size: 28px;">â•</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: var(--gray-800);">ì§€í‘œ ì¶”ê°€</div>
              <div style="font-size: 11px; color: var(--gray-500);">${kpi.name}ì— ì¶”ê°€</div>
            </div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ“Š ìœ í˜• <span style="color: var(--danger);">*</span>
            </label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="this.querySelector('input').checked=true; this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'; this.parentElement.children[1].style.borderColor='var(--gray-200)'; this.parentElement.children[1].style.background='white'; document.getElementById('newLagValuePerUnit').parentElement.style.display='none';">
                <input type="radio" name="newLagType" value="activity" checked style="display: none;">
                <span style="font-size: 18px;">ğŸ“‹</span>
                <div>
                  <div style="font-size: 13px; font-weight: 600;">í™œë™í˜•</div>
                  <div style="font-size: 10px; color: var(--gray-500);">í–‰ë™ íšŸìˆ˜ ì¶”ì </div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;" onclick="this.querySelector('input').checked=true; this.style.borderColor='var(--success)'; this.style.background='var(--success-light)'; this.parentElement.children[0].style.borderColor='var(--gray-200)'; this.parentElement.children[0].style.background='white'; document.getElementById('newLagValuePerUnit').parentElement.style.display='block';">
                <input type="radio" name="newLagType" value="result" style="display: none;">
                <span style="font-size: 18px;">ğŸ’°</span>
                <div>
                  <div style="font-size: 13px; font-weight: 600;">ì„±ê³¼í˜•</div>
                  <div style="font-size: 10px; color: var(--gray-500);">KPI ë‹¬ì„±ì— ë°˜ì˜</div>
                </div>
              </label>
            </div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ“ ì§€í‘œ ì´ë¦„ <span style="color: var(--danger);">*</span>
            </label>
            <input type="text" id="newLagName" placeholder="ì˜ˆ: SNS ë§ˆì¼€íŒ…" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; box-sizing: border-box;" />
          </div>

          <div style="margin-bottom: 16px; display: none;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ“ ê±´ë‹¹ ì˜ˆìƒ ê°’ <span style="color: var(--gray-400); font-size: 11px;">(ì„ íƒ)</span>
            </label>
            <div style="display: flex; gap: 8px;">
              <input type="number" id="newLagValuePerUnit" placeholder="ì˜ˆ: 100000" style="flex: 1; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; box-sizing: border-box;" />
              <select id="newLagUnit" style="width: 80px; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
                <option value="ì›">ì›</option>
                <option value="ê±´">ê±´</option>
                <option value="ëª…">ëª…</option>
                <option value="%">%</option>
                <option value="ê°œ">ê°œ</option>
                <option value="íšŒ">íšŒ</option>
              </select>
            </div>
            <div style="font-size: 10px; color: var(--gray-500); margin-top: 4px;">1ê±´ë‹¹ ì˜ˆìƒ ê¸°ì—¬ ê°’ (ìë™ í™˜ì‚°ìš©)</div>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ·ï¸ ë²„ì „
            </label>
            <select id="newLagVersion" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
              ${okrState.versions.map(v => `<option value="${v.id}">${v.name}ë²„ì „</option>`).join('')}
            </select>
          </div>

          <button onclick="addNewLaggingIndicator('${krId}', '${kpiId}', ${krIdx})" style="width: 100%; padding: 14px; background: ${okrColors[krIdx]}; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer;">
            ì¶”ê°€í•˜ê¸°
          </button>
        </div>
      `;
    }

    // ì§€í‘œ ì¶”ê°€ ì‹¤í–‰
    async function addNewLaggingIndicator(krId, kpiId, krIdx) {
      const name = document.getElementById('newLagName')?.value?.trim();
      const version = document.getElementById('newLagVersion')?.value || 'A';
      const typeRadio = document.querySelector('input[name="newLagType"]:checked');
      const lagType = typeRadio?.value || 'activity';
      const valuePerUnit = parseInt(document.getElementById('newLagValuePerUnit')?.value) || 0;
      const lagUnit = document.getElementById('newLagUnit')?.value || 'ì›';

      if (!name) {
        showToast('ì§€í‘œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      try {
        const newLag = {
          kpiId,
          name,
          version,
          target: 10,
          type: lagType, // 'activity' ë˜ëŠ” 'result'
          valuePerUnit: lagType === 'result' ? valuePerUnit : 0, // ì„±ê³¼í˜•ì¼ ë•Œë§Œ ê±´ë‹¹ ê°’
          unit: lagType === 'result' ? lagUnit : '', // ì„±ê³¼í˜•ì¼ ë•Œë§Œ ë‹¨ìœ„
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const docRef = await db.collection('okr_laggingIndicators').add(newLag);
        const lagWithId = { ...newLag, id: docRef.id };

        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        okrState.laggingIndicators.push(lagWithId);

        // ë³€ê²½ ì´ë ¥ ì €ì¥
        await saveChangeLog('laggingIndicator', 'create', { id: docRef.id, name, version, type: lagType });

        showToast(`"${name}" ì¶”ê°€ë¨`, 'success');

        // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
        closeModal();
        openKrSelectionModal(krId);
      } catch (e) {
        console.error('ì§€í‘œ ì¶”ê°€ ì˜¤ë¥˜:', e);
        showToast('ì¶”ê°€ ì‹¤íŒ¨', 'error');
      }
    }

    // ì§€í‘œ ì‚­ì œ í™•ì¸
    function confirmDeleteLag(lagId, lagName) {
      const formArea = document.getElementById('workRecordFormArea');
      if (!formArea) return;

      formArea.innerHTML = `
        <div style="width: 100%; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
          <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 8px;">ì§€í‘œ ì‚­ì œ</div>
          <div style="font-size: 14px; color: var(--gray-600); margin-bottom: 20px;">"<b>${lagName}</b>"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>

          <div style="background: var(--danger-light); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: left;">
            <div style="font-size: 12px; color: var(--danger); font-weight: 600; margin-bottom: 4px;">âš ï¸ ì£¼ì˜</div>
            <div style="font-size: 11px; color: var(--gray-700);">ì‚­ì œëœ ì§€í‘œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ê´€ë ¨ ê¸°ë¡ì€ ìœ ì§€ë˜ì§€ë§Œ ì§€í‘œ ì„ íƒì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              í™•ì¸ì„ ìœ„í•´ "<span style="color: var(--danger);">ì‚­ì œ</span>"ë¥¼ ì…ë ¥í•˜ì„¸ìš”
            </label>
            <input type="text" id="deleteConfirmInput" placeholder="ì‚­ì œ" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; text-align: center; box-sizing: border-box;" />
          </div>

          <div style="display: flex; gap: 12px;">
            <button onclick="cancelDeleteLag()" style="flex: 1; padding: 12px; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">ì·¨ì†Œ</button>
            <button onclick="executeDeleteLag('${lagId}')" style="flex: 1; padding: 12px; background: var(--danger); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">ì‚­ì œ</button>
          </div>
        </div>
      `;
    }

    // ì§€í‘œ ìˆ˜ì • í¼ í‘œì‹œ
    function showEditLagForm(lagId) {
      const lag = okrState.laggingIndicators.find(l => l.id === lagId);
      if (!lag) return;

      const kpi = okrState.kpis.find(k => k.id === lag.kpiId);
      const kr = kpi ? okrState.keyResults.find(k => k.id === kpi.keyResultId) : null;
      const krIdx = kr ? okrState.keyResults.findIndex(k => k.id === kr.id) : 0;

      const formArea = document.getElementById('workRecordFormArea');
      if (!formArea) return;

      const isResultType = lag.type === 'result';

      formArea.innerHTML = `
        <div style="width: 100%;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid ${okrColors[krIdx]};">
            <span style="font-size: 28px;">âœï¸</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: var(--gray-800);">ì§€í‘œ ìˆ˜ì •</div>
              <div style="font-size: 11px; color: var(--gray-500);">ì´ë¦„, ìœ í˜•, ë²„ì „ ë³€ê²½</div>
            </div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ“ ì§€í‘œ ì´ë¦„ <span style="color: var(--danger);">*</span>
            </label>
            <input type="text" id="editLagName" value="${lag.name}" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; box-sizing: border-box;" />
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
              ğŸ“Š ìœ í˜• <span style="color: var(--danger);">*</span>
            </label>
            <div style="background: var(--gray-50); border-radius: 8px; padding: 10px 12px; margin-bottom: 10px; border-left: 3px solid var(--primary);">
              <div style="font-size: 11px; color: var(--gray-600); line-height: 1.5;">
                ğŸ’¡ <strong>í™œë™í˜•</strong>: KR ì§„ì²™ë„ì— <span style="color: var(--gray-500); font-weight: 600;">ë°˜ì˜ ì•ˆë¨</span> (ì—…ë¬´ ê¸°ë¡ìš©)<br>
                ğŸ’¡ <strong>ì„±ê³¼í˜•</strong>: KR ì§„ì²™ë„ì— <span style="color: var(--success); font-weight: 600;">ë°˜ì˜ë¨</span> (ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚°)
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid ${!isResultType ? okrColors[krIdx] : 'var(--gray-200)'}; border-radius: 8px; cursor: pointer; background: ${!isResultType ? okrColors[krIdx] + '10' : 'white'};" onclick="document.getElementById('editLagValuePerUnit').parentElement.style.display='none';">
                <input type="radio" name="editLagType" value="activity" ${!isResultType ? 'checked' : ''} style="accent-color: ${okrColors[krIdx]};">
                <div>
                  <div style="font-size: 13px; font-weight: 600;">ğŸ“‹ í™œë™í˜•</div>
                  <div style="font-size: 10px; color: var(--gray-500);">í–‰ë™ íšŸìˆ˜ ì¶”ì  (ì°¸ê³ ìš©)</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid ${isResultType ? 'var(--success)' : 'var(--gray-200)'}; border-radius: 8px; cursor: pointer; background: ${isResultType ? 'var(--success-light)' : 'white'};" onclick="document.getElementById('editLagValuePerUnit').parentElement.style.display='block';">
                <input type="radio" name="editLagType" value="result" ${isResultType ? 'checked' : ''} style="accent-color: var(--success);">
                <div>
                  <div style="font-size: 13px; font-weight: 600;">ğŸ’° ì„±ê³¼í˜•</div>
                  <div style="font-size: 10px; color: var(--gray-500);">KPI ë‹¬ì„±ì— ë°˜ì˜</div>
                </div>
              </label>
            </div>
          </div>

          <div style="margin-bottom: 16px; display: ${isResultType ? 'block' : 'none'};">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ“ ê±´ë‹¹ ì˜ˆìƒ ê°’
            </label>
            <div style="display: flex; gap: 8px;">
              <input type="number" id="editLagValuePerUnit" value="${lag.valuePerUnit || 0}" min="0" placeholder="ì˜ˆ: 100000" style="flex: 1; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; box-sizing: border-box;" />
              <select id="editLagUnit" style="width: 80px; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
                <option value="ì›" ${(lag.unit || 'ì›') === 'ì›' ? 'selected' : ''}>ì›</option>
                <option value="ê±´" ${lag.unit === 'ê±´' ? 'selected' : ''}>ê±´</option>
                <option value="ëª…" ${lag.unit === 'ëª…' ? 'selected' : ''}>ëª…</option>
                <option value="%" ${lag.unit === '%' ? 'selected' : ''}>%</option>
                <option value="ê°œ" ${lag.unit === 'ê°œ' ? 'selected' : ''}>ê°œ</option>
                <option value="íšŒ" ${lag.unit === 'íšŒ' ? 'selected' : ''}>íšŒ</option>
              </select>
            </div>
            <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">â€» 0 ì…ë ¥ ì‹œ ìˆ˜ëŸ‰ ìì²´ê°€ KPIì— í•©ì‚°ë©ë‹ˆë‹¤</div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ·ï¸ ë²„ì „
            </label>
            <select id="editLagVersion" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
              <option value="A" ${lag.version === 'A' ? 'selected' : ''}>Aë²„ì „</option>
              <option value="B" ${lag.version === 'B' ? 'selected' : ''}>Bë²„ì „</option>
              <option value="C" ${lag.version === 'C' ? 'selected' : ''}>Cë²„ì „</option>
            </select>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ¯ ì¼ì¼ ëª©í‘œ ìˆ˜ëŸ‰
            </label>
            <input type="number" id="editLagTarget" value="${lag.target || 10}" min="1" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; box-sizing: border-box;" />
          </div>

          <div style="display: flex; gap: 12px;">
            <button onclick="cancelDeleteLag()" style="flex: 1; padding: 12px; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">ì·¨ì†Œ</button>
            <button onclick="executeEditLag('${lagId}')" style="flex: 1; padding: 12px; background: ${okrColors[krIdx]}; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">ì €ì¥</button>
          </div>

          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
            <button onclick="confirmDeleteLag('${lagId}', '${lag.name}')" style="width: 100%; padding: 10px; background: transparent; color: var(--danger); border: 1px solid var(--danger); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">ğŸ—‘ï¸ ì´ ì§€í‘œ ì‚­ì œ</button>
          </div>
        </div>
      `;
    }

    // ì§€í‘œ ìˆ˜ì • ì‹¤í–‰
    async function executeEditLag(lagId) {
      const lag = okrState.laggingIndicators.find(l => l.id === lagId);
      if (!lag) return;

      const newName = document.getElementById('editLagName')?.value?.trim();
      const newVersion = document.getElementById('editLagVersion')?.value || 'A';
      const newTarget = parseInt(document.getElementById('editLagTarget')?.value) || 10;
      const newType = document.querySelector('input[name="editLagType"]:checked')?.value || 'activity';
      const newValuePerUnit = parseInt(document.getElementById('editLagValuePerUnit')?.value) || 0;
      const newUnit = document.getElementById('editLagUnit')?.value || 'ì›';

      if (!newName) {
        showToast('ì§€í‘œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      const oldName = lag.name;
      const oldVersion = lag.version;
      const oldType = lag.type;
      const oldValuePerUnit = lag.valuePerUnit;

      try {
        await db.collection('okr_laggingIndicators').doc(lagId).update({
          name: newName,
          version: newVersion,
          target: newTarget,
          type: newType,
          valuePerUnit: newType === 'result' ? newValuePerUnit : 0,
          unit: newType === 'result' ? newUnit : '',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ë³€ê²½ ì´ë ¥ ì €ì¥
        await saveChangeLog('laggingIndicator', 'update', {
          id: lagId,
          changes: {
            name: { from: oldName, to: newName },
            version: { from: oldVersion, to: newVersion },
            type: { from: oldType, to: newType },
            valuePerUnit: { from: oldValuePerUnit, to: newValuePerUnit }
          }
        });

        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        lag.name = newName;
        lag.version = newVersion;
        lag.target = newTarget;
        lag.type = newType;
        lag.valuePerUnit = newType === 'result' ? newValuePerUnit : 0;
        lag.unit = newType === 'result' ? newUnit : '';

        showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

        // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
        const kpi = okrState.kpis.find(k => k.id === lag.kpiId);
        if (kpi) {
          const kr = okrState.keyResults.find(k => k.id === kpi.keyResultId);
          if (kr) {
            closeModal();
            openKrSelectionModal(kr.id);
            return;
          }
        }
        cancelDeleteLag();
      } catch (e) {
        console.error('ì§€í‘œ ìˆ˜ì • ì˜¤ë¥˜:', e);
        showToast('ìˆ˜ì • ì‹¤íŒ¨', 'error');
      }
    }

    // ë³€ê²½ ì´ë ¥ ì €ì¥
    async function saveChangeLog(entityType, action, data) {
      try {
        await db.collection('okr_changeLogs').add({
          entityType, // 'laggingIndicator', 'kpi', 'keyResult', 'dailyLog'
          action, // 'create', 'update', 'delete'
          data,
          userId: state.currentUser?.uid || 'anonymous',
          userName: state.currentUser?.name || 'ì‚¬ìš©ì',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        console.error('ë³€ê²½ ì´ë ¥ ì €ì¥ ì˜¤ë¥˜:', e);
      }
    }

    // ì‚­ì œ ì·¨ì†Œ
    function cancelDeleteLag() {
      const formArea = document.getElementById('workRecordFormArea');
      if (!formArea) return;

      formArea.innerHTML = `
        <div style="text-align: center; color: var(--gray-400);">
          <div style="font-size: 40px; margin-bottom: 12px;">ğŸ‘ˆ</div>
          <div style="font-size: 14px;">ì™¼ìª½ì—ì„œ ê¸°ë¡í• <br>í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
      `;
    }

    // ì§€í‘œ ì‚­ì œ ì‹¤í–‰
    async function executeDeleteLag(lagId) {
      const confirmInput = document.getElementById('deleteConfirmInput')?.value?.trim();

      if (confirmInput !== 'ì‚­ì œ') {
        showToast('"ì‚­ì œ"ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      const lag = okrState.laggingIndicators.find(l => l.id === lagId);
      if (!lag) return;

      try {
        await db.collection('okr_laggingIndicators').doc(lagId).delete();

        // ë³€ê²½ ì´ë ¥ ì €ì¥
        await saveChangeLog('laggingIndicator', 'delete', { id: lagId, name: lag.name });

        // ë¡œì»¬ ìƒíƒœì—ì„œ ì œê±°
        okrState.laggingIndicators = okrState.laggingIndicators.filter(l => l.id !== lagId);

        showToast(`"${lag.name}" ì‚­ì œë¨`, 'success');

        // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ KR ì°¾ê¸°)
        const kpi = okrState.kpis.find(k => k.id === lag.kpiId);
        if (kpi) {
          const kr = okrState.keyResults.find(k => k.id === kpi.keyResultId);
          if (kr) {
            closeModal();
            openKrSelectionModal(kr.id);
            return;
          }
        }
        closeModal();
      } catch (e) {
        console.error('ì§€í‘œ ì‚­ì œ ì˜¤ë¥˜:', e);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
      }
    }

    // í˜„ì¬ ì„ íƒëœ ì§€í‘œ ì •ë³´ ì €ì¥ (ë²„ì „ ì—…ë°ì´íŠ¸ ì‹œ í¼ ì¬ë Œë”ë§ìš©)
    let currentSelectedLag = null;

    // ë²„ì „ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    window.addEventListener('versionUpdated', () => {
      if (currentSelectedLag) {
        selectLagForRecord(
          currentSelectedLag.krId,
          currentSelectedLag.kpiId,
          currentSelectedLag.lagId,
          currentSelectedLag.krIdx
        );
      }
    });

    // ì§€í‘œ ì„ íƒ ì‹œ ì˜¤ë¥¸ìª½ì— ì…ë ¥ í¼ í‘œì‹œ
    function selectLagForRecord(krId, kpiId, lagId, krIdx) {
      // í˜„ì¬ ì„ íƒëœ ì§€í‘œ ì •ë³´ ì €ì¥
      currentSelectedLag = { krId, kpiId, lagId, krIdx };
      const kr = okrState.keyResults.find(k => k.id === krId);
      const kpi = okrState.kpis.find(k => k.id === kpiId);
      const lag = okrState.laggingIndicators.find(l => l.id === lagId);

      if (!kr || !kpi || !lag) return;

      // ì²¨ë¶€íŒŒì¼ ì´ˆê¸°í™”
      workRecordAttachments = [];

      // ëª¨ë“  ë²„íŠ¼ ì„ íƒ í•´ì œ
      document.querySelectorAll('[id^="lag-btn-"]').forEach(btn => {
        btn.classList.remove('selected');
        btn.style.borderColor = 'var(--gray-200)';
        btn.style.background = 'white';
      });

      // ì„ íƒëœ ë²„íŠ¼ í‘œì‹œ
      const selectedBtn = document.getElementById(`lag-btn-${lagId}`);
      if (selectedBtn) {
        selectedBtn.classList.add('selected');
        selectedBtn.style.borderColor = okrColors[krIdx];
        selectedBtn.style.background = `${okrColors[krIdx]}10`;
      }

      // ì˜¤ë¥¸ìª½ í¼ ì˜ì—­ ì—…ë°ì´íŠ¸
      const formArea = document.getElementById('workRecordFormArea');
      if (!formArea) return;

      formArea.innerHTML = `
        <div style="width: 100%;">
          <!-- í—¤ë” -->
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid ${okrColors[krIdx]};">
            <span style="font-size: 28px;">${getOkrLagIcon(lag.name)}</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: var(--gray-800);">${lag.name}</div>
              <div style="font-size: 11px; color: var(--gray-500);">${kr.name} â†’ ${kpi.name}</div>
            </div>
          </div>

          <!-- ë²„ì „ ì„ íƒ -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ·ï¸ ë²„ì „
            </label>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              ${okrState.versions.map((v, idx) => `
                <div style="position: relative; flex: ${v.fixed ? '1 1 0' : '0 0 auto'};">
                  <button type="button" id="versionBtn${v.id}" onclick="selectWorkVersion('${v.id}')"
                    style="width: 100%; min-width: ${v.fixed ? 'auto' : '80px'}; padding: 10px ${v.fixed ? '10px' : '28px 10px 10px'}; border: 2px solid ${idx === 0 ? okrColors[krIdx] : 'var(--gray-200)'}; border-radius: 8px; background: ${idx === 0 ? okrColors[krIdx] + '15' : 'white'}; color: ${idx === 0 ? okrColors[krIdx] : 'var(--gray-600)'}; font-size: 13px; font-weight: ${idx === 0 ? '700' : '600'}; cursor: pointer; white-space: nowrap;">
                    ${v.name}${v.fixed ? 'ë²„ì „' : ''}
                  </button>
                  ${!v.fixed ? `
                    <div style="position: absolute; top: 2px; right: 2px; display: flex; gap: 2px;">
                      <button onclick="event.stopPropagation(); editWorkVersion('${v.id}')"
                        style="width: 20px; height: 20px; padding: 0; border: none; border-radius: 4px; background: rgba(0,0,0,0.05); color: var(--gray-600); font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                        title="ìˆ˜ì •">âœï¸</button>
                      <button onclick="event.stopPropagation(); deleteWorkVersion('${v.id}')"
                        style="width: 20px; height: 20px; padding: 0; border: none; border-radius: 4px; background: rgba(255,0,0,0.05); color: var(--danger); font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                        title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
              <button type="button" onclick="addWorkVersion()"
                style="flex: 0 0 auto; min-width: 40px; padding: 10px; border: 2px dashed var(--gray-300); border-radius: 8px; background: white; color: var(--gray-500); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                title="ë²„ì „ ì¶”ê°€">â•</button>
            </div>
            <input type="hidden" id="workRecordVersion" value="A" />
          </div>

          <!-- ë²„ì „ ì„¤ëª… -->
          <div id="workRecordVersionDesc" style="margin-bottom: 16px; padding: 8px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 11px; color: var(--gray-600); background: var(--gray-50); min-height: 34px; max-height: 200px; overflow-y: auto; display: none;">
          </div>

          <!-- ìˆ˜ëŸ‰ ì…ë ¥ -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ“Š ìˆ˜ëŸ‰ <span style="color: var(--danger);">*</span>
            </label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button onclick="adjustWorkQuantity(-1)" style="width: 36px; height: 36px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; font-size: 18px; cursor: pointer;">-</button>
              <input type="number" id="workRecordQuantity" value="1" min="1" style="width: 80px; text-align: center; padding: 8px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 700;" />
              <button onclick="adjustWorkQuantity(1)" style="width: 36px; height: 36px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; font-size: 18px; cursor: pointer;">+</button>
            </div>
            <div style="font-size: 10px; color: var(--gray-500); margin-top: 4px;">í•´ë‹¹ í™œë™ì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”</div>
          </div>

          <!-- ë©”ëª¨ ì…ë ¥ -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ“ ë©”ëª¨ <span style="color: var(--gray-400); font-size: 11px;">(ì„ íƒ)</span>
            </label>
            <textarea id="workRecordMemo" placeholder="ì—…ë¬´ ë‚´ìš©, íŠ¹ì´ì‚¬í•­ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 13px; resize: none; height: 70px;"></textarea>
          </div>

          <!-- ì¦ë¹™ ìë£Œ ì²¨ë¶€ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ğŸ“ ì¦ë¹™ ìë£Œ <span style="color: var(--gray-400); font-size: 11px;">(ì„ íƒ)</span>
            </label>
            <div id="workRecordDropZone"
                 style="border: 2px dashed var(--gray-300); border-radius: 10px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s; background: white;"
                 onclick="document.getElementById('workRecordFileInput').click()"
                 ondragover="event.preventDefault(); this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)';"
                 ondragleave="this.style.borderColor='var(--gray-300)'; this.style.background='white';"
                 ondrop="handleWorkRecordDrop(event)">
              <div style="font-size: 24px; margin-bottom: 4px;">ğŸ“¤</div>
              <div style="font-size: 12px; color: var(--gray-600);">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
              <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">ì´ë¯¸ì§€ ìº¡ì²˜ í›„ Ctrl+Vë¡œ ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥</div>
            </div>
            <input type="file" id="workRecordFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.hwp" style="display: none;" onchange="handleWorkRecordFileSelect(event)" />

            <!-- ì²¨ë¶€ëœ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="workRecordAttachmentPreview" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
          </div>

          <!-- ê¸°ë¡ ë²„íŠ¼ -->
          <button onclick="submitWorkRecordInline('${krId}', '${kpiId}', '${lagId}')" style="width: 100%; padding: 14px; background: ${okrColors[krIdx]}; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer;">
            ê¸°ë¡í•˜ê¸°
          </button>
        </div>
      `;
    }

    // ë²„ì „ ì„ íƒ
    function selectWorkVersion(version) {
      document.getElementById('workRecordVersion').value = version;

      // í˜„ì¬ ì„ íƒëœ ë²„ì „ì˜ ì„¤ëª… í‘œì‹œ
      const versionObj = okrState.versions.find(v => v.id === version);
      const descDiv = document.getElementById('workRecordVersionDesc');
      if (descDiv && versionObj) {
        const description = versionObj.description || '';
        if (description) {
          descDiv.innerHTML = description;
          descDiv.style.display = 'block';
        } else {
          descDiv.innerHTML = '';
          descDiv.style.display = 'none';
        }
      }

      // ëª¨ë“  ë²„ì „ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
      okrState.versions.forEach(v => {
        const btn = document.getElementById(`versionBtn${v.id}`);
        if (btn) {
          if (v.id === version) {
            btn.style.borderColor = 'var(--primary)';
            btn.style.background = 'var(--primary-light)';
            btn.style.color = 'var(--primary)';
            btn.style.fontWeight = '700';
          } else {
            btn.style.borderColor = 'var(--gray-200)';
            btn.style.background = 'white';
            btn.style.color = 'var(--gray-600)';
            btn.style.fontWeight = '600';
          }
        }
      });
    }

    // ë²„ì „ ì¶”ê°€
    function addWorkVersion() {
      // ë‹¤ìŒ ë²„ì „ ID ìƒì„± (B, C, D, E...)
      const lastVersion = okrState.versions[okrState.versions.length - 1];
      const lastId = lastVersion.id;
      const nextId = String.fromCharCode(lastId.charCodeAt(0) + 1);

      // ëª¨ë‹¬ë¡œ ë²„ì „ ì´ë¦„ê³¼ ì„¤ëª… ì…ë ¥ë°›ê¸°
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700;">ìƒˆ ë²„ì „ ì¶”ê°€</h3>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ë²„ì „ëª… <span style="color: var(--danger);">*</span>
            </label>
            <input type="text" id="newVersionName" value="${nextId}" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" placeholder="ì˜ˆ: B, Plan B, í…ŒìŠ¤íŠ¸ë²„ì „ ë“±" />
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ì„¤ëª… <span style="color: var(--gray-400); font-size: 11px;">(ì„ íƒ - ì´ë¯¸ì§€ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)</span>
            </label>
            <div style="display: flex; gap: 8px; margin-bottom: 6px;">
              <input type="file" id="newVersionImageInput" accept="image/*" style="display: none;" onchange="handleVersionImageUpload(event, 'newVersionDesc')" />
              <button type="button" onclick="document.getElementById('newVersionImageInput').click()" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; color: var(--gray-600); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                ğŸ“ ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ
              </button>
              <span style="font-size: 11px; color: var(--gray-400); line-height: 28px;">ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°</span>
            </div>
            <div id="newVersionDesc" contenteditable="true" style="width: 100%; min-height: 80px; max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 13px; background: white;" placeholder="ì´ ë²„ì „ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></div>
          </div>

          <div style="display: flex; gap: 8px;">
            <button onclick="this.closest('div[style*=fixed]').remove()" style="flex: 1; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; color: var(--gray-700); font-size: 14px; font-weight: 600; cursor: pointer;">ì·¨ì†Œ</button>
            <button onclick="confirmAddVersion()" style="flex: 1; padding: 10px; border: none; border-radius: 8px; background: var(--primary); color: white; font-size: 14px; font-weight: 700; cursor: pointer;">ì¶”ê°€</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // ì´ë¦„ ì…ë ¥ í¬ì»¤ìŠ¤
      setTimeout(() => document.getElementById('newVersionName').focus(), 100);
    }

    // ë²„ì „ ì¶”ê°€ í™•ì¸
    function confirmAddVersion() {
      const nameInput = document.getElementById('newVersionName');
      const descInput = document.getElementById('newVersionDesc');
      const name = nameInput?.value.trim() || '';
      const description = descInput?.innerHTML.trim() || '';

      if (!name) {
        showToast('ë²„ì „ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      // ì¤‘ë³µ ì²´í¬
      if (okrState.versions.some(v => v.name === name)) {
        showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²„ì „ëª…ì…ë‹ˆë‹¤', 'error');
        return;
      }

      // ë‹¤ìŒ ID ìƒì„±
      const lastVersion = okrState.versions[okrState.versions.length - 1];
      const lastId = lastVersion.id;
      const nextId = String.fromCharCode(lastId.charCodeAt(0) + 1);

      // ë²„ì „ ì¶”ê°€
      const newVersion = {
        id: nextId,
        name: name,
        description: description,
        fixed: false
      };

      okrState.versions.push(newVersion);
      localStorage.setItem('okrVersions', JSON.stringify(okrState.versions));

      // ëª¨ë‹¬ ë‹«ê¸°
      document.querySelectorAll('div[style*=fixed]').forEach(el => {
        if (el.innerHTML.includes('ìƒˆ ë²„ì „ ì¶”ê°€')) el.remove();
      });

      showToast('ë²„ì „ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

      // ì—…ë¬´ê¸°ë¡ í¼ì´ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
      const formArea = document.getElementById('workRecordFormArea');
      if (formArea && formArea.innerHTML.includes('ë²„ì „')) {
        // í˜„ì¬ ì„ íƒëœ ì§€í‘œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const versionInput = document.getElementById('workRecordVersion');
        if (versionInput) {
          // í¼ì„ ë‹¤ì‹œ ë Œë”ë§í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ ë””ìŠ¤íŒ¨ì¹˜
          window.dispatchEvent(new CustomEvent('versionUpdated'));
        }
      }
    }

    // ë²„ì „ ìˆ˜ì •
    function editWorkVersion(versionId) {
      const version = okrState.versions.find(v => v.id === versionId);
      if (!version) return;

      if (version.fixed) {
        showToast('Aë²„ì „ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700;">ë²„ì „ ìˆ˜ì •</h3>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ë²„ì „ëª… <span style="color: var(--danger);">*</span>
            </label>
            <input type="text" id="editVersionName" value="${version.name}" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;" placeholder="ì˜ˆ: B, Plan B, í…ŒìŠ¤íŠ¸ë²„ì „ ë“±" />
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
              ì„¤ëª… <span style="color: var(--gray-400); font-size: 11px;">(ì„ íƒ - ì´ë¯¸ì§€ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)</span>
            </label>
            <div style="display: flex; gap: 8px; margin-bottom: 6px;">
              <input type="file" id="editVersionImageInput" accept="image/*" style="display: none;" onchange="handleVersionImageUpload(event, 'editVersionDesc')" />
              <button type="button" onclick="document.getElementById('editVersionImageInput').click()" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; color: var(--gray-600); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                ğŸ“ ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ
              </button>
              <span style="font-size: 11px; color: var(--gray-400); line-height: 28px;">ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°</span>
            </div>
            <div id="editVersionDesc" contenteditable="true" style="width: 100%; min-height: 80px; max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 13px; background: white;">${version.description || ''}</div>
          </div>

          <div style="display: flex; gap: 8px;">
            <button onclick="this.closest('div[style*=fixed]').remove()" style="flex: 1; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; color: var(--gray-700); font-size: 14px; font-weight: 600; cursor: pointer;">ì·¨ì†Œ</button>
            <button onclick="confirmEditVersion('${versionId}')" style="flex: 1; padding: 10px; border: none; border-radius: 8px; background: var(--primary); color: white; font-size: 14px; font-weight: 700; cursor: pointer;">ìˆ˜ì •</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // ì´ë¦„ ì…ë ¥ í¬ì»¤ìŠ¤
      setTimeout(() => document.getElementById('editVersionName').focus(), 100);
    }

    // ë²„ì „ ìˆ˜ì • í™•ì¸
    function confirmEditVersion(versionId) {
      const nameInput = document.getElementById('editVersionName');
      const descInput = document.getElementById('editVersionDesc');
      const name = nameInput?.value.trim() || '';
      const description = descInput?.innerHTML.trim() || '';

      if (!name) {
        showToast('ë²„ì „ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      // ì¤‘ë³µ ì²´í¬ (ìì‹  ì œì™¸)
      if (okrState.versions.some(v => v.id !== versionId && v.name === name)) {
        showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²„ì „ëª…ì…ë‹ˆë‹¤', 'error');
        return;
      }

      // ë²„ì „ ìˆ˜ì •
      const version = okrState.versions.find(v => v.id === versionId);
      if (version) {
        version.name = name;
        version.description = description;
        localStorage.setItem('okrVersions', JSON.stringify(okrState.versions));
      }

      // ëª¨ë‹¬ ë‹«ê¸°
      document.querySelectorAll('div[style*=fixed]').forEach(el => {
        if (el.innerHTML.includes('ë²„ì „ ìˆ˜ì •')) el.remove();
      });

      showToast('ë²„ì „ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

      // ì—…ë¬´ê¸°ë¡ í¼ì´ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
      window.dispatchEvent(new CustomEvent('versionUpdated'));
    }

    // ë²„ì „ ì‚­ì œ
    function deleteWorkVersion(versionId) {
      const version = okrState.versions.find(v => v.id === versionId);
      if (!version) return;

      if (version.fixed) {
        showToast('Aë²„ì „ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }

      if (!confirm(`"${version.name}" ë²„ì „ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      // ë²„ì „ ì‚­ì œ
      okrState.versions = okrState.versions.filter(v => v.id !== versionId);
      localStorage.setItem('okrVersions', JSON.stringify(okrState.versions));

      showToast('ë²„ì „ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

      // ì—…ë¬´ê¸°ë¡ í¼ì´ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
      window.dispatchEvent(new CustomEvent('versionUpdated'));
    }

    // ë²„ì „ ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    function handleVersionImageUpload(event, targetId) {
      const file = event.target.files?.[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        return;
      }

      // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì œí•œ)
      if (file.size > 5 * 1024 * 1024) {
        showToast('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.cssText = 'max-width: 100%; height: auto; border-radius: 8px; margin: 8px 0; display: block;';

        const target = document.getElementById(targetId);
        if (target) {
          target.appendChild(img);
          target.appendChild(document.createElement('br'));
        }
      };
      reader.readAsDataURL(file);

      // íŒŒì¼ input ì´ˆê¸°í™”
      event.target.value = '';
    }

    // contenteditable ì˜ì—­ì— ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupVersionDescPasteHandler() {
      // ëª¨ë“  ë²„ì „ ì„¤ëª… ì…ë ¥ ì˜ì—­ì— ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ì¶”ê°€
      document.addEventListener('paste', function(e) {
        const target = e.target;
        if (target.id !== 'newVersionDesc' && target.id !== 'editVersionDesc') return;

        const items = e.clipboardData?.items;
        if (!items) return;

        // ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
        for (let i = 0; i < items.length; i++) {
          if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();

            const file = items[i].getAsFile();
            if (!file) continue;

            // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì œí•œ)
            if (file.size > 5 * 1024 * 1024) {
              showToast('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤', 'error');
              continue;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
              const img = document.createElement('img');
              img.src = event.target.result;
              img.style.cssText = 'max-width: 100%; height: auto; border-radius: 8px; margin: 8px 0; display: block;';

              // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— ì´ë¯¸ì§€ ì‚½ì…
              const selection = window.getSelection();
              if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(img);
                range.insertNode(document.createElement('br'));

                // ì»¤ì„œë¥¼ ì´ë¯¸ì§€ ë’¤ë¡œ ì´ë™
                range.setStartAfter(img);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
              } else {
                target.appendChild(img);
                target.appendChild(document.createElement('br'));
              }
            };
            reader.readAsDataURL(file);
            break;
          }
        }
      });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶™ì—¬ë„£ê¸° í•¸ë“¤ëŸ¬ ì„¤ì •
    setupVersionDescPasteHandler();

    // ì¸ë¼ì¸ ì—…ë¬´ê¸°ë¡ ì œì¶œ
    async function submitWorkRecordInline(krId, kpiId, lagId) {
      const quantity = parseInt(document.getElementById('workRecordQuantity')?.value) || 1;
      const memo = document.getElementById('workRecordMemo')?.value || '';
      const version = document.getElementById('workRecordVersion')?.value || 'A';

      // ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
      let attachmentUrls = [];
      if (workRecordAttachments.length > 0) {
        showToast('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...', 'info');
        try {
          for (const att of workRecordAttachments) {
            const storageRef = firebase.storage().ref();
            const fileName = `okr_attachments/${state.currentUser?.uid || 'anonymous'}/${Date.now()}_${att.name}`;
            const fileRef = storageRef.child(fileName);
            await fileRef.put(att.file);
            const url = await fileRef.getDownloadURL();
            attachmentUrls.push({
              name: att.name,
              url,
              type: att.type,
              size: att.size
            });
          }
        } catch (e) {
          console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', e);
          showToast('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
        }
      }

      // ì—…ë¬´ ê¸°ë¡
      await recordOkrWork(krId, kpiId, lagId, quantity, memo, attachmentUrls, version);

      // í¼ ì´ˆê¸°í™” (ëª¨ë‹¬ ìœ ì§€)
      workRecordAttachments = [];
      const formArea = document.getElementById('workRecordFormArea');
      if (formArea) {
        formArea.innerHTML = `
          <div style="text-align: center; color: var(--success);">
            <div style="font-size: 48px; margin-bottom: 12px;">âœ…</div>
            <div style="font-size: 16px; font-weight: 600;">ê¸°ë¡ ì™„ë£Œ!</div>
            <div style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">ë‹¤ë¥¸ í•­ëª©ì„ ì„ íƒí•˜ê±°ë‚˜<br>ë‹«ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
          </div>
        `;
      }
    }

    // ëª¨ë‹¬ì—ì„œ ì—…ë¬´ ê¸°ë¡ (ì‹œê°„ ë°ì´í„° í¬í•¨)
    async function recordOkrWorkFromModal(krId, kpiId, lagId) {
      closeModal();
      await recordOkrWork(krId, kpiId, lagId);
    }

    // ì—…ë¬´ê¸°ë¡ ì…ë ¥ìš© ì„ì‹œ ìƒíƒœ
    let workRecordAttachments = [];

    // ì—…ë¬´ê¸°ë¡ ìƒì„¸ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
    function openWorkRecordInputModal(krId, kpiId, lagId) {
      const kr = okrState.keyResults.find(k => k.id === krId);
      const kpi = okrState.kpis.find(k => k.id === kpiId);
      const lag = okrState.laggingIndicators.find(l => l.id === lagId);
      const krIdx = okrState.keyResults.findIndex(k => k.id === krId);

      if (!kr || !kpi || !lag) return;

      // ì²¨ë¶€íŒŒì¼ ì´ˆê¸°í™”
      workRecordAttachments = [];

      showModal(`
        <div style="padding: 24px; max-width: 500px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid ${okrColors[krIdx]};">
            <span style="font-size: 32px;">${getOkrLagIcon(lag.name)}</span>
            <div>
              <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${lag.name}</div>
              <div style="font-size: 12px; color: var(--gray-500);">${kr.name} â†’ ${kpi.name}</div>
            </div>
          </div>

          <!-- ìˆ˜ëŸ‰ ì…ë ¥ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
              ğŸ“Š ìˆ˜ëŸ‰ <span style="color: var(--danger);">*</span>
            </label>
            <div style="display: flex; align-items: center; gap: 12px;">
              <button onclick="adjustWorkQuantity(-1)" style="width: 40px; height: 40px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; font-size: 20px; cursor: pointer;">-</button>
              <input type="number" id="workRecordQuantity" value="1" min="1" style="width: 100px; text-align: center; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 18px; font-weight: 700;" />
              <button onclick="adjustWorkQuantity(1)" style="width: 40px; height: 40px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; font-size: 20px; cursor: pointer;">+</button>
            </div>
            <div style="font-size: 11px; color: var(--gray-500); margin-top: 6px;">í•´ë‹¹ í™œë™ì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”</div>
          </div>

          <!-- ë©”ëª¨ ì…ë ¥ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
              ğŸ“ ë©”ëª¨ <span style="color: var(--gray-400); font-size: 12px;">(ì„ íƒ)</span>
            </label>
            <textarea id="workRecordMemo" placeholder="ì—…ë¬´ ë‚´ìš©, íŠ¹ì´ì‚¬í•­ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; resize: none; height: 80px;"></textarea>
          </div>

          <!-- ì¦ë¹™ ìë£Œ ì²¨ë¶€ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
              ğŸ“ ì¦ë¹™ ìë£Œ <span style="color: var(--gray-400); font-size: 12px;">(ì„ íƒ)</span>
            </label>
            <div id="workRecordDropZone"
                 style="border: 2px dashed var(--gray-300); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--gray-50);"
                 onclick="document.getElementById('workRecordFileInput').click()"
                 ondragover="event.preventDefault(); this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)';"
                 ondragleave="this.style.borderColor='var(--gray-300)'; this.style.background='var(--gray-50)';"
                 ondrop="handleWorkRecordDrop(event)">
              <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“¤</div>
              <div style="font-size: 13px; color: var(--gray-600);">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
              <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px;">ì´ë¯¸ì§€ ìº¡ì²˜ í›„ Ctrl+Vë¡œ ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥</div>
            </div>
            <input type="file" id="workRecordFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.hwp" style="display: none;" onchange="handleWorkRecordFileSelect(event)" />

            <!-- ì²¨ë¶€ëœ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="workRecordAttachmentPreview" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;"></div>
          </div>

          <!-- ë²„íŠ¼ -->
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="submitWorkRecord('${krId}', '${kpiId}', '${lagId}')" style="background: ${okrColors[krIdx]};">
              ê¸°ë¡í•˜ê¸°
            </button>
          </div>
        </div>
      `);

      // ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      setTimeout(() => {
        const dropZone = document.getElementById('workRecordDropZone');
        if (dropZone) {
          document.addEventListener('paste', handleWorkRecordPaste);
        }
      }, 100);
    }

    // ìˆ˜ëŸ‰ ì¡°ì ˆ
    function adjustWorkQuantity(delta) {
      const input = document.getElementById('workRecordQuantity');
      if (!input) return;
      const current = parseInt(input.value) || 1;
      const newVal = Math.max(1, current + delta);
      input.value = newVal;
    }

    // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
    function handleWorkRecordFileSelect(event) {
      const files = event.target.files;
      if (!files) return;
      for (let i = 0; i < files.length; i++) {
        addWorkRecordAttachment(files[i]);
      }
    }

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
    function handleWorkRecordDrop(event) {
      event.preventDefault();
      const dropZone = document.getElementById('workRecordDropZone');
      if (dropZone) {
        dropZone.style.borderColor = 'var(--gray-300)';
        dropZone.style.background = 'var(--gray-50)';
      }

      const files = event.dataTransfer.files;
      for (let i = 0; i < files.length; i++) {
        addWorkRecordAttachment(files[i]);
      }
    }

    // ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬
    function handleWorkRecordPaste(event) {
      const items = event.clipboardData?.items;
      if (!items) return;

      for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
          event.preventDefault();
          const file = items[i].getAsFile();
          if (file) {
            addWorkRecordAttachment(file);
          }
        }
      }
    }

    // ì²¨ë¶€íŒŒì¼ ì¶”ê°€
    function addWorkRecordAttachment(file) {
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        return;
      }

      const id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      const isImage = file.type.startsWith('image/');

      const attachment = {
        id,
        file,
        name: file.name,
        type: file.type,
        size: file.size,
        isImage
      };

      // ì´ë¯¸ì§€ì¸ ê²½ìš° ë¯¸ë¦¬ë³´ê¸° ìƒì„±
      if (isImage) {
        const reader = new FileReader();
        reader.onload = (e) => {
          attachment.preview = e.target.result;
          workRecordAttachments.push(attachment);
          renderWorkRecordAttachments();
        };
        reader.readAsDataURL(file);
      } else {
        workRecordAttachments.push(attachment);
        renderWorkRecordAttachments();
      }
    }

    // ì²¨ë¶€íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
    function renderWorkRecordAttachments() {
      const container = document.getElementById('workRecordAttachmentPreview');
      if (!container) return;

      if (workRecordAttachments.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = workRecordAttachments.map(att => {
        const sizeKB = Math.round(att.size / 1024);
        const sizeStr = sizeKB > 1024 ? `${(sizeKB / 1024).toFixed(1)}MB` : `${sizeKB}KB`;

        if (att.isImage && att.preview) {
          return `
            <div style="position: relative; display: inline-block;">
              <img src="${att.preview}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid var(--gray-200);" />
              <button onclick="removeWorkRecordAttachment('${att.id}')" style="position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); color: white; border: none; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">Ã—</button>
            </div>
          `;
        } else {
          return `
            <div style="position: relative; display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--gray-100); border-radius: 8px;">
              <span style="font-size: 16px;">ğŸ“„</span>
              <div>
                <div style="font-size: 12px; color: var(--gray-700); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${att.name}</div>
                <div style="font-size: 10px; color: var(--gray-500);">${sizeStr}</div>
              </div>
              <button onclick="removeWorkRecordAttachment('${att.id}')" style="width: 20px; height: 20px; border-radius: 50%; background: var(--danger); color: white; border: none; font-size: 12px; cursor: pointer;">Ã—</button>
            </div>
          `;
        }
      }).join('');
    }

    // ì²¨ë¶€íŒŒì¼ ì œê±°
    function removeWorkRecordAttachment(id) {
      workRecordAttachments = workRecordAttachments.filter(att => att.id !== id);
      renderWorkRecordAttachments();
    }

    // ì—…ë¬´ê¸°ë¡ ì œì¶œ
    async function submitWorkRecord(krId, kpiId, lagId) {
      const quantity = parseInt(document.getElementById('workRecordQuantity')?.value) || 1;
      const memo = document.getElementById('workRecordMemo')?.value || '';

      // ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
      document.removeEventListener('paste', handleWorkRecordPaste);

      closeModal();

      // ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
      let attachmentUrls = [];
      if (workRecordAttachments.length > 0) {
        showToast('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...', 'info');
        try {
          for (const att of workRecordAttachments) {
            const storageRef = firebase.storage().ref();
            const fileName = `okr_attachments/${state.currentUser?.uid || 'anonymous'}/${Date.now()}_${att.name}`;
            const fileRef = storageRef.child(fileName);
            await fileRef.put(att.file);
            const url = await fileRef.getDownloadURL();
            attachmentUrls.push({
              name: att.name,
              url,
              type: att.type,
              size: att.size
            });
          }
        } catch (e) {
          console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', e);
          showToast('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
        }
      }

      // ì—…ë¬´ ê¸°ë¡
      await recordOkrWork(krId, kpiId, lagId, quantity, memo, attachmentUrls);
    }

    // ì—…ë¬´ê¸°ë¡ ìƒì„¸ë³´ê¸° ëª¨ë‹¬
    function viewWorkRecordDetail(logId) {
      const log = okrState.dailyLogs.find(l => l.id === logId);
      if (!log) return;

      const kr = okrState.keyResults.find(k => k.id === log.krId);
      const kpi = okrState.kpis.find(k => k.id === log.kpiId);
      const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
      const krIdx = okrState.keyResults.findIndex(k => k.id === log.krId);

      let attachmentsHtml = '';
      if (log.attachments && log.attachments.length > 0) {
        attachmentsHtml = `
          <div style="margin-top: 16px;">
            <div style="font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">ğŸ“ ì¦ë¹™ ìë£Œ (${log.attachments.length}ê°œ)</div>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
              ${log.attachments.map(att => {
                const isImage = att.type && att.type.startsWith('image/');
                if (isImage) {
                  return `
                    <a href="${att.url}" target="_blank" style="display: block;">
                      <img src="${att.url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid var(--gray-200); cursor: pointer;" title="${att.name}" />
                    </a>
                  `;
                } else {
                  return `
                    <a href="${att.url}" target="_blank" style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--gray-100); border-radius: 8px; text-decoration: none; color: var(--gray-700);">
                      <span style="font-size: 20px;">ğŸ“„</span>
                      <div>
                        <div style="font-size: 13px; font-weight: 500;">${att.name}</div>
                        <div style="font-size: 11px; color: var(--gray-500);">${Math.round(att.size / 1024)}KB</div>
                      </div>
                    </a>
                  `;
                }
              }).join('')}
            </div>
          </div>
        `;
      }

      showModal(`
        <div style="padding: 24px; max-width: 500px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid ${okrColors[krIdx] || 'var(--gray-300)'};">
            <span style="font-size: 32px;">${getOkrLagIcon(lag?.name || '')}</span>
            <div style="flex: 1;">
              <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${lag?.name || 'ì—…ë¬´'}</div>
              <div style="font-size: 12px; color: var(--gray-500);">${kr?.name || ''} â†’ ${kpi?.name || ''}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 24px; font-weight: 800; color: var(--success);">+${log.resultValue || 1}</div>
              <div style="font-size: 11px; color: var(--gray-400);">${log.registeredTime || ''}</div>
            </div>
          </div>

          <div style="background: var(--gray-50); border-radius: 12px; padding: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
              <div>
                <div style="color: var(--gray-500); margin-bottom: 4px;">ê¸°ë¡ì¼</div>
                <div style="font-weight: 600;">${log.date}</div>
              </div>
              <div>
                <div style="color: var(--gray-500); margin-bottom: 4px;">ê¸°ë¡ì</div>
                <div style="font-weight: 600;">${log.memberName || 'ì‚¬ìš©ì'}</div>
              </div>
            </div>
          </div>

          ${log.memo ? `
            <div style="margin-top: 16px;">
              <div style="font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ğŸ“ ë©”ëª¨</div>
              <div style="background: var(--gray-50); border-radius: 8px; padding: 12px; font-size: 14px; color: var(--gray-700); line-height: 1.6;">${log.memo}</div>
            </div>
          ` : ''}

          ${attachmentsHtml}

          <div style="margin-top: 24px; display: flex; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          </div>
        </div>
      `);
    }

    // ê²€ìƒ‰ í•„í„°
    function filterOkrRecordButtons() {
      const searchInput = document.getElementById('okrRecordSearch');
      okrState.searchQuery = searchInput?.value || '';
      renderOkrRecord();
    }

    // ì¦ê²¨ì°¾ê¸° í•„í„° í† ê¸€
    function toggleFavoriteFilter() {
      okrState.showFavoritesOnly = !okrState.showFavoritesOnly;
      const btn = document.getElementById('favoriteFilterBtn');
      if (btn) {
        btn.style.background = okrState.showFavoritesOnly ? 'var(--warning)' : '';
        btn.style.color = okrState.showFavoritesOnly ? 'white' : '';
      }
      renderOkrRecord();
    }

    // ì¦ê²¨ì°¾ê¸° í† ê¸€
    function toggleOkrFavorite(lagId) {
      const idx = okrState.favorites.indexOf(lagId);
      if (idx === -1) {
        okrState.favorites.push(lagId);
      } else {
        okrState.favorites.splice(idx, 1);
      }
      localStorage.setItem('okrFavorites', JSON.stringify(okrState.favorites));
      renderOkrRecord();
    }

    // ë§ˆì§€ë§‰ ê¸°ë¡ (Undoìš©)
    let lastOkrLog = null;
    let undoTimeout = null;

    // ì—…ë¬´ ê¸°ë¡
    // ì‹œê°„ í¬ë§· í•¨ìˆ˜
    function formatTime(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    async function recordOkrWork(krId, kpiId, lagId, quantity = 1, memo = '', attachments = [], version = 'A') {
      try {
        const now = new Date();
        const registeredTime = formatTime(now);

        const log = {
          date: okrToday,
          memberId: state.currentUser?.uid || 'anonymous',
          memberName: state.currentUser?.name || 'ì‚¬ìš©ì',
          krId, kpiId, laggingIndicatorId: lagId,
          resultValue: quantity,
          // ë²„ì „ ì¶”ê°€
          version: version,
          // ë©”ëª¨ ì¶”ê°€
          memo: memo,
          // ì¦ë¹™ ìë£Œ ì²¨ë¶€
          attachments: attachments,
          // ì‹œê°„ ë°ì´í„° ì¶”ê°€
          registeredTime: registeredTime,
          registeredTimestamp: now.getTime(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const docRef = await db.collection('okr_dailyLogs').add(log);
        const logWithId = { ...log, id: docRef.id };

        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        okrState.dailyLogs.unshift(logWithId);
        okrState.todayLogs = okrState.dailyLogs.filter(l => l.date === okrToday);

        // Undoë¥¼ ìœ„í•´ ë§ˆì§€ë§‰ ê¸°ë¡ ì €ì¥
        lastOkrLog = logWithId;

        renderOkrDashboard();
        renderOkrRecord();

        // Undo ì•Œë¦¼ í‘œì‹œ
        const lag = okrState.laggingIndicators.find(l => l.id === lagId);
        const versionObj = okrState.versions.find(v => v.id === version);
        const versionName = versionObj ? (versionObj.fixed ? `${versionObj.name}ë²„ì „` : versionObj.name) : (version || 'Aë²„ì „');
        const quantityText = quantity > 1 ? ` (${quantity}ê±´)` : '';
        const versionText = ` [${versionName}]`;
        showUndoNotification(`${lag?.name || 'ì—…ë¬´'}${versionText}${quantityText}`);
      } catch (e) {
        console.error('ê¸°ë¡ ì˜¤ë¥˜:', e);
        showToast('ê¸°ë¡ ì‹¤íŒ¨', 'error');
      }
    }

    // ì—…ë¬´ê¸°ë¡ ì‚­ì œ (í™•ì¸ ì ˆì°¨ í¬í•¨)
    async function deleteOkrLog(logId) {
      if (!logId) return;

      const log = okrState.dailyLogs.find(l => l.id === logId);
      if (!log) {
        showToast('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }

      const lag = okrState.laggingIndicators.find(l => l.id === log.laggingIndicatorId);
      const confirmMsg = `"${lag?.name || 'ì—…ë¬´'}" ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

      if (!confirm(confirmMsg)) return;

      try {
        await db.collection('okr_dailyLogs').doc(logId).delete();

        // ë¡œì»¬ ìƒíƒœì—ì„œ ì œê±°
        okrState.dailyLogs = okrState.dailyLogs.filter(l => l.id !== logId);
        okrState.todayLogs = okrState.dailyLogs.filter(l => l.date === okrToday);

        showToast('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

        renderOkrDashboard();
        renderOkrRecord();
      } catch (e) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', e);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
      }
    }

    // Undo ì•Œë¦¼ í‘œì‹œ
    function showUndoNotification(itemName) {
      const notification = document.getElementById('okrUndoNotification');
      const message = document.getElementById('okrUndoMessage');
      if (!notification || !message) return;

      message.textContent = `"${itemName}" ê¸°ë¡ë¨`;
      notification.style.display = 'flex';

      // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
      if (undoTimeout) clearTimeout(undoTimeout);
      undoTimeout = setTimeout(() => {
        hideUndoNotification();
      }, 5000);
    }

    // Undo ì•Œë¦¼ ìˆ¨ê¸°ê¸°
    function hideUndoNotification() {
      const notification = document.getElementById('okrUndoNotification');
      if (notification) notification.style.display = 'none';
      if (undoTimeout) {
        clearTimeout(undoTimeout);
        undoTimeout = null;
      }
    }

    // ì—…ë¬´ ê¸°ë¡ ì‹¤í–‰ ì·¨ì†Œ
    async function undoOkrWork() {
      if (!lastOkrLog || !lastOkrLog.id) {
        showToast('ì·¨ì†Œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }

      try {
        // Firestoreì—ì„œ ì‚­ì œ
        await db.collection('okr_dailyLogs').doc(lastOkrLog.id).delete();

        // ë¡œì»¬ ìƒíƒœì—ì„œ ì œê±°
        okrState.dailyLogs = okrState.dailyLogs.filter(l => l.id !== lastOkrLog.id);
        okrState.todayLogs = okrState.dailyLogs.filter(l => l.date === okrToday);

        const lag = okrState.laggingIndicators.find(l => l.id === lastOkrLog.laggingIndicatorId);
        showToast(`"${lag?.name || 'ì—…ë¬´'}" ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');

        lastOkrLog = null;
        hideUndoNotification();

        renderOkrDashboard();
        renderOkrRecord();
      } catch (e) {
        console.error('Undo ì˜¤ë¥˜:', e);
        showToast('ì·¨ì†Œ ì‹¤íŒ¨', 'error');
      }
    }

    // ========================================
    // ìš´ì˜ì„¼í„° í™œë™ ë‚´ì—­ í€µë°°ë„ˆ
    // ========================================
    let opsCenterActivities = [];

    // ìš´ì˜ì„¼í„° ë°°ë„ˆ í‘œì‹œ (OKR íƒ­ì—ì„œë§Œ)
    function showOpsCenterBanner() {
      const banner = document.getElementById('opsCenterQuickBanner');
      if (banner) banner.style.display = 'block';
      loadOpsCenterActivities();
    }

    // ìš´ì˜ì„¼í„° ë°°ë„ˆ ìˆ¨ê¸°ê¸°
    function hideOpsCenterBanner() {
      const banner = document.getElementById('opsCenterQuickBanner');
      if (banner) banner.style.display = 'none';
    }

    // ìš´ì˜ì„¼í„° ë°°ë„ˆ í¼ì¹¨/ì ‘ê¸° í† ê¸€
    function toggleOpsBanner(expand) {
      const mini = document.getElementById('opsBannerMini');
      const expanded = document.getElementById('opsBannerExpanded');
      if (!mini || !expanded) return;

      if (expand) {
        mini.style.display = 'none';
        expanded.style.display = 'block';
        renderOpsBannerContent();
      } else {
        mini.style.display = 'flex';
        expanded.style.display = 'none';
      }
    }

    // ìš´ì˜ì„¼í„° í™œë™ ë‚´ì—­ ë¡œë“œ (ìµœê·¼ 7ì¼)
    async function loadOpsCenterActivities() {
      try {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

        // ìš´ì˜ì„¼í„° í™œë™ ë¡œê·¸ ì»¬ë ‰ì…˜ì—ì„œ ë¡œë“œ (ops_activity_logs)
        const snapshot = await db.collection('ops_activity_logs')
          .where('date', '>=', sevenDaysAgoStr)
          .orderBy('date', 'desc')
          .orderBy('createdAt', 'desc')
          .limit(20)
          .get();

        opsCenterActivities = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // ë°°ì§€ ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜ í™œë™ ìˆ˜)
        const todayActivities = opsCenterActivities.filter(a => a.date === okrToday);
        const badge = document.getElementById('opsBadge');
        if (badge) {
          if (todayActivities.length > 0) {
            badge.textContent = todayActivities.length;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (e) {
        console.log('ìš´ì˜ì„¼í„° í™œë™ ë¡œë“œ:', e.message);
        // ì»¬ë ‰ì…˜ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ìœ ì§€
        opsCenterActivities = [];
      }
    }

    // ìš´ì˜ì„¼í„° ë°°ë„ˆ ë‚´ìš© ë Œë”ë§
    function renderOpsBannerContent() {
      const container = document.getElementById('opsBannerContent');
      if (!container) return;

      if (opsCenterActivities.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 30px 20px;">
            <div style="font-size: 40px; margin-bottom: 12px;">ğŸ“‹</div>
            <div style="color: var(--gray-500); font-size: 13px;">ìµœê·¼ 7ì¼ê°„ ìš´ì˜ì„¼í„° í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="color: var(--gray-400); font-size: 12px; margin-top: 8px;">ìš´ì˜ì„¼í„°ì—ì„œ ì‘ì—…ì„ ê¸°ë¡í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
      const grouped = {};
      opsCenterActivities.forEach(activity => {
        const date = activity.date || 'ë‚ ì§œ ì—†ìŒ';
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(activity);
      });

      const today = okrToday;
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().split('T')[0];

      container.innerHTML = Object.entries(grouped).map(([date, activities]) => {
        let dateLabel = date;
        if (date === today) dateLabel = 'ì˜¤ëŠ˜';
        else if (date === yesterdayStr) dateLabel = 'ì–´ì œ';
        else dateLabel = date.slice(5).replace('-', '/');

        return `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 11px; font-weight: 700; color: var(--gray-400); margin-bottom: 8px; text-transform: uppercase;">${dateLabel}</div>
            ${activities.map(a => `
              <div style="display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 6px;">
                <span style="font-size: 16px;">${getOpsActivityIcon(a.type)}</span>
                <div style="flex: 1;">
                  <div style="font-size: 13px; font-weight: 600; color: var(--gray-700);">${a.title || a.type || 'í™œë™'}</div>
                  <div style="font-size: 11px; color: var(--gray-500);">${a.description || ''}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('');
    }

    // ìš´ì˜ì„¼í„° í™œë™ ì•„ì´ì½˜
    function getOpsActivityIcon(type) {
      const icons = {
        'deal': 'ğŸ’°',
        'meeting': 'ğŸ¤',
        'call': 'ğŸ“',
        'email': 'ğŸ“§',
        'report': 'ğŸ“Š',
        'task': 'âœ…',
        'visit': 'ğŸš—',
        'contract': 'ğŸ“',
        'support': 'ğŸ› ï¸',
        'inquiry': 'â“'
      };
      return icons[type] || 'ğŸ“Œ';
    }

    // OKR ëª©í‘œì„¤ì • ë Œë”ë§
    function renderOkrSettings() {
      const container = document.getElementById('okrSettingsContent');
      if (!container) return;

      // ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
      const isAdmin = state.currentUser?.role === 'admin';

      // ëª©í‘œ ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¹€/í‘œì‹œ
      const objEditBtn = document.getElementById('okrObjectiveEditBtn');
      if (objEditBtn) {
        objEditBtn.style.display = isAdmin ? 'inline-block' : 'none';
      }

      const lockBadge = !isAdmin ? `
        <div style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: var(--warning-light); border: 1px solid var(--warning); border-radius: 10px; margin-bottom: 20px;">
          <span style="font-size: 20px;">ğŸ”’</span>
          <div>
            <div style="font-size: 14px; font-weight: 600; color: var(--warning);">ë³´ê¸° ì „ìš© ëª¨ë“œ</div>
            <div style="font-size: 12px; color: var(--gray-600);">ëª©í‘œì„¤ì • ìˆ˜ì •ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
          </div>
        </div>
      ` : '';

      container.innerHTML = `
        ${lockBadge}
        <div style="background: linear-gradient(135deg, var(--primary-light, #EBF5FF), #DDD6FE); border: 2px solid var(--primary); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">ğŸ¯ ìµœì¢… ëª©í‘œ (O)</div>
          </div>
          ${okrState.objective ? `
            <div style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${okrState.objective.name}</div>
            <div style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">${okrState.objective.startDate || ''} ~ ${okrState.objective.endDate || ''}</div>
          ` : '<div style="color: var(--gray-500);">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>'}
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 8px;">ğŸ“ˆ í•µì‹¬ ê²°ê³¼ (KR)</div>
          ${isAdmin ? `<button class="btn btn-primary" onclick="openOkrKRModal()" ${!okrState.objective ? 'disabled' : ''}>+ KR ì¶”ê°€</button>` : ''}
        </div>

        <div style="display: flex; flex-direction: column; gap: 16px;">
          ${okrState.keyResults.map((kr, idx) => {
            const kpisForKR = okrState.kpis.filter(k => k.keyResultId === kr.id);
            return `
              <div class="card" style="border-left: 4px solid ${okrColors[idx]};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <div style="font-size: 16px; font-weight: 700; color: var(--gray-800);">${kr.name}</div>
                  ${isAdmin ? `
                    <div>
                      <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openOkrKRModal('${kr.id}')">í¸ì§‘</button>
                      <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openOkrKPIModal('${kr.id}')">+ KPI</button>
                    </div>
                  ` : ''}
                </div>
                <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">ëª©í‘œ: ${formatAmountWithSummary(kr.targetValue || 0, kr.unit || '')}</div>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-left: 16px;">
                  ${kpisForKR.map(kpi => {
                    const lagsForKPI = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
                    const resultCount = lagsForKPI.filter(l => l.type === 'result').length;
                    const activityCount = lagsForKPI.filter(l => l.type !== 'result').length;
                    return `
                      <div style="padding: 12px 16px; background: var(--gray-50); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                          <div style="font-size: 14px; font-weight: 600; color: var(--gray-700);">${kpi.name}</div>
                          <div style="font-size: 13px; color: var(--gray-500);">ëª©í‘œ: ${formatAmountWithSummary(kpi.targetValue || 0, kpi.unit || '')}</div>
                          <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px;">
                            ì§€í‘œ: ${lagsForKPI.length}ê°œ
                            ${resultCount > 0 ? `<span style="color: var(--success);">(ğŸ’°ì„±ê³¼ ${resultCount})</span>` : ''}
                            ${activityCount > 0 ? `<span style="color: var(--gray-500);">(ğŸ“‹í™œë™ ${activityCount})</span>` : ''}
                          </div>
                        </div>
                        ${isAdmin ? `<button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" onclick="openOkrKPIModal('${kr.id}', '${kpi.id}')">í¸ì§‘</button>` : ''}
                      </div>
                    `;
                  }).join('')}
                  ${kpisForKR.length === 0 ? '<div style="color: var(--gray-400); font-size: 13px;">KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>' : ''}
                </div>
              </div>
            `;
          }).join('')}
          ${okrState.keyResults.length === 0 ? '<div class="card" style="text-align: center; padding: 40px; color: var(--gray-400);">KRì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>' : ''}
        </div>
      `;
    }

    // OKR ì‹¤í—˜ë¶„ì„ ë Œë”ë§
    function renderOkrExperiment() {
      const container = document.getElementById('okrExperimentContent');
      if (!container) return;

      if (okrState.kpis.length === 0) {
        container.innerHTML = `<div class="card" style="text-align: center; padding: 60px;"><div style="font-size: 64px; margin-bottom: 16px;">ğŸ”¬</div><div style="font-size: 18px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">KPIë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</div></div>`;
        return;
      }

      // ì „ì²´ ì‹¤í—˜ í˜„í™© ë¶„ì„
      const experimentSummary = analyzeAllExperiments();

      container.innerHTML = `
        <!-- ì‹¤í—˜ í˜„í™© ìš”ì•½ ëŒ€ì‹œë³´ë“œ -->
        <div class="card" style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
            <div style="text-align: center;">
              <div style="font-size: 36px; font-weight: 800;">${experimentSummary.totalKPIs}</div>
              <div style="font-size: 13px; opacity: 0.9;">ì´ KPI</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 36px; font-weight: 800;">${experimentSummary.kpisWithMultipleVersions}</div>
              <div style="font-size: 13px; opacity: 0.9;">ì‹¤í—˜ ì¤‘ì¸ KPI</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 36px; font-weight: 800;">${experimentSummary.totalVersions}</div>
              <div style="font-size: 13px; opacity: 0.9;">ì´ ë²„ì „ ìˆ˜</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 36px; font-weight: 800;">${experimentSummary.decisionsNeeded}</div>
              <div style="font-size: 13px; opacity: 0.9;">íŒë‹¨ í•„ìš”</div>
            </div>
          </div>
        </div>

        <!-- í•µì‹¬ ì¸ì‚¬ì´íŠ¸ (íŒë‹¨ í•„ìš”í•œ ì‹¤í—˜ì´ ìˆì„ ë•Œë§Œ) -->
        ${experimentSummary.decisionsNeeded > 0 ? `
        <div class="card" style="background: var(--warning-light); border-left: 4px solid var(--warning); margin-bottom: 20px;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <span style="font-size: 24px;">âš ï¸</span>
            <div>
              <div style="font-size: 15px; font-weight: 700; color: var(--gray-800); margin-bottom: 8px;">íŒë‹¨ì´ í•„ìš”í•œ ì‹¤í—˜ì´ ìˆìŠµë‹ˆë‹¤</div>
              <div style="font-size: 13px; color: var(--gray-600); line-height: 1.6;">
                ${experimentSummary.decisionsNeeded}ê°œì˜ KPIì—ì„œ ì¶©ë¶„í•œ ë°ì´í„°ê°€ ìŒ“ì—¬ ë²„ì „ ì„ íƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                ì•„ë˜ì—ì„œ ê° ì‹¤í—˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  <strong>ìŠ¹ì ë²„ì „ì„ ì„ ì •</strong>í•˜ì„¸ìš”.
              </div>
            </div>
          </div>
        </div>
        ` : ''}

        <!-- ì‹¤í—˜ë³„ ìƒì„¸ ë¶„ì„ -->
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 8px;">
              ğŸ”¬ ì‹¤í—˜ë³„ ìƒì„¸ ë¶„ì„
            </div>
            <select id="okrExperimentKPISelect" onchange="renderOkrExperimentResults()" style="padding: 10px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; min-width: 250px; cursor: pointer; font-family: inherit;">
              <option value="">ì „ì²´ ì‹¤í—˜ í˜„í™© ë³´ê¸°</option>
              ${okrState.kpis.filter(kpi => {
                const lags = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
                return lags.length >= 1;
              }).map(kpi => {
                const lags = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
                const hasMultiple = lags.length > 1;
                return `<option value="${kpi.id}">${kpi.name} ${hasMultiple ? '(ì‹¤í—˜ì¤‘ ' + lags.length + 'ê°œ ë²„ì „)' : ''}</option>`;
              }).join('')}
            </select>
          </div>
          <div id="okrExperimentResults">
            ${renderAllExperimentsOverview()}
          </div>
        </div>
      `;
    }

    // ì „ì²´ ì‹¤í—˜ í˜„í™© ë¶„ì„
    function analyzeAllExperiments() {
      const totalKPIs = okrState.kpis.length;
      let kpisWithMultipleVersions = 0;
      let totalVersions = 0;
      let decisionsNeeded = 0;

      okrState.kpis.forEach(kpi => {
        const lags = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
        totalVersions += lags.length;
        if (lags.length > 1) {
          kpisWithMultipleVersions++;
          // ì¶©ë¶„í•œ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ê° ë²„ì „ì— ìµœì†Œ 5ê±´ ì´ìƒ)
          const hasEnoughData = lags.every(lag => {
            const logs = okrState.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
            return logs.length >= 5;
          });
          if (hasEnoughData) decisionsNeeded++;
        }
      });

      return { totalKPIs, kpisWithMultipleVersions, totalVersions, decisionsNeeded };
    }

    // ì „ì²´ ì‹¤í—˜ í˜„í™© ì˜¤ë²„ë·° ë Œë”ë§
    function renderAllExperimentsOverview() {
      const kpisWithExperiments = okrState.kpis.filter(kpi => {
        const lags = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
        return lags.length >= 1;
      });

      if (kpisWithExperiments.length === 0) {
        return `<div style="text-align: center; padding: 40px; color: var(--gray-400);">
          <div style="font-size: 48px; margin-bottom: 12px;">ğŸ”¬</div>
          <div>ë“±ë¡ëœ ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>`;
      }

      return `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          ${kpisWithExperiments.map(kpi => {
            const kr = okrState.keyResults.find(k => k.id === kpi.keyResultId);
            const krIdx = okrState.keyResults.findIndex(k => k.id === kpi.keyResultId);
            const lags = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);

            // ê° ë²„ì „ì˜ ì„±ê³¼ ê³„ì‚°
            const versionResults = lags.map(lag => {
              const logs = okrState.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
              const totalValue = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
              const avgPerLog = logs.length > 0 ? totalValue / logs.length : 0;
              return { ...lag, totalValue, logCount: logs.length, avgPerLog };
            }).sort((a, b) => b.avgPerLog - a.avgPerLog);

            const hasMultipleVersions = lags.length > 1;
            const winner = versionResults[0];
            const hasEnoughData = versionResults.every(v => v.logCount >= 5);
            const totalLogs = versionResults.reduce((sum, v) => sum + v.logCount, 0);

            // ì‹¤í—˜ ìƒíƒœ ê²°ì •
            let status, statusColor, statusIcon;
            if (!hasMultipleVersions) {
              status = 'ë‹¨ì¼ ë²„ì „';
              statusColor = 'var(--gray-500)';
              statusIcon = 'ğŸ“Š';
            } else if (totalLogs === 0) {
              status = 'ë°ì´í„° ìˆ˜ì§‘ ì¤‘';
              statusColor = 'var(--gray-500)';
              statusIcon = 'â³';
            } else if (!hasEnoughData) {
              status = 'ë°ì´í„° ë¶€ì¡±';
              statusColor = 'var(--warning)';
              statusIcon = 'ğŸ“Š';
            } else {
              status = 'íŒë‹¨ ê°€ëŠ¥';
              statusColor = 'var(--success)';
              statusIcon = 'âœ…';
            }

            return `
              <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; border-left: 4px solid ${okrColors[krIdx] || 'var(--primary)'};">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                  <div>
                    <div style="font-size: 15px; font-weight: 700; color: var(--gray-800); margin-bottom: 4px;">${kpi.name}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">${kr ? kr.name : ''} Â· ${lags.length}ê°œ ë²„ì „</div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">${statusIcon}</span>
                    <span style="padding: 4px 12px; background: ${statusColor}15; color: ${statusColor}; border-radius: 12px; font-size: 12px; font-weight: 600;">${status}</span>
                  </div>
                </div>

                ${hasMultipleVersions ? `
                  <!-- ë²„ì „ ë¹„êµ ë°” -->
                  <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    ${versionResults.map((v, idx) => {
                      const maxAvg = Math.max(...versionResults.map(r => r.avgPerLog), 1);
                      const width = (v.avgPerLog / maxAvg) * 100;
                      const isWinner = idx === 0 && hasEnoughData && v.avgPerLog > 0;
                      return `
                        <div style="flex: 1; background: white; border-radius: 8px; padding: 12px; border: ${isWinner ? '2px solid var(--success)' : '1px solid var(--gray-200)'};">
                          <div style="margin-bottom: 8px;">
                            <div style="font-size: 12px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; display: flex; align-items: center; gap: 4px;">
                              ${v.name || 'ì§€í‘œ'}
                              ${isWinner ? '<span style="font-size: 11px;">ğŸ†</span>' : ''}
                            </div>
                            <div style="font-size: 11px; color: var(--gray-500);">${v.version || 'ê¸°ë³¸'}ë²„ì „</div>
                          </div>
                          <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                            <div style="height: 100%; width: ${width}%; background: ${isWinner ? 'var(--success)' : 'var(--primary)'}; border-radius: 4px;"></div>
                          </div>
                          <div style="font-size: 12px; color: var(--gray-600);">
                            í‰ê·  <strong style="color: var(--gray-800);">${v.avgPerLog.toFixed(1)}</strong> Â· ${v.logCount}ê±´
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>

                  ${hasEnoughData && winner.avgPerLog > 0 ? `
                    <!-- ì¶”ì²œ ì•¡ì…˜ -->
                    <div style="background: var(--success-light); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;">
                      <span style="font-size: 20px;">ğŸ’¡</span>
                      <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--success);">ì¶”ì²œ: "${winner.name}" (${winner.version || 'ê¸°ë³¸'}ë²„ì „) ì±„íƒ</div>
                        <div style="font-size: 12px; color: var(--gray-600);">í‰ê·  ì„±ê³¼ê°€ ${((winner.avgPerLog / (versionResults[1]?.avgPerLog || 1) - 1) * 100).toFixed(0)}% ë” ë†’ìŠµë‹ˆë‹¤</div>
                      </div>
                      <button onclick="document.getElementById('okrExperimentKPISelect').value='${kpi.id}'; renderOkrExperimentResults();" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">ìƒì„¸ ë¶„ì„</button>
                    </div>
                  ` : `
                    <div style="font-size: 12px; color: var(--gray-500); text-align: center; padding: 8px;">
                      ${totalLogs === 0 ? 'ì•„ì§ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤' : `ê° ë²„ì „ë‹¹ ìµœì†Œ 5ê±´ ì´ìƒì˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤ (í˜„ì¬ ì´ ${totalLogs}ê±´)`}
                    </div>
                  `}
                ` : `
                  <!-- ë‹¨ì¼ ë²„ì „ í˜„í™© -->
                  <div style="background: white; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-size: 13px; color: var(--gray-600);">${versionResults[0]?.name || 'ì§€í‘œ'}</span>
                      <span style="font-size: 13px; font-weight: 600; color: var(--gray-800);">${versionResults[0]?.logCount || 0}ê±´ ê¸°ë¡</span>
                    </div>
                  </div>
                  <div style="margin-top: 8px; font-size: 12px; color: var(--gray-500); text-align: center;">
                    ğŸ’¡ ë²„ì „ì„ ì¶”ê°€í•˜ë©´ A/B í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤
                  </div>
                `}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderOkrExperimentResults() {
      const kpiId = document.getElementById('okrExperimentKPISelect')?.value;
      const container = document.getElementById('okrExperimentResults');
      if (!container) return;

      // KPI ë¯¸ì„ íƒì‹œ ì „ì²´ í˜„í™© í‘œì‹œ
      if (!kpiId) {
        container.innerHTML = renderAllExperimentsOverview();
        return;
      }

      const kpi = okrState.kpis.find(k => k.id === kpiId);
      const kr = okrState.keyResults.find(k => k.id === kpi?.keyResultId);
      const lagsForKPI = okrState.laggingIndicators.filter(l => l.kpiId === kpiId);

      if (lagsForKPI.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-400);">ì§€í‘œ(ë²„ì „)ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      const results = lagsForKPI.map(lag => {
        const logs = okrState.dailyLogs.filter(l => l.laggingIndicatorId === lag.id);
        const totalValue = logs.reduce((sum, l) => sum + (l.resultValue || 0), 0);
        const avgPerLog = logs.length > 0 ? (totalValue / logs.length) : 0;

        // ì¼ë³„ ì¶”ì´ ê³„ì‚° (ìµœê·¼ 7ì¼)
        const dailyData = {};
        logs.forEach(log => {
          const date = log.date || 'unknown';
          if (!dailyData[date]) dailyData[date] = { count: 0, value: 0 };
          dailyData[date].count++;
          dailyData[date].value += log.resultValue || 0;
        });

        return { ...lag, totalValue, logCount: logs.length, avgPerLog, dailyData };
      }).sort((a, b) => b.avgPerLog - a.avgPerLog);

      const maxValue = Math.max(...results.map(r => r.avgPerLog), 1);
      const ranks = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
      const barColors = ['var(--success)', 'var(--primary)', 'var(--warning)', 'var(--gray-400)'];
      const hasEnoughData = results.every(r => r.logCount >= 5);
      const totalLogs = results.reduce((sum, r) => sum + r.logCount, 0);
      const winner = results[0];
      const runnerUp = results[1];

      container.innerHTML = `
        <!-- KPI ì •ë³´ í—¤ë” -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <div style="font-size: 18px; font-weight: 700; color: var(--gray-800); margin-bottom: 8px;">${kpi?.name || 'KPI'}</div>
          <div style="font-size: 13px; color: var(--gray-500);">${kr?.name || ''} Â· ${results.length}ê°œ ë²„ì „ ì‹¤í—˜ ì¤‘ Â· ì´ ${totalLogs}ê±´ ë°ì´í„°</div>
        </div>

        <!-- ì‹¤í—˜ ê²°ê³¼ íŒì • -->
        ${results.length > 1 ? `
          <div style="background: ${hasEnoughData ? 'var(--success-light)' : 'var(--warning-light)'}; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid ${hasEnoughData ? 'var(--success)' : 'var(--warning)'};">
            <div style="display: flex; align-items: flex-start; gap: 16px;">
              <span style="font-size: 32px;">${hasEnoughData ? 'ğŸ†' : 'â³'}</span>
              <div style="flex: 1;">
                ${hasEnoughData ? `
                  <div style="font-size: 16px; font-weight: 700; color: var(--success); margin-bottom: 8px;">
                    ì‹¤í—˜ ê²°ê³¼: ${winner.version || 'ê¸°ë³¸'}ë²„ì „ ìŠ¹ë¦¬
                  </div>
                  <div style="font-size: 14px; color: var(--gray-700); margin-bottom: 12px;">
                    ${winner.version || 'ê¸°ë³¸'}ë²„ì „ì´ ${runnerUp ? `${runnerUp.version || 'ê¸°ë³¸'}ë²„ì „ ëŒ€ë¹„ í‰ê·  <strong>${((winner.avgPerLog / (runnerUp.avgPerLog || 1) - 1) * 100).toFixed(0)}%</strong> ë” ë†’ì€ ì„±ê³¼ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤.` : 'ê°€ì¥ ë†’ì€ ì„±ê³¼ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤.'}
                  </div>
                  <div style="background: white; border-radius: 8px; padding: 16px;">
                    <div style="font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">ğŸ“‹ ë‹¤ìŒ ì•¡ì…˜ ê°€ì´ë“œ</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--gray-600); line-height: 1.8;">
                      <li><strong>${winner.version || 'ê¸°ë³¸'}ë²„ì „</strong>ì„ í‘œì¤€ ë°©ì‹ìœ¼ë¡œ ì±„íƒí•˜ì„¸ìš”</li>
                      <li>ë‹¤ë¥¸ ë²„ì „ë“¤ì€ ì ì§„ì ìœ¼ë¡œ ì¶•ì†Œí•˜ê±°ë‚˜ ì¤‘ë‹¨ì„ ê²€í† í•˜ì„¸ìš”</li>
                      <li>ì±„íƒëœ ë²„ì „ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒˆë¡œìš´ ê°œì„  ì‹¤í—˜ì„ ì„¤ê³„í•˜ì„¸ìš”</li>
                    </ul>
                  </div>
                ` : `
                  <div style="font-size: 16px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">
                    ë°ì´í„° ìˆ˜ì§‘ ì¤‘
                  </div>
                  <div style="font-size: 14px; color: var(--gray-700); margin-bottom: 8px;">
                    ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” íŒë‹¨ì„ ìœ„í•´ ê° ë²„ì „ë‹¹ ìµœì†Œ 5ê±´ ì´ìƒì˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.
                  </div>
                  <div style="font-size: 13px; color: var(--gray-500);">
                    í˜„ì¬: ${results.map(r => `${r.version || 'ê¸°ë³¸'}ë²„ì „ ${r.logCount}ê±´`).join(' / ')}
                  </div>
                `}
              </div>
            </div>
          </div>
        ` : ''}

        <!-- ë²„ì „ë³„ ìƒì„¸ ê²°ê³¼ -->
        <div style="font-size: 15px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px;">ë²„ì „ë³„ ìƒì„¸ ê²°ê³¼</div>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          ${results.map((r, idx) => `
            <div style="background: white; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 20px; border: ${idx === 0 && hasEnoughData ? '2px solid var(--success)' : '1px solid var(--gray-100)'};">
              <div style="font-size: 32px;">${ranks[idx] || 'ğŸ“Š'}</div>
              <div style="flex: 1;">
                <div style="font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 4px;">
                  ${r.version || 'ê¸°ë³¸'}ë²„ì „: ${r.name}
                  ${idx === 0 && hasEnoughData ? '<span style="margin-left: 8px; padding: 2px 8px; background: var(--success); color: white; border-radius: 4px; font-size: 11px;">ìŠ¹ì</span>' : ''}
                </div>
                <div style="font-size: 13px; color: var(--gray-500);">ì—…ë¬´ ${r.logCount}ê±´ | ì´í•© ${r.totalValue}</div>
              </div>
              <div style="flex: 2;">
                <div style="height: 24px; width: ${(r.avgPerLog / maxValue) * 100}%; min-width: 60px; background: ${barColors[idx]}; border-radius: 4px; display: flex; align-items: center; padding-left: 12px; color: white; font-size: 13px; font-weight: 600;">
                  í‰ê·  ${r.avgPerLog.toFixed(2)}
                </div>
              </div>
              <div style="text-align: right; min-width: 80px;">
                <div style="font-size: 20px; font-weight: 800; color: var(--gray-800);">${r.avgPerLog.toFixed(1)}</div>
                <div style="font-size: 11px; color: var(--gray-500);">ê±´ë‹¹ í‰ê· </div>
              </div>
            </div>
          `).join('')}
        </div>

        ${results.length === 1 ? `
          <div style="margin-top: 20px; padding: 16px; background: var(--primary-light); border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; color: var(--primary); margin-bottom: 8px;">ğŸ’¡ A/B í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
            <div style="font-size: 13px; color: var(--gray-600);">
              ëª©í‘œì„¤ì •ì—ì„œ ìƒˆë¡œìš´ ë²„ì „(B, C ë“±)ì„ ì¶”ê°€í•˜ë©´ ì‹¤í—˜ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </div>
        ` : ''}
      `;
    }

    // OKR ëª¨ë‹¬ë“¤
    function openOkrObjectiveModal() {
      const obj = okrState.objective;
      showModal(`
        <div style="padding: 24px;">
          <div style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ¯ ìµœì¢… ëª©í‘œ (O) ${obj ? 'ìˆ˜ì •' : 'ì„¤ì •'}</div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ëª©í‘œëª… *</label>
            <input type="text" id="okrObjName" value="${obj?.name || ''}" placeholder="ì˜ˆ: 26ë…„ë„ ì—° 10ì–µ ë§¤ì¶œ ë‹¬ì„±" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ì‹œì‘ì¼</label>
              <input type="date" id="okrObjStartDate" value="${obj?.startDate || ''}" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ì¢…ë£Œì¼</label>
              <input type="date" id="okrObjEndDate" value="${obj?.endDate || ''}" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
            </div>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 12px;">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveOkrObjective()">ì €ì¥</button>
          </div>
        </div>
      `);
    }

    async function saveOkrObjective() {
      const name = document.getElementById('okrObjName')?.value.trim();
      if (!name) { showToast('ëª©í‘œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
      const data = {
        name,
        startDate: document.getElementById('okrObjStartDate')?.value || '',
        endDate: document.getElementById('okrObjEndDate')?.value || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        if (okrState.objective) {
          await db.collection('okr_objective').doc(okrState.objective.id).update(data);
        } else {
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('okr_objective').add(data);
        }
        await loadOkrData();
        renderOkrDashboard();
        renderOkrSettings();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (e) { console.error(e); showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
    }

    function openOkrKRModal(krId = null) {
      const kr = krId ? okrState.keyResults.find(k => k.id === krId) : null;

      showModal(`
        <div style="padding: 24px; max-width: 600px;">
          <div style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ“ˆ KR ${kr ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">KRëª… *</label>
            <input type="text" id="okrKRName" value="${kr?.name || ''}" placeholder="ì˜ˆ: ì—°ë§¤ì¶œ 10ì–µ ë‹¬ì„±" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
          </div>
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ëª©í‘œê°’</label>
              <input type="number" id="okrKRTargetValue" value="${kr?.targetValue || ''}" placeholder="1000000000" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë‹¨ìœ„</label>
              <input type="text" id="okrKRUnit" value="${kr?.unit || ''}" placeholder="ì›" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
            </div>
          </div>
          <div style="display: flex; justify-content: ${kr ? 'space-between' : 'flex-end'}; gap: 12px;">
            ${kr ? `<button class="btn" style="background: var(--danger-light, #FEE2E2); color: var(--danger);" onclick="deleteOkrKR('${kr.id}')">ì‚­ì œ</button>` : ''}
            <div style="display: flex; gap: 12px;">
              <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
              <button class="btn btn-primary" onclick="saveOkrKR('${krId || ''}')">ì €ì¥</button>
            </div>
          </div>
        </div>
      `);
    }

    async function saveOkrKR(krId) {
      const name = document.getElementById('okrKRName')?.value.trim();
      if (!name) { showToast('KRëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }

      const data = {
        objectiveId: okrState.objective.id, name,
        targetValue: parseFloat(document.getElementById('okrKRTargetValue')?.value) || 0,
        unit: document.getElementById('okrKRUnit')?.value.trim() || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        if (krId) {
          await db.collection('okr_keyResults').doc(krId).update(data);
        } else {
          data.order = okrState.keyResults.length + 1;
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('okr_keyResults').add(data);
        }
        await loadOkrData();
        renderOkrDashboard();
        renderOkrSettings();
        renderOkrRecord();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (e) { console.error(e); showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
    }

    async function deleteOkrKR(krId) {
      if (!confirm('ì´ KRì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì—°ê²°ëœ KPIë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;
      try {
        const kpis = okrState.kpis.filter(k => k.keyResultId === krId);
        for (const kpi of kpis) {
          const lags = okrState.laggingIndicators.filter(l => l.kpiId === kpi.id);
          for (const lag of lags) await db.collection('okr_laggingIndicators').doc(lag.id).delete();
          await db.collection('okr_kpis').doc(kpi.id).delete();
        }
        await db.collection('okr_keyResults').doc(krId).delete();
        await loadOkrData();
        renderOkrDashboard();
        renderOkrSettings();
        renderOkrRecord();
        closeModal();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (e) { console.error(e); showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
    }

    // KPI í˜„í™© í…Œì´ë¸”ì—ì„œ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
    function showEditKPIModal(kpiId) {
      const kpi = okrState.kpis.find(k => k.id === kpiId);
      if (!kpi) {
        showToast('KPIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }
      openOkrKPIModal(kpi.keyResultId, kpiId);
    }

    function openOkrKPIModal(krId, kpiId = null) {
      const kpi = kpiId ? okrState.kpis.find(k => k.id === kpiId) : null;
      const lagsForKPI = kpi ? okrState.laggingIndicators.filter(l => l.kpiId === kpi.id) : [];
      const teamMembers = (state.teamMembers || []).filter(m => m.role !== 'ceo' && m.role !== 'guest');
      const mainAssignee = kpi?.mainAssignee || '';
      const subAssignees = kpi?.subAssignees || [];

      showModal(`
        <div style="padding: 24px; max-height: 80vh; overflow-y: auto;">
          <div style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ“Š KPI ${kpi ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">KPIëª… *</label>
            <input type="text" id="okrKPIName" value="${kpi?.name || ''}" placeholder="ì˜ˆ: êµ­ë‚´ ì…€ëŸ¬ ë§¤ì¶œ" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
          </div>
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ëª©í‘œê°’ *</label>
              <input type="number" id="okrKPITargetValue" value="${kpi?.targetValue || ''}" placeholder="800000000" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë‹¨ìœ„</label>
              <select id="okrKPIUnit" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit; background: white; cursor: pointer;">
                <option value="ì›" ${(kpi?.unit || '') === 'ì›' ? 'selected' : ''}>ì› (ê¸ˆì•¡)</option>
                <option value="%" ${kpi?.unit === '%' ? 'selected' : ''}>% (ë¹„ìœ¨)</option>
                <option value="ê±´" ${kpi?.unit === 'ê±´' ? 'selected' : ''}>ê±´ (ê±´ìˆ˜)</option>
                <option value="ëª…" ${kpi?.unit === 'ëª…' ? 'selected' : ''}>ëª… (ì¸ì›)</option>
                <option value="ê³³" ${kpi?.unit === 'ê³³' ? 'selected' : ''}>ê³³ (ì¥ì†Œ/ì—…ì²´)</option>
                <option value="ê°œ" ${kpi?.unit === 'ê°œ' ? 'selected' : ''}>ê°œ (ìˆ˜ëŸ‰)</option>
                <option value="íšŒ" ${kpi?.unit === 'íšŒ' ? 'selected' : ''}>íšŒ (íšŸìˆ˜)</option>
              </select>
            </div>
          </div>

          <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--gray-200);">

          <!-- ì£¼ ë‹´ë‹¹ -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">â­ ì£¼ ë‹´ë‹¹ íŒ€ì› (1ëª… ì„ íƒ)</label>
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 12px;">
              ì´ KPIì˜ ì£¼ìš” ì±…ì„ìì…ë‹ˆë‹¤
            </div>
            <div style="background: var(--gray-50); border: 2px solid var(--gray-200); border-radius: 8px; padding: 12px; max-height: 150px; overflow-y: auto;">
              ${teamMembers.length > 0 ? teamMembers.map(member => `
                <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.15s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
                  <input type="radio" name="kpi-main-assignee" class="kpi-main-assignee" value="${member.id}" data-name="${member.name}" ${mainAssignee === member.id ? 'checked' : ''} style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                  <span style="font-size: 14px; color: var(--gray-800);">${member.name}</span>
                </label>
              `).join('') : '<div style="text-align: center; color: var(--gray-400); padding: 20px;">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
            </div>
          </div>

          <!-- ì„œë¸Œ ë‹´ë‹¹ -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ğŸ“Œ ì„œë¸Œ ë‹´ë‹¹ íŒ€ì› (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</label>
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 12px;">
              ì£¼ ë‹´ë‹¹ì„ ì§€ì›í•˜ëŠ” íŒ€ì›ë“¤ì…ë‹ˆë‹¤
            </div>
            <div style="background: var(--gray-50); border: 2px solid var(--gray-200); border-radius: 8px; padding: 12px; max-height: 150px; overflow-y: auto;">
              ${teamMembers.length > 0 ? teamMembers.map(member => `
                <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.15s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" class="kpi-sub-assignee" value="${member.id}" data-name="${member.name}" ${subAssignees.includes(member.id) ? 'checked' : ''} style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                  <span style="font-size: 14px; color: var(--gray-800);">${member.name}</span>
                </label>
              `).join('') : '<div style="text-align: center; color: var(--gray-400); padding: 20px;">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
            </div>
          </div>

          <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--gray-200);">
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ğŸ“Š ì§€í‘œ (í™œë™/ì„±ê³¼) - ì—…ë¬´ê¸°ë¡ ëŒ€ìƒ</label>
            <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 8px;">ğŸ’¡ ì§€í‘œ ì¶”ê°€ í›„ ì™¼ìª½ íŒ¨ë„ì—ì„œ í™œë™í˜•/ì„±ê³¼í˜•ì„ ì„¤ì •í•˜ì„¸ìš”</div>
            <div id="okrLagList">
              ${lagsForKPI.map(lag => `
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                  <input type="text" class="okr-lag-version" value="${lag.version}" style="width: 60px; padding: 10px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px;" placeholder="A">
                  <input type="text" class="okr-lag-name" value="${lag.name}" style="flex: 1; padding: 10px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px;" placeholder="ì „í™” ìƒë‹´">
                  <button class="btn btn-secondary" onclick="this.parentElement.remove()">Ã—</button>
                </div>
              `).join('')}
            </div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addOkrLagInput()">+ ë²„ì „ ì¶”ê°€</button>
          </div>
          <div style="display: flex; justify-content: ${kpi ? 'space-between' : 'flex-end'}; gap: 12px;">
            ${kpi ? `<button class="btn" style="background: var(--danger-light, #FEE2E2); color: var(--danger);" onclick="deleteOkrKPI('${kpi.id}')">ì‚­ì œ</button>` : ''}
            <div style="display: flex; gap: 12px;">
              <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
              <button class="btn btn-primary" onclick="saveOkrKPI('${krId}', '${kpiId || ''}')">ì €ì¥</button>
            </div>
          </div>
        </div>
      `);
    }

    function addOkrLagInput() {
      const lagList = document.getElementById('okrLagList');
      const div = document.createElement('div');
      div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
      div.innerHTML = `
        <input type="text" class="okr-lag-version" style="width: 60px; padding: 10px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px;" placeholder="A">
        <input type="text" class="okr-lag-name" style="flex: 1; padding: 10px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px;" placeholder="ì „í™” ìƒë‹´">
        <button class="btn btn-secondary" onclick="this.parentElement.remove()">Ã—</button>
      `;
      lagList.appendChild(div);
    }

    async function saveOkrKPI(krId, kpiId) {
      const name = document.getElementById('okrKPIName')?.value.trim();
      const targetValue = parseFloat(document.getElementById('okrKPITargetValue')?.value);
      if (!name) { showToast('KPIëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
      if (!targetValue) { showToast('ëª©í‘œê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }

      // ì£¼ ë‹´ë‹¹ íŒ€ì› ìˆ˜ì§‘
      const mainRadio = document.querySelector('.kpi-main-assignee:checked');
      const mainAssignee = mainRadio ? mainRadio.value : '';
      const mainAssigneeName = mainRadio ? mainRadio.dataset.name : '';

      // ì„œë¸Œ ë‹´ë‹¹ íŒ€ì› ìˆ˜ì§‘
      const subCheckboxes = document.querySelectorAll('.kpi-sub-assignee:checked');
      const subAssignees = Array.from(subCheckboxes).map(cb => cb.value);
      const subAssigneeNames = Array.from(subCheckboxes).map(cb => cb.dataset.name);

      const data = {
        keyResultId: krId, name, targetValue,
        unit: document.getElementById('okrKPIUnit')?.value.trim() || '',
        leadingIndicator: document.getElementById('okrKPILeadingIndicator')?.value.trim() || '',
        mainAssignee: mainAssignee,
        mainAssigneeName: mainAssigneeName,
        subAssignees: subAssignees,
        subAssigneeNames: subAssigneeNames,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        let savedKpiId = kpiId;
        if (kpiId) {
          await db.collection('okr_kpis').doc(kpiId).update(data);
        } else {
          data.order = okrState.kpis.filter(k => k.keyResultId === krId).length + 1;
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection('okr_kpis').add(data);
          savedKpiId = docRef.id;
        }
        // ì§€í‘œ ì²˜ë¦¬
        const versions = document.querySelectorAll('.okr-lag-version');
        const names = document.querySelectorAll('.okr-lag-name');
        const existingLags = okrState.laggingIndicators.filter(l => l.kpiId === savedKpiId);
        for (const lag of existingLags) await db.collection('okr_laggingIndicators').doc(lag.id).delete();
        for (let i = 0; i < versions.length; i++) {
          const version = versions[i].value.trim();
          const lagName = names[i].value.trim();
          if (version && lagName) {
            await db.collection('okr_laggingIndicators').add({
              kpiId: savedKpiId, version, name: lagName,
              totalValue: 0, logCount: 0, isActive: true,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }
        await loadOkrData();
        renderOkrDashboard();
        renderOkrSettings();
        renderOkrRecord();
        closeModal();
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (e) { console.error(e); showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
    }

    async function deleteOkrKPI(kpiId) {
      if (!confirm('ì´ KPIë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const lags = okrState.laggingIndicators.filter(l => l.kpiId === kpiId);
        for (const lag of lags) await db.collection('okr_laggingIndicators').doc(lag.id).delete();
        await db.collection('okr_kpis').doc(kpiId).delete();
        await loadOkrData();
        renderOkrDashboard();
        renderOkrSettings();
        renderOkrRecord();
        closeModal();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (e) { console.error(e); showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
    }

    // ë¹ ë¥¸ ì¶”ê°€ ëª¨ë‹¬
    function openQuickAddModal() {
      showModal(`
        <div style="padding: 24px;">
          <div style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">â• ë¹ ë¥¸ ì—…ë¬´ ì¶”ê°€</div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">KR ì„ íƒ *</label>
            <select id="quickAddKR" onchange="updateQuickAddKPIs()" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
              <option value="">KR ì„ íƒ</option>
              ${okrState.keyResults.map(kr => `<option value="${kr.id}">${kr.name}</option>`).join('')}
            </select>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">KPI ì„ íƒ *</label>
            <select id="quickAddKPI" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
              <option value="">ë¨¼ì € KRì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 16px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë²„ì „</label>
              <input type="text" id="quickAddVersion" value="A" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ì—…ë¬´ëª… *</label>
              <input type="text" id="quickAddName" placeholder="ì˜ˆ: ì‹ ê·œ ì—…ë¬´" style="width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit;">
            </div>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 12px;">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveQuickAdd()">ì¶”ê°€</button>
          </div>
        </div>
      `);
    }

    function updateQuickAddKPIs() {
      const krId = document.getElementById('quickAddKR')?.value;
      const kpiSelect = document.getElementById('quickAddKPI');
      if (!kpiSelect) return;
      const kpisForKR = okrState.kpis.filter(k => k.keyResultId === krId);
      kpiSelect.innerHTML = kpisForKR.length > 0
        ? kpisForKR.map(kpi => `<option value="${kpi.id}">${kpi.name}</option>`).join('')
        : '<option value="">KPIê°€ ì—†ìŠµë‹ˆë‹¤</option>';
    }

    async function saveQuickAdd() {
      const kpiId = document.getElementById('quickAddKPI')?.value;
      const version = document.getElementById('quickAddVersion')?.value.trim() || 'A';
      const name = document.getElementById('quickAddName')?.value.trim();
      if (!kpiId) { showToast('KPIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error'); return; }
      if (!name) { showToast('ì—…ë¬´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
      try {
        await db.collection('okr_laggingIndicators').add({
          kpiId, version, name,
          totalValue: 0, logCount: 0, isActive: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await loadOkrData();
        renderOkrRecord();
        renderOkrSettings();
        closeModal();
        showToast('ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch (e) { console.error(e); showToast('ì¶”ê°€ ì‹¤íŒ¨', 'error'); }
    }

    // OKR íƒ­ ì „í™˜ ì‹œ ë Œë”ë§
    function renderOkrTab(tabId) {
      if (tabId === 'okr-dashboard') renderOkrDashboard();
      else if (tabId === 'okr-record') renderOkrRecord();
      else if (tabId === 'okr-settings') renderOkrSettings();
      else if (tabId === 'okr-experiment') renderOkrExperiment();
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      loadAdminPassword();
      checkLoginStatus();

      // OKR ë°ì´í„° ë¡œë“œ
      setTimeout(() => {
        loadOkrData();
      }, 500);

      // ë§ˆê° ì—…ë¬´ ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸
      setTimeout(() => {
        updateChatbotBadge();
      }, 2000);
    });
  </script>

</body>
</html>

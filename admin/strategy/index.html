<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì „ëµì„¼í„° - ëª¨ì—¬ë¼ë”œ</title>
  <link rel="manifest" href="/admin/manifest.json">
  <meta name="theme-color" content="#3182f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ì „ëµì„¼í„°">
  <link rel="apple-touch-icon" href="/admin/icon-192.png">
  <meta name="description" content="ëª¨ì—¬ë¼ë”œ ì „ëµì„¼í„° - ì˜ì—…í˜„í™©, ê·¸ë¡œìŠ¤ë³´ë“œ, ì—…ë¬´ê´€ë¦¬">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #3182f6;
      --primary-light: #eef4ff;
      --primary-dark: #1b64da;
      --white: #ffffff;
      --gray-900: #191f28;
      --gray-800: #333d4b;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      --success: #00c073;
      --success-light: #e8f7f0;
      --warning: #fc9600;
      --warning-light: #fff8f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --info: #3182f6;
      --info-light: #eef4ff;
      --card-radius: 16px;
      --card-shadow: 0 2px 8px rgba(0,0,0,0.06);
      --btn-radius: 8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      background: var(--gray-100);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    .login-screen {
      min-height: 100vh;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container { width: 100%; max-width: 400px; }

    .login-logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo img { height: 48px; }

    .login-logo-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-top: 8px;
    }

    .login-card {
      background: var(--white);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .login-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      color: var(--gray-900);
    }

    .login-error {
      background: var(--danger-light);
      border: 1px solid #fecaca;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }

    .login-error.show { display: block; }

    .login-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
      margin-bottom: 12px;
    }

    .login-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: var(--white);
      font-family: inherit;
      transition: all 0.15s ease;
    }

    .login-btn:hover { background: var(--primary-dark); }

    /* ë ˆì´ì•„ì›ƒ */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 260px;
      background: var(--white);
      border-right: 1px solid var(--gray-200);
      padding: 24px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 20px;
      margin-bottom: 32px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .nav-section { margin-bottom: 32px; }

    .nav-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-500);
      letter-spacing: -0.2px;
      padding: 0 20px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      font-weight: 500;
      color: var(--gray-700);
      position: relative;
    }

    .nav-item:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }

    .nav-item.active {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary);
    }

    .nav-item .icon {
      width: 20px;
      text-align: center;
      font-size: 16px;
    }

    .center-links {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      margin-top: auto;
    }

    .center-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      color: var(--gray-600);
      text-decoration: none;
      transition: all 0.2s;
      margin-bottom: 4px;
    }

    .center-link:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .center-link.active {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }

    /* ë©”ì¸ ì»¨í…ì¸  */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 28px 32px;
      max-width: 1400px;
    }

    /* ëª¨ë°”ì¼ ë©”ë‰´ */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 150;
      background: var(--primary);
      color: var(--white);
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 90;
    }

    /* í—¤ë” */
    .page-header { margin-bottom: 24px; }

    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .page-desc {
      font-size: 14px;
      color: var(--gray-500);
    }

    /* ë²„íŠ¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover { background: var(--primary-dark); }

    .btn-secondary {
      background: var(--white);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    .btn-secondary:hover { background: var(--gray-50); }

    /* ì¹´ë“œ */
    .card {
      background: var(--white);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
    }

    /* KPI ì¹´ë“œ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--white);
      border-radius: var(--card-radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
    }

    .kpi-card.highlight {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .kpi-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 8px;
    }

    .kpi-card.highlight .kpi-label {
      color: rgba(255,255,255,0.8);
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .kpi-card.highlight .kpi-value {
      color: white;
    }

    .kpi-change {
      font-size: 12px;
      margin-top: 4px;
    }

    .kpi-change.positive { color: var(--success); }
    .kpi-change.negative { color: var(--danger); }

    /* í…Œì´ë¸” */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    th {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-500);
      background: var(--gray-50);
    }

    td {
      font-size: 14px;
      color: var(--gray-700);
    }

    /* ì°¨íŠ¸ í”Œë ˆì´ìŠ¤í™€ë” */
    .chart-placeholder {
      height: 300px;
      background: var(--gray-50);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-500);
      font-size: 14px;
    }

    /* OKR ìŠ¤íƒ€ì¼ */
    .okr-section {
      margin-bottom: 24px;
    }

    .okr-objective {
      background: var(--white);
      border-radius: var(--card-radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--card-shadow);
    }

    .okr-objective-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .okr-key-result {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
    }

    .okr-kr-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .okr-kr-title {
      font-size: 14px;
      color: var(--gray-700);
    }

    .okr-kr-progress {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }

    .okr-progress-bar {
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      overflow: hidden;
    }

    .okr-progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      display: flex;
      gap: 4px;
      background: var(--gray-100);
      padding: 4px;
      border-radius: 10px;
      margin-bottom: 24px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: var(--white);
      color: var(--gray-900);
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* í† ìŠ¤íŠ¸ */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gray-900);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 9999;
    }

    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-500);
      padding: 4px;
    }

    .modal-close:hover {
      color: var(--gray-900);
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .mobile-menu-btn {
        display: flex;
      }

      .sidebar-overlay.show {
        display: block;
      }

      .main-content {
        margin-left: 0;
        padding: 70px 16px 24px;
      }

      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
  <!-- PPT ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <div class="login-logo">
        <img src="/admin/moyeora-logo.png" alt="ëª¨ì—¬ë¼ë”œ" onerror="this.style.display='none'">
        <div class="login-logo-desc">ì „ëµì„¼í„°</div>
      </div>
      <div class="login-card">
        <div class="login-title">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
        <div id="loginError" class="login-error"></div>
        <input type="password" id="loginPassword" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter')handleLogin()">
        <button class="login-btn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì•± í™”ë©´ -->
  <div id="appScreen" class="app-container" style="display:none;">
    <!-- ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <div class="logo">
        <div class="logo-icon">ğŸ“Š</div>
        <span class="logo-text">ì „ëµì„¼í„°</span>
      </div>

      <nav>
        <div class="nav-section">
          <div class="nav-label">í˜„í™©</div>
          <div class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
            <span class="icon">ğŸ“ˆ</span>
            <span>ì˜ì—…í˜„í™©</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-label">ì „ëµ ì‚¬ì´í´</div>
          <div class="nav-item" data-tab="kpi" onclick="switchTab('kpi')">
            <span class="icon">ğŸš€</span>
            <span>ê·¸ë¡œìŠ¤ë³´ë“œ</span>
          </div>
          <div class="nav-item" data-tab="worklog" onclick="switchTab('worklog')">
            <span class="icon">ğŸ“</span>
            <span>ì—…ë¬´ê´€ë¦¬</span>
          </div>
          <div class="nav-item" data-tab="review" onclick="switchTab('review')">
            <span class="icon">ğŸ”</span>
            <span>ì „ëµë¦¬ë·°</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-label">ìë£Œ</div>
          <div class="nav-item" data-tab="guide" onclick="switchTab('guide')">
            <span class="icon">ğŸ“š</span>
            <span>ì—…ë¬´ê°€ì´ë“œ</span>
          </div>
          <div class="nav-item" data-tab="reference" onclick="switchTab('reference')">
            <span class="icon">ğŸ“‚</span>
            <span>ë ˆí¼ëŸ°ìŠ¤</span>
          </div>
        </div>

        <!-- ì„¼í„° ì´ë™ -->
        <div class="center-links">
          <div class="nav-label">ì„¼í„° ì´ë™</div>
          <a href="/admin/" class="center-link">
            <span>âš™ï¸</span>
            <span>ìš´ì˜ì„¼í„°</span>
          </a>
          <a href="/admin/crm/" class="center-link">
            <span>ğŸ’¼</span>
            <span>CRMì„¼í„°</span>
          </a>
          <a href="/admin/strategy/" class="center-link active">
            <span>ğŸ“Š</span>
            <span>ì „ëµì„¼í„°</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
      <!-- ìƒë‹¨ ì„¼í„° ë°”ë¡œê°€ê¸° -->
      <div style="display: flex; gap: 4px; margin-bottom: 20px; padding: 4px; background: var(--gray-200); border-radius: 12px; width: fit-content;">
        <a href="/admin/" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: transparent; border-radius: 10px; text-decoration: none; color: var(--gray-600); font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
          ìš´ì˜ì„¼í„°
        </a>
        <a href="/admin/strategy/" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: var(--primary); border-radius: 10px; text-decoration: none; color: white; font-size: 13px; font-weight: 700; box-shadow: 0 2px 8px rgba(49, 130, 246, 0.3);">
          ì „ëµì„¼í„°
        </a>
        <a href="/admin/crm/" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: transparent; border-radius: 10px; text-decoration: none; color: var(--gray-600); font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='transparent'">
          CRMì„¼í„°
        </a>
      </div>

      <!-- ì˜ì—…í˜„í™© -->
      <div id="tab-dashboard" class="tab-content active">
        <div id="salesDashboardContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- OKR -->
      <div id="tab-okr" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">OKR</h1>
          <p class="page-desc">ëª©í‘œ ë° í•µì‹¬ ê²°ê³¼ ê´€ë¦¬</p>
        </div>

        <div class="tab-nav">
          <button class="tab-btn active" onclick="switchOkrPeriod('quarterly')">ë¶„ê¸°ë³„</button>
          <button class="tab-btn" onclick="switchOkrPeriod('monthly')">ì›”ë³„</button>
          <button class="tab-btn" onclick="switchOkrPeriod('weekly')">ì£¼ê°„</button>
        </div>

        <div class="okr-section" id="okrContent">
          <div class="okr-objective">
            <div class="okr-objective-title">
              <span>ğŸ¯</span>
              <span>Q1 ë§¤ì¶œ ëª©í‘œ ë‹¬ì„±</span>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">ì›” ë§¤ì¶œ 1ì–µì› ë‹¬ì„±</span>
                <span class="okr-kr-progress">65%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 65%"></div>
              </div>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">ì‹ ê·œ ê³µê¸‰ì‚¬ 20ê°œ í™•ë³´</span>
                <span class="okr-kr-progress">40%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 40%"></div>
              </div>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">ê³µêµ¬ ì „í™˜ìœ¨ 15% ë‹¬ì„±</span>
                <span class="okr-kr-progress">80%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 80%"></div>
              </div>
            </div>
          </div>

          <div class="okr-objective">
            <div class="okr-objective-title">
              <span>ğŸš€</span>
              <span>íŒŒíŠ¸ë„ˆ ìƒíƒœê³„ í™•ì¥</span>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">ì…€ëŸ¬ ë„¤íŠ¸ì›Œí¬ 50ê°œ í™•ë³´</span>
                <span class="okr-kr-progress">55%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 55%"></div>
              </div>
            </div>
            <div class="okr-key-result">
              <div class="okr-kr-header">
                <span class="okr-kr-title">íŒŒíŠ¸ë„ˆ ë§Œì¡±ë„ 4.5ì  ì´ìƒ</span>
                <span class="okr-kr-progress">90%</span>
              </div>
              <div class="okr-progress-bar">
                <div class="okr-progress-fill" style="width: 90%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì—…ë¬´ê´€ë¦¬ -->
      <div id="tab-worklog" class="tab-content">
        <div id="worklogContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- KPIê´€ë¦¬ -->
      <div id="tab-kpi" class="tab-content">
        <div id="kpiContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- ì „ëµë¦¬ë·° -->
      <div id="tab-review" class="tab-content">
        <div id="reviewContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- ì—…ë¬´ê°€ì´ë“œ -->
      <div id="tab-guide" class="tab-content">
        <div id="guideContent">
          <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
        </div>
      </div>

      <!-- ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
      <div id="tab-reference" class="tab-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
          <div>
            <h1 class="page-title">ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬</h1>
            <p class="page-desc">ì´ë²¤íŠ¸, ë””ìì¸, ì œì•ˆì„œ, ìˆí¼ ë“± ì—…ë¬´ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ëª¨ì•„ë‘ì„¸ìš”</p>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="openCategoryModal()">âš™ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</button>
            <button class="btn btn-primary" onclick="openReferenceModal()">+ ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€</button>
          </div>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <input type="text" id="refSearch" placeholder="ë ˆí¼ëŸ°ìŠ¤ ê²€ìƒ‰..." oninput="filterReferences()" style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
            </div>
            <div id="refCategoryFilters" style="display: flex; gap: 8px; flex-wrap: wrap;">
              <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
            </div>
          </div>
        </div>

        <!-- ë ˆí¼ëŸ°ìŠ¤ ëª©ë¡ -->
        <div id="referenceList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
          <div style="text-align: center; padding: 60px; grid-column: 1 / -1; background: var(--white); border-radius: 16px;">
            ë ˆí¼ëŸ°ìŠ¤ ë¡œë”©ì¤‘...
          </div>
        </div>
      </div>

      <!-- ë ˆí¼ëŸ°ìŠ¤ ëª¨ë‹¬ -->
      <div id="referenceModal" class="modal">
        <div class="modal-content" style="max-width: 650px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
          <div class="modal-header" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white;">
            <h2 id="referenceModalTitle" class="modal-title" style="color: white;">ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeReferenceModal()" style="color: white;">Ã—</button>
          </div>
          <div style="flex: 1; overflow-y: auto; padding: 24px;">
            <input type="hidden" id="referenceId">
            <div style="display: grid; gap: 16px;">
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì œëª© *</label>
                <input type="text" id="referenceTitle" placeholder="ë ˆí¼ëŸ°ìŠ¤ ì œëª©" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì¹´í…Œê³ ë¦¬ *</label>
                <select id="referenceCategory" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
                  <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
                </select>
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">ì„¤ëª…</label>
                <textarea id="referenceDesc" placeholder="ë ˆí¼ëŸ°ìŠ¤ì— ëŒ€í•œ ì„¤ëª…" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="background: #E8F3FF; padding: 16px; border-radius: 10px;">
                <label style="font-size: 13px; font-weight: 600; color: #0064FF; display: block; margin-bottom: 6px;">ğŸ”— ë§í¬ URL</label>
                <input type="url" id="referenceLink" placeholder="https://..." style="width: 100%; padding: 12px; border: 1px solid #C7D2FE; border-radius: 10px; font-size: 14px; background: white;">
                <div style="font-size: 11px; color: var(--gray-600); margin-top: 6px;">ìœ íŠœë¸Œ, ì¸ìŠ¤íƒ€ê·¸ë¨, ì›¹ì‚¬ì´íŠ¸ ë“± ì™¸ë¶€ ë§í¬</div>
              </div>
              <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); padding: 16px; border-radius: 10px; border: 1px solid #F59E0B;">
                <label style="font-size: 13px; font-weight: 600; color: #B45309; display: block; margin-bottom: 10px;">ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ <span id="refImageCount" style="color: var(--gray-600); font-weight: 400;"></span></label>
                <div id="refFileUploadArea" style="background: white; border: 2px dashed #F59E0B; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('refFileInput').click()">
                  <input type="file" id="refFileInput" accept=".jpg,.jpeg,.png,.gif" multiple style="display: none;" onchange="handleRefImageUpload(this.files)">
                  <div style="font-size: 32px; margin-bottom: 8px;">ğŸ–¼ï¸</div>
                  <div style="font-size: 14px; font-weight: 600; color: #92400E;">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ (ì—¬ëŸ¬ì¥ ê°€ëŠ¥)</div>
                  <div style="font-size: 12px; color: #B45309; margin-top: 4px;">JPG, PNG, GIF (ìµœëŒ€ 10ì¥)</div>
                </div>
                <div id="refImagesPreview" style="display: none; margin-top: 12px;"></div>
              </div>
              <div style="background: #DCFCE7; padding: 16px; border-radius: 10px;">
                <label style="font-size: 13px; font-weight: 600; color: #16A34A; display: block; margin-bottom: 6px;">ğŸ“ íŒŒì¼ URL (ì™¸ë¶€ ë§í¬)</label>
                <input type="url" id="referenceFileUrl" placeholder="êµ¬ê¸€ ë“œë¼ì´ë¸Œ, Dropbox ë“± íŒŒì¼ ê³µìœ  ë§í¬" style="width: 100%; padding: 12px; border: 1px solid #86EFAC; border-radius: 10px; font-size: 14px; background: white;">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 6px;">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                <input type="text" id="referenceTags" placeholder="ì˜ˆ: ë´„ì‹ ìƒ, í• ì¸ì´ë²¤íŠ¸, ì¸ìŠ¤íƒ€" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 10px; font-size: 14px;">
              </div>
            </div>
          </div>
          <div style="padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between;">
            <button id="deleteReferenceBtn" type="button" onclick="deleteReference()" style="background: var(--danger-light); color: var(--danger); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; display: none;">ì‚­ì œ</button>
            <div style="display: flex; gap: 12px; margin-left: auto;">
              <button type="button" onclick="closeReferenceModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
              <button type="button" onclick="saveReference()" class="btn btn-primary" id="btnSaveRef">ì €ì¥</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ëª¨ë‹¬ -->
      <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h2 class="modal-title">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h2>
            <button class="modal-close" onclick="closeCategoryModal()">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
              <input type="text" id="newCatEmoji" placeholder="ğŸ‰" style="width: 60px; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; text-align: center; font-size: 20px;">
              <input type="text" id="newCatName" placeholder="ì¹´í…Œê³ ë¦¬ëª…" style="flex: 1; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              <input type="color" id="newCatColor" value="#8B5CF6" style="width: 50px; height: 46px; border: none; border-radius: 8px; cursor: pointer;">
              <button onclick="addCategory()" class="btn btn-primary">ì¶”ê°€</button>
            </div>
            <div id="categoryList" style="display: grid; gap: 8px;">
              <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
            </div>
          </div>
        </div>
      </div>

      <!-- ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ëª¨ë‹¬ -->
      <div id="referenceDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
          <div id="referenceDetailContent">
            <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
          </div>
        </div>
      </div>

      <!-- ë²”ìš© ëª¨ë‹¬ -->
      <div id="modal" class="modal"></div>
    </main>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAQf_Cu9wMji5QsMBQns5eg6nOD_vmrZMs",
      authDomain: "moyeora-deal-manager.firebaseapp.com",
      projectId: "moyeora-deal-manager",
      storageBucket: "moyeora-deal-manager.firebasestorage.app",
      messagingSenderId: "527148187832",
      appId: "1:527148187832:web:dc35b0413a7157db34744d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ìƒíƒœ ê´€ë¦¬
    let state = {
      currentTab: 'dashboard',
      deals: [],
      suppliers: [],
      sellers: [],
      sellerList: [],
      productList: [],
      projects: [],
      megaProjects: [],      // ëŒ€í˜•í”„ë¡œì íŠ¸
      yearlyGoals: [],       // ì—°ë„ë³„ ëª©í‘œ
      teamKPIs: [],          // íŒ€ KPI (ë…ë¦½)
      memberKPIs: [],        // ê°œì¸ KPI (ë…ë¦½)
      tasks: [],             // ì—…ë¬´ (KPI ì—°ê²°)
      references: [],
      refCategories: [],
      teamMembers: [],
      strategyData: {},
      strategyVersions: [],
      currentUser: null,
      isLoggedIn: false
    };

    // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ (Firebaseì— ì—†ì„ ë•Œ ì‚¬ìš©)
    const DEFAULT_CATEGORIES = [
      { id: 'event', label: 'ì´ë²¤íŠ¸', emoji: 'ğŸ‰', color: '#F59E0B', bg: '#FEF3C7' },
      { id: 'design', label: 'ë””ìì¸', emoji: 'ğŸ¨', color: '#EC4899', bg: '#FCE7F3' },
      { id: 'proposal', label: 'ì œì•ˆì„œ', emoji: 'ğŸ“„', color: '#3B82F6', bg: '#DBEAFE' },
      { id: 'shortform', label: 'ìˆí¼', emoji: 'ğŸ¬', color: '#EF4444', bg: '#FEE2E2' },
      { id: 'content', label: 'ì½˜í…ì¸ ', emoji: 'âœï¸', color: '#10B981', bg: '#D1FAE5' },
      { id: 'marketing', label: 'ë§ˆì¼€íŒ…', emoji: 'ğŸ“¢', color: '#8B5CF6', bg: '#EDE9FE' },
      { id: 'etc', label: 'ê¸°íƒ€', emoji: 'ğŸ“', color: '#6B7280', bg: '#F3F4F6' }
    ];

    // ë ˆí¼ëŸ°ìŠ¤ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let refCategoryFilter = 'all';
    let refSearchQuery = '';
    let refUploadedImages = [];

    let adminPassword = 'admin1234';

    // ë¹„ë°€ë²ˆí˜¸ ë¡œë“œ
    async function loadAdminPassword() {
      try {
        const doc = await db.collection('settings').doc('admin').get();
        if (doc.exists && doc.data().password) {
          adminPassword = doc.data().password;
        }
      } catch (e) {
        console.error('ë¹„ë°€ë²ˆí˜¸ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    function checkLoginStatus() {
      const isLoggedIn = sessionStorage.getItem('moyeora_admin_logged_in') === 'true';
      if (isLoggedIn) {
        state.isLoggedIn = true;
        showApp();
      } else {
        showLogin();
      }
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    async function handleLogin() {
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');

      if (password === adminPassword) {
        state.isLoggedIn = true;
        sessionStorage.setItem('moyeora_admin_logged_in', 'true');
        showApp();
      } else {
        errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        errorEl.classList.add('show');
      }
    }

    // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
    function showLogin() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('appScreen').style.display = 'none';
    }

    // ì•± í™”ë©´ í‘œì‹œ
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appScreen').style.display = 'flex';
      setupListeners();

      // URL íŒŒë¼ë¯¸í„°ë¡œ íƒ­ ì „í™˜ (ì˜ˆ: ?tab=worklog)
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab');
      if (tabParam) {
        setTimeout(() => switchTab(tabParam), 100);
      } else {
        // ì˜ì—…í˜„í™© ì´ˆê¸° ë Œë”ë§
        setTimeout(() => renderSalesDashboard(), 100);
      }
    }

    // Firebase ë¦¬ìŠ¤ë„ˆ
    function setupListeners() {
      db.collection('deals').orderBy('startDate', 'desc').onSnapshot(snapshot => {
        state.deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      db.collection('suppliers').orderBy('name').onSnapshot(snapshot => {
        state.suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      db.collection('projects').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      db.collection('references').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.references = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'reference') renderReferences();
      });

      // ì¹´í…Œê³ ë¦¬ ë¦¬ìŠ¤ë„ˆ
      db.collection('refCategories').orderBy('order', 'asc').onSnapshot(snapshot => {
        if (snapshot.empty) {
          state.refCategories = DEFAULT_CATEGORIES;
        } else {
          state.refCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        renderCategoryFilters();
        renderCategoryOptions();
      });

      db.collection('sellers').orderBy('name').onSnapshot(snapshot => {
        state.sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      // ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° (íŒŒì´í”„ë¼ì¸/ì˜¨ë³´ë”©ìš©)
      db.collection('sellerList').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.sellerList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° (íŒŒì´í”„ë¼ì¸/ì˜¨ë³´ë”©ìš©)
      db.collection('productList').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.productList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ì…€ëŸ¬ ì •ì‚° ë°ì´í„° (ì˜ì—…í˜„í™©ìš©)
      db.collection('sellerSettlements').orderBy('settlementDate', 'desc').onSnapshot(snapshot => {
        state.sellerSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ê³µê¸‰ì‚¬ ì •ì‚° ë°ì´í„° (ì˜ì—…í˜„í™©ìš©)
      db.collection('supplierSettlements').orderBy('settlementDate', 'desc').onSnapshot(snapshot => {
        state.supplierSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      });

      // íŒ€ì› ë°ì´í„° (ì˜ì—…í˜„í™©ìš©)
      db.collection('teamMembers').orderBy('name').onSnapshot(snapshot => {
        state.teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ì „ëµ ì„¤ì • ë°ì´í„° (ëª©í‘œì¹˜)
      db.collection('settings').doc('strategy').onSnapshot(doc => {
        if (doc.exists) {
          state.strategyData = doc.data();
        }
      });

      // ì—°ë„ë³„ ëª©í‘œ ë°ì´í„°
      db.collection('yearlyGoals').orderBy('year', 'asc').onSnapshot(snapshot => {
        state.yearlyGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'dashboard') renderSalesDashboard();
      });

      // ëŒ€í˜•í”„ë¡œì íŠ¸ ë°ì´í„°
      db.collection('megaProjects').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.megaProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'kpi') renderKPIManagement();
      });

      // íŒ€ KPI ë°ì´í„° (ë…ë¦½ ì»¬ë ‰ì…˜)
      db.collection('teamKPIs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.teamKPIs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'kpi') renderKPIManagement();
      });

      // ê°œì¸ KPI ë°ì´í„° (ë…ë¦½ ì»¬ë ‰ì…˜)
      db.collection('memberKPIs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.memberKPIs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'kpi') renderKPIManagement();
      });

      // ì—…ë¬´ ë°ì´í„° (KPI ì—°ê²°)
      db.collection('tasks').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (state.currentTab === 'worklog') renderWorkLog();
      });

      // ì „ëµ ë²„ì „ íˆìŠ¤í† ë¦¬
      db.collection('strategyVersions').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        state.strategyVersions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      });

      // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
      loadCurrentUser();
    }

    // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    async function loadCurrentUser() {
      try {
        const loginId = sessionStorage.getItem('moyeora_login_id');
        if (loginId) {
          const snapshot = await db.collection('teamMembers').where('loginId', '==', loginId).get();
          if (!snapshot.empty) {
            state.currentUser = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
          }
        }
        // ê¸°ë³¸ê°’ ì„¤ì • (ê´€ë¦¬ìë¡œ ê°€ì •)
        if (!state.currentUser) {
          state.currentUser = { id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin', loginId: 'admin' };
        }
      } catch (e) {
        console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', e);
        state.currentUser = { id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin', loginId: 'admin' };
      }
    }

    // íƒ­ ì „í™˜
    function switchTab(tabId) {
      state.currentTab = tabId;

      // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-tab') === tabId) {
          item.classList.add('active');
        }
      });

      // íƒ­ ì»¨í…ì¸  í‘œì‹œ
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      const tabEl = document.getElementById(`tab-${tabId}`);
      if (tabEl) tabEl.classList.add('active');

      render();

      // íƒ­ë³„ ë Œë”ë§
      switch(tabId) {
        case 'dashboard': renderSalesDashboard(); break;
        case 'kpi': renderKPIManagement(); break;
        case 'worklog': renderWorkLog(); break;
        case 'review': renderStrategicReview(); break;
        case 'guide': renderGuide(); break;
        case 'reference': renderReferences(); break;
      }
    }

    // OKR ê¸°ê°„ ì „í™˜
    function switchOkrPeriod(period) {
      document.querySelectorAll('.tab-nav .tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      // TODO: ê¸°ê°„ë³„ OKR ë°ì´í„° ë¡œë“œ
    }

    // ì‚¬ì´ë“œë°” í† ê¸€
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('show');
    }

    // ë Œë”ë§
    function render() {
      // ê·¸ë¡œìŠ¤ë³´ë“œ ì§€í‘œ (null ì²´í¬)
      const conversionRateEl = document.getElementById('conversionRate');
      const avgDealDaysEl = document.getElementById('avgDealDays');
      const repeatRateEl = document.getElementById('repeatRate');
      const npsScoreEl = document.getElementById('npsScore');

      if (conversionRateEl) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const activeDeals = state.deals.filter(deal => {
          const start = new Date(deal.startDate);
          const end = new Date(deal.endDate);
          return today >= start && today <= end;
        });
        conversionRateEl.textContent = state.deals.length > 0 ? `${((activeDeals.length / state.deals.length) * 100).toFixed(1)}%` : '-';
      }
      if (avgDealDaysEl) avgDealDaysEl.textContent = '7ì¼';
      if (repeatRateEl) repeatRateEl.textContent = '-';
      if (npsScoreEl) npsScoreEl.textContent = '-';

      // ëŒ€ì‹œë³´ë“œ - ë„ë©”ì¸ë³„ ë°ì´í„° ì—…ë°ì´íŠ¸
      const domainSuppliersEl = document.getElementById('domainSuppliers');
      if (domainSuppliersEl) {
        domainSuppliersEl.textContent = (state.suppliers?.length || 0) + 'ê°œ';
      }

      // ëŒ€ì‹œë³´ë“œ - ì˜ì—… ì‹¤ì  ì—…ë°ì´íŠ¸
      const salesStatsEl = document.getElementById('salesStats');
      if (salesStatsEl) {
        salesStatsEl.innerHTML = `
          <span style="font-size: 11px; padding: 4px 10px; background: #dbeafe; color: #2563eb; border-radius: 4px;">ğŸ‘¥ ì…€ëŸ¬ ${state.sellers?.length || 0}ëª…</span>
          <span style="font-size: 11px; padding: 4px 10px; background: #dbeafe; color: #2563eb; border-radius: 4px;">ğŸ“¦ ê³µêµ¬ ${state.deals?.length || 0}ê±´</span>
        `;
      }
    }

    // í”„ë¡œì íŠ¸ ëª¨ë‹¬ ì—´ê¸° (êµ¬ë²„ì „ - ë¯¸ì‚¬ìš©)
    function openProjectModal(project = null) {
      const modal = document.getElementById('projectModal');
      const title = document.getElementById('projectModalTitle');
      const deleteBtn = document.getElementById('deleteProjectBtn');

      // í¼ ì´ˆê¸°í™”
      document.getElementById('projectId').value = project?.id || '';
      document.getElementById('projectName').value = project?.name || '';
      document.getElementById('projectDesc').value = project?.description || '';
      document.getElementById('projectRevenueGoal').value = project?.revenueGoal || '';
      document.getElementById('projectStartDate').value = project?.startDate || '';
      document.getElementById('projectEndDate').value = project?.endDate || '';
      document.getElementById('projectStatus').value = project?.status || 'active';

      // KPI ì´ˆê¸°í™”
      document.getElementById('teamKPIList').innerHTML = '';
      document.getElementById('memberKPIList').innerHTML = '';

      if (project) {
        title.textContent = 'í”„ë¡œì íŠ¸ ìˆ˜ì •';
        deleteBtn.style.display = 'block';
        // ê¸°ì¡´ íŒ€ KPI ë¡œë“œ
        (project.teamKPIs || []).forEach(kpi => addTeamKPI(kpi));
        // ê¸°ì¡´ ê°œë³„ KPI ë¡œë“œ
        (project.memberKPIs || []).forEach(kpi => addMemberKPI(kpi));
      } else {
        title.textContent = 'í”„ë¡œì íŠ¸ ì¶”ê°€';
        deleteBtn.style.display = 'none';
        // ê¸°ë³¸ KPI í•˜ë‚˜ì”© ì¶”ê°€
        addTeamKPI();
      }

      modal.classList.add('show');
    }

    function closeProjectModal() {
      document.getElementById('projectModal').classList.remove('show');
    }

    // ë²”ìš© ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.className = 'modal';
        modal.innerHTML = '';
      }
    }

    // íŒ€ KPI ì¶”ê°€
    function addTeamKPI(kpi = null) {
      const list = document.getElementById('teamKPIList');
      const idx = list.children.length;
      const div = document.createElement('div');
      div.style.cssText = 'display: grid; grid-template-columns: 1fr 80px 80px 40px; gap: 8px; align-items: center; background: var(--gray-50); padding: 12px; border-radius: 8px;';
      div.innerHTML = `
        <input type="text" class="team-kpi-name" placeholder="KPI í•­ëª© (ì˜ˆ: ê³µê¸‰ì‚¬ ê³„ì•½)" value="${kpi?.name || ''}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <input type="number" class="team-kpi-target" placeholder="ëª©í‘œ" value="${kpi?.target || ''}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <input type="number" class="team-kpi-current" placeholder="í˜„ì¬" value="${kpi?.current || 0}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <button type="button" onclick="this.parentElement.remove()" style="background: var(--danger-light); color: var(--danger); border: none; padding: 8px; border-radius: 6px; cursor: pointer;">âœ•</button>
      `;
      list.appendChild(div);
    }

    // ê°œë³„ KPI ì¶”ê°€
    function addMemberKPI(kpi = null) {
      const list = document.getElementById('memberKPIList');
      const div = document.createElement('div');
      div.style.cssText = 'display: grid; grid-template-columns: 100px 1fr 70px 70px 40px; gap: 8px; align-items: center; background: var(--info-light); padding: 12px; border-radius: 8px;';
      div.innerHTML = `
        <select class="member-kpi-member" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
          <option value="songhee" ${kpi?.memberId === 'songhee' ? 'selected' : ''}>ê¹€ì†¡í¬</option>
          <option value="chaeeun" ${kpi?.memberId === 'chaeeun' ? 'selected' : ''}>ì´ì±„ì€</option>
        </select>
        <input type="text" class="member-kpi-name" placeholder="KPI í•­ëª©" value="${kpi?.name || ''}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <input type="number" class="member-kpi-target" placeholder="ëª©í‘œ" value="${kpi?.target || ''}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <input type="number" class="member-kpi-current" placeholder="í˜„ì¬" value="${kpi?.current || 0}" style="padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px;">
        <button type="button" onclick="this.parentElement.remove()" style="background: var(--danger-light); color: var(--danger); border: none; padding: 8px; border-radius: 6px; cursor: pointer;">âœ•</button>
      `;
      list.appendChild(div);
    }

    // í”„ë¡œì íŠ¸ ì €ì¥
    async function saveProject() {
      const id = document.getElementById('projectId').value;
      const name = document.getElementById('projectName').value.trim();

      if (!name) {
        showToast('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      // íŒ€ KPI ìˆ˜ì§‘
      const teamKPIs = [];
      document.querySelectorAll('#teamKPIList > div').forEach(row => {
        const kpiName = row.querySelector('.team-kpi-name').value.trim();
        const target = parseInt(row.querySelector('.team-kpi-target').value) || 0;
        const current = parseInt(row.querySelector('.team-kpi-current').value) || 0;
        if (kpiName) {
          teamKPIs.push({ name: kpiName, target, current });
        }
      });

      // ê°œë³„ KPI ìˆ˜ì§‘
      const memberKPIs = [];
      document.querySelectorAll('#memberKPIList > div').forEach(row => {
        const memberId = row.querySelector('.member-kpi-member').value;
        const kpiName = row.querySelector('.member-kpi-name').value.trim();
        const target = parseInt(row.querySelector('.member-kpi-target').value) || 0;
        const current = parseInt(row.querySelector('.member-kpi-current').value) || 0;
        if (kpiName) {
          memberKPIs.push({ memberId, name: kpiName, target, current });
        }
      });

      const projectData = {
        name,
        description: document.getElementById('projectDesc').value.trim(),
        revenueGoal: parseInt(document.getElementById('projectRevenueGoal').value) || 0,
        startDate: document.getElementById('projectStartDate').value,
        endDate: document.getElementById('projectEndDate').value,
        status: document.getElementById('projectStatus').value,
        teamKPIs,
        memberKPIs,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('projects').doc(id).update(projectData);
        } else {
          projectData.createdAt = new Date().toISOString();
          await db.collection('projects').add(projectData);
        }
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeProjectModal();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    // í”„ë¡œì íŠ¸ ì‚­ì œ
    async function deleteProject() {
      const id = document.getElementById('projectId').value;
      if (!id) return;

      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('projects').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeProjectModal();
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // KPI ë¹ ë¥¸ ì—…ë°ì´íŠ¸
    async function quickUpdateKPI(projectId, kpiType, kpiIndex, newValue) {
      const project = state.projects.find(p => p.id === projectId);
      if (!project) return;

      const kpiList = kpiType === 'team' ? project.teamKPIs : project.memberKPIs;
      if (kpiList && kpiList[kpiIndex]) {
        kpiList[kpiIndex].current = parseInt(newValue) || 0;

        try {
          await db.collection('projects').doc(projectId).update({
            [kpiType === 'team' ? 'teamKPIs' : 'memberKPIs']: kpiList
          });
          showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        } catch (e) {
          showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
      }
    }

    // í”„ë¡œì íŠ¸ ëª©ë¡ ë Œë”ë§
    function renderProjects() {
      const list = document.getElementById('projectList');
      if (!list) return;

      const projects = state.projects || [];
      const activeProjects = projects.filter(p => p.status === 'active');

      // ìš”ì•½ ì—…ë°ì´íŠ¸ (null ì²´í¬)
      const totalGoal = projects.reduce((sum, p) => sum + (p.revenueGoal || 0), 0);
      const totalRevenueGoalEl = document.getElementById('totalRevenueGoal');
      const activeProjectsEl = document.getElementById('activeProjects');
      const completedKPIsEl = document.getElementById('completedKPIs');

      if (totalRevenueGoalEl) {
        totalRevenueGoalEl.textContent = totalGoal >= 100000000
          ? (totalGoal / 100000000).toFixed(1) + 'ì–µì›'
          : (totalGoal / 10000).toLocaleString() + 'ë§Œì›';
      }
      if (activeProjectsEl) {
        activeProjectsEl.textContent = activeProjects.length;
      }

      // KPI ì™„ë£Œ ê³„ì‚°
      let totalKPIs = 0, completedKPIs = 0;
      projects.forEach(p => {
        (p.teamKPIs || []).forEach(k => {
          totalKPIs++;
          if (k.current >= k.target) completedKPIs++;
        });
        (p.memberKPIs || []).forEach(k => {
          totalKPIs++;
          if (k.current >= k.target) completedKPIs++;
        });
      });
      if (completedKPIsEl) {
        completedKPIsEl.textContent = `${completedKPIs}/${totalKPIs}`;
      }

      if (projects.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 60px; background: var(--gray-50); border-radius: 16px; border: 2px dashed var(--gray-300);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div>
            <div style="font-size: 16px; color: var(--gray-600); margin-bottom: 16px;">ì•„ì§ ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <button class="btn btn-primary" onclick="openProjectModal()">+ ì²« í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</button>
          </div>
        `;
        return;
      }

      list.innerHTML = projects.map(project => {
        const statusColors = {
          active: { bg: '#dcfce7', text: '#16a34a', icon: 'ğŸŸ¢' },
          paused: { bg: '#fef3c7', text: '#d97706', icon: 'ğŸŸ¡' },
          completed: { bg: '#dbeafe', text: '#2563eb', icon: 'âœ…' }
        };
        const status = statusColors[project.status] || statusColors.active;

        // íŒ€ KPI ì§„í–‰ë¥ 
        const teamKPIs = project.teamKPIs || [];
        const memberKPIs = project.memberKPIs || [];
        const allKPIs = [...teamKPIs, ...memberKPIs];
        const kpiProgress = allKPIs.length > 0
          ? Math.round(allKPIs.reduce((sum, k) => sum + Math.min(100, (k.current / k.target) * 100), 0) / allKPIs.length)
          : 0;

        return `
          <div class="card" style="cursor: pointer;" onclick="openProjectModal(state.projects.find(p=>p.id==='${project.id}'))">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
              <div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <span style="font-size: 20px; font-weight: 700;">${project.name}</span>
                  <span style="background: ${status.bg}; color: ${status.text}; padding: 2px 8px; border-radius: 12px; font-size: 11px;">${status.icon} ${project.status === 'active' ? 'ì§„í–‰ì¤‘' : project.status === 'paused' ? 'ì¼ì‹œì •ì§€' : 'ì™„ë£Œ'}</span>
                </div>
                <div style="font-size: 13px; color: var(--gray-500);">${project.description || ''}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 24px; font-weight: 800; color: var(--primary);">${project.revenueGoal >= 100000000 ? (project.revenueGoal/100000000).toFixed(1) + 'ì–µ' : (project.revenueGoal/10000).toLocaleString() + 'ë§Œ'}</div>
                <div style="font-size: 11px; color: var(--gray-500);">ë§¤ì¶œ ëª©í‘œ</div>
              </div>
            </div>

            <!-- KPI ì§„í–‰ë¥  ë°” -->
            <div style="margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                <span style="color: var(--gray-600);">KPI ì§„í–‰ë¥ </span>
                <span style="font-weight: 600; color: ${kpiProgress >= 70 ? 'var(--success)' : kpiProgress >= 40 ? 'var(--warning)' : 'var(--gray-600)'};">${kpiProgress}%</span>
              </div>
              <div style="background: var(--gray-200); height: 8px; border-radius: 4px;">
                <div style="background: ${kpiProgress >= 70 ? 'var(--success)' : kpiProgress >= 40 ? 'var(--warning)' : 'var(--primary)'}; height: 100%; width: ${kpiProgress}%; border-radius: 4px; transition: width 0.3s;"></div>
              </div>
            </div>

            <!-- íŒ€ KPI -->
            ${teamKPIs.length > 0 ? `
            <div style="margin-bottom: 12px;">
              <div style="font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 8px;">ğŸ¯ íŒ€ KPI</div>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${teamKPIs.map((kpi, idx) => {
                  const progress = Math.min(100, Math.round((kpi.current / kpi.target) * 100));
                  return `
                    <div style="background: var(--gray-50); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;" onclick="event.stopPropagation()">
                      <span style="font-size: 13px;">${kpi.name}</span>
                      <span style="font-weight: 700; color: ${progress >= 100 ? 'var(--success)' : 'var(--gray-900)'};">${kpi.current}/${kpi.target}</span>
                      <button onclick="event.stopPropagation(); quickUpdateKPI('${project.id}', 'team', ${idx}, ${kpi.current + 1})" style="background: var(--primary); color: white; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 14px;">+</button>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            ` : ''}

            <!-- ê°œë³„ KPI -->
            ${memberKPIs.length > 0 ? `
            <div>
              <div style="font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 8px;">ğŸ‘¤ ê°œë³„ KPI</div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                ${memberKPIs.map((kpi, idx) => {
                  const progress = Math.min(100, Math.round((kpi.current / kpi.target) * 100));
                  const memberName = kpi.memberId === 'songhee' ? 'ê¹€ì†¡í¬' : 'ì´ì±„ì€';
                  return `
                    <div style="background: var(--info-light); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;" onclick="event.stopPropagation()">
                      <div>
                        <span style="font-size: 11px; color: var(--info);">${memberName}</span>
                        <div style="font-size: 13px;">${kpi.name}</div>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-weight: 700; color: ${progress >= 100 ? 'var(--success)' : 'var(--gray-900)'};">${kpi.current}/${kpi.target}</span>
                        <button onclick="event.stopPropagation(); quickUpdateKPI('${project.id}', 'member', ${idx}, ${kpi.current + 1})" style="background: var(--info); color: white; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; font-size: 12px;">+</button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            ` : ''}

            <!-- ê¸°ê°„ -->
            ${project.startDate || project.endDate ? `
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); font-size: 12px; color: var(--gray-500);">
              ğŸ“… ${project.startDate || '?'} ~ ${project.endDate || '?'}
            </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // ========================================
    // ë ˆí¼ëŸ°ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹œìŠ¤í…œ
    // ========================================

    // ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸° í—¬í¼
    function getCategories() {
      return state.refCategories.length > 0 ? state.refCategories : DEFAULT_CATEGORIES;
    }

    function getCategoryById(catId) {
      const cats = getCategories();
      return cats.find(c => c.id === catId) || cats[cats.length - 1];
    }

    // ì¹´í…Œê³ ë¦¬ í•„í„° ë²„íŠ¼ ë Œë”ë§
    function renderCategoryFilters() {
      const container = document.getElementById('refCategoryFilters');
      if (!container) return;

      const cats = getCategories();
      let html = `<button onclick="setRefCategoryFilter('all')" class="ref-cat-btn ${refCategoryFilter === 'all' ? 'active' : ''}"
                          style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600;
                          background: ${refCategoryFilter === 'all' ? '#0064FF' : '#F2F4F6'};
                          color: ${refCategoryFilter === 'all' ? 'white' : '#6B7684'};">ì „ì²´</button>`;

      cats.forEach(c => {
        const isActive = refCategoryFilter === c.id;
        html += `<button onclick="setRefCategoryFilter('${c.id}')" class="ref-cat-btn ${isActive ? 'active' : ''}"
                         style="padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;
                         background: ${isActive ? c.color : c.bg}; color: ${isActive ? 'white' : c.color};">
                   ${c.emoji} ${c.label}
                 </button>`;
      });
      container.innerHTML = html;
    }

    // ì¹´í…Œê³ ë¦¬ ì…€ë ‰íŠ¸ ì˜µì…˜ ë Œë”ë§
    function renderCategoryOptions() {
      const select = document.getElementById('referenceCategory');
      if (!select) return;

      const cats = getCategories();
      select.innerHTML = cats.map(c => `<option value="${c.id}">${c.emoji} ${c.label}</option>`).join('');
    }

    // ì¹´í…Œê³ ë¦¬ í•„í„° ì„¤ì •
    function setRefCategoryFilter(category) {
      refCategoryFilter = category;
      renderCategoryFilters();
      filterReferences();
    }

    // ë ˆí¼ëŸ°ìŠ¤ í•„í„°ë§
    function filterReferences() {
      const searchInput = document.getElementById('refSearch');
      const search = searchInput ? searchInput.value.toLowerCase() : '';
      refSearchQuery = search;

      const filtered = state.references.filter(ref => {
        const matchCategory = refCategoryFilter === 'all' || ref.category === refCategoryFilter;
        const matchSearch = !search ||
          ref.title.toLowerCase().includes(search) ||
          (ref.description || '').toLowerCase().includes(search) ||
          (ref.tags || []).some(t => t.toLowerCase().includes(search));
        return matchCategory && matchSearch;
      });
      renderReferenceList(filtered);
    }

    // ë ˆí¼ëŸ°ìŠ¤ ëª©ë¡ ë Œë”ë§
    function renderReferences() {
      renderCategoryFilters();
      filterReferences();
    }

    function renderReferenceList(references) {
      const container = document.getElementById('referenceList');
      if (!container) return;

      if (references.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px; grid-column: 1 / -1; background: white; border-radius: 16px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
            <div style="font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ë“±ë¡ëœ ë ˆí¼ëŸ°ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <p style="color: var(--gray-600); margin-bottom: 20px;">ìƒˆë¡œìš´ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
            <button onclick="openReferenceModal()" class="btn btn-primary">+ ì²« ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€</button>
          </div>`;
        return;
      }

      let html = '';
      references.forEach(ref => {
        const cat = getCategoryById(ref.category);
        const date = ref.createdAt ? ref.createdAt.substring(0, 10) : '';
        const images = ref.images || [];
        const hasImages = images.length > 0;
        const firstImage = hasImages ? images[0].data : null;
        const tags = (ref.tags || []).slice(0, 3);

        html += `
          <div onclick="openReferenceDetail('${ref.id}')"
               style="background: white; border-radius: 16px; overflow: hidden; cursor: pointer; transition: all 0.2s;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #E5E8EB;"
               onmouseover="this.style.borderColor='#8B5CF6'; this.style.transform='translateY(-2px)'"
               onmouseout="this.style.borderColor='#E5E8EB'; this.style.transform='none'">
            ${firstImage ? `
              <div style="position: relative; width: 100%; height: 140px; background: #F2F4F6;">
                <img src="${firstImage}" style="width: 100%; height: 100%; object-fit: cover;">
                ${images.length > 1 ? `<span style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">+${images.length - 1}</span>` : ''}
              </div>
            ` : ''}
            <div style="padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 11px; padding: 4px 10px; background: ${cat.bg}; color: ${cat.color}; border-radius: 6px; font-weight: 600;">${cat.emoji} ${cat.label}</span>
                <span style="font-size: 11px; color: #8B95A1;">${date}</span>
              </div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px; line-height: 1.4;">${ref.title}</div>
              ${ref.description ? `<div style="font-size: 12px; color: #6B7684; margin-bottom: 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${ref.description}</div>` : ''}
              <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                ${ref.linkUrl ? `<span style="font-size: 10px; padding: 3px 8px; background: #E8F3FF; color: #0064FF; border-radius: 4px;">ğŸ”— ë§í¬</span>` : ''}
                ${hasImages ? `<span style="font-size: 10px; padding: 3px 8px; background: #FEF3C7; color: #B45309; border-radius: 4px;">ğŸ–¼ï¸ ${images.length}ì¥</span>` : ''}
                ${ref.fileUrl && !hasImages ? `<span style="font-size: 10px; padding: 3px 8px; background: #DCFCE7; color: #16A34A; border-radius: 4px;">ğŸ“ íŒŒì¼</span>` : ''}
                ${tags.map(t => `<span style="font-size: 11px; padding: 4px 8px; background: #F2F4F6; color: #6B7684; border-radius: 4px;">#${t}</span>`).join('')}
              </div>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ë ˆí¼ëŸ°ìŠ¤ ëª¨ë‹¬ ì—´ê¸°
    function openReferenceModal(refId = null) {
      refUploadedImages = [];
      const modal = document.getElementById('referenceModal');
      const title = document.getElementById('referenceModalTitle');
      const deleteBtn = document.getElementById('deleteReferenceBtn');

      renderCategoryOptions();

      // í¼ ì´ˆê¸°í™”
      document.getElementById('referenceId').value = '';
      document.getElementById('referenceTitle').value = '';
      document.getElementById('referenceCategory').value = 'event';
      document.getElementById('referenceDesc').value = '';
      document.getElementById('referenceLink').value = '';
      document.getElementById('referenceFileUrl').value = '';
      document.getElementById('referenceTags').value = '';
      document.getElementById('refImagesPreview').style.display = 'none';
      document.getElementById('refImagesPreview').innerHTML = '';

      if (refId) {
        title.textContent = 'ë ˆí¼ëŸ°ìŠ¤ ìˆ˜ì •';
        deleteBtn.style.display = 'block';
        loadReferenceForEdit(refId);
      } else {
        title.textContent = 'ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€';
        deleteBtn.style.display = 'none';
      }

      modal.classList.add('show');
    }

    // ìˆ˜ì •ìš© ë°ì´í„° ë¡œë“œ
    async function loadReferenceForEdit(refId) {
      try {
        const doc = await db.collection('references').doc(refId).get();
        if (doc.exists) {
          const ref = doc.data();
          document.getElementById('referenceId').value = refId;
          document.getElementById('referenceTitle').value = ref.title || '';
          document.getElementById('referenceCategory').value = ref.category || 'etc';
          document.getElementById('referenceDesc').value = ref.description || '';
          document.getElementById('referenceLink').value = ref.linkUrl || '';
          document.getElementById('referenceFileUrl').value = ref.fileUrl || '';
          document.getElementById('referenceTags').value = (ref.tags || []).join(', ');

          if (ref.images && ref.images.length > 0) {
            refUploadedImages = ref.images;
            renderRefImagesPreview();
          }
        }
      } catch (e) {
        console.error('ë ˆí¼ëŸ°ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }

    function closeReferenceModal() {
      document.getElementById('referenceModal').classList.remove('show');
    }

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
    async function handleRefImageUpload(files) {
      if (!files || files.length === 0) return;

      const maxImages = 10;
      const currentCount = refUploadedImages.length;
      if (currentCount >= maxImages) {
        showToast('ìµœëŒ€ ' + maxImages + 'ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
        return;
      }

      const filesToProcess = Array.from(files).slice(0, maxImages - currentCount);
      const btn = document.getElementById('btnSaveRef');
      if (btn) btn.disabled = true;

      for (const file of filesToProcess) {
        const result = await processRefImage(file);
        if (result) refUploadedImages.push(result);
      }

      renderRefImagesPreview();
      if (btn) btn.disabled = false;
      document.getElementById('refFileInput').value = '';
      showToast(`${filesToProcess.length}ì¥ ì¶”ê°€ë¨`);
    }

    async function processRefImage(file) {
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
      const ext = file.name.split('.').pop().toLowerCase();
      if (!allowedTypes.includes(file.type) && !['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return null;
      if (file.size > 10 * 1024 * 1024) return null;

      try {
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        // ê°„ë‹¨í•œ ì••ì¶• (700KB ì´í•˜ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        if (base64.length <= 700000) {
          return { data: base64, name: file.name, type: file.type };
        }

        // ì••ì¶• í•„ìš”ì‹œ canvas ì‚¬ìš©
        const compressed = await compressImage(base64, 1200, 0.7);
        return { data: compressed, name: file.name, type: 'image/jpeg' };
      } catch (e) {
        console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
        return null;
      }
    }

    function compressImage(base64, maxSize, quality) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let { width, height } = img;
          if (width > maxSize || height > maxSize) {
            if (width > height) {
              height = Math.round(height * maxSize / width);
              width = maxSize;
            } else {
              width = Math.round(width * maxSize / height);
              height = maxSize;
            }
          }
          canvas.width = width;
          canvas.height = height;
          canvas.getContext('2d').drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = base64;
      });
    }

    function renderRefImagesPreview() {
      const preview = document.getElementById('refImagesPreview');
      const count = document.getElementById('refImageCount');

      if (count) count.textContent = refUploadedImages.length > 0 ? `(${refUploadedImages.length}ì¥)` : '';

      if (!preview) return;
      if (refUploadedImages.length === 0) {
        preview.style.display = 'none';
        return;
      }

      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px;">';
      refUploadedImages.forEach((img, i) => {
        html += `
          <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 1px solid #F59E0B;">
            <img src="${img.data}" style="width: 100%; height: 100%; object-fit: cover;">
            <button onclick="removeRefImage(${i})" style="position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; background: rgba(220,38,38,0.9); color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
          </div>`;
      });
      html += '</div>';
      preview.innerHTML = html;
      preview.style.display = 'block';
    }

    function removeRefImage(index) {
      refUploadedImages.splice(index, 1);
      renderRefImagesPreview();
    }

    // ë ˆí¼ëŸ°ìŠ¤ ì €ì¥
    async function saveReference() {
      const id = document.getElementById('referenceId').value;
      const title = document.getElementById('referenceTitle').value.trim();
      const linkUrl = document.getElementById('referenceLink').value.trim();
      const fileUrl = document.getElementById('referenceFileUrl').value.trim();

      if (!title) { showToast('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (!linkUrl && refUploadedImages.length === 0 && !fileUrl) {
        showToast('ë§í¬ ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”');
        return;
      }

      const tagsStr = document.getElementById('referenceTags').value.trim();
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : [];

      const data = {
        title,
        category: document.getElementById('referenceCategory').value,
        description: document.getElementById('referenceDesc').value.trim(),
        linkUrl: linkUrl || null,
        fileUrl: refUploadedImages.length > 0 ? null : (fileUrl || null),
        images: refUploadedImages,
        tags,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('references').doc(id).update(data);
        } else {
          data.createdAt = new Date().toISOString();
          data.createdBy = 'admin';
          data.createdByName = 'ê´€ë¦¬ì';
          await db.collection('references').add(data);
        }
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeReferenceModal();
        renderReferences();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    // ë ˆí¼ëŸ°ìŠ¤ ì‚­ì œ
    async function deleteReference() {
      const id = document.getElementById('referenceId').value;
      if (!id || !confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('references').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeReferenceModal();
        renderReferences();
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ë³´ê¸°
    async function openReferenceDetail(refId) {
      const ref = state.references.find(r => r.id === refId);
      if (!ref) return;

      const cat = getCategoryById(ref.category);
      const images = ref.images || [];
      const tags = ref.tags || [];

      let html = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 20px 24px; border-bottom: 1px solid var(--gray-200);">
          <span style="font-size: 13px; padding: 6px 14px; background: ${cat.bg}; color: ${cat.color}; border-radius: 8px; font-weight: 600;">${cat.emoji} ${cat.label}</span>
          <button onclick="closeReferenceDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
        </div>
        <div style="padding: 24px;">
          <h2 style="font-size: 22px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">${ref.title}</h2>
          ${images.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <div style="width: 100%; max-height: 350px; border-radius: 12px; overflow: hidden; background: #F2F4F6; margin-bottom: 10px;">
                <img id="detailMainImg" src="${images[0].data}" style="width: 100%; height: 100%; object-fit: contain; max-height: 350px;">
              </div>
              ${images.length > 1 ? `
                <div style="display: flex; gap: 8px; overflow-x: auto;">
                  ${images.map((img, i) => `<img src="${img.data}" onclick="document.getElementById('detailMainImg').src='${img.data}'" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid ${i === 0 ? '#8B5CF6' : '#E5E8EB'};">`).join('')}
                </div>
              ` : ''}
            </div>
          ` : ''}
          ${ref.description ? `<div style="font-size: 15px; color: var(--gray-700); line-height: 1.7; margin-bottom: 20px; padding: 16px; background: var(--gray-100); border-radius: 10px;">${ref.description}</div>` : ''}
          ${ref.linkUrl ? `
            <a href="${ref.linkUrl}" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #E8F3FF; border-radius: 12px; margin-bottom: 12px; text-decoration: none;">
              <span style="font-size: 24px;">ğŸ”—</span>
              <div style="flex: 1;"><div style="font-size: 14px; font-weight: 600; color: #0064FF;">ì™¸ë¶€ ë§í¬ ì—´ê¸°</div></div>
              <span style="color: #0064FF;">â†’</span>
            </a>
          ` : ''}
          ${ref.fileUrl && images.length === 0 ? `
            <a href="${ref.fileUrl}" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #DCFCE7; border-radius: 12px; margin-bottom: 12px; text-decoration: none;">
              <span style="font-size: 24px;">ğŸ“</span>
              <div style="flex: 1;"><div style="font-size: 14px; font-weight: 600; color: #16A34A;">íŒŒì¼ ì—´ê¸°</div></div>
              <span style="color: #16A34A;">â†’</span>
            </a>
          ` : ''}
          ${tags.length > 0 ? `<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">${tags.map(t => `<span style="font-size: 12px; padding: 6px 12px; background: var(--gray-100); color: var(--gray-600); border-radius: 6px;">#${t}</span>`).join('')}</div>` : ''}
          <div style="padding: 16px; background: var(--gray-50); border-radius: 10px; font-size: 13px; color: var(--gray-500);">
            ğŸ“… ${ref.createdAt ? ref.createdAt.substring(0, 10) : ''}
          </div>
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button onclick="closeReferenceDetail(); openReferenceModal('${ref.id}')" class="btn btn-primary" style="flex: 1;">âœï¸ ìˆ˜ì •</button>
            <button onclick="if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { db.collection('references').doc('${ref.id}').delete(); closeReferenceDetail(); showToast('ì‚­ì œë¨'); renderReferences(); }" class="btn btn-secondary" style="flex: 1; color: var(--danger);">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </div>
      `;

      document.getElementById('referenceDetailContent').innerHTML = html;
      document.getElementById('referenceDetailModal').classList.add('show');
    }

    function closeReferenceDetail() {
      document.getElementById('referenceDetailModal').classList.remove('show');
    }

    // ========================================
    // ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ì‹œìŠ¤í…œ
    // ========================================

    function openCategoryModal() {
      renderCategoryList();
      document.getElementById('categoryModal').classList.add('show');
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('show');
    }

    function renderCategoryList() {
      const list = document.getElementById('categoryList');
      const cats = getCategories();

      list.innerHTML = cats.map((c, i) => `
        <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: ${c.bg}; border-radius: 8px;">
          <span style="font-size: 20px;">${c.emoji}</span>
          <span style="flex: 1; font-weight: 500; color: ${c.color};">${c.label}</span>
          <button onclick="editCategory('${c.id}')" style="background: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">ìˆ˜ì •</button>
          <button onclick="deleteCategory('${c.id}')" style="background: #FEE2E2; color: #DC2626; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    async function addCategory() {
      const emoji = document.getElementById('newCatEmoji').value.trim() || 'ğŸ“';
      const name = document.getElementById('newCatName').value.trim();
      const color = document.getElementById('newCatColor').value;

      if (!name) { showToast('ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      const id = name.toLowerCase().replace(/\s+/g, '_');
      const bg = color + '20'; // ì—°í•œ ë°°ê²½ìƒ‰

      try {
        await db.collection('refCategories').doc(id).set({
          id, label: name, emoji, color, bg,
          order: state.refCategories.length,
          createdAt: new Date().toISOString()
        });
        showToast('ì¹´í…Œê³ ë¦¬ ì¶”ê°€ë¨');
        document.getElementById('newCatEmoji').value = '';
        document.getElementById('newCatName').value = '';
      } catch (e) {
        showToast('ì¶”ê°€ ì‹¤íŒ¨');
      }
    }

    async function editCategory(catId) {
      const cat = getCategoryById(catId);
      const newEmoji = prompt('ì´ëª¨ì§€:', cat.emoji);
      const newLabel = prompt('ì´ë¦„:', cat.label);
      const newColor = prompt('ìƒ‰ìƒ (hex):', cat.color);

      if (!newLabel) return;

      try {
        await db.collection('refCategories').doc(catId).update({
          emoji: newEmoji || cat.emoji,
          label: newLabel,
          color: newColor || cat.color,
          bg: (newColor || cat.color) + '20'
        });
        showToast('ìˆ˜ì •ë¨');
      } catch (e) {
        showToast('ìˆ˜ì • ì‹¤íŒ¨');
      }
    }

    async function deleteCategory(catId) {
      if (!confirm('ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('refCategories').doc(catId).delete();
        showToast('ì‚­ì œë¨');
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ìˆ«ì í¬ë§·
    function formatNumber(num) {
      if (num === null || num === undefined) return '0';
      return Number(num).toLocaleString('ko-KR');
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 2500);
    }

    // ========================================
    // ì˜ì—…í˜„í™© ì‹œìŠ¤í…œ
    // ========================================
    function getStrategyTarget() {
      const saved = state.strategyData || {};
      return {
        annualRevenue: saved.annualRevenue || 500000000,
        successRate: saved.successRate || 30,
        avgDealRevenue: saved.avgDealRevenue || 4630000,
        targetSuccessDeals: saved.targetSuccessDeals || 108,
        monthlySuccessDeals: saved.monthlySuccessDeals || 9,
        monthlyProfit: saved.monthlyProfit || 4000000,
        annualProfit: saved.annualProfit || 48000000,
        commission30Ratio: saved.commission30Ratio || 70,
        monthlyNewSuppliers: saved.monthlyNewSuppliers || 3,
        monthlyNewSellers: saved.monthlyNewSellers || 15,
        get requiredTotalDeals() { return Math.ceil(this.targetSuccessDeals / (this.successRate / 100)); },
        get monthlyRequiredDeals() { return Math.ceil(this.requiredTotalDeals / 12); },
        get weeklyRequiredDeals() { return Math.ceil(this.requiredTotalDeals / 52); }
      };
    }

    function renderSalesDashboard() {
      const container = document.getElementById('salesDashboardContent');
      if (!container) return;

      container.innerHTML = `
        <div style="text-align: center; padding: 60px;">
          <div class="loading-spinner"></div>
          <p style="color: var(--gray-500); margin-top: 16px;">ì˜ì—…í˜„í™© ë¡œë”©ì¤‘...</p>
        </div>
      `;

      loadSalesDashboardData();
    }

    async function loadSalesDashboardData() {
      try {
        // í•„ìš”í•œ ë°ì´í„° ë¡œë“œ
        if (!state.deals) state.deals = [];
        if (!state.sellerSettlements) state.sellerSettlements = [];
        if (!state.supplierSettlements) state.supplierSettlements = [];
        if (!state.sellers) state.sellers = [];
        if (!state.suppliers) state.suppliers = [];
        if (!state.teamMembers) state.teamMembers = [];

        renderSalesDashboardContent();
      } catch (error) {
        console.error('ì˜ì—…í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('salesDashboardContent').innerHTML = '<div style="text-align: center; padding: 60px; color: var(--danger);">ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜</div>';
      }
    }

    function renderSalesDashboardContent() {
      const container = document.getElementById('salesDashboardContent');
      if (!container) return;

      const members = state.teamMembers || [];
      const currentUser = state.currentUser || {};
      const isAdmin = currentUser.role === 'admin';

      const now = new Date();
      const currentYear = now.getFullYear();
      const thisMonth = now.toISOString().slice(0, 7);
      const thisYearStr = String(currentYear);

      const allSettlements = state.sellerSettlements || [];
      const allDeals = state.deals || [];

      const yearDeals = allDeals.filter(d => (d.startDate || d.createdAt || '').startsWith(thisYearStr));
      const yearSettlements = allSettlements.filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
      const monthDeals = allDeals.filter(d => (d.endDate || '').startsWith(thisMonth));
      const monthSettlements = allSettlements.filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisMonth));

      const successfulDeals = yearDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');
      const monthSuccessfulDeals = monthDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');

      const deals30Percent = yearDeals.filter(d => Number(d.commissionRate || d.supplierCommission || 0) >= 30);
      const commission30Ratio = yearDeals.length > 0 ? Math.round((deals30Percent.length / yearDeals.length) * 100) : 0;

      const totalSalesAmount = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
      const monthSalesAmount = monthSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);

      // ìˆœìµ ê³„ì‚°
      const yearInhouseSettlements = yearSettlements.filter(s => s.productType !== 'external');
      const inhouseSalesAmt = yearInhouseSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
      const inhouseSellerPayout = yearInhouseSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
      const inhousePgFeeAmt = Math.round(inhouseSalesAmt * 0.04);
      const inhouseProfitAmt = inhouseSalesAmt - inhouseSellerPayout - inhousePgFeeAmt;

      const yearExternalSettlements = yearSettlements.filter(s => s.productType === 'external');
      const externalSalesAmt = yearExternalSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
      const externalSellerPayout = yearExternalSettlements.reduce((sum, s) => sum + (Number(s.actualPayment) || 0), 0);
      const externalPgFeeAmt = Math.round(externalSalesAmt * 0.04);

      const yearSupplierSettlements = (state.supplierSettlements || []).filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
      const supplierPayoutAmt = yearSupplierSettlements.reduce((sum, s) => sum + (Number(s.totalSupplyAmount) || Number(s.supplyAmount) || 0) + (Number(s.totalVatAmount) || Number(s.vatAmount) || 0), 0);
      const externalProfitAmt = externalSalesAmt - externalSellerPayout - supplierPayoutAmt - externalPgFeeAmt;

      const totalProfitAmount = inhouseProfitAmt + externalProfitAmt;

      const completedDeals = yearDeals.filter(d => d.status === 'completed' || d.isSuccess !== undefined || d.ë‹¬ì„±ì—¬ë¶€);
      const currentSuccessRate = completedDeals.length > 0 ? Math.round((successfulDeals.length / completedDeals.length) * 100) : 0;

      const T = getStrategyTarget();
      const revenueProgress = Math.min(100, Math.round((totalSalesAmount / T.annualRevenue) * 100));
      const profitProgress = Math.min(100, Math.round((totalProfitAmount / T.annualProfit) * 100));
      const successDealsProgress = Math.min(100, Math.round((successfulDeals.length / T.targetSuccessDeals) * 100));
      const totalDealsProgress = Math.min(100, Math.round((yearDeals.length / T.requiredTotalDeals) * 100));

      const yearEnd = new Date(currentYear, 11, 31);
      const remainingDays = Math.ceil((yearEnd - now) / (1000 * 60 * 60 * 24));
      const remainingWeeks = Math.ceil(remainingDays / 7);
      const remainingMonths = 12 - now.getMonth();

      const remainingTotalDeals = Math.max(T.requiredTotalDeals - yearDeals.length, 0);
      const weeklyNeededDeals = Math.ceil(remainingTotalDeals / Math.max(remainingWeeks, 1));
      const monthlyNeededDeals = Math.ceil(remainingTotalDeals / Math.max(remainingMonths, 1));

      // ì´ë²ˆ ì£¼ ë°ì´í„°
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay());
      weekStart.setHours(0, 0, 0, 0);
      const thisWeekDeals = allDeals.filter(d => {
        if (!d.endDate) return false;
        const endDate = new Date(d.endDate);
        return endDate >= weekStart && endDate <= now;
      });

      const weeklyTargetDeals = T.weeklyRequiredDeals;
      const monthlyTargetDeals = T.monthlyRequiredDeals;
      const weeklyProgress = Math.min(100, Math.round((thisWeekDeals.length / weeklyTargetDeals) * 100));
      const monthlyProgress = Math.min(100, Math.round((monthDeals.length / monthlyTargetDeals) * 100));

      // ì…€ëŸ¬/ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë°ì´í„°
      const allSellerList = state.sellerList || [];
      const allProductList = state.productList || [];

      // ğŸ“‹ ì˜¨ë³´ë”© ì§„ì²™ë„ ê³„ì‚° (ì…€ëŸ¬ë¦¬ìŠ¤íŠ¸)
      const sellerOnboardingItems = allSellerList.filter(s => s.onboarding || s.contacted);
      const sellerOnboardingStats = {
        total: sellerOnboardingItems.length,
        obContact: sellerOnboardingItems.filter(s => s.obContact).length,
        obGuide: sellerOnboardingItems.filter(s => s.obGuide).length,
        obForm: sellerOnboardingItems.filter(s => s.obForm).length,
        obBank: sellerOnboardingItems.filter(s => s.obBank).length,
        obIdCard: sellerOnboardingItems.filter(s => s.obIdCard).length
      };
      const sellerOnboardingProgress = sellerOnboardingStats.total > 0
        ? Math.round(((sellerOnboardingStats.obContact + sellerOnboardingStats.obGuide + sellerOnboardingStats.obForm + sellerOnboardingStats.obBank + sellerOnboardingStats.obIdCard) / (sellerOnboardingStats.total * 5)) * 100)
        : 0;

      // ğŸ“‹ ì˜¨ë³´ë”© ì§„ì²™ë„ ê³„ì‚° (ìƒí’ˆë¦¬ìŠ¤íŠ¸/ê³µê¸‰ì‚¬)
      const supplierOnboardingItems = allProductList.filter(p => p.onboarding || p.contacted);
      const supplierOnboardingStats = {
        total: supplierOnboardingItems.length,
        obContact: supplierOnboardingItems.filter(p => p.obContact).length,
        obGuide: supplierOnboardingItems.filter(p => p.obGuide).length,
        obProductInfo: supplierOnboardingItems.filter(p => p.obProductInfo).length,
        obBizLicense: supplierOnboardingItems.filter(p => p.obBizLicense).length,
        obBank: supplierOnboardingItems.filter(p => p.obBank).length
      };
      const supplierOnboardingProgress = supplierOnboardingStats.total > 0
        ? Math.round(((supplierOnboardingStats.obContact + supplierOnboardingStats.obGuide + supplierOnboardingStats.obProductInfo + supplierOnboardingStats.obBizLicense + supplierOnboardingStats.obBank) / (supplierOnboardingStats.total * 5)) * 100)
        : 0;

      // íŒ€ì›ë³„ ì‹¤ì 
      const memberStats = members.filter(m => m.role !== 'ceo').map(member => {
        const mSuppliers = (state.suppliers || []).filter(s => s.registeredBy === member.id);
        const mSellers = (state.sellers || []).filter(s => s.registeredBy === member.id);

        // ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸ (sellerList ê¸°ë°˜)
        const mSellerList = allSellerList.filter(s => s.createdBy === member.loginId || s.createdBy === member.id);
        const sellerPipeline = {
          total: mSellerList.length,
          proposed: mSellerList.filter(s => s.proposed).length,
          onboarding: mSellerList.filter(s => s.onboarding || s.contacted).length,
          contracted: mSellerList.filter(s => s.contracted).length
        };

        // ìƒí’ˆ íŒŒì´í”„ë¼ì¸ (productList ê¸°ë°˜)
        const mProductList = allProductList.filter(s => s.createdBy === member.loginId || s.createdBy === member.id);
        const supplierPipeline = {
          total: mProductList.length,
          proposed: mProductList.filter(s => s.proposed).length,
          onboarding: mProductList.filter(s => s.onboarding || s.contacted).length,
          contracted: mProductList.filter(s => s.contracted).length
        };

        const mDeals = allDeals.filter(d => d.registeredBy === member.id);
        const mYearDeals = mDeals.filter(d => (d.startDate || d.createdAt || '').startsWith(thisYearStr));
        const mMonthDeals = mDeals.filter(d => (d.endDate || '').startsWith(thisMonth));
        const mSuccessDeals = mYearDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');

        const sellerNames = mSellers.map(s => s.name).filter(Boolean);
        const mSettlements = allSettlements.filter(s => {
          if (s.registeredBy === member.id) return true;
          const sName = s.sellerName || '';
          return sellerNames.some(name => name && (sName.includes(name.split('/')[0]) || sName.includes(name)));
        });

        const mYearSettlements = mSettlements.filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
        const totalSales = mYearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
        const totalProfit = mYearSettlements.reduce((sum, s) => sum + (Number(s.marginAmount) || 0), 0);

        const mCompletedDeals = mYearDeals.filter(d => d.status === 'completed' || d.isSuccess !== undefined || d.ë‹¬ì„±ì—¬ë¶€);
        const mSuccessRate = mCompletedDeals.length > 0 ? Math.round((mSuccessDeals.length / mCompletedDeals.length) * 100) : 0;

        return {
          ...member,
          suppliers: mSuppliers.length,
          sellers: mSellers.length,
          yearDeals: mYearDeals.length,
          monthDeals: mMonthDeals.length,
          successDeals: mSuccessDeals.length,
          successRate: mSuccessRate,
          sales: totalSales,
          profit: totalProfit,
          sellerPipeline,
          supplierPipeline
        };
      });

      // TOP ë­í‚¹
      const supplierSalesMap = {};
      allSettlements.forEach(s => {
        const brand = s.brandName || s.supplierName || 'ë¯¸ì§€ì •';
        if (!supplierSalesMap[brand]) supplierSalesMap[brand] = { name: brand, sales: 0, count: 0 };
        supplierSalesMap[brand].sales += Number(s.salesAmount) || 0;
        supplierSalesMap[brand].count += 1;
      });
      const topSuppliers = Object.values(supplierSalesMap).filter(s => s.sales > 0).sort((a, b) => b.sales - a.sales).slice(0, 5);

      const sellerSalesMap = {};
      allSettlements.forEach(s => {
        const seller = s.sellerName || 'ë¯¸ì§€ì •';
        if (!sellerSalesMap[seller]) sellerSalesMap[seller] = { name: seller, sales: 0, margin: 0, count: 0 };
        sellerSalesMap[seller].sales += Number(s.salesAmount) || 0;
        sellerSalesMap[seller].margin += Number(s.marginAmount) || 0;
        sellerSalesMap[seller].count += 1;
      });
      const topSellers = Object.values(sellerSalesMap).filter(s => s.sales > 0).sort((a, b) => b.sales - a.sales).slice(0, 5);

      const C = {
        primary: '#3182f6',
        orange: '#fc9600',
        blue: '#0064FF',
        blueLight: '#E8F3FF',
        green: '#00C471',
        greenLight: '#E8F8F0',
        red: '#F04452',
        redLight: '#FEE2E4',
        yellow: '#F59E0B',
        yellowLight: '#FEF3C7',
        black: '#191F28',
        gray900: '#191F28',
        gray700: '#333D4B',
        gray600: '#4E5968',
        gray500: '#6B7684',
        gray400: '#8B95A1',
        gray300: '#B0B8C1',
        gray200: '#D1D6DB',
        gray100: '#E5E8EB',
        gray50: '#F2F4F6',
        white: '#FFFFFF'
      };

      const getProgressColor = (progress) => progress >= 80 ? C.green : progress >= 50 ? C.yellow : C.red;
      const getProgressBg = (progress) => progress >= 80 ? C.greenLight : progress >= 50 ? C.yellowLight : C.redLight;

      container.innerHTML = `
        <div style="max-width: 1400px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <h1 style="font-size: 24px; font-weight: 700; color: ${C.black}; margin: 0;">ì˜ì—…í˜„í™©</h1>
              <p style="color: ${C.gray500}; margin-top: 4px; font-size: 13px;">
                ì—° ${(T.annualRevenue / 100000000)}ì–µ = ê³µêµ¬ ${T.requiredTotalDeals}ê±´ (ì›”${T.monthlyRequiredDeals}/ì£¼${T.weeklyRequiredDeals}) â†’ ì„±ê³µ ${T.targetSuccessDeals}ê±´
              </p>
            </div>
            <div style="display: flex; gap: 8px;">
              ${isAdmin ? `<button onclick="openGoalCalculator()" style="padding: 8px 14px; font-size: 12px; font-weight: 600; background: ${C.white}; color: ${C.primary}; border: 1px solid ${C.gray200}; border-radius: 8px; cursor: pointer;">ğŸ§® ê³„ì‚°ê¸°</button>` : ''}
            </div>
          </div>

          <!-- ì—°ë„ë³„ ëª©í‘œ ëŒ€ì‹œë³´ë“œ -->
          ${renderYearlyGoalsDashboard()}

          <!-- í•µì‹¬ í˜„í™© ë°°ë„ˆ -->
          <div style="background: linear-gradient(135deg, ${C.primary}, #1b64da); border-radius: 14px; padding: 16px 20px; margin-bottom: 16px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div><div style="font-size: 11px; opacity: 0.85;">ê³µêµ¬</div><div style="font-size: 20px; font-weight: 700;">${yearDeals.length}<span style="font-size: 13px; opacity: 0.8;">/${T.requiredTotalDeals}</span></div></div>
                <div><div style="font-size: 11px; opacity: 0.85;">ì„±ê³µ</div><div style="font-size: 20px; font-weight: 700;">${successfulDeals.length}<span style="font-size: 13px; opacity: 0.8;">/${T.targetSuccessDeals}</span></div></div>
                <div><div style="font-size: 11px; opacity: 0.85;">ë§¤ì¶œ</div><div style="font-size: 20px; font-weight: 700;">${(totalSalesAmount / 100000000).toFixed(1)}<span style="font-size: 13px; opacity: 0.8;">/${(T.annualRevenue / 100000000)}ì–µ</span></div></div>
                <div><div style="font-size: 11px; opacity: 0.85;">ì„±ê³µë¥ </div><div style="font-size: 20px; font-weight: 700;">${currentSuccessRate}%</div></div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 11px; opacity: 0.8;">ë‚¨ì€ ê¸°ê°„</div>
                <div style="font-size: 18px; font-weight: 700;">${remainingMonths}ê°œì›” ${remainingDays % 30}ì¼</div>
              </div>
            </div>
          </div>

          <!-- KPI ì¹´ë“œ -->
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 16px;">
            <div style="background: ${C.white}; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <div style="font-size: 11px; color: ${C.gray500}; margin-bottom: 6px;">ì—° ë§¤ì¶œ</div>
              <div style="font-size: 20px; font-weight: 700; color: ${C.black};">${(totalSalesAmount / 100000000).toFixed(2)}ì–µ</div>
              <div style="background: ${C.gray100}; height: 4px; border-radius: 2px; margin-top: 8px;"><div style="background: ${getProgressColor(revenueProgress)}; height: 100%; width: ${revenueProgress}%; border-radius: 2px;"></div></div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <div style="font-size: 11px; color: ${C.gray500}; margin-bottom: 6px;">ì—° ìˆœìµ</div>
              <div style="font-size: 20px; font-weight: 700; color: ${totalProfitAmount >= 0 ? C.green : C.red};">${formatNumber(totalProfitAmount)}ì›</div>
              <div style="display: flex; justify-content: space-between; font-size: 9px; color: ${C.gray400}; margin-top: 4px;">
                <span>ìì‚¬ ${formatNumber(inhouseProfitAmt)}ì›</span>
                <span>íƒ€ì‚¬ ${formatNumber(externalProfitAmt)}ì›</span>
              </div>
            </div>
            <div style="background: ${weeklyProgress >= 100 ? C.greenLight : C.blueLight}; border-radius: 12px; padding: 14px;">
              <div style="font-size: 11px; color: ${C.gray600}; margin-bottom: 6px;">ğŸ“… ì´ë²ˆ ì£¼</div>
              <div style="font-size: 20px; font-weight: 700; color: ${weeklyProgress >= 100 ? C.green : C.blue};">${thisWeekDeals.length}<span style="font-size: 12px; color: ${C.gray500};">/${weeklyTargetDeals}</span></div>
              <div style="font-size: 10px; color: ${C.gray600}; margin-top: 4px;">${weeklyProgress >= 100 ? 'âœ… ë‹¬ì„±' : `${Math.max(weeklyTargetDeals - thisWeekDeals.length, 0)}ê±´ í•„ìš”`}</div>
            </div>
            <div style="background: ${monthlyProgress >= 100 ? C.greenLight : C.gray50}; border-radius: 12px; padding: 14px;">
              <div style="font-size: 11px; color: ${C.gray600}; margin-bottom: 6px;">ğŸ“† ì´ë²ˆ ë‹¬</div>
              <div style="font-size: 20px; font-weight: 700; color: ${monthlyProgress >= 100 ? C.green : C.black};">${monthDeals.length}<span style="font-size: 12px; color: ${C.gray500};">/${monthlyTargetDeals}</span></div>
              <div style="font-size: 10px; color: ${C.gray600}; margin-top: 4px;">${monthlyProgress >= 100 ? 'âœ… ë‹¬ì„±' : `${Math.max(monthlyTargetDeals - monthDeals.length, 0)}ê±´ í•„ìš”`}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <div style="font-size: 11px; color: ${C.gray500}; margin-bottom: 6px;">ë‚¨ì€ ê³µêµ¬</div>
              <div style="font-size: 20px; font-weight: 700; color: ${C.black};">${remainingTotalDeals}ê±´</div>
              <div style="font-size: 10px; color: ${C.gray500}; margin-top: 4px;">ì£¼ ${weeklyNeededDeals} / ì›” ${monthlyNeededDeals}</div>
            </div>
            <div style="background: ${commission30Ratio >= T.commission30Ratio ? C.greenLight : C.white}; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <div style="font-size: 11px; color: ${C.gray500}; margin-bottom: 6px;">30% ìˆ˜ìˆ˜ë£Œ</div>
              <div style="font-size: 20px; font-weight: 700; color: ${commission30Ratio >= T.commission30Ratio ? C.green : C.yellow};">${commission30Ratio}%</div>
              <div style="font-size: 10px; color: ${C.gray500}; margin-top: 4px;">ëª©í‘œ ${T.commission30Ratio}%</div>
            </div>
          </div>

          <!-- íŒ€ì›ë³„ ì˜ì—… ì„±ê³¼ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.black};">ğŸ‘¥ íŒ€ì›ë³„ ì˜ì—… ì„±ê³¼ (${currentYear}ë…„)</div>
              <div style="font-size: 12px; color: ${C.gray400};">ì „ì²´ ê³µê¸‰ì‚¬ ${state.suppliers?.length || 0}ê°œ Â· ì…€ëŸ¬ ${state.sellers?.length || 0}ëª…</div>
            </div>

            ${memberStats.length === 0 ? `
              <div style="text-align: center; padding: 40px; color: ${C.gray500};">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            ` : `
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead>
                    <tr style="background: ${C.gray50}; border-bottom: 2px solid ${C.gray200};">
                      <th style="padding: 14px 12px; text-align: left; font-weight: 600; color: ${C.gray700};">íŒ€ì›</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ê³µê¸‰ì‚¬</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì…€ëŸ¬</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì—° ê³µêµ¬</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì´ë²ˆë‹¬</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì„±ê³µ</th>
                      <th style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.gray700};">ì„±ê³µë¥ </th>
                      <th style="padding: 14px 12px; text-align: right; font-weight: 600; color: ${C.gray700};">ë§¤ì¶œ</th>
                      <th style="padding: 14px 12px; text-align: right; font-weight: 600; color: ${C.gray700};">ìˆœìµ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${memberStats.map(m => {
                      const rateColor = m.successRate >= 30 ? C.green : m.successRate >= 20 ? C.yellow : C.red;
                      const rateBg = m.successRate >= 30 ? C.greenLight : m.successRate >= 20 ? C.yellowLight : C.redLight;
                      return `
                        <tr style="border-bottom: 1px solid ${C.gray100};">
                          <td style="padding: 14px 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, ${C.primary}, #3B82F6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px;">
                                ${(m.name || m.id || '?').charAt(0)}
                              </div>
                              <div>
                                <div style="font-weight: 600; color: ${C.black};">${m.name || m.id}</div>
                                <div style="font-size: 11px; color: ${C.gray400};">${m.role === 'admin' ? 'ê´€ë¦¬ì' : m.role === 'manager' ? 'ë§¤ë‹ˆì €' : 'íŒ€ì›'}</div>
                              </div>
                            </div>
                          </td>
                          <td style="padding: 14px 12px; text-align: center; font-weight: 500;">${m.suppliers}</td>
                          <td style="padding: 14px 12px; text-align: center; font-weight: 500;">${m.sellers}</td>
                          <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: ${C.black};">${m.yearDeals}</td>
                          <td style="padding: 14px 12px; text-align: center; color: ${C.blue}; font-weight: 600;">${m.monthDeals}</td>
                          <td style="padding: 14px 12px; text-align: center; color: ${C.green}; font-weight: 600;">${m.successDeals}</td>
                          <td style="padding: 14px 12px; text-align: center;">
                            <span style="background: ${rateBg}; color: ${rateColor}; padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 12px;">${m.successRate}%</span>
                          </td>
                          <td style="padding: 14px 12px; text-align: right; font-weight: 500; color: ${C.gray700};">${formatNumber(m.sales)}ì›</td>
                          <td style="padding: 14px 12px; text-align: right; font-weight: 600; color: ${C.green};">${formatNumber(m.profit)}ì›</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                  <tfoot>
                    <tr style="background: ${C.gray50}; border-top: 2px solid ${C.gray200};">
                      <td style="padding: 14px 12px; font-weight: 700; color: ${C.black};">í•©ê³„</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700;">${state.suppliers?.length || 0}</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700;">${state.sellers?.length || 0}</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700;">${yearDeals.length}</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: ${C.blue};">${monthDeals.length}</td>
                      <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: ${C.green};">${successfulDeals.length}</td>
                      <td style="padding: 14px 12px; text-align: center;">
                        <span style="background: ${currentSuccessRate >= 30 ? C.greenLight : currentSuccessRate >= 20 ? C.yellowLight : C.redLight}; color: ${currentSuccessRate >= 30 ? C.green : currentSuccessRate >= 20 ? C.yellow : C.red}; padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 12px;">${currentSuccessRate}%</span>
                      </td>
                      <td style="padding: 14px 12px; text-align: right; font-weight: 700; color: ${C.gray900};">${formatNumber(totalSalesAmount)}ì›</td>
                      <td style="padding: 14px 12px; text-align: right; font-weight: 700; color: ${C.green};">${formatNumber(totalProfitAmount)}ì›</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            `}
          </div>

          <!-- TOP ì„±ê³¼ ë­í‚¹ -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <!-- ê³µê¸‰ì‚¬ TOP -->
            <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 15px; font-weight: 700; color: ${C.black};">ğŸ­ ê³µê¸‰ì‚¬ íŒë§¤ TOP</div>
              </div>
              ${topSuppliers.length === 0 ? `
                <div style="text-align: center; padding: 24px; color: ${C.gray400}; font-size: 13px;">ë°ì´í„° ì—†ìŒ</div>
              ` : topSuppliers.map((s, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; ${i < topSuppliers.length - 1 ? `border-bottom: 1px solid ${C.gray100};` : ''}">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: ${i < 3 ? C.primary : C.gray200}; color: ${i < 3 ? 'white' : C.gray600}; border-radius: 50%; font-size: 11px; font-weight: 700;">${i + 1}</span>
                    <span style="font-size: 13px; color: ${C.gray700};">${s.name}</span>
                  </div>
                  <span style="font-size: 12px; font-weight: 600; color: ${C.gray600};">${formatNumber(s.sales)}ì›</span>
                </div>
              `).join('')}
            </div>

            <!-- ì…€ëŸ¬ TOP -->
            <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 15px; font-weight: 700; color: ${C.black};">ğŸ‘¤ ì…€ëŸ¬ íŒë§¤ TOP</div>
              </div>
              ${topSellers.length === 0 ? `
                <div style="text-align: center; padding: 24px; color: ${C.gray400}; font-size: 13px;">ë°ì´í„° ì—†ìŒ</div>
              ` : topSellers.map((s, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; ${i < topSellers.length - 1 ? `border-bottom: 1px solid ${C.gray100};` : ''}">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: ${i < 3 ? C.green : C.gray200}; color: ${i < 3 ? 'white' : C.gray600}; border-radius: 50%; font-size: 11px; font-weight: 700;">${i + 1}</span>
                    <span style="font-size: 13px; color: ${C.gray700};">${s.name}</span>
                  </div>
                  <span style="font-size: 12px; font-weight: 600; color: ${C.gray600};">${formatNumber(s.sales)}ì›</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- ğŸ“‹ ì˜¨ë³´ë”© ì§„ì²™ë„ -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 20px;">
            <!-- ì…€ëŸ¬ ì˜¨ë³´ë”© ì§„ì²™ë„ -->
            <div style="background: ${C.white}; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 15px; font-weight: 700; color: #B45309;">ğŸ¤ ì…€ëŸ¬ ì˜¨ë³´ë”© ì§„ì²™ë„</div>
                <span style="font-size: 20px; font-weight: 800; color: ${sellerOnboardingProgress >= 70 ? C.green : sellerOnboardingProgress >= 40 ? C.yellow : C.red};">${sellerOnboardingProgress}%</span>
              </div>
              <div style="background: ${C.gray100}; border-radius: 8px; height: 8px; margin-bottom: 16px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #F59E0B, #D97706); height: 100%; width: ${sellerOnboardingProgress}%; border-radius: 8px; transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 12px;">ì˜¨ë³´ë”© ì§„í–‰ ì¤‘: <strong style="color: #B45309;">${sellerOnboardingStats.total}ê±´</strong></div>
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 11px;">
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obContact > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“</div>
                  <div style="color: ${C.gray600};">ì»¨íƒ</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obContact}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obGuide > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“˜</div>
                  <div style="color: ${C.gray600};">ê°€ì´ë“œ</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obGuide}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obForm > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“„</div>
                  <div style="color: ${C.gray600};">ì‹ ì²­ì„œ</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obForm}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obBank > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ¦</div>
                  <div style="color: ${C.gray600};">ê³„ì¢Œ</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obBank}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${sellerOnboardingStats.obIdCard > 0 ? '#FEF3C7' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸªª</div>
                  <div style="color: ${C.gray600};">ì‹ ë¶„ì¦</div>
                  <div style="font-weight: 700; color: #B45309;">${sellerOnboardingStats.obIdCard}</div>
                </div>
              </div>
            </div>

            <!-- ê³µê¸‰ì‚¬ ì˜¨ë³´ë”© ì§„ì²™ë„ -->
            <div style="background: ${C.white}; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 15px; font-weight: 700; color: #4338CA;">ğŸ¤ ê³µê¸‰ì‚¬ ì˜¨ë³´ë”© ì§„ì²™ë„</div>
                <span style="font-size: 20px; font-weight: 800; color: ${supplierOnboardingProgress >= 70 ? C.green : supplierOnboardingProgress >= 40 ? C.yellow : C.red};">${supplierOnboardingProgress}%</span>
              </div>
              <div style="background: ${C.gray100}; border-radius: 8px; height: 8px; margin-bottom: 16px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #6366F1, #4338CA); height: 100%; width: ${supplierOnboardingProgress}%; border-radius: 8px; transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 12px;">ì˜¨ë³´ë”© ì§„í–‰ ì¤‘: <strong style="color: #4338CA;">${supplierOnboardingStats.total}ê±´</strong></div>
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 11px;">
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obContact > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“</div>
                  <div style="color: ${C.gray600};">ì»¨íƒ</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obContact}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obGuide > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“˜</div>
                  <div style="color: ${C.gray600};">ê°€ì´ë“œ</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obGuide}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obProductInfo > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ“¦</div>
                  <div style="color: ${C.gray600};">ìƒí’ˆì •ë³´</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obProductInfo}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obBizLicense > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ¢</div>
                  <div style="color: ${C.gray600};">ì‚¬ì—…ì</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obBizLicense}</div>
                </div>
                <div style="text-align: center; padding: 8px 4px; background: ${supplierOnboardingStats.obBank > 0 ? '#EEF2FF' : C.gray50}; border-radius: 8px;">
                  <div style="font-size: 16px; margin-bottom: 4px;">ğŸ¦</div>
                  <div style="color: ${C.gray600};">í†µì¥</div>
                  <div style="font-weight: 700; color: #4338CA;">${supplierOnboardingStats.obBank}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ğŸ“Š íŒ€ì›ë³„ íŒŒì´í”„ë¼ì¸ ì„±ê³¼ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.black};">ğŸ“Š íŒ€ì›ë³„ íŒŒì´í”„ë¼ì¸ ì„±ê³¼</div>
            </div>

            ${memberStats.length === 0 ? `
              <div style="text-align: center; padding: 40px; color: ${C.gray500};">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            ` : `
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                  <thead>
                    <tr style="background: linear-gradient(135deg, #EEF2FF, #FEF3C7);">
                      <th rowspan="2" style="padding: 10px 8px; text-align: left; font-weight: 600; color: ${C.gray700}; border-bottom: 2px solid ${C.gray200};">íŒ€ì›</th>
                      <th colspan="4" style="padding: 8px; text-align: center; font-weight: 700; color: #B45309; border-bottom: 1px solid #FCD34D; background: #FEF3C7;">
                        ğŸ‘¤ ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸
                      </th>
                      <th colspan="4" style="padding: 8px; text-align: center; font-weight: 700; color: #4338CA; border-bottom: 1px solid #C7D2FE; background: #EEF2FF;">
                        ğŸ“¦ ìƒí’ˆ íŒŒì´í”„ë¼ì¸
                      </th>
                    </tr>
                    <tr style="background: ${C.gray50};">
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ë¦¬ìŠ¤íŠ¸ì—…</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ì œì•ˆ</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ì˜¨ë³´ë”©</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: #B45309; border-bottom: 2px solid ${C.gray200};">ê³„ì•½</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ë¦¬ìŠ¤íŠ¸ì—…</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ì œì•ˆ</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: ${C.gray600}; border-bottom: 2px solid ${C.gray200};">ì˜¨ë³´ë”©</th>
                      <th style="padding: 8px 6px; text-align: center; font-weight: 500; color: #4338CA; border-bottom: 2px solid ${C.gray200};">ê³„ì•½</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${memberStats.map(m => `
                      <tr style="border-bottom: 1px solid ${C.gray100};">
                        <td style="padding: 12px 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, ${C.primary}, #3B82F6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">
                              ${(m.name || m.id || '?').charAt(0)}
                            </div>
                            <span style="font-weight: 600; color: ${C.black};">${m.name || m.id}</span>
                          </div>
                        </td>
                        <td style="padding: 8px 6px; text-align: center; font-weight: 600;">${m.sellerPipeline.total}</td>
                        <td style="padding: 8px 6px; text-align: center; color: ${m.sellerPipeline.proposed > 0 ? C.green : C.gray400};">${m.sellerPipeline.proposed}</td>
                        <td style="padding: 8px 6px; text-align: center; color: ${m.sellerPipeline.onboarding > 0 ? C.blue : C.gray400};">${m.sellerPipeline.onboarding}</td>
                        <td style="padding: 8px 6px; text-align: center;"><span style="background: ${m.sellerPipeline.contracted > 0 ? '#FEF3C7' : C.gray100}; color: ${m.sellerPipeline.contracted > 0 ? '#B45309' : C.gray400}; padding: 2px 8px; border-radius: 10px; font-weight: 700;">${m.sellerPipeline.contracted}</span></td>
                        <td style="padding: 8px 6px; text-align: center; font-weight: 600;">${m.supplierPipeline.total}</td>
                        <td style="padding: 8px 6px; text-align: center; color: ${m.supplierPipeline.proposed > 0 ? C.green : C.gray400};">${m.supplierPipeline.proposed}</td>
                        <td style="padding: 8px 6px; text-align: center; color: ${m.supplierPipeline.onboarding > 0 ? C.blue : C.gray400};">${m.supplierPipeline.onboarding}</td>
                        <td style="padding: 8px 6px; text-align: center;"><span style="background: ${m.supplierPipeline.contracted > 0 ? '#EEF2FF' : C.gray100}; color: ${m.supplierPipeline.contracted > 0 ? '#4338CA' : C.gray400}; padding: 2px 8px; border-radius: 10px; font-weight: 700;">${m.supplierPipeline.contracted}</span></td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    <tr style="background: ${C.gray50}; border-top: 2px solid ${C.gray200};">
                      <td style="padding: 12px 8px; font-weight: 700;">í•©ê³„</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700;">${memberStats.reduce((sum, m) => sum + m.sellerPipeline.total, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${C.green};">${memberStats.reduce((sum, m) => sum + m.sellerPipeline.proposed, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${C.blue};">${memberStats.reduce((sum, m) => sum + m.sellerPipeline.onboarding, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: #B45309;">${memberStats.reduce((sum, m) => sum + m.sellerPipeline.contracted, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700;">${memberStats.reduce((sum, m) => sum + m.supplierPipeline.total, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${C.green};">${memberStats.reduce((sum, m) => sum + m.supplierPipeline.proposed, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${C.blue};">${memberStats.reduce((sum, m) => sum + m.supplierPipeline.onboarding, 0)}</td>
                      <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: #4338CA;">${memberStats.reduce((sum, m) => sum + m.supplierPipeline.contracted, 0)}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function openGoalCalculator() {
      const currentYear = new Date().getFullYear();
      const goals = state.yearlyGoals || [];
      const currentGoal = goals.find(g => g.year === currentYear) || { revenueTarget: 1000000000 };
      const annualTarget = currentGoal.revenueTarget || 1000000000;

      // ì €ì¥ëœ ê³„ì‚°ê¸° ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
      const saved = state.strategyData || {};
      const defaultAvgDeal = saved.avgDealRevenue || 4630000;
      const defaultSuccessRate = saved.successRate || 30;
      const defaultAvgProfit = saved.avgDealProfit || 200000;

      // í˜„ì¬ ì§„í–‰ ìƒí™©
      const thisYearStr = String(currentYear);
      const yearDeals = (state.deals || []).filter(d => (d.startDate || d.createdAt || '').startsWith(thisYearStr));
      const successDeals = yearDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');
      const yearSettlements = (state.sellerSettlements || []).filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
      const currentRevenue = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);

      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), #1b64da); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ§® ê³µêµ¬ì„¤ê³„ ê³„ì‚°ê¸°</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; max-height: 75vh; overflow-y: auto;">

            <!-- ì—°ë„ë³„ ëª©í‘œ ì—°ë™ í‘œì‹œ -->
            <div style="background: linear-gradient(135deg, #1e3a5f, #0f2744); border-radius: 12px; padding: 16px; margin-bottom: 20px; color: white;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <div>
                  <div style="font-size: 12px; opacity: 0.8;">ğŸ“… ${currentYear}ë…„ ëª©í‘œ (ì—°ë„ë³„ ëª©í‘œì—ì„œ ì—°ë™)</div>
                  <div style="font-size: 28px; font-weight: 700;">${(annualTarget / 100000000).toFixed(0)}ì–µì›</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; opacity: 0.8;">í˜„ì¬ ë‹¬ì„±</div>
                  <div style="font-size: 20px; font-weight: 600;">${(currentRevenue / 100000000).toFixed(2)}ì–µ <span style="font-size: 14px; opacity: 0.8;">(${Math.round(currentRevenue / annualTarget * 100)}%)</span></div>
                </div>
              </div>
              <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; margin-top: 12px; overflow: hidden;">
                <div style="background: ${currentRevenue >= annualTarget ? '#00C471' : '#F59E0B'}; height: 100%; width: ${Math.min(100, currentRevenue / annualTarget * 100)}%;"></div>
              </div>
            </div>

            <!-- ì‹œë®¬ë ˆì´ì…˜ ì…ë ¥ -->
            <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 16px; font-size: 15px;">âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                <div>
                  <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px;">ê³µêµ¬ë‹¹ í‰ê·  íŒë§¤ì•¡</label>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <input type="number" id="calcAvgDeal" value="${defaultAvgDeal / 10000}"
                      oninput="updateGoalCalculation()"
                      style="flex: 1; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                    <span style="font-size: 14px; color: var(--gray-600);">ë§Œì›</span>
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px;">ëª©í‘œ ì„±ê³µë¥ </label>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <input type="number" id="calcSuccessRate" value="${defaultSuccessRate}" min="1" max="100"
                      oninput="updateGoalCalculation()"
                      style="flex: 1; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                    <span style="font-size: 14px; color: var(--gray-600);">%</span>
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px;">ê³µêµ¬ë‹¹ í‰ê·  ìˆœìµ</label>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <input type="number" id="calcAvgProfit" value="${defaultAvgProfit / 10000}"
                      oninput="updateGoalCalculation()"
                      style="flex: 1; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                    <span style="font-size: 14px; color: var(--gray-600);">ë§Œì›</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- ê³„ì‚° ê²°ê³¼ -->
            <div id="calcResultArea">
              <!-- updateGoalCalculation()ì—ì„œ ë™ì  ë Œë”ë§ -->
            </div>

            <!-- í˜„ì¬ ì§„í–‰ ìƒí™© ë¹„êµ -->
            <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-top: 20px;">
              <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 16px; font-size: 15px;">ğŸ“Š í˜„ì¬ ì§„í–‰ ìƒí™©</div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                <div style="background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--gray-200);">
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">ì§„í–‰ ê³µêµ¬</div>
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${yearDeals.length}</div>
                </div>
                <div style="background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--gray-200);">
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">ì„±ê³µ ê³µêµ¬</div>
                  <div style="font-size: 24px; font-weight: 700; color: #00C471;">${successDeals.length}</div>
                </div>
                <div style="background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--gray-200);">
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">í˜„ì¬ ì„±ê³µë¥ </div>
                  <div style="font-size: 24px; font-weight: 700; color: #F59E0B;">${yearDeals.length > 0 ? Math.round(successDeals.length / yearDeals.length * 100) : 0}%</div>
                </div>
                <div style="background: white; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--gray-200);">
                  <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px;">ë‹¬ì„± ë§¤ì¶œ</div>
                  <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">${(currentRevenue / 100000000).toFixed(1)}ì–µ</div>
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer" style="border-top: 1px solid var(--gray-200); padding: 16px 20px; display: flex; justify-content: space-between;">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            <button class="btn btn-primary" onclick="saveCalculatorSettings()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
          </div>
        </div>
      `;

      // ì´ˆê¸° ê³„ì‚° ì‹¤í–‰
      updateGoalCalculation();
    }

    function updateGoalCalculation() {
      const currentYear = new Date().getFullYear();
      const goals = state.yearlyGoals || [];
      const currentGoal = goals.find(g => g.year === currentYear) || { revenueTarget: 1000000000 };
      const annualTarget = currentGoal.revenueTarget || 1000000000;

      const avgDeal = (parseFloat(document.getElementById('calcAvgDeal')?.value) || 463) * 10000;
      const successRate = parseFloat(document.getElementById('calcSuccessRate')?.value) || 30;
      const avgProfit = (parseFloat(document.getElementById('calcAvgProfit')?.value) || 20) * 10000;

      // ê³„ì‚°
      const requiredSuccessDeals = Math.ceil(annualTarget / avgDeal);
      const requiredTotalDeals = Math.ceil(requiredSuccessDeals / (successRate / 100));
      const monthlyDeals = Math.ceil(requiredTotalDeals / 12);
      const weeklyDeals = Math.ceil(requiredTotalDeals / 52);
      const monthlySuccess = Math.ceil(requiredSuccessDeals / 12);
      const expectedProfit = requiredSuccessDeals * avgProfit;

      // ë‚¨ì€ ê¸°ê°„ ê³„ì‚°
      const now = new Date();
      const yearEnd = new Date(currentYear, 11, 31);
      const remainingDays = Math.ceil((yearEnd - now) / (1000 * 60 * 60 * 24));
      const remainingWeeks = Math.ceil(remainingDays / 7);
      const remainingMonths = 12 - now.getMonth();

      // í˜„ì¬ ì§„í–‰ ìƒí™©
      const thisYearStr = String(currentYear);
      const yearDeals = (state.deals || []).filter(d => (d.startDate || d.createdAt || '').startsWith(thisYearStr));
      const successDeals = yearDeals.filter(d => d.isSuccess === true || d.ë‹¬ì„±ì—¬ë¶€ === 'ì„±ê³µ');
      const yearSettlements = (state.sellerSettlements || []).filter(s => (s.settlementDate || s.createdAt || '').startsWith(thisYearStr));
      const currentRevenue = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);

      // ë‚¨ì€ ëª©í‘œ ê³„ì‚°
      const remainingRevenue = Math.max(0, annualTarget - currentRevenue);
      const remainingSuccessDeals = Math.max(0, requiredSuccessDeals - successDeals.length);
      const remainingTotalDeals = Math.ceil(remainingSuccessDeals / (successRate / 100));
      const neededWeeklyDeals = Math.ceil(remainingTotalDeals / Math.max(remainingWeeks, 1));
      const neededMonthlyDeals = Math.ceil(remainingTotalDeals / Math.max(remainingMonths, 1));

      // ë‹¬ì„± ê°€ëŠ¥ì„± íŒë‹¨
      const isOnTrack = neededWeeklyDeals <= weeklyDeals * 1.5;
      const statusColor = isOnTrack ? '#00C471' : '#F04452';
      const statusBg = isOnTrack ? '#E8F8F0' : '#FEE2E4';
      const statusText = isOnTrack ? 'ë‹¬ì„± ê°€ëŠ¥' : 'âš ï¸ ì£¼ì˜ í•„ìš”';

      const container = document.getElementById('calcResultArea');
      if (!container) return;

      container.innerHTML = `
        <!-- ëª©í‘œ ë‹¬ì„± ê°€ì´ë“œ -->
        <div style="background: linear-gradient(135deg, var(--primary), #1b64da); border-radius: 16px; padding: 24px; color: white; margin-bottom: 20px;">
          <div style="font-weight: 700; margin-bottom: 16px; font-size: 15px;">ğŸ“Š ëª©í‘œ ë‹¬ì„± ê°€ì´ë“œ</div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 16px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;">${requiredTotalDeals}</div>
              <div style="font-size: 11px; opacity: 0.8;">ì—° í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 16px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;">${monthlyDeals}</div>
              <div style="font-size: 11px; opacity: 0.8;">ì›” í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 16px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;">${weeklyDeals}</div>
              <div style="font-size: 11px; opacity: 0.8;">ì£¼ í•„ìš” ê³µêµ¬</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 16px; text-align: center;">
              <div style="font-size: 28px; font-weight: 700;">${requiredSuccessDeals}</div>
              <div style="font-size: 11px; opacity: 0.8;">ì—° ì„±ê³µ ëª©í‘œ</div>
            </div>
          </div>
        </div>

        <!-- ì„±ê³µ ê³µì‹ -->
        <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="font-weight: 700; color: #2E7D32; margin-bottom: 8px;">âœ… ì„±ê³µ ê³µì‹</div>
          <div style="font-size: 13px; color: #388E3C; line-height: 1.8;">
            <strong>ê³„ì‚°:</strong> ${(annualTarget/100000000).toFixed(0)}ì–µ Ã· ${(avgDeal/10000).toFixed(0)}ë§Œì› = <strong>${requiredSuccessDeals}ê±´</strong> ì„±ê³µ í•„ìš”<br>
            <strong>ì‹¤íŒ¨ìœ¨ ê³ ë ¤:</strong> ${requiredSuccessDeals}ê±´ Ã· ${successRate}% = <strong>${requiredTotalDeals}ê±´</strong> ì´ ì§„í–‰ í•„ìš”<br>
            <strong>ì›”ë³„:</strong> ${monthlyDeals}ê±´ ì§„í–‰ Ã— ${successRate}% = ì›” ${monthlySuccess}ê±´ ì„±ê³µ<br>
            <strong>ì˜ˆìƒ ìˆœìµ:</strong> ${requiredSuccessDeals}ê±´ Ã— ${(avgProfit/10000).toFixed(0)}ë§Œì› = <strong>${(expectedProfit/100000000).toFixed(1)}ì–µì›</strong>
          </div>
        </div>

        <!-- ë‚¨ì€ ëª©í‘œ & ê²½ê³  -->
        <div style="background: ${statusBg}; border: 2px solid ${statusColor}; border-radius: 12px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-weight: 700; color: ${statusColor};">ğŸ“… ë‚¨ì€ ëª©í‘œ (${remainingMonths}ê°œì›” ${remainingDays % 30}ì¼)</div>
            <div style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${statusText}</div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: var(--gray-500);">ë‚¨ì€ ë§¤ì¶œ</div>
              <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${(remainingRevenue/100000000).toFixed(1)}ì–µ</div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: var(--gray-500);">ë‚¨ì€ ì„±ê³µ</div>
              <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${remainingSuccessDeals}ê±´</div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: var(--gray-500);">ì£¼ë‹¹ í•„ìš”</div>
              <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${neededWeeklyDeals}ê±´</div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: var(--gray-500);">ì›”ë‹¹ í•„ìš”</div>
              <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${neededMonthlyDeals}ê±´</div>
            </div>
          </div>
          ${!isOnTrack ? `
            <div style="background: #F04452; color: white; border-radius: 8px; padding: 12px; margin-top: 12px; font-size: 13px;">
              <strong>âš ï¸ ê²½ê³ :</strong> í˜„ì¬ ì†ë„ë¡œëŠ” ëª©í‘œ ë‹¬ì„±ì´ ì–´ë µìŠµë‹ˆë‹¤.
              ì£¼ë‹¹ ${neededWeeklyDeals}ê±´ í•„ìš” (ê¸°ì¡´ ëª©í‘œ ${weeklyDeals}ê±´ ëŒ€ë¹„ ${Math.round((neededWeeklyDeals/weeklyDeals - 1) * 100)}% ì¦ê°€ í•„ìš”)
            </div>
          ` : ''}
        </div>
      `;
    }

    async function saveCalculatorSettings() {
      try {
        const avgDeal = (parseFloat(document.getElementById('calcAvgDeal')?.value) || 463) * 10000;
        const successRate = parseFloat(document.getElementById('calcSuccessRate')?.value) || 30;
        const avgProfit = (parseFloat(document.getElementById('calcAvgProfit')?.value) || 20) * 10000;

        const currentYear = new Date().getFullYear();
        const goals = state.yearlyGoals || [];
        const currentGoal = goals.find(g => g.year === currentYear) || { revenueTarget: 1000000000 };
        const annualTarget = currentGoal.revenueTarget || 1000000000;

        const requiredSuccessDeals = Math.ceil(annualTarget / avgDeal);
        const requiredTotalDeals = Math.ceil(requiredSuccessDeals / (successRate / 100));

        const settings = {
          avgDealRevenue: avgDeal,
          avgDealProfit: avgProfit,
          successRate: successRate,
          annualRevenue: annualTarget,
          annualProfit: requiredSuccessDeals * avgProfit,
          targetSuccessDeals: requiredSuccessDeals,
          monthlySuccessDeals: Math.ceil(requiredSuccessDeals / 12),
          requiredTotalDeals: requiredTotalDeals,
          monthlyRequiredDeals: Math.ceil(requiredTotalDeals / 12),
          weeklyRequiredDeals: Math.ceil(requiredTotalDeals / 52),
          updatedAt: new Date().toISOString()
        };

        await db.collection('settings').doc('strategy').set(settings, { merge: true });
        state.strategyData = { ...state.strategyData, ...settings };

        showToast('ê³„ì‚°ê¸° ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();

        // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
        if (state.currentTab === 'dashboard') {
          renderSalesDashboard();
        }
      } catch (e) {
        console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ========================================
    // ì—…ë¬´ê°€ì´ë“œ ì‹œìŠ¤í…œ
    // ========================================
    let guideTab = 'essence';

    function renderGuide() {
      const container = document.getElementById('guideContent');
      if (!container) return;

      container.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="background: linear-gradient(135deg, var(--primary), #e08600); color: white; padding: 28px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 16px rgba(49, 130, 246, 0.2);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="font-size: 36px;">ğŸ“š</div>
              <div>
                <div style="font-size: 24px; font-weight: 700;">ëª¨ì—¬ë¼ë”œ ì—…ë¬´ ê°€ì´ë“œ</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">ì‹ ê·œ íŒ€ì›ì„ ìœ„í•œ ìƒì„¸ ê°€ì´ë“œ - ë³¸ì§ˆë¶€í„° ì‹¤ë¬´ê¹Œì§€</div>
              </div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 14px; margin-top: 12px;">
              <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px;">ğŸ’¡ ëª¨ì—¬ë¼ë”œ í•µì‹¬ ì •ì˜</div>
              <div style="font-size: 15px; line-height: 1.6;">"<strong>ì‚¬ëŒì˜ ì‹ ë¢°</strong>ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼"</div>
            </div>
          </div>

          <!-- íƒ­ ë©”ë‰´ -->
          <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--gray-200); padding-bottom: 8px; flex-wrap: wrap;">
            <button onclick="switchGuideTab('essence')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'essence' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ¯ ë³¸ì§ˆ ë©”ì‹œì§€
            </button>
            <button onclick="switchGuideTab('process')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'process' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ“‹ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤
            </button>
            <button onclick="switchGuideTab('partner')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'partner' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ¤ íŒŒíŠ¸ë„ˆ ì‘ëŒ€
            </button>
            <button onclick="switchGuideTab('menu')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'menu' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ“‘ ë©”ë‰´ ì„¤ëª…
            </button>
            <button onclick="switchGuideTab('feature')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'feature' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              âš™ï¸ ì£¼ìš” ê¸°ëŠ¥
            </button>
            <button onclick="switchGuideTab('pipeline')" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; ${guideTab === 'pipeline' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-600);'}">
              ğŸ“Š íŒŒì´í”„ë¼ì¸
            </button>
          </div>

          <!-- ì»¨í…ì¸  ì˜ì—­ -->
          <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
            ${getGuideContent(guideTab)}
          </div>
        </div>
      `;
    }

    function switchGuideTab(tab) {
      guideTab = tab;
      renderGuide();
    }

    function getGuideContent(tab) {
      switch(tab) {
        case 'essence': return getGuideEssenceContent();
        case 'process': return getGuideProcessContent();
        case 'partner': return getGuidePartnerContent();
        case 'menu': return getGuideMenuContent();
        case 'feature': return getGuideFeatureContent();
        case 'pipeline': return getGuidePipelineContent();
        default: return getGuideEssenceContent();
      }
    }

    function getGuideEssenceContent() {
      return `
        <!-- í•µì‹¬ ê°€ì¹˜ -->
        <div style="text-align: center; padding: 20px 0 30px;">
          <div style="font-size: 28px; font-weight: 700; color: #191F28; margin-bottom: 12px;">ì™œ ëª¨ì—¬ë¼ë”œì¸ê°€?</div>
          <div style="font-size: 16px; color: #6B7684; max-width: 600px; margin: 0 auto; line-height: 1.6;">
            ê´‘ê³  ì‹ ë¢°ë„ëŠ” í•˜ë½í•˜ê³ , 'ì‚¬ëŒ ì¶”ì²œ'ì˜ ê°€ì¹˜ëŠ” ìƒìŠ¹í•©ë‹ˆë‹¤.<br>
            ëª¨ì—¬ë¼ë”œì€ <strong>"ì‹ ë¢° â†’ êµ¬ë§¤"</strong> êµ¬ì¡°ì— ìµœì í™”ëœ í”Œë«í¼ì…ë‹ˆë‹¤.
          </div>
        </div>

        <!-- 3ëŒ€ ê³ ê° ê°€ì¹˜ ì¹´ë“œ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <!-- ê³µê¸‰ì‚¬ -->
          <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border-radius: 16px; padding: 24px; border: 1px solid #C7D2FE;">
            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ­</div>
            <div style="font-size: 18px; font-weight: 700; color: #4338CA; margin-bottom: 8px;">ê³µê¸‰ì‚¬</div>
            <div style="font-size: 13px; color: #6366F1; font-weight: 600; margin-bottom: 16px;">"ì¢‹ì€ ì œí’ˆì´ ë” ë¹ ë¥´ê³  íš¨ìœ¨ì ìœ¼ë¡œ íŒ”ë¦¬ëŠ” êµ¬ì¡°"</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
              âœ“ ì´ˆê¸°ë¹„ìš© <strong>0ì›</strong><br>
              âœ“ í”„ë¦¬ë¯¸ì—„ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬ë¡œ <strong>ë¹ ë¥¸ í™•ì‚°</strong><br>
              âœ“ ì´ë²¤íŠ¸ ê¸°íšÂ·ì‚¬ì€í’ˆÂ·íŒ¨í‚¤ì§•Â·ê²°ì œì°½ <strong>ì¼ê´„ ì§€ì›</strong><br>
              âœ“ <strong>3~7ì¼ ë‚´ ë¹ ë¥¸ ì •ì‚°</strong>, ì¶”ê°€ ê´€ë¦¬ë¹„ ì—†ìŒ<br>
              âœ“ ì½˜í…ì¸  <strong>2ì°¨ ë§ˆì¼€íŒ… í™œìš©</strong> ê°€ëŠ¥
            </div>
          </div>

          <!-- ì…€ëŸ¬ -->
          <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 24px; border: 1px solid #FCD34D;">
            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ‘©â€ğŸ’¼</div>
            <div style="font-size: 18px; font-weight: 700; color: #B45309; margin-bottom: 8px;">ì…€ëŸ¬</div>
            <div style="font-size: 13px; color: #D97706; font-weight: 600; margin-bottom: 16px;">"ì½˜í…ì¸ ëŠ” ì…€ëŸ¬ê°€, êµ¬ì¡°ëŠ” ëª¨ì—¬ë¼ë”œì´"</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
              âœ“ ì´ˆê¸°ë¹„ìš© <strong>0ì›</strong><br>
              âœ“ ê¸°íšÂ·ë””ìì¸Â·ê²°ì œÂ·ì •ì‚°ê¹Œì§€ <strong>í’€ì„œí¬íŠ¸</strong><br>
              âœ“ ì „ì† ê³„ì•½ ê¸°ë°˜ <strong>ìˆ˜ìµ ì•ˆì •ì„±</strong> í™•ë³´<br>
              âœ“ ë¸Œëœë“œ ì§ê±°ë˜/ì •ì‚° <strong>ë¦¬ìŠ¤í¬ ì°¨ë‹¨</strong><br>
              âœ“ ì„±ì¥ ì‹œ ìˆ˜ìˆ˜ë£Œ ìƒìŠ¹, <strong>ë¸Œëœë“œí™”ê¹Œì§€ í™•ì¥</strong>
            </div>
          </div>

          <!-- ì†Œë¹„ì -->
          <div style="background: linear-gradient(135deg, #DCFCE7, #BBF7D0); border-radius: 16px; padding: 24px; border: 1px solid #86EFAC;">
            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ›’</div>
            <div style="font-size: 18px; font-weight: 700; color: #166534; margin-bottom: 8px;">ì†Œë¹„ì</div>
            <div style="font-size: 13px; color: #16A34A; font-weight: 600; margin-bottom: 16px;">"ì‹ ë¢°ë¥¼ ì „ì œë¡œ í•œ ê³µë™êµ¬ë§¤ ê²½í—˜"</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8;">
              âœ“ ê´‘ê³ ê°€ ì•„ë‹Œ, <strong>ì‹¤ì œ ì‚¬ìš© ê¸°ë°˜ ì¶”ì²œ</strong><br>
              âœ“ ê³µì‹ ë¸Œëœë“œ ì—°ë™ìœ¼ë¡œ <strong>ê°€ê²©Â·í’ˆì§ˆ ì‹ ë¢°</strong><br>
              âœ“ <strong>ë³µì¡í•œ ê²½ë¡œ ì—†ëŠ”</strong> ê°„í¸ êµ¬ë§¤<br>
              âœ“ ì…€ëŸ¬ê°€ ì§ì ‘ ì¨ë³´ê³  ì¢‹ì•˜ë˜ ì œí’ˆ<br>
              âœ“ <strong>í•©ë¦¬ì ì¸ ê°€ê²©</strong>ì— ë§Œë‚˜ëŠ” í’ˆì§ˆ
            </div>
          </div>
        </div>

        <!-- ë³¸ì§ˆì  ì°¨ë³„ì  -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 16px;">ğŸ† ëª¨ì—¬ë¼ë”œì˜ ë³¸ì§ˆì  ì°¨ë³„ì  (MOAT)</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
              <div style="width: 40px; height: 40px; background: #E8F3FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ“Š</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28;">ì…€ëŸ¬ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬ & ë¹…ë°ì´í„°</div>
                <div style="font-size: 12px; color: #6B7684;">ì–´ë–¤ ìƒí’ˆì´ ì˜ íŒ”ë¦¬ëŠ”ì§€ ë°ì´í„° ê¸°ë°˜ ë¶„ì„</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
              <div style="width: 40px; height: 40px; background: #FEF3C7; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ“</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28;">ì „ì† ê³„ì•½ ê¸°ë°˜ì˜ ì•ˆì •ì  êµ¬ì¡°</div>
                <div style="font-size: 12px; color: #6B7684;">1ë…„ ì „ì†ê³„ì•½ìœ¼ë¡œ ì§ê±°ë˜ ìœ„í—˜ ì°¨ë‹¨</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
              <div style="width: 40px; height: 40px; background: #DCFCE7; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">âš¡</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28;">í’€ìŠ¤íƒ ìœ í†µ ìš´ì˜</div>
                <div style="font-size: 12px; color: #6B7684;">ì´ë²¤íŠ¸Â·ì •ì‚°Â·ê²°ì œê¹Œì§€ ì›ìŠ¤í†± ì§€ì›</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: 10px;">
              <div style="width: 40px; height: 40px; background: #FCE7F3; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ’</div>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #191F28;">"ì‹ ë¢° â†’ êµ¬ë§¤" êµ¬ì¡°</div>
                <div style="font-size: 12px; color: #6B7684;">ê´‘ê³ â†’ì „í™˜ì´ ì•„ë‹Œ, ì‹ ë¢° ê¸°ë°˜ í”Œë«í¼</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë¹„ì „ -->
        <div style="background: linear-gradient(135deg, var(--primary), #e08600); border-radius: 12px; padding: 24px; color: white; text-align: center;">
          <div style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">ğŸš€ ëª¨ì—¬ë¼ë”œì´ ë§Œë“œëŠ” ë¯¸ë˜</div>
          <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
            <div>
              <div style="font-size: 24px; margin-bottom: 4px;">ğŸ­</div>
              <div style="font-size: 13px; opacity: 0.9;">ë¸Œëœë“œì—ê²ŒëŠ”</div>
              <div style="font-size: 14px; font-weight: 600;">ê°€ì¥ íš¨ìœ¨ì ì¸ ìœ í†µ ì±„ë„</div>
            </div>
            <div>
              <div style="font-size: 24px; margin-bottom: 4px;">ğŸ‘©â€ğŸ’¼</div>
              <div style="font-size: 13px; opacity: 0.9;">ì…€ëŸ¬ì—ê²ŒëŠ”</div>
              <div style="font-size: 14px; font-weight: 600;">ì§€ì† ê°€ëŠ¥í•œ ìˆ˜ìµ ì¸í”„ë¼</div>
            </div>
            <div>
              <div style="font-size: 24px; margin-bottom: 4px;">ğŸ›’</div>
              <div style="font-size: 13px; opacity: 0.9;">ì†Œë¹„ìì—ê²ŒëŠ”</div>
              <div style="font-size: 14px; font-weight: 600;">ê°€ì¥ ë¯¿ì„ ìˆ˜ ìˆëŠ” ì¶”ì²œ ê³µê°„</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuideProcessContent() {
      return `
        <!-- ì „ì²´ íë¦„ -->
        <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--gray-200);">
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-800); margin-bottom: 12px;">ì „ì²´ íë¦„</div>
          <div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; font-size: 12px; font-weight: 600;">
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ìƒí’ˆ ì¤€ë¹„</span>
            <span style="color: var(--gray-400);">â†’</span>
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ì…€ëŸ¬ ì¤€ë¹„</span>
            <span style="color: var(--gray-400);">â†’</span>
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ê³µêµ¬ ë“±ë¡</span>
            <span style="color: var(--gray-400);">â†’</span>
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">íŒë§¤</span>
            <span style="color: var(--gray-400);">â†’</span>
            <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px;">ì •ì‚°</span>
          </div>
        </div>

        <!-- ë‹¨ê³„ë³„ ì„¤ëª… -->
        <div style="display: grid; gap: 12px;">
          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">1</div>
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ìƒí’ˆ ì¤€ë¹„</div>
              <span style="font-size: 11px; color: var(--gray-500); background: var(--gray-100); padding: 2px 8px; border-radius: 4px;">êµ¬ë§¤íŒ€</span>
            </div>
            <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
              <div>â‘  ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê³µê¸‰ì‚¬ ì°¾ê¸°</div>
              <div>â‘¡ ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ</div>
              <div>â‘¢ ìƒí’ˆ DBì— ë“±ë¡</div>
            </div>
          </div>

          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">2</div>
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ì…€ëŸ¬ ì¤€ë¹„</div>
              <span style="font-size: 11px; color: var(--gray-500); background: var(--gray-100); padding: 2px 8px; border-radius: 4px;">ë§ˆì¼€íŒ…íŒ€</span>
            </div>
            <div style="padding-left: 38px;">
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 11px; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-weight: 600;">A. ì‹ ê·œ ì…€ëŸ¬ ë°œêµ´</span>
              </div>
              <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); margin-bottom: 12px; flex-wrap: wrap;">
                <div>â‘  ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¸í”Œë£¨ì–¸ì„œ ì°¾ê¸°</div>
                <div>â‘¡ ì»¨íƒ â†’ ì œì•ˆ â†’ ê³„ì•½</div>
                <div>â‘¢ ì…€ëŸ¬ DBì— ë“±ë¡</div>
              </div>
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 11px; background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-weight: 600;">B. ê¸°ì¡´ ì…€ëŸ¬ì—ê²Œ ì œì•ˆ</span>
              </div>
              <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); flex-wrap: wrap;">
                <div>â‘  ì…€ëŸ¬ DBì—ì„œ ì í•©í•œ ì…€ëŸ¬ ì„ íƒ</div>
                <div>â‘¡ ë§ˆì§„ê³„ì‚°ê¸°ë¡œ ì…€ëŸ¬ ë§ˆì§„ í˜‘ìƒ</div>
                <div>â‘¢ ì…€ëŸ¬ ì œì•ˆì„œ ì „ë‹¬</div>
              </div>
            </div>
          </div>

          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">3</div>
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">ê³µêµ¬ ë“±ë¡</div>
            </div>
            <div style="display: flex; gap: 20px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
              <div>â‘  ê³µêµ¬ ìº˜ë¦°ë”ì—ì„œ ê³µêµ¬ ë“±ë¡</div>
              <div>â‘¡ ì…€ëŸ¬ì—ê²Œ ê³µêµ¬ ê°€ì´ë“œ ì „ë‹¬</div>
              <div>â‘¢ ì…€ëŸ¬ê°€ SNSì— í™ë³´</div>
            </div>
          </div>

          <div style="background: white; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700;">4</div>
              <div style="font-size: 14px; font-weight: 700; color: var(--gray-800);">íŒë§¤ & ì •ì‚°</div>
            </div>
            <div style="display: flex; gap: 16px; font-size: 12px; color: var(--gray-600); padding-left: 38px; flex-wrap: wrap;">
              <div>â‘  ì†Œë¹„ìê°€ ëª¨ì—¬ë¼ë”œì—ì„œ ê²°ì œ</div>
              <div>â‘¡ ê³µê¸‰ì‚¬ì—ê²Œ ë°œì£¼ì„œ ì „ë‹¬</div>
              <div>â‘¢ ê³µê¸‰ì‚¬ê°€ ìƒí’ˆ ë°°ì†¡</div>
              <div>â‘£ ê³µê¸‰ì‚¬ê°€ ì†¡ì¥ ëª¨ì—¬ë¼ë”œì—ê²Œ ì „ë‹¬</div>
              <div>â‘¤ ê³µêµ¬ ì¢…ë£Œ í›„ ì…€ëŸ¬, ê³µê¸‰ì‚¬ì—ê²Œ 3~7ì¼ ë‚´ ì •ì‚°</div>
            </div>
          </div>
        </div>

        <!-- ìˆ˜ìµ êµ¬ì¡° -->
        <div style="background: var(--gray-50); border-radius: 10px; padding: 16px; margin-top: 16px; border: 1px solid var(--gray-200);">
          <div style="font-size: 13px; font-weight: 700; color: var(--gray-800); margin-bottom: 10px;">ìˆ˜ìµ êµ¬ì¡°</div>
          <div style="display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 11px; flex-wrap: wrap;">
            <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
              <div style="font-weight: 600; color: var(--gray-700);">ê³µê¸‰ì‚¬</div>
              <div style="color: var(--gray-500);">ê³µê¸‰ê°€</div>
            </div>
            <span style="color: var(--gray-400);">+</span>
            <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
              <div style="font-weight: 600; color: var(--gray-700);">ì…€ëŸ¬</div>
              <div style="color: var(--gray-500);">ë§ˆì§„(-3.3%)</div>
            </div>
            <span style="color: var(--gray-400);">+</span>
            <div style="text-align: center; padding: 8px 12px; background: white; border-radius: 6px;">
              <div style="font-weight: 600; color: var(--gray-700);">PGì‚¬</div>
              <div style="color: var(--gray-500);">4%</div>
            </div>
            <span style="color: var(--gray-400);">+</span>
            <div style="text-align: center; padding: 8px 12px; background: var(--primary); border-radius: 6px; color: white;">
              <div style="font-weight: 600;">ëª¨ì—¬ë¼ë”œ</div>
              <div style="opacity: 0.9;">ë‚˜ë¨¸ì§€ ì „ë¶€</div>
            </div>
            <span style="color: var(--gray-400);">=</span>
            <div style="text-align: center; padding: 8px 12px; background: var(--gray-900); border-radius: 6px; color: white;">
              <div style="font-weight: 600;">íŒë§¤ê°€</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuidePartnerContent() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 20px;">ğŸ¤ íŒŒíŠ¸ë„ˆ ì‘ëŒ€ ê°€ì´ë“œ</div>

        <!-- ê³µê¸‰ì‚¬ ì‘ëŒ€ -->
        <div style="background: #EEF2FF; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #C7D2FE;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
            <span style="font-size: 24px;">ğŸ­</span>
            <span style="font-size: 16px; font-weight: 700; color: #4338CA;">ê³µê¸‰ì‚¬ ì‘ëŒ€ ì‹œ í•µì‹¬ í¬ì¸íŠ¸</span>
          </div>

          <div style="background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
            <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸ“Œ ì²« ì»¨íƒ ì‹œ ì „ë‹¬í•  ë©”ì‹œì§€</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8; padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 3px solid #4338CA;">
              "ëª¨ì—¬ë¼ë”œì€ ë‹¨ìˆœ ë²¤ë”ì‚¬ê°€ ì•„ë‹ˆë¼,<br>
              <strong>ì œí’ˆì´ ì‹œì¥ì— ë¹ ë¥´ê²Œ ë…¸ì¶œë˜ê³  ì‹¤êµ¬ë§¤ë¡œ ì´ì–´ì§€ëŠ” êµ¬ì¡°</strong>ë¥¼ ë§Œë“œëŠ” ê³³ì…ë‹ˆë‹¤."
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <div style="background: white; border-radius: 8px; padding: 14px;">
              <div style="font-size: 13px; font-weight: 600; color: #4338CA; margin-bottom: 8px;">âœ… ê°•ì¡°í•´ì•¼ í•  ê²ƒ</div>
              <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
                â€¢ ì´ˆê¸°ë¹„ìš© 0ì›<br>
                â€¢ í”„ë¦¬ë¯¸ì—„ ì— ë²„ì„œë” ë„¤íŠ¸ì›Œí¬<br>
                â€¢ ì´ë²¤íŠ¸ ê¸°íšÂ·ì‚¬ì€í’ˆÂ·ê²°ì œì°½ ì§€ì›<br>
                â€¢ 3~7ì¼ ë‚´ ë¹ ë¥¸ ì •ì‚°<br>
                â€¢ ì½˜í…ì¸  2ì°¨ ë§ˆì¼€íŒ… í™œìš© ê°€ëŠ¥
              </div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 14px;">
              <div style="font-size: 13px; font-weight: 600; color: #DC2626; margin-bottom: 8px;">âŒ í”¼í•´ì•¼ í•  ê²ƒ</div>
              <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
                â€¢ ë‹¨ìˆœ "ê³µë™êµ¬ë§¤ ì§„í–‰í•´ìš”" ì‹ ì ‘ê·¼<br>
                â€¢ ìˆ˜ìˆ˜ë£Œë§Œ ê°•ì¡°í•˜ëŠ” ì„¤ëª…<br>
                â€¢ íŒë§¤ ë³´ì¥ ì•½ì†<br>
                â€¢ ê²½ìŸì‚¬ ë¹„ë°©
              </div>
            </div>
          </div>
        </div>

        <!-- ì…€ëŸ¬ ì‘ëŒ€ -->
        <div style="background: #FEF3C7; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #FCD34D;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
            <span style="font-size: 24px;">ğŸ‘©â€ğŸ’¼</span>
            <span style="font-size: 16px; font-weight: 700; color: #B45309;">ì…€ëŸ¬ ì‘ëŒ€ ì‹œ í•µì‹¬ í¬ì¸íŠ¸</span>
          </div>

          <div style="background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
            <div style="font-size: 14px; font-weight: 600; color: #191F28; margin-bottom: 8px;">ğŸ“Œ ì²« ì»¨íƒ ì‹œ ì „ë‹¬í•  ë©”ì‹œì§€</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.8; padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 3px solid #B45309;">
              "ëª¨ì—¬ë¼ë”œì€ ì…€ëŸ¬ê°€ <strong>'ì§€ì†ì ìœ¼ë¡œ ì˜ íŒ” ìˆ˜ ìˆëŠ” êµ¬ì¡°'</strong>ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ì„±ì¥ í”Œë«í¼ì…ë‹ˆë‹¤.<br>
              ì½˜í…ì¸ ëŠ” ì…€ëŸ¬ê°€, êµ¬ì¡°ëŠ” ëª¨ì—¬ë¼ë”œì´ ì±…ì„ì§‘ë‹ˆë‹¤."
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <div style="background: white; border-radius: 8px; padding: 14px;">
              <div style="font-size: 13px; font-weight: 600; color: #B45309; margin-bottom: 8px;">âœ… ê°•ì¡°í•´ì•¼ í•  ê²ƒ</div>
              <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
                â€¢ ì´ˆê¸°ë¹„ìš© 0ì›, í’€ì„œí¬íŠ¸<br>
                â€¢ ì „ì†ê³„ì•½ìœ¼ë¡œ ìˆ˜ìµ ì•ˆì •ì„±<br>
                â€¢ ë¸Œëœë“œ í˜‘ìƒ/ì •ì‚° ìœ„í—˜ ì°¨ë‹¨<br>
                â€¢ ì„±ì¥ ì‹œ ìˆ˜ìˆ˜ë£Œ ìë™ ìƒìŠ¹<br>
                â€¢ ODM/OEM ë¸Œëœë“œí™” ì§€ì›
              </div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 14px;">
              <div style="font-size: 13px; font-weight: 600; color: #DC2626; margin-bottom: 8px;">âŒ í”¼í•´ì•¼ í•  ê²ƒ</div>
              <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
                â€¢ "ë§ì´ íŒ”ë©´ ëˆ ë©ë‹ˆë‹¤" ì‹ ì ‘ê·¼<br>
                â€¢ ìˆ˜ìµë§Œ ê°•ì¡°í•˜ëŠ” ì„¤ëª…<br>
                â€¢ ì „ì†ê³„ì•½ ë¶€ë‹´ê° ì£¼ê¸°<br>
                â€¢ ì„±ê¸‰í•œ ê³„ì•½ ìš”êµ¬
              </div>
            </div>
          </div>

          <div style="background: white; border-radius: 8px; padding: 14px; margin-top: 12px;">
            <div style="font-size: 13px; font-weight: 600; color: #B45309; margin-bottom: 8px;">ğŸ’° ì…€ëŸ¬ ìˆ˜ìˆ˜ë£Œ êµ¬ì¡° ì„¤ëª…</div>
            <div style="font-size: 12px; color: #4B5563; line-height: 1.7;">
              â€¢ ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ: í˜‘ì˜ (ìƒí’ˆ/ì…€ëŸ¬ë³„ ìƒì´)<br>
              â€¢ 500ê°œ ì´ìƒ íŒë§¤ ì‹œ: ë³´ë„ˆìŠ¤ ë§ˆì§„ +1%ì”© (ëª¨ì—¬ë¼ë”œ ë¶€ë‹´)<br>
              â€¢ ì •ì‚°: ê³µêµ¬ ì¢…ë£Œ í›„ 3~7ì¼ ë‚´ ë¹ ë¥¸ ì…ê¸ˆ
            </div>
          </div>
        </div>

        <!-- FAQ -->
        <div style="background: #F2F4F6; border-radius: 12px; padding: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 16px;">â“ ìì£¼ ë°›ëŠ” ì§ˆë¬¸ & ë‹µë³€</div>

          <div style="display: grid; gap: 12px;">
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ì™œ ì´ˆê¸°ë¹„ìš©ì´ 0ì›ì¸ê°€ìš”?</div>
              <div style="font-size: 13px; color: #4B5563;">A. ëª¨ì—¬ë¼ë”œì€ íŒë§¤ ìˆ˜ìˆ˜ë£Œ ê¸°ë°˜ ìˆ˜ìµ êµ¬ì¡°ì…ë‹ˆë‹¤. íŒŒíŠ¸ë„ˆì˜ ì„±ê³µì´ ê³§ ìš°ë¦¬ì˜ ì„±ê³µì´ê¸° ë•Œë¬¸ì—, ì§„ì… ì¥ë²½ì„ ë‚®ì¶”ê³  í•¨ê»˜ ì„±ì¥í•˜ëŠ” êµ¬ì¡°ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.</div>
            </div>
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ë‹¤ë¥¸ ê³µë™êµ¬ë§¤ í”Œë«í¼ê³¼ ë­ê°€ ë‹¤ë¥¸ê°€ìš”?</div>
              <div style="font-size: 13px; color: #4B5563;">A. ëª¨ì—¬ë¼ë”œì€ 'ì‹ ë¢° â†’ êµ¬ë§¤' êµ¬ì¡°ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¨ìˆœ ì¤‘ê°œê°€ ì•„ë‹ˆë¼, ì´ë²¤íŠ¸ ê¸°íšë¶€í„° ì •ì‚°ê¹Œì§€ í’€ìŠ¤íƒ ìœ í†µ ìš´ì˜ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
            </div>
            <div style="background: white; border-radius: 10px; padding: 16px;">
              <div style="font-size: 13px; font-weight: 600; color: #0064FF; margin-bottom: 6px;">Q. ì „ì†ê³„ì•½ì´ë©´ ë‹¤ë¥¸ ê³³ì—ì„œ ëª» íŒŒë‚˜ìš”?</div>
              <div style="font-size: 13px; color: #4B5563;">A. ì „ì†ê³„ì•½ì€ 'ëª¨ì—¬ë¼ë”œ ì±„ë„ ë‚´'ì—ì„œì˜ ë…ì ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì…€ëŸ¬ë‹˜ì˜ ë‹¤ë¥¸ ì±„ë„ í™œë™ì—ëŠ” ì œí•œì´ ì—†ìœ¼ë©°, ì˜¤íˆë ¤ ì•ˆì •ì ì¸ ìˆ˜ìµ ë³´í˜¸ë¥¼ ìœ„í•œ ì¥ì¹˜ì…ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuideMenuContent() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 20px;">ğŸ“‘ ë©”ë‰´ ì„¤ëª…</div>
        <div style="font-size: 14px; color: #6B7684; margin-bottom: 24px;">ìš´ì˜ì„¼í„° & ì „ëµì„¼í„°ì˜ ê° ë©”ë‰´ ê¸°ëŠ¥ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</div>

        <!-- ìš´ì˜ì„¼í„° -->
        <div style="background: #E8F3FF; border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid #3182f6;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ¢</span>
            <span style="font-size: 18px; font-weight: 700; color: #3182f6;">ìš´ì˜ì„¼í„°</span>
            <span style="font-size: 12px; color: #6B7684; background: white; padding: 4px 10px; border-radius: 12px;">ì¼ìƒ ì—…ë¬´ ì²˜ë¦¬</span>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“¦</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ìƒí’ˆ ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ê³µê¸‰ì‚¬ë¡œë¶€í„° ë°›ì€ ìƒí’ˆ DB ê´€ë¦¬<br>ìƒí’ˆ ë“±ë¡, ìˆ˜ì •, ìƒíƒœ ë³€ê²½</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ‘©â€ğŸ’¼</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì…€ëŸ¬ ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì¸í”Œë£¨ì–¸ì„œ/ì…€ëŸ¬ DB ê´€ë¦¬<br>ê³„ì•½ í˜„í™©, ë“±ê¸‰, íˆìŠ¤í† ë¦¬</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ›’</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ê³µêµ¬ ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ê³µë™êµ¬ë§¤ ì¼ì • ê´€ë¦¬<br>ìƒí’ˆ-ì…€ëŸ¬ ë§¤ì¹­, ì§„í–‰ í˜„í™©</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ­</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ê³µê¸‰ì‚¬ ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ê³µê¸‰ì‚¬/ë¸Œëœë“œ DB ê´€ë¦¬<br>ê³„ì•½ ì¡°ê±´, ê±°ë˜ íˆìŠ¤í† ë¦¬</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ’°</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì •ì‚° ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì…€ëŸ¬/ê³µê¸‰ì‚¬ ì •ì‚° ì²˜ë¦¬<br>ìˆ˜ìµ ë¶„ë°°, ì§€ê¸‰ í˜„í™©</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“Š</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ë§ˆì§„ê³„ì‚°ê¸°</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ ì‹œë®¬ë ˆì´ì…˜<br>ìˆ˜ìµ êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸°</div>
            </div>
          </div>
        </div>

        <!-- ì „ëµì„¼í„° -->
        <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 24px; border: 1px solid #F59E0B;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ¯</span>
            <span style="font-size: 18px; font-weight: 700; color: #B45309;">ì „ëµì„¼í„°</span>
            <span style="font-size: 12px; color: #6B7684; background: white; padding: 4px 10px; border-radius: 12px;">ì „ëµ ìˆ˜ë¦½ & ì„±ê³¼ ê´€ë¦¬</span>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“ˆ</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì˜ì—…í˜„í™©</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì‹¤ì‹œê°„ ë§¤ì¶œ, ì˜¨ë³´ë”© í˜„í™©<br>íŒ€ì›ë³„ ì„±ê³¼ ëŒ€ì‹œë³´ë“œ</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸš€</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ê·¸ë¡œìŠ¤ë³´ë“œ</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ëŒ€í˜•í”„ë¡œì íŠ¸â†’íŒ€KPIâ†’ê°œì¸KPI<br>ê³„ì¸µí˜• ëª©í‘œ ê´€ë¦¬, AI ì¶”ì²œ</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ““</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì—…ë¬´ê´€ë¦¬</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì¹¸ë°˜/íƒ€ì„ë¼ì¸ ì—…ë¬´ì¼ì§€<br>ìš´ì˜ì„¼í„° í™œë™ ìë™ ê¸°ë¡</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ”</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì „ëµë¦¬ë·°</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ëª©í‘œ vs ê²°ê³¼ ë¶„ì„<br>A/B í…ŒìŠ¤íŠ¸, ê°œì¸ PPT ìƒì„±</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px;">
              <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“š</div>
              <div style="font-size: 15px; font-weight: 700; color: #191F28; margin-bottom: 6px;">ì—…ë¬´ê°€ì´ë“œ</div>
              <div style="font-size: 13px; color: #6B7684; line-height: 1.6;">ì‹ ê·œ íŒ€ì› ì˜¨ë³´ë”©<br>ë³¸ì§ˆ, í”„ë¡œì„¸ìŠ¤, FAQ</div>
            </div>
          </div>
        </div>
      `;
    }

    function getGuideFeatureContent() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 20px;">âš™ï¸ ì£¼ìš” ê¸°ëŠ¥</div>
        <div style="font-size: 14px; color: #6B7684; margin-bottom: 24px;">ëª¨ì—¬ë¼ë”œ ì‹œìŠ¤í…œì˜ í•µì‹¬ ê¸°ëŠ¥ë“¤ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</div>

        <div style="display: grid; gap: 20px;">
          <!-- ë§ˆì§„ê³„ì‚°ê¸° -->
          <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border-radius: 16px; padding: 24px; border: 1px solid #C7D2FE;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: #6366F1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ’°</div>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: #4338CA;">ë§ˆì§„ê³„ì‚°ê¸°</div>
                <div style="font-size: 13px; color: #6366F1;">ê³µê¸‰ë‹¨ê°€ í˜‘ìƒ ì‹œë®¬ë ˆì´ì…˜</div>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px; font-size: 13px; color: #4B5563; line-height: 1.8;">
              <strong>ì‚¬ìš© ì‹œì :</strong> ê³µê¸‰ì‚¬ì™€ ë‹¨ê°€ í˜‘ìƒ ì „<br>
              <strong>ì…ë ¥ í•­ëª©:</strong> ê³µê¸‰ê°€, íŒë§¤ê°€, ìˆ˜ìˆ˜ë£Œìœ¨, ë°°ì†¡ë¹„<br>
              <strong>ê²°ê³¼:</strong> ì˜ˆìƒ ë§ˆì§„, ìˆ˜ìµ ë¶„ë°° êµ¬ì¡° ìë™ ê³„ì‚°<br>
              <strong>ê¿€íŒ:</strong> 30% ìˆ˜ìˆ˜ë£Œ êµ¬ì¡°ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ê¶Œì¥
            </div>
          </div>

          <!-- ìë™ ê¸°ë¡ -->
          <div style="background: linear-gradient(135deg, #DCFCE7, #BBF7D0); border-radius: 16px; padding: 24px; border: 1px solid #86EFAC;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: #10B981; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ“</div>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: #166534;">ìë™ ì—…ë¬´ ê¸°ë¡</div>
                <div style="font-size: 13px; color: #16A34A;">ìš´ì˜ì„¼í„° í™œë™ â†’ ì—…ë¬´ì¼ì§€ ìë™ ì—°ë™</div>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px; font-size: 13px; color: #4B5563; line-height: 1.8;">
              <strong>ìë™ ê¸°ë¡ ëŒ€ìƒ:</strong><br>
              â€¢ ìƒí’ˆ ë“±ë¡/ìˆ˜ì •/ìƒíƒœ ë³€ê²½<br>
              â€¢ ì…€ëŸ¬ ë“±ë¡/ê³„ì•½/ë“±ê¸‰ ë³€ê²½<br>
              â€¢ ê³µê¸‰ì‚¬ ë“±ë¡/ê³„ì•½/ìƒíƒœ ë³€ê²½<br>
              â€¢ ê³µêµ¬ ìƒì„±/ë§¤ì¹­/ì§„í–‰/ì™„ë£Œ<br>
              <strong>í™•ì¸:</strong> ì „ëµì„¼í„° â†’ ì—…ë¬´ê´€ë¦¬ì—ì„œ í™•ì¸
            </div>
          </div>

          <!-- ì—°ë„ë³„ ëª©í‘œ ê´€ë¦¬ -->
          <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 16px; padding: 24px; border: 1px solid #FCD34D;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: #F59E0B; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ¯</div>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: #B45309;">ì—°ë„ë³„ ëª©í‘œ ê´€ë¦¬</div>
                <div style="font-size: 13px; color: #D97706;">2026-2028 ë§¤ì¶œ ëª©í‘œ ì„¤ì •</div>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px; font-size: 13px; color: #4B5563; line-height: 1.8;">
              <strong>ëª©ì :</strong> 100ì–µ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì—°ë„ë³„ ëª©í‘œ ê´€ë¦¬<br>
              <strong>ê¸°ëŠ¥:</strong><br>
              â€¢ ì—°ë„ë³„ ë§¤ì¶œ ëª©í‘œ ì„¤ì • ë° ì§„ì²™ë„ í™•ì¸<br>
              â€¢ ê·¸ë¡œìŠ¤(90%)/ì˜ì—…(10%) ë¹„ìœ¨ ìë™ ë°°ë¶„<br>
              â€¢ ëŒ€í˜•í”„ë¡œì íŠ¸ â†’ KPI ì—­ì „íŒŒ ëª©í‘œ ì¶”ì <br>
              <strong>ìœ„ì¹˜:</strong> ì „ëµì„¼í„° â†’ ëŒ€ì‹œë³´ë“œ â†’ ì—°ë„ë³„ ëª©í‘œ
            </div>
          </div>

          <!-- PPT ìƒì„± -->
          <div style="background: linear-gradient(135deg, #FCE7F3, #FBCFE8); border-radius: 16px; padding: 24px; border: 1px solid #F9A8D4;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: #EC4899; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ“Š</div>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: #BE185D;">PPT ìë™ ìƒì„±</div>
                <div style="font-size: 13px; color: #DB2777;">CEO ë³´ê³ ìš© ìë£Œ ìë™í™”</div>
              </div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 16px; font-size: 13px; color: #4B5563; line-height: 1.8;">
              <strong>ìƒì„± ê°€ëŠ¥ PPT:</strong><br>
              â€¢ ì „ëµ ë³´ê³ ì„œ (ë³¸ì§ˆëª©í‘œ, ì—°ê°„ëª©í‘œ, KPI)<br>
              â€¢ ê°œì¸ ì„±ê³¼ PPT (ëª©í‘œâ†’KPIâ†’ì‹¤í–‰â†’ê²°ê³¼)<br>
              <strong>ì‚¬ìš©ë²•:</strong> ì „ëµë¦¬ë·° â†’ PPT ìƒì„± ë²„íŠ¼<br>
              <strong>ë¯¸ë¦¬ë³´ê¸°:</strong> ë‹¤ìš´ë¡œë“œ ì „ ìŠ¬ë¼ì´ë“œ ë¯¸ë¦¬ë³´ê¸° ê°€ëŠ¥
            </div>
          </div>
        </div>
      `;
    }

    function getGuidePipelineContent() {
      return `
        <div style="font-size: 18px; font-weight: 700; color: #191F28; margin-bottom: 8px;">ğŸ“Š ì˜ì—… íŒŒì´í”„ë¼ì¸ ê°€ì´ë“œ</div>
        <div style="font-size: 14px; color: #6B7684; margin-bottom: 24px;">ê° íŒŒì´í”„ë¼ì¸ì˜ ë‹¨ê³„ë³„ ì •ì˜ì™€ ë‹´ë‹¹ì ì—­í• ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</div>

        <!-- ìƒí’ˆ íŒŒì´í”„ë¼ì¸ -->
        <div style="background: #F2F4F6; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ“¦</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: #191F28;">ìƒí’ˆ íŒŒì´í”„ë¼ì¸</div>
              <div style="font-size: 13px; color: #6B7684;">ìƒí’ˆ ë°œêµ´ë¶€í„° ê³„ì•½ê¹Œì§€ì˜ ì—¬ì •</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #E5E8EB;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ“‹</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">1. ë¦¬ìŠ¤íŠ¸ì—…</div>
              <div style="font-size: 12px; color: #6B7684;">ì ì¬ ìƒí’ˆ/ê³µê¸‰ì‚¬ ë°œêµ´</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #10B981;">
              <div style="font-size: 28px; margin-bottom: 12px;">âœ…</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">2. ì œì•ˆ</div>
              <div style="font-size: 12px; color: #6B7684;">ì—°ë½/ì œì•ˆ ì™„ë£Œ</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #F59E0B;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ¤</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">3. ì˜¨ë³´ë”©</div>
              <div style="font-size: 12px; color: #6B7684; line-height: 1.5;">ë¯¸íŒ…/ìƒë‹´ Â· ì¡°ê±´í˜‘ì˜<br>ì„œë¥˜ìˆ˜ë ¹ Â· ìƒí’ˆì •ë³´</div>
            </div>
            <div style="background: #6366F1; border-radius: 12px; padding: 20px; text-align: center; color: white;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ‰</div>
              <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">4. ê³„ì•½</div>
              <div style="font-size: 12px; opacity: 0.9;">ê³„ì•½ ì™„ë£Œ</div>
            </div>
          </div>
        </div>

        <!-- ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸ -->
        <div style="background: #FEF9E7; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 28px;">ğŸ‘©â€ğŸ’¼</span>
            <div>
              <div style="font-size: 16px; font-weight: 700; color: #191F28;">ì…€ëŸ¬ íŒŒì´í”„ë¼ì¸</div>
              <div style="font-size: 13px; color: #6B7684;">ì…€ëŸ¬ ë°œêµ´ë¶€í„° ê³„ì•½ê¹Œì§€ì˜ ì—¬ì •</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #E5E8EB;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ“‹</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">1. ë¦¬ìŠ¤íŠ¸ì—…</div>
              <div style="font-size: 12px; color: #6B7684;">ì…€ëŸ¬ í›„ë³´ ë“±ë¡</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #10B981;">
              <div style="font-size: 28px; margin-bottom: 12px;">âœ…</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">2. ì œì•ˆ</div>
              <div style="font-size: 12px; color: #6B7684;">DM/ì—°ë½ Â· ì œì•ˆ ì™„ë£Œ</div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #F59E0B;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ¤</div>
              <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 6px;">3. ì˜¨ë³´ë”©</div>
              <div style="font-size: 12px; color: #6B7684; line-height: 1.5;">ì„œë¹„ìŠ¤ ì•ˆë‚´ Â· ì¡°ê±´í˜‘ì˜<br>ì •ì‚°ì •ë³´ ìˆ˜ë ¹</div>
            </div>
            <div style="background: #B45309; border-radius: 12px; padding: 20px; text-align: center; color: white;">
              <div style="font-size: 28px; margin-bottom: 12px;">ğŸ‰</div>
              <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">4. ê³„ì•½</div>
              <div style="font-size: 12px; opacity: 0.9;">ê³„ì•½ ì™„ë£Œ</div>
            </div>
          </div>
        </div>

        <!-- íŒŒì´í”„ë¼ì¸ ê´€ë¦¬ íŒ -->
        <div style="background: linear-gradient(135deg, #3182f6, #1b64da); border-radius: 16px; padding: 24px; color: white;">
          <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">ğŸ’¡ íŒŒì´í”„ë¼ì¸ ê´€ë¦¬ íŒ</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ“Š ì£¼ê°„ ì²´í¬í¬ì¸íŠ¸</div>
              <div style="font-size: 12px; opacity: 0.9; line-height: 1.6;">ë§¤ì£¼ ì›”ìš”ì¼ íŒŒì´í”„ë¼ì¸ í˜„í™© ì ê²€<br>ì •ì²´ëœ ê±´ ì§‘ì¤‘ íŒ”ë¡œì—…</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">â° ì ì • ì²´ë¥˜ ê¸°ê°„</div>
              <div style="font-size: 12px; opacity: 0.9; line-height: 1.6;">ë¦¬ìŠ¤íŠ¸ì—…â†’ì œì•ˆ: 3ì¼ ì´ë‚´<br>ì œì•ˆâ†’ì˜¨ë³´ë”©: 7ì¼ ì´ë‚´<br>ì˜¨ë³´ë”©â†’ê³„ì•½: 14ì¼ ì´ë‚´</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ¯ ì „í™˜ìœ¨ ëª©í‘œ</div>
              <div style="font-size: 12px; opacity: 0.9; line-height: 1.6;">ë¦¬ìŠ¤íŠ¸ì—…â†’ì œì•ˆ: 50%+<br>ì œì•ˆâ†’ì˜¨ë³´ë”©: 30%+<br>ì˜¨ë³´ë”©â†’ê³„ì•½: 60%+</div>
            </div>
          </div>
        </div>
      `;
    }

    // ========================================
    // ì—…ë¬´ì¼ì§€ ì‹œìŠ¤í…œ
    // ========================================
    const TASK_COLUMNS = [
      { id: 'waiting', label: 'ëŒ€ê¸°', color: '#f59e0b', bg: '#fef3c7', icon: 'â³' },
      { id: 'progress', label: 'ì§„í–‰ì¤‘', color: '#3b82f6', bg: '#dbeafe', icon: 'ğŸ”„' },
      { id: 'complete', label: 'ì™„ë£Œ', color: '#10b981', bg: '#d1fae5', icon: 'âœ…' },
      { id: 'hold', label: 'ë³´ë¥˜', color: '#6b7280', bg: '#f3f4f6', icon: 'â¸ï¸' }
    ];

    let workLogView = 'kanban';
    let memberFilter = 'all';  // ê¸°ë³¸ê°’ì„ 'all'ë¡œ ë³€ê²½ - ëª¨ë“  ì—…ë¬´ í‘œì‹œ
    let selectedMemberId = null;
    // ========================================
    // [DEPRECATED] ì „ëµê¸°íš ì‹œìŠ¤í…œ - ì´ ê¸°ëŠ¥ì€ ì‚­ì œë¨
    // ëŒ€ì‹œë³´ë“œì˜ ì—°ë„ë³„ ëª©í‘œì™€ ê·¸ë¡œìŠ¤ë³´ë“œë¡œ ëŒ€ì²´ë¨
    // ========================================
    let currentStrategyVersion = 'v1.0';
    let strategyVersions = [];

    function renderStrategicPlanning() {
      const container = document.getElementById('planningContent');
      if (!container) return;

      const versions = state.strategyVersions || [{ id: 'v1.0', name: 'v1.0', createdAt: new Date().toISOString(), status: 'active' }];
      const currentVersion = versions.find(v => v.status === 'active') || versions[0];
      const strategyData = state.strategyData || {};

      const C = {
        primary: '#3182f6',
        green: '#00C471',
        yellow: '#F59E0B',
        red: '#F04452',
        gray50: '#F2F4F6',
        gray100: '#E5E8EB',
        gray200: '#D1D6DB',
        gray500: '#6B7684',
        gray700: '#333D4B',
        gray900: '#191F28',
        white: '#FFFFFF'
      };

      container.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 style="font-size: 24px; font-weight: 700; color: ${C.gray900}; margin: 0; display: flex; align-items: center; gap: 12px;">
                ğŸ¯ ì „ëµê¸°íš
                <span style="font-size: 14px; background: ${C.primary}; color: white; padding: 4px 12px; border-radius: 20px;">${currentVersion?.name || 'v1.0'}</span>
              </h1>
              <p style="color: ${C.gray500}; margin-top: 4px; font-size: 13px;">ëª©í‘œ ì„¤ì • ë° ì „ëµ ë°©í–¥ ê´€ë¦¬ Â· ë²„ì „ë³„ íˆìŠ¤í† ë¦¬ ë³´ê´€</p>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="openStrategySettingsModal()" style="padding: 12px 20px; font-size: 14px; font-weight: 700; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 12px rgba(16,185,129,0.3); display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 18px;">âš™ï¸</span> ì „ëµ ì„¤ì •
              </button>
              <button onclick="openVersionHistoryModal()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.white}; color: ${C.gray700}; border: 1px solid ${C.gray200}; border-radius: 8px; cursor: pointer;">
                ğŸ“œ ë²„ì „ íˆìŠ¤í† ë¦¬
              </button>
              <button onclick="downloadStrategyPPT()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.primary}; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ğŸ“¥ PPT ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
          </div>

          <!-- ë³¸ì§ˆ ëª©í‘œ (ì¸ë¼ì¸ í¸ì§‘ ê°€ëŠ¥) -->
          <div style="background: linear-gradient(135deg, ${C.primary}, #1b64da); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
              <div style="font-size: 16px; font-weight: 700; opacity: 0.9;">ğŸ“Œ ë³¸ì§ˆ ëª©í‘œ (Why)</div>
              <button onclick="toggleEditMode('essence')" style="background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                âœï¸ í¸ì§‘
              </button>
            </div>
            <div id="essenceGoal" class="editable-field" data-field="essenceGoal" style="font-size: 20px; font-weight: 600; line-height: 1.5; min-height: 60px;">
              ${strategyData.essenceGoal || 'ì‚¬ëŒì˜ ì‹ ë¢°ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼'}
            </div>
          </div>

          <!-- ì—°ê°„ ëª©í‘œ ì¹´ë“œ (ì¸ë¼ì¸ í¸ì§‘ ê°€ëŠ¥) -->
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ì—°ê°„ ë§¤ì¶œ ëª©í‘œ</div>
              <div class="editable-number" data-field="annualRevenue" onclick="enableInlineEdit(this)" style="font-size: 28px; font-weight: 700; color: ${C.gray900}; cursor: pointer;">
                ${((strategyData.annualRevenue || 500000000) / 100000000).toFixed(1)}ì–µ
              </div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ì—°ê°„ ìˆœìµ ëª©í‘œ</div>
              <div class="editable-number" data-field="annualProfit" onclick="enableInlineEdit(this)" style="font-size: 28px; font-weight: 700; color: ${C.green}; cursor: pointer;">
                ${((strategyData.annualProfit || 50000000) / 10000).toLocaleString()}ë§Œ
              </div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ëª©í‘œ ì„±ê³µë¥ </div>
              <div class="editable-number" data-field="successRate" onclick="enableInlineEdit(this)" style="font-size: 28px; font-weight: 700; color: ${C.yellow}; cursor: pointer;">
                ${strategyData.successRate || 30}%
              </div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">30% ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨</div>
              <div class="editable-number" data-field="commission30Ratio" onclick="enableInlineEdit(this)" style="font-size: 28px; font-weight: 700; color: ${C.primary}; cursor: pointer;">
                ${strategyData.commission30Ratio || 30}%
              </div>
            </div>
          </div>

          <!-- ì„±ì¥ vs ì˜ì—… ë¹„ìœ¨ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.gray900};">âš–ï¸ ë¦¬ì†ŒìŠ¤ ë°°ë¶„ ì „ëµ</div>
              <button onclick="toggleEditMode('allocation')" style="background: ${C.gray50}; border: 1px solid ${C.gray200}; padding: 6px 12px; border-radius: 6px; color: ${C.gray700}; cursor: pointer; font-size: 12px;">
                âœï¸ í¸ì§‘
              </button>
            </div>
            <div style="display: flex; gap: 24px; align-items: center;">
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 14px; font-weight: 600; color: #10B981;">ğŸŒ± ì„±ì¥ (Growth)</span>
                  <span id="growthRatio" class="editable-number" data-field="growthRatio" onclick="enableInlineEdit(this)" style="font-size: 14px; font-weight: 700; color: #10B981; cursor: pointer;">${strategyData.growthRatio || 90}%</span>
                </div>
                <div style="background: ${C.gray100}; border-radius: 8px; height: 24px; overflow: hidden;">
                  <div style="background: linear-gradient(90deg, #10B981, #34D399); height: 100%; width: ${strategyData.growthRatio || 90}%; transition: width 0.3s;"></div>
                </div>
                <div style="font-size: 12px; color: ${C.gray500}; margin-top: 8px;">ì‹ ê·œ ê³µê¸‰ì‚¬/ì…€ëŸ¬ í™•ë³´, ì‹œì¥ í™•ì¥</div>
              </div>
              <div style="font-size: 24px; color: ${C.gray300};">âŸ·</div>
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 14px; font-weight: 600; color: #3B82F6;">ğŸ’° ì˜ì—… (Sales)</span>
                  <span id="salesRatio" style="font-size: 14px; font-weight: 700; color: #3B82F6;">${100 - (strategyData.growthRatio || 90)}%</span>
                </div>
                <div style="background: ${C.gray100}; border-radius: 8px; height: 24px; overflow: hidden;">
                  <div style="background: linear-gradient(90deg, #3B82F6, #60A5FA); height: 100%; width: ${100 - (strategyData.growthRatio || 90)}%; transition: width 0.3s;"></div>
                </div>
                <div style="font-size: 12px; color: ${C.gray500}; margin-top: 8px;">ê¸°ì¡´ íŒŒíŠ¸ë„ˆ ê´€ë¦¬, ë§¤ì¶œ ê·¹ëŒ€í™”</div>
              </div>
            </div>
          </div>

          <!-- 4ì¶• ë„ë©”ì¸ ì „ëµ -->
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="font-size: 16px; font-weight: 700; color: ${C.gray900};">ğŸ§­ 4ì¶• ë„ë©”ì¸ ì „ëµ</div>
              <button onclick="openDomainStrategyModal()" style="background: ${C.gray50}; border: 1px solid ${C.gray200}; padding: 6px 12px; border-radius: 6px; color: ${C.gray700}; cursor: pointer; font-size: 12px;">
                âš™ï¸ ì „ëµ í¸ì§‘
              </button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              ${renderDomainCard('domestic', 'ğŸ‡°ğŸ‡· êµ­ë‚´ ê³µê¸‰ì‚¬', strategyData.domesticStrategy || 'êµ­ë‚´ ìš°ìˆ˜ ë¸Œëœë“œ ë°œêµ´ ë° ë…ì  ê³„ì•½', '#6366F1')}
              ${renderDomainCard('import', 'âœˆï¸ í•´ì™¸ ì§ìˆ˜ì…', strategyData.importStrategy || 'ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ìƒí’ˆ ì„ ì œ í™•ë³´', '#F59E0B')}
              ${renderDomainCard('export', 'ğŸŒ í•´ì™¸ ìˆ˜ì¶œ', strategyData.exportStrategy || 'K-ë¸Œëœë“œ ê¸€ë¡œë²Œ ì§„ì¶œ ì§€ì›', '#10B981')}
              ${renderDomainCard('platform', 'ğŸ¥• ë‹¹ê·¼ Ã— ëª¨ì—¬ë¼ë”œ', strategyData.platformStrategy || 'ì§€ì—­ ê¸°ë°˜ ê³µë™êµ¬ë§¤ í™œì„±í™”', '#EF4444')}
            </div>
          </div>

          <!-- KPI ì—°ê²° ì•ˆë‚´ -->
          <div style="background: ${C.gray50}; border: 2px dashed ${C.gray200}; border-radius: 16px; padding: 24px; margin-top: 24px; text-align: center;">
            <div style="font-size: 14px; color: ${C.gray500}; margin-bottom: 12px;">ì´ ì „ëµì— ì—°ê²°ëœ KPIë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>
            <button onclick="switchTab('kpi'); event.stopPropagation();" style="background: ${C.primary}; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
              ğŸ“Š KPIê´€ë¦¬ë¡œ ì´ë™ â†’
            </button>
          </div>
        </div>
      `;
    }

    function renderDomainCard(domain, title, description, color) {
      return `
        <div style="background: ${color}10; border: 1px solid ${color}30; border-radius: 12px; padding: 16px;">
          <div style="font-size: 14px; font-weight: 700; color: ${color}; margin-bottom: 8px;">${title}</div>
          <div style="font-size: 13px; color: #4B5563; line-height: 1.5;">${description}</div>
        </div>
      `;
    }

    // ì¸ë¼ì¸ í¸ì§‘ í™œì„±í™”
    function enableInlineEdit(element) {
      if (element.querySelector('input')) return; // ì´ë¯¸ í¸ì§‘ ì¤‘

      const field = element.dataset.field;
      const currentValue = element.textContent.replace(/[^0-9.]/g, '');

      element.innerHTML = `
        <input type="number" value="${currentValue}"
          style="width: 80px; font-size: inherit; font-weight: inherit; color: inherit; background: rgba(255,255,255,0.9); border: 2px solid var(--primary); border-radius: 6px; padding: 4px 8px; text-align: center;"
          onblur="saveInlineEdit(this, '${field}')"
          onkeypress="if(event.key==='Enter') this.blur();"
          autofocus>
      `;
      element.querySelector('input').focus();
    }

    // ì¸ë¼ì¸ í¸ì§‘ ì €ì¥
    async function saveInlineEdit(input, field) {
      const value = parseFloat(input.value);
      const parent = input.parentElement;

      try {
        let updateData = {};
        if (field === 'annualRevenue') {
          updateData[field] = value * 100000000;
          parent.textContent = value.toFixed(1) + 'ì–µ';
        } else if (field === 'annualProfit') {
          updateData[field] = value * 10000;
          parent.textContent = value.toLocaleString() + 'ë§Œ';
        } else if (field === 'growthRatio') {
          updateData[field] = value;
          parent.textContent = value + '%';
          document.getElementById('salesRatio').textContent = (100 - value) + '%';
        } else {
          updateData[field] = value;
          parent.textContent = value + '%';
        }

        await db.collection('settings').doc('strategy').set(updateData, { merge: true });
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    // ë²„ì „ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬
    // ì „ëµ ì„¤ì • ëª¨ë‹¬
    function openStrategySettingsModal() {
      const strategy = state.strategyData || {};
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header" style="background: #10B981; color: white;">
            <h2 class="modal-title" style="color: white;">âš™ï¸ ì „ëµ ì„¤ì •</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; max-height: 70vh; overflow-y: auto;">
            <!-- ë³¸ì§ˆ ëª©í‘œ -->
            <div style="margin-bottom: 24px;">
              <label style="display: block; font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 8px;">ğŸ“Œ ë³¸ì§ˆ ëª©í‘œ (Why)</label>
              <textarea id="setting-essenceGoal" class="form-input" rows="2" style="width: 100%;">${strategy.essenceGoal || 'ì‚¬ëŒì˜ ì‹ ë¢°ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼'}</textarea>
            </div>

            <!-- ì—°ê°„ ëª©í‘œ -->
            <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 12px;">ğŸ“Š ì—°ê°„ ëª©í‘œ</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ì—°ê°„ ë§¤ì¶œ ëª©í‘œ (ì–µ)</label>
                <input type="number" id="setting-annualRevenue" class="form-input" step="0.1" value="${((strategy.annualRevenue || 500000000) / 100000000).toFixed(1)}" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ì—°ê°„ ìˆœìµ ëª©í‘œ (ë§Œì›)</label>
                <input type="number" id="setting-annualProfit" class="form-input" value="${(strategy.annualProfit || 50000000) / 10000}" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ëª©í‘œ ì„±ê³µë¥  (%)</label>
                <input type="number" id="setting-successRate" class="form-input" value="${strategy.successRate || 30}" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">30% ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨ (%)</label>
                <input type="number" id="setting-commission30Ratio" class="form-input" value="${strategy.commission30Ratio || 30}" style="width: 100%;">
              </div>
            </div>

            <!-- ë¦¬ì†ŒìŠ¤ ë°°ë¶„ -->
            <div style="margin-bottom: 24px;">
              <label style="display: block; font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 8px;">âš–ï¸ ë¦¬ì†ŒìŠ¤ ë°°ë¶„ (ì„±ì¥ ë¹„ìœ¨ %)</label>
              <div style="display: flex; align-items: center; gap: 16px;">
                <input type="range" id="setting-growthRatio" min="0" max="100" value="${strategy.growthRatio || 90}" style="flex: 1;" oninput="document.getElementById('growthRatioDisplay').textContent = this.value + '%'">
                <span id="growthRatioDisplay" style="font-weight: 700; color: #10B981; min-width: 50px;">${strategy.growthRatio || 90}%</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6B7684; margin-top: 4px;">
                <span>ğŸŒ± ì„±ì¥ ì¤‘ì‹¬</span>
                <span>ğŸ’° ì˜ì—… ì¤‘ì‹¬</span>
              </div>
            </div>

            <!-- 4ì¶• ë„ë©”ì¸ ì „ëµ -->
            <div style="font-size: 14px; font-weight: 700; color: #191F28; margin-bottom: 12px;">ğŸ§­ 4ì¶• ë„ë©”ì¸ ì „ëµ</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ğŸ‡°ğŸ‡· êµ­ë‚´ ê³µê¸‰ì‚¬</label>
                <textarea id="setting-domesticStrategy" class="form-input" rows="2" style="width: 100%;">${strategy.domesticStrategy || 'êµ­ë‚´ ìš°ìˆ˜ ë¸Œëœë“œ ë°œêµ´ ë° ë…ì  ê³„ì•½'}</textarea>
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">âœˆï¸ í•´ì™¸ ì§ìˆ˜ì…</label>
                <textarea id="setting-importStrategy" class="form-input" rows="2" style="width: 100%;">${strategy.importStrategy || 'ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ìƒí’ˆ ì„ ì œ í™•ë³´'}</textarea>
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ğŸŒ í•´ì™¸ ìˆ˜ì¶œ</label>
                <textarea id="setting-exportStrategy" class="form-input" rows="2" style="width: 100%;">${strategy.exportStrategy || 'K-ë¸Œëœë“œ ê¸€ë¡œë²Œ ì§„ì¶œ ì§€ì›'}</textarea>
              </div>
              <div>
                <label style="display: block; font-size: 13px; color: #6B7684; margin-bottom: 6px;">ğŸ¥• ë‹¹ê·¼ Ã— ëª¨ì—¬ë¼ë”œ</label>
                <textarea id="setting-platformStrategy" class="form-input" rows="2" style="width: 100%;">${strategy.platformStrategy || 'ì§€ì—­ ê¸°ë°˜ ê³µë™êµ¬ë§¤ í™œì„±í™”'}</textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveStrategySettings()">ğŸ’¾ ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveStrategySettings() {
      try {
        const updateData = {
          essenceGoal: document.getElementById('setting-essenceGoal').value.trim(),
          annualRevenue: parseFloat(document.getElementById('setting-annualRevenue').value) * 100000000,
          annualProfit: parseFloat(document.getElementById('setting-annualProfit').value) * 10000,
          successRate: parseFloat(document.getElementById('setting-successRate').value),
          commission30Ratio: parseFloat(document.getElementById('setting-commission30Ratio').value),
          growthRatio: parseInt(document.getElementById('setting-growthRatio').value),
          domesticStrategy: document.getElementById('setting-domesticStrategy').value.trim(),
          importStrategy: document.getElementById('setting-importStrategy').value.trim(),
          exportStrategy: document.getElementById('setting-exportStrategy').value.trim(),
          platformStrategy: document.getElementById('setting-platformStrategy').value.trim(),
          updatedAt: new Date().toISOString()
        };

        await db.collection('settings').doc('strategy').set(updateData, { merge: true });
        state.strategyData = { ...state.strategyData, ...updateData };

        closeModal();
        renderStrategicPlanning();
        showToast('ì „ëµ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('ì „ëµ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // PPT ì§ì ‘ ë‹¤ìš´ë¡œë“œ
    function downloadStrategyPPT() {
      try {
        const pptx = new PptxGenJS();
        pptx.author = 'ëª¨ì—¬ë¼ë”œ';
        pptx.title = 'ì „ëµ ë³´ê³ ì„œ';
        pptx.subject = 'ëª¨ì—¬ë¼ë”œ ì „ëµ ë³´ê³ ì„œ';

        const strategy = state.strategyData || {};
        const versions = state.strategyVersions || [];
        const currentVersion = versions.find(v => v.status === 'active') || { name: 'v1.0' };

        // ìŠ¬ë¼ì´ë“œ 1: íƒ€ì´í‹€
        let slide = pptx.addSlide();
        slide.addText('ì „ëµ ë³´ê³ ì„œ', { x: 0.5, y: 2, w: '90%', h: 1, fontSize: 44, bold: true, color: '191F28', align: 'center' });
        slide.addText(`${currentVersion.name} Â· ${new Date().toLocaleDateString('ko-KR')}`, { x: 0.5, y: 3.2, w: '90%', h: 0.5, fontSize: 18, color: '6B7684', align: 'center' });
        slide.addText('ëª¨ì—¬ë¼ë”œ', { x: 0.5, y: 4.5, w: '90%', h: 0.5, fontSize: 16, color: '3182f6', align: 'center' });

        // ìŠ¬ë¼ì´ë“œ 2: ë³¸ì§ˆ ëª©í‘œ
        slide = pptx.addSlide();
        slide.addText('ë³¸ì§ˆ ëª©í‘œ (Why)', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });
        slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 1.5, w: 9, h: 1.5, fill: { color: '3182f6' }, line: { color: '3182f6' } });
        slide.addText(strategy.essenceGoal || 'ì‚¬ëŒì˜ ì‹ ë¢°ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼', { x: 0.7, y: 1.7, w: 8.6, h: 1.1, fontSize: 18, color: 'FFFFFF', valign: 'middle' });

        // ìŠ¬ë¼ì´ë“œ 3: ì—°ê°„ ëª©í‘œ
        slide = pptx.addSlide();
        slide.addText('ì—°ê°„ ëª©í‘œ', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });

        const targets = [
          { label: 'ì—°ë§¤ì¶œ ëª©í‘œ', value: `${((strategy.annualRevenue || 500000000) / 100000000).toFixed(1)}ì–µ`, color: '191F28' },
          { label: 'ìˆœìµ ëª©í‘œ', value: `${((strategy.annualProfit || 50000000) / 10000).toLocaleString()}ë§Œ`, color: '00C471' },
          { label: 'ì„±ê³µë¥  ëª©í‘œ', value: `${strategy.successRate || 30}%`, color: 'F59E0B' },
          { label: '30% ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨', value: `${strategy.commission30Ratio || 30}%`, color: '3182f6' }
        ];

        targets.forEach((t, i) => {
          const x = 0.5 + (i * 2.3);
          slide.addShape(pptx.ShapeType.rect, { x, y: 1.5, w: 2.1, h: 1.8, fill: { color: 'F2F4F6' }, line: { color: 'E5E8EB' } });
          slide.addText(t.label, { x, y: 1.6, w: 2.1, h: 0.5, fontSize: 11, color: '6B7684', align: 'center' });
          slide.addText(t.value, { x, y: 2.1, w: 2.1, h: 0.8, fontSize: 24, bold: true, color: t.color, align: 'center' });
        });

        // ìŠ¬ë¼ì´ë“œ 4: ë¦¬ì†ŒìŠ¤ ë°°ë¶„ + 4ì¶• ì „ëµ
        slide = pptx.addSlide();
        slide.addText('ë¦¬ì†ŒìŠ¤ ë°°ë¶„ & ë„ë©”ì¸ ì „ëµ', { x: 0.5, y: 0.3, w: '90%', h: 0.6, fontSize: 24, bold: true, color: '191F28' });

        const growthRatio = strategy.growthRatio || 90;
        slide.addText(`ì„±ì¥ ${growthRatio}% : ì˜ì—… ${100-growthRatio}%`, { x: 0.5, y: 1, w: 9, h: 0.4, fontSize: 14, color: '6B7684' });

        const domains = [
          { icon: 'ğŸ‡°ğŸ‡·', title: 'êµ­ë‚´ ê³µê¸‰ì‚¬', desc: strategy.domesticStrategy || '' },
          { icon: 'âœˆï¸', title: 'í•´ì™¸ ì§ìˆ˜ì…', desc: strategy.importStrategy || '' },
          { icon: 'ğŸŒ', title: 'í•´ì™¸ ìˆ˜ì¶œ', desc: strategy.exportStrategy || '' },
          { icon: 'ğŸ¥•', title: 'ë‹¹ê·¼Ã—ëª¨ì—¬ë¼ë”œ', desc: strategy.platformStrategy || '' }
        ];

        domains.forEach((d, i) => {
          const x = 0.5 + (i % 2) * 4.7;
          const y = 1.6 + Math.floor(i / 2) * 1.6;
          slide.addShape(pptx.ShapeType.rect, { x, y, w: 4.4, h: 1.4, fill: { color: 'F2F4F6' }, line: { color: 'E5E8EB' } });
          slide.addText(`${d.icon} ${d.title}`, { x: x + 0.2, y: y + 0.1, w: 4, h: 0.4, fontSize: 12, bold: true, color: '191F28' });
          slide.addText(d.desc, { x: x + 0.2, y: y + 0.5, w: 4, h: 0.8, fontSize: 10, color: '6B7684' });
        });

        // ë‹¤ìš´ë¡œë“œ
        const fileName = `ì „ëµë³´ê³ ì„œ_${currentVersion.name}_${new Date().toISOString().split('T')[0]}.pptx`;
        pptx.writeFile({ fileName });
        showToast('PPT ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤');
      } catch (e) {
        console.error('PPT ìƒì„± ì˜¤ë¥˜:', e);
        showToast('PPT ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    function openVersionHistoryModal() {
      const versions = state.strategyVersions || [{ id: 'v1.0', name: 'v1.0', createdAt: new Date().toISOString(), status: 'active' }];
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">ğŸ“œ ì „ëµ ë²„ì „ íˆìŠ¤í† ë¦¬</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
            ${versions.map((v, i) => `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: ${v.status === 'active' ? 'var(--primary-light)' : 'var(--gray-50)'}; border-radius: 12px; margin-bottom: 12px; border: ${v.status === 'active' ? '2px solid var(--primary)' : '1px solid var(--gray-200)'};">
                <div>
                  <div style="font-weight: 700; color: var(--gray-900);">${v.name}</div>
                  <div style="font-size: 12px; color: var(--gray-500);">${formatDateKR(v.createdAt)}</div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  ${v.status === 'active' ? '<span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">í˜„ì¬ ë²„ì „</span>' : `<button onclick="activateVersion('${v.id}')" style="padding: 6px 12px; font-size: 12px; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer;">ì ìš©</button>`}
                  <button onclick="viewVersionDetail('${v.id}')" style="padding: 6px 12px; font-size: 12px; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer;">ìƒì„¸</button>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
          </div>
        </div>
      `;
    }

    // ìƒˆ ë²„ì „ ìƒì„± ëª¨ë‹¬
    function openNewVersionModal() {
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h2 class="modal-title">+ ìƒˆ ì „ëµ ë²„ì „ ìƒì„±</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë²„ì „ ì´ë¦„</label>
              <input type="text" id="newVersionName" class="form-input" placeholder="ì˜ˆ: v1.1, v2.0, 2026 Q2" value="">
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ë³€ê²½ ì‚¬ìœ </label>
              <textarea id="newVersionReason" class="form-input" rows="3" placeholder="ì´ ë²„ì „ì„ ìƒì„±í•˜ëŠ” ì´ìœ ë¥¼ ê¸°ë¡í•˜ì„¸ìš”"></textarea>
            </div>
            <div style="background: var(--yellow-light); border-radius: 8px; padding: 12px; font-size: 12px; color: #B45309;">
              âš ï¸ ìƒˆ ë²„ì „ ìƒì„± ì‹œ í˜„ì¬ ì „ëµ ì„¤ì •ì´ ë³µì‚¬ë˜ë©°, ê¸°ì¡´ ë²„ì „ì€ íˆìŠ¤í† ë¦¬ì— ë³´ê´€ë©ë‹ˆë‹¤.
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="createNewVersion()">ìƒì„±</button>
          </div>
        </div>
      `;
    }

    // ìƒˆ ë²„ì „ ìƒì„±
    async function createNewVersion() {
      const name = document.getElementById('newVersionName').value.trim();
      const reason = document.getElementById('newVersionReason').value.trim();
      if (!name) { showToast('ë²„ì „ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

      try {
        const currentStrategy = state.strategyData || {};
        const newVersion = {
          name,
          reason,
          createdAt: new Date().toISOString(),
          status: 'active',
          data: { ...currentStrategy }
        };

        // ê¸°ì¡´ ë²„ì „ë“¤ ë¹„í™œì„±í™”
        const versions = state.strategyVersions || [];
        versions.forEach(v => v.status = 'archived');
        versions.unshift(newVersion);

        await db.collection('settings').doc('strategyVersions').set({ versions });
        state.strategyVersions = versions;

        closeModal();
        renderStrategicPlanning();
        showToast(`${name} ë²„ì „ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`);
      } catch (e) {
        console.error(e);
        showToast('ë²„ì „ ìƒì„± ì‹¤íŒ¨');
      }
    }

    // PPT ìƒì„±
    function generateStrategyPPT() {
      const strategyData = state.strategyData || {};
      const kpis = state.projects?.flatMap(p => [...(p.teamKPIs || []), ...(p.memberKPIs || [])]) || [];

      if (kpis.length === 0) {
        if (confirm('KPIê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. KPIê´€ë¦¬ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          switchTab('kpi');
        }
        return;
      }

      // PPT ë°ì´í„° êµ¬ì„±
      const pptData = {
        title: 'ì „ëµ ë³´ê³ ì„œ',
        version: currentStrategyVersion,
        date: new Date().toLocaleDateString('ko-KR'),
        essenceGoal: strategyData.essenceGoal || '',
        annualRevenue: strategyData.annualRevenue || 0,
        annualProfit: strategyData.annualProfit || 0,
        successRate: strategyData.successRate || 0,
        growthRatio: strategyData.growthRatio || 90,
        domains: {
          domestic: strategyData.domesticStrategy || '',
          import: strategyData.importStrategy || '',
          export: strategyData.exportStrategy || '',
          platform: strategyData.platformStrategy || ''
        },
        kpis: kpis
      };

      // PPT ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬
      showPPTPreviewModal(pptData);
    }

    function showPPTPreviewModal(data) {
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header" style="background: var(--primary); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ“Š ì „ëµ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; background: #f0f0f0;">
            <!-- ìŠ¬ë¼ì´ë“œ ë¯¸ë¦¬ë³´ê¸° -->
            <div style="background: white; aspect-ratio: 16/9; border-radius: 8px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
              <div style="text-align: center; margin-bottom: 40px;">
                <h1 style="font-size: 32px; color: var(--gray-900); margin-bottom: 8px;">${data.title}</h1>
                <div style="color: var(--gray-500);">${data.version} Â· ${data.date}</div>
              </div>
              <div style="background: var(--primary); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 24px;">
                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 8px;">ë³¸ì§ˆ ëª©í‘œ</div>
                <div style="font-size: 18px; font-weight: 600;">${data.essenceGoal || 'ë¯¸ì„¤ì •'}</div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">${(data.annualRevenue / 100000000).toFixed(1)}ì–µ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ì—°ë§¤ì¶œ ëª©í‘œ</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--green);">${(data.annualProfit / 10000).toLocaleString()}ë§Œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ìˆœìµ ëª©í‘œ</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--yellow);">${data.successRate}%</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ì„±ê³µë¥  ëª©í‘œ</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${data.kpis.length}ê°œ</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ì—°ê²° KPI</div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            <button class="btn btn-primary" onclick="downloadPPT()">ğŸ“¥ PPT ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
      `;
    }

    function downloadPPT() {
      try {
        const pptx = new PptxGenJS();
        pptx.author = 'ëª¨ì—¬ë¼ë”œ';
        pptx.title = 'ì „ëµ ë³´ê³ ì„œ';
        pptx.subject = 'ëª¨ì—¬ë¼ë”œ ì „ëµ ë³´ê³ ì„œ';

        const strategy = state.strategyData || {};
        const versions = state.strategyVersions || [];
        const currentVersion = versions.find(v => v.status === 'active') || { name: 'v1.0' };

        // ìŠ¬ë¼ì´ë“œ 1: íƒ€ì´í‹€
        let slide = pptx.addSlide();
        slide.addText('ì „ëµ ë³´ê³ ì„œ', { x: 0.5, y: 2, w: '90%', h: 1, fontSize: 44, bold: true, color: '191F28', align: 'center' });
        slide.addText(`${currentVersion.name} Â· ${new Date().toLocaleDateString('ko-KR')}`, { x: 0.5, y: 3.2, w: '90%', h: 0.5, fontSize: 18, color: '6B7684', align: 'center' });
        slide.addText('ëª¨ì—¬ë¼ë”œ', { x: 0.5, y: 4.5, w: '90%', h: 0.5, fontSize: 16, color: '3182f6', align: 'center' });

        // ìŠ¬ë¼ì´ë“œ 2: ë³¸ì§ˆ ëª©í‘œ
        slide = pptx.addSlide();
        slide.addText('ë³¸ì§ˆ ëª©í‘œ (Why)', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });
        slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 1.5, w: 9, h: 1.5, fill: { color: '3182f6' }, line: { color: '3182f6' } });
        slide.addText(strategy.essenceGoal || 'ì‚¬ëŒì˜ ì‹ ë¢°ë¥¼ ìœ í†µì˜ ì¤‘ì‹¬ì— ë‘” ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤ ê¸°ë°˜ ê³µë™êµ¬ë§¤ ì¸í”„ë¼ í”Œë«í¼', { x: 0.7, y: 1.7, w: 8.6, h: 1.1, fontSize: 18, color: 'FFFFFF', valign: 'middle' });

        // ìŠ¬ë¼ì´ë“œ 3: ì—°ê°„ ëª©í‘œ
        slide = pptx.addSlide();
        slide.addText('ì—°ê°„ ëª©í‘œ', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });

        const targets = [
          { label: 'ì—°ë§¤ì¶œ ëª©í‘œ', value: `${((strategy.annualRevenue || 500000000) / 100000000).toFixed(1)}ì–µ`, color: '191F28' },
          { label: 'ìˆœìµ ëª©í‘œ', value: `${((strategy.annualProfit || 50000000) / 10000).toLocaleString()}ë§Œ`, color: '00C471' },
          { label: 'ì„±ê³µë¥  ëª©í‘œ', value: `${strategy.successRate || 30}%`, color: 'F59E0B' },
          { label: '30% ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨', value: `${strategy.commission30Ratio || 30}%`, color: '3182f6' }
        ];

        targets.forEach((t, i) => {
          const x = 0.5 + (i * 2.3);
          slide.addShape(pptx.ShapeType.rect, { x, y: 1.5, w: 2.1, h: 1.8, fill: { color: 'F2F4F6' }, line: { color: 'E5E8EB' } });
          slide.addText(t.label, { x, y: 1.6, w: 2.1, h: 0.5, fontSize: 11, color: '6B7684', align: 'center' });
          slide.addText(t.value, { x, y: 2.1, w: 2.1, h: 0.8, fontSize: 24, bold: true, color: t.color, align: 'center' });
        });

        // ìŠ¬ë¼ì´ë“œ 4: ë¦¬ì†ŒìŠ¤ ë°°ë¶„
        slide = pptx.addSlide();
        slide.addText('ë¦¬ì†ŒìŠ¤ ë°°ë¶„ ì „ëµ', { x: 0.5, y: 0.5, w: '90%', h: 0.8, fontSize: 28, bold: true, color: '191F28' });
        const growthRatio = strategy.growthRatio || 90;
        slide.addText(`ì„±ì¥ (Growth): ${growthRatio}%`, { x: 0.5, y: 1.8, w: 4, h: 0.5, fontSize: 16, color: '10B981' });
        slide.addText(`ì˜ì—… (Sales): ${100 - growthRatio}%`, { x: 5, y: 1.8, w: 4, h: 0.5, fontSize: 16, color: '3B82F6' });

        // ë‹¤ìš´ë¡œë“œ
        pptx.writeFile({ fileName: `ì „ëµë³´ê³ ì„œ_${currentVersion.name}_${new Date().toISOString().split('T')[0]}.pptx` });
        showToast('PPT ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error('PPT ìƒì„± ì˜¤ë¥˜:', e);
        showToast('PPT ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ========================================
    // KPIê´€ë¦¬ ì‹œìŠ¤í…œ (ìƒˆ êµ¬ì¡°: ëŒ€í˜•í”„ë¡œì íŠ¸ â†’ í”„ë¡œì íŠ¸ â†’ íŒ€KPI â†’ ê°œì¸KPI)
    // ========================================
    let kpiViewMode = 'hierarchy'; // hierarchy, team, member
    let kpiMemberFilter = 'all';

    function renderKPIManagement() {
      const container = document.getElementById('kpiContent');
      if (!container) return;

      const megaProjects = state.megaProjects || [];
      const projects = state.projects || [];
      const teamKPIs = state.teamKPIs || [];
      const memberKPIs = state.memberKPIs || [];
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');

      const C = {
        primary: '#3182f6',
        purple: '#6366F1',
        green: '#00C471',
        yellow: '#F59E0B',
        red: '#F04452',
        gray50: '#F2F4F6',
        gray100: '#E5E8EB',
        gray200: '#D1D6DB',
        gray500: '#6B7684',
        gray700: '#333D4B',
        gray900: '#191F28',
        white: '#FFFFFF'
      };

      // ë‹¬ì„±ë¥  ê³„ì‚°
      const totalKPIs = teamKPIs.length + memberKPIs.length;
      const achievedKPIs = [...teamKPIs, ...memberKPIs].filter(k => k.current >= k.target).length;
      const achievementRate = totalKPIs > 0 ? Math.round((achievedKPIs / totalKPIs) * 100) : 0;

      container.innerHTML = `
        <div style="max-width: 1400px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 style="font-size: 24px; font-weight: 700; color: ${C.gray900}; margin: 0;">ğŸ“Š KPIê´€ë¦¬</h1>
              <p style="color: ${C.gray500}; margin-top: 4px; font-size: 13px;">ëŒ€í˜•í”„ë¡œì íŠ¸ â†’ í”„ë¡œì íŠ¸ â†’ íŒ€KPI â†’ ê°œì¸KPI ê³„ì¸µ êµ¬ì¡°</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="openMegaProjectModal()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.purple}; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ğŸ¢ ëŒ€í˜•í”„ë¡œì íŠ¸ ì¶”ê°€
              </button>
              <button onclick="openTeamKPIModal()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.green}; color: white; border: none; border-radius: 8px; cursor: pointer;">
                + íŒ€ KPI ì¶”ê°€
              </button>
            </div>
          </div>

          <!-- KPI ìš”ì•½ ì¹´ë“œ -->
          <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: linear-gradient(135deg, ${C.purple}, #8B5CF6); border-radius: 12px; padding: 20px; color: white;">
              <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px;">ğŸ¢ ëŒ€í˜•í”„ë¡œì íŠ¸</div>
              <div style="font-size: 28px; font-weight: 700;">${megaProjects.length}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ“ í”„ë¡œì íŠ¸</div>
              <div style="font-size: 28px; font-weight: 700; color: ${C.primary};">${projects.length}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ‘¥ íŒ€ KPI</div>
              <div style="font-size: 28px; font-weight: 700; color: ${C.green};">${teamKPIs.length}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ‘¤ ê°œì¸ KPI</div>
              <div style="font-size: 28px; font-weight: 700; color: ${C.yellow};">${memberKPIs.length}</div>
            </div>
            <div style="background: ${C.white}; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ğŸ“ˆ ë‹¬ì„±ë¥ </div>
              <div style="font-size: 28px; font-weight: 700; color: ${achievementRate >= 70 ? C.green : achievementRate >= 40 ? C.yellow : C.red};">${achievementRate}%</div>
            </div>
          </div>

          <!-- ë·° ëª¨ë“œ ì „í™˜ -->
          <div style="display: flex; gap: 8px; margin-bottom: 20px; background: ${C.gray50}; padding: 4px; border-radius: 10px; width: fit-content;">
            <button onclick="setKPIViewMode('hierarchy')" style="background: ${kpiViewMode === 'hierarchy' ? C.primary : 'transparent'}; color: ${kpiViewMode === 'hierarchy' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ—ï¸ ê³„ì¸µ êµ¬ì¡°
            </button>
            <button onclick="setKPIViewMode('team')" style="background: ${kpiViewMode === 'team' ? C.primary : 'transparent'}; color: ${kpiViewMode === 'team' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ‘¥ íŒ€ KPI
            </button>
            <button onclick="setKPIViewMode('member')" style="background: ${kpiViewMode === 'member' ? C.primary : 'transparent'}; color: ${kpiViewMode === 'member' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ‘¤ ë‚´ KPI
            </button>
          </div>

          <!-- ë©”ì¸ ì»¨í…ì¸  -->
          <div id="kpi-main-content">
            ${kpiViewMode === 'hierarchy' ? renderKPIHierarchyView(megaProjects, projects, teamKPIs, memberKPIs, C) :
              kpiViewMode === 'team' ? renderTeamKPIView(teamKPIs, projects, memberKPIs, C) :
              renderMemberKPIView(memberKPIs, teamKPIs, projects, members, C)}
          </div>
        </div>
      `;
    }

    function setKPIViewMode(mode) {
      kpiViewMode = mode;
      renderKPIManagement();
    }

    function renderKPIHierarchyView(megaProjects, projects, teamKPIs, memberKPIs, C) {
      if (megaProjects.length === 0) {
        return `
          <div style="text-align: center; padding: 60px; background: ${C.white}; border-radius: 16px; border: 2px dashed ${C.gray200};">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¢</div>
            <div style="font-size: 18px; font-weight: 600; color: ${C.gray900}; margin-bottom: 8px;">ëŒ€í˜•í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”</div>
            <div style="font-size: 14px; color: ${C.gray500}; margin-bottom: 20px;">ì˜ˆ: í•´ì™¸ ìˆ˜ì¶œ (K-ë¸Œëœë“œ í™•ì¥), êµ­ë‚´ í™•ì¥ ë“±</div>
            <button onclick="openMegaProjectModal()" style="padding: 12px 24px; background: ${C.purple}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ğŸ¢ ì²« ëŒ€í˜•í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°
            </button>
          </div>
        `;
      }

      return megaProjects.map(mega => {
        const childProjects = projects.filter(p => p.megaProjectId === mega.id);
        const megaProgress = calculateMegaProjectProgress(mega, childProjects, teamKPIs, memberKPIs);

        return `
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 4px solid ${C.purple};">
            <!-- ëŒ€í˜•í”„ë¡œì íŠ¸ í—¤ë” -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, ${C.purple}, #8B5CF6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ¢</div>
                <div>
                  <div style="font-size: 20px; font-weight: 700; color: ${C.gray900};">${mega.name}</div>
                  <div style="font-size: 13px; color: ${C.gray500};">${mega.description || ''}</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px;">
                ${mega.revenueTarget ? `<div style="text-align: right;"><div style="font-size: 11px; color: ${C.gray500};">ëª©í‘œ ë§¤ì¶œ</div><div style="font-size: 18px; font-weight: 700; color: ${C.purple};">${(mega.revenueTarget / 100000000).toFixed(1)}ì–µ</div></div>` : ''}
                <div style="text-align: right;">
                  <div style="font-size: 11px; color: ${C.gray500};">ì§„í–‰ë¥ </div>
                  <div style="font-size: 18px; font-weight: 700; color: ${megaProgress >= 70 ? C.green : megaProgress >= 40 ? C.yellow : C.red};">${megaProgress}%</div>
                </div>
                <button onclick="openMegaProjectModal(state.megaProjects.find(m=>m.id==='${mega.id}'))" style="padding: 8px 12px; background: ${C.gray50}; border: 1px solid ${C.gray200}; border-radius: 6px; cursor: pointer; font-size: 12px;">í¸ì§‘</button>
              </div>
            </div>

            <!-- í•˜ìœ„ í”„ë¡œì íŠ¸ ëª©ë¡ -->
            <div style="margin-left: 30px; border-left: 2px solid ${C.gray200}; padding-left: 20px;">
              ${childProjects.length === 0 ? `
                <div style="padding: 20px; background: ${C.gray50}; border-radius: 12px; text-align: center;">
                  <div style="color: ${C.gray500}; margin-bottom: 12px;">í•˜ìœ„ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                  <button onclick="openProjectModalV2(null, '${mega.id}')" style="padding: 8px 16px; background: ${C.primary}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">+ í”„ë¡œì íŠ¸ ì¶”ê°€</button>
                </div>
              ` : childProjects.map(project => {
                const projectTeamKPIs = teamKPIs.filter(k => k.projectId === project.id);
                const projectMemberKPIs = memberKPIs.filter(k => k.projectId === project.id);
                const projectProgress = calculateProjectProgress(projectTeamKPIs, projectMemberKPIs);

                return `
                  <div style="background: ${C.gray50}; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                    <!-- í”„ë¡œì íŠ¸ í—¤ë” -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 18px;">ğŸ“</div>
                        <div>
                          <div style="font-size: 16px; font-weight: 600; color: ${C.gray900};">${project.name}</div>
                          ${project.revenueGoal ? `<div style="font-size: 12px; color: ${C.gray500};">ëª©í‘œ ${(project.revenueGoal / 100000000).toFixed(1)}ì–µ</div>` : ''}
                        </div>
                      </div>
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: ${projectProgress >= 70 ? C.green : projectProgress >= 40 ? C.yellow : C.red}20; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; color: ${projectProgress >= 70 ? C.green : projectProgress >= 40 ? C.yellow : C.red};">
                          ${projectProgress}%
                        </div>
                        <button onclick="openProjectModalV2(state.projects.find(p=>p.id==='${project.id}'))" style="padding: 6px 10px; background: ${C.white}; border: 1px solid ${C.gray200}; border-radius: 4px; cursor: pointer; font-size: 11px;">í¸ì§‘</button>
                        <button onclick="openTeamKPIModal(null, '${project.id}')" style="padding: 6px 10px; background: ${C.green}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">+ íŒ€KPI</button>
                      </div>
                    </div>

                    <!-- íŒ€ KPI ëª©ë¡ -->
                    ${projectTeamKPIs.length > 0 ? `
                      <div style="margin-left: 28px;">
                        ${projectTeamKPIs.map(kpi => {
                          const progress = kpi.target > 0 ? Math.min(100, Math.round((kpi.current / kpi.target) * 100)) : 0;
                          const kpiMemberKPIs = memberKPIs.filter(mk => mk.teamKpiId === kpi.id);

                          return `
                            <div style="background: ${C.white}; border-radius: 10px; padding: 14px; margin-bottom: 10px; border-left: 3px solid ${C.green};">
                              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                  <span style="font-size: 14px;">ğŸ‘¥</span>
                                  <span style="font-weight: 600; color: ${C.gray900};">${kpi.name}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                  <span style="font-size: 14px; font-weight: 700; color: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red};">${kpi.current}/${kpi.target} ${kpi.unit || ''}</span>
                                  <button onclick="openTeamKPIModal(state.teamKPIs.find(k=>k.id==='${kpi.id}'))" style="padding: 4px 8px; background: ${C.gray50}; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">í¸ì§‘</button>
                                </div>
                              </div>
                              <div style="background: ${C.gray100}; height: 6px; border-radius: 3px; margin-bottom: 8px;">
                                <div style="background: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red}; height: 100%; width: ${progress}%; border-radius: 3px;"></div>
                              </div>

                              <!-- ê°œì¸ KPI -->
                              ${kpiMemberKPIs.length > 0 ? `
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                  ${kpiMemberKPIs.map(mk => {
                                    const mkProgress = mk.target > 0 ? Math.min(100, Math.round((mk.current / mk.target) * 100)) : 0;
                                    return `
                                      <div style="background: ${C.gray50}; padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 12px; color: ${C.primary}; font-weight: 500;">ğŸ‘¤ ${mk.memberName}</span>
                                        <span style="font-size: 12px; font-weight: 600; color: ${mkProgress >= 100 ? C.green : C.gray700};">${mk.current}/${mk.target}</span>
                                        <button onclick="quickUpdateMemberKPI('${mk.id}', ${mk.current + 1})" style="background: ${C.primary}; color: white; border: none; width: 20px; height: 20px; border-radius: 4px; cursor: pointer; font-size: 12px;">+</button>
                                      </div>
                                    `;
                                  }).join('')}
                                </div>
                              ` : ''}
                            </div>
                          `;
                        }).join('')}
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
              <button onclick="openProjectModalV2(null, '${mega.id}')" style="width: 100%; padding: 12px; background: transparent; border: 2px dashed ${C.gray300}; border-radius: 10px; color: ${C.gray500}; cursor: pointer; font-size: 13px; margin-top: 8px;">
                + í”„ë¡œì íŠ¸ ì¶”ê°€
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // íŒ€ KPI ë·° ë Œë”ë§
    function renderTeamKPIView(teamKPIs, projects, memberKPIs, C) {
      if (teamKPIs.length === 0) {
        return `
          <div style="text-align: center; padding: 60px; background: ${C.white}; border-radius: 16px; border: 2px dashed ${C.gray200};">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¥</div>
            <div style="font-size: 18px; font-weight: 600; color: ${C.gray900}; margin-bottom: 8px;">ë“±ë¡ëœ íŒ€ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 14px; color: ${C.gray500}; margin-bottom: 20px;">íŒ€ KPIë¥¼ ì¶”ê°€í•˜ì—¬ íŒ€ ëª©í‘œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>
            <button onclick="openTeamKPIModal()" style="padding: 12px 24px; background: ${C.green}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              + ì²« íŒ€ KPI ë§Œë“¤ê¸°
            </button>
          </div>
        `;
      }

      // í”„ë¡œì íŠ¸ë³„ë¡œ ê·¸ë£¹í•‘
      const kpisByProject = {};
      teamKPIs.forEach(kpi => {
        const projectId = kpi.projectId || 'unassigned';
        if (!kpisByProject[projectId]) {
          kpisByProject[projectId] = [];
        }
        kpisByProject[projectId].push(kpi);
      });

      return Object.keys(kpisByProject).map(projectId => {
        const project = projects.find(p => p.id === projectId);
        const kpis = kpisByProject[projectId];

        return `
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid ${C.gray100};">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: ${C.green}20; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“</div>
                <div>
                  <div style="font-size: 18px; font-weight: 700; color: ${C.gray900};">${project ? project.name : 'ë¯¸ë°°ì • KPI'}</div>
                  <div style="font-size: 13px; color: ${C.gray500};">íŒ€ KPI ${kpis.length}ê°œ</div>
                </div>
              </div>
              <button onclick="openTeamKPIModal(null, '${projectId}')" style="padding: 8px 16px; background: ${C.green}; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">+ íŒ€ KPI ì¶”ê°€</button>
            </div>

            <div style="display: grid; gap: 16px;">
              ${kpis.map(kpi => {
                const progress = kpi.target > 0 ? Math.min(100, Math.round((kpi.current / kpi.target) * 100)) : 0;
                const kpiMemberKPIs = memberKPIs.filter(mk => mk.teamKpiId === kpi.id);
                const memberProgress = kpiMemberKPIs.length > 0
                  ? Math.round(kpiMemberKPIs.reduce((sum, mk) => sum + Math.min(100, (mk.current / mk.target) * 100), 0) / kpiMemberKPIs.length)
                  : 0;

                return `
                  <div style="background: ${C.gray50}; border-radius: 12px; padding: 20px; border-left: 4px solid ${C.green};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                      <div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                          <span style="font-size: 16px;">ğŸ‘¥</span>
                          <span style="font-size: 16px; font-weight: 700; color: ${C.gray900};">${kpi.name}</span>
                        </div>
                        ${kpi.description ? `<div style="font-size: 13px; color: ${C.gray500}; margin-top: 4px;">${kpi.description}</div>` : ''}
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px; font-weight: 700; color: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red};">
                          ${kpi.current}/${kpi.target} ${kpi.unit || ''}
                        </span>
                        <button onclick="openTeamKPIModal(state.teamKPIs.find(k=>k.id==='${kpi.id}'))" style="padding: 6px 12px; background: ${C.white}; border: 1px solid ${C.gray200}; border-radius: 6px; cursor: pointer; font-size: 12px;">í¸ì§‘</button>
                      </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="font-size: 12px; color: ${C.gray500};">íŒ€ ëª©í‘œ ì§„í–‰ë¥ </span>
                        <span style="font-size: 13px; font-weight: 600; color: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red};">${progress}%</span>
                      </div>
                      <div style="background: ${C.gray200}; height: 8px; border-radius: 4px;">
                        <div style="background: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red}; height: 100%; width: ${progress}%; border-radius: 4px; transition: width 0.3s;"></div>
                      </div>
                    </div>

                    ${kpiMemberKPIs.length > 0 ? `
                      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed ${C.gray200};">
                        <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 12px;">ğŸ‘¤ ì—°ê²°ëœ ê°œì¸ KPI (${kpiMemberKPIs.length}ê°œ)</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                          ${kpiMemberKPIs.map(mk => {
                            const mkProgress = mk.target > 0 ? Math.min(100, Math.round((mk.current / mk.target) * 100)) : 0;
                            return `
                              <div style="background: ${C.white}; padding: 10px 14px; border-radius: 8px; display: flex; align-items: center; gap: 10px; border: 1px solid ${C.gray200};">
                                <span style="font-size: 13px; color: ${C.primary}; font-weight: 600;">ğŸ‘¤ ${mk.memberName}</span>
                                <span style="font-size: 12px; color: ${C.gray500};">${mk.name}</span>
                                <span style="font-size: 13px; font-weight: 600; color: ${mkProgress >= 100 ? C.green : mkProgress >= 70 ? C.yellow : C.red};">${mk.current}/${mk.target}</span>
                                <button onclick="quickUpdateMemberKPI('${mk.id}', ${mk.current + 1})" style="background: ${C.primary}; color: white; border: none; width: 24px; height: 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">+</button>
                              </div>
                            `;
                          }).join('')}
                        </div>
                      </div>
                    ` : `
                      <div style="margin-top: 12px; padding: 12px; background: ${C.white}; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: ${C.gray500}; margin-bottom: 8px;">ì—°ê²°ëœ ê°œì¸ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        <button onclick="openMemberKPIModal(null, '${kpi.id}')" style="padding: 6px 12px; background: ${C.yellow}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">+ ê°œì¸ KPI ì¶”ê°€</button>
                      </div>
                    `}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // ê°œì¸ KPI ë·° ë Œë”ë§
    function renderMemberKPIView(memberKPIs, teamKPIs, projects, members, C) {
      if (memberKPIs.length === 0) {
        return `
          <div style="text-align: center; padding: 60px; background: ${C.white}; border-radius: 16px; border: 2px dashed ${C.gray200};">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¤</div>
            <div style="font-size: 18px; font-weight: 600; color: ${C.gray900}; margin-bottom: 8px;">ë“±ë¡ëœ ê°œì¸ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="font-size: 14px; color: ${C.gray500}; margin-bottom: 20px;">ê°œì¸ KPIë¥¼ ì¶”ê°€í•˜ì—¬ ê°œì¸ ëª©í‘œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>
            <button onclick="openMemberKPIModal()" style="padding: 12px 24px; background: ${C.yellow}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              + ì²« ê°œì¸ KPI ë§Œë“¤ê¸°
            </button>
          </div>
        `;
      }

      // ë‹´ë‹¹ìë³„ë¡œ ê·¸ë£¹í•‘
      const kpisByMember = {};
      memberKPIs.forEach(kpi => {
        const memberName = kpi.memberName || 'ë¯¸ë°°ì •';
        if (!kpisByMember[memberName]) {
          kpisByMember[memberName] = [];
        }
        kpisByMember[memberName].push(kpi);
      });

      return Object.keys(kpisByMember).map(memberName => {
        const kpis = kpisByMember[memberName];
        const totalProgress = kpis.length > 0
          ? Math.round(kpis.reduce((sum, k) => sum + (k.target > 0 ? Math.min(100, (k.current / k.target) * 100) : 0), 0) / kpis.length)
          : 0;
        const achievedCount = kpis.filter(k => k.target > 0 && k.current >= k.target).length;

        return `
          <div style="background: ${C.white}; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid ${C.gray100};">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, ${C.yellow}, #FBBF24); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">ğŸ‘¤</div>
                <div>
                  <div style="font-size: 18px; font-weight: 700; color: ${C.gray900};">${memberName}</div>
                  <div style="font-size: 13px; color: ${C.gray500};">ê°œì¸ KPI ${kpis.length}ê°œ Â· ë‹¬ì„± ${achievedCount}ê°œ</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: ${C.gray500};">í‰ê·  ë‹¬ì„±ë¥ </div>
                  <div style="font-size: 24px; font-weight: 700; color: ${totalProgress >= 100 ? C.green : totalProgress >= 70 ? C.yellow : C.red};">${totalProgress}%</div>
                </div>
                <button onclick="openMemberKPIModal()" style="padding: 8px 16px; background: ${C.yellow}; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">+ KPI ì¶”ê°€</button>
              </div>
            </div>

            <div style="display: grid; gap: 12px;">
              ${kpis.map(kpi => {
                const progress = kpi.target > 0 ? Math.min(100, Math.round((kpi.current / kpi.target) * 100)) : 0;
                const teamKPI = teamKPIs.find(tk => tk.id === kpi.teamKpiId);
                const project = projects.find(p => p.id === kpi.projectId);

                return `
                  <div style="background: ${C.gray50}; border-radius: 12px; padding: 16px; border-left: 4px solid ${C.yellow};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                      <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                          <span style="font-size: 15px; font-weight: 600; color: ${C.gray900};">${kpi.name}</span>
                          ${teamKPI ? `<span style="font-size: 11px; background: ${C.green}20; color: ${C.green}; padding: 2px 8px; border-radius: 10px;">ğŸ‘¥ ${teamKPI.name}</span>` : ''}
                          ${project ? `<span style="font-size: 11px; background: ${C.primary}20; color: ${C.primary}; padding: 2px 8px; border-radius: 10px;">ğŸ“ ${project.name}</span>` : ''}
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                          <div style="flex: 1; max-width: 300px;">
                            <div style="background: ${C.gray200}; height: 8px; border-radius: 4px;">
                              <div style="background: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red}; height: 100%; width: ${progress}%; border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                          </div>
                          <span style="font-size: 14px; font-weight: 700; color: ${progress >= 100 ? C.green : progress >= 70 ? C.yellow : C.red};">
                            ${kpi.current}/${kpi.target} ${kpi.unit || ''}
                          </span>
                        </div>
                      </div>

                      <div style="display: flex; align-items: center; gap: 8px; margin-left: 16px;">
                        <button onclick="quickUpdateMemberKPI('${kpi.id}', ${Math.max(0, kpi.current - 1)})" style="background: ${C.gray200}; color: ${C.gray700}; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">-</button>
                        <button onclick="quickUpdateMemberKPI('${kpi.id}', ${kpi.current + 1})" style="background: ${C.primary}; color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">+</button>
                        <button onclick="openMemberKPIModal(state.memberKPIs.find(k=>k.id==='${kpi.id}'))" style="padding: 8px 12px; background: ${C.white}; border: 1px solid ${C.gray200}; border-radius: 6px; cursor: pointer; font-size: 12px;">í¸ì§‘</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function calculateMegaProjectProgress(mega, childProjects, teamKPIs, memberKPIs) {
      const allKPIs = [];
      childProjects.forEach(p => {
        teamKPIs.filter(k => k.projectId === p.id).forEach(k => allKPIs.push(k));
        memberKPIs.filter(k => k.projectId === p.id).forEach(k => allKPIs.push(k));
      });
      if (allKPIs.length === 0) return 0;
      const totalProgress = allKPIs.reduce((sum, k) => sum + Math.min(100, (k.current / k.target) * 100), 0);
      return Math.round(totalProgress / allKPIs.length);
    }

    function calculateProjectProgress(projectTeamKPIs, projectMemberKPIs) {
      const allKPIs = [...projectTeamKPIs, ...projectMemberKPIs];
      if (allKPIs.length === 0) return 0;
      const totalProgress = allKPIs.reduce((sum, k) => sum + Math.min(100, (k.current / k.target) * 100), 0);
      return Math.round(totalProgress / allKPIs.length);
    }

    async function quickUpdateMemberKPI(kpiId, newValue) {
      try {
        await db.collection('memberKPIs').doc(kpiId).update({ current: newValue, updatedAt: new Date().toISOString() });
        showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ');
      } catch (e) {
        showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
      }
    }

    function renderKPICard(kpi, type) {
      const progress = kpi.target > 0 ? Math.min(100, Math.round((kpi.current / kpi.target) * 100)) : 0;
      const color = progress >= 100 ? '#00C471' : progress >= 70 ? '#F59E0B' : '#F04452';

      return `
        <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-weight: 600; color: var(--gray-900);">${kpi.name}</span>
              ${kpi.memberName ? `<span style="font-size: 11px; background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 10px;">${kpi.memberName}</span>` : ''}
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="flex: 1; background: var(--gray-200); border-radius: 4px; height: 8px;">
                <div style="background: ${color}; height: 100%; width: ${progress}%; border-radius: 4px; transition: width 0.3s;"></div>
              </div>
              <span style="font-size: 13px; font-weight: 600; color: ${color};">${kpi.current}/${kpi.target} ${kpi.unit || ''}</span>
            </div>
          </div>
        </div>
      `;
    }

    function calculateKPIAchievementRate(teamKPIs, memberKPIs) {
      const allKPIs = [...teamKPIs, ...memberKPIs];
      if (allKPIs.length === 0) return 0;
      const achieved = allKPIs.filter(k => k.current >= k.target).length;
      return Math.round((achieved / allKPIs.length) * 100);
    }

    // AI KPI ì¶”ì²œ
    function suggestKPIs() {
      const strategy = state.strategyData || {};
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), #6366F1); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ¤– AI KPI ì¶”ì²œ</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
              <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 8px;">í˜„ì¬ ì „ëµ ëª©í‘œ ê¸°ë°˜ ì¶”ì²œ</div>
              <div style="font-size: 14px; color: var(--gray-700);">ì—° ë§¤ì¶œ ${((strategy.annualRevenue || 500000000) / 100000000).toFixed(1)}ì–µ Â· ì„±ê³µë¥  ${strategy.successRate || 30}%</div>
            </div>

            <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 12px;">ğŸ“‹ ì¶”ì²œ KPI</div>
            <div style="display: grid; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 12px; cursor: pointer;">
                <input type="checkbox" checked style="width: 18px; height: 18px;">
                <div>
                  <div style="font-weight: 600;">ì›”ê°„ ê³µêµ¬ ìˆ˜</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œ: ì›” 30ê±´</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 12px; cursor: pointer;">
                <input type="checkbox" checked style="width: 18px; height: 18px;">
                <div>
                  <div style="font-weight: 600;">ì‹ ê·œ ê³µê¸‰ì‚¬ ê³„ì•½</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œ: ì›” 5ê°œ</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 12px; cursor: pointer;">
                <input type="checkbox" checked style="width: 18px; height: 18px;">
                <div>
                  <div style="font-weight: 600;">ì‹ ê·œ ì…€ëŸ¬ ì˜¨ë³´ë”©</div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œ: ì›” 10ëª…</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 12px; cursor: pointer;">
                <input type="checkbox" style="width: 18px; height: 18px;">
                <div>
                  <div style="font-weight: 600;">ê³µêµ¬ ì„±ê³µë¥ </div>
                  <div style="font-size: 12px; color: var(--gray-500);">ëª©í‘œ: ${strategy.successRate || 30}%</div>
                </div>
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="applyRecommendedKPIs()">ì„ íƒí•œ KPI ì ìš©</button>
          </div>
        </div>
      `;
    }

    function applyRecommendedKPIs() {
      showToast('KPIê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤');
      closeModal();
      renderKPIManagement();
    }

    function openKPIModal() {
      showToast('KPI ì¶”ê°€ ëª¨ë‹¬ ì¤€ë¹„ ì¤‘...');
    }

    function openKPIEditModal(type, name) {
      showToast(`${name} KPI í¸ì§‘ ëª¨ë‹¬ ì¤€ë¹„ ì¤‘...`);
    }

    function filterKPIByMember(memberId) {
      // TODO: í•„í„°ë§ êµ¬í˜„
    }

    // ========================================
    // ì „ëµë¦¬ë·° ì‹œìŠ¤í…œ (ì—­ìˆœ ë°ì´í„° í™•ì¸ + ê°œì¸ë³„ ì„±ê³µë¥ )
    // ========================================
    let reviewViewMode = 'summary'; // summary, reverse, member

    function renderStrategicReview() {
      const container = document.getElementById('reviewContent');
      if (!container) return;

      const C = {
        primary: '#3182f6',
        purple: '#6366F1',
        green: '#00C471',
        yellow: '#F59E0B',
        red: '#F04452',
        gray50: '#F2F4F6',
        gray100: '#E5E8EB',
        gray200: '#D1D6DB',
        gray500: '#6B7684',
        gray700: '#333D4B',
        gray900: '#191F28',
        white: '#FFFFFF'
      };

      // ë°ì´í„° ì§‘ê³„
      const currentYear = new Date().getFullYear();
      const yearGoal = (state.yearlyGoals || []).find(g => g.year === currentYear) || {};
      const megaProjects = state.megaProjects || [];
      const projects = state.projects || [];
      const teamKPIs = state.teamKPIs || [];
      const memberKPIs = state.memberKPIs || [];
      const tasks = state.tasks || [];
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');

      // ì—°ë„ë³„ ëª©í‘œ ë‹¬ì„±ë¥ 
      const yearTarget = yearGoal.revenueTarget || 1000000000;
      const yearSettlements = (state.sellerSettlements || []).filter(s =>
        (s.settlementDate || s.createdAt || '').startsWith(String(currentYear))
      );
      const yearAchieved = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
      const revenueProgress = Math.round((yearAchieved / yearTarget) * 100);

      // KPI ë‹¬ì„±ë¥ 
      const allKPIs = [...teamKPIs, ...memberKPIs];
      const kpiAchieved = allKPIs.filter(k => k.current >= k.target).length;
      const kpiProgress = allKPIs.length > 0 ? Math.round((kpiAchieved / allKPIs.length) * 100) : 0;

      // ì—…ë¬´ ì„±ê³µë¥  (ê¸°í•œ ë‚´ ì™„ë£Œ)
      const completedTasks = tasks.filter(t => t.status === 'complete');
      const successTasks = completedTasks.filter(t => t.isSuccess === true);
      const taskSuccessRate = completedTasks.length > 0 ? Math.round((successTasks.length / completedTasks.length) * 100) : 0;

      // íŒ€ì›ë³„ ì„±ê³µë¥  ê³„ì‚°
      const memberStats = members.map(member => {
        const memberTasks = tasks.filter(t => t.assigneeId === member.id || t.assignee === member.name);
        const memberCompleted = memberTasks.filter(t => t.status === 'complete');
        const memberSuccess = memberCompleted.filter(t => t.isSuccess === true);
        const successRate = memberCompleted.length > 0 ? Math.round((memberSuccess.length / memberCompleted.length) * 100) : 0;

        const myKPIs = memberKPIs.filter(k => k.memberId === member.id);
        const kpiAchievedCount = myKPIs.filter(k => k.current >= k.target).length;

        return {
          ...member,
          totalTasks: memberTasks.length,
          completedTasks: memberCompleted.length,
          successTasks: memberSuccess.length,
          successRate,
          totalKPIs: myKPIs.length,
          kpiAchieved: kpiAchievedCount
        };
      });

      container.innerHTML = `
        <div style="max-width: 1400px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 style="font-size: 24px; font-weight: 700; color: ${C.gray900}; margin: 0;">ğŸ” ì „ëµë¦¬ë·°</h1>
              <p style="color: ${C.gray500}; margin-top: 4px; font-size: 13px;">ì—­ìˆœ ë°ì´í„° í™•ì¸ Â· ê°œì¸ë³„ ì„±ê³µë¥  Â· ë³´ê³ ì„œ ìë™ ìƒì„±</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="generateMemberReport()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.white}; color: ${C.primary}; border: 1px solid ${C.primary}; border-radius: 8px; cursor: pointer;">
                ğŸ“„ ê°œì¸ ë³´ê³ ì„œ
              </button>
              <button onclick="generateAdminReport()" style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: ${C.purple}; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ğŸ“Š ê´€ë¦¬ì ë³´ê³ ì„œ
              </button>
            </div>
          </div>

          <!-- ë·° ëª¨ë“œ ì „í™˜ -->
          <div style="display: flex; gap: 8px; margin-bottom: 20px; background: ${C.gray50}; padding: 4px; border-radius: 10px; width: fit-content;">
            <button onclick="setReviewViewMode('summary')" style="background: ${reviewViewMode === 'summary' ? C.primary : 'transparent'}; color: ${reviewViewMode === 'summary' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ“ˆ ëª©í‘œ ë‹¬ì„± í˜„í™©
            </button>
            <button onclick="setReviewViewMode('reverse')" style="background: ${reviewViewMode === 'reverse' ? C.primary : 'transparent'}; color: ${reviewViewMode === 'reverse' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ”„ ì—­ìˆœ ë°ì´í„°
            </button>
            <button onclick="setReviewViewMode('member')" style="background: ${reviewViewMode === 'member' ? C.primary : 'transparent'}; color: ${reviewViewMode === 'member' ? 'white' : C.gray500}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
              ğŸ‘¤ ê°œì¸ë³„ ì„±ê³µë¥ 
            </button>
          </div>

          <!-- ëª©í‘œ ë‹¬ì„± ìš”ì•½ -->
          <div style="background: linear-gradient(135deg, #1e3a5f, #0f2744); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white;">
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 20px; opacity: 0.9;">ğŸ¯ ${currentYear}ë…„ ëª©í‘œ ë‹¬ì„± í˜„í™© â†’ ìµœì¢… 100ì–µ ë‹¬ì„±</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
              <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">ë§¤ì¶œ ë‹¬ì„±ë¥ </div>
                <div style="font-size: 28px; font-weight: 700; color: ${revenueProgress >= 70 ? C.green : revenueProgress >= 40 ? C.yellow : C.red};">${revenueProgress}%</div>
                <div style="font-size: 11px; opacity: 0.8;">${(yearAchieved / 100000000).toFixed(1)}ì–µ / ${(yearTarget / 100000000).toFixed(0)}ì–µ</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">KPI ë‹¬ì„±ë¥ </div>
                <div style="font-size: 28px; font-weight: 700; color: ${kpiProgress >= 70 ? C.green : kpiProgress >= 40 ? C.yellow : C.red};">${kpiProgress}%</div>
                <div style="font-size: 11px; opacity: 0.8;">${kpiAchieved} / ${allKPIs.length}ê°œ</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">ì—…ë¬´ ì„±ê³µë¥ </div>
                <div style="font-size: 28px; font-weight: 700; color: ${taskSuccessRate >= 70 ? C.green : taskSuccessRate >= 40 ? C.yellow : C.red};">${taskSuccessRate}%</div>
                <div style="font-size: 11px; opacity: 0.8;">${successTasks.length} / ${completedTasks.length}ê±´ (ê¸°í•œ ë‚´ ì™„ë£Œ)</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">í”„ë¡œì íŠ¸ ì§„í–‰</div>
                <div style="font-size: 28px; font-weight: 700;">${projects.length}</div>
                <div style="font-size: 11px; opacity: 0.8;">ëŒ€í˜•í”„ë¡œì íŠ¸ ${megaProjects.length}ê°œ</div>
              </div>
            </div>
          </div>

          <!-- ë©”ì¸ ì»¨í…ì¸  -->
          <div id="review-main-content">
            ${reviewViewMode === 'summary' ? renderReviewSummary(megaProjects, projects, teamKPIs, memberKPIs, tasks, C) :
              reviewViewMode === 'reverse' ? renderReverseDataView(yearGoal, megaProjects, projects, teamKPIs, memberKPIs, tasks, C) :
              renderMemberSuccessRates(memberStats, C)}
          </div>

          <!-- ë³´ê³ ì„œ ìƒì„± ì•ˆë‚´ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 24px;">
            <div style="background: linear-gradient(135deg, ${C.primary}, #1b64da); border-radius: 16px; padding: 24px; color: white;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">ğŸ“„ ê°œì¸ë³„ ì „ëµë¦¬ë·° PPT</div>
                  <div style="font-size: 13px; opacity: 0.9;">ë‚´ KPI â†’ ì—…ë¬´ â†’ ì„±ê³µë¥ ì„ ì •ë¦¬í•œ ë°œí‘œ ìë£Œ</div>
                </div>
                <button onclick="generateMemberReport()" style="padding: 12px 20px; background: white; color: ${C.primary}; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                  ìƒì„±í•˜ê¸°
                </button>
              </div>
            </div>
            <div style="background: linear-gradient(135deg, ${C.purple}, #8B5CF6); border-radius: 16px; padding: 24px; color: white;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">ğŸ“Š ê´€ë¦¬ì í˜„í™© ë³´ê³ ì„œ</div>
                  <div style="font-size: 13px; opacity: 0.9;">ì „ì²´ ì „ëµ í˜„í™© ë° íŒ€ì›ë³„ ë¶„ì„ ë³´ê³ ì„œ</div>
                </div>
                <button onclick="generateAdminReport()" style="padding: 12px 20px; background: white; color: ${C.purple}; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                  ìƒì„±í•˜ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function setReviewViewMode(mode) {
      reviewViewMode = mode;
      renderStrategicReview();
    }

    function renderReviewSummary(megaProjects, projects, teamKPIs, memberKPIs, tasks, C) {
      return `
        <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <div style="font-size: 16px; font-weight: 700; color: ${C.gray900}; margin-bottom: 20px;">ğŸ”„ ì „ëµ â†’ ê²°ê³¼ íë¦„</div>
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ¢</div>
              <div style="font-weight: 600; color: ${C.gray900};">ëŒ€í˜•í”„ë¡œì íŠ¸</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.purple}; margin-top: 8px;">${megaProjects.length}</div>
            </div>
            <div style="font-size: 20px; color: ${C.gray300};">â†’</div>
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“</div>
              <div style="font-weight: 600; color: ${C.gray900};">í”„ë¡œì íŠ¸</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.primary}; margin-top: 8px;">${projects.length}</div>
            </div>
            <div style="font-size: 20px; color: ${C.gray300};">â†’</div>
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ‘¥</div>
              <div style="font-weight: 600; color: ${C.gray900};">íŒ€ KPI</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.green}; margin-top: 8px;">${teamKPIs.length}</div>
            </div>
            <div style="font-size: 20px; color: ${C.gray300};">â†’</div>
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ‘¤</div>
              <div style="font-weight: 600; color: ${C.gray900};">ê°œì¸ KPI</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.yellow}; margin-top: 8px;">${memberKPIs.length}</div>
            </div>
            <div style="font-size: 20px; color: ${C.gray300};">â†’</div>
            <div style="flex: 1; min-width: 150px; text-align: center; padding: 20px; background: ${C.gray50}; border-radius: 12px;">
              <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“</div>
              <div style="font-weight: 600; color: ${C.gray900};">ì—…ë¬´</div>
              <div style="font-size: 24px; font-weight: 700; color: ${C.primary}; margin-top: 8px;">${tasks.length}</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderReverseDataView(yearGoal, megaProjects, projects, teamKPIs, memberKPIs, tasks, C) {
      // ì—­ìˆœ: ìµœì¢…ëª©í‘œ â† ëŒ€í˜•í”„ë¡œì íŠ¸ â† í”„ë¡œì íŠ¸ â† KPI â† ì—…ë¬´
      const yearTarget = yearGoal.revenueTarget || 1000000000;

      // ë¯¸í¡ ì˜ì—­ ë¶„ì„
      const lowPerformingKPIs = [...teamKPIs, ...memberKPIs].filter(k => {
        const progress = k.target > 0 ? (k.current / k.target) * 100 : 0;
        return progress < 50;
      });

      const overdueTasks = tasks.filter(t => {
        if (t.status === 'complete') return false;
        const deadline = t.deadline || t.dueDate;
        if (!deadline) return false;
        return new Date(deadline) < new Date();
      });

      return `
        <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <div style="font-size: 16px; font-weight: 700; color: ${C.gray900}; margin-bottom: 20px;">ğŸ”„ ì—­ìˆœ ë°ì´í„° ë¶„ì„ (ê²°ê³¼ â†’ ì›ì¸)</div>

          <!-- ìµœì¢… ëª©í‘œ -->
          <div style="background: linear-gradient(135deg, #1e3a5f, #0f2744); border-radius: 12px; padding: 20px; color: white; margin-bottom: 16px;">
            <div style="font-size: 14px; opacity: 0.8;">ğŸ¯ ìµœì¢… ëª©í‘œ</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 8px;">${(yearTarget / 100000000).toFixed(0)}ì–µ ë‹¬ì„±</div>
            <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">ì–´ë–¤ ë¶€ë¶„ì´ ë¯¸í¡í•œì§€ í™•ì¸í•˜ê³  ë¹ ë¥´ê²Œ ìˆ˜ì •, ë³´ì™„</div>
          </div>

          <!-- ë¯¸í¡ ì˜ì—­ -->
          <div style="background: ${C.red}10; border: 1px solid ${C.red}30; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
            <div style="font-size: 14px; font-weight: 700; color: ${C.red}; margin-bottom: 12px;">âš ï¸ ë¯¸í¡ ì˜ì—­ (ê¸´ê¸‰ ì¡°ì¹˜ í•„ìš”)</div>

            ${lowPerformingKPIs.length > 0 ? `
              <div style="margin-bottom: 16px;">
                <div style="font-size: 13px; font-weight: 600; color: ${C.gray700}; margin-bottom: 8px;">ğŸ“Š ì§„í–‰ë¥  50% ë¯¸ë§Œ KPI (${lowPerformingKPIs.length}ê±´)</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  ${lowPerformingKPIs.slice(0, 5).map(k => {
                    const progress = k.target > 0 ? Math.round((k.current / k.target) * 100) : 0;
                    return `
                      <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 14px; border-radius: 8px;">
                        <span style="font-size: 13px; color: ${C.gray900};">${k.name}</span>
                        <span style="font-size: 13px; font-weight: 600; color: ${C.red};">${k.current}/${k.target} (${progress}%)</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            ${overdueTasks.length > 0 ? `
              <div>
                <div style="font-size: 13px; font-weight: 600; color: ${C.gray700}; margin-bottom: 8px;">â° ê¸°í•œ ì´ˆê³¼ ì—…ë¬´ (${overdueTasks.length}ê±´)</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  ${overdueTasks.slice(0, 5).map(t => `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 14px; border-radius: 8px;">
                      <span style="font-size: 13px; color: ${C.gray900};">${t.title}</span>
                      <span style="font-size: 12px; color: ${C.red};">ê¸°í•œ: ${t.deadline || t.dueDate}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${lowPerformingKPIs.length === 0 && overdueTasks.length === 0 ? `
              <div style="text-align: center; padding: 20px; color: ${C.green};">
                <div style="font-size: 24px; margin-bottom: 8px;">âœ…</div>
                <div>í˜„ì¬ ê¸´ê¸‰ ì¡°ì¹˜ê°€ í•„ìš”í•œ ë¯¸í¡ ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤!</div>
              </div>
            ` : ''}
          </div>

          <!-- ì—­ìˆœ íë¦„ -->
          <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 16px;">
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">ìµœì¢…ëª©í‘œ</div>
              <div style="font-weight: 600; color: ${C.gray900};">${(yearTarget / 100000000).toFixed(0)}ì–µ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">ëŒ€í˜•í”„ë¡œì íŠ¸</div>
              <div style="font-weight: 600; color: ${C.purple};">${megaProjects.length}ê°œ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">í”„ë¡œì íŠ¸</div>
              <div style="font-weight: 600; color: ${C.primary};">${projects.length}ê°œ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">íŒ€KPI</div>
              <div style="font-weight: 600; color: ${C.green};">${teamKPIs.length}ê°œ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">ê°œì¸KPI</div>
              <div style="font-weight: 600; color: ${C.yellow};">${memberKPIs.length}ê°œ</div>
            </div>
            <div style="color: ${C.gray300};">â†</div>
            <div style="background: ${C.gray50}; padding: 12px 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: ${C.gray500};">ì—…ë¬´</div>
              <div style="font-weight: 600; color: ${C.primary};">${tasks.length}ê±´</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMemberSuccessRates(memberStats, C) {
      return `
        <div style="background: ${C.white}; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <div style="font-size: 16px; font-weight: 700; color: ${C.gray900}; margin-bottom: 20px;">ğŸ‘¤ ê°œì¸ë³„ ì—…ë¬´ ì„±ê³µë¥ </div>

          <div style="display: grid; gap: 16px;">
            ${memberStats.map(m => {
              const rateColor = m.successRate >= 80 ? C.green : m.successRate >= 50 ? C.yellow : C.red;
              return `
                <div style="background: ${C.gray50}; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 20px;">
                  <div style="width: 60px; height: 60px; background: linear-gradient(135deg, ${C.primary}, #1b64da); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
                    ${m.name?.charAt(0) || '?'}
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 18px; font-weight: 700; color: ${C.gray900}; margin-bottom: 8px;">${m.name}</div>
                    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                      <div>
                        <div style="font-size: 11px; color: ${C.gray500};">ì—…ë¬´ ì„±ê³µë¥ </div>
                        <div style="font-size: 16px; font-weight: 700; color: ${rateColor};">${m.successRate}%</div>
                      </div>
                      <div>
                        <div style="font-size: 11px; color: ${C.gray500};">ì™„ë£Œ ì—…ë¬´</div>
                        <div style="font-size: 16px; font-weight: 600; color: ${C.gray900};">${m.completedTasks}ê±´</div>
                      </div>
                      <div>
                        <div style="font-size: 11px; color: ${C.gray500};">ê¸°í•œ ë‚´ ì™„ë£Œ</div>
                        <div style="font-size: 16px; font-weight: 600; color: ${C.green};">${m.successTasks}ê±´</div>
                      </div>
                      <div>
                        <div style="font-size: 11px; color: ${C.gray500};">KPI ë‹¬ì„±</div>
                        <div style="font-size: 16px; font-weight: 600; color: ${C.primary};">${m.kpiAchieved}/${m.totalKPIs}</div>
                      </div>
                    </div>
                  </div>
                  <div style="text-align: center;">
                    <div style="font-size: 36px; font-weight: 700; color: ${rateColor};">${m.successRate}%</div>
                    <div style="font-size: 11px; color: ${C.gray500};">ì„±ê³µë¥ </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          ${memberStats.length === 0 ? `
            <div style="text-align: center; padding: 40px; color: ${C.gray500};">
              <div style="font-size: 32px; margin-bottom: 12px;">ğŸ‘¤</div>
              <div>íŒ€ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function openABTestModal() {
      showToast('A/B í…ŒìŠ¤íŠ¸ ê¸°ë¡ì€ ì—…ë¬´ ë“±ë¡ ì‹œ ë©”ëª¨ì— ì‘ì„±í•´ì£¼ì„¸ìš”');
    }

    function generatePersonalPPT() {
      generateMemberReport();
    }

    // ========================================
    // ì—…ë¬´ì¼ì§€ ì‹œìŠ¤í…œ
    // ========================================
    let workLogTasks = [];
    let workLogMonth = '';

    function getCurrentMember() {
      return {
        id: state.currentUser?.odooId || state.currentUser?.id || 'unknown',
        loginId: state.currentUser?.loginId || '',
        name: state.currentUser?.name || 'ë¯¸ì§€ì •'
      };
    }

    function renderWorkLog() {
      const container = document.getElementById('worklogContent');
      if (!container) return;

      const now = new Date();
      workLogMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      const currentMember = getCurrentMember();
      const isAdmin = state.currentUser?.role === 'admin';

      container.innerHTML = `
        <div style="max-width: 1400px; margin: 0 auto;">
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
              <h1 style="font-size: 26px; font-weight: 700; color: #191F28; margin: 0;">ğŸ““ ì—…ë¬´ì¼ì§€</h1>
              <p style="color: #6B7684; margin-top: 8px; font-size: 15px;">íŒ€ì›ë³„ ì—…ë¬´ ê´€ë¦¬ ë° ìë™ ê¸°ë¡</p>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="openQuickTaskModal()" style="padding: 12px 20px; font-size: 14px; font-weight: 600; background: #0064FF; color: white; border: none; border-radius: 12px; cursor: pointer;">
                â• ìƒˆ ì—…ë¬´
              </button>
            </div>
          </div>

          <!-- ì»¨íŠ¸ë¡¤ ë°” -->
          <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
              <!-- ì›” ì„ íƒ -->
              <div style="display: flex; align-items: center; gap: 10px;">
                <button onclick="changeWorkLogMonth(-1)" style="background: #E5E8EB; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 18px;">â†</button>
                <input type="month" id="worklog-month" value="${workLogMonth}" onchange="loadWorkLogData()" style="padding: 10px 16px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px; font-weight: 600;" />
                <button onclick="changeWorkLogMonth(1)" style="background: #E5E8EB; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 18px;">â†’</button>
              </div>

              <!-- ë©¤ë²„ í•„í„° -->
              <div style="display: flex; gap: 8px; align-items: center;">
                <div style="display: flex; gap: 4px; background: #F2F4F6; padding: 4px; border-radius: 10px;">
                  <button id="filter-my" onclick="setMemberFilter('my')" style="background: ${memberFilter === 'my' ? '#0064FF' : 'transparent'}; color: ${memberFilter === 'my' ? 'white' : '#6B7684'}; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ‘¤ ë‚´ ì—…ë¬´</button>
                  <button id="filter-all" onclick="setMemberFilter('all')" style="background: ${memberFilter === 'all' ? '#0064FF' : 'transparent'}; color: ${memberFilter === 'all' ? 'white' : '#6B7684'}; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ‘¥ ì „ì²´ íŒ€</button>
                </div>
                <select id="member-select" onchange="setMemberFilter('member', this.value)" style="padding: 10px 14px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 13px; font-weight: 600; background: ${memberFilter === 'member' ? '#E8F3FF' : 'white'}; color: #191F28; cursor: pointer;">
                  <option value="">íŒ€ì› ì„ íƒ</option>
                  ${(state.teamMembers || []).filter(m => m.role !== 'ceo' && m.id !== currentMember.id).map(m => `<option value="${m.id}" ${selectedMemberId === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                </select>
              </div>

              <!-- ë·° ì „í™˜ -->
              <div style="display: flex; gap: 8px; background: #F2F4F6; padding: 4px; border-radius: 10px;">
                <button id="view-kanban" onclick="setWorkLogView('kanban')" style="background: ${workLogView === 'kanban' ? '#0064FF' : 'transparent'}; color: ${workLogView === 'kanban' ? 'white' : '#6B7684'}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“‹ ì¹¸ë°˜</button>
                <button id="view-timeline" onclick="setWorkLogView('timeline')" style="background: ${workLogView === 'timeline' ? '#0064FF' : 'transparent'}; color: ${workLogView === 'timeline' ? 'white' : '#6B7684'}; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“ íƒ€ì„ë¼ì¸</button>
              </div>
            </div>
          </div>

          <!-- ì‚¬ìš©ì ì¹´ë“œ -->
          <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; align-items: center; gap: 14px;">
              <div style="width: 48px; height: 48px; background: ${memberFilter === 'all' ? '#FEF3C7' : memberFilter === 'member' ? '#E0E7FF' : '#E8F3FF'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: ${memberFilter === 'all' ? '#F59E0B' : memberFilter === 'member' ? '#6366F1' : '#0064FF'};">${memberFilter === 'all' ? 'ğŸ‘¥' : 'ğŸ‘¤'}</div>
              <div>
                <div style="font-size: 18px; font-weight: 700; color: #191F28;" id="worklog-title">${memberFilter === 'all' ? 'ì „ì²´ íŒ€ ì—…ë¬´' : memberFilter === 'member' ? getSelectedMemberName() + ' ì—…ë¬´' : currentMember.name + ' (ë‚˜)'}</div>
                <div style="font-size: 13px; color: #6B7684;" id="today-summary">ì—…ë¬´ í˜„í™© ë¡œë”©ì¤‘...</div>
              </div>
            </div>
            ${memberFilter !== 'my' ? `<span style="font-size: 12px; padding: 6px 12px; background: #F2F4F6; border-radius: 20px; color: #6B7684;">${memberFilter === 'all' ? 'ì „ì²´ íŒ€ì› ì—…ë¬´ ì¡°íšŒ ì¤‘' : 'ë‹¤ë¥¸ íŒ€ì› ì—…ë¬´ ì¡°íšŒ ì¤‘'}</span>` : ''}
          </div>

          <!-- í†µê³„ ì¹´ë“œ -->
          <div id="worklog-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;"></div>

          <!-- ë©”ì¸ ì»¨í…ì¸  -->
          <div id="worklog-main-content">
            <div style="text-align: center; padding: 60px;"><div class="loading-spinner"></div></div>
          </div>
        </div>
      `;

      loadWorkLogData();
    }

    async function loadWorkLogData() {
      const monthInput = document.getElementById('worklog-month');
      if (!monthInput) return;

      workLogMonth = monthInput.value;
      const [year, month] = workLogMonth.split('-').map(Number);
      const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0];
      const endDate = new Date(year, month, 0).toISOString().split('T')[0];
      const currentMember = getCurrentMember();

      try {
        const snapshot = await db.collection('tasks').get();
        const allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        console.log('ğŸ“‹ [ì—…ë¬´ ë¡œë”©] ì „ì²´:', allTasks.length, 'ê±´');
        console.log('ğŸ“‹ [í˜„ì¬ ì‚¬ìš©ì] id:', currentMember.id, 'loginId:', currentMember.loginId, 'name:', currentMember.name);
        console.log('ğŸ“‹ [í•„í„°] ì›”:', workLogMonth, 'ë‹´ë‹¹ì í•„í„°:', memberFilter);

        // ë‚´ ì—…ë¬´ ë§¤ì¹­ í—¬í¼ í•¨ìˆ˜
        const isMyTask = (task) => {
          // ì´ë¦„ ë§¤ì¹­
          if (task.assignee === currentMember.name) return true;
          // ID ë§¤ì¹­ (ì—¬ëŸ¬ ID í˜•ì‹ í™•ì¸)
          if (task.assigneeId === currentMember.id) return true;
          if (task.assigneeId === currentMember.loginId) return true;
          // loginId í•„ë“œ ë§¤ì¹­
          if (task.assigneeLoginId === currentMember.loginId) return true;
          // ë‹´ë‹¹ì ë¯¸ì§€ì • = ë‚´ ì—…ë¬´
          if (!task.assignee && !task.assigneeId) return true;
          return false;
        };

        // ì›”ë³„ + ë‹´ë‹¹ì í•„í„°
        workLogTasks = allTasks.filter(t => {
          // ë‚ ì§œ í•„í„°: dueDate ë˜ëŠ” createdAt ê¸°ì¤€ (ë‚ ì§œ ì—†ìœ¼ë©´ í†µê³¼)
          const taskDate = t.dueDate || (t.createdAt ? t.createdAt.split('T')[0] : null);
          const inMonth = !taskDate || (taskDate >= startDate && taskDate <= endDate);

          // ë‹´ë‹¹ì í•„í„°
          if (memberFilter === 'all') {
            return inMonth; // ì „ì²´ íŒ€: ë‚ ì§œë§Œ í•„í„°
          } else if (memberFilter === 'member' && selectedMemberId) {
            // íŠ¹ì • íŒ€ì› ì„ íƒ
            const selectedMember = (state.teamMembers || []).find(m => m.id === selectedMemberId);
            const isSelectedMember = t.assignee === selectedMember?.name ||
                                     t.assigneeId === selectedMemberId ||
                                     t.assigneeLoginId === selectedMember?.loginId;
            return inMonth && isSelectedMember;
          } else {
            // ë‚´ ì—…ë¬´
            return inMonth && isMyTask(t);
          }
        });

        console.log('ğŸ“‹ [ê²°ê³¼] í•„í„°ë§ í›„:', workLogTasks.length, 'ê±´');
        if (allTasks.length > 0 && workLogTasks.length === 0) {
          console.log('ğŸ“‹ [ì°¸ê³ ] ì „ì²´ ì—…ë¬´ ìƒ˜í”Œ:', allTasks.slice(0, 3));
        }

        renderWorkLogStats();
        renderWorkLogContent();
      } catch (e) {
        console.error('ì—…ë¬´ì¼ì§€ ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }

    function renderWorkLogStats() {
      const statsEl = document.getElementById('worklog-stats');
      const summaryEl = document.getElementById('today-summary');
      if (!statsEl) return;

      const counts = { waiting: 0, progress: 0, complete: 0, hold: 0 };
      workLogTasks.forEach(t => {
        const status = t.status || 'waiting';
        if (counts[status] !== undefined) counts[status]++;
      });

      statsEl.innerHTML = TASK_COLUMNS.map(col => `
        <div style="background: ${col.bg}; border-radius: 12px; padding: 16px; text-align: center;">
          <div style="font-size: 24px; margin-bottom: 8px;">${col.icon}</div>
          <div style="font-size: 28px; font-weight: 700; color: ${col.color};">${counts[col.id]}</div>
          <div style="font-size: 13px; color: #6B7684;">${col.label}</div>
        </div>
      `).join('');

      if (summaryEl) {
        const today = new Date().toISOString().split('T')[0];
        const todayComplete = workLogTasks.filter(t => t.status === 'complete' && t.completedAt?.startsWith(today)).length;
        summaryEl.textContent = `ì˜¤ëŠ˜ ì™„ë£Œ: ${todayComplete}ê±´ | ì§„í–‰ì¤‘: ${counts.progress}ê±´`;
      }
    }

    function renderWorkLogContent() {
      const container = document.getElementById('worklog-main-content');
      if (!container) return;

      if (workLogView === 'kanban') {
        renderKanbanView(container);
      } else {
        renderTimelineView(container);
      }
    }

    function renderKanbanView(container) {
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
          ${TASK_COLUMNS.map(col => {
            const tasks = workLogTasks.filter(t => (t.status || 'waiting') === col.id);
            return `
              <div style="background: ${col.bg}; border-radius: 16px; padding: 16px; min-height: 400px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <div style="font-weight: 700; color: ${col.color};">${col.icon} ${col.label}</div>
                  <span style="background: ${col.color}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${tasks.length}</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  ${tasks.length === 0 ? `
                    <div style="text-align: center; padding: 40px 20px; color: #8B95A1; font-size: 13px;">ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                  ` : tasks.map(task => {
                    const deadline = task.deadline || task.dueDate;
                    let deadlineBadge = '';
                    let cardBorder = '';
                    if (deadline && task.status !== 'complete') {
                      const now = new Date();
                      const deadlineDate = new Date(deadline);
                      const diffDays = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
                      if (diffDays < 0) {
                        deadlineBadge = '<span style="background: #F04452; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">ì´ˆê³¼</span>';
                        cardBorder = 'border-left: 3px solid #F04452;';
                      } else if (diffDays === 0) {
                        deadlineBadge = '<span style="background: #F59E0B; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">ì˜¤ëŠ˜</span>';
                        cardBorder = 'border-left: 3px solid #F59E0B;';
                      } else if (diffDays <= 3) {
                        deadlineBadge = `<span style="background: #F59E0B20; color: #F59E0B; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">D-${diffDays}</span>`;
                        cardBorder = 'border-left: 3px solid #F59E0B;';
                      }
                    }
                    if (task.isSuccess === true) {
                      deadlineBadge = '<span style="background: #00C47120; color: #00C471; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">âœ“ ì„±ê³µ</span>';
                    } else if (task.isSuccess === false) {
                      deadlineBadge = '<span style="background: #F0445220; color: #F04452; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">ê¸°í•œì´ˆê³¼</span>';
                    }

                    return `
                      <div onclick="openTaskDetailModal('${task.id}')" style="background: white; border-radius: 12px; padding: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.06); ${cardBorder}">
                        <div style="font-weight: 600; color: #191F28; margin-bottom: 8px; font-size: 14px;">${task.title || 'ì œëª© ì—†ìŒ'}</div>
                        ${deadline ? `<div style="font-size: 12px; color: #8B95A1; display: flex; align-items: center;">ğŸ“… ${deadline} ${deadlineBadge}</div>` : ''}
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px;">
                          ${task.kpiId ? `<span style="font-size: 10px; padding: 2px 8px; background: #E8F3FF; border-radius: 4px; color: #0064FF;">ğŸ“Š KPI ì—°ê²°</span>` : ''}
                          ${task.category ? `<span style="font-size: 10px; padding: 2px 8px; background: #F2F4F6; border-radius: 4px; color: #6B7684;">${task.category}</span>` : ''}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderTimelineView(container) {
      const sortedTasks = [...workLogTasks].sort((a, b) => (b.dueDate || '').localeCompare(a.dueDate || ''));

      container.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 24px;">
          ${sortedTasks.length === 0 ? `
            <div style="text-align: center; padding: 60px; color: #8B95A1;">ì´ë²ˆ ë‹¬ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          ` : sortedTasks.map(task => {
            const col = TASK_COLUMNS.find(c => c.id === (task.status || 'waiting')) || TASK_COLUMNS[0];
            return `
              <div onclick="openTaskDetailModal('${task.id}')" style="display: flex; gap: 16px; padding: 16px; border-bottom: 1px solid #E5E8EB; cursor: pointer;">
                <div style="font-size: 20px;">${col.icon}</div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #191F28;">${task.title || 'ì œëª© ì—†ìŒ'}</div>
                  <div style="font-size: 13px; color: #8B95A1; margin-top: 4px;">
                    ${task.dueDate || 'ë‚ ì§œ ë¯¸ì •'} ${task.category ? `Â· ${task.category}` : ''}
                  </div>
                </div>
                <span style="background: ${col.bg}; color: ${col.color}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; height: fit-content;">${col.label}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function setWorkLogView(view) {
      workLogView = view;
      ['kanban', 'timeline'].forEach(v => {
        const btn = document.getElementById('view-' + v);
        if (btn) {
          btn.style.background = view === v ? '#0064FF' : 'transparent';
          btn.style.color = view === v ? 'white' : '#6B7684';
        }
      });
      renderWorkLogContent();
    }

    function setMemberFilter(filter, memberId = null) {
      memberFilter = filter;
      selectedMemberId = memberId;

      // íŒ€ì› ì„ íƒ ë“œë¡­ë‹¤ìš´ ë¦¬ì…‹
      const memberSelect = document.getElementById('member-select');
      if (memberSelect) {
        if (filter === 'member' && memberId) {
          memberSelect.style.background = '#E8F3FF';
        } else {
          memberSelect.value = '';
          memberSelect.style.background = 'white';
        }
      }

      // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      ['all', 'my'].forEach(f => {
        const btn = document.getElementById('filter-' + f);
        if (btn) {
          const isActive = filter === f;
          btn.style.background = isActive ? '#0064FF' : 'transparent';
          btn.style.color = isActive ? 'white' : '#6B7684';
        }
      });

      renderWorkLog(); // ì „ì²´ ì¬ë Œë”ë§ (ì¹´ë“œ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸ ìœ„í•´)
    }

    function getSelectedMemberName() {
      if (!selectedMemberId) return '';
      const member = (state.teamMembers || []).find(m => m.id === selectedMemberId);
      return member?.name || 'íŒ€ì›';
    }

    function changeWorkLogMonth(delta) {
      const input = document.getElementById('worklog-month');
      if (!input) return;

      let [year, month] = input.value.split('-').map(Number);
      month += delta;
      if (month > 12) { month = 1; year++; }
      if (month < 1) { month = 12; year--; }
      input.value = year + '-' + String(month).padStart(2, '0');
      loadWorkLogData();
    }

    function openQuickTaskModal() {
      const today = new Date().toISOString().split('T')[0];
      const currentMember = getCurrentMember();
      const isAdmin = state.currentUser?.role === 'admin';

      // KPI í•„í„°ë§: memberId, loginId, name ë“± ì—¬ëŸ¬ í•„ë“œë¡œ ë§¤ì¹­
      const allMemberKPIs = state.memberKPIs || [];
      const memberKPIs = isAdmin ? allMemberKPIs : allMemberKPIs.filter(k =>
        k.memberId === currentMember.id ||
        k.memberId === currentMember.loginId ||
        k.memberName === currentMember.name ||
        k.memberId === state.currentUser?.loginId
      );

      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
          <div class="modal-header" style="background: #0064FF; color: white;">
            <h2 class="modal-title" style="color: white;">â• ìƒˆ ì—…ë¬´ ì¶”ê°€</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ì—…ë¬´ ì œëª© *</label>
              <input type="text" id="taskTitle" placeholder="ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
            </div>

            <!-- KPI ì—°ê²° -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“Š KPI ì—°ê²°</label>
              <select id="taskKpiId" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
                <option value="">ì—°ê²° ì•ˆí•¨</option>
                ${memberKPIs.map(k => `<option value="${k.id}">${k.name} (${k.current}/${k.target} ${k.unit || ''})</option>`).join('')}
              </select>
              <div style="font-size: 11px; color: #8B95A1; margin-top: 4px;">ğŸ’¡ KPIë¥¼ ì—°ê²°í•˜ë©´ ì—…ë¬´ ì™„ë£Œ ì‹œ ìë™ìœ¼ë¡œ ì§„ì²™ë„ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“… ì™„ë£Œ ëª©í‘œ ê¸°í•œ *</label>
                <input type="date" id="taskDeadline" value="${today}" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;" required>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ìƒíƒœ</label>
                <select id="taskStatus" onchange="handleStatusChange()" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
                  <option value="waiting">â³ ëŒ€ê¸°</option>
                  <option value="progress">ğŸ”„ ì§„í–‰ì¤‘</option>
                  <option value="complete">âœ… ì™„ë£Œ</option>
                  <option value="hold">â¸ï¸ ë³´ë¥˜</option>
                </select>
              </div>
            </div>

            <div id="startDateContainer" style="margin-bottom: 16px; display: none;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸš€ ì‹œì‘ì¼ (ìë™ ì„¤ì •)</label>
              <input type="date" id="taskStartDate" value="${today}" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px; background: #F2F4F6;" readonly>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">êµ¬ë¶„</label>
              <input type="text" id="taskCategory" placeholder="ì˜ˆ: ì˜ì—…, ê°œë°œ, ë§ˆì¼€íŒ…" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“ ì‹œí–‰ì°©ì˜¤ / AÂ·B í…ŒìŠ¤íŠ¸ ë©”ëª¨</label>
              <textarea id="taskNotes" rows="3" placeholder="ì—…ë¬´ ì§„í–‰ ì¤‘ ë°°ìš´ ì , ì‹œí–‰ì°©ì˜¤, A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”"
                style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;"></textarea>
            </div>
          </div>
          <div class="modal-footer" style="border-top: 1px solid #E5E8EB; padding: 16px 24px;">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveQuickTask()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    function handleStatusChange() {
      const status = document.getElementById('taskStatus').value;
      const startDateContainer = document.getElementById('startDateContainer');
      const startDateInput = document.getElementById('taskStartDate');

      if (status === 'progress') {
        startDateContainer.style.display = 'block';
        startDateInput.value = new Date().toISOString().split('T')[0];
      } else {
        startDateContainer.style.display = 'none';
      }
    }

    async function saveQuickTask() {
      const title = document.getElementById('taskTitle').value.trim();
      const deadline = document.getElementById('taskDeadline').value;
      const status = document.getElementById('taskStatus').value;
      const category = document.getElementById('taskCategory').value.trim();
      const kpiId = document.getElementById('taskKpiId').value;
      const notes = document.getElementById('taskNotes').value.trim();
      const startDate = document.getElementById('taskStartDate')?.value || '';

      if (!title) { showToast('ì—…ë¬´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
      if (!deadline) { showToast('ì™„ë£Œ ëª©í‘œ ê¸°í•œì„ ì„¤ì •í•˜ì„¸ìš”'); return; }

      const currentMember = getCurrentMember();

      try {
        const taskData = {
          title,
          deadline,
          dueDate: deadline,
          status,
          category,
          notes,
          assignee: currentMember.name,
          assigneeId: currentMember.id,
          createdAt: new Date().toISOString(),
          source: 'strategy-worklog'
        };

        // KPI ì—°ê²°
        if (kpiId) {
          const kpi = (state.memberKPIs || []).find(k => k.id === kpiId);
          if (kpi) {
            taskData.kpiId = kpiId;
            taskData.kpiName = kpi.name;
            taskData.teamKpiId = kpi.teamKpiId;
            taskData.projectId = kpi.projectId;
          }
        }

        // ì§„í–‰ì¤‘ ìƒíƒœë©´ ì‹œì‘ì¼ ìë™ ì„¤ì •
        if (status === 'progress') {
          taskData.startDate = startDate || new Date().toISOString().split('T')[0];
        }

        // ì™„ë£Œ ìƒíƒœë©´ ì™„ë£Œì¼, ì„±ê³µ/ì‹¤íŒ¨ íŒì •
        if (status === 'complete') {
          const now = new Date();
          const deadlineDate = new Date(deadline);
          taskData.completedAt = now.toISOString();
          taskData.isSuccess = now <= deadlineDate; // ê¸°í•œ ë‚´ ì™„ë£Œ = ì„±ê³µ
        }

        await db.collection('tasks').add(taskData);
        showToast('ì—…ë¬´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        loadWorkLogData();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    function openTaskDetailModal(taskId) {
      const task = workLogTasks.find(t => t.id === taskId);
      if (!task) return;

      const col = TASK_COLUMNS.find(c => c.id === (task.status || 'waiting')) || TASK_COLUMNS[0];
      const currentMember = getCurrentMember();
      const isAdmin = state.currentUser?.role === 'admin';
      const allMembers = state.teamMembers || [];

      // KPI í•„í„°ë§: memberId, loginId, name ë“± ì—¬ëŸ¬ í•„ë“œë¡œ ë§¤ì¹­ (ê´€ë¦¬ìëŠ” ëª¨ë“  KPI í‘œì‹œ)
      const allMemberKPIs = state.memberKPIs || [];
      const memberKPIs = isAdmin ? allMemberKPIs : allMemberKPIs.filter(k =>
        k.memberId === currentMember.id ||
        k.memberId === currentMember.loginId ||
        k.memberName === currentMember.name ||
        k.memberId === state.currentUser?.loginId
      );

      // ë§ˆê°ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
      const deadline = task.deadline || task.dueDate;
      let deadlineInfo = '';
      if (deadline) {
        const now = new Date();
        const deadlineDate = new Date(deadline);
        const diffDays = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) {
          deadlineInfo = `<span style="color: #F04452; font-weight: 600;">${Math.abs(diffDays)}ì¼ ì´ˆê³¼</span>`;
        } else if (diffDays === 0) {
          deadlineInfo = `<span style="color: #F59E0B; font-weight: 600;">ì˜¤ëŠ˜ ë§ˆê°!</span>`;
        } else if (diffDays <= 3) {
          deadlineInfo = `<span style="color: #F59E0B;">D-${diffDays}</span>`;
        } else {
          deadlineInfo = `<span style="color: #00C471;">D-${diffDays}</span>`;
        }
      }

      // ë³€ê²½ íˆìŠ¤í† ë¦¬ ë Œë”ë§
      const history = task.history || [];
      const historyHtml = history.length > 0 ? `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E8EB;">
          <div style="font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
            <span>ğŸ“‹</span> ë³€ê²½ íˆìŠ¤í† ë¦¬ (${history.length})
          </div>
          <div style="max-height: 150px; overflow-y: auto; font-size: 12px;">
            ${history.slice().reverse().map(h => `
              <div style="padding: 8px 10px; background: #F9FAFB; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid ${h.type === 'assignee' ? '#8B5CF6' : '#F59E0B'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #6B7684;">${h.type === 'assignee' ? 'ğŸ‘¤ ë‹´ë‹¹ì ë³€ê²½' : 'ğŸ“… ê¸°í•œ ë³€ê²½'}</span>
                  <span style="color: #8B95A1; font-size: 11px;">${new Date(h.changedAt).toLocaleString('ko-KR')}</span>
                </div>
                <div style="margin-top: 4px; color: #333D4B;">
                  <span style="text-decoration: line-through; color: #8B95A1;">${h.from || 'ì—†ìŒ'}</span>
                  <span style="color: #8B95A1;"> â†’ </span>
                  <span style="font-weight: 600;">${h.to || 'ì—†ìŒ'}</span>
                </div>
                <div style="font-size: 11px; color: #8B95A1; margin-top: 2px;">ë³€ê²½ì: ${h.changedBy || 'ì‹œìŠ¤í…œ'}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : '';

      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
          <div class="modal-header" style="background: ${col.color}; color: white;">
            <h2 class="modal-title" style="color: white;">${col.icon} ${task.title || 'ì—…ë¬´ ìƒì„¸'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; max-height: 70vh; overflow-y: auto;">
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div style="background: #F2F4F6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                <div><span style="color: #6B7684;">ğŸ“… ì™„ë£Œ ê¸°í•œ:</span> <strong>${deadline || 'ë¯¸ì •'}</strong> ${deadlineInfo}</div>
                <div><span style="color: #6B7684;">ğŸ‘¤ ë‹´ë‹¹ì:</span> <strong>${task.assignee || 'ë¯¸ì •'}</strong></div>
                ${task.startDate ? `<div><span style="color: #6B7684;">ğŸš€ ì‹œì‘ì¼:</span> ${task.startDate}</div>` : ''}
                ${task.completedAt ? `<div><span style="color: #6B7684;">âœ… ì™„ë£Œì¼:</span> ${task.completedAt.split('T')[0]}</div>` : ''}
                ${task.category ? `<div><span style="color: #6B7684;">ğŸ·ï¸ êµ¬ë¶„:</span> ${task.category}</div>` : ''}
                ${task.isSuccess !== undefined ? `<div><span style="color: #6B7684;">ğŸ“Š ê²°ê³¼:</span> ${task.isSuccess ? '<span style="color: #00C471; font-weight: 600;">ì„±ê³µ âœ“</span>' : '<span style="color: #F04452; font-weight: 600;">ê¸°í•œ ì´ˆê³¼</span>'}</div>` : ''}
              </div>
            </div>

            <!-- ê´€ë¦¬ì ì „ìš©: ë‹´ë‹¹ì ë°°ì • -->
            ${isAdmin ? `
              <div style="background: linear-gradient(135deg, #8B5CF6, #A78BFA); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">ğŸ‘‘ ê´€ë¦¬ì ì „ìš©</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: white; margin-bottom: 4px;">ğŸ‘¤ ë‹´ë‹¹ì ë°°ì •</label>
                    <select id="editTaskAssignee" style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 14px;">
                      <option value="">ë¯¸ë°°ì •</option>
                      ${allMembers.filter(m => m.role !== 'ceo').map(m => `
                        <option value="${m.id}" ${task.assigneeId === m.id ? 'selected' : ''}>${m.name || m.id}</option>
                      `).join('')}
                    </select>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: white; margin-bottom: 4px;">ğŸ“… ì™„ë£Œê¸°í•œ ìˆ˜ì •</label>
                    <input type="date" id="editTaskDeadline" value="${deadline || ''}"
                      style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 14px;">
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- KPI ì—°ê²° ì •ë³´ -->
            ${task.kpiId ? `
              <div style="background: #E8F3FF; border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 16px;">ğŸ“Š</span>
                <div>
                  <div style="font-size: 12px; color: #0064FF;">ì—°ê²°ëœ KPI</div>
                  <div style="font-weight: 600; color: #191F28;">${task.kpiName || 'KPI ì—°ê²°ë¨'}</div>
                </div>
              </div>
            ` : ''}

            <!-- ìƒíƒœ ë³€ê²½ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ìƒíƒœ ë³€ê²½</label>
              <select id="editTaskStatus" onchange="handleDetailStatusChange('${taskId}')" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
                ${TASK_COLUMNS.map(c => `<option value="${c.id}" ${task.status === c.id ? 'selected' : ''}>${c.icon} ${c.label}</option>`).join('')}
              </select>
            </div>

            <!-- ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½ ì‹œ ì‹œì‘ì¼ í‘œì‹œ -->
            <div id="detailStartDateContainer" style="display: ${task.status === 'progress' ? 'block' : 'none'}; margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸš€ ì‹œì‘ì¼</label>
              <input type="date" id="editTaskStartDate" value="${task.startDate || new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px; background: #F2F4F6;">
            </div>

            <!-- KPI ë³€ê²½ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“Š KPI ì—°ê²°</label>
              <select id="editTaskKpiId" style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 15px;">
                <option value="">ì—°ê²° ì•ˆí•¨</option>
                ${memberKPIs.map(k => `<option value="${k.id}" ${task.kpiId === k.id ? 'selected' : ''}>${k.name} (${k.current}/${k.target})</option>`).join('')}
              </select>
            </div>

            <!-- ì‹œí–‰ì°©ì˜¤/ë©”ëª¨ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ“ ì‹œí–‰ì°©ì˜¤ / ë©”ëª¨</label>
              <textarea id="editTaskNotes" rows="3" placeholder="ì—…ë¬´ ì§„í–‰ ì¤‘ ë°°ìš´ ì , ì‹œí–‰ì°©ì˜¤ ë“±"
                style="width: 100%; padding: 12px; border: 1px solid #E5E8EB; border-radius: 10px; font-size: 14px;">${task.notes || ''}</textarea>
            </div>

            <!-- ë³€ê²½ íˆìŠ¤í† ë¦¬ -->
            ${historyHtml}
          </div>
          <div class="modal-footer" style="border-top: 1px solid #E5E8EB; padding: 16px 24px; display: flex; justify-content: space-between;">
            <button onclick="deleteTask('${taskId}')" style="background: #FEE2E4; color: #F04452; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">ì‚­ì œ</button>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
              <button class="btn btn-primary" onclick="updateTaskStatus('${taskId}')">ì €ì¥</button>
            </div>
          </div>
        </div>
      `;
    }

    function handleDetailStatusChange(taskId) {
      const status = document.getElementById('editTaskStatus').value;
      const startDateContainer = document.getElementById('detailStartDateContainer');
      const startDateInput = document.getElementById('editTaskStartDate');

      if (status === 'progress') {
        startDateContainer.style.display = 'block';
        if (!startDateInput.value) {
          startDateInput.value = new Date().toISOString().split('T')[0];
        }
      } else {
        startDateContainer.style.display = 'none';
      }
    }

    async function updateTaskStatus(taskId) {
      const status = document.getElementById('editTaskStatus').value;
      const kpiId = document.getElementById('editTaskKpiId')?.value || '';
      const notes = document.getElementById('editTaskNotes')?.value || '';
      const startDate = document.getElementById('editTaskStartDate')?.value || '';

      // ê´€ë¦¬ì ì „ìš© í•„ë“œ
      const newAssigneeId = document.getElementById('editTaskAssignee')?.value || '';
      const newDeadline = document.getElementById('editTaskDeadline')?.value || '';

      const task = workLogTasks.find(t => t.id === taskId);
      if (!task) return;

      const isAdmin = state.currentUser?.role === 'admin';
      const currentUser = state.currentUser;
      const allMembers = state.teamMembers || [];

      try {
        const updateData = {
          status,
          notes,
          updatedAt: new Date().toISOString()
        };

        // ë³€ê²½ íˆìŠ¤í† ë¦¬ ë°°ì—´ ì´ˆê¸°í™”
        const history = task.history || [];

        // ê´€ë¦¬ì ì „ìš©: ë‹´ë‹¹ì ë³€ê²½ ì²˜ë¦¬
        if (isAdmin && newAssigneeId !== undefined) {
          const oldAssigneeId = task.assigneeId || '';
          if (newAssigneeId !== oldAssigneeId) {
            const oldMember = allMembers.find(m => m.id === oldAssigneeId);
            const newMember = allMembers.find(m => m.id === newAssigneeId);

            // íˆìŠ¤í† ë¦¬ ê¸°ë¡
            history.push({
              type: 'assignee',
              from: oldMember?.name || task.assignee || 'ë¯¸ë°°ì •',
              to: newMember?.name || 'ë¯¸ë°°ì •',
              changedBy: currentUser?.name || currentUser?.loginId || 'ê´€ë¦¬ì',
              changedAt: new Date().toISOString()
            });

            // ë‹´ë‹¹ì ì •ë³´ ì—…ë°ì´íŠ¸
            if (newAssigneeId) {
              updateData.assigneeId = newAssigneeId;
              updateData.assignee = newMember?.name || '';
              updateData.assigneeLoginId = newMember?.loginId || '';
            } else {
              updateData.assigneeId = null;
              updateData.assignee = null;
              updateData.assigneeLoginId = null;
            }
          }
        }

        // ê´€ë¦¬ì ì „ìš©: ì™„ë£Œê¸°í•œ ë³€ê²½ ì²˜ë¦¬
        if (isAdmin && newDeadline !== undefined) {
          const oldDeadline = task.deadline || task.dueDate || '';
          if (newDeadline !== oldDeadline) {
            // íˆìŠ¤í† ë¦¬ ê¸°ë¡
            history.push({
              type: 'deadline',
              from: oldDeadline || 'ë¯¸ì •',
              to: newDeadline || 'ë¯¸ì •',
              changedBy: currentUser?.name || currentUser?.loginId || 'ê´€ë¦¬ì',
              changedAt: new Date().toISOString()
            });

            // ê¸°í•œ ì—…ë°ì´íŠ¸
            updateData.deadline = newDeadline || null;
            updateData.dueDate = newDeadline || null;
          }
        }

        // íˆìŠ¤í† ë¦¬ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì €ì¥
        if (history.length > (task.history?.length || 0)) {
          updateData.history = history;
        }

        // KPI ì—°ê²° ì—…ë°ì´íŠ¸
        if (kpiId) {
          const kpi = (state.memberKPIs || []).find(k => k.id === kpiId);
          if (kpi) {
            updateData.kpiId = kpiId;
            updateData.kpiName = kpi.name;
            updateData.teamKpiId = kpi.teamKpiId;
            updateData.projectId = kpi.projectId;
          }
        } else {
          updateData.kpiId = null;
          updateData.kpiName = null;
        }

        // ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½ ì‹œ ì‹œì‘ì¼ ìë™ ì„¤ì •
        if (status === 'progress' && task.status !== 'progress') {
          updateData.startDate = startDate || new Date().toISOString().split('T')[0];
        }

        // ì™„ë£Œ ì‹œ ì™„ë£Œì¼ ë° ì„±ê³µ/ì‹¤íŒ¨ íŒì •
        if (status === 'complete' && task.status !== 'complete') {
          const now = new Date();
          const deadline = task.deadline || task.dueDate;
          updateData.completedAt = now.toISOString();

          if (deadline) {
            const deadlineDate = new Date(deadline);
            updateData.isSuccess = now <= deadlineDate;
          } else {
            updateData.isSuccess = true; // ë§ˆê°ì¼ ì—†ìœ¼ë©´ ì„±ê³µìœ¼ë¡œ
          }

          // KPI ìë™ ì—…ë°ì´íŠ¸ (ì—°ê²°ëœ ê²½ìš°)
          if (kpiId && updateData.isSuccess) {
            const kpi = (state.memberKPIs || []).find(k => k.id === kpiId);
            if (kpi) {
              await db.collection('memberKPIs').doc(kpiId).update({
                current: (kpi.current || 0) + 1,
                updatedAt: new Date().toISOString()
              });
            }
          }
        }

        await db.collection('tasks').doc(taskId).update(updateData);

        const statusMsg = status === 'complete'
          ? (updateData.isSuccess ? 'ì—…ë¬´ ì™„ë£Œ! ğŸ‰ (ê¸°í•œ ë‚´ ì„±ê³µ)' : 'ì—…ë¬´ ì™„ë£Œ (ê¸°í•œ ì´ˆê³¼)')
          : 'ì—…ë¬´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤';
        showToast(statusMsg);
        closeModal();
        loadWorkLogData();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteTask(taskId) {
      if (!confirm('ì´ ì—…ë¬´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        await db.collection('tasks').doc(taskId).delete();
        showToast('ì—…ë¬´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        loadWorkLogData();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // [DEPRECATED] ì „ëµê¸°íš í—¬í¼ í•¨ìˆ˜ - ë¯¸ì‚¬ìš©
    // ========================================
    function toggleEditMode(section) {
      if (section === 'essence') {
        const el = document.getElementById('essenceGoal');
        if (!el) return;
        if (el.querySelector('textarea')) {
          // ì €ì¥ ëª¨ë“œ
          const textarea = el.querySelector('textarea');
          const value = textarea.value.trim();
          el.innerHTML = value;
          db.collection('settings').doc('strategy').set({ essenceGoal: value }, { merge: true })
            .then(() => showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤'))
            .catch(e => showToast('ì €ì¥ ì‹¤íŒ¨'));
        } else {
          // í¸ì§‘ ëª¨ë“œ
          const currentValue = el.textContent.trim();
          el.innerHTML = `<textarea style="width: 100%; min-height: 80px; font-size: inherit; font-weight: inherit; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; color: white; resize: vertical;">${currentValue}</textarea>`;
          el.querySelector('textarea').focus();
        }
      } else if (section === 'allocation') {
        showToast('ì„±ì¥/ì˜ì—… ë¹„ìœ¨ì€ ìˆ«ìë¥¼ í´ë¦­í•˜ì—¬ í¸ì§‘í•˜ì„¸ìš”');
      }
    }

    function openDomainStrategyModal() {
      const strategy = state.strategyData || {};
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">ğŸ§­ 4ì¶• ë„ë©”ì¸ ì „ëµ í¸ì§‘</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div style="padding: 20px; display: grid; gap: 16px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ‡°ğŸ‡· êµ­ë‚´ ê³µê¸‰ì‚¬</label>
              <textarea id="domainDomestic" class="form-input" rows="2" placeholder="êµ­ë‚´ ê³µê¸‰ì‚¬ ì „ëµ">${strategy.domesticStrategy || 'êµ­ë‚´ ìš°ìˆ˜ ë¸Œëœë“œ ë°œêµ´ ë° ë…ì  ê³„ì•½'}</textarea>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">âœˆï¸ í•´ì™¸ ì§ìˆ˜ì…</label>
              <textarea id="domainImport" class="form-input" rows="2" placeholder="í•´ì™¸ ì§ìˆ˜ì… ì „ëµ">${strategy.importStrategy || 'ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ìƒí’ˆ ì„ ì œ í™•ë³´'}</textarea>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸŒ í•´ì™¸ ìˆ˜ì¶œ</label>
              <textarea id="domainExport" class="form-input" rows="2" placeholder="í•´ì™¸ ìˆ˜ì¶œ ì „ëµ">${strategy.exportStrategy || 'K-ë¸Œëœë“œ ê¸€ë¡œë²Œ ì§„ì¶œ ì§€ì›'}</textarea>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; color: #333D4B; margin-bottom: 6px;">ğŸ¥• ë‹¹ê·¼ Ã— ëª¨ì—¬ë¼ë”œ</label>
              <textarea id="domainPlatform" class="form-input" rows="2" placeholder="í”Œë«í¼ ì „ëµ">${strategy.platformStrategy || 'ì§€ì—­ ê¸°ë°˜ ê³µë™êµ¬ë§¤ í™œì„±í™”'}</textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveDomainStrategy()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveDomainStrategy() {
      try {
        await db.collection('settings').doc('strategy').set({
          domesticStrategy: document.getElementById('domainDomestic').value.trim(),
          importStrategy: document.getElementById('domainImport').value.trim(),
          exportStrategy: document.getElementById('domainExport').value.trim(),
          platformStrategy: document.getElementById('domainPlatform').value.trim()
        }, { merge: true });
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderStrategicPlanning();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    function formatDateKR(dateString) {
      if (!dateString) return 'ë‚ ì§œ ì—†ìŒ';
      try {
        const d = new Date(dateString);
        return d.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
      } catch (e) {
        return dateString;
      }
    }

    async function activateVersion(versionId) {
      if (!confirm('ì´ ë²„ì „ì„ í˜„ì¬ ë²„ì „ìœ¼ë¡œ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const versions = state.strategyVersions || [];
        versions.forEach(v => {
          v.status = v.id === versionId ? 'active' : 'archived';
        });
        await db.collection('settings').doc('strategyVersions').set({ versions });
        state.strategyVersions = versions;

        // í•´ë‹¹ ë²„ì „ì˜ ë°ì´í„° ë³µì›
        const activeVersion = versions.find(v => v.id === versionId);
        if (activeVersion?.data) {
          await db.collection('settings').doc('strategy').set(activeVersion.data, { merge: true });
          state.strategyData = { ...state.strategyData, ...activeVersion.data };
        }

        closeModal();
        renderStrategicPlanning();
        showToast('ë²„ì „ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error(e);
        showToast('ë²„ì „ ì ìš© ì‹¤íŒ¨');
      }
    }

    function viewVersionDetail(versionId) {
      const versions = state.strategyVersions || [];
      const version = versions.find(v => v.id === versionId);
      if (!version) return;

      const data = version.data || {};
      const m = document.getElementById('modal');
      if (!m) { showToast('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">ğŸ“‹ ë²„ì „ ìƒì„¸: ${version.name}</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom: 20px;">
              <div style="font-size: 13px; color: var(--gray-500);">ìƒì„±ì¼</div>
              <div style="font-weight: 600; color: var(--gray-900);">${formatDateKR(version.createdAt)}</div>
            </div>
            ${version.reason ? `
              <div style="margin-bottom: 20px;">
                <div style="font-size: 13px; color: var(--gray-500);">ë³€ê²½ ì‚¬ìœ </div>
                <div style="color: var(--gray-700);">${version.reason}</div>
              </div>
            ` : ''}
            <div style="background: var(--gray-50); border-radius: 12px; padding: 16px;">
              <div style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">ğŸ“Š ì €ì¥ëœ ì„¤ì •</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                <div>ì—°ë§¤ì¶œ ëª©í‘œ: <strong>${((data.annualRevenue || 0) / 100000000).toFixed(1)}ì–µ</strong></div>
                <div>ìˆœìµ ëª©í‘œ: <strong>${((data.annualProfit || 0) / 10000).toLocaleString()}ë§Œ</strong></div>
                <div>ì„±ê³µë¥  ëª©í‘œ: <strong>${data.successRate || 0}%</strong></div>
                <div>ì„±ì¥/ì˜ì—…: <strong>${data.growthRatio || 90}:${100 - (data.growthRatio || 90)}</strong></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="openVersionHistoryModal()">â† ë’¤ë¡œ</button>
            ${version.status !== 'active' ? `<button class="btn btn-primary" onclick="activateVersion('${versionId}')">ì´ ë²„ì „ ì ìš©</button>` : ''}
          </div>
        </div>
      `;
    }

    // ========================================
    // ì—°ë„ë³„ ëª©í‘œ ê´€ë¦¬ ì‹œìŠ¤í…œ
    // ========================================
    function renderYearlyGoalsDashboard() {
      const goals = state.yearlyGoals || [];
      const currentYear = new Date().getFullYear();
      const isAdmin = state.currentUser?.role === 'admin';

      // ì—°ë„ë³„ ëª©í‘œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ìƒì„± ì•ˆë‚´
      const displayYears = [2026, 2027, 2028];

      // ê° ì—°ë„ë³„ ë°ì´í„° ì¤€ë¹„
      const yearData = displayYears.map(year => {
        const goal = goals.find(g => g.year === year) || {
          year,
          revenueTarget: year === 2026 ? 1000000000 : year === 2027 ? 3000000000 : 6000000000,
          salesRatio: 70,
          growthRatio: 30,
          achieved: 0
        };

        // í•´ë‹¹ ì—°ë„ ë‹¬ì„±ì•¡ ê³„ì‚° (ì •ì‚° ë°ì´í„° ê¸°ë°˜)
        const yearStr = String(year);
        const yearSettlements = (state.sellerSettlements || []).filter(s =>
          (s.settlementDate || s.createdAt || '').startsWith(yearStr)
        );
        const achieved = yearSettlements.reduce((sum, s) => sum + (Number(s.salesAmount) || 0), 0);
        goal.achieved = achieved;

        return goal;
      });

      // ìµœì¢… ëª©í‘œ (2028ë…„ 100ì–µ)
      const finalGoal = 10000000000;
      const totalAchieved = yearData.reduce((sum, y) => sum + (y.achieved || 0), 0);
      const totalTarget = yearData.reduce((sum, y) => sum + (y.revenueTarget || 0), 0);

      return `
        <div style="background: linear-gradient(135deg, #1e3a5f, #0f2744); border-radius: 16px; padding: 24px; margin-bottom: 20px; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px;">ğŸ¯ ë³¸ì§ˆì˜ ëª©í‘œ</div>
              <div style="font-size: 22px; font-weight: 700;">2028ë…„ê¹Œì§€ 100ì–µ ë‹¬ì„±</div>
            </div>
            ${isAdmin ? `<button onclick="openYearlyGoalModal()" style="padding: 10px 18px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">âš™ï¸ ëª©í‘œ ì„¤ì •</button>` : ''}
          </div>

          <!-- ì—°ë„ë³„ ëª©í‘œ ì¹´ë“œ -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
            ${yearData.map(goal => {
              const progress = goal.revenueTarget > 0 ? Math.min(100, Math.round((goal.achieved / goal.revenueTarget) * 100)) : 0;
              const isCurrentYear = goal.year === currentYear;
              return `
                <div style="background: ${isCurrentYear ? 'rgba(255,255,255,0.15)' : 'rgba(255,255,255,0.08)'}; border-radius: 12px; padding: 16px; ${isCurrentYear ? 'border: 2px solid rgba(255,255,255,0.4);' : ''}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 18px; font-weight: 700;">${goal.year}ë…„</div>
                    ${isCurrentYear ? '<span style="font-size: 10px; background: #00C471; padding: 2px 8px; border-radius: 10px;">í˜„ì¬</span>' : ''}
                  </div>
                  <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">${(goal.revenueTarget / 100000000).toFixed(0)}ì–µ</div>
                  <div style="font-size: 11px; opacity: 0.7; margin-bottom: 12px;">
                    ì˜ì—… ${goal.salesRatio || 70}% Â· ì„±ì¥ ${goal.growthRatio || 30}%
                  </div>
                  <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: ${progress >= 70 ? '#00C471' : progress >= 40 ? '#F59E0B' : '#F04452'}; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                    <span>ë‹¬ì„± ${(goal.achieved / 100000000).toFixed(1)}ì–µ</span>
                    <span style="font-weight: 600;">${progress}%</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <!-- ìµœì¢… ëª©í‘œ ì§„í–‰ë¥  -->
          <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-size: 14px;">ğŸ† ìµœì¢… ëª©í‘œ ì§„í–‰ë¥ </span>
              <span style="font-size: 14px; font-weight: 700;">${(totalAchieved / 100000000).toFixed(1)}ì–µ / 100ì–µ</span>
            </div>
            <div style="background: rgba(255,255,255,0.2); height: 12px; border-radius: 6px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #00C471, #10B981); height: 100%; width: ${Math.min(100, (totalAchieved / finalGoal) * 100)}%; border-radius: 6px;"></div>
            </div>
          </div>
        </div>
      `;
    }

    function openYearlyGoalModal() {
      const goals = state.yearlyGoals || [];
      const displayYears = [2025, 2026, 2027, 2028, 2029, 2030];

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #1e3a5f, #0f2744); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ¯ ì—°ë„ë³„ ëª©í‘œ ì„¤ì •</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px; max-height: 70vh; overflow-y: auto;">
            <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
              <div style="font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">ğŸ“Œ ë³¸ì§ˆ ëª©í‘œ</div>
              <div style="font-size: 13px; color: var(--gray-600);">2028ë…„ê¹Œì§€ 100ì–µ ë‹¬ì„± Â· ì´í›„ 150ì–µ ëª©í‘œ ê²€í† </div>
            </div>

            <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">ì—°ë„ë³„ ëª©í‘œì•¡ ë° ë¹„ìœ¨ ì„¤ì •</div>
            <div style="display: grid; gap: 16px;">
              ${displayYears.map(year => {
                const existing = goals.find(g => g.year === year) || {};
                const defaultTarget = year === 2026 ? 10 : year === 2027 ? 30 : year === 2028 ? 60 : 0;
                return `
                  <div style="background: var(--gray-50); border-radius: 12px; padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                      <div style="font-size: 16px; font-weight: 700; color: var(--gray-900); min-width: 60px;">${year}ë…„</div>
                      <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="goal-${year}-revenue" value="${existing.revenueTarget ? existing.revenueTarget / 100000000 : defaultTarget}"
                          style="width: 80px; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                        <span style="font-size: 14px; color: var(--gray-600);">ì–µì›</span>
                      </div>
                    </div>
                    <div style="display: flex; gap: 16px;">
                      <div style="flex: 1;">
                        <label style="display: block; font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ğŸ’° ì˜ì—… ë¹„ìœ¨ (%)</label>
                        <input type="number" id="goal-${year}-sales" value="${existing.salesRatio || 70}" min="0" max="100"
                          style="width: 100%; padding: 8px; border: 1px solid var(--gray-300); border-radius: 6px;"
                          onchange="document.getElementById('goal-${year}-growth').value = 100 - this.value">
                      </div>
                      <div style="flex: 1;">
                        <label style="display: block; font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ğŸŒ± ì„±ì¥ ë¹„ìœ¨ (%)</label>
                        <input type="number" id="goal-${year}-growth" value="${existing.growthRatio || 30}" min="0" max="100"
                          style="width: 100%; padding: 8px; border: 1px solid var(--gray-300); border-radius: 6px;"
                          onchange="document.getElementById('goal-${year}-sales').value = 100 - this.value">
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveYearlyGoals()">ğŸ’¾ ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveYearlyGoals() {
      const displayYears = [2025, 2026, 2027, 2028, 2029, 2030];

      try {
        for (const year of displayYears) {
          const revenueEl = document.getElementById(`goal-${year}-revenue`);
          const salesEl = document.getElementById(`goal-${year}-sales`);
          const growthEl = document.getElementById(`goal-${year}-growth`);

          if (!revenueEl) continue;

          const revenue = parseFloat(revenueEl.value) || 0;
          if (revenue <= 0) continue;

          const goalData = {
            year,
            revenueTarget: revenue * 100000000,
            salesRatio: parseInt(salesEl?.value) || 70,
            growthRatio: parseInt(growthEl?.value) || 30,
            updatedAt: new Date().toISOString()
          };

          // ê¸°ì¡´ ë¬¸ì„œ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒˆë¡œ ìƒì„±
          const existing = (state.yearlyGoals || []).find(g => g.year === year);
          if (existing?.id) {
            await db.collection('yearlyGoals').doc(existing.id).update(goalData);
          } else {
            goalData.createdAt = new Date().toISOString();
            await db.collection('yearlyGoals').add(goalData);
          }
        }

        showToast('ì—°ë„ë³„ ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error('ì—°ë„ë³„ ëª©í‘œ ì €ì¥ ì˜¤ë¥˜:', e);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ========================================
    // ëŒ€í˜•í”„ë¡œì íŠ¸ â†’ í”„ë¡œì íŠ¸ ê³„ì¸µ êµ¬ì¡°
    // ========================================
    function openMegaProjectModal(megaProject = null) {
      const isEdit = !!megaProject;
      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white;">
            <h2 class="modal-title" style="color: white;">${isEdit ? 'ğŸ¢ ëŒ€í˜•í”„ë¡œì íŠ¸ ìˆ˜ì •' : 'ğŸ¢ ëŒ€í˜•í”„ë¡œì íŠ¸ ì¶”ê°€'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="megaProjectId" value="${megaProject?.id || ''}">

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">í”„ë¡œì íŠ¸ëª… *</label>
              <input type="text" id="megaProjectName" value="${megaProject?.name || ''}" placeholder="ì˜ˆ: í•´ì™¸ ìˆ˜ì¶œ (K-ë¸Œëœë“œ í™•ì¥)"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì„¤ëª…</label>
              <textarea id="megaProjectDesc" rows="2" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª…"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">${megaProject?.description || ''}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œ ë§¤ì¶œì•¡ (ì–µ)</label>
                <input type="number" id="megaProjectRevenue" value="${megaProject?.revenueTarget ? megaProject.revenueTarget / 100000000 : ''}" placeholder="5"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì—°ê²° ì—°ë„</label>
                <select id="megaProjectYear" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
                  <option value="">ì„ íƒ</option>
                  ${[2025, 2026, 2027, 2028, 2029, 2030].map(y => `<option value="${y}" ${megaProject?.year === y ? 'selected' : ''}>${y}ë…„</option>`).join('')}
                </select>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì‹œì‘ì¼</label>
                <input type="date" id="megaProjectStart" value="${megaProject?.startDate || ''}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì¢…ë£Œì¼</label>
                <input type="date" id="megaProjectEnd" value="${megaProject?.endDate || ''}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteMegaProject('${megaProject.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveMegaProject()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveMegaProject() {
      const id = document.getElementById('megaProjectId').value;
      const name = document.getElementById('megaProjectName').value.trim();

      if (!name) {
        showToast('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const data = {
        name,
        description: document.getElementById('megaProjectDesc').value.trim(),
        revenueTarget: (parseFloat(document.getElementById('megaProjectRevenue').value) || 0) * 100000000,
        year: parseInt(document.getElementById('megaProjectYear').value) || null,
        startDate: document.getElementById('megaProjectStart').value,
        endDate: document.getElementById('megaProjectEnd').value,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('megaProjects').doc(id).update(data);
        } else {
          data.createdAt = new Date().toISOString();
          data.status = 'active';
          await db.collection('megaProjects').add(data);
        }
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteMegaProject(id) {
      if (!confirm('ì´ ëŒ€í˜•í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•˜ìœ„ í”„ë¡œì íŠ¸ì™€ KPIë„ ì—°ê²°ì´ í•´ì œë©ë‹ˆë‹¤.')) return;

      try {
        await db.collection('megaProjects').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // í”„ë¡œì íŠ¸ ëª¨ë‹¬ (ëŒ€í˜•í”„ë¡œì íŠ¸ ì—°ê²°)
    function openProjectModalV2(project = null, megaProjectId = null) {
      const isEdit = !!project;
      const megaProjects = state.megaProjects || [];

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header" style="background: var(--primary); color: white;">
            <h2 class="modal-title" style="color: white;">${isEdit ? 'ğŸ“ í”„ë¡œì íŠ¸ ìˆ˜ì •' : 'ğŸ“ í”„ë¡œì íŠ¸ ì¶”ê°€'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="projectIdV2" value="${project?.id || ''}">

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ìƒìœ„ ëŒ€í˜•í”„ë¡œì íŠ¸ *</label>
              <select id="projectMegaId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${megaProjects.map(mp => `<option value="${mp.id}" ${(project?.megaProjectId === mp.id || megaProjectId === mp.id) ? 'selected' : ''}>${mp.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">í”„ë¡œì íŠ¸ëª… *</label>
              <input type="text" id="projectNameV2" value="${project?.name || ''}" placeholder="ì˜ˆ: ì¼ë³¸ ìˆ˜ì¶œ ì§„í–‰"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì„¤ëª…</label>
              <textarea id="projectDescV2" rows="2" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª…"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">${project?.description || ''}</textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œ ë§¤ì¶œ (ì–µ)</label>
                <input type="number" id="projectRevenueV2" value="${project?.revenueGoal ? project.revenueGoal / 100000000 : ''}" placeholder="2"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì‹œì‘ì¼</label>
                <input type="date" id="projectStartV2" value="${project?.startDate || ''}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì¢…ë£Œì¼</label>
                <input type="date" id="projectEndV2" value="${project?.endDate || ''}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteProjectV2('${project.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveProjectV2()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    async function saveProjectV2() {
      const id = document.getElementById('projectIdV2').value;
      const megaProjectId = document.getElementById('projectMegaId').value;
      const name = document.getElementById('projectNameV2').value.trim();

      if (!megaProjectId) {
        showToast('ìƒìœ„ ëŒ€í˜•í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      if (!name) {
        showToast('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const data = {
        megaProjectId,
        name,
        description: document.getElementById('projectDescV2').value.trim(),
        revenueGoal: (parseFloat(document.getElementById('projectRevenueV2').value) || 0) * 100000000,
        startDate: document.getElementById('projectStartV2').value,
        endDate: document.getElementById('projectEndV2').value,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('projects').doc(id).update(data);
        } else {
          data.createdAt = new Date().toISOString();
          data.status = 'active';
          await db.collection('projects').add(data);
        }
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteProjectV2(id) {
      if (!confirm('ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('projects').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // íŒ€ KPI â†’ ê°œì¸ KPI ì—°ê²° ì‹œìŠ¤í…œ
    // ========================================
    function openTeamKPIModal(kpi = null, projectId = null) {
      const isEdit = !!kpi;
      const projects = state.projects || [];
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');

      // ê¸°ì¡´ ë°°ì •ëœ ë©¤ë²„
      const assignedMembers = kpi?.assignedMembers || [];

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 650px;">
          <div class="modal-header" style="background: #10B981; color: white;">
            <h2 class="modal-title" style="color: white;">${isEdit ? 'ğŸ‘¥ íŒ€ KPI ìˆ˜ì •' : 'ğŸ‘¥ íŒ€ KPI ì¶”ê°€'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="teamKpiId" value="${kpi?.id || ''}">

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì—°ê²° í”„ë¡œì íŠ¸ *</label>
              <select id="teamKpiProjectId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${projects.map(p => `<option value="${p.id}" ${(kpi?.projectId === p.id || projectId === p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">KPI ì´ë¦„ *</label>
              <input type="text" id="teamKpiName" value="${kpi?.name || ''}" placeholder="ì˜ˆ: ì¼ë³¸ ì¸í”Œë£¨ì–¸ì„œ 20ëª… í™•ë³´"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œê°’ *</label>
                <input type="number" id="teamKpiTarget" value="${kpi?.target || ''}" placeholder="20"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">í˜„ì¬ê°’</label>
                <input type="number" id="teamKpiCurrent" value="${kpi?.current || 0}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ë‹¨ìœ„</label>
                <input type="text" id="teamKpiUnit" value="${kpi?.unit || 'ê±´'}" placeholder="ëª…, ê±´, ê°œ"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
            </div>

            <!-- íŒ€ì› ë°°ì • -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">ğŸ‘¤ ë‹´ë‹¹ íŒ€ì› ë°°ì • (ê°œì¸ KPIë¡œ ë¶„ë°°)</label>
              <div style="background: var(--gray-50); border-radius: 12px; padding: 16px;">
                ${members.map(member => {
                  const assigned = assignedMembers.find(a => a.memberId === member.id);
                  return `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px;">
                      <input type="checkbox" id="assign-${member.id}" ${assigned ? 'checked' : ''} onchange="toggleMemberAssignment('${member.id}')"
                        style="width: 18px; height: 18px;">
                      <span style="flex: 1; font-weight: 500;">${member.name}</span>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="assign-target-${member.id}" value="${assigned?.target || ''}" placeholder="ëª©í‘œ"
                          style="width: 70px; padding: 8px; border: 1px solid var(--gray-300); border-radius: 6px; ${!assigned ? 'opacity: 0.5;' : ''}"
                          ${!assigned ? 'disabled' : ''}>
                        <span style="font-size: 12px; color: var(--gray-500);">${kpi?.unit || 'ê±´'}</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              <div style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">
                ğŸ’¡ ì²´í¬í•œ íŒ€ì›ì—ê²Œ ê°œì¸ KPIê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤. ê°œì¸ ëª©í‘œ í•©ê³„ê°€ íŒ€ KPI ëª©í‘œê°€ ë©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteTeamKPI('${kpi.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveTeamKPI()">ì €ì¥</button>
          </div>
        </div>
      `;
    }

    function toggleMemberAssignment(memberId) {
      const checkbox = document.getElementById(`assign-${memberId}`);
      const targetInput = document.getElementById(`assign-target-${memberId}`);

      if (checkbox.checked) {
        targetInput.disabled = false;
        targetInput.style.opacity = '1';
      } else {
        targetInput.disabled = true;
        targetInput.style.opacity = '0.5';
        targetInput.value = '';
      }
    }

    async function saveTeamKPI() {
      const id = document.getElementById('teamKpiId').value;
      const projectId = document.getElementById('teamKpiProjectId').value;
      const name = document.getElementById('teamKpiName').value.trim();
      const target = parseInt(document.getElementById('teamKpiTarget').value) || 0;
      const current = parseInt(document.getElementById('teamKpiCurrent').value) || 0;
      const unit = document.getElementById('teamKpiUnit').value.trim() || 'ê±´';

      if (!projectId) {
        showToast('í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      if (!name) {
        showToast('KPI ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      // ë°°ì •ëœ ë©¤ë²„ ìˆ˜ì§‘
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');
      const assignedMembers = [];

      members.forEach(member => {
        const checkbox = document.getElementById(`assign-${member.id}`);
        const targetInput = document.getElementById(`assign-target-${member.id}`);

        if (checkbox?.checked) {
          assignedMembers.push({
            memberId: member.id,
            memberName: member.name,
            target: parseInt(targetInput?.value) || 0
          });
        }
      });

      const teamKpiData = {
        projectId,
        name,
        target,
        current,
        unit,
        assignedMembers,
        updatedAt: new Date().toISOString()
      };

      try {
        let teamKpiId = id;

        if (id) {
          await db.collection('teamKPIs').doc(id).update(teamKpiData);
        } else {
          teamKpiData.createdAt = new Date().toISOString();
          const docRef = await db.collection('teamKPIs').add(teamKpiData);
          teamKpiId = docRef.id;
        }

        // ê°œì¸ KPI ìë™ ìƒì„±/ì—…ë°ì´íŠ¸
        for (const assigned of assignedMembers) {
          const memberKpiData = {
            teamKpiId,
            projectId,
            memberId: assigned.memberId,
            memberName: assigned.memberName,
            name: `${name} (${assigned.memberName})`,
            target: assigned.target,
            current: 0,
            unit,
            updatedAt: new Date().toISOString()
          };

          // ê¸°ì¡´ ê°œì¸ KPI ì°¾ê¸°
          const existingQuery = await db.collection('memberKPIs')
            .where('teamKpiId', '==', teamKpiId)
            .where('memberId', '==', assigned.memberId)
            .get();

          if (!existingQuery.empty) {
            await db.collection('memberKPIs').doc(existingQuery.docs[0].id).update(memberKpiData);
          } else {
            memberKpiData.createdAt = new Date().toISOString();
            await db.collection('memberKPIs').add(memberKpiData);
          }
        }

        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderKPIManagement();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteTeamKPI(id) {
      if (!confirm('ì´ íŒ€ KPIë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ê²°ëœ ê°œì¸ KPIë„ ì‚­ì œë©ë‹ˆë‹¤.')) return;

      try {
        // ì—°ê²°ëœ ê°œì¸ KPI ì‚­ì œ
        const memberKPIs = await db.collection('memberKPIs').where('teamKpiId', '==', id).get();
        const batch = db.batch();
        memberKPIs.docs.forEach(doc => batch.delete(doc.ref));
        batch.delete(db.collection('teamKPIs').doc(id));
        await batch.commit();

        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderKPIManagement();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // ê°œì¸ KPI ëª¨ë‹¬ ì‹œìŠ¤í…œ
    // ========================================
    function openMemberKPIModal(kpi = null, teamKpiId = null) {
      const isEdit = !!kpi;
      const projects = state.projects || [];
      const teamKPIs = state.teamKPIs || [];
      const members = (state.teamMembers || []).filter(m => m.role === 'admin' || m.role === 'manager');

      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
          <div class="modal-header" style="background: #F59E0B; color: white;">
            <h2 class="modal-title" style="color: white;">${isEdit ? 'ğŸ‘¤ ê°œì¸ KPI ìˆ˜ì •' : 'ğŸ‘¤ ê°œì¸ KPI ì¶”ê°€'}</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <input type="hidden" id="memberKpiId" value="${kpi?.id || ''}">

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ë‹´ë‹¹ì *</label>
              <select id="memberKpiMemberId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${members.map(member => `<option value="${member.id}" data-name="${member.name}" ${kpi?.memberId === member.id ? 'selected' : ''}>${member.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì—°ê²° íŒ€ KPI (ì„ íƒ)</label>
              <select id="memberKpiTeamKpiId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                <option value="">ì—†ìŒ (ë…ë¦½ ê°œì¸ KPI)</option>
                ${teamKPIs.map(tk => `<option value="${tk.id}" data-project="${tk.projectId}" ${(kpi?.teamKpiId === tk.id || teamKpiId === tk.id) ? 'selected' : ''}>${tk.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì—°ê²° í”„ë¡œì íŠ¸ (ì„ íƒ)</label>
              <select id="memberKpiProjectId" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                ${projects.map(p => `<option value="${p.id}" ${kpi?.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
              </select>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">KPI ì´ë¦„ *</label>
              <input type="text" id="memberKpiName" value="${kpi?.name || ''}" placeholder="ì˜ˆ: ì¸í”Œë£¨ì–¸ì„œ 5ëª… í™•ë³´"
                style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ëª©í‘œê°’ *</label>
                <input type="number" id="memberKpiTarget" value="${kpi?.target || ''}" placeholder="10"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">í˜„ì¬ê°’</label>
                <input type="number" id="memberKpiCurrent" value="${kpi?.current || 0}"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ë‹¨ìœ„</label>
                <input type="text" id="memberKpiUnit" value="${kpi?.unit || 'ê±´'}" placeholder="ëª…, ê±´, ê°œ"
                  style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px;">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button class="btn" style="background: var(--danger-light); color: var(--danger);" onclick="deleteMemberKPI('${kpi.id}')">ì‚­ì œ</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveMemberKPI()">ì €ì¥</button>
          </div>
        </div>
      `;

      // íŒ€ KPI ì„ íƒ ì‹œ í”„ë¡œì íŠ¸ ìë™ ì—°ê²°
      document.getElementById('memberKpiTeamKpiId').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const projectId = selectedOption.dataset.project;
        if (projectId) {
          document.getElementById('memberKpiProjectId').value = projectId;
        }
      });
    }

    async function saveMemberKPI() {
      const id = document.getElementById('memberKpiId').value;
      const memberSelect = document.getElementById('memberKpiMemberId');
      const memberId = memberSelect.value;
      const memberName = memberSelect.options[memberSelect.selectedIndex]?.dataset?.name || '';
      const teamKpiId = document.getElementById('memberKpiTeamKpiId').value || null;
      const projectId = document.getElementById('memberKpiProjectId').value || null;
      const name = document.getElementById('memberKpiName').value.trim();
      const target = parseInt(document.getElementById('memberKpiTarget').value) || 0;
      const current = parseInt(document.getElementById('memberKpiCurrent').value) || 0;
      const unit = document.getElementById('memberKpiUnit').value.trim() || 'ê±´';

      if (!memberId) {
        showToast('ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      if (!name) {
        showToast('KPI ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      if (target <= 0) {
        showToast('ëª©í‘œê°’ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const memberKpiData = {
        memberId,
        memberName,
        teamKpiId,
        projectId,
        name,
        target,
        current,
        unit,
        updatedAt: new Date().toISOString()
      };

      try {
        if (id) {
          await db.collection('memberKPIs').doc(id).update(memberKpiData);
        } else {
          memberKpiData.createdAt = new Date().toISOString();
          await db.collection('memberKPIs').add(memberKpiData);
        }

        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderKPIManagement();
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function deleteMemberKPI(id) {
      if (!confirm('ì´ ê°œì¸ KPIë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await db.collection('memberKPIs').doc(id).delete();
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        closeModal();
        renderKPIManagement();
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // ========================================
    // ë³´ê³ ì„œ ìë™ ìƒì„± ì‹œìŠ¤í…œ
    // ========================================
    function generateMemberReport() {
      const member = state.currentUser;
      const memberName = member?.name || 'ì‚¬ìš©ì';
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];

      // ê°œì¸ KPI ë°ì´í„°
      const myKPIs = (state.memberKPIs || []).filter(k =>
        k.memberId === member?.id || k.memberName === memberName
      );

      // ë‚´ ì—…ë¬´ ë°ì´í„°
      const myTasks = (state.tasks || []).filter(t =>
        t.assignee === member?.id || t.assigneeName === memberName
      );

      const completedTasks = myTasks.filter(t => t.status === 'done');
      const inProgressTasks = myTasks.filter(t => t.status === 'progress');
      const pendingTasks = myTasks.filter(t => t.status === 'todo');

      // ì„±ê³µë¥  ê³„ì‚°
      const tasksWithDeadline = myTasks.filter(t => t.deadline && t.status === 'done');
      const successTasks = tasksWithDeadline.filter(t => {
        const completed = t.completedAt || t.updatedAt;
        return completed && completed <= t.deadline;
      });
      const successRate = tasksWithDeadline.length > 0
        ? Math.round((successTasks.length / tasksWithDeadline.length) * 100)
        : 0;

      // HTML ë³´ê³ ì„œ ìƒì„±
      const reportHTML = `
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°œì¸ ì„±ê³¼ ë³´ê³ ì„œ - ${memberName} (${dateStr})</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Pretendard', -apple-system, sans-serif; background: #f5f7fa; padding: 40px; color: #1e293b; }
    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #1e3a5f, #0f2744); color: white; padding: 32px; }
    .header h1 { font-size: 24px; margin-bottom: 8px; }
    .header .subtitle { opacity: 0.8; font-size: 14px; }
    .content { padding: 32px; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 16px; font-weight: 700; color: #1e3a5f; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .stat-card { background: #f8fafc; border-radius: 12px; padding: 20px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; color: #1e3a5f; }
    .stat-label { font-size: 12px; color: #64748b; margin-top: 4px; }
    .kpi-list, .task-list { background: #f8fafc; border-radius: 12px; overflow: hidden; }
    .kpi-item, .task-item { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .kpi-item:last-child, .task-item:last-child { border-bottom: none; }
    .kpi-name, .task-name { font-weight: 600; }
    .kpi-progress { font-size: 14px; color: #64748b; }
    .progress-bar { width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-left: 12px; }
    .progress-fill { height: 100%; background: #00C471; }
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .badge-success { background: #dcfce7; color: #16a34a; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-danger { background: #fee2e2; color: #dc2626; }
    .footer { background: #f8fafc; padding: 20px 32px; text-align: center; font-size: 12px; color: #64748b; }
    @media print { body { padding: 0; background: white; } .container { box-shadow: none; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ê°œì¸ ì„±ê³¼ ë³´ê³ ì„œ</h1>
      <div class="subtitle">${memberName} | ìƒì„±ì¼: ${today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
    </div>
    <div class="content">
      <div class="section">
        <div class="section-title">ğŸ“ˆ ì„±ê³¼ ìš”ì•½</div>
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-value">${myKPIs.length}</div>
            <div class="stat-label">í• ë‹¹ëœ KPI</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${completedTasks.length}</div>
            <div class="stat-label">ì™„ë£Œ ì—…ë¬´</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${inProgressTasks.length}</div>
            <div class="stat-label">ì§„í–‰ ì¤‘</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: ${successRate >= 80 ? '#16a34a' : successRate >= 50 ? '#d97706' : '#dc2626'};">${successRate}%</div>
            <div class="stat-label">ì—…ë¬´ ì„±ê³µë¥ </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">ğŸ¯ KPI ë‹¬ì„± í˜„í™©</div>
        <div class="kpi-list">
          ${myKPIs.length === 0 ? '<div class="kpi-item" style="color: #94a3b8;">í• ë‹¹ëœ KPIê°€ ì—†ìŠµë‹ˆë‹¤</div>' : myKPIs.map(kpi => {
            const progress = kpi.target > 0 ? Math.round((kpi.current / kpi.target) * 100) : 0;
            return `
              <div class="kpi-item">
                <div class="kpi-name">${kpi.name || 'ì´ë¦„ì—†ìŒ'}</div>
                <div style="display: flex; align-items: center;">
                  <span class="kpi-progress">${kpi.current || 0}/${kpi.target || 0} ${kpi.unit || ''}</span>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(100, progress)}%; background: ${progress >= 100 ? '#16a34a' : progress >= 70 ? '#00C471' : progress >= 40 ? '#f59e0b' : '#ef4444'};"></div>
                  </div>
                  <span style="margin-left: 8px; font-weight: 600; font-size: 14px;">${progress}%</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>

      <div class="section">
        <div class="section-title">âœ… ìµœê·¼ ì™„ë£Œ ì—…ë¬´</div>
        <div class="task-list">
          ${completedTasks.slice(0, 10).length === 0 ? '<div class="task-item" style="color: #94a3b8;">ì™„ë£Œëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : completedTasks.slice(0, 10).map(task => `
            <div class="task-item">
              <div class="task-name">${task.title || task.name || 'ì œëª©ì—†ìŒ'}</div>
              <span class="badge ${task.success ? 'badge-success' : 'badge-danger'}">${task.success ? 'ì„±ê³µ' : 'ì§€ì—°'}</span>
            </div>
          `).join('')}
        </div>
      </div>

      <div class="section">
        <div class="section-title">â³ ì§„í–‰ ì¤‘ ì—…ë¬´</div>
        <div class="task-list">
          ${inProgressTasks.length === 0 ? '<div class="task-item" style="color: #94a3b8;">ì§„í–‰ ì¤‘ì¸ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : inProgressTasks.map(task => {
            const deadline = task.deadline;
            const daysLeft = deadline ? Math.ceil((new Date(deadline) - today) / (1000 * 60 * 60 * 24)) : null;
            return `
              <div class="task-item">
                <div class="task-name">${task.title || task.name || 'ì œëª©ì—†ìŒ'}</div>
                ${daysLeft !== null ? `<span class="badge ${daysLeft < 0 ? 'badge-danger' : daysLeft <= 3 ? 'badge-warning' : 'badge-success'}">${daysLeft < 0 ? 'D+' + Math.abs(daysLeft) : daysLeft === 0 ? 'D-Day' : 'D-' + daysLeft}</span>` : ''}
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
    <div class="footer">
      NetformRND ì „ëµì„¼í„° | ìë™ ìƒì„±ëœ ë³´ê³ ì„œ | ${today.toISOString()}
    </div>
  </div>
</body>
</html>`;

      // ìƒˆ ì°½ì—ì„œ ë³´ê³ ì„œ ì—´ê¸°
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(reportHTML);
      reportWindow.document.close();

      showToast('ê°œì¸ ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function generateAdminReport() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];

      // íŒ€ ì „ì²´ ë°ì´í„°
      const teamMembers = [
        { id: 'chaeeun', name: 'ì´ì±„ì€', role: 'manager' },
        { id: 'songhee', name: 'ê¹€ì†¡í¬', role: 'admin' }
      ];

      // ì—°ë„ë³„ ëª©í‘œ
      const yearlyGoals = state.yearlyGoals || [];
      const currentYearGoal = yearlyGoals.find(g => g.year === today.getFullYear());

      // ëŒ€í˜•í”„ë¡œì íŠ¸
      const megaProjects = state.megaProjects || [];

      // íŒ€ KPI
      const teamKPIs = state.teamKPIs || [];

      // ê°œì¸ KPI
      const memberKPIs = state.memberKPIs || [];

      // ì „ì²´ ì—…ë¬´
      const allTasks = state.tasks || [];
      const completedTasks = allTasks.filter(t => t.status === 'done');
      const inProgressTasks = allTasks.filter(t => t.status === 'progress');
      const overdueTasks = allTasks.filter(t => {
        if (!t.deadline || t.status === 'done') return false;
        return new Date(t.deadline) < today;
      });

      // íŒ€ì›ë³„ ì„±ê³¼ ê³„ì‚°
      const memberStats = teamMembers.map(member => {
        const kpis = memberKPIs.filter(k => k.memberId === member.id || k.memberName === member.name);
        const tasks = allTasks.filter(t => t.assignee === member.id || t.assigneeName === member.name);
        const completed = tasks.filter(t => t.status === 'done');
        const successTasks = completed.filter(t => t.success === true);
        const successRate = completed.length > 0 ? Math.round((successTasks.length / completed.length) * 100) : 0;

        const kpiProgress = kpis.length > 0
          ? Math.round(kpis.reduce((sum, k) => sum + (k.target > 0 ? (k.current / k.target) * 100 : 0), 0) / kpis.length)
          : 0;

        return {
          ...member,
          kpiCount: kpis.length,
          kpiProgress,
          taskCount: tasks.length,
          completedCount: completed.length,
          successRate
        };
      });

      // ëŒ€í˜•í”„ë¡œì íŠ¸ë³„ ì§„í–‰ë¥ 
      const projectStats = megaProjects.map(mp => {
        const projects = (state.projects || []).filter(p => p.megaProjectId === mp.id);
        const kpis = teamKPIs.filter(k => projects.some(p => p.id === k.projectId));
        const totalProgress = kpis.length > 0
          ? Math.round(kpis.reduce((sum, k) => sum + (k.target > 0 ? (k.current / k.target) * 100 : 0), 0) / kpis.length)
          : 0;
        return {
          name: mp.name,
          projectCount: projects.length,
          kpiCount: kpis.length,
          progress: totalProgress
        };
      });

      // HTML ë³´ê³ ì„œ ìƒì„±
      const reportHTML = `
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì ì¢…í•© ë³´ê³ ì„œ (${dateStr})</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Pretendard', -apple-system, sans-serif; background: #f5f7fa; padding: 40px; color: #1e293b; }
    .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; padding: 32px; }
    .header h1 { font-size: 24px; margin-bottom: 8px; }
    .header .subtitle { opacity: 0.8; font-size: 14px; }
    .content { padding: 32px; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 16px; font-weight: 700; color: #1e3a5f; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; display: flex; align-items: center; gap: 8px; }
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .stat-card { background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #e2e8f0; }
    .stat-value { font-size: 28px; font-weight: 700; color: #1e3a5f; }
    .stat-label { font-size: 12px; color: #64748b; margin-top: 4px; }
    .table { width: 100%; border-collapse: collapse; background: #f8fafc; border-radius: 12px; overflow: hidden; }
    .table th { background: #1e3a5f; color: white; padding: 14px 16px; text-align: left; font-size: 13px; font-weight: 600; }
    .table td { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
    .table tr:last-child td { border-bottom: none; }
    .table tr:hover { background: #f1f5f9; }
    .progress-bar { width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; display: inline-block; vertical-align: middle; }
    .progress-fill { height: 100%; }
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-success { background: #dcfce7; color: #16a34a; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-danger { background: #fee2e2; color: #dc2626; }
    .badge-info { background: #dbeafe; color: #2563eb; }
    .alert { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
    .alert-danger { background: #fee2e2; border-color: #ef4444; }
    .alert-icon { font-size: 24px; }
    .goal-card { background: linear-gradient(135deg, #1e3a5f, #0f2744); color: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; }
    .goal-title { font-size: 14px; opacity: 0.8; margin-bottom: 8px; }
    .goal-value { font-size: 32px; font-weight: 700; }
    .footer { background: #f8fafc; padding: 20px 32px; text-align: center; font-size: 12px; color: #64748b; }
    @media print { body { padding: 0; background: white; } .container { box-shadow: none; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ê´€ë¦¬ì ì¢…í•© ë³´ê³ ì„œ</h1>
      <div class="subtitle">NetformRND ì „ëµì„¼í„° | ${today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
    </div>
    <div class="content">
      ${overdueTasks.length > 0 ? `
      <div class="alert alert-danger">
        <span class="alert-icon">âš ï¸</span>
        <div>
          <strong>ì£¼ì˜: ë§ˆê° ì´ˆê³¼ ì—…ë¬´ ${overdueTasks.length}ê±´</strong>
          <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
        </div>
      </div>
      ` : ''}

      <div class="section">
        <div class="section-title">ğŸ¯ ì—°ê°„ ëª©í‘œ í˜„í™©</div>
        ${currentYearGoal ? `
        <div class="goal-card">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div class="goal-title">${today.getFullYear()}ë…„ ëª©í‘œ</div>
              <div class="goal-value">${((currentYearGoal.revenueTarget || 0) / 100000000).toFixed(0)}ì–µ</div>
            </div>
            <div style="text-align: right;">
              <div class="goal-title">ì˜ì—… / ì„±ì¥ ë¹„ìœ¨</div>
              <div style="font-size: 20px; font-weight: 600;">${currentYearGoal.salesRatio || 70}% : ${currentYearGoal.growthRatio || 30}%</div>
            </div>
          </div>
        </div>
        ` : '<div style="color: #94a3b8; padding: 20px; text-align: center;">ì—°ê°„ ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>'}
      </div>

      <div class="section">
        <div class="section-title">ğŸ“ˆ ì „ì²´ í˜„í™©</div>
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-value">${megaProjects.length}</div>
            <div class="stat-label">ëŒ€í˜• í”„ë¡œì íŠ¸</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${teamKPIs.length}</div>
            <div class="stat-label">íŒ€ KPI</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${completedTasks.length}/${allTasks.length}</div>
            <div class="stat-label">ì—…ë¬´ ì™„ë£Œìœ¨</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: ${overdueTasks.length === 0 ? '#16a34a' : '#dc2626'};">${overdueTasks.length}</div>
            <div class="stat-label">ë§ˆê° ì´ˆê³¼</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">ğŸ‘¥ íŒ€ì›ë³„ ì„±ê³¼</div>
        <table class="table">
          <tr>
            <th>ì´ë¦„</th>
            <th>ì—­í• </th>
            <th>KPI ìˆ˜</th>
            <th>KPI ë‹¬ì„±ë¥ </th>
            <th>ì™„ë£Œ ì—…ë¬´</th>
            <th>ì„±ê³µë¥ </th>
          </tr>
          ${memberStats.map(m => `
            <tr>
              <td><strong>${m.name}</strong></td>
              <td><span class="badge ${m.role === 'admin' ? 'badge-info' : 'badge-warning'}">${m.role === 'admin' ? 'ê´€ë¦¬ì' : 'ë§¤ë‹ˆì €'}</span></td>
              <td>${m.kpiCount}</td>
              <td>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${Math.min(100, m.kpiProgress)}%; background: ${m.kpiProgress >= 80 ? '#16a34a' : m.kpiProgress >= 50 ? '#f59e0b' : '#ef4444'};"></div>
                </div>
                <span style="margin-left: 8px;">${m.kpiProgress}%</span>
              </td>
              <td>${m.completedCount}/${m.taskCount}</td>
              <td><span class="badge ${m.successRate >= 80 ? 'badge-success' : m.successRate >= 50 ? 'badge-warning' : 'badge-danger'}">${m.successRate}%</span></td>
            </tr>
          `).join('')}
        </table>
      </div>

      ${megaProjects.length > 0 ? `
      <div class="section">
        <div class="section-title">ğŸ¢ ëŒ€í˜• í”„ë¡œì íŠ¸ë³„ í˜„í™©</div>
        <table class="table">
          <tr>
            <th>í”„ë¡œì íŠ¸ëª…</th>
            <th>í•˜ìœ„ í”„ë¡œì íŠ¸</th>
            <th>KPI ìˆ˜</th>
            <th>ì§„í–‰ë¥ </th>
          </tr>
          ${projectStats.map(p => `
            <tr>
              <td><strong>${p.name}</strong></td>
              <td>${p.projectCount}ê°œ</td>
              <td>${p.kpiCount}ê°œ</td>
              <td>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${Math.min(100, p.progress)}%; background: ${p.progress >= 80 ? '#16a34a' : p.progress >= 50 ? '#f59e0b' : '#ef4444'};"></div>
                </div>
                <span style="margin-left: 8px;">${p.progress}%</span>
              </td>
            </tr>
          `).join('')}
        </table>
      </div>
      ` : ''}

      ${overdueTasks.length > 0 ? `
      <div class="section">
        <div class="section-title" style="color: #dc2626;">âš ï¸ ë§ˆê° ì´ˆê³¼ ì—…ë¬´ ëª©ë¡</div>
        <table class="table">
          <tr>
            <th>ì—…ë¬´ëª…</th>
            <th>ë‹´ë‹¹ì</th>
            <th>ë§ˆê°ì¼</th>
            <th>ì´ˆê³¼ ì¼ìˆ˜</th>
          </tr>
          ${overdueTasks.slice(0, 10).map(t => {
            const daysOver = Math.ceil((today - new Date(t.deadline)) / (1000 * 60 * 60 * 24));
            return `
              <tr>
                <td><strong>${t.title || t.name || 'ì œëª©ì—†ìŒ'}</strong></td>
                <td>${t.assigneeName || '-'}</td>
                <td>${t.deadline}</td>
                <td><span class="badge badge-danger">+${daysOver}ì¼</span></td>
              </tr>
            `;
          }).join('')}
        </table>
      </div>
      ` : ''}
    </div>
    <div class="footer">
      NetformRND ì „ëµì„¼í„° | ê´€ë¦¬ììš© ìë™ ìƒì„± ë³´ê³ ì„œ | ${today.toISOString()}
    </div>
  </div>
</body>
</html>`;

      // ìƒˆ ì°½ì—ì„œ ë³´ê³ ì„œ ì—´ê¸°
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(reportHTML);
      reportWindow.document.close();

      showToast('ê´€ë¦¬ì ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ========================================
    // ê³µí†µ UI: ëª¨ë”” ì±—ë´‡ ì‹œìŠ¤í…œ
    // ========================================
    function toggleChatbot() {
      const chatbot = document.getElementById('chatbot-window');
      if (chatbot.style.display === 'none' || chatbot.style.display === '') {
        chatbot.style.display = 'flex';
        initChatbot();
      } else {
        chatbot.style.display = 'none';
      }
    }

    function initChatbot() {
      const messages = document.getElementById('chatbot-messages');
      if (!messages) return;

      // ë§ˆê° ì„ë°• ì—…ë¬´ í™•ì¸
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const upcomingTasks = (state.tasks || []).filter(t => {
        if (!t.deadline || t.status === 'done') return false;
        const deadline = new Date(t.deadline);
        const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
        return daysLeft <= 3 && daysLeft >= 0;
      });

      const overdueTasks = (state.tasks || []).filter(t => {
        if (!t.deadline || t.status === 'done') return false;
        return new Date(t.deadline) < today;
      });

      let alertHTML = '';
      if (overdueTasks.length > 0) {
        alertHTML += `
          <div style="background: #fee2e2; border: 1px solid #fca5a5; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 700; color: #dc2626; margin-bottom: 4px;">âš ï¸ ë§ˆê° ì´ˆê³¼ ì—…ë¬´ ${overdueTasks.length}ê±´</div>
            <div style="font-size: 11px; color: #991b1b;">ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!</div>
          </div>
        `;
      }
      if (upcomingTasks.length > 0) {
        alertHTML += `
          <div style="background: #fef3c7; border: 1px solid #fcd34d; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 700; color: #d97706; margin-bottom: 4px;">ğŸ“… ì˜¤ëŠ˜ ë§ˆê° ì—…ë¬´ ${upcomingTasks.filter(t => t.deadline === todayStr).length}ê±´</div>
            <div style="font-size: 11px; color: #92400e;">3ì¼ ë‚´ ë§ˆê°: ${upcomingTasks.length}ê±´</div>
          </div>
        `;
      }

      messages.innerHTML = `
        <div style="margin-bottom: 16px;">
          ${alertHTML}
          <div style="background: white; padding: 12px 16px; border-radius: 12px 12px 12px 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 12px; max-width: 85%;">
            <div style="font-size: 13px; color: var(--gray-800); line-height: 1.6;">
              ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹<br>
              ì „ëµì„¼í„° ë„ìš°ë¯¸ <strong>ëª¨ë””</strong>ì…ë‹ˆë‹¤.<br>
              ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
          </div>
          <div style="font-size: 11px; color: var(--gray-400); margin-bottom: 12px;">ë¹ ë¥¸ ë©”ë‰´</div>
          <div style="display: grid; gap: 6px;">
            <button onclick="askQuestion('KPI ê´€ë¦¬ ë°©ë²•')" style="background: linear-gradient(135deg, #fff8f0, #ffe8cc); border: 1px solid var(--primary); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--primary); font-weight: 600; transition: all 0.2s;">
              ğŸ¯ KPI ê´€ë¦¬ëŠ” ì–´ë–»ê²Œ í•˜ë‚˜ìš”?
            </button>
            <button onclick="askQuestion('í”„ë¡œì íŠ¸ ë“±ë¡ ë°©ë²•')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;">
              ğŸ“‹ í”„ë¡œì íŠ¸ ë“±ë¡ ë°©ë²•
            </button>
            <button onclick="askQuestion('ì—…ë¬´ ê´€ë¦¬ íŒ')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;">
              âœ… ì—…ë¬´ ê´€ë¦¬ íŒ
            </button>
            <button onclick="askQuestion('ì „ëµë¦¬ë·° í™œìš©ë²•')" style="background: white; border: 1px solid var(--gray-300); padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: var(--gray-700); transition: all 0.2s;">
              ğŸ“Š ì „ëµë¦¬ë·° í™œìš©ë²•
            </button>
            <button onclick="window.open('../', '_self')" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 1px solid #3b82f6; padding: 10px 14px; border-radius: 8px; text-align: left; cursor: pointer; font-size: 12px; color: #1d4ed8; font-weight: 600; transition: all 0.2s;">
              ğŸ  ìš´ì˜ì„¼í„°ë¡œ ì´ë™
            </button>
          </div>
        </div>
      `;
    }

    function askQuestion(question) {
      addUserMessage(question);
      setTimeout(() => {
        const answer = getChatbotAnswer(question);
        addBotMessage(answer);
      }, 300);
    }

    function addUserMessage(message) {
      const messages = document.getElementById('chatbot-messages');
      if (!messages) return;
      const userMsg = document.createElement('div');
      userMsg.style.cssText = 'display: flex; justify-content: flex-end; margin-bottom: 12px;';
      userMsg.innerHTML = `
        <div style="background: var(--primary); color: white; padding: 10px 14px; border-radius: 12px 12px 4px 12px; max-width: 75%; font-size: 13px;">
          ${message}
        </div>
      `;
      messages.appendChild(userMsg);
      messages.scrollTop = messages.scrollHeight;
    }

    function addBotMessage(message) {
      const messages = document.getElementById('chatbot-messages');
      if (!messages) return;
      const botMsg = document.createElement('div');
      botMsg.style.cssText = 'margin-bottom: 12px;';
      botMsg.innerHTML = `
        <div style="background: white; padding: 12px 16px; border-radius: 12px 12px 12px 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 85%; font-size: 13px; color: var(--gray-800); line-height: 1.7;">
          ${message}
        </div>
      `;
      messages.appendChild(botMsg);
      messages.scrollTop = messages.scrollHeight;
    }

    function sendChatMessage() {
      const input = document.getElementById('chatbot-input');
      if (!input) return;
      const message = input.value.trim();
      if (!message) return;
      askQuestion(message);
      input.value = '';
    }

    function getChatbotAnswer(question) {
      const q = question.toLowerCase();

      if (q.includes('kpi') || q.includes('ê´€ë¦¬')) {
        return `<strong>ğŸ¯ KPI ê´€ë¦¬ ë°©ë²•</strong><br><br>
          1ï¸âƒ£ <strong>KPIê´€ë¦¬</strong> ë©”ë‰´ë¡œ ì´ë™<br>
          2ï¸âƒ£ ê³„ì¸µ ë·°ì—ì„œ ì „ì²´ KPI í˜„í™© í™•ì¸<br>
          3ï¸âƒ£ íŒ€ KPI í´ë¦­ â†’ ëª©í‘œ/í˜„ì¬ê°’ ìˆ˜ì •<br>
          4ï¸âƒ£ ê°œì¸ KPIì˜ +1 ë²„íŠ¼ìœ¼ë¡œ ë¹ ë¥¸ ì—…ë°ì´íŠ¸<br><br>
          ğŸ’¡ <strong>íŒ:</strong> ì—…ë¬´ ì™„ë£Œ ì‹œ ì—°ê²°ëœ KPIê°€ ìë™ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤!`;
      }

      if (q.includes('í”„ë¡œì íŠ¸') || q.includes('ë“±ë¡')) {
        return `<strong>ğŸ“‹ í”„ë¡œì íŠ¸ ë“±ë¡ ë°©ë²•</strong><br><br>
          1ï¸âƒ£ <strong>ëŒ€ì‹œë³´ë“œ</strong>ì—ì„œ "ğŸ¢ ëŒ€í˜•í”„ë¡œì íŠ¸ ì¶”ê°€" í´ë¦­<br>
          2ï¸âƒ£ í”„ë¡œì íŠ¸ëª…, ëª©í‘œ ë§¤ì¶œ, ê¸°ê°„ ì…ë ¥<br>
          3ï¸âƒ£ í•˜ìœ„ í”„ë¡œì íŠ¸ ì¶”ê°€<br>
          4ï¸âƒ£ íŒ€ KPI ì—°ê²°<br><br>
          ğŸ’¡ <strong>êµ¬ì¡°:</strong> ëŒ€í˜•í”„ë¡œì íŠ¸ â†’ í”„ë¡œì íŠ¸ â†’ íŒ€KPI â†’ ê°œì¸KPI â†’ ì—…ë¬´`;
      }

      if (q.includes('ì—…ë¬´') || q.includes('ê´€ë¦¬') || q.includes('íŒ')) {
        return `<strong>âœ… ì—…ë¬´ ê´€ë¦¬ íŒ</strong><br><br>
          <strong>1. ì¹¸ë°˜ ë·° í™œìš©</strong><br>
          â€¢ ë“œë˜ê·¸ë¡œ ìƒíƒœ ë³€ê²½<br>
          â€¢ "ì§„í–‰ì¤‘"ìœ¼ë¡œ ì´ë™ ì‹œ ìë™ ì‹œì‘ì¼ ê¸°ë¡<br><br>
          <strong>2. ë§ˆê°ì¼ í•„ìˆ˜ ì„¤ì •</strong><br>
          â€¢ D-day ë°°ì§€ë¡œ ë§ˆê° í™•ì¸<br>
          â€¢ ë§ˆê° ì¤€ìˆ˜ ì‹œ ì„±ê³µìœ¼ë¡œ ê¸°ë¡<br><br>
          <strong>3. KPI ì—°ê²°</strong><br>
          â€¢ ì—…ë¬´ ì™„ë£Œ ì‹œ KPI ìë™ +1<br><br>
          ğŸ’¡ ë¹¨ê°„ í…Œë‘ë¦¬ = ë§ˆê° ì„ë°•!`;
      }

      if (q.includes('ì „ëµ') || q.includes('ë¦¬ë·°') || q.includes('í™œìš©')) {
        return `<strong>ğŸ“Š ì „ëµë¦¬ë·° í™œìš©ë²•</strong><br><br>
          <strong>1. ìš”ì•½ ë·°</strong><br>
          ëª©í‘œ ë‹¬ì„± í˜„í™© í•œëˆˆì— í™•ì¸<br><br>
          <strong>2. ì—­ìˆœ ë°ì´í„°</strong><br>
          ì—…ë¬´ â†’ ê°œì¸KPI â†’ íŒ€KPI â†’ í”„ë¡œì íŠ¸<br>
          âš ï¸ ê²½ê³  ì˜ì—­ì—ì„œ ì·¨ì•½ì  íŒŒì•…<br><br>
          <strong>3. ê°œì¸ë³„ ì„±ê³µë¥ </strong><br>
          íŒ€ì›ë³„ ì—…ë¬´ ì™„ìˆ˜ìœ¨ í™•ì¸<br><br>
          ğŸ’¡ <strong>ë³´ê³ ì„œ ìë™ ìƒì„±</strong> ë²„íŠ¼ìœ¼ë¡œ PDF ì¶œë ¥!`;
      }

      return `ì£„ì†¡í•©ë‹ˆë‹¤, í•´ë‹¹ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ğŸ˜…<br><br>
        ë‹¤ìŒ ë©”ë‰´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”:<br>
        â€¢ <strong>ì—…ë¬´ê°€ì´ë“œ</strong> - ìƒì„¸ ê°€ì´ë“œ<br>
        â€¢ <strong>ëŒ€ì‹œë³´ë“œ</strong> - ì „ì²´ í˜„í™©<br><br>
        ë˜ëŠ” ìš´ì˜ì„¼í„°ì˜ ëª¨ë”” ì±—ë´‡ì„ ì´ìš©í•´ë³´ì„¸ìš”!`;
    }

    // ëª¨ë”” ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateChatbotBadge() {
      const badge = document.getElementById('chatbot-notification-badge');
      if (!badge) return;

      const today = new Date();
      const overdueTasks = (state.tasks || []).filter(t => {
        if (!t.deadline || t.status === 'done') return false;
        return new Date(t.deadline) < today;
      });

      if (overdueTasks.length > 0) {
        badge.style.display = 'flex';
        badge.textContent = overdueTasks.length > 9 ? '9+' : overdueTasks.length;
      } else {
        badge.style.display = 'none';
      }
    }

    // ========================================
    // ê³µí†µ UI: ê°„í¸ ë§ˆì§„ê³„ì‚°ê¸°
    // ========================================
    function openSimpleMarginCalculator() {
      const m = document.getElementById('modal');
      if (!m) return;
      m.className = 'modal show';
      m.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white;">
            <h2 class="modal-title" style="color: white;">ğŸ§® ê°„í¸ ë§ˆì§„ ê³„ì‚°ê¸°</h2>
            <button class="modal-close" onclick="closeModal()" style="color: white;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <div style="background: #fef3c7; border-radius: 10px; padding: 12px 16px; margin-bottom: 20px; font-size: 12px; color: #92400e;">
              ğŸ’¡ <strong>ëª©í‘œ:</strong> ê±´ë‹¹ ìˆœë§ˆì§„ 2,000ì› ì´ìƒ | íŒë§¤ìˆ˜ëŸ‰ 200~300ê°œ
            </div>

            <div style="display: grid; gap: 16px; margin-bottom: 20px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ê³µê¸‰ë‹¨ê°€ (ì›)</label>
                <input type="number" id="calcSupplyPrice" value="10000" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;" oninput="calculateMargin()">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">íŒë§¤ê°€ (ì›)</label>
                <input type="number" id="calcSalePrice" value="15000" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;" oninput="calculateMargin()">
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì…€ëŸ¬ ë§ˆì§„ìœ¨ (%)</label>
                  <input type="number" id="calcSellerRate" value="20" min="0" max="50" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;" oninput="calculateMargin()">
                </div>
                <div>
                  <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">ì˜ˆìƒ íŒë§¤ìˆ˜ëŸ‰</label>
                  <input type="number" id="calcQty" value="250" min="1" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 15px;" oninput="calculateMargin()">
                </div>
              </div>
            </div>

            <div id="marginResult" style="background: var(--gray-50); border-radius: 12px; padding: 20px;">
              <!-- ê³„ì‚° ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            <a href="../" class="btn btn-primary" style="text-decoration: none;">ğŸ§® ìƒì„¸ ê³„ì‚°ê¸° (ìš´ì˜ì„¼í„°)</a>
          </div>
        </div>
      `;
      calculateMargin();
    }

    function calculateMargin() {
      const supplyPrice = Number(document.getElementById('calcSupplyPrice')?.value) || 0;
      const salePrice = Number(document.getElementById('calcSalePrice')?.value) || 0;
      const sellerRate = Number(document.getElementById('calcSellerRate')?.value) || 20;
      const qty = Number(document.getElementById('calcQty')?.value) || 1;

      const totalMargin = salePrice - supplyPrice;
      const sellerMargin = Math.round(salePrice * (sellerRate / 100));
      const pgFee = Math.round(salePrice * 0.04); // 4% PGìˆ˜ìˆ˜ë£Œ
      const ourMargin = totalMargin - sellerMargin - pgFee;

      const totalSales = salePrice * qty;
      const totalOurMargin = ourMargin * qty;

      const isGood = ourMargin >= 2000;
      const marginColor = isGood ? '#16a34a' : '#dc2626';

      const resultEl = document.getElementById('marginResult');
      if (!resultEl) return;

      resultEl.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div style="text-align: center; background: white; padding: 16px; border-radius: 10px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì´ ë§ˆì§„</div>
            <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${totalMargin.toLocaleString()}ì›</div>
          </div>
          <div style="text-align: center; background: white; padding: 16px; border-radius: 10px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">ì…€ëŸ¬ ë§ˆì§„</div>
            <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${sellerMargin.toLocaleString()}ì›</div>
          </div>
          <div style="text-align: center; background: white; padding: 16px; border-radius: 10px;">
            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">PG ìˆ˜ìˆ˜ë£Œ (4%)</div>
            <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${pgFee.toLocaleString()}ì›</div>
          </div>
          <div style="text-align: center; background: ${isGood ? '#dcfce7' : '#fee2e2'}; padding: 16px; border-radius: 10px; border: 2px solid ${marginColor};">
            <div style="font-size: 12px; color: ${marginColor}; margin-bottom: 4px;">ğŸ¯ ìš°ë¦¬ ìˆœë§ˆì§„</div>
            <div style="font-size: 24px; font-weight: 700; color: ${marginColor};">${ourMargin.toLocaleString()}ì›</div>
          </div>
        </div>
        <div style="margin-top: 16px; padding: 16px; background: ${isGood ? '#dcfce7' : '#fee2e2'}; border-radius: 10px; text-align: center;">
          <div style="font-size: 14px; font-weight: 700; color: ${marginColor};">
            ${isGood ? 'âœ… ìˆ˜ìµì„± ì¶©ë¶„' : 'âš ï¸ ë§ˆì§„ ë¶€ì¡± - ì¡°ì • í•„ìš”'}
          </div>
          <div style="font-size: 13px; color: var(--gray-600); margin-top: 8px;">
            ì˜ˆìƒ ë§¤ì¶œ: <strong>${totalSales.toLocaleString()}ì›</strong> |
            ì˜ˆìƒ ìˆœìµ: <strong style="color: ${marginColor};">${totalOurMargin.toLocaleString()}ì›</strong>
          </div>
        </div>
      `;
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      loadAdminPassword();
      checkLoginStatus();

      // ë§ˆê° ì—…ë¬´ ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸
      setTimeout(() => {
        updateChatbotBadge();
      }, 2000);
    });
  </script>

<!-- ëª¨ë”” ì±—ë´‡ FAB -->
<style>
  @keyframes chatbot-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(252, 150, 0, 0.4), 0 0 40px rgba(252, 150, 0, 0.2), 0 4px 16px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 0 25px rgba(252, 150, 0, 0.6), 0 0 50px rgba(252, 150, 0, 0.3), 0 4px 16px rgba(0,0,0,0.3); }
  }
  #chatbot-fab:hover { animation: chatbot-glow 2s ease-in-out infinite; }
  @keyframes margin-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4), 0 0 40px rgba(168, 85, 247, 0.2), 0 4px 16px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 0 25px rgba(168, 85, 247, 0.6), 0 0 50px rgba(168, 85, 247, 0.3), 0 4px 16px rgba(0,0,0,0.3); }
  }
  #margin-calc-fab:hover { animation: margin-glow 2s ease-in-out infinite; }
</style>

<div id="chatbot-fab" onclick="toggleChatbot()" style="position: fixed; bottom: 90px; right: 24px; width: 60px; height: 60px; background: linear-gradient(135deg, #0f172a, #1e293b); border: 2px solid rgba(252, 150, 0, 0.5); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 0 20px rgba(252, 150, 0, 0.3), 0 4px 16px rgba(0,0,0,0.3); z-index: 999; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.borderColor='rgba(252, 150, 0, 0.8)'" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='rgba(252, 150, 0, 0.5)'">
  <div style="width: 40px; height: 40px; border-radius: 50%; background: radial-gradient(circle, rgba(252, 150, 0, 0.3) 0%, transparent 70%); display: flex; align-items: center; justify-content: center;">
    <span style="filter: drop-shadow(0 0 8px rgba(252, 150, 0, 0.6));">ğŸ’¬</span>
  </div>
  <div id="chatbot-notification-badge" style="position: absolute; top: -4px; right: -4px; min-width: 20px; height: 20px; background: #ef4444; color: white; border-radius: 10px; display: none; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; padding: 0 6px; border: 2px solid #0f172a; box-shadow: 0 2px 8px rgba(239,68,68,0.6);"></div>
</div>

<!-- ëª¨ë”” ì±—ë´‡ ì°½ -->
<div id="chatbot-window" style="position: fixed; bottom: 160px; right: 24px; width: min(380px, calc(100vw - 48px)); max-height: min(500px, calc(100vh - 200px)); background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); z-index: 998; display: none; flex-direction: column; overflow: hidden;">
  <div style="background: linear-gradient(135deg, #fc9600, #e08600); color: white; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="font-size: 24px;">ğŸ¤–</div>
      <div>
        <div style="font-size: 16px; font-weight: 700;">ëª¨ë”” (MODi)</div>
        <div style="font-size: 11px; opacity: 0.9;">ì „ëµì„¼í„° ë„ìš°ë¯¸</div>
      </div>
    </div>
    <button onclick="toggleChatbot()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">Ã—</button>
  </div>
  <div id="chatbot-messages" style="flex: 1; overflow-y: auto; padding: 16px; max-height: 350px; background: #f9fafb;"></div>
  <div style="padding: 12px; border-top: 1px solid var(--gray-200); background: white;">
    <div style="display: flex; gap: 8px;">
      <input id="chatbot-input" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: 20px; font-size: 13px; font-family: inherit;" onkeypress="if(event.key==='Enter') sendChatMessage()">
      <button onclick="sendChatMessage()" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">ì „ì†¡</button>
    </div>
  </div>
</div>

<!-- ë§ˆì§„ê³„ì‚°ê¸° FAB -->
<div id="margin-calc-fab" onclick="openSimpleMarginCalculator()" style="position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; background: linear-gradient(135deg, #0f172a, #1e293b); border: 2px solid rgba(168, 85, 247, 0.5); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 0 20px rgba(168, 85, 247, 0.3), 0 4px 16px rgba(0,0,0,0.3); z-index: 999; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.borderColor='rgba(168, 85, 247, 0.8)'" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='rgba(168, 85, 247, 0.5)'">
  <div style="width: 40px; height: 40px; border-radius: 50%; background: radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, transparent 70%); display: flex; align-items: center; justify-content: center;">
    <span style="filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.6));">ğŸ§®</span>
  </div>
</div>

</body>
</html>

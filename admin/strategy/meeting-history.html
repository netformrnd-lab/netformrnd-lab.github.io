<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¯¸íŒ… íˆìŠ¤í† ë¦¬ - ì „ëµì„¼í„°</title>
  <link rel="manifest" href="/admin/manifest.json">
  <meta name="theme-color" content="#3182f6">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #3182f6;
      --primary-light: #eef4ff;
      --primary-dark: #1b64da;
      --white: #ffffff;
      --gray-900: #191f28;
      --gray-800: #333d4b;
      --gray-700: #4e5968;
      --gray-600: #6b7684;
      --gray-500: #8b95a1;
      --gray-400: #b0b8c1;
      --gray-300: #d1d6db;
      --gray-200: #e5e8eb;
      --gray-100: #f2f4f6;
      --gray-50: #f9fafb;
      --success: #00c073;
      --success-light: #e8f7f0;
      --warning: #fc9600;
      --warning-light: #fff8f0;
      --danger: #f04452;
      --danger-light: #fff0f1;
      --card-radius: 16px;
      --card-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      background: var(--gray-100);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--gray-900);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 20px 0;
      margin-bottom: 24px;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .header-subtitle {
      font-size: 14px;
      color: var(--gray-600);
      margin-top: 2px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover { background: var(--primary-dark); }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn-secondary:hover { background: var(--gray-200); }

    .btn-danger {
      background: var(--danger);
      color: var(--white);
    }

    .btn-danger:hover { background: #d63240; }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .view-toggle .btn {
      flex: 1;
    }

    .view-toggle .btn.active {
      background: var(--primary);
      color: var(--white);
    }

    /* Meeting List View */
    .meeting-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .meeting-card {
      background: var(--white);
      border-radius: var(--card-radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid var(--gray-200);
    }

    .meeting-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .meeting-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .meeting-type {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .meeting-type.report { background: var(--info-light); color: var(--info); }
    .meeting-type.proposal { background: var(--warning-light); color: var(--warning); }
    .meeting-type.review { background: var(--success-light); color: var(--success); }

    .meeting-date {
      font-size: 13px;
      color: var(--gray-500);
      font-weight: 500;
    }

    .meeting-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .meeting-summary {
      font-size: 14px;
      color: var(--gray-600);
      line-height: 1.6;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .meeting-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-100);
    }

    .meeting-attendees {
      font-size: 13px;
      color: var(--gray-600);
    }

    .meeting-actions {
      display: flex;
      gap: 4px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: background 0.15s ease;
    }

    .icon-btn:hover { background: var(--gray-100); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 24px;
    }

    /* Report View */
    .report-view {
      display: none;
    }

    .report-view.active {
      display: block;
    }

    .report-container {
      background: var(--white);
      border-radius: var(--card-radius);
      padding: 40px;
      box-shadow: var(--card-shadow);
      max-width: 900px;
      margin: 0 auto;
    }

    .report-header {
      text-align: center;
      padding-bottom: 32px;
      border-bottom: 2px solid var(--gray-200);
      margin-bottom: 40px;
    }

    .report-type-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .report-title-input {
      width: 100%;
      font-size: 28px;
      font-weight: 800;
      text-align: center;
      border: none;
      padding: 8px;
      color: var(--gray-900);
      border-bottom: 2px solid transparent;
      transition: border-color 0.15s ease;
    }

    .report-title-input:focus {
      outline: none;
      border-bottom-color: var(--primary);
    }

    .report-meta {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .report-meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--gray-600);
    }

    .report-meta-item input {
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 14px;
      font-family: inherit;
      width: 140px;
    }

    .report-meta-item input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .report-section {
      margin-bottom: 40px;
    }

    .report-section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .report-section-icon {
      font-size: 20px;
    }

    textarea, input[type="text"] {
      font-family: inherit;
    }

    .report-textarea {
      width: 100%;
      min-height: 120px;
      padding: 16px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 15px;
      line-height: 1.7;
      resize: vertical;
      transition: border-color 0.15s ease;
    }

    .report-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .action-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .action-item {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .action-item input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 14px;
    }

    .action-item input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .action-item-assignee {
      width: 120px;
    }

    .action-item-deadline {
      width: 140px;
    }

    .btn-add-item {
      align-self: flex-start;
      margin-top: 8px;
      background: var(--gray-100);
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-add-item:hover {
      background: var(--gray-200);
    }

    .report-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      padding-top: 32px;
      border-top: 1px solid var(--gray-200);
      margin-top: 40px;
    }

    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      min-height: 48px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--primary-light);
      color: var(--primary);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
    }

    .tag-remove {
      cursor: pointer;
      font-size: 16px;
      opacity: 0.7;
    }

    .tag-remove:hover {
      opacity: 1;
    }

    .tag-input {
      border: none;
      outline: none;
      flex: 1;
      min-width: 100px;
      font-size: 14px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .modal-desc {
      font-size: 14px;
      color: var(--gray-600);
      margin-bottom: 24px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Print Styles */
    @media print {
      body {
        background: white;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .header, .report-actions, .icon-btn, .list-view, .view-toggle {
        display: none !important;
      }
      .container {
        max-width: 100%;
        padding: 0;
      }
      .report-view {
        display: block !important;
      }
      .report-container {
        box-shadow: none;
        padding: 0;
        border: none;
      }
      .report-header {
        border-bottom: 2px solid #333;
        padding-bottom: 16px;
        margin-bottom: 20px;
      }
      .report-section {
        page-break-inside: avoid;
        margin-bottom: 20px;
      }
      .report-section-title {
        font-weight: 700;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
        margin-bottom: 12px;
      }
      .report-textarea, input {
        border: none !important;
        padding: 0 !important;
        background: transparent !important;
        resize: none;
        overflow: visible;
        min-height: auto !important;
        height: auto !important;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.8;
        font-size: 11pt;
      }
      .report-textarea {
        display: block;
        width: 100%;
      }
      .action-items-list {
        border: none;
      }
      .action-item {
        border-bottom: 1px dotted #ccc;
        padding: 8px 0;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .meeting-list {
        grid-template-columns: 1fr;
      }
      .report-container {
        padding: 24px;
      }
      .report-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .action-item {
        flex-direction: column;
      }
      .action-item-assignee, .action-item-deadline {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div>
        <div class="header-title">ğŸ“‹ ë¯¸íŒ… íˆìŠ¤í† ë¦¬</div>
        <div class="header-subtitle">ì „ëµì„¼í„° Â· ë³´ê³ ì„œ ê´€ë¦¬</div>
      </div>
      <button class="btn btn-primary" onclick="createNewReport()">
        â• ìƒˆ ë³´ê³ ì„œ
      </button>
    </div>
  </div>

  <div class="container">
    <!-- List View -->
    <div id="listView" class="list-view">
      <div class="view-toggle">
        <button class="btn btn-secondary active" onclick="filterReports('all')">ì „ì²´</button>
        <button class="btn btn-secondary" onclick="filterReports('report')">ë³´ê³ </button>
        <button class="btn btn-secondary" onclick="filterReports('proposal')">ì œì•ˆ</button>
        <button class="btn btn-secondary" onclick="filterReports('review')">ê²€í† </button>
      </div>

      <div id="meetingList" class="meeting-list">
        <!-- Meeting cards will be inserted here -->
      </div>

      <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">ğŸ“</div>
        <div class="empty-state-title">ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-state-desc">ìƒˆ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì—¬ ë¯¸íŒ… ë‚´ìš©ì„ ê¸°ë¡í•˜ì„¸ìš”</div>
        <button class="btn btn-primary" onclick="createNewReport()">ì²« ë³´ê³ ì„œ ì‘ì„±í•˜ê¸°</button>
      </div>
    </div>

    <!-- Report View -->
    <div id="reportView" class="report-view">
      <div style="margin-bottom: 24px;">
        <button class="btn btn-secondary" onclick="showListView()">â† ëª©ë¡ìœ¼ë¡œ</button>
      </div>

      <div class="report-container">
        <div class="report-header">
          <span class="report-type-badge" id="reportTypeBadge" style="background: var(--info-light); color: var(--info);">ë³´ê³ </span>
          <input type="text" class="report-title-input" id="reportTitle" placeholder="ë³´ê³ ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

          <div class="report-meta">
            <div class="report-meta-item">
              <span>ğŸ“… ë‚ ì§œ:</span>
              <input type="date" id="reportDate">
            </div>
            <div class="report-meta-item">
              <span>ğŸ‘¤ ì‘ì„±ì:</span>
              <input type="text" id="reportAuthor" placeholder="ì´ë¦„">
            </div>
            <div class="report-meta-item">
              <span>ğŸ“‚ ìœ í˜•:</span>
              <select id="reportType" style="border: 1px solid var(--gray-300); border-radius: 6px; padding: 6px 10px; font-size: 14px; font-family: inherit;">
                <option value="report">ë³´ê³ </option>
                <option value="proposal">ì œì•ˆ</option>
                <option value="review">ê²€í† </option>
              </select>
            </div>
          </div>
        </div>

        <div class="report-section">
          <div class="report-section-title">
            <span class="report-section-icon">ğŸ‘¥</span>
            ì°¸ì„ì
          </div>
          <div class="tags-input" id="attendeesContainer">
            <input type="text" class="tag-input" id="attendeeInput" placeholder="ì´ë¦„ ì…ë ¥ í›„ Enter">
          </div>
        </div>

        <div class="report-section">
          <div class="report-section-title">
            <span class="report-section-icon">ğŸ“Œ</span>
            ì•ˆê±´ / ëª©ì 
          </div>
          <textarea class="report-textarea" id="reportAgenda" placeholder="ë¯¸íŒ…ì˜ ì•ˆê±´ê³¼ ëª©ì ì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
        </div>

        <div class="report-section">
          <div class="report-section-title">
            <span class="report-section-icon">ğŸ’¬</span>
            ë…¼ì˜ ë‚´ìš©
          </div>
          <textarea class="report-textarea" id="reportDiscussion" style="min-height: 200px;" placeholder="ë…¼ì˜ëœ ë‚´ìš©ì„ ìƒì„¸íˆ ì‘ì„±í•˜ì„¸ìš”"></textarea>
        </div>

        <div class="report-section">
          <div class="report-section-title">
            <span class="report-section-icon">âœ…</span>
            ê²°ì • ì‚¬í•­
          </div>
          <textarea class="report-textarea" id="reportDecisions" placeholder="ë¯¸íŒ…ì—ì„œ ê²°ì •ëœ ì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
        </div>

        <div class="report-section">
          <div class="report-section-title">
            <span class="report-section-icon">ğŸ“Š</span>
            ì—°ê´€ KPI
          </div>
          <div id="relatedKpisContainer">
            <select id="kpiSelector" style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; font-family: inherit;">
              <option value="">ê´€ë ¨ KPI ì„ íƒ...</option>
            </select>
            <div id="selectedKpisList" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
              <!-- Selected KPIs will appear here as tags -->
            </div>
          </div>
        </div>

        <div class="report-section">
          <div class="report-section-title">
            <span class="report-section-icon">ğŸ¯</span>
            ì•¡ì…˜ ì•„ì´í…œ
          </div>
          <div class="action-items" id="actionItemsContainer">
            <!-- Action items will be inserted here -->
          </div>
          <button class="btn btn-small btn-add-item" onclick="addActionItem()">
            <span>+</span> ì•¡ì…˜ ì•„ì´í…œ ì¶”ê°€
          </button>
        </div>

        <div class="report-section">
          <div class="report-section-title">
            <span class="report-section-icon">ğŸ“</span>
            ë¹„ê³  / íŠ¹ì´ì‚¬í•­
          </div>
          <textarea class="report-textarea" id="reportNotes" placeholder="ì¶”ê°€ë¡œ ê¸°ë¡í•  ë‚´ìš©ì´ ìˆë‹¤ë©´ ì‘ì„±í•˜ì„¸ìš”"></textarea>
        </div>

        <div class="report-actions">
          <button class="btn btn-secondary" onclick="showListView()">ì·¨ì†Œ</button>
          <button class="btn btn-secondary" onclick="printReport()">ğŸ–¨ï¸ ì¸ì‡„</button>
          <button class="btn btn-primary" onclick="saveReport()">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">ë³´ê³ ì„œ ì‚­ì œ</div>
      <div class="modal-desc">ì´ ë³´ê³ ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
        <button class="btn btn-danger" onclick="confirmDelete()">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBIovld04wHY1sDPQRH8XQsyIv9nnJp6Lo",
      authDomain: "netform-strategy.firebaseapp.com",
      projectId: "netform-strategy",
      storageBucket: "netform-strategy.firebasestorage.app",
      messagingSenderId: "331082896890",
      appId: "1:331082896890:web:e29f89f5e84a7f1f9ed6ce",
      measurementId: "G-C5KSGM13LX"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.firestore();
    const auth = firebase.auth();

    let reports = [];
    let currentReportId = null;
    let deleteTargetId = null;
    let currentFilter = 'all';
    let unsubscribeMeetings = null;

    // Initialize
    function init() {
      // Check authentication
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = '/admin/';
          return;
        }

        // Load meetings from Firestore
        loadMeetings();
        setupEventListeners();

        // URL parameter check
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id');
        if (reportId) {
          setTimeout(() => viewReport(reportId), 500);
        }
      });
    }

    // Load meetings from Firestore with real-time sync
    function loadMeetings() {
      if (unsubscribeMeetings) {
        unsubscribeMeetings();
      }

      unsubscribeMeetings = db.collection('okr_meetings')
        .orderBy('createdAt', 'desc')
        .onSnapshot(snapshot => {
          reports = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          renderReports();
        }, error => {
          console.error('Meeting load error:', error);
          alert('ë¯¸íŒ… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        });
    }

    let availableKpis = [];
    let selectedKpiIds = [];

    function setupEventListeners() {
      // Attendee input
      document.getElementById('attendeeInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.value.trim()) {
          e.preventDefault();
          addAttendee(e.target.value.trim());
          e.target.value = '';
        }
      });

      // Report type change
      document.getElementById('reportType').addEventListener('change', (e) => {
        updateReportTypeBadge(e.target.value);
      });

      // KPI selector
      document.getElementById('kpiSelector').addEventListener('change', (e) => {
        if (e.target.value) {
          addRelatedKpi(e.target.value);
          e.target.value = '';
        }
      });

      // Date default
      document.getElementById('reportDate').valueAsDate = new Date();

      // Load KPIs for selector
      loadKpisForSelector();
    }

    // Load all KPIs for the selector
    async function loadKpisForSelector() {
      try {
        const [krsSnapshot, kpisSnapshot] = await Promise.all([
          db.collection('okr_keyResults').get(),
          db.collection('okr_kpis').get()
        ]);

        availableKpis = [
          ...krsSnapshot.docs.map(doc => ({
            id: doc.id,
            name: doc.data().name,
            type: 'Main KPI',
            ...doc.data()
          })),
          ...kpisSnapshot.docs.map(doc => ({
            id: doc.id,
            name: doc.data().name,
            type: 'Sub KPI',
            ...doc.data()
          }))
        ];

        updateKpiSelector();
      } catch (error) {
        console.error('KPI load error:', error);
      }
    }

    function updateKpiSelector() {
      const selector = document.getElementById('kpiSelector');
      const options = availableKpis
        .filter(kpi => !selectedKpiIds.includes(kpi.id))
        .map(kpi => `<option value="${kpi.id}">[${kpi.type}] ${kpi.name}</option>`)
        .join('');
      selector.innerHTML = '<option value="">ê´€ë ¨ KPI ì„ íƒ...</option>' + options;
    }

    function addRelatedKpi(kpiId) {
      if (selectedKpiIds.includes(kpiId)) return;

      selectedKpiIds.push(kpiId);
      renderSelectedKpis();
      updateKpiSelector();
    }

    function removeRelatedKpi(kpiId) {
      selectedKpiIds = selectedKpiIds.filter(id => id !== kpiId);
      renderSelectedKpis();
      updateKpiSelector();
    }

    function renderSelectedKpis() {
      const container = document.getElementById('selectedKpisList');
      const selectedKpis = availableKpis.filter(kpi => selectedKpiIds.includes(kpi.id));

      container.innerHTML = selectedKpis.map(kpi => `
        <div class="tag">
          <a href="/admin/strategy/?kpi=${kpi.id}" target="_blank" style="color: inherit; text-decoration: none;">
            [${kpi.type}] ${kpi.name}
          </a>
          <span class="tag-remove" onclick="removeRelatedKpi('${kpi.id}')">Ã—</span>
        </div>
      `).join('');
    }

    function updateReportTypeBadge(type) {
      const badge = document.getElementById('reportTypeBadge');
      const styles = {
        report: { bg: 'var(--info-light)', color: 'var(--info)', text: 'ë³´ê³ ' },
        proposal: { bg: 'var(--warning-light)', color: 'var(--warning)', text: 'ì œì•ˆ' },
        review: { bg: 'var(--success-light)', color: 'var(--success)', text: 'ê²€í† ' }
      };
      const style = styles[type];
      badge.style.background = style.bg;
      badge.style.color = style.color;
      badge.textContent = style.text;
    }

    function addAttendee(name) {
      const container = document.getElementById('attendeesContainer');
      const input = document.getElementById('attendeeInput');

      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.innerHTML = `
        ${name}
        <span class="tag-remove" onclick="this.parentElement.remove()">Ã—</span>
      `;

      container.insertBefore(tag, input);
    }

    function addActionItem() {
      const container = document.getElementById('actionItemsContainer');
      const item = document.createElement('div');
      item.className = 'action-item';
      item.innerHTML = `
        <input type="text" placeholder="í•´ì•¼ í•  ì¼" class="action-task">
        <input type="text" placeholder="ë‹´ë‹¹ì" class="action-item-assignee action-assignee">
        <input type="date" class="action-item-deadline action-deadline">
        <button class="icon-btn" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>
      `;
      container.appendChild(item);
    }

    function createNewReport() {
      currentReportId = null;
      clearReportForm();
      showReportView();
    }

    function clearReportForm() {
      document.getElementById('reportTitle').value = '';
      document.getElementById('reportDate').valueAsDate = new Date();
      document.getElementById('reportAuthor').value = '';
      document.getElementById('reportType').value = 'report';
      updateReportTypeBadge('report');
      document.getElementById('reportAgenda').value = '';
      document.getElementById('reportDiscussion').value = '';
      document.getElementById('reportDecisions').value = '';
      document.getElementById('reportNotes').value = '';

      // Clear attendees
      const attendeesContainer = document.getElementById('attendeesContainer');
      const tags = attendeesContainer.querySelectorAll('.tag');
      tags.forEach(tag => tag.remove());

      // Clear action items
      document.getElementById('actionItemsContainer').innerHTML = '';

      // Clear selected KPIs
      selectedKpiIds = [];
      renderSelectedKpis();
      updateKpiSelector();
    }

    async function saveReport() {
      const title = document.getElementById('reportTitle').value.trim();
      if (!title) {
        alert('ë³´ê³ ì„œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const attendees = Array.from(document.querySelectorAll('#attendeesContainer .tag'))
        .map(tag => tag.textContent.replace('Ã—', '').trim());

      const actionItems = Array.from(document.querySelectorAll('.action-item'))
        .map(item => ({
          task: item.querySelector('.action-task').value,
          assignee: item.querySelector('.action-assignee').value,
          deadline: item.querySelector('.action-deadline').value,
          completed: false,
          worklogId: null // Link to worklog when completed
        }))
        .filter(item => item.task);

      const currentUser = auth.currentUser;
      const report = {
        title,
        date: document.getElementById('reportDate').value,
        author: document.getElementById('reportAuthor').value || currentUser?.displayName || currentUser?.email || 'ë¯¸ìƒ',
        authorId: currentUser?.uid || null,
        type: document.getElementById('reportType').value,
        attendees,
        agenda: document.getElementById('reportAgenda').value,
        discussion: document.getElementById('reportDiscussion').value,
        decisions: document.getElementById('reportDecisions').value,
        notes: document.getElementById('reportNotes').value,
        actionItems,
        relatedKpiIds: selectedKpiIds, // Linked KPIs
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (currentReportId) {
          // Update existing meeting
          await db.collection('okr_meetings').doc(currentReportId).update(report);
          alert('ë¯¸íŒ… ë³´ê³ ì„œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          // Create new meeting
          report.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection('okr_meetings').add(report);
          console.log('Meeting created:', docRef.id);
          alert('ë¯¸íŒ… ë³´ê³ ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        showListView();
      } catch (error) {
        console.error('Save error:', error);
        alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
    }

    function viewReport(id) {
      const report = reports.find(r => r.id === id);
      if (!report) return;

      currentReportId = id;

      document.getElementById('reportTitle').value = report.title || '';
      document.getElementById('reportDate').value = report.date || '';
      document.getElementById('reportAuthor').value = report.author || '';
      document.getElementById('reportType').value = report.type || 'report';
      updateReportTypeBadge(report.type || 'report');
      document.getElementById('reportAgenda').value = report.agenda || '';
      document.getElementById('reportDiscussion').value = report.discussion || '';
      document.getElementById('reportDecisions').value = report.decisions || '';
      document.getElementById('reportNotes').value = report.notes || '';

      // Load attendees
      const attendeesContainer = document.getElementById('attendeesContainer');
      const existingTags = attendeesContainer.querySelectorAll('.tag');
      existingTags.forEach(tag => tag.remove());
      if (report.attendees) {
        report.attendees.forEach(name => addAttendee(name));
      }

      // Load action items
      const actionItemsContainer = document.getElementById('actionItemsContainer');
      actionItemsContainer.innerHTML = '';
      if (report.actionItems) {
        report.actionItems.forEach(item => {
          addActionItem();
          const lastItem = actionItemsContainer.lastElementChild;
          lastItem.querySelector('.action-task').value = item.task || '';
          lastItem.querySelector('.action-assignee').value = item.assignee || '';
          lastItem.querySelector('.action-deadline').value = item.deadline || '';
        });
      }

      // Load related KPIs
      selectedKpiIds = report.relatedKpiIds || [];
      renderSelectedKpis();
      updateKpiSelector();

      showReportView();

      // Update URL
      history.pushState(null, '', `?id=${id}`);
    }

    function deleteReport(id, event) {
      event.stopPropagation();
      deleteTargetId = id;
      document.getElementById('deleteModal').classList.add('active');
    }

    async function confirmDelete() {
      try {
        await db.collection('okr_meetings').doc(deleteTargetId).delete();
        closeDeleteModal();
        alert('ë³´ê³ ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('Delete error:', error);
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      }
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      deleteTargetId = null;
    }

    function shareReport(id, event) {
      event.stopPropagation();
      const url = `${window.location.origin}${window.location.pathname}?id=${id}`;
      navigator.clipboard.writeText(url).then(() => {
        alert('ë³´ê³ ì„œ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      });
    }

    function filterReports(type) {
      currentFilter = type;

      // Update button states
      const buttons = document.querySelectorAll('.view-toggle .btn');
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      renderReports();
    }

    function renderReports() {
      const container = document.getElementById('meetingList');
      const emptyState = document.getElementById('emptyState');

      let filteredReports = reports;
      if (currentFilter !== 'all') {
        filteredReports = reports.filter(r => r.type === currentFilter);
      }

      if (filteredReports.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      container.innerHTML = filteredReports.map(report => {
        const typeStyles = {
          report: { class: 'report', text: 'ë³´ê³ ' },
          proposal: { class: 'proposal', text: 'ì œì•ˆ' },
          review: { class: 'review', text: 'ê²€í† ' }
        };
        const typeStyle = typeStyles[report.type] || typeStyles.report;

        const attendeeCount = (report.attendees && report.attendees.length) || 0;
        const actionItemCount = (report.actionItems && report.actionItems.length) || 0;
        const kpiCount = (report.relatedKpiIds && report.relatedKpiIds.length) || 0;

        return `
          <div class="meeting-card" onclick="viewReport('${report.id}')">
            <div class="meeting-card-header">
              <span class="meeting-type ${typeStyle.class}">${typeStyle.text}</span>
              <span class="meeting-date">${report.date || ''}</span>
            </div>
            <div class="meeting-title">${report.title || 'ì œëª© ì—†ìŒ'}</div>
            <div class="meeting-summary">${report.agenda || report.discussion || 'ë‚´ìš© ì—†ìŒ'}</div>
            <div class="meeting-footer">
              <div class="meeting-attendees">
                ğŸ‘¥ ${attendeeCount}ëª…
                ${actionItemCount > 0 ? `Â· ğŸ¯ ${actionItemCount}ê°œ ì•¡ì…˜` : ''}
                ${kpiCount > 0 ? `Â· ğŸ“Š ${kpiCount}ê°œ KPI` : ''}
              </div>
              <div class="meeting-actions">
                <button class="icon-btn" onclick="shareReport('${report.id}', event)" title="ê³µìœ ">ğŸ”—</button>
                <button class="icon-btn" onclick="deleteReport('${report.id}', event)" title="ì‚­ì œ">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showListView() {
      document.getElementById('listView').style.display = 'block';
      document.getElementById('reportView').classList.remove('active');
      history.pushState(null, '', window.location.pathname);
      renderReports();
    }

    function showReportView() {
      document.getElementById('listView').style.display = 'none';
      document.getElementById('reportView').classList.add('active');
    }

    function printReport() {
      window.print();
    }

    // Initialize on load
    init();
  </script>
</body>
</html>